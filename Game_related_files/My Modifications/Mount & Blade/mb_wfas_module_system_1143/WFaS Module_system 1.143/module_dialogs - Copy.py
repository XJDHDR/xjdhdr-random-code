from header_items import *
from header_common import *
from header_dialogs import *
from header_operations import *
from header_parties import *
from header_item_modifiers import *
from header_skills import *
from header_triggers import *
from ID_troops import *
from ID_party_templates import *

from module_constants import *


####################################################################################################################
# During a dialog, the dialog lines are scanned from top to bottom.
# If the dialog-line is spoken by the player, all the matching lines are displayed for the player to pick from.
# If the dialog-line is spoken by another, the first (top-most) matching line is selected.
#
#  Each dialog line contains the following fields:
# 1) Dialogue partner: This should match the person player is talking to.
#    Usually this is a troop-id.
#    You can also use a party-template-id by appending '|party_tpl' to this field.
#    Use the constant 'anyone' if you'd like the line to match anybody.
#    Appending '|plyr' to this field means that the actual line is spoken by the player
#    Appending '|other(troop_id)' means that this line is spoken by a third person on the scene.
#       (You must make sure that this third person is present on the scene)
#
# 2) Starting dialog-state:
#    During a dialog there's always an active Dialog-state.
#    A dialog-line's starting dialog state must be the same as the active dialog state, for the line to be a possible candidate.
#    If the dialog is started by meeting a party on the map, initially, the active dialog state is "start"
#    If the dialog is started by speaking to an NPC in a town, initially, the active dialog state is "start"
#    If the dialog is started by helping a party defeat another party, initially, the active dialog state is "party_relieved"
#    If the dialog is started by liberating a prisoner, initially, the active dialog state is "prisoner_liberated"
#    If the dialog is started by defeating a party led by a hero, initially, the active dialog state is "enemy_defeated"
#    If the dialog is started by a trigger, initially, the active dialog state is "event_triggered"
# 3) Conditions block (list): This must be a valid operation block. See header_operations.py for reference.  
# 4) Dialog Text (string):
# 5) Ending dialog-state:
#    If a dialog line is picked, the active dialog-state will become the picked line's ending dialog-state.
# 6) Consequences block (list): This must be a valid operation block. See header_operations.py for reference.
# 7) Voice-over (string): sound filename for the voice over. Leave here empty for no voice over
####################################################################################################################

dialogs = [
  [anyone ,"start", [(store_conversation_troop, "$g_talk_troop"),
                     (store_conversation_agent, "$g_talk_agent"),
                     (store_troop_faction, "$g_talk_troop_faction", "$g_talk_troop"),
					 
					 ##(try_begin), 
					##	(assign, reg10, "$g_encountered_party_faction"),
					##	(display_log_message, "@Log: {reg10}"),
					 ##(end_try), 
					 
#                     (troop_get_slot, "$g_talk_troop_relation", "$g_talk_troop", slot_troop_player_relation),
                     (call_script, "script_troop_get_player_relation", "$g_talk_troop"),
                     (assign, "$g_talk_troop_relation", reg0),
					 
                     (try_begin),
                       (this_or_next|is_between, "$g_talk_troop", village_elders_begin, village_elders_end),
                       (is_between, "$g_talk_troop", mayors_begin, mayors_end),
                       (party_get_slot, "$g_talk_troop_relation", "$current_town", slot_center_player_relation),
                     (try_end),
                     (store_relation, "$g_talk_troop_faction_relation", "$g_talk_troop_faction", "fac_player_faction"),
                     
                     (assign, "$g_talk_troop_party", "$g_encountered_party"),
                     (try_begin),
                       (troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1),
                       (troop_get_slot, "$g_talk_troop_party", "$g_talk_troop", slot_troop_leaded_party),
                     (try_end),
                     
					 
#                     (assign, "$g_talk_troop_kingdom_relation", 0),
#                     (try_begin),
#                       (gt, "$players_kingdom", 0),
#                       (store_relation, "$g_talk_troop_kingdom_relation", "$g_talk_troop_faction", "$players_kingdom"),
#                     (try_end),

                     (store_current_hours, "$g_current_hours"),
                     (troop_get_slot, "$g_talk_troop_last_talk_time", "$g_talk_troop", slot_troop_last_talk_time),
                     (troop_set_slot, "$g_talk_troop", slot_troop_last_talk_time, "$g_current_hours"),
                     (store_sub, "$g_time_since_last_talk","$g_current_hours","$g_talk_troop_last_talk_time"),
                     (troop_get_slot, "$g_talk_troop_met", "$g_talk_troop", slot_troop_met),
						(troop_set_slot, "$g_talk_troop", slot_troop_met, 1),
						
                     (try_begin),
#                       (this_or_next|eq, "$talk_context", tc_party_encounter),
#                       (this_or_next|eq, "$talk_context", tc_castle_commander),
#					   (neg|is_between, "$g_talk_troop", tutorial_fighters_begin, tutorial_fighters_end),
                       (call_script, "script_party_calculate_strength", "p_collective_enemy",0),
                       (assign, "$g_enemy_strength", reg0),
                       (call_script, "script_party_calculate_strength", "p_main_party",0),
                       (assign, "$g_ally_strength", reg0),
                       (store_mul, "$g_strength_ratio", "$g_ally_strength", 100),
					   (gt, "$g_enemy_strength", 0), 
                       (val_div, "$g_strength_ratio", "$g_enemy_strength"),
                     (try_end),

                     (assign, "$g_comment_found", 0),

                     (try_begin),
                       (troop_is_hero, "$g_talk_troop"),
                       (talk_info_show, 1),
                       (call_script, "script_setup_talk_info"),
                     (try_end),

                     (try_begin),
                       (is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
                       (call_script, "script_get_relevant_comment_to_s42"),
                       (assign, "$g_comment_found", reg0),
                     (try_end),

                     (troop_get_type, reg65, "$g_talk_troop"),
                     (try_begin),
                       (faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader,"$g_talk_troop"),
                       (str_store_string,s64,"@{reg65?my Lady:my Lord}"), #bug fix
                       (str_store_string,s65,"@{reg65?my Lady:my Lord}"),
                       (str_store_string,s66,"@{reg65?My Lady:My Lord}"),
                       (str_store_string,s67,"@{reg65?My Lady:My Lord}"), #bug fix
                     (else_try),
                       (str_store_string,s64,"@{reg65?madame:sir}"), #bug fix
                       (str_store_string,s65,"@{reg65?madame:sir}"),
                       (str_store_string,s66,"@{reg65?Madame:Sir}"),
                       (str_store_string,s67,"@{reg65?Madame:Sir}"), #bug fix
                     (try_end),
					 
                     (eq, 1, 0)],
   "Warning: This line is never displayed. It is just for storing conversation variables.", "close_window", []],

  [anyone ,"member_chat", [(store_conversation_troop, "$g_talk_troop"),
                    (try_begin),
                        (is_between, "$g_talk_troop", companions_begin, companions_end),
                        (talk_info_show, 1),
                        (call_script, "script_setup_talk_info_companions"),
                    (try_end),
					(troop_get_type, reg65, "$g_talk_troop"),
                           
                    (troop_get_type, reg65, "$g_talk_troop"),
                    (try_begin),
                        (faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader,"$g_talk_troop"),
                        (str_store_string,s64,"@{reg65?my Lady:my Lord}"), #bug fix
                        (str_store_string,s65,"@{reg65?my Lady:my Lord}"),
                        (str_store_string,s66,"@{reg65?My Lady:My Lord}"),
                    (else_try),
                        (str_store_string,s64,"@{reg65?madame:sir}"), #bug fix
                        (str_store_string,s65,"@{reg65?madame:sir}"),
                        (str_store_string,s66,"@{reg65?Madame:Sir}"),
                    (try_end),

                    (eq, 1, 0)],  
   "Warning: This line is never displayed. It is just for storing conversation variables.", "close_window", []],

  [anyone ,"event_triggered", [(store_conversation_troop, "$g_talk_troop"),
                           (try_begin),
                               (is_between, "$g_talk_troop", companions_begin, companions_end),
                               (talk_info_show, 1),
                               (call_script, "script_setup_talk_info_companions"),
                           (try_end),
                               
                     (troop_get_type, reg65, "$g_talk_troop"),
                     (try_begin),
                       (faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader,"$g_talk_troop"),
                       (str_store_string,s64,"@{reg65?my Lady:my Lord}"), #bug fix
                       (str_store_string,s65,"@{reg65?my Lady:my Lord}"),
                       (str_store_string,s66,"@{reg65?My Lady:My Lord}"),
                     (else_try),
                       (str_store_string,s64,"@{reg65?madame:sir}"), #bug fix
                       (str_store_string,s65,"@{reg65?madame:sir}"),
                       (str_store_string,s66,"@{reg65?Madame:Sir}"),
                     (try_end),

					 
                     (eq, 1, 0)],  
   "Warning: This line is never displayed. It is just for storing conversation variables.", "close_window", []],
   
##OiM new game start stuff
##  [anyone|auto_proceed, "start",
##   [
##	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
##	(eq, "$g_oim_training_stage", 3), 		 
##   ],
##   "not shown", "oim_tutorial_mission_dlg", []],
##
##   [anyone, "oim_tutorial_mission_dlg", [], "There is no time to talk, enemies are close. Take this sword and I'll show some strikes", "close_window", [
##	(val_add, "$g_oim_training_stage", 1), 
##	(troop_add_item, "itm_rusty_palash"),
##   ]],
##
##  [anyone|auto_proceed, "start",
##   [
##	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
##	(eq, "$g_oim_training_stage", 12), 		 
##	#?
##   ],
##   "not shown", "oim_tutorial_mission_dlg_2", []],
##
##   [anyone, "oim_tutorial_mission_dlg_2", [], "I can feal their smell, be ready to attack.", "close_window", [
##	(val_add, "$g_oim_training_stage", 1), 
##   ]],   
##
##  [anyone|auto_proceed, "start",
##   [
##	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
##	(eq, "$g_oim_training_stage", 16), 		 
##	#?
##   ],
##   "not shown", "oim_tutorial_mission_dlg_3", []],
##
##   [anyone, "oim_tutorial_mission_dlg_3", [], "It is ", "close_window", [
##	(val_add, "$g_oim_training_stage", 1),
##   ]],   
##
##  [anyone|auto_proceed, "start",
##   [
##	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
##	(eq, "$g_oim_training_stage", 22), 		 
##   ],
##   "not shown", "oim_tutorial_mission_dlg_4", []],
##
##   [anyone, "oim_tutorial_mission_dlg_4", [], "Good work, but it seems that it was just scouts, such bandits never attack alone, we'll take horse and move to my mens on the other side to help them.", "close_window", [
##	(val_add, "$g_oim_training_stage", 1), 
##   ]], 
##
##  [anyone|auto_proceed, "start",
##   [
##	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
##	(eq, "$g_oim_training_stage", 31), 		 
##   ],
##   "not shown", "oim_tutorial_mission_dlg_5", []],
##
##   [anyone, "oim_tutorial_mission_dlg_5", [], "Many thanks again stranger, now I suppose you'd like some answers about these strange times and lands.", "oim_tutorial_mission_dlg_5_1", []],    
##
##   [anyone|plyr, "oim_tutorial_mission_dlg_5_1", [], "That I would, let's see what you have to say.", "close_window", [
##	(val_add, "$g_oim_training_stage", 1), 
##   ]],    
##   
##OiM new game start stuff end   



##OiM new game start stuff
  [anyone|auto_proceed, "start",
   [
   	(eq, "$g_tw_training_stage", 6),
	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"),  
   ],
   "{!}NOT SHOWN", "oim_tutorial_mission_dlg_x", [(assign, "$g_tw_training_stage", 7), ]],
   
   [anyone, "oim_tutorial_mission_dlg_x", [], "Thank you for aiding us! An extra arm is always welcome in times such as these.", "oim_tutorial_mission_dlg_1_1", []],
   
   [anyone|plyr, "oim_tutorial_mission_dlg_1_1", [], "It was my honor to aid you.", "oim_tutorial_mission_dlg_1_2", []],    
   
   [anyone, "oim_tutorial_mission_dlg_1_2", [], "Come let's find some horses and ride away before more of these scoundrels appear.", "close_window", [
   
   ]],   
   

  [anyone|auto_proceed, "start",
   [
   	(eq, "$g_tw_training_stage", 9), 	
	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 	 
   ],
   "{!}NOT SHOWN", "oim_tutorial_mission_dlg", [(assign, "$g_tw_training_stage", 10),]],

   [anyone, "oim_tutorial_mission_dlg", [], "Alright then, we'll have to do something about this padlock. Take this old pistol and blast the wretched thing, will you?", "close_window", [
   
   ]],
     

  [anyone|auto_proceed, "start",
   [
	(eq, "$g_talk_troop", "trp_oim_monfore_tutorial"), 
	(eq, "$g_tw_training_stage", 22), 		 
   ],
   "{!}NOT SHOWN", "oim_tutorial_mission_dlg_5", [(assign, "$g_tw_training_stage", 23), ]],

   [anyone, "oim_tutorial_mission_dlg_5", [], "Many thanks, stranger. These are strange times, as we both well know... And it good to meet new friends. Would you care to join us for supper?", "oim_tutorial_mission_dlg_5_1", []],    

   [anyone|plyr, "oim_tutorial_mission_dlg_5_1", [], "Aye, that I would!", "close_window", [
	
   ]],    

   
#OiM new game start stuff end   


 #MS Dialogs -begin
 [anyone|auto_proceed, "start", 
	[
		(eq, "$g_select_extra_officer_dialog", 1),
	], 
	"{!}NOT SHOWN", "ms_extra_officer_dialog_start",[]], 

 [anyone,"ms_extra_officer_dialog_start", [
												(try_begin),
													(call_script, "script_ms_fill_officer_elements_array_with_faction"),
													(try_begin),
														(troop_slot_eq, "trp_ms_player_officer_elements", 101, 1),
														(str_store_string, s0,"@Viberite variant."),
													(else_try),
														(str_store_string, s0,"@Seychas vse dostupniye oficeri zanyati obucheniem novobrancev."),
													(try_end),
												(try_end),
												(call_script, "script_ms_officer_get_troops_list_to_s5"),
											], "{s0}^{s5}", "ms_extra_officer_element_list", []], 
 [anyone|plyr|repeat_for_100,"ms_extra_officer_element_list", [
																	(store_repeat_object, ":slot_no"),
																	(troop_slot_ge, "trp_ms_player_officer_elements", ":slot_no", 1),
																	(try_begin),
																		(troop_get_slot, ":troop", "trp_ms_player_officer_elements", ":slot_no"),
																		(str_store_troop_name, s2, ":troop"),
																	(try_end),
																], "{s2}", "ms_view_officer_elements",
																 [
																	(store_repeat_object, "$g_ms_officer_slot"),
																 ]],
  [anyone|plyr,"ms_extra_officer_element_list", [
													
													(troop_slot_eq, "trp_ms_player_officer_elements", 102, 1),
												], "I would like to recruit some men.", "ms_extra_officer_dialog_start",
													 [
														(call_script, "script_ms_officer_get_troops_to_player_party"),
													 ]],
 [anyone|plyr,"ms_extra_officer_element_list", [], "I must go...", "close_window",[  
																					(assign, "$g_select_extra_officer_dialog", 0),
																					(jump_to_menu, "mnu_ms_additional_officer")
																				 ]],
 [anyone, "ms_view_officer_elements", [
											(try_begin),
												(call_script, "script_ms_officer_calculate_troop_cost"),
												(try_begin),
													(eq, "$g_ms_officer_max_count", 0),
													(str_store_string, s2, "@U vas nedostatochno deneg dazhe na odnogo voina, nuzhno hotyabi {reg0} tallerov"),
												(else_try),
													(str_store_string, s2, "@Vot vse chto dostupno za zoloto, kotoroe u vas est"),
												(try_end),
											(try_end),
										], "{s2}", "ms_view_officer_elements_list", []], 
 [anyone|plyr, "ms_view_officer_elements_list", [
													(ge, "$g_ms_officer_max_count", 1),
													(try_begin),
														(store_mul, reg0, "$g_ms_officer_troop_price", 1),
														(assign, reg1, "$g_ms_officer_timer"),
														(val_div, reg1, 24),
													(try_end),
												], "1 ({reg0} thaler and {reg1} coppers).", "ms_extra_officer_dialog_start",
												[
													(call_script, "script_ms_buy_extra_troop", 1),
												]],
[anyone|plyr, "ms_view_officer_elements_list", [
													(ge, "$g_ms_officer_max_count", 3),
													(try_begin),
														(store_mul, reg0, "$g_ms_officer_troop_price", 3),
														(assign, reg1, "$g_ms_officer_timer"),
														(val_div, reg1, 24),
													(try_end),
												], "3 ({reg0} thaler and {reg1} coppers).", "ms_extra_officer_dialog_start",
												[
													(call_script, "script_ms_buy_extra_troop", 3),
												]],
[anyone|plyr, "ms_view_officer_elements_list", [
													(ge, "$g_ms_officer_max_count", 5),
													(try_begin),
														(store_mul, reg0, "$g_ms_officer_troop_price", 5),
														(assign, reg1, "$g_ms_officer_timer"),
														(val_div, reg1, 24),
													(try_end),
												], "5 ({reg0} thaler and {reg1} coppers).", "ms_extra_officer_dialog_start",
												[
													(call_script, "script_ms_buy_extra_troop", 5),
												]],
 [anyone|plyr,"ms_view_officer_elements_list", [], "I must go...", "ms_extra_officer_dialog_start",[]],

#========
 
 [anyone|auto_proceed, "start", 
	[
		(eq, "$g_select_extra_good_dialog", 1),
	], 
	"{!}NOT SHOWN", "ms_extra_goods_dialog_start",[]], 

 [anyone,"ms_extra_goods_dialog_start", [], "What is your wish?", "ms_extra_goods_category_list", []], 
 [anyone|plyr|repeat_for_100,"ms_extra_goods_category_list", [
																	(store_repeat_object, ":slot_no"),
																	(troop_slot_ge, "trp_ms_temp_array_extra_category", ":slot_no", 1),
																	(try_begin),
																		(troop_get_slot, ":string", "trp_ms_temp_array_extra_category", ":slot_no"),
																		(str_store_string, s2, ":string"),
																	(try_end),
																], "{s2}", "ms_view_categoty_elements",
																 [
																	(store_repeat_object, ":slot_no"),
																	(call_script, "script_ms_go_to_category_elements", ":slot_no"),
																 ]],
 [anyone|plyr,"ms_extra_goods_category_list", [		(store_free_inventory_capacity, ":free_inventory", "trp_player"),
													(troop_slot_eq, "trp_ms_temp_array_extra_category", 0, 0),
													(ge, ":free_inventory", 1),
												], "Make purchase.", "close_window",[ 
																						(try_begin),
																							(eq, "$g_ms_cur_add_menu", "trp_town_upgrade_armourer"),
																							(assign, ":slot", slot_ms_party_armourer_element),
																						(else_try),
																							(eq, "$g_ms_cur_add_menu", "trp_town_upgrade_protection"),
																							(assign, ":slot", slot_ms_party_protection_element),
																						(else_try), 
																							(eq, "$g_ms_cur_add_menu", "trp_town_upgrade_groom"),
																							(assign, ":slot", slot_ms_party_horse_element),
																						(try_end),
																						(party_get_slot, ":element", "$g_encountered_party", ":slot"),
																						(party_set_slot, "$g_encountered_party", ":slot", 0),
																						(troop_add_item, "trp_player", ":element"),
																						#(troop_equip_items, "trp_player"), 
																						(assign, "$g_select_extra_good_dialog", 0),
																						(jump_to_menu, "mnu_ms_additional_extra_goods")
																					 ]],
 [anyone|plyr,"ms_extra_goods_category_list", [], "I must go...", "close_window",[ 
																	(assign, "$g_select_extra_good_dialog", 0),
																	(jump_to_menu, "mnu_ms_additional_extra_goods")
																 ]],
 
 [anyone, "ms_view_categoty_elements", [
										(try_begin),
											#(troop_slot_eq, "trp_ms_temp_extra_category_elements", 0, 1),
											(str_store_string, s0,"@Vot chto vam seychas dostupno, zakazivayte."),
										(else_try),
											(eq, 0, 1),
											(str_store_string, s0,"@Na daniy moment net dostupnih vam elementov."),
										(try_end),
										], "{s0}", "ms_view_categoty_elements_list", []], 
 [anyone|plyr|repeat_for_100, "ms_view_categoty_elements_list", [
																	(store_repeat_object, ":slot_no"),
																	(ge, ":slot_no", 1),
																	(troop_slot_ge, "trp_ms_temp_extra_category_elements", ":slot_no", 1),
																	(try_begin),
																		(troop_get_slot, ":element", "trp_ms_temp_extra_category_elements", ":slot_no"),
																		(troop_get_slot, ":old_price", "trp_ms_temp_extra_category_elements_prices", ":slot_no"),
																		(call_script, "script_ms_recalculate_extra_price", ":old_price"),
																		(str_store_item_name, s2, ":element"),
																	(try_end),
																], "{s2} ({reg2} thaler).", "ms_extra_element_buy_descr",[
																																(store_repeat_object, "$temp"),
																																#(call_script, "script_ms_buy_extra_good", ":slot_no"),
																															  ]],
 [anyone|plyr,"ms_view_categoty_elements_list", [], "I must go...", "ms_extra_goods_dialog_start",[]],
  
 [anyone,"ms_extra_element_buy_descr", [
	(store_troop_gold, ":player_gold", "trp_player"),
	(troop_get_slot, ":old_price", "trp_ms_temp_extra_category_elements_prices", "$temp"),
	(call_script, "script_ms_recalculate_extra_price", ":old_price"),
	(assign, ":old_price", reg2),
	(ge, ":player_gold", ":old_price"), 
 ], "The order's accepted. Come in about two weeks, everything would be ready.", "ms_extra_element_buy_descr_list", [
	(call_script, "script_ms_buy_extra_good", "$temp"),
 ]],  
 
 [anyone,"ms_extra_element_buy_descr", [], "You don't have enough money!", "ms_extra_element_buy_descr_list", []], 
 
 [anyone|plyr,"ms_extra_element_buy_descr_list", [], "Very well.", "close_window", [
																					(assign, "$g_select_extra_good_dialog", 0),
																					(jump_to_menu, "mnu_ms_additional_extra_goods")]], 

#========
 #Re-done this shit!
 [anyone|auto_proceed, "ms_talk_to_elder_to_construct", 
	[
		#(eq, "$g_ms_elder_dialog", 1),
		(call_script, "script_ms_init"), 
	], 
	"{!}NOT SHOWN", "ms_elder_dialog_start",[]], 

 [anyone,"ms_elder_dialog_start", [
										(try_begin),
											(assign, "$g_ms_center", "$current_town"),
											(store_sub, "$g_ms_offset", "$g_ms_center", towns_begin),
											(val_add, "$g_ms_offset", ms_party_has_element_start_slot),
										(try_end),
									], "How can I be of help?", "ms_elder_list", []], 
 [anyone|plyr,"ms_elder_list", [], "I'd like to erect a building.", "ms_view_elements",
							 [
								(call_script, "script_ms_go_to_view_element_menu", ms_flag_building),
							 ]],
 [anyone|plyr,"ms_elder_list", [], "To appoint someone...", "ms_view_elements",
							 [
								(call_script, "script_ms_go_to_view_element_menu", ms_flag_upgrade),
							 ]],
 [anyone|plyr,"ms_elder_list", [], "Tell me, what is already built here?", "ms_already_builded",
							 [
								 (assign, "$g_ms_cur_elements_type", ms_flag_building),
							 ]],
  [anyone|plyr,"ms_elder_list", [], "Tell me, which positions are already occupied?", "ms_already_builded",
							 [
								 (assign, "$g_ms_cur_elements_type", ms_flag_upgrade),
							 ]],
 [anyone|plyr,"ms_elder_list", [], "I must go...", "close_window",[ 
																	#(assign, "$g_ms_elder_dialog", 0),
																	(try_begin), 
																		(ge, "$g_next_menu", 1),
																		(jump_to_menu, "$g_next_menu"),
																	(end_try), 	
																 ]],
 
 [anyone, "ms_view_elements", [
								(try_begin),
									(ge, "$g_ms_temp", 1),
									(call_script, "script_ms_get_faction_description_for_element", "$g_ms_temp", ms_flag_short, "$g_ms_center"),
									(str_store_string, s1, reg0),
									(store_add, ":time_to_built_slot", ms_time_to_build_start_slot, "$g_ms_offset"),
									(troop_get_slot, ":wait_time", "$g_ms_temp",":time_to_built_slot"),
									(call_script, "script_ms_get_wait_time", ":wait_time"),
									(str_store_string, s0,"@Ya seychas zaynuat prediduschim vashim prikazom otnositelno {s1}. Zakonchu cherez {reg2} {reg1?dney:chasov}"),
								(else_try),
									(str_store_string, s0,"@Viberite zhelayumiy element"),
								(try_end),
								], "{s0}", "ms_view_elements_list", []], 
 [anyone|plyr|repeat_for_100, "ms_view_elements_list", [
														(store_repeat_object, ":slot_no"),
														(troop_slot_ge, "trp_ms_elder_menu_array", ":slot_no", 1),
														(try_begin),
															(troop_get_slot, ":temp_element", "trp_ms_elder_menu_array", ":slot_no"),
															(call_script, "script_ms_get_faction_description_for_element", ":temp_element", ms_flag_short, "$g_ms_center"),
															(str_store_string, s2, reg0),
														(try_end),
													], "{s2}", "ms_element_menu",[
																					(store_repeat_object, ":slot_no"),
																					(call_script, "script_ms_go_to_element_menu", ":slot_no"),
																				  ]],
 [anyone|plyr,"ms_view_elements_list", [(eq, "$g_ms_extra_adviser_dialog", 0),], "That's all.", "ms_elder_dialog_start",[]],
 [anyone|plyr,"ms_view_elements_list", [(eq, "$g_ms_extra_adviser_dialog", 1),], "Understood.", "ms_extra_adviser",[]], 
 
 [anyone,"ms_element_menu", [       
										(try_begin),
											(store_troop_gold, "$g_trp_player_gold", "trp_player"),
											(call_script, "script_ms_get_faction_description_for_element", "$g_cur_element", ms_flag_short, "$g_ms_center"),
											(str_store_string, s1, reg0),
										(try_end),
										(try_begin),
											(troop_slot_eq, "$g_cur_element", "$g_ms_offset", ms_flag_empty),
											(str_store_string, s0, "@Zdes esche net {s1}."),
										(else_try),
											(troop_slot_eq, "$g_cur_element", "$g_ms_offset", ms_flag_already_builded),
											(str_store_string, s0, "@Zdes uzhe est {s1}."),
										(try_end),
									], "{s0}. What would you like to do, my {lord/lady}?", "ms_element_menu_list", []],  
	
	[anyone|plyr,"ms_element_menu_list", [ 
											(this_or_next|troop_slot_eq, "$g_cur_element", slot_ms_price, "$g_trp_player_gold"),
											(neg|troop_slot_ge, "$g_cur_element", slot_ms_price, "$g_trp_player_gold"),
											(troop_slot_eq, "$g_cur_element", "$g_ms_offset", ms_flag_empty),
											(try_begin),
												(neg|troop_slot_eq, "$g_cur_element", slot_ms_construct_requirements, ms_flag_empty),
												(troop_get_slot, ":script", "$g_cur_element", slot_ms_construct_requirements),
												(call_script, ":script", "$g_ms_center", "$g_cur_element", slot_ms_construct_requirements),
											(else_try),
												(assign, reg1, 1),
											(try_end),		
											(eq, reg1, 1),
											(try_begin),
												(assign, reg0, "$g_ms_cur_elements_type"),
												(str_store_string, s2, "@{reg0?Naynyat:Postroit}"),
											(try_end),
										   ], "{s2} ", "ms_player_read_descr", []], 
	[anyone|plyr,"ms_element_menu_list", [ ], "Tell me more...", "ms_element_description", []], 
	[anyone|plyr,"ms_element_menu_list", [],  "Nothing...", "ms_view_elements",[]],				
	
	[anyone,"ms_player_read_descr", [       
										(try_begin),
											(call_script, "script_ms_get_faction_description_for_element", "$g_cur_element", ms_flag_short, "$g_ms_center"),
											(str_store_string, s0, reg0),
											(troop_get_slot, ":wait_time", "$g_cur_element", slot_ms_construct_time),
											(call_script, "script_ms_get_wait_time", ":wait_time"),		
											(troop_get_slot, reg3, "$g_cur_element", slot_ms_price),
											(assign, reg0, "$g_ms_cur_elements_type"),
										(try_end),
									], "To {reg0?find a worthy man:erect a building} would require {reg2} {reg1?days:hours} and {reg3} thaler.", "ms_player_read_descr_list", []],  
	
	[anyone|plyr,"ms_player_read_descr_list", [], "Very well.", "ms_elder_dialog_start", [
																								(call_script, "script_ms_start_build_element"),
																							]], 
	[anyone|plyr,"ms_player_read_descr_list", [], "I've changed my mind.", "ms_element_menu", []], 
	
	[anyone,"ms_element_description", [       
										(try_begin),
											(call_script, "script_ms_get_faction_description_for_element", "$g_cur_element", ms_flag_long, "$g_ms_center"),
											(str_store_string, s0, reg0),
										(try_end),
									], "{s0}", "ms_element_description_list", []],  
	
	[anyone|plyr,"ms_element_description_list", [], "Understood.", "ms_element_menu", []], 
	
	[anyone,"ms_already_builded", [       
										(try_begin),
											(str_store_string, s1, "@ "),
											(str_store_string, s2, "@ "),
											(assign, "$g_ms_temp_2", 0),
											(call_script, "script_ms_get_kind_bounds", "script_ms_already_builded_to_s2", 1),
										(try_end),
										(try_begin),
											(eq, "$g_ms_temp_2", 1),
											(try_begin),
												(eq, "$g_ms_cur_elements_type", ms_flag_building),
												(str_store_string, s1, "@U vas zdes uzhe postroeni sleduyuzhiye zdaniya:^"),
											(else_try),
												(eq, "$g_ms_cur_elements_type", ms_flag_upgrade),
												(str_store_string, s1, "@Zdes k tebe loyalni takie ludi:^"),
											(try_end),
										(else_try),
											(str_store_string, s1, "@U vas nichego esche netu."),
										(try_end),
									], "{s1} {s2}", "ms_already_builded_list", []],  
	
	[anyone|plyr,"ms_already_builded_list", [(eq, "$g_ms_extra_adviser_dialog", 0),], "That is all.", "ms_elder_dialog_start", []], 
	[anyone|plyr,"ms_already_builded_list", [(eq, "$g_ms_extra_adviser_dialog", 1),], "Understood.", "ms_extra_adviser",[]], 
	#========
 
[anyone|auto_proceed, "start", 
	[
		(eq, "$g_is_npc_dialog", 1),
	], 
	"{!}NOT SHOWN", "ms_npc_dialog_start",[]], 

 [anyone,"ms_npc_dialog_start", [], "Which of your companions would you like to train?", "ms_npc_list", []], 
 [anyone|plyr|repeat_for_troops,"ms_npc_list", [
								(store_repeat_object, ":troop_no"),
								(is_between, ":troop_no", companions_begin, companions_end),
								(str_store_troop_name, s0, ":troop_no"),
								(troop_slot_eq, ":troop_no", slot_troop_occupation, slto_player_companion),
								(neq, ":troop_no", "trp_npc1"),
								(neq, ":troop_no", "trp_npc4"),
							 ], "{s0}", "ms_npc_variants",
							 [
								(store_repeat_object, "$g_cur_npc"),
							]],
 [anyone|plyr,"ms_npc_list", [], "I've changed my mind.", "close_window",[ (assign, "$g_is_npc_dialog", 0),]],
 
 #slot_troop_studing_count
 #slot_troop_studing_war
 #slot_troop_studing_medicine
 #slot_troop_studing_war_work
 
 [anyone, "ms_npc_variants", [
	(troop_slot_eq, "$g_cur_npc", slot_troop_studing_count, 3),
 ], "We can teach him nothing more!", "ms_npc_dialog_start", []], 
 
 [anyone, "ms_npc_variants", [], "Very well, pick an art you would like to master.", "ms_nps_variant_descr", []], 
 [anyone|plyr, "ms_nps_variant_descr", [
	(neg|troop_slot_eq, "$g_cur_npc", slot_troop_studing_medicine, 1),
 ], "Medicine", "ms_nps_variant_selected",[(assign, "$g_cur_npc_branch", ms_flag_medicine),]],
 
 [anyone|plyr, "ms_nps_variant_descr", [
	(neg|troop_slot_eq, "$g_cur_npc", slot_troop_studing_war_work, 1),	
 ], "Tactics", "ms_nps_variant_selected",[(assign, "$g_cur_npc_branch", ms_flag_war_work),]],
 
 [anyone|plyr, "ms_nps_variant_descr", [
	(neg|troop_slot_eq, "$g_cur_npc", slot_troop_studing_war, 1),	
 ], "Military training", "ms_nps_variant_selected",[(assign, "$g_cur_npc_branch", ms_flag_war_prepare),]],
 
 [anyone|plyr,"ms_nps_variant_descr", [], "Return...", "ms_npc_dialog_start",[]],
	 
 [anyone,"ms_nps_variant_selected", [       
										(try_begin),
											(store_character_level, ":npc_level", "$g_cur_npc"),
											(store_mul, "$g_study_price", ":npc_level", 3),
											(val_mul, "$g_study_price", 150),
											(troop_get_slot, ":count", "$g_cur_npc", slot_troop_studing_count), 
											(try_begin),
												(gt, "$g_study_count", 0),
												(store_mul, ":koef", "$g_study_count", 5),
												(val_mul, ":koef", ":koef"),
											(try_end),
											(assign, ":koef", 0),
											(try_begin),
												(gt, ":count", 0),
												(store_mul, ":koef", ":count", 5),
												(val_mul, "$g_study_price", ":koef"),
											(try_end),
											(assign, reg0, "$g_study_price"),
										(try_end),
									], "The cost of training will be {reg0} thaler.", "ms_npc_agree_disagree", []],  
	
	[anyone|plyr,"ms_npc_agree_disagree", [ 
											(try_begin),
												(store_troop_gold, ":player_gold", "trp_player"),
											(try_end),
											(ge, ":player_gold", "$g_study_price"),
										   ], "All right, here's the pay.", "close_window", 
																   [
																		(call_script, "script_ms_start_npc_study"),
																		(assign, "$g_is_npc_dialog", 0),
																		(jump_to_menu,"mnu_ms_additional_school"),
																   ]], 
	[anyone|plyr,"ms_npc_agree_disagree", [],  "Some other time.", "ms_npc_variants",[]],				
	
	#========
	[anyone|auto_proceed, "start", 
	[
		(eq, "$g_ms_extra_adviser_dialog", 1),
	], 
	"{!}NOT SHOWN", "ms_extra_adviser",[]], 

 [anyone,"ms_extra_adviser", [], "Well, to whom shall we go?", "ms_extra_adviser_list", []], 
 [anyone|plyr|repeat_for_100,"ms_extra_adviser_list", [
											(store_repeat_object, ":slot_no"),
											(gt, ":slot_no", 0),
											(troop_slot_ge, "trp_ms_temp_extra_adviser_menu", ":slot_no", 1),
											(try_begin),
												(troop_get_slot, ":center", "trp_ms_temp_extra_adviser_menu", ":slot_no"),
												(str_store_party_name, s0, ":center"),
											(try_end),
										 ],
										 "{s0}", "ms_view_elements",
																[
																(store_repeat_object, ":slot_no"),
																(call_script, "script_ms_send_adviser", ":slot_no"),
																]],
[anyone|plyr,"ms_extra_adviser_list", [], "Return...", "close_window",[ 
																		(assign, "$g_ms_extra_adviser_dialog", 0),
																		(jump_to_menu, "mnu_ms_additional_adviser"),
																	]],
#MS Dialogs -end
 #==========
[anyone|auto_proceed, "start", 
	[
		(eq, "$g_select_capital_dialog", 1),
	], 
	"{!}NOT SHOWN", "messenger_dialog_start",[]], 

 [anyone,"messenger_dialog_start", [], "Your capital has been captured, my {lord/lady}! Where would you like to set up a new one?", "centres_list", []], 
 [anyone|plyr|repeat_for_100,"centres_list", [
												(store_repeat_object, ":slot_no"),
												(gt, ":slot_no", 0),
												(troop_slot_ge, "trp_diplomatic_array", ":slot_no", 1),
													(try_begin),
														(troop_get_slot, ":center", "trp_diplomatic_array", ":slot_no"),
														(str_store_party_name, s0, ":center"),
													(try_end),
											  ], "{s0}", "close_window",
														 [
															(store_repeat_object, ":slot_no"),
															(troop_get_slot, "$g_diplomatic_capital", "trp_diplomatic_array", ":slot_no"),
															(assign, "$g_select_capital_dialog", 0),
														  ]],
 
 [anyone|plyr,"centres_list", [], "Return...", "close_window",[ (assign, "$g_diplomatic_capital", 0),]],
 # ======
 
 [anyone|auto_proceed, "start", 
	[
		(eq, "$g_ambassador_dialog", 1),
		(try_begin),
			  (store_sub, "$g_talk_troop_faction", "$g_talk_troop", ambassador_start),
			  (val_add, "$g_talk_troop_faction", "fac_kingdom_1"),
		(try_end),
	], 
	"{!}NOT SHOWN", "ambassador_start",[]], 

 [anyone,"ambassador_start", [], "What is thy bidding, most serene {playername}?", "ambassador_variants", []], 
 [anyone|plyr,"ambassador_variants", [
										(try_begin),
											(call_script, "script_check_ambassador_variant", flag_peace),
										(try_end),
										(eq, reg0, 1),
									 ], "I would like to discuss a peace treaty...", "ambassador_peace",
									 []],
 [anyone|plyr,"ambassador_variants", [
										(try_begin),
											(call_script, "script_check_ambassador_variant", flag_war),
										(try_end),
										(eq, reg0, 1),
									 ], "Prepare for war!", "ambassador_start",
									 [
										(call_script, "script_ambassador_start_war"),
									 ]],
 [anyone|plyr,"ambassador_variants", [
										(try_begin),
											(call_script, "script_check_ambassador_variant", flag_trade),
										(try_end),
										(eq, reg0, 1),
									 ], "I would like to make a trade agreement.", "ambassador_trade_deal",
									 [ ]],
  
 [anyone|plyr,"ambassador_variants", [], "Nothing so far...", "close_window",[ (assign, "$g_ambassador_dialog", 0),
																	(jump_to_menu, "mnu_select_ambassador"),	]],
 
 [anyone, "ambassador_peace", [
									(try_begin),
										(call_script, "script_check_peace_condition"),
									(try_end),
								], "{s0}", "ambassador_peace_choose", []], 
 [anyone|plyr, "ambassador_peace_choose", [
											(try_begin),
												(call_script, "script_check_peace_gold"),
											(try_end),
											(eq, reg0, 1),
											], "Your wishes are most reasonable. We agree.", "ambassador_start",[
																					(call_script, "script_ambassador_start_peace"),
																				  ]],
 [anyone|plyr, "ambassador_peace_choose", [], "Our nation would never make such concessions!", "ambassador_start",[]],

 [anyone, "ambassador_trade_deal", [],"This trade agreement would cost you 4000 thaler, and the revenue you would receive from trade would most likely be no less than 2500 thaler per month...", "ambassador_trade_chose", []], 
 [anyone|plyr, "ambassador_trade_chose", [], "I agree.", "ambassador_start",[
																					(call_script, "script_do_trade_deal"),
																				  ]],
 [anyone|plyr,"ambassador_trade_chose", [], "I must consider this further.", "ambassador_start",[]],

  
   
   #OiM faching hacks!

	#qst_oim_potop_execute_king
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(check_quest_active, "qst_oim_potop_execute_king"),
		(check_quest_succeeded, "qst_oim_potop_execute_king"), 
		(neg|check_quest_finished,"qst_oim_potop_execute_king"),
		(neq, "$talk_context", tc_ally_thanks), 
		(neq, "$talk_context", tc_hero_freed), 
	], "{!}NOT SHOWN", "oim_potop_king_execution_zagloba_talk",[]],	


	#qst_oim_potop_destroy_mercs
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_potop_destroy_mercs"),
		(check_quest_succeeded, "qst_oim_potop_destroy_mercs"), 
		(neg|check_quest_finished,"qst_oim_potop_destroy_mercs"),
		(eq, "$oim_auto_talk_troop", "trp_npc1"), 
	], "{!}NOT SHOWN", "oim_potop_zagloba_return_dlg", []],
	
   
    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"),
		(quest_get_slot, ":quest_current_state", "qst_oim_trakay_icon", slot_quest_current_state),
		(eq, ":quest_current_state", 1),
		], "{!}NOT SHOWN", "oim_trakai_icon_radzivil_talk",[]],
		
    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_tatarin_zolotarenko"),
		(quest_slot_eq, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 0),
		(check_quest_active,"qst_oim_bring_tatarin_to_sich"),
		(neg|check_quest_failed,"qst_oim_bring_tatarin_to_sich"),
		(neg|check_quest_finished,"qst_oim_bring_tatarin_to_sich"),
	], "{!}NOT SHOWN", "oim_tatarin_first_talk",[]],		

    [anyone|auto_proceed, "start", [
			(eq, "$g_talk_troop", "trp_oim_tatarin_zolotarenko"),
			(check_quest_active,"qst_oim_bring_tatarin_to_perekop"),
			(quest_slot_eq, "qst_oim_bring_tatarin_to_perekop", slot_quest_current_state, 0),
	], "{!}NOT SHOWN", "oim_tatarin_loopback",[]],		
		
    [anyone|auto_proceed, "start", [
			(eq, "$g_talk_troop", "trp_oim_tatarin_zolotarenko"),
			(check_quest_active,"qst_oim_bring_tatarin_to_perekop"),
			(neg|check_quest_failed,"qst_oim_bring_tatarin_to_perekop"),
			(quest_slot_eq, "qst_oim_bring_tatarin_to_perekop", slot_quest_current_state, 1),
		], "{!}NOT SHOWN", "oim_tatarin_end_qst_perekop",[]],		
		
		
		
    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_trakai_ksendz"),
		(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 5),
		], "{!}NOT SHOWN", "oim_trakai_icon_town_dweller_riga_talk_1", []],  
		
    [anyone|auto_proceed,"start", [(eq, "$g_talk_troop", "trp_oim_polish_taver_visitor"),], "{!}NOT SHOWN", "oim_trakai_icon_tavern_talk", []],			

    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_trakai_ksendz"),
		(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 10), 
		], "{!}NOT SHOWN", "oim_tracai_monk_talk_quest_ended", []],   
    [anyone,"oim_tracai_monk_talk_quest_ended", [], "Go away. Don't disturb me while I'm having my beer...", "close_window", []],					
		
    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_trakai_ksendz"),
		(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 10), 
		], "{!}NOT SHOWN", "oim_tracai_monk_talk_quest_ended", []],   


    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_rhodok_sergeant"),
		(check_quest_failed, "qst_oim_bring_tatarin_to_sich"), 
		(neg|check_quest_finished, "qst_oim_bring_tatarin_to_sich"),
		(eq, "$trp_rhodok_sergeant_zolot_tatar_qst", 0),
		], "{!}NOT SHOWN", "oim_kozaks_tell_failur", [(assign, "$trp_rhodok_sergeant_zolot_tatar_qst",1)]],   

    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_castle_17_seneschal"),
		(quest_slot_eq, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 1), 
		], "{!}NOT SHOWN", "oim_bring_tataring_to_sich_sich_dlg", []],   
		
	#zolotarenko check	
    [anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_knight_5_9"),
		(eq, "$zolotarenko_bring_tataring", 0), 
		(store_character_level, ":level", "trp_player"),	
		#code
		(troop_get_slot, ":lord_party", "trp_knight_5_9", slot_troop_leaded_party),
		(troop_get_slot, ":lord2_party", "trp_knight_5_3", slot_troop_leaded_party),
		(store_skill_level, ":skill", skl_prisoner_management, "trp_player"),
		(try_begin), 
			(ge, ":lord_party", 0), 
			(ge, ":lord2_party", 0), 
			(store_distance_to_party_from_party, ":cur_dist", ":lord_party", ":lord2_party"),	
		(else_try), 
			(assign, ":cur_dist", 0), 
		(end_try), 
		(gt, ":cur_dist", 10),
		(lt, ":level", 14), 
		(ge, ":skill", 1),
		], "{!}NOT SHOWN", "oim_zolotarenko_bring_tataring_start",[(assign, "$zolotarenko_bring_tataring", 1),]],					
    
    [anyone|auto_proceed, "start", [
			(check_quest_active,"qst_oim_bring_tatarin_to_sich"),
			(neg|check_quest_failed, "qst_oim_bring_tatarin_to_sich"), 			
			(neg|check_quest_finished,"qst_oim_bring_tatarin_to_sich"),
			(quest_slot_eq, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 2),
			(eq, "$g_talk_troop", "trp_knight_5_3"),
		], "{!}NOT SHOWN", "oim_gomon_bring_tataring_start",[]],					
	
	#Sem samurev check
    [anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_start_quest_sem_samuraev", 0), 
		(call_script, "script_cf_oim_check_quest_sem_samuraev"), 
		], "{!}NOT SHOWN", "oim_start_quest_sem_samuraev",[(assign, "$oim_start_quest_sem_samuraev", 1),]],					

	[anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_start_quest_monfor_for_shved", 0), 
		(call_script, "script_cf_oim_check_quest_monfor_shved"), 
		], "{!}NOT SHOWN", "oim_start_quest_monfor_shved",[(assign, "$oim_start_quest_monfor_for_shved", 1),]],	
		
		
    [anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_start_quest_lendliz", 0), 
		(call_script, "script_cf_oim_check_quest_lendliz"), 
		], "{!}NOT SHOWN", "oim_start_lendliz_dlg",[(assign, "$oim_start_quest_lendliz", 1),]],			

    [anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_start_quest_mest_i_zakon", 0), 
		(call_script, "script_cf_oim_check_quest_mest_i_zakon"), 
		], "{!}NOT SHOWN", "oim_start_quest_mest_i_zakon_dlg",[(assign, "$oim_start_quest_mest_i_zakon", 1),]],

	[anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_start_quest_invest", 0), 
		(call_script, "script_cf_oim_check_quest_invest"), 
		(neq, "$g_talk_troop", "trp_kingdom_5_lord"),
		], "{!}NOT SHOWN", "oim_start_quest_invest_dlg",[(assign, "$oim_start_quest_invest", 1),]],
		
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_rhodok_sergeant"), 
		(check_quest_active,"qst_oim_sem_samuraev"),
		(neg|check_quest_succeeded, "qst_oim_sem_samuraev"), 
		(neg|check_quest_finished,"qst_oim_sem_samuraev"),
		(quest_slot_eq, "qst_oim_sem_samuraev", slot_quest_current_state, 1), 
		], "{!}NOT SHOWN", "oim_pre_fight_dlg_sem_samuraev",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_monfor"), 
		(check_quest_active,"qst_oim_monfor_shved"),
		(neg|check_quest_finished,"qst_oim_monfor_shved"),
		(quest_slot_eq, "qst_oim_monfor_shved", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "oim_monfor_talk_shved_start",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_monfor"), 
		(check_quest_active,"qst_oim_monfor_shved_army"),
		(neg|check_quest_succeeded, "qst_oim_monfor_shved_army"), 
		(neg|check_quest_finished,"qst_oim_monfor_shved_army"),
		(quest_slot_eq, "qst_oim_monfor_shved_army", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "oim_monfor_talk_shved_soldiers",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_4_lord"), 
		(check_quest_active,"qst_oim_monfor_shved"),
		(check_quest_succeeded,"qst_oim_monfor_shved"),
		(neg|check_quest_finished,"qst_oim_monfor_shved"),
		#(quest_slot_eq, "qst_oim_monfor_shved", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "oim_monfor_talk_shved_king",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_village_84_elder"), 
		(check_quest_active,"qst_mest_i_zakon"),
		(neg|check_quest_finished,"qst_mest_i_zakon"),
		(quest_slot_eq, "qst_mest_i_zakon", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "oim_elder_talk_maslovbrod",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_5_lord"), 
		(check_quest_active,"qst_mest_i_zakon3"),
		(neg|check_quest_finished,"qst_mest_i_zakon3"),
		(quest_slot_eq, "qst_mest_i_zakon3", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "qst_mest_i_zakon3_talk",[]],	

	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_5_lord"), 
		(check_quest_active,"qst_oim_invest_2"),
		(neg|check_quest_finished,"qst_oim_invest_2"),
		#(quest_slot_eq, "qst_oim_invest_2", slot_quest_current_state, 1), 
	], "{!}NOT SHOWN", "qst_oim_invest_finish",[]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_5_lord"), 
		(check_quest_active,"qst_mest_i_zakon2"),
		(neg|check_quest_finished,"qst_mest_i_zakon2"),
		(quest_slot_eq, "qst_mest_i_zakon2", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "qst_mest_i_zakon2_talk",[]],	

	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_4_lord"), 
		(check_quest_succeeded,"qst_oim_monfor_shved"),
		(neg|check_quest_finished,"qst_oim_monfor_shved"),
		(quest_slot_eq, "qst_oim_monfor_shved", slot_quest_current_state, 0), 
	], "{!}NOT SHOWN", "oim_monfor_talk_shved_king",[]],	

	[anyone|auto_proceed, "start", [
		(quest_slot_eq, "qst_mest_i_zakon", slot_quest_giver_troop, "$g_talk_troop"), 
		(check_quest_succeeded,"qst_mest_i_zakon"),
		(neg|check_quest_finished,"qst_mest_i_zakon"),
		(quest_slot_eq, "qst_mest_i_zakon", slot_quest_current_state, 1), 
	], "{!}NOT SHOWN", "qst_mest_i_zakon_talk_end",[]],	

	[anyone|auto_proceed, "start", [
		(quest_get_slot, ":lord", "qst_mest_i_zakon", slot_quest_giver_troop), 
		(eq, "$g_talk_troop", ":lord"), 
		(check_quest_failed,"qst_mest_i_zakon"),
		(neg|check_quest_finished,"qst_mest_i_zakon"),
	], "{!}NOT SHOWN", "qst_mest_i_zakon_talk_end_2",[]],	
	
	[anyone|auto_proceed, "oim_lord_sp_task", [
		(eq, "$oim_quest_kidalovo_z_konyem", 0), 
		(call_script, "script_cf_oim_check_quest_kidalovo_z_konyem"), 
		(neg|check_quest_finished,"qst_oim_kidalovo_z_konyem"),
		], "{!}NOT SHOWN", "oim_qst_kidalovo_z_konyem_dlg",[(assign, "$oim_quest_kidalovo_z_konyem", 1),]],

	#
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_bandit"), 
		(eq, "$oim_horse_ambush_dlg", 1),
		(check_quest_active, "qst_oim_kidalovo_z_konyem"),
		(neg|check_quest_finished,"qst_oim_kidalovo_z_konyem"),
	], "{!}NOT SHOWN", "oim_horse_ambush_dlg",[(assign, "$oim_horse_ambush_dlg", 0),]],	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_bandit"), 
		(eq, "$oim_horse_ambush_dlg", 2),
		(check_quest_active, "qst_oim_kidalovo_z_konyem"),
		(quest_slot_eq, "qst_oim_kidalovo_z_konyem", slot_quest_current_state, 0),
		(neg|check_quest_finished,"qst_oim_kidalovo_z_konyem"),
	], "{!}NOT SHOWN", "oim_horse_ambush_dlg2",[(assign, "$oim_horse_ambush_dlg", 0),]],	
	
	
	#(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_target_troop, ":king"),
	[anyone|auto_proceed, "start", [
		(quest_slot_eq, "qst_oim_kidalovo_z_konyem", slot_quest_target_troop, "$g_talk_troop"),
		(check_quest_active, "qst_oim_kidalovo_z_konyem"),
		(neg|check_quest_finished,"qst_oim_kidalovo_z_konyem"),
		(player_has_item, "itm_hunter"),
		#(troop_remove_items, "trp_player", "itm_hunter", 1),
	], "{!}NOT SHOWN", "oim_horse_delivered_dlg",[]],
	
	#moskoviti
	[party_tpl|pt_oim_monfor_party|auto_proceed, "start", [
		(eq, "$oim_rekomendaciya_k_trubeckomu", 0), 
		(call_script, "script_cf_oim_check_letter_to_trubeckoy"), 
	], "{!}NOT SHOWN", "oim_rekomendaciya_k_trubeckomu", [(assign, "$oim_rekomendaciya_k_trubeckomu", 1),]], 
	
	#OiM potop hacks
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(eq, "$oim_can_recruit_zagloba", 1),
		(check_quest_active, "qst_oim_potop_find_zagloba"),
		(neg|check_quest_finished,"qst_oim_potop_find_zagloba"),
	], "{!}NOT SHOWN", "oim_zagloba_finded",[]],	
	
	[anyone|auto_proceed, "member_chat", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(eq, "$oim_can_recruit_zagloba", 1),
		(check_quest_active, "qst_oim_potop_find_zagloba"),
		(neg|check_quest_finished,"qst_oim_potop_find_zagloba"),
	], "{!}NOT SHOWN", "oim_zagloba_finded",[]],	
	
	#(assign, "oim_can_recruit_zagloba", 1), 
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(eq, "$oim_can_recruit_zagloba", 0),
	], "{!}NOT SHOWN", "oim_zagloba_auto_reject",[]],	
	
	
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(eq, "$oim_auto_talk_troop", "$g_talk_troop"),
	], "{!}NOT SHOWN", "oim_zagloba_auto_help",[(jump_to_menu, "mnu_auto_return_to_map")]],	


	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_nord_archer"), 
		(check_quest_active, "qst_oim_potop_defend_church"),
		(neg|check_quest_finished,"qst_oim_potop_defend_church"),
	], "{!}NOT SHOWN", "oim_potop_defend_church",[]],	

	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
		(check_quest_active, "qst_oim_potop_shtirlic"),
		(neg|check_quest_finished,"qst_oim_potop_shtirlic"),
		(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 1),
		(neq, "$supported_pretender", "$g_talk_troop"),
	], "{!}NOT SHOWN", "oim_potop_mahmet_girey_talk",[]],	


	[anyone|auto_proceed, "oim_zagloba_auto_help", [
		(eq, "$g_talk_troop", "trp_npc1"), 
		(check_quest_active, "qst_oim_potop_return"),
		(neg|check_quest_succeeded,"qst_oim_potop_return"),
		(neg|check_quest_finished,"qst_oim_potop_return"),
	], "{!}NOT SHOWN", "oim_potop_return_zagloba_dlg",[]],	


	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_knight_1_2_wife"), 
		(check_quest_active,"qst_oim_potop_volodievskiy"),
		(neg|check_quest_finished,"qst_oim_potop_volodievskiy"),
		(quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 3),
	], "{!}NOT SHOWN", "oim_potop_borzobogataya_dlg",[]],	

			
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_polish_lord"), 
	], "{!}NOT SHOWN", "oim_potop_polish_lord_talk",[]],	


	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_reestrovuy_kozak"), 
		(check_quest_active, "qst_oim_potop_kshetuskiy"),
		(neg|check_quest_finished,"qst_oim_potop_kshetuskiy"),
		(quest_slot_eq, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 3), 
	], "{!}NOT SHOWN", "oim_potop_kozaks_guard",[]],	


	############################################################################
	##  OiM Black Getman code
	############################################################################
	#[anyone|auto_proceed, "start", [
	#	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	#	(eq, "$g_talk_troop_met", 0), 
	#], "{!}NOT SHOWN", "oim_general_radzivil_start_dlg",[]],	

	#(assign, "$can_recruit_mamay", 1),
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_npc4"), 
		(eq, "$can_recruit_mamay", 0),
	], "{!}NOT SHOWN", "oim_getman_mamay_auto_reject",[]],	

	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_zagloba_qst"), 
	], "{!}NOT SHOWN", "oim_potop_zagloba_pre_fight_dlg",[]],	

	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop_faction", "fac_kingdom_5"),
		(is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
		(store_relation, ":ralation", "$g_talk_troop_faction", "fac_player_faction"),
		(ge, ":ralation", 10),		
		(eq, "$oim_getman_inited", 0),
		
 	    (neq, "$g_main_quest_active", 1),
	    (neq, "$g_main_quest_active", 2),
	], "{!}NOT SHOWN", "oim_getman_initial_dlg",[(assign, "$oim_getman_inited", 1),]],	

	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_old_man_qst"), 
	], "{!}NOT SHOWN", "oim_getman_init_dlg_old_man",[]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_radzivill_capture_city"),
		(quest_slot_eq, "qst_oim_getman_radzivill_capture_city", slot_quest_current_state, 1), 
		(eq, "$oim_auto_talk_troop", "$g_talk_troop"), 
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
		(quest_slot_eq, "qst_oim_getman_main", slot_quest_current_state, 2),
		#(lt, "$g_center_taken_by_player_faction", 1),
	], "{!}NOT SHOWN", "oim_getman_radzivil_city_captured",[]],
	
	#qst_oim_getman_main
	#qst_rebel_against_kingdom
	#[anyone|auto_proceed, "start", [
	#	(check_quest_active, "qst_oim_getman_main"),
	#	(neg|check_quest_succeeded, "qst_oim_getman_main"), 
	#	(neg|check_quest_finished,"qst_oim_getman_main"),
	#	(check_quest_active, "qst_rebel_against_kingdom"),
	#	(neg|check_quest_succeeded, "qst_rebel_against_kingdom"), 
	#	(neg|check_quest_finished,"qst_rebel_against_kingdom"),
	#	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	#], "{!}NOT SHOWN", "supported_pretender_pretalk",[]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_capture_tatarin"),
		(neg|check_quest_succeeded, "qst_oim_getman_capture_tatarin"), 
		(neg|check_quest_finished,"qst_oim_getman_capture_tatarin"),
		(this_or_next|quest_slot_eq, "qst_oim_getman_capture_tatarin", slot_quest_target_troop, "$g_talk_troop"), 
		(eq, "$oim_auto_talk_troop", "$g_talk_troop"),
		#(is_between, "$g_talk_troop", "trp_knight_3_1", "trp_knight_4_1"),
		#(quest_slot_eq, "qst_oim_getman_capture_tatarin", slot_quest_current_state, 1), 
	], "{!}NOT SHOWN", "oim_getman_captured_tatarin_dlg", []],
	#(quest_get_slot, ":talk_troop", "qst_oim_getman_capture_tatarin", slot_quest_target_troop), 
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesviz_legend"),
		(neg|check_quest_succeeded, "qst_oim_getman_nesviz_legend"), 
		(neg|check_quest_finished,"qst_oim_getman_nesviz_legend"),
		(quest_slot_eq, "qst_oim_getman_nesviz_legend", slot_quest_target_troop, "$g_talk_troop"), 
	], "{!}NOT SHOWN", "oim_getman_deserters_talk_next", []],

	#", "qst_oim_lendliz2
	#"trp_don_cossack"), 
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_lendliz2"),
		(quest_slot_eq, "qst_oim_lendliz2", slot_quest_current_state, 1),
		(eq, "$oim_auto_talk_troop", "trp_don_cossack"), 
		(eq, "$oim_auto_talk_troop", "$g_talk_troop"),
	], "{!}NOT SHOWN", "oim_don_cossaks_responce",[]],	

	 #qst_oim_potop_execute_king
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
		(check_quest_active, "qst_oim_potop_execute_king"),
		(neg|check_quest_succeeded, "qst_oim_potop_execute_king"), 
		(neg|check_quest_finished,"qst_oim_potop_execute_king"),
		(neq, "$talk_context", tc_hero_defeated),
		(neq, "$talk_context", tc_ally_thanks), 
		(neq, "$talk_context", tc_hero_freed), 
	], "{!}NOT SHOWN", "oim_potop_king_before_execution_talk",[]],	

	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_swadian_sergeant"), 
		(check_quest_active, "qst_oim_potop_final_qst"),
		(check_quest_succeeded, "qst_oim_potop_final_qst"), 
		(neg|check_quest_finished,"qst_oim_potop_final_qst"),
	], "{!}NOT SHOWN", "oim_potop_qst_oim_potop_final_qst_guard_talk",[]],	

	#oim_killer_qst
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_killer_qst"), 
		(check_quest_active, "qst_oim_potop_final_qst"),
		(check_quest_succeeded, "qst_oim_potop_final_qst"), 
		(neg|check_quest_finished,"qst_oim_potop_final_qst"),
	], "{!}NOT SHOWN", "oim_potop_qst_oim_potop_final_qst_killer_talk",[]],	
	
    #
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_knight_2_14"), 
		(check_quest_active, "qst_oim_getman_tayna_knyaza"),
		(neg|check_quest_succeeded, "qst_oim_getman_tayna_knyaza"), 
		(neg|check_quest_finished,"qst_oim_getman_tayna_knyaza"),
		(neq,"$talk_context",tc_hero_defeated),
	], "{!}NOT SHOWN", "oim_getman_knyaz_boryat_dlg",[]],	

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_voron_translate"),
		(neg|check_quest_finished,"qst_oim_getman_voron_translate"),
		(quest_slot_eq, "qst_oim_getman_voron_translate", slot_quest_current_state, 1), 
		(eq, "$g_talk_troop", "trp_oim_getman_pafnutiy"), 
	], "{!}NOT SHOWN", "oim_getman_pafnut_start_dlg",[]],			
	
	#(quest_slot_eq, "qst_oim_getman_voron_translate", slot_quest_current_state, 2),
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_voron_translate"),
		(neg|check_quest_succeeded, "qst_oim_getman_voron_translate"),
		(neg|check_quest_finished,"qst_oim_getman_voron_translate"),
		(quest_slot_eq, "qst_oim_getman_voron_translate", slot_quest_current_state, 2), 
		(eq, "$g_talk_troop", "trp_oim_getman_pafnutiy"), 
	], "{!}NOT SHOWN", "oim_getman_pafnut_delivered_dlg",[]],			

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_voron_translate"),
		(check_quest_succeeded, "qst_oim_getman_voron_translate"),
		(neg|check_quest_finished,"qst_oim_getman_voron_translate"),
		(quest_slot_eq, "qst_oim_getman_voron_translate", slot_quest_current_state, 3), 
		(eq, "$g_talk_troop", "trp_oim_getman_pafnutiy"), 
	], "{!}NOT SHOWN", "oim_getman_pafnut_translated_book",[]],		
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_kozak_legend"),
		(neg|check_quest_succeeded, "qst_oim_getman_kozak_legend"),
		(neg|check_quest_finished,"qst_oim_getman_kozak_legend"),
		(quest_slot_eq, "qst_oim_getman_kozak_legend", slot_quest_current_state, 1), 
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_kozak_legend_mamay_dlg",[]],

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_kill_radzivill"),
		(neg|check_quest_succeeded, "qst_oim_getman_kill_radzivill"), 
		(neg|check_quest_finished,"qst_oim_getman_kill_radzivill"),
		(quest_slot_eq, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 3),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_radzivil_npc2_dlg",[]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"), 
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 3),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_target_troop, "$g_talk_troop"),
	], "{!}NOT SHOWN", "oim_getman_radzivil_died",[]],	

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(neg|check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"), 
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_mamay_nesviz_dlg_encounter",[]],

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(neg|check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"), 
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 2),
		(eq, "$g_talk_troop", "trp_swadian_man_at_arms"), 
	], "{!}NOT SHOWN", "oim_getman_nesviz_post_battle_dlg_prisoner",[]],

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(neg|check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"), 
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 2),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_nesviz_mamay_dlg",[]],
	

	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_kill_radzivill"),
		(neg|check_quest_succeeded, "qst_oim_getman_kill_radzivill"), 
		(neg|check_quest_finished,"qst_oim_getman_kill_radzivill"),
		(quest_slot_eq, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_swadian_crossbowman"), 
	], "{!}NOT SHOWN", "oim_getman_guard_dlg_before_fight",[]],

	#
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_kill_radzivill"),
		(neg|check_quest_succeeded, "qst_oim_getman_kill_radzivill"), 
		(neg|check_quest_finished,"qst_oim_getman_kill_radzivill"),
		(quest_slot_eq, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	], "{!}NOT SHOWN", "oim_getman_radzivil_before_death",[]],


	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"), 
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 10),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_mamay_talk_babrabash_refused",[]],
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_caravan"),
		(check_quest_succeeded, "qst_oim_getman_caravan"), 
		(neg|check_quest_finished,"qst_oim_getman_caravan"),
		(quest_slot_eq, "qst_oim_getman_caravan", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_caravan_master"), 
	], "{!}NOT SHOWN", "oim_getman_caravan_master_talk",[]],
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_volhv"), 
	], "{!}NOT SHOWN", "oim_getman_volhv_last_dlg",[]],
	
	
	#(quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 0), 
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_korona_vitovta"),
		(neg|check_quest_succeeded, "qst_oim_getman_korona_vitovta"), 
		(neg|check_quest_finished,"qst_oim_getman_korona_vitovta"),
		(quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_mamay_korona_start_dlg",[]],
	
	#(quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 2), 
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_getman_korona_vitovta"),
		(neg|check_quest_succeeded, "qst_oim_getman_korona_vitovta"), 
		(neg|check_quest_finished,"qst_oim_getman_korona_vitovta"),
		(quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 2),
		(eq, "$g_talk_troop", "trp_npc4"), 
	], "{!}NOT SHOWN", "oim_getman_mamay_korona_finded_dlg",[]],

###########################################################################################
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_5_pretender"), 
		(eq, "$g_talk_troop_met", 0),
		(check_quest_active, "qst_oim_getman_barabash"),
		(neg|check_quest_succeeded, "qst_oim_getman_barabash"),
		(neg|check_quest_finished,"qst_oim_getman_barabash"),
		(quest_slot_eq, "qst_oim_getman_barabash", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_kingdom_5_pretender"), 
	], "{!}NOT SHOWN", "oim_getman_barabash_first_talk",[]],
	
	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
		(quest_slot_eq, "qst_oim_dmitriy_razin", slot_quest_current_state, 2),
		(neg|check_quest_active, "qst_biyars_specnaz"), 
	], "{!}NOT SHOWN", "oim_dmitriy_razin_sp_task",[]],


	#oim_dmitriy_yevangelik	
	[anyone|auto_proceed, "start", [
		#(str_store_troop_name, s2, "$g_talk_troop"), 
		#(quest_get_slot, reg0, "qst_oim_dmitriy_gerasim", slot_quest_current_state),
		#(display_log_message, "#Log: {reg0}, troop: {s2}"), 
		(check_quest_active, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_finished,"qst_oim_dmitriy_gerasim"),
		(quest_slot_eq, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 2),
		(eq, "$g_talk_troop", "trp_oim_dmitriy_yevangelik"), 
	], "{!}NOT SHOWN", "oim_dmitriy_gerasim_start_dlg",[]],	
	
	#
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_finished,"qst_oim_dmitriy_gerasim"),
		(quest_slot_eq, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 4),
		#(party_slot_eq, "$g_talk_troop", "$current_town", slot_town_elder),
	], "{!}NOT SHOWN", "oim_dmitriy_gerasim_elder",[]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_gerasim"),
		(neg|check_quest_finished,"qst_oim_dmitriy_gerasim"),
		(quest_slot_eq, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 5),
		(eq, "$g_talk_troop", "trp_oim_dmitriy_yevangelik"), 
	], "{!}NOT SHOWN", "oim_dmitriy_gerasim_last",[]],	
	
	#qst_oim_dmitriy_talk_to_voevoda
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_talk_to_voevoda"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_talk_to_voevoda"),
		(neg|check_quest_finished,"qst_oim_dmitriy_talk_to_voevoda"),
		(eq, "$g_talk_troop", "trp_knight_2_1"), 
	], "{!}NOT SHOWN", "oim_dmitriy_elena_init_dlg",[]],	
	
	
	#oim_dmitriy_eleonora_dlg
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_eleonora"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_eleonora"),
		(neg|check_quest_finished,"qst_oim_dmitriy_eleonora"),
		(quest_slot_eq, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_eleonora"), 
	], "{!}NOT SHOWN", "oim_dmitriy_eleonora_dlg",[]],	

	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_eleonora"), 
	], "{!}NOT SHOWN", "oim_dmitriy_eleonora_auto_dlg",[]],	
	
	
	#(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 1),
	#trp_eleonora

	#only once
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_tsar_prison"),
		(check_quest_succeeded, "qst_oim_dmitriy_tsar_prison"),
		(neg|check_quest_finished,"qst_oim_dmitriy_tsar_prison"),
		(quest_slot_eq, "qst_oim_dmitriy_tsar_prison", slot_quest_current_state, 1),
		(eq, "$g_talk_troop_faction", "fac_kingdom_2"), 
		(eq, "$oim_talked_about_razin", 0), 
		(neq, "$g_talk_troop", "trp_kingdom_2_lord"),
		(neq, "$g_talk_troop", "trp_kingdom_2_pretender"),
		(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
	], "{!}NOT SHOWN", "oim_dmitriy_razin_init_dlg",[(assign, "$oim_talked_about_razin", 1), ]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_dmitriy_tsar_prison"),
		(check_quest_succeeded, "qst_oim_dmitriy_tsar_prison"),
		(neg|check_quest_finished,"qst_oim_dmitriy_tsar_prison"),
		(quest_slot_eq, "qst_oim_dmitriy_tsar_prison", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_kingdom_2_lord"), 
	], "{!}NOT SHOWN", "oim_dmitriy_king_talk",[]],	
	
	#start
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_alevtina_hanum"),
		(neg|check_quest_succeeded, "qst_oim_alevtina_hanum"),
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
		(eq, "$g_talk_troop", "trp_knight_2_17"), 
		(quest_slot_ge, "qst_biyars_specnaz", slot_quest_current_state, 0),
	], "{!}NOT SHOWN", "oim_dmitriy_nikita_auto_responce",[]],	
	
	
	#trp_saymen	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_alevtina_hanum"),
		(neg|check_quest_succeeded, "qst_oim_alevtina_hanum"),
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
		(eq, "$g_talk_troop", "trp_saymen"), 
		(quest_slot_eq, "qst_oim_alevtina_hanum", slot_quest_target_center, "$g_encountered_party"),
	], "{!}NOT SHOWN", "oim_dmitriy_alevtina_guard_dlg",[]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_alevtina_hanum"),
		(neg|check_quest_succeeded, "qst_oim_alevtina_hanum"),
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
		#(quest_slot_eq, "qst_oim_alevtina_hanum", slot_quest_current_state, 3),
		(eq, "$g_talk_troop", "trp_alevtina"), 
	], "{!}NOT SHOWN", "oim_dmitriy_alevtina_garem_dlg",[]],	
	
	
	
#Auto-responders for OiM 	
	[anyone, "start", [
		(eq, "$g_talk_troop", "trp_alevtina"), 
	], "Off you go!", "close_window", []], 
	
	[anyone|auto_proceed, "start", [
		(call_script, "script_cf_oim_check_dmitriy_auto_msg"), 
		(eq, "$g_discussed_mc_king", 0), 
		(eq, "$g_talk_troop_faction", "fac_player_supporters_faction"), 
		#(is_between, kingdom_heroes_begin, kingdom_heroes_end), 
		(neq, "$g_talk_troop", "trp_kingdom_2_pretender"),
		(check_quest_active, "qst_oim_dmitriy_main"),
	], "{!}NOT SHOWN", "oim_dmitriy_sarin_na_kichku_dlg",[(assign, "$g_discussed_mc_king", 1),]],	
	
	[anyone|auto_proceed, "start", [
		(check_quest_active, "qst_oim_black_lord"),
		(neg|check_quest_succeeded, "qst_oim_black_lord"),
		(neg|check_quest_finished,"qst_oim_black_lord"),
		(quest_slot_eq, "qst_oim_black_lord", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
	], "{!}NOT SHOWN", "oim_dmitriy_razin_ending_dlg",[]],	

	[anyone|auto_proceed, "event_triggered", [
		(eq, "$talk_context", tc_rebel_thanks),
		(check_quest_active, "qst_oim_black_lord"),
		(neg|check_quest_succeeded, "qst_oim_black_lord"),
		(neg|check_quest_finished,"qst_oim_black_lord"),
		#(quest_slot_eq, "qst_oim_black_lord", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
	], "{!}NOT SHOWN", "oim_dmitriy_razin_ending_dlg",[]],	
	
	
	[anyone, "event_triggered", [
		(eq, "$talk_context", tc_rebel_thanks),
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
		(check_quest_active, "qst_oim_dmitriy_main"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_main"),
		(neg|check_quest_finished,"qst_oim_dmitriy_main"),
		(check_quest_active, "qst_rebel_against_kingdom"),
		(neg|check_quest_active, "qst_oim_black_lord"),
    ],  "The lands of Moscow celebrate!", "oim_dmitriy_razin_rebel_end", []],
	
	[anyone|auto_proceed, "start", [
		#(quest_set_slot, "qst_oim_black_lord", slot_quest_current_state, 2),		
		(check_quest_active, "qst_oim_black_lord"),
		(neg|check_quest_succeeded, "qst_oim_black_lord"),
		(neg|check_quest_finished,"qst_oim_black_lord"),
		(quest_slot_eq, "qst_oim_black_lord", slot_quest_current_state, 2),
		(neq, "$g_talk_troop_faction", "fac_kingdom_2"), 
		(neq, "$g_talk_troop", "trp_kingdom_2_pretender"),
		(is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
		(troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, 0), 
		(eq,"$talk_context",tc_party_encounter),
		(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
	], "{!}NOT SHOWN", "oim_dmitriy_vlastilin_dlg",[]],	
	
### OiM 
	[anyone|auto_proceed, "start", [
		(is_between, "$g_talk_troop", oim_tavern_visitors_begin, oim_tavern_visitors_end), 
	], "{!}NOT SHOWN", "oim_tavern_visitor_dlg",[]],	

###########################################################################################
##
##    OiM GE Code
##   
###########################################################################################	
	
    #oim_guild_master
	#[anyone|auto_proceed, "start", [
	#	(is_between, "$g_talk_troop", oim_guild_master_begin, oim_guild_master_end), 
	#], "{!}NOT SHOWN", "oim_guild_master_talk",[]],	

	[anyone|auto_proceed, "start", [
		(eq, "$g_talk_troop", "trp_oim_caravan_master"), 
	], "{!}NOT SHOWN", "oim_caravan_master_dlg",[]],	
	
	

	
###########################################################################################   
   
   
	
  [trp_ramun_the_slave_trader, "start", [
   (troop_slot_eq, "$g_talk_troop", slot_troop_met_previously, 0),
   ], "Good day to you, {young man/my lass}.", "ramun_introduce_1",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_1", [], "You look like a trader... but I don't see any merchandise.", "ramun_introduce_2",[
   (troop_set_slot, "$g_talk_troop", slot_troop_met_previously, 1),
  ]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_1", [], "I beg your pardon -- there's no time for talk just now.", "close_window",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_2", [], "A trader? Oh, aye, I certainly am that. My merchandise is quite special, however. It has to be fed and watered twice a day and tries to run away if I turn my back.", "ramun_introduce_3",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_3", [], "You sell livestock?", "ramun_introduce_4",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_4", [], "Near enough. It is thanks to me that the galleys of the Sublime Porte move, by my grace sail the taridas of the king of Sicily and even the ships of Louis the king of France.", "ramun_introduce_5",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_5", [], "Ah, galley slaves...", "ramun_introduce_6",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_6", [], "Galley slaves, indeed! This city prospers thanks to my living goods. I am but its humble servant -- so to speak.", "ramun_introduce_7",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_7", [], "Where do your slaves come from?", "ramun_introduce_8",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_8", [], "They come to me in a number of ways -- some are Yesir, Tatar captives or prisoners of war, or bandits and deserters captured during raids... You can't be picky about your suppliers in this line of work. You wouldn't happen to have any prisoners yourself, would you?", "ramun_introduce_9",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_9", [], "Me? ", "ramun_introduce_10",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_10", [], "And why not? You're a warrior clear enough, and in your battles you might take a prisoner or two. Anyhow, I pay good money for every man you can offer.", "ramun_introduce_11",[]],
  [trp_ramun_the_slave_trader|plyr, "ramun_introduce_11", [], "Hmm. I'll think about it.", "ramun_introduce_12",[]],
  [trp_ramun_the_slave_trader, "ramun_introduce_12", [], "See that you do! There's a lot of silver to be made, make no mistake. More than enough for the both of us.", "close_window",[]],

  [trp_ramun_the_slave_trader,"start", [], "Hello, {playername}.", "ramun_talk",[]],
  [trp_ramun_the_slave_trader,"ramun_pre_talk", [], "What can I do for you?", "ramun_talk",[]],

  [trp_ramun_the_slave_trader|plyr,"ramun_talk",
   [[store_num_regular_prisoners,reg(0)],[ge,reg(0),1]],
   "I have something that might be of interest to you.", "ramun_sell_prisoners",[]],
  [trp_ramun_the_slave_trader,"ramun_sell_prisoners", [],
  "Well, then. Let's see what you have...", "ramun_sell_prisoners_2",
   [[change_screen_trade_prisoners]]],
  [trp_ramun_the_slave_trader, "ramun_sell_prisoners_2", [], "A pleasure doing business with you.", "close_window",[]],

  [trp_ramun_the_slave_trader|plyr,"ramun_talk", [(neg|troop_slot_ge,"$g_talk_troop",slot_troop_met_previously,1)], "Could you give a few tips on how to take somebody prisoner?", "ramun_ask_about_capturing",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_talk", [(troop_slot_ge,"$g_talk_troop", slot_troop_met_previously, 1)], "Can you tell me again about taking prisoners?", "ramun_ask_about_capturing",[(troop_set_slot,"$g_talk_troop", slot_troop_met_previously, 2)]],

  [trp_ramun_the_slave_trader,"ramun_ask_about_capturing", [(neg|troop_slot_ge,"$g_talk_troop",slot_troop_met_previously,1)],
 "Ha, you're new to this, aren't you? Well it's not complicated. The basic rule of taking someone prisoner is to knock him down with a blunt weapon, like a mace or a club, instead of cutting him open with a sword. That way he goes to sleep for a little while, instead of bleeding to death, you see? You do have a blunt weapon, don't you?", "ramun_have_blunt_weapon",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_have_blunt_weapon", [],
 "Of course.", "ramun_have_blunt_weapon_yes",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_have_blunt_weapon", [],
 "Umm, I don't think so.", "ramun_have_blunt_weapon_no",[]],
  [trp_ramun_the_slave_trader,"ramun_have_blunt_weapon_yes", [],
 "Good. So, all you need to do is beat the sorry sod down with your weapon, and then when the fighting's over you clap him in irons. It's a bit different for nobles and such, since they tend to be protected well enough that it won't matter what kind of weapon you use. But your average rabble-rouser will bleed like a stuck pig if you go at him with anything sharp. I'm not too picky about what I'll buy, so long as they can walk.", "ramun_ask_about_capturing_2",[]],
  [trp_ramun_the_slave_trader,"ramun_have_blunt_weapon_no", [],
 "No? Heh, well, this must just be your lucky day. I've got an old club lying around that I was going to throw away. Here, have it, it's still strong enough to knock someone unconscious.","ramun_have_blunt_weapon_no_2",[(troop_add_item, "trp_player","itm_club",imod_cracked)]],
  [trp_ramun_the_slave_trader|plyr,"ramun_have_blunt_weapon_no_2", [],
 "Thank you. I'll give it a try.", "ramun_have_blunt_weapon_yes",[]],
  [trp_ramun_the_slave_trader,"ramun_ask_about_capturing", [],
 "Alright, I'll try and explain it again in simple terms. The basic rule of taking someone prisoner is to knock him down with a blunt weapon, like a mace or a club, instead of cutting him open with a sword. That way he goes to sleep for a little while, instead of bleeding to death, you see? It's a bit different for nobles and such, since they tend to be protected well enough that it won't matter what kind of weapon you use. But your average rabble-rouser will bleed like a stuck pig if you go at him with anything sharp.", "ramun_ask_about_capturing_2",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_ask_about_capturing_2", [], "Alright, I think I understand. Anything else?", "ramun_ask_about_capturing_3",[]],
  [trp_ramun_the_slave_trader,"ramun_ask_about_capturing_3", [],
 "Well, it's not as simple as it sounds. Blunt weapons don't do as much damage as sharp ones, so you'll have a little more trouble bringing your enemies down. And trust me, most of the scum you run across would just as soon kill you as look at you, if you give them half a chance. So don't expect any courtesy when you pull out a club instead of a sword. Plus, having to drag prisoners around will slow down your party, which is why some people just set their prisoners free after the fighting's done. Me, I call that madness. How could anyone turn down all that cash, eh?", "ramun_ask_about_capturing_4",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_ask_about_capturing_4", [],
 "Is that it?", "ramun_ask_about_capturing_5",[]],
  [trp_ramun_the_slave_trader,"ramun_ask_about_capturing_5", [],
 "Ah yes, just one last thing. Managing prisoners is no easy task -- you could call it a skill in itself. If you want to capture a lot of prisoners, it'll take no little sweat, or you won't be able to hang on to a single man you catch.", "ramun_ask_about_capturing_7",[]],
  [trp_ramun_the_slave_trader|plyr,"ramun_ask_about_capturing_7", [],
 "Thanks, I'll keep it in mind.", "ramun_pre_talk",[]],

  [trp_ramun_the_slave_trader|plyr,"ramun_talk", [], "I need to get going...", "ramun_leave",[]],
  [trp_ramun_the_slave_trader,"ramun_leave", [], "Remember, any prisoners you've got, bring them to me. I'll pay you good silver for every one.", "close_window",[]],

  
##  [trp_tutorial_trainer,"start", [(eq, "$tutorial_quest_award_taken", 1),], "I think you have trained enough. Perhaps you should go to Zendar for the next step of your adventure.", "close_window",[]],
##  [trp_tutorial_trainer,"start", [(store_character_level, ":player_level", "trp_player"),(gt, ":player_level", 1)], "I think you have trained enough. Perhaps you should go to Zendar for the next step of your adventure.", "close_window",[]],
##  [trp_tutorial_trainer,"start", [(eq, "$tutorial_quest_taken", 0),], "Greetings stranger. What's your name?", "tutorial1_1",[]],
##  [trp_tutorial_trainer|plyr, "tutorial1_1", [], "Greetings sir, it's {playername}.", "tutorial1_2", []],
##  [trp_tutorial_trainer, "tutorial1_2", [], "Well {playername}, this place you see is the training ground. Locals come here to practice their combat skills. Since you are here you may have a go as well.", "tutorial1_3", []],
##  [trp_tutorial_trainer|plyr, "tutorial1_3", [], "I'd like that very much sir. Thank you.", "tutorial1_4", []],
##  [trp_tutorial_trainer, "tutorial1_4", [], "You will learn the basics of weapons and riding a horse here.\
##  First you'll begin with melee weapons. Then you'll enter an archery range to test your skills. And finally you'll see a horse waiting for you.\
##  I advise you to train in all these 3 areas. But you can skip some of them, it's up to you.", "tutorial1_6", []],
##  [trp_tutorial_trainer, "tutorial1_6", [], "Tell you what, if you destroy at least 10 dummies while training, I will give you my old knife as a reward. It's a little rusty but it's a good blade.", "tutorial1_7", []],
##  [trp_tutorial_trainer|plyr, "tutorial1_7", [], "Sounds nice, I'm ready for training.", "tutorial1_9", []],
##  [trp_tutorial_trainer, "tutorial1_9", [], "Good. Return to me when you have earned your reward.", "close_window", [(eq, "$tutorial_quest_taken", 0),
##                                                                                                                     (str_store_troop_name, 1, "trp_tutorial_trainer"),
##                                                                                                                     (str_store_party_name, 2, "p_training_ground"),
##                                                                                                                     (setup_quest_giver, "qst_destroy_dummies", "str_given_by_s1_at_s2"),
##                                                                                                                     (str_store_string, s2, "@Trainer ordered you to destroy 10 dummies in the training camp."),
##                                                                                                                     (call_script, "script_start_quest", "qst_destroy_dummies", "$g_talk_troop"),
##                                                                                                                     (assign, "$tutorial_quest_taken", 1)]],
##
##  [trp_tutorial_trainer,"start", [(eq, "$tutorial_quest_taken", 1),
##                                  (eq, "$tutorial_quest_succeeded", 1),], "Well done {playername}. Now you earned this knife. There you go.", "tutorial2_1",[]],
##  [trp_tutorial_trainer|plyr, "tutorial2_1", [], "Thank you master.", "close_window", [(call_script, "script_end_quest", "qst_destroy_dummies"),(assign, "$tutorial_quest_award_taken", 1),(add_xp_to_troop, 100, "trp_player"),(troop_add_item, "trp_player","itm_knife",imod_chipped),]],
##
##  [trp_tutorial_trainer,"start", [(eq, "$tutorial_quest_taken", 1),
##                                  (eq, "$tutorial_quest_succeeded", 1),], "Greetings {playername}. Feel free to train with the targets.", "tutorial2_1",[]],
##
##  [trp_tutorial_trainer,"start", [(eq, "$tutorial_quest_taken", 1),
##                                  (eq, "$tutorial_quest_succeeded", 0),], "I don't see 10 dummies on the floor from here. You haven't earned your reward yet.", "tutorial3_1",[]],
##  [trp_tutorial_trainer|plyr, "tutorial3_1", [], "Alright alright, I was just tired and wanted to talk to you while resting.", "tutorial3_2", []],
##  [trp_tutorial_trainer, "tutorial3_2", [], "Less talk, more work.", "close_window", []],


##  [party_tpl|pt_peasant,"start", [(eq,"$talk_context",tc_party_encounter)], "Greetings traveller.", "peasant_talk_1",[(play_sound,"snd_encounter_farmers")]],
##  [party_tpl|pt_peasant|plyr,"peasant_talk_1", [[eq,"$quest_accepted_zendar_looters"]], "Greetings to you too.", "close_window",[(assign, "$g_leave_encounter",1)]],
##  [party_tpl|pt_peasant|plyr,"peasant_talk_1", [[neq,"$quest_accepted_zendar_looters"],[eq,"$peasant_misunderstanding_said"]], "I have been charged with hunting down outlaws in this area...", "peasant_talk_2",[[assign,"$peasant_misunderstanding_said",1]]],
##  [party_tpl|pt_peasant|plyr,"peasant_talk_1", [[neq,"$quest_accepted_zendar_looters"],[neq,"$peasant_misunderstanding_said"]], "Greetings. I am hunting outlaws. Have you seen any around here?", "peasant_talk_2b",[]],
##  [party_tpl|pt_peasant,"peasant_talk_2", [], "I swear to God {sir/madam}. I am not an outlaw... I am just a simple peasant. I am taking my goods to the market, see.", "peasant_talk_3",[]],
##  [party_tpl|pt_peasant|plyr,"peasant_talk_3", [], "I was just going to ask if you saw any outlaws around here.", "peasant_talk_4",[]],
##  [party_tpl|pt_peasant,"peasant_talk_4", [], "Oh... phew... yes, outlaws are everywhere. They are making life miserable for us.\
## I pray to God you will kill them all.", "close_window",[(assign, "$g_leave_encounter",1)]],
##  [party_tpl|pt_peasant,"peasant_talk_2b", [], "Outlaws? They are everywhere. They are making life miserable for us.\
## I pray to God you will kill them all.", "close_window",[(assign, "$g_leave_encounter",1)]],

  [party_tpl|pt_manhunters,"start", [(eq,"$talk_context",tc_party_encounter)], "Hey, you there! You seen any outlaws around here?", "manhunter_talk_b",[]],
  [party_tpl|pt_manhunters|plyr,"manhunter_talk_b", [], "Yes, they passed through here about an hour ago.", "manhunter_talk_b1",[]],
  [party_tpl|pt_manhunters,"manhunter_talk_b1", [], "Perfect! Now we'll get those bastards, no doubt! Thank you kindly.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [party_tpl|pt_manhunters|plyr,"manhunter_talk_b", [], "No, haven't seen any outlaws lately.", "manhunter_talk_b2",[]],
  [party_tpl|pt_manhunters,"manhunter_talk_b2", [], "The devil take them! They're holed up in this country like rats. Ah well, we'll smoke them out sooner or later.", "close_window",[(assign, "$g_leave_encounter",1)]],

  [party_tpl|pt_looters|auto_proceed,"start", [(eq,"$talk_context",tc_party_encounter)], "Warning: This line should never be displayed.", "looters_1",[
	(str_store_string, s11, "@It's your money or your life, {mate/girlie}. No sudden moves or we'll run you through."),
	(str_store_string, s12, "@Lucky for you, you caught me in a good mood. Give us all your coin and I might just let you live."),
	(str_store_string, s13, "@This a robbery, eh? I givin' you one chance to hand over everythin' you got, or me and my mates'll kill you. Understand?"),
	(store_random_in_range, ":random", 11, 14),
	(str_store_string_reg, s4, ":random"),
	(play_sound, "snd_encounter_looters")
  ]],
  [party_tpl|pt_looters,"looters_1", [], "{s4}", "looters_2",[]],

  [party_tpl|pt_looters|plyr,"looters_2", [[store_character_level,reg1,"trp_player"],[lt,reg1,4]], "Heh, you don't scare me. You'd best be ready to taste steel!", "close_window",
   [[encounter_attack]]],
  [party_tpl|pt_looters|plyr,"looters_2", [[store_character_level,reg1,"trp_player"],[ge,reg1,4]], "You'll have no pity from me, scum.", "close_window",
   [[encounter_attack]]],
  [party_tpl|pt_looters|plyr,"looters_2", 
  [
	(store_character_level, ":player_character_level", "trp_player"),
	(store_mul, "$g_tribute_amount", ":player_character_level", 30),
	(val_add, "$g_tribute_amount", 50),

	#(bandits and looters wants only 3% of player's total richness + player character level * 30 + 50)
    (store_troop_gold, ":total_value", "trp_player"),
    (troop_get_inventory_capacity, ":inv_size", "trp_player"),
    (try_for_range, ":i_slot", 0, ":inv_size"),
         (troop_get_inventory_slot, ":item_id", "trp_player", ":i_slot"),
         (ge, ":item_id", 0),
         (try_begin),
           (is_between, ":item_id", trade_goods_begin, trade_goods_end),
           (store_item_value, ":item_value", ":item_id"),
           (val_add, ":total_value", ":item_value"),
         (try_end),
    (try_end),    
	(store_div, ":total_value_div_33", ":total_value", 333),
	(val_mul, ":total_value_div_33", 10),
	(val_add, "$g_tribute_amount", ":total_value_div_33"),

	(store_troop_gold, ":player_gold", "trp_player"),
	(ge, ":player_gold", "$g_tribute_amount"),
	
	(assign, reg1, "$g_tribute_amount"),	
  ], "Take that {reg1} thalers and leave me alone.", "bandit_barter_2", []],

  [party_tpl|pt_looters,"bandit_barter_2", [], "Ha ha! Good. Now go.", "close_window",[
	(troop_remove_gold, "trp_player","$g_tribute_amount"), 
	#oim code
	(call_script, "script_get_closest_walled_center", "$g_encountered_party"), 
	(assign, ":party_to_patrol", reg0),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_main_object, ":party_to_patrol"),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_attack, 0),
	(call_script, "script_party_set_ai_state", "$g_encountered_party", spai_patrolling_around_center, ":party_to_patrol"),
	(party_set_ai_behavior, "$g_encountered_party", ai_bhvr_patrol_location),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_is_control, 17),
	(party_relocate_near_party, "$g_encountered_party", "p_main_party", 2),
	#oim code
    (store_current_hours,":protected_until"),
    (val_add, ":protected_until", 72),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,":protected_until"),
    (party_ignore_player, "$g_encountered_party", 72),	
	(party_set_ignore_with_player_party, "p_main_party", 72),

	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),

	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),

	  (le, ":dist", 25),
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	(try_end),	
	      
    (assign, "$g_leave_encounter",1),
    ]],
   

  [party_tpl|pt_village_farmers,"start", [(eq,"$talk_context",tc_party_encounter),
                                          (agent_play_sound, "$g_talk_agent", "snd_encounter_farmers"),
  ],
   "Mi{lord/lady}, we're only poor farmers from the village of {s11}. {reg1?We are taking our products to the market at {s12}.:We are returning to our village from the market at {s12}.}", "village_farmer_talk",
   [(party_get_slot, ":target_center", "$g_encountered_party", slot_party_ai_object),
    (party_get_slot, ":home_center", "$g_encountered_party", slot_party_home_center),
    (party_get_slot, ":market_town", ":home_center", slot_village_market_town),
    (str_store_party_name, s11, ":home_center"),
    (str_store_party_name, s12, ":market_town"),
    (assign, reg1, 1),
    (try_begin),
      (party_slot_eq, ":target_center", slot_party_type, spt_village),
      (assign, reg1, 0),
    (try_end),
    ]],

  [anyone|plyr,"village_farmer_talk", [], "Call yourself poor? We'll see how poor you are after I take all you own!", "close_window",
   [(party_get_slot, ":home_center", "$g_encountered_party", slot_party_home_center),
    (party_get_slot, ":market_town", ":home_center", slot_village_market_town),
    (party_get_slot, ":village_owner", ":home_center", slot_town_lord),
    (call_script, "script_change_player_relation_with_center", ":home_center", -4),
    (call_script, "script_change_player_relation_with_center", ":market_town", -2),
    (call_script, "script_change_player_relation_with_troop", ":village_owner", -2),
    (store_relation,":rel", "$g_encountered_party_faction","fac_player_supporters_faction"),
    (try_begin),
      (gt, ":rel", 0),
      (val_sub, ":rel", 5),
    (try_end),
    (val_sub, ":rel", 3),
    (call_script, "script_set_player_relation_with_faction", "$g_encountered_party_faction", ":rel"),
    ]],
  [anyone|plyr,"village_farmer_talk", [], "Very well then, go on in peace.", "close_window",[(assign, "$g_leave_encounter",1)]],


### COMPANIONS
  [anyone,"start", [(troop_slot_eq,"$g_talk_troop", slot_troop_occupation, slto_player_companion),
                    (party_slot_eq, "$g_encountered_party", slot_party_type, spt_castle),
                    (party_get_num_companion_stacks, ":num_stacks", "$g_encountered_party"),
                    (ge, ":num_stacks", 1),
                    (party_stack_get_troop_id, ":castle_leader", "$g_encountered_party", 0),
                    (eq, ":castle_leader", "$g_talk_troop"),
                    (eq, "$talk_context", 0)],
   "Yes, {playername}? What can I do for you?", "member_castellan_talk",[]],
  
  [anyone,"member_castellan_pretalk", [], "Anything else?", "member_castellan_talk",[]],
  
  [anyone|plyr,"member_castellan_talk", [],
   "I want to review the fortress garrison.", "member_review_castle_garrison",[]],
  [anyone,"member_review_castle_garrison", [], "Of course, here be our lists, {sir/madam}. Let me know if you require any changes.", "member_castellan_pretalk",[(change_screen_exchange_members,0)]],
  [anyone|plyr,"member_castellan_talk", [],
   "Let me see your equipment.", "member_review_castellan_equipment",[]],
  [anyone,"member_review_castellan_equipment", [], "Very well, it's all here...", "member_castellan_pretalk",[(change_screen_equip_other)]],
  [anyone|plyr,"member_castellan_talk", [],
   "I would ask that you to leave the fortress and join my party.", "member_castellan_join",[]],
  [anyone,"member_castellan_join", [(party_can_join_party,"$g_encountered_party","p_main_party")],
   "I've grown quite fond of the place... But if it is your wish, {playername}, I'll come with you.", "close_window", [
       (assign, "$g_move_heroes", 1),
       (call_script, "script_party_add_party", "p_main_party", "$g_encountered_party"),
       (party_clear, "$g_encountered_party"),
       ]],
  [anyone,"member_castellan_join", [],
   "And where would we sleep? You're already dragging an entire army with you, {playername}. There's no more room for all of us.", "member_castellan_pretalk",[]],
  
  [anyone|plyr,"member_castellan_talk", [], "Leave...", "close_window",[]],


#Quest heroes member chats

  [trp_kidnapped_girl,"member_chat", [], "Are we there yet?", "kidnapped_girl_chat_1",[]],
  [trp_kidnapped_girl|plyr,"kidnapped_girl_chat_1", [], "Not yet.", "kidnapped_girl_chat_2",[]],
  [trp_kidnapped_girl,"kidnapped_girl_chat_2", [], "I can't wait to get back. I've missed my mother and father so much! I'd give anything to see them again.", "close_window",[]],

  [anyone,"member_chat",
   [
    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
    ], "{playername}, when do you think we shall reach our destination?", "member_lady_1",[]],
  [anyone|plyr, "member_lady_1", [],  "We still have a long way ahead of us.", "member_lady_2a", []],
  [anyone|plyr, "member_lady_1", [],  "Very soon. We're almost there.", "member_lady_2b", []],

  [anyone ,"member_lady_2a", [],  "Very well, I shall enjoy the road for a bit longer. I shan't complain. In fact, I find riding the open fields far more pleasant than sitting in the fortress all day. You know, I must say -- I envy you. Your life of endless travels...", "close_window", []],
  [anyone ,"member_lady_2b", [],  "That's good news. Not that I find your company unpleasant, but I grow weary of these long travels. Still, I must say, I will be sorry to leave you. You must promise that you'll come visit when you can!", "close_window", []],

  [anyone ,"member_chat", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),],
   "Greetings, {playername}, chief among my warlord. I await your counsel.", "supported_pretender_talk", []],
  [anyone ,"supported_pretender_pretalk", [],
   "Anything else?", "supported_pretender_talk", []],

  [anyone|plyr,"supported_pretender_talk", [
	(check_quest_active, "qst_rebel_against_kingdom"),
  ],
   "What are your thoughts on our progress?", "pretender_progress",[]],

  [anyone|plyr,"supported_pretender_talk", [],
   "Do you have a task for me?", "oim_dmitriy_razin_sp_task",[]],
   
   
  [anyone,"pretender_progress", [
       (assign, reg11, 0),(assign, reg13, 0),(assign, reg14, 0),(assign, reg15, 0),
       (assign, reg21, 0),(assign, reg23, 0),(assign, reg24, 0),(assign, reg25, 0),
       
       (try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
         (store_troop_faction, ":troop_faction", ":troop_no"),
         (try_begin),
           (eq, ":troop_faction", "fac_player_supporters_faction"),
           (neq, ":troop_no", "trp_player"),
           (neq, ":troop_no", "$supported_pretender"),
           (val_add, reg11, 1),
         (else_try),
           (eq, ":troop_faction", "$supported_pretender_old_faction"),
           (neg|faction_slot_eq, "$supported_pretender_old_faction", slot_faction_leader, ":troop_no"),
           (val_add, reg21, 1),
         (try_end),
       (try_end),
       (try_for_range, ":center_no", centers_begin, centers_end),
         (store_faction_of_party, ":center_faction", ":center_no"),
         (try_begin),
           (eq, ":center_faction", "fac_player_supporters_faction"),
           (try_begin),
             (party_slot_eq, ":center_no", slot_party_type, spt_town),
             (val_add, reg13, 1),
           (else_try),
             (party_slot_eq, ":center_no", slot_party_type, spt_castle),
             (val_add, reg14, 1),
           (else_try),
             (party_slot_eq, ":center_no", slot_party_type, spt_village),
             (val_add, reg15, 1),
           (try_end),
         (else_try),
           (eq, ":center_faction", "$supported_pretender_old_faction"),
           (try_begin),
             (party_slot_eq, ":center_no", slot_party_type, spt_town),
             (val_add, reg23, 1),
           (else_try),
             (party_slot_eq, ":center_no", slot_party_type, spt_castle),
             (val_add, reg24, 1),
           (else_try),
             (party_slot_eq, ":center_no", slot_party_type, spt_village),
             (val_add, reg25, 1),
           (try_end),
         (try_end),
       (try_end),
       (store_add, reg19, reg13, reg14),
       (val_add, reg19, reg15),
       (store_add, reg29, reg23, reg24),
       (val_add, reg29, reg25),
       (store_add, ":our_score", reg13, reg14),
       (val_add, ":our_score", reg11),
       (store_add, ":their_score", reg23, reg24),
       (val_add, ":their_score", reg21),
       (store_add, ":total_score", ":our_score", ":their_score"),
	   (val_add, ":total_score", 1),
       (val_mul, ":our_score", 100),
       (store_div, ":our_ratio", ":our_score", ":total_score"),
       (try_begin),
         (lt, ":our_ratio", 10),
         (str_store_string, s30, "@we have made very little progress so far"),
       (else_try),
         (lt, ":our_ratio", 30),
         (str_store_string, s30, "@we have suceeded in gaining some ground, but we still have a long way to go"),
       (else_try),
         (lt, ":our_ratio", 50),
         (str_store_string, s30, "@we have become a significant force, and we have an even chance of victory"),
       (else_try),
         (lt, ":our_ratio", 75),
         (str_store_string, s30, "@we are winning the war, but our enemies are still holding on."),
       (else_try),
         (str_store_string, s30, "@we are on the verge of victory. The remaining enemies pose no threat, but we still need to hunt them down."),
       (try_end),
       (faction_get_slot, ":enemy_king", "$supported_pretender_old_faction", slot_faction_leader),
       (str_store_troop_name, s9, ":enemy_king"),
      ],
   "{reg11?We have {reg11} nobles on our side:No nobles have yet joined us}, while {reg21?{s9} has {reg21} nobles supporting him:{s9} has no loyal nobles left}. {reg19?We have gained {reg13?{reg13} towns:} {reg14?{reg14} fortresses:} {reg15?and {reg15} villages:}:We do not control any settlements}, while {reg29?they still control {reg23?{reg23} towns:} {reg24?{reg24} fortresses:} {reg25?and {reg25} villages:}:they have no remaining settlements}. Overall, {s30}.", "pretender_progress_2",[]],

  [anyone|plyr,"pretender_progress_2", [],
   "We must keep fighting and rally our supporters!", "supported_pretender_pretalk",[]],

  [anyone|plyr,"pretender_progress_2", [],
   "It seems this rebellion is doomed. We should perhaps accept that we cannot win.", "pretender_quit_rebel_confirm",[]],
  
  [anyone,"pretender_quit_rebel_confirm", [],
   "{playername}, you can't abandon me now. Has the devil taken your tongue?", "pretender_quit_rebel_confirm_2",[]],
  
  [anyone|plyr,"pretender_quit_rebel_confirm_2", [],
   "No, I speak the truth. I fear that I cannot support you any longer.", "pretender_quit_rebel_confirm_3",[]],
  
  [anyone|plyr,"pretender_quit_rebel_confirm_2", [],
   "It was a mere jest. I will fight by your side until the last gun lies cold.", "supported_pretender_pretalk",[]],
 
   [anyone,"pretender_quit_rebel_confirm_3", [],
   "Are you quite certain? I shall never forgive you if you abandon our cause in our hour of greatest need.", "pretender_quit_rebel_confirm_4",[]],
  
  [anyone|plyr,"pretender_quit_rebel_confirm_4", [],
   "Yes, I am quite sure.", "pretender_quit_rebel",[]],
  
  [anyone|plyr,"pretender_quit_rebel_confirm_4", [],
   "Let me think on this further...", "supported_pretender_pretalk",[]],
 
  [anyone,"pretender_quit_rebel", [],
   "So be it. Then we are lost. There is no hope, and I must accept this.", "close_window",
   [
     (troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
     (try_for_range, ":cur_troop", kingdom_heroes_begin, kingdom_heroes_end),
	   (neq, "$supported_pretender", ":cur_troop"),
       (store_troop_faction, ":cur_faction", ":cur_troop"),
       (eq, ":cur_faction", "fac_player_supporters_faction"),
       (call_script, "script_change_troop_faction", ":cur_troop", ":original_faction"),
     (try_end),
     (troop_set_faction, "$g_talk_troop", "fac_neutral"),
     (faction_set_slot, "fac_player_supporters_faction", slot_faction_leader, "trp_player"),
     (assign, ":has_center", 0),
     (try_for_range, ":cur_center", centers_begin, centers_end),
       (store_faction_of_party, ":cur_faction", ":cur_center"),
       (eq, ":cur_faction", "fac_player_supporters_faction"),
       (assign, ":has_center", 1),
       (neg|party_slot_eq, ":cur_center", slot_town_lord, "trp_player"),
       (call_script, "script_give_center_to_lord", ":cur_center", "trp_player", 0),
     (try_end),
     (party_remove_members, "p_main_party", "$supported_pretender", 1),
     (faction_set_slot, ":original_faction", slot_faction_has_rebellion_chance, 0),
     (assign, "$supported_pretender", 0),
     (try_begin),
       (eq, ":has_center", 1),
       (faction_set_color, "fac_player_supporters_faction", 0xAAAAAA),
     (else_try),
       (call_script, "script_activate_deactivate_player_faction", -1),
     (try_end),
     (call_script, "script_change_player_honor", -20),
     (call_script, "script_fail_quest", "qst_rebel_against_kingdom"),
     (call_script, "script_end_quest", "qst_rebel_against_kingdom"),
    ]],


  [anyone|plyr,"supported_pretender_talk", [],
   "{reg65?My lady:My lord}, would you allow me to examine your equipment?", "supported_pretender_equip",[]],
  [anyone,"supported_pretender_equip", [], "Very well, take a look...", "supported_pretender_pretalk",[
      (change_screen_equip_other),
      ]],

  [anyone|plyr,"supported_pretender_talk", [], "If you wouldn't mind, could you please tell me of your skills?", "pretneder_view_char_requested",[]],
  [anyone,"pretneder_view_char_requested", [], "Certainly...", "supported_pretender_pretalk",[(change_screen_view_character)]],


  ############################################
  ##  OiM Black Getman code
  ############################################

  [anyone|plyr,"supported_pretender_talk", [
	#oim code
	#qst_oim_getman_radzivill_rebelion
	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	(check_quest_active, "qst_oim_getman_main"), 
  ],
   "What are your orders, my {lord/lady}?", "oim_radzivil_dlg_orders",[]],

   #(call_script, "script_succeed_quest", "qst_oim_getman_kiev_burgomistr"), 
  [anyone|plyr,"supported_pretender_talk", [
	#qst_oim_getman_radzivill_rebelion
	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	(check_quest_active, "qst_oim_getman_kiev_burgomistr"), 
	(check_quest_succeeded, "qst_oim_getman_kiev_burgomistr"), 
	(neg|check_quest_finished, "qst_oim_getman_kiev_burgomistr"), 
  ],
   "I found out all you needed from the mayor of Kiev...", "oim_radzivil_dlg_kiev_report",[]],

#qst_oim_getman_ask_add_info
  [anyone|plyr,"supported_pretender_talk", [
	#oim code
	#qst_oim_getman_radzivill_rebelion
	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	(check_quest_active, "qst_oim_getman_ask_add_info"), 
	(neg|check_quest_succeeded, "qst_oim_getman_ask_add_info"),
	(neg|check_quest_finished, "qst_oim_getman_ask_add_info"), 
  ],
   "So then, Prince Janusz, would you tell me of the Black Mace?", "oim_getman_ask_add_info_dlg",[]],

	#fix it!
   [anyone|plyr,"supported_pretender_talk", [
	#oim code
	#qst_oim_getman_radzivill_rebelion
	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	(check_quest_active, "qst_oim_getman_capture_tatarin"), 
	(check_quest_succeeded, "qst_oim_getman_capture_tatarin"),
	(neg|check_quest_finished, "qst_oim_getman_capture_tatarin"), 
  ],
   "I have brought the prisoner.", "oim_getman_tatarin_captured",[]],

   [anyone|plyr,"supported_pretender_talk", [
	#oim code
	#qst_oim_getman_radzivill_rebelion
	(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	(check_quest_active, "qst_oim_getman_kiev_capture"), 
	(check_quest_succeeded, "qst_oim_getman_kiev_capture"),
	(neg|check_quest_finished, "qst_oim_getman_kiev_capture"), 
  ],
   "I have captured Kiev...", "oim_getman_kiev_captured_dlg",[]],


   
  [anyone|plyr,"supported_pretender_talk", [],
   "Let us keep going, {reg65?my lady:my lord}.", "close_window",[(assign, "$g_leave_encounter", 1),]],


  [anyone,"do_member_trade", [], "Will there be anything else?", "member_talk",[]],
#fix it!!!
  
  [anyone,"member_chat", [	
						    (eq, 0, 1),
							#(store_conversation_troop,"$g_talk_troop"),
                            #(troop_is_hero,"$g_talk_troop"),
							#(eq, "$g_talk_troop", "trp_npc1"), 
							#(call_script, "script_oim_get_zagloba_dlg_idx"), 
							#(eq, "$oim_zagloba_crn_dlg", 2), 
							#(store_add, ":zagloba_text", "str_oim_was_killed_while_in_town", "$oim_zagloba_crn_dlg"), 
							#(str_store_string, s2, ":zagloba_text"),
                          ], "{s6}", "member_talk",[]],
						  
  [anyone,"member_chat", [#(store_conversation_troop,"$g_talk_troop"),
                          (troop_is_hero,"$g_talk_troop"),
						  (try_begin), 
							(eq, "$g_talk_troop", "trp_npc1"), 
							(call_script, "script_oim_get_zagloba_dlg_idx"), 
							(store_add, ":zagloba_text", "str_zagloba_member_chat_1", "$oim_zagloba_crn_dlg"), 
							(str_store_string, s6, ":zagloba_text"),
						  (else_try), 
							(troop_get_slot, ":honorific", "$g_talk_troop", slot_troop_honorific),
							(str_store_string, s5, ":honorific"),
							(str_store_string, s6, "@Yes, {s5}?"),
						  (end_try), 
						  (neq, "$g_talk_troop", "trp_oim_tatarin_zolotarenko"),
						  (neq, "$g_talk_troop", "trp_oim_monfor"),
						  (neq, "$g_talk_troop", "trp_alevtina"),
						  (neq, "$g_talk_troop", "trp_knight_1_2_wife"),
						  (neq, "$g_talk_troop", "trp_eleonora"),
						  #(neq, "$g_talk_troop", "trp_"
						  #(str_store_troop_name, s2, "$g_talk_troop"),
						  #(display_message, "@talking to: s2"),
                          #(call_script, "script_add_log_entry", logent_lord_captured_by_player, "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),						  
                          ], "{s6}", "member_talk",[]],

  [anyone|plyr,"member_talk", [],

   "Let me see your equipment.", "member_trade",[]],
  [anyone,"member_trade", [], "Very well, it's all here...", "do_member_trade",[
#      (change_screen_trade)
      (change_screen_equip_other),
      ]],

  [anyone,"do_member_trade", [], "Anything else?", "member_talk",[]],

  [anyone|plyr,"member_talk", [(eq, "$g_talk_troop", "trp_npc1"), ], "Colonel Zagloba, tell me -- what do you think I should do next?", "oim_zagloba_help_answer",[]],

  [anyone|plyr,"member_talk", [
	(eq, "$g_talk_troop", "trp_npc4"), 
    (check_quest_active, "qst_oim_getman_kozak_legend"),
	(check_quest_succeeded, "qst_oim_getman_kozak_legend"), 
	(neg|check_quest_finished,"qst_oim_getman_kozak_legend"),
  ], "Have you heard the old legend of the Black Mace?", "oim_getman_mamay_kozak_legend_story",[]],
  
  
  
  [anyone|plyr,"member_talk", [], "What can you tell me about your skills?", "view_member_char_requested",[]],
  [anyone,"view_member_char_requested", [], "Ah yes, let me tell you...", "do_member_view_char",[(change_screen_view_character)]],

  [anyone|plyr,"member_talk", [(neq, "$g_talk_troop", "trp_npc1"),(neq, "$g_talk_troop", "trp_npc4"),], "We need to go our separate ways for a while.", "member_separate",[
            (call_script, "script_npc_morale", "$g_talk_troop"),
            (assign, "$npc_quit_morale", reg0),
      ]],

  [anyone,"member_separate", [
            (gt, "$npc_quit_morale", 30),
      ], "You realize I'm not just going to sit here and wait for you to come back. I'll be going into the towns to look for other work. Is that really what you want?", "member_separate_confirm",
   []],

  [anyone,"member_separate", [
      ], "Well, actually, there was something I needed to tell you.", "companion_quitting",
   [
        (assign, "$player_can_refuse_npc_quitting", 0),
        (assign, "$player_can_persuade_npc", 0),
       ]],


  [anyone|plyr,"member_separate_confirm", [], "You're free to do as you please. Like I said, we need to part ways.", "member_separate_yes",[]],
  [anyone|plyr,"member_separate_confirm", [], "No, I'd rather have you at my side.", "do_member_trade",[]],

  [anyone,"member_separate_yes", [
      ], "Very well, I'll be off then. Find me if you have need of me.", "close_window",
   [
            (troop_set_slot, "$g_talk_troop", slot_troop_occupation, 0),
            (troop_set_slot, "$g_talk_troop", slot_troop_playerparty_history, pp_history_dismissed),
            (remove_member_from_party, "$g_talk_troop"),
       ]],


  [anyone|plyr,"member_talk", [], "I'd like to ask you something.", "member_question",[]],

  [anyone|plyr,"member_talk", [], "No time for talk right now.", "close_window",[]],

  [anyone,"member_question", [], "Very well. What did you want to ask?", "member_question_2",[]],

  [anyone|plyr,"member_question_2", [], "How do you feel about the way things are going in this company? What say you?", "member_morale",[]],
  [anyone|plyr,"member_question_2", [], "Please, tell me your story once again.", "member_background_recap",[]],
  
  [anyone,"member_morale", [
        (call_script, "script_npc_morale", "$g_talk_troop"),
      ], "{s21}", "do_member_trade",[]],

  [anyone,"member_background_recap", [
          (troop_get_slot, ":first_met", "$g_talk_troop", slot_troop_first_encountered),
          (str_store_party_name, 20, ":first_met"),
          (troop_get_slot, ":home", "$g_talk_troop", slot_troop_home),
          (str_store_party_name, 21, ":home"),
          (troop_get_slot, ":recap", "$g_talk_troop", slot_troop_home_recap),
          (str_store_string, 5, ":recap"),
      ], "{s5}", "member_background_recap_2",[]],

  [anyone,"member_background_recap_2", [
          (str_clear, 19),
          (troop_get_slot, ":background", "$g_talk_troop", slot_troop_backstory_b),
          (str_store_string, 5, ":background"),
      ], "{s5}", "member_background_recap_3",[]],

	  [anyone,"member_background_recap_3", [
      ], "Then a short while afterwards, I joined up with you.", "do_member_trade",[]],

  [anyone,"do_member_view_char", [], "Will there be anything else?", "member_talk",[]],

  

  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (eq, "$talk_context", tc_tavern_talk),
                     (main_party_has_troop, "$g_talk_troop")],
   "We shall set out as soon as you are ready.", "close_window", []],

  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_turned_down_twice, 1),
   ],
   "Let us waste our time here no longer, {sir/my lady}. Perhaps someday we shall meet again.", "close_window", [
       ]],


  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (eq, "$g_talk_troop_met", 0),
                     (troop_get_slot, ":intro", "$g_talk_troop", slot_troop_intro),
                     (str_store_string, 5, ":intro"),
                     (str_store_party_name, 20, "$g_encountered_party"),
   ],
   "{s5}", "companion_recruit_intro_response", [
                    (troop_set_slot, "$g_talk_troop", slot_troop_first_encountered, "$g_encountered_party"),
       ]],


  [anyone|plyr, "companion_recruit_intro_response", [
                     (troop_get_slot, ":intro_response", "$g_talk_troop", slot_troop_intro_response_1),
                     (str_store_string, 6, ":intro_response")
      ], "{s6}", "companion_recruit_backstory_a", []],

  [anyone|plyr, "companion_recruit_intro_response", [
                     (troop_get_slot, ":intro_response", "$g_talk_troop", slot_troop_intro_response_2),
                     (str_store_string, 7, ":intro_response")
      ],  "{s7}", "close_window", [
          ]],

  [anyone, "companion_recruit_backstory_a", [(troop_get_slot, ":backstory_a", "$g_talk_troop", slot_troop_backstory_a),
                     (str_store_string, 5, ":backstory_a"),
                     (str_store_string, 19, "str_here_plus_space"),
                     (str_store_party_name, 20, "$g_encountered_party"),
   ],
   "{s5}", "companion_recruit_backstory_b", []],

  [anyone, "companion_recruit_backstory_b", [(troop_get_slot, ":backstory_b", "$g_talk_troop", slot_troop_backstory_b),
                     (str_store_string, 5, ":backstory_b"),
                     (str_store_party_name, 20, "$g_encountered_party"),
   ],
   "{s5}", "companion_recruit_backstory_c", []],

  [anyone, "companion_recruit_backstory_c", [(troop_get_slot, ":backstory_c", "$g_talk_troop", slot_troop_backstory_c),
                     (str_store_string, 5, ":backstory_c"),
   ],
   "{s5}", "companion_recruit_backstory_response", []],

  [anyone|plyr, "companion_recruit_backstory_response", [
                     (troop_get_slot, ":backstory_response", "$g_talk_troop", slot_troop_backstory_response_1),
                     (str_store_string, 6, ":backstory_response")
      ], "{s6}", "companion_recruit_signup", []],

  [anyone|plyr, "companion_recruit_backstory_response", [
                     (troop_get_slot, ":backstory_response", "$g_talk_troop", slot_troop_backstory_response_2),
                     (str_store_string, 7, ":backstory_response")
      ],  "{s7}", "close_window", [
          ]],

  [anyone, "companion_recruit_signup", [(troop_get_slot, ":signup", "$g_talk_troop", slot_troop_signup),
                     (str_store_string, 5, ":signup"),
                     (str_store_party_name, 20, "$g_encountered_party"),

   ],
   "{s5}", "companion_recruit_signup_b", []],

  [anyone, "companion_recruit_signup_b", [
      (troop_get_slot, ":signup", "$g_talk_troop", slot_troop_signup_2),
      (troop_get_slot, reg3, "$g_talk_troop", slot_troop_payment_request),#

      (str_store_string, 5, ":signup"),
      (str_store_party_name, 20, "$g_encountered_party"),

   ],
   "{s5}", "companion_recruit_signup_response", []],

  [anyone|plyr, "companion_recruit_signup_response", [(neg|hero_can_join, "p_main_party"),], "Unfortunately, I can't take on any more hands in my party right now.", "close_window", [
     ]],

  [anyone|plyr, "companion_recruit_signup_response", [
                    (hero_can_join, "p_main_party"),
                    (troop_get_slot, ":signup_response", "$g_talk_troop", slot_troop_signup_response_1),
                    (str_store_string, 6, ":signup_response")
      ], "{s6}", "companion_recruit_payment", []],

  [anyone|plyr, "companion_recruit_signup_response", [
                    (hero_can_join, "p_main_party"),
                     (troop_get_slot, ":signup_response", "$g_talk_troop", slot_troop_signup_response_2),
                     (str_store_string, 7, ":signup_response")
      ],  "{s7}", "close_window", [
          ]],

  [anyone|auto_proceed, "companion_recruit_payment", [
      (troop_slot_eq, "$g_talk_troop", slot_troop_payment_request, 0),
   ],
   ".", "companion_recruit_signup_confirm", []],
  
  [anyone, "companion_recruit_payment", [
      (store_sub, ":npc_offset", "$g_talk_troop", "trp_npc1"),
      (store_add, ":dialog_line", "str_npc1_payment", ":npc_offset"),
      (troop_get_slot, reg3, "$g_talk_troop", slot_troop_payment_request),
      (str_store_string, s5, ":dialog_line"),
      (str_store_party_name, s20, "$g_encountered_party"),
   ],
   "{s5}", "companion_recruit_payment_response", []],

  [anyone|plyr, "companion_recruit_payment_response", [
                    (hero_can_join, "p_main_party"),
                    (troop_get_slot, ":amount_requested", "$g_talk_troop", slot_troop_payment_request),#
                    (store_troop_gold, ":gold", "trp_player"),#
                    (ge, ":gold", ":amount_requested"),#
                    (assign, reg3, ":amount_requested"),
                    (store_sub, ":npc_offset", "$g_talk_troop", "trp_npc1"),
                    (store_add, ":dialog_line", "str_npc1_payment_response", ":npc_offset"),
                    (str_store_string, s6, ":dialog_line"),
      ], "{s6}", "companion_recruit_signup_confirm", [
                    (troop_get_slot, ":amount_requested", "$g_talk_troop", slot_troop_payment_request),#
                    (gt, ":amount_requested", 0),#
                    (troop_remove_gold, "trp_player", ":amount_requested"),  #                  
                    (troop_set_slot, "$g_talk_troop", slot_troop_payment_request, 0),#
          ]],

  [anyone|plyr, "companion_recruit_payment_response", [
                     (troop_get_slot, ":signup_response", "$g_talk_troop", slot_troop_signup_response_2),
                     (str_store_string, s7, ":signup_response")
      ],  "Alas, I can't afford that at the moment.", "close_window", [
          ]],

  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_met_previously, 1),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, 0),

    ],
   "It is good to see you again.", "companion_recruit_meet_again", [
                     (troop_set_slot, "$g_talk_troop", slot_troop_turned_down_twice, 1),
       ]],

  [anyone|plyr, "companion_recruit_meet_again", [
      ], "So... What have you been doing since our last encounter?", "companion_recruit_backstory_delayed", []],

  [anyone|plyr, "companion_recruit_meet_again", [
      ],  "Good day to you.", "close_window", [
          ]],


  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_met_previously, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, 0),
   ],
   "Yes?", "companion_recruit_secondchance", [
                     (troop_set_slot, "$g_talk_troop", slot_troop_turned_down_twice, 1),
       ]],


  [anyone|plyr, "companion_recruit_secondchance", [
      ], "My apologies if I have been rude. Please, tell me your story once again.", "companion_recruit_backstory_b", []],

  [anyone|plyr, "companion_recruit_secondchance", [
      ],  "I'm afraid there is no time for talk just now.", "close_window", [
          ]],

  [anyone, "companion_recruit_backstory_delayed",
   [(troop_get_slot, ":backstory_delayed", "$g_talk_troop", slot_troop_backstory_delayed),
     (str_store_string, 5, ":backstory_delayed")
   ],
   "{s5}", "companion_recruit_backstory_delayed_response", []],

  [anyone|plyr, "companion_recruit_backstory_delayed_response", [
      ], "You could be of use to me.", "companion_recruit_signup_b", [
          ]],

  [anyone|plyr, "companion_recruit_backstory_delayed_response", [
      ],  "I'll let you know if I hear anything.", "close_window", [
          ]],

  [anyone, "companion_recruit_signup_confirm", [], "Excellent! Give me a few moments to get ready, and I'll be ready to move.", "close_window",
   [(call_script, "script_recruit_troop_as_companion", "$g_talk_troop")]],



### Rehire dialogues
  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, pp_history_indeterminate),
   ],
   "My offer to rejoin you still stands, if you'll have me.", "companion_rehire", []],

### If the companion and the player were separated in battle
  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
    (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, pp_history_scattered),
    (assign, ":battle_fate", "str_battle_fate_1"),
    (store_random_in_range, ":fate_roll", 0, 5),
    (val_add, ":battle_fate", ":fate_roll"),
                     (str_store_string, 6, ":battle_fate"),
    (troop_get_slot, ":honorific", "$g_talk_troop", slot_troop_honorific),
                     (str_store_string, 5, ":honorific"),
  ],
   "It is good to see you alive, {s5}! I had feared the worst -- perhaps that you had been captured, or even killed... But I see you're strong as ever! So what say you -- will you take me back in your company?",
   "companion_rehire", [
    (troop_set_slot, "$g_talk_troop", slot_troop_playerparty_history, pp_history_indeterminate),
  ]],


### If the player and the companion parted on bad terms
  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_turned_down_twice, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, pp_history_quit),
                     (troop_get_slot, ":speech", "$g_talk_troop", slot_troop_rehire_speech),
                     (str_store_string, 5, ":speech"),
   ],
   "{s5}", "companion_rehire", [
                     (troop_set_slot, "$g_talk_troop", slot_troop_playerparty_history, pp_history_indeterminate),
      ]],


###If the player and the companion parted on good terms
  [anyone, "start", [(is_between, "$g_talk_troop", companions_begin, companions_end),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, 0),
                     (troop_slot_eq, "$g_talk_troop", slot_troop_playerparty_history, pp_history_dismissed),
                     (troop_get_slot, ":honorific", "$g_talk_troop", slot_troop_honorific),
                     (str_store_string, 21, ":honorific"),
                     (troop_get_slot, ":speech", "$g_talk_troop", slot_troop_backstory_delayed),
                     (str_store_string, 5, ":speech"),
   ],
   "It is good to see you, {s21}! To tell you the truth, I have long hoped that our paths would cross again.",
   "companion_was_dismissed", [
                     (troop_set_slot, "$g_talk_troop", slot_troop_playerparty_history, pp_history_indeterminate),
      ]],

  [anyone, "companion_was_dismissed", [
                      (troop_get_slot, ":speech", "$g_talk_troop", slot_troop_backstory_delayed),
                     (str_store_string, 5, ":speech"),
   ],
   "{s5}, would you like me to rejoin your company?", "companion_rehire", [
      ]],


  [anyone|plyr, "companion_rehire", [
                    (hero_can_join, "p_main_party")
  ], "Welcome back, my friend!", "companion_recruit_signup_confirm", []],

  [anyone|plyr, "companion_rehire", [
      ],  "Sorry, I can't take on anyone else right now.", "companion_rehire_refused", [
          ]],

  [anyone, "companion_rehire_refused", [], "Well... Come find me if you change your mind, all right?", "close_window",
   []],
   
  [anyone, "event_triggered",
   [
     (this_or_next|faction_slot_eq, "fac_player_supporters_faction", slot_faction_leader, "$g_talk_troop"),
	 (this_or_next|eq, "$g_talk_troop", "trp_swadian_messenger"),
     (             faction_slot_eq, "$players_kingdom", slot_faction_messenger_troop, "$g_talk_troop"),
     (ge, "$g_center_taken_by_player_faction", 0),
    (str_store_party_name, s1, "$g_center_taken_by_player_faction"),
     ],
   "{s1} is not under anyone's control. I wonder who might become its next ruler...", "center_captured_lord_advice",
   []],   

   [anyone|plyr|repeat_for_troops, "center_captured_lord_advice",
   [
     (store_repeat_object, ":troop_no"),
     (troop_slot_eq, ":troop_no", slot_troop_occupation, slto_kingdom_hero),
     (neq, "$g_talk_troop", ":troop_no"),
     (neq, "trp_player", ":troop_no"),
     (store_troop_faction, ":faction_no", ":troop_no"),
	 (store_faction_of_party, ":center_faction", "$g_center_taken_by_player_faction"),
     (eq, ":faction_no", ":center_faction"),
     (str_store_troop_name, s11, ":troop_no"),
     (call_script, "script_print_troop_owned_centers_in_numbers_to_s0", ":troop_no"),
     (try_begin),
       (eq, reg0, 0),
       (str_store_string, s1, "@(no fiefs)"),
     (else_try),
       (str_store_string, s1, "@(fiefs: {s0})"),
     (try_end),
     ],
   "{s11}. {s1}", "center_captured_lord_advice_2",
   [
     (store_repeat_object, "$temp"),
     ]],

  [anyone|plyr, "center_captured_lord_advice",
   [
     (call_script, "script_print_troop_owned_centers_in_numbers_to_s0", "trp_player"),
     (str_store_party_name, s1, "$g_center_taken_by_player_faction"),
	 ],
   "Oh, it would be a great boon if I were to become the master of {s1}. (fiefs: {s0})", "center_captured_lord_advice_2",
   [
     (assign, "$temp", "trp_player"),
     ]],

  [anyone|plyr, "center_captured_lord_advice",
   [
   
     (faction_get_slot, ":lord", "fac_player_supporters_faction", slot_faction_leader),
	 (store_faction_of_party, ":center_faction", "$g_center_taken_by_player_faction"),
	 (faction_get_slot, ":lord2", ":center_faction", slot_faction_leader),
	 (neq, ":lord2", "trp_player"),
	 (call_script, "script_print_troop_owned_centers_in_numbers_to_s0", ":lord"),
     (str_store_party_name, s1, "$g_center_taken_by_player_faction"),
     ],
   "I believe {s1} must belong to the rightful heir to the throne. (fiefs: {s0})", "center_captured_lord_advice_2",
   [
     (faction_get_slot, ":lord", "fac_player_supporters_faction", slot_faction_leader),
	 (assign, "$temp", ":lord"),
     ]],

  [anyone, "center_captured_lord_advice_2",
   [
#     (faction_slot_eq, "fac_player_supporters_faction", slot_faction_leader, "$g_talk_troop"),
#     (ge, "$g_center_taken_by_player_faction", 0),
     ],
   "Hmmm. I value your counsel highly, {playername}. {reg6?Only the rightful heir is worthy of taking {s1}.:{reg7?Most likely you shall receive {s1}:Most likely, {s11} shall receive {s1}}.}", "close_window",
   [
     (assign, ":new_owner", "$temp"),
     (call_script, "script_calculate_troop_score_for_center", ":new_owner", "$g_center_taken_by_player_faction"),
     (assign, ":new_owner_score", reg0),
     (assign, ":total_negative_effect"),
     (try_for_range, ":cur_troop", kingdom_heroes_begin, kingdom_heroes_end),
       (store_troop_faction, ":cur_faction", ":cur_troop"),
	   (store_faction_of_party, ":center_faction", "$g_center_taken_by_player_faction"),
       (eq, ":cur_faction", ":center_faction"),
       (neq, ":cur_troop", ":new_owner"),
       (call_script, "script_calculate_troop_score_for_center", ":cur_troop", "$g_center_taken_by_player_faction"),
       (assign, ":cur_troop_score", reg0),
       (gt, ":cur_troop_score", ":new_owner_score"),
       (store_sub, ":difference", ":cur_troop_score", ":new_owner_score"),
       (store_random_in_range, ":random_dif", 0, ":difference"),
       (val_div, ":random_dif", 1000),
       (gt, ":random_dif", 0),
       (val_add, ":total_negative_effect", ":random_dif"),
       (val_mul, ":random_dif", -1),
       (call_script, "script_change_player_relation_with_troop", ":cur_troop", ":random_dif"),
	 (try_end),	 
     (val_mul, ":total_negative_effect", 2),
     (val_div, ":total_negative_effect", 3),
     (val_add, ":total_negative_effect", 5),
     (try_begin),
       (neq, ":new_owner", "trp_player"),
       (val_min, ":total_negative_effect", 30),
       (call_script, "script_change_player_relation_with_troop", ":new_owner", ":total_negative_effect"),
     (try_end),
     (call_script, "script_give_center_to_lord", "$g_center_taken_by_player_faction", ":new_owner", 0),
	 (try_begin),
       (neq, ":new_owner", "trp_player"),
       (call_script, "script_cf_reinforce_party", "$g_center_taken_by_player_faction"),
       (call_script, "script_cf_reinforce_party", "$g_center_taken_by_player_faction"),
     (try_end),

     (assign, reg6, 0),
     (assign, reg7, 0),
     (try_begin),
       (eq, "$temp", "$g_talk_troop"),
       (assign, reg6, 1),
     (else_try),
       (eq, "$temp", "trp_player"),
       (assign, reg7, 1),
     (else_try),
       (str_store_troop_name, s11, "$temp"),
     (try_end),
     (str_store_party_name, s1, "$g_center_taken_by_player_faction"),
     (troop_get_type, reg3, "$temp"),
     (assign, "$g_center_taken_by_player_faction", -1),
     ]],



  [anyone, "event_triggered", [
                     (store_conversation_troop, "$map_talk_troop"),
                     (eq, "$map_talk_troop", "$npc_is_quitting"), 
                     (troop_get_slot, ":honorific", "$map_talk_troop", slot_troop_honorific), 
                     (str_store_string, 5, ":honorific")],
   "{s5}, there is something I must tell you.", "companion_quitting", [
                    (assign, "$npc_is_quitting", 0),
                    (assign, "$player_can_persuade_npc", 1),
                    (assign, "$player_can_refuse_npc_quitting", 1),
       ]],

### This is also where the dialogue jumps if the player initiates quitting dialogue and the companion has low morale
  [anyone, "companion_quitting", [
                     (store_conversation_troop, "$map_talk_troop"),
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_retirement_speech), 
                     (str_store_string, 5, ":speech")
                     ],
   "{s5}", "companion_quitting_2", [
       ]],

## The companion explains his/her reasons for quitting
  [anyone, "companion_quitting_2", [
                    (call_script, "script_npc_morale", "$map_talk_troop"),
                     ],
   "To tell you the truth, {s21}.", "companion_quitting_response", [
       ]],

  [anyone|plyr, "companion_quitting_response", [
      ], "Very well. Be off then.", "companion_quitting_yes", [
          ]],

  [anyone|plyr, "companion_quitting_response", [
                (eq, "$player_can_persuade_npc", 1),
      ], "Perhaps I can persuade you to change your mind.", "companion_quitting_persuasion", [
            (assign, "$player_can_persuade_npc", 0),
          ]],

  [anyone, "companion_quitting_persuasion", [
                (store_random_in_range, ":random", -2, 13),
                (store_skill_level, ":persuasion", "skl_persuasion", "trp_player"),
                (le, ":random", ":persuasion"),
                     ],
   "Hm. When you put it like that, I suppose I might stay a while longer, provided matters improve.", "close_window",
   [
                (troop_get_slot, ":morality_penalties", "$map_talk_troop", slot_troop_morality_penalties),
                (val_div, ":morality_penalties", 2),
                (troop_set_slot, "$map_talk_troop", slot_troop_morality_penalties, ":morality_penalties"),

                (troop_get_slot, ":personalityclash_penalties", "$map_talk_troop", slot_troop_personalityclash_penalties),
                (val_div, ":personalityclash_penalties", 2),
                (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_penalties, ":personalityclash_penalties"),
       ]],

  [anyone, "companion_quitting_persuasion", [
                     ],
   "I'm sorry, but I do not see your point. I shall take my leave of you now.", "companion_quitting_response",
   [
       ]],

  [anyone|plyr, "companion_quitting_response", [
            (eq, 1, 0),
            (eq, "$player_can_refuse_npc_quitting", 1),
      ], "We hang deserters in this company.", "companion_quitting_no", [
          ]],

  [anyone, "companion_quitting_no", [],
   "Oh... I see. I see you do not mean that in jest...", "companion_quitting_no_confirm", [
       ]],

  [anyone|plyr, "companion_quitting_no_confirm", [],
   "Absolutely. You may either leave this company by my order, or you are carried away on your shield.", "companion_quitting_no_confirmed", [
       ]],

  [anyone|plyr, "companion_quitting_no_confirm", [],
   "No, fear not -- I mean you no harm. You are free to leave.", "companion_quitting_yes", [
       ]],

  [anyone, "companion_quitting_yes", [
                     ],
   "Then this is farewell. Perhaps we shall meet again, {playername}.", "close_window", [
          (troop_set_slot, "$map_talk_troop", slot_troop_playerparty_history, pp_history_quit), 
          (call_script, "script_retire_companion", "$map_talk_troop", 100),
       ]],

  [anyone, "companion_quitting_no_confirmed", [
      ],
   "Hmm. I suppose I'll stay, then.", "close_window", [
       ]],


#Morality objections
  [anyone, "event_triggered", [
                     (store_conversation_troop, "$map_talk_troop"),
                     (eq, "$map_talk_troop", "$npc_with_grievance"), 
                     (eq, "$npc_map_talk_context", slot_troop_morality_state), 

                     (try_begin),
                         (eq, "$npc_grievance_slot", slot_troop_morality_state),
                         (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_morality_speech),
                     (else_try),
                         (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_2ary_morality_speech),
                     (try_end),
                     (str_store_string, 21, "$npc_grievance_string"),
                     (str_store_string, 5, ":speech"),
                     ],
   "{s5}", "companion_objection_response", [
                    (assign, "$npc_with_grievance", 0),
       ]],



  [anyone|plyr, "companion_objection_response", [
                    (eq, "$npc_praise_not_complaint", 1),
      ], "Thank you. I appreciate your support.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", "$npc_grievance_slot", tms_acknowledged),
          ]],

  [anyone|plyr, "companion_objection_response", [
                    (eq, "$npc_praise_not_complaint", 0),
      ], "Hopefully it won't happen again.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", "$npc_grievance_slot", tms_acknowledged),
          ]],

  [anyone|plyr, "companion_objection_response", [
                    (eq, "$npc_praise_not_complaint", 0),
      ],  "Your objection is noted. Now fall back in line.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", "$npc_grievance_slot", tms_dismissed),
                    (troop_get_slot, ":grievance", "$map_talk_troop", slot_troop_morality_penalties),
                    (val_add, ":grievance", 10),
                    (troop_set_slot, "$map_talk_troop", slot_troop_morality_penalties, ":grievance"),
          ]],


##  [anyone|plyr, "companion_objection_response", [
##      ],  "I prefer my followers to keep their opinions to themselves.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", "$npc_grievance_slot", tms_dismissed),
##                    (troop_get_slot, ":grievance", "$map_talk_troop", slot_troop_morality_penalties),
##                    (val_add, ":grievance", 10),
##                    (troop_set_slot, "$map_talk_troop", slot_troop_morality_penalties, ":grievance"),
##                    (assign, "$disable_npc_complaints", 1),
##          ]],



# Personality clash 2 objections
  [anyone, "event_triggered", [
                     (store_conversation_troop, "$map_talk_troop"),
                     (eq, "$map_talk_troop", "$npc_with_personality_clash_2"), 
                     (eq, "$npc_map_talk_context", slot_troop_personalityclash2_state), 

                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalityclash2_speech),
                     (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash2_object),
                     (str_store_troop_name, 11, ":object"),
                     (str_store_string, 5, ":speech"),
                     ],
   "{s5}", "companion_personalityclash2_b", [
                    (assign, "$npc_with_personality_clash_2", 0),
                    (troop_get_slot, ":grievance", "$map_talk_troop", slot_troop_personalityclash_penalties),
                    (val_add, ":grievance", 5),
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_penalties, ":grievance"),
       ]],

  [anyone, "companion_personalityclash2_b", [
      ],  "{s5}", "companion_personalityclash2_response", [
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalityclash2_speech_b),
                     (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash2_object),
                     (str_store_troop_name, 11, ":object"),
                     (str_store_string, 5, ":speech"),
          ]],



  [anyone|plyr, "companion_personalityclash2_response", [
      (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash2_object),
      (str_store_troop_name, s11, ":object"),
      (troop_get_type, reg11, ":object"),
      ],  "{s11} is a valuable member of this company. I do not want you picking any more fights with {reg11?her:him}.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash2_state, pclash_penalty_to_self),
          ]],

  [anyone|plyr, "companion_personalityclash2_response", [
      (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash2_object),
      (str_store_troop_name, s11, ":object"),
      (troop_get_type, reg11, ":object"),
      ],  "Tell {s11} you have my support in this.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash2_state, pclash_penalty_to_other),
          ]],
  
  [anyone|plyr, "companion_personalityclash2_response", [
      ],  "I don't have time for your petty dispute. Do not bother me with this again.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash2_state, pclash_penalty_to_both),
          ]],

  
##  [anyone|plyr, "companion_personalityclash2_response", [
##      ],  "Your grievance is noted. Now fall back in line.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash2_state, 1),
##          ]],

##  [anyone|plyr, "companion_personalityclash2_response", [
##      ],  "I prefer my followers to keep their opinions to themselves.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash2_state, 1),
##                    (assign, "$disable_npc_complaints", 1),
##          ]],




# Personality clash objections

  [anyone, "event_triggered", [
                     (store_conversation_troop, "$map_talk_troop"),
                     (eq, "$map_talk_troop", "$npc_with_personality_clash"),
                     (eq, "$npc_map_talk_context", slot_troop_personalityclash_state), 

                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalityclash_speech),
                     (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash_object),
                     (str_store_troop_name, 11, ":object"),
                     (str_store_string, 5, ":speech"),
                     ],
   "{s5}", "companion_personalityclash_b", [
                    (assign, "$npc_with_personality_clash", 0),
                    (troop_get_slot, ":grievance", "$map_talk_troop", slot_troop_personalityclash_penalties),
                    (val_add, ":grievance", 5),
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_penalties, ":grievance"),
       ]],

  [anyone, "companion_personalityclash_b", [
      ],  "{s5}", "companion_personalityclash_response", [
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalityclash_speech_b),
                     (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash_object),
                     (str_store_troop_name, 11, ":object"),
                     (str_store_string, 5, ":speech"),
          ]],

  [anyone|plyr, "companion_personalityclash_response", [
      (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash_object),
      (str_store_troop_name, s11, ":object"),
      (troop_get_type, reg11, ":object"),
      ],  "{s11} is a capable member of this company. I don't want you picking any more fights with {reg11?her:him}.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_state, pclash_penalty_to_self),
          ]],

  [anyone|plyr, "companion_personalityclash_response", [
      (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalityclash_object),
      (str_store_troop_name, s11, ":object"),
      (troop_get_type, reg11, ":object"),
      ],  "Tell {s11} you have my support in this, and {reg11?she:he}'d better tame {reg11?her:his} tongue.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_state, pclash_penalty_to_other),
          ]],
  
  [anyone|plyr, "companion_personalityclash_response", [
      ],  "I don't have time for your petty dispute. Do not bother me with this again.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_state, pclash_penalty_to_both),
          ]],


##  [anyone|plyr, "companion_personalityclash_response", [
##      ],  "Your grievance is noted. Now fall back in line.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_state, 1),
##          ]],

##  [anyone|plyr, "companion_personalityclash_response", [
##      ],  "I prefer my followers to keep their opinions to themselves.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", slot_troop_personalityclash_state, 1),
##                    (assign, "$disable_npc_complaints", 1),
##          ]],



# Personality match

  [anyone, "event_triggered", [
                     (eq, "$npc_map_talk_context", slot_troop_personalitymatch_state), 
                     (store_conversation_troop, "$map_talk_troop"),
                     (eq, "$map_talk_troop", "$npc_with_personality_match"),

                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalitymatch_speech),
                     (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalitymatch_object),
                     (str_store_troop_name, 11, ":object"),
                     (str_store_string, 5, ":speech"),
                     ],
   "{s5}", "companion_personalitymatch_b", [
                    (assign, "$npc_with_personality_match", 0),
       ]],

  [anyone, "companion_personalitymatch_b", [
                    (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_personalitymatch_speech_b),
                    (troop_get_slot, ":object", "$map_talk_troop", slot_troop_personalitymatch_object),
                    (str_store_troop_name, 11, ":object"),
                    (str_store_string, 5, ":speech"),
                     ],
   "{s5}", "companion_personalitymatch_response", [
       ]],


  [anyone|plyr, "companion_personalitymatch_response", [
      ],  "Very good.", "close_window", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_personalitymatch_state, 1),
					]],

##  [anyone|plyr, "companion_personalitymatch_response", [
##      ],  "I prefer my followers to keep their opinions to themselves.", "close_window", [
##                    (troop_set_slot, "$map_talk_troop", slot_troop_personalitymatch_state, 1),
##                    (assign, "$disable_npc_complaints", 1),
##          ]],

	   

  [anyone, "event_triggered", [
                     (eq, "$npc_map_talk_context", slot_troop_home), 
                     (store_conversation_troop, "$map_talk_troop"),
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_home_intro),
                     (str_store_string, s5, ":speech"),
                     ],
   "{s5}", "companion_home_description", [
                    (troop_set_slot, "$map_talk_troop", slot_troop_home_speech_delivered, 1),
       ]],

  [anyone|plyr, "companion_home_description", [
      ],  "Tell me more.", "companion_home_description_2", [
          ]],

  [anyone|plyr, "companion_home_description", [
      ],  "We don't have time to chat just now.", "close_window", [
          ]],

  [anyone|plyr, "companion_home_description", [
      ],  "I prefer my companions not to bother me with such petty matters.", "close_window", [
                    (assign, "$disable_local_histories", 1),
          ]],


  [anyone, "companion_home_description_2", [
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_home_description),
                     (str_store_string, 5, ":speech"),
      ],  "{s5}", "companion_home_description_3", [
          ]],

  [anyone, "companion_home_description_3", [
                     (troop_get_slot, ":speech", "$map_talk_troop", slot_troop_home_description_2),
                     (str_store_string, 5, ":speech"),
      ],  "{s5}", "close_window", [
          ]],

	
  [anyone,"event_triggered", [
    (eq, "$talk_context", tc_rebel_thanks),
    (troop_get_slot, ":old_faction", "$g_talk_troop", slot_troop_original_faction),
    (str_store_faction_name, s3, ":old_faction"),
    (str_store_string, s6, "@{playername}, when we started our long walk, few people had the courage to support me.\
 And fewer still would be willing to put their lives at risk for my cause.\
 But you didn't hesitate for a moment in throwing yourself at my enemies.\
 We have gone through a lot together, and there were times I came close to losing all hope.\
 But with God's help, we prevailed. It is now time for me to leave your company and take what's rightfully mine.\
 From now on, I will carry out the great responsibility of ruling {s3}.\
 There still lie many challanges ahead and I count on your help in overcoming those.\
 And of course, you will always remain as my foremost vassal."),
    ],
   "{s6}", "rebel_thanks_answer",
   [
     (call_script, "script_end_quest", "qst_rebel_against_kingdom"),
	 #oim code
	 (try_begin), 
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
		(check_quest_active,"qst_oim_getman_radzivill_rebelion"),
		(neg|check_quest_finished,"qst_oim_getman_radzivill_rebelion"),
		#code to end quest
		#fix this!
		#(call_script, "script_succeed_quest", "qst_oim_getman_za_radzivilla"), 
		(call_script, "script_end_quest", "qst_oim_getman_za_radzivilla"), 
		#(call_script, "script_succeed_quest", "qst_oim_getman_radzivill_rebelion"), 		
		(call_script, "script_end_quest", "qst_oim_getman_radzivill_rebelion"), 
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 10),	 
	 (try_end),	
 	 (try_begin), 
		(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
		(check_quest_active,"qst_oim_potop_shtirlic"),
		(neg|check_quest_finished,"qst_oim_potop_shtirlic"),
		(quest_set_slot, "qst_oim_potop_shtirlic", slot_quest_current_state, 3),	 
	 (try_end),	
	 #oim barabash rebelion succeeded
 	 (try_begin), 
		(eq, "$g_talk_troop", "trp_kingdom_5_pretender"), 
		(check_quest_active,"qst_oim_getman_za_barabasha"),
		(neg|check_quest_finished,"qst_oim_getman_za_barabasha"),
		(call_script, "script_succeed_quest", "qst_oim_getman_za_barabasha"),
	 (try_end),
       ]],

  [anyone|plyr,"rebel_thanks_answer", [], "It was an honor to fight for your cause, {reg65?my lady:sir}.", "rebel_thanks_answer_2", []],
  [anyone|plyr,"rebel_thanks_answer", [], "You will always have my loyal support, {reg65?my lady:sir}.", "rebel_thanks_answer_2", []],

  [anyone,"rebel_thanks_answer_2", [], "I shall miss this life of adventure with you, but my duties call. So... farewell for now, {playername}. I do hope we meet again soon.", "close_window", []],


 
  [anyone, "event_triggered", [
                     ],
   "Sorry - just talking to myself [ERROR]", "close_window", [
       ]],



		  


					


# Town Lords:

#oim code
  [anyone,"start", 
  [
  (try_begin),
  (store_troop_gold,"$player_gold_a","trp_player"),
  (try_end),
  (party_slot_eq, "$current_town", slot_party_type, spt_town),
  (eq, "$talk_context", tc_castle_commander)],
   "What do you want?", "player_siege_castle_commander_1a", []],
  [anyone|plyr,"player_siege_castle_commander_1a", [],
   "Open the gates.", "player_siege_ask_surrender_a", []],
  [anyone|plyr,"player_siege_castle_commander_1a", [], "Nothing, I changed my mind.", "close_window", []],

  
  [anyone,"player_siege_ask_surrender_a", [
        ##(try_begin),
		##	(call_script, "script_get_max_skill_of_player_party", "skl_persuasion"),
		##	(assign, ":koef", reg0),
		##	(call_script, "script_get_max_skill_of_player_party", "skl_looting"),
		##	(val_add, ":koef", reg0),
		##(try_end),
		##
		##(ge, ":koef", 1),
		(this_or_next|neg|troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
		(eq, debug_mode, 1),
		(ge, "$player_gold_a", 20000),],
   "Certainly, I shall open the gates, just give me 20,000 thaler...", "player_siege_ask_surrender_next", [(assign, "$g_podkup", 1),]],
  
  [anyone,"player_siege_ask_surrender_a", [
    (this_or_next|neg|troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
	(eq, debug_mode, 1),
	(lt,"$player_gold_a", 20000),],
   "You jest?! Your impudence may be your undoing!", "close_window", [(assign, "$g_podkup", 1),]],
 
  [anyone,"player_siege_ask_surrender_a", [],
   "Perhaps I should just give you the crown and call you king?", "close_window", [(assign, "$g_podkup", 1),]],
  

  
  [anyone|plyr,"player_siege_ask_surrender_next", [],
   "Very well, it's a deal...", "close_window", [
	(assign, "$g_podkup", 1),
	(troop_remove_gold, "trp_player", 20000),
	(jump_to_menu,"mnu_podkup_ataka"),  
   ]],
  
  [anyone|plyr,"player_siege_ask_surrender_next", [],
   "Very well... My men shall find another way to take this city...", "close_window", []],


   
   
   
  #Kingdom Lords:
  [anyone,"start", [(eq, "$talk_context", tc_castle_commander)],
   "What do you want?", "player_siege_castle_commander_1", []],
  [anyone|plyr,"player_siege_castle_commander_1", [],
   "Surrender! Your situation is hopeless!", "player_siege_ask_surrender", []],
  [anyone|plyr,"player_siege_castle_commander_1", [], "Nothing. I'll leave you now.", "close_window", []],

  
  [anyone,"player_siege_ask_surrender", [(lt, "$g_enemy_strength", 100), (store_mul,":required_str","$g_enemy_strength",5),(ge, "$g_ally_strength", ":required_str")],
   "Perhaps... Do I have your word of honor that we shall be fairly treated?", "player_siege_ask_surrender_treatment", []],
  [anyone,"player_siege_ask_surrender", [(lt, "$g_enemy_strength", 200), (store_mul,":required_str","$g_enemy_strength",3),(ge, "$g_ally_strength", ":required_str")],
   "We are prepared to surrender this fortress to you, and march towards friendlier lands, if you give us your word of honor that we shall be allowed to leave in peace.", "player_siege_ask_leave_unmolested", []],
  [anyone,"player_siege_ask_surrender", [],
   "Surrender? Hah! We shall hold these walls until we all die of old age!", "close_window", []],

  
  [anyone|plyr,"player_siege_ask_surrender_treatment", [],
   "I shall give you nothing. Surrender now or prepare to die!", "player_siege_ask_surrender_treatment_reject", []],
  [anyone,"player_siege_ask_surrender_treatment_reject", [],
   "The devil take you! We shall fight you to the last drop of blood!", "close_window", []],
  [anyone|plyr,"player_siege_ask_surrender_treatment", [],
   "You will be ransomed, and your soldiers will be allowed to disperse. I give you my word.", "player_siege_ask_surrender_treatment_accept", []],
  [anyone,"player_siege_ask_surrender_treatment_accept", [],
   "Very well then. Under those terms, I offer you my surrender.", "close_window", [(assign,"$g_enemy_surrenders",1)]],

  [anyone|plyr,"player_siege_ask_leave_unmolested", [],
   "You have my word. You may go in peace if you leave the fortress.", "player_siege_ask_leave_unmolested_accept", []],
  [anyone,"player_siege_ask_leave_unmolested_accept", [],
   "Very well. We shall leave this fortress to you. You have won this day, but we may yet meet again!", "close_window", [(assign,"$g_castle_left_to_player",1)]],
  [anyone|plyr,"player_siege_ask_leave_unmolested", [],
   "That is unacceptable. I shall take prisoners.", "player_siege_ask_leave_unmolested_reject", []],
  [anyone,"player_siege_ask_leave_unmolested_reject", [],
   "Then we shall defend this stronghold to the last man, and this parley is finished.", "close_window", []],


#After battle texts
  
  [anyone,"start", [(eq, "$talk_context", tc_hero_freed),
    (troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero)],
   "I am in your debt for freeing me, my friend. You have my eternal gratitude!", "freed_lord_answer",
   [
     (call_script, "script_remove_troop_from_prison", "$g_talk_troop"),
   ]],

  [anyone|plyr,"freed_lord_answer", [(lt, "$g_talk_troop_faction_relation", 0)],
   "You're not going anywhere, 'friend'. You're my prisoner now.", "freed_lord_answer_1",
   [#(troop_set_slot, "$g_talk_troop", slot_troop_is_prisoner, 1),
    (troop_set_slot, "$g_talk_troop", slot_troop_prisoner_of_party, "p_main_party"),
    (party_force_add_prisoners, "p_main_party", "$g_talk_troop", 1),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -30),
    (call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", -2),
    (call_script, "script_event_hero_taken_prisoner_by_player", "$g_talk_troop"),
    ]],#take prisoner

  [anyone,"freed_lord_answer_1", [],
   "You bastard! Mark my words, someday you shall pay for this dearly!", "close_window", []],

  [anyone|plyr,"freed_lord_answer", [],
   "You are free to go, sir.", "freed_lord_answer_2",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 7),
    (call_script, "script_change_player_honor", 2),
#    (troop_get_slot, ":cur_rank", "$g_talk_troop", slot_troop_kingdom_rank),
#    (val_mul, ":cur_rank", 1),
    (call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", 2)]],

  [anyone,"freed_lord_answer_2", [],
   "Thank you, good {sire/lady}. I never forget a good turn.", "close_window",
   []],

##  [anyone|plyr,"freed_lord_answer", [(neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"), #he is not a faction leader!
##                                     (call_script, "script_get_number_of_hero_centers", "$g_talk_troop"),
##                                     (eq, reg0, 0), #he has no castles or towns
##                                     (hero_can_join)],
##   "I need capable men like you. Would you like to join me?", "knight_offer_join",
##   []],
##
##  [anyone,"freed_lord_answer_3", [(store_random_in_range, ":random_no",0,2),(eq, ":random_no", 0)],
##   "Alright I will join you.", "close_window",
##   [
###     (troop_set_slot, "$g_talk_troop", slot_troop_is_player_companion, 1),
##     (troop_set_slot, "$g_talk_troop", slot_troop_occupation, slto_player_companion),
##     (store_conversation_troop, ":cur_troop_id"), 
##     (party_add_members, "p_main_party", ":cur_troop_id", 1),#join hero
##   ]],
##
##  [anyone,"freed_lord_answer_3", [],
##   "No, I want to go on my own.", "close_window", []],


#Troop commentary changes begin
  [anyone,"start", [(eq,"$talk_context",tc_hero_defeated),
                    (troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero)],
   "{s43}", "defeat_lord_answer",
   [(troop_set_slot, "$g_talk_troop", slot_troop_leaded_party, -1),
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_surrender_offer_default"),
    ]],

  [anyone|plyr,"defeat_lord_answer", [],
   "You are my prisoner now.", "defeat_lord_answer_1",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_prisoner_of_party, "p_main_party"),
     (party_force_add_prisoners, "p_main_party", "$g_talk_troop", 1),#take prisoner
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -3),
     (call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", -3),
     (call_script, "script_event_hero_taken_prisoner_by_player", "$g_talk_troop"),
     (call_script, "script_add_log_entry", logent_lord_captured_by_player, "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
     ]],

	[anyone|auto_proceed, "defeat_lord_answer_1", [
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
		(eq, "$g_razin_rebellion", 2), 
	], "{!}NOT SHOWN", "oim_dmitriy_razin_captured",[]],	
	 
	 
	#oim code
    [anyone|auto_proceed,"defeat_lord_answer_1", [
		(check_quest_active,"qst_oim_potop_volodievskiy"),
		(this_or_next|quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 1), 
		( 			  quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 2), 
		(neg|check_quest_finished,"qst_oim_potop_volodievskiy"),
		(eq, "$g_talk_troop_faction", "fac_kingdom_4"), 
	],
      "I beg your mercy.", "oim_potop_volodievsky_shved_dlg", []],

    [anyone|auto_proceed,"defeat_lord_answer_1", [
		(check_quest_active, "qst_oim_potop_capture_tszar"),
		(neg|check_quest_succeeded, "qst_oim_potop_capture_tszar"), 
		(neg|check_quest_finished,"qst_oim_potop_capture_tszar"),
		(eq, "$g_talk_troop", "trp_kingdom_2_lord"), 
	],
      "Hear me, officer...", "oim_potop_capture_tzar_dlg_captured", []],

    [anyone|auto_proceed,"defeat_lord_answer_1", [
		(check_quest_active, "qst_oim_getman_capture_tatarin"),
		(neg|check_quest_succeeded, "qst_oim_getman_capture_tatarin"), 
		(neg|check_quest_finished,"qst_oim_getman_capture_tatarin"),
		(is_between, "$g_talk_troop", "trp_knight_3_1", "trp_knight_4_1"), 
		(quest_slot_eq, "qst_oim_getman_capture_tatarin", slot_quest_current_state, 0), 
	],
      "I am at your mercy.", "close_window", [
		(quest_set_slot, "qst_oim_getman_capture_tatarin", slot_quest_current_state, 1), 
		(quest_set_slot, "qst_oim_getman_capture_tatarin", slot_quest_target_troop, "$g_talk_troop"), 
	]],

    [anyone|auto_proceed,"defeat_lord_answer_1", [
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"),
		(check_quest_active,"qst_oim_getman_nesvizh_pernach"),
		#(quest_slot_eq, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 2), 
		(neg|check_quest_succeeded,"qst_oim_getman_nesvizh_pernach"),
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
	],
      "I beg your mercy.", "oim_getman_radzivill_captured", [
	]],
	
    [anyone|auto_proceed,"defeat_lord_answer_1", [
		(eq, "$g_talk_troop", "trp_knight_2_14"),
		(check_quest_active,"qst_oim_getman_borat_dlg"),
		(neg|check_quest_succeeded,"qst_oim_getman_borat_dlg"),
		(neg|check_quest_finished,"qst_oim_getman_borat_dlg"),
	],
      "I beg your mercy.", "oim_getman_knyaz_boryat_dlg_generik_end", [
	]],	
	
	 
  [anyone,"defeat_lord_answer_1", [],
   "I am at your mercy.", "close_window", []],

  [anyone|plyr,"defeat_lord_answer", [],
   "You have fought well. You are free to go.", "defeat_lord_answer_2",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 5),
    (call_script, "script_change_player_honor", 3),
    (call_script, "script_add_log_entry", logent_lord_defeated_but_let_go_by_player, "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction")]],

  [anyone,"defeat_lord_answer_2", [],
   "{s43}", "close_window", [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_prisoner_released_default"),
       ]],
#Troop commentary changes end

#Troop commentaries changes begin
  [anyone,"start", [(eq,"$talk_context",tc_party_encounter),
                    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
                    (lt,"$g_encountered_party_relation",0),
                    (encountered_party_is_attacker),
                    (eq, "$g_talk_troop_met", 1),                    ],
   "{playername}!", "party_encounter_lord_hostile_attacker", [
                    ]],

  [anyone,"start", [(eq,"$talk_context",tc_party_encounter),
                    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
                    (lt,"$g_encountered_party_relation",0),
                    (encountered_party_is_attacker),                ],
   "Halt!", "party_encounter_lord_hostile_attacker", [
                    ]],

  [anyone,"party_encounter_lord_hostile_attacker", [
      (gt, "$g_comment_found", 0),
                    ],
   "{s42}", "party_encounter_lord_hostile_attacker", [
                         (try_begin),
                           (neq, "$log_comment_relation_change", 0),
                           (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", "$log_comment_relation_change"),
                         (try_end),
                         (assign, "$g_comment_found", 0),
                    ]],

#Troop commentaries changes end
  [anyone,"party_encounter_lord_hostile_attacker", [
                    ],
   "{s43}", "party_encounter_lord_hostile_attacker_2",
   [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_surrender_demand_default"),
       ]],

  [anyone|plyr,"party_encounter_lord_hostile_attacker_2", [
                    ],
   "Is there no way to avoid this battle? I don't want to fight with you.", "party_encounter_offer_dont_fight", []],

  [anyone|plyr,"party_encounter_lord_hostile_attacker_2", [
                    ],
   "Don't attack! We surrender.", "close_window", [(assign,"$g_player_surrenders",1)]],

  [anyone|plyr,"party_encounter_lord_hostile_attacker_2", [
                    ],
   "We will fight you to the end!", "close_window", []],
  
  [anyone, "party_encounter_offer_dont_fight", [(gt, "$g_talk_troop_relation", 30),
#TODO: Add adition conditions, lord personalities, battle advantage, etc...                                                
                    ],
   "Hmm, I owe you a favor now, don't I... Very well, I will let you pass unharmed -- just this once.", "close_window", [
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop", -7),
    (store_current_hours,":protected_until"),
    (val_add, ":protected_until", 72),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,":protected_until"),
    (party_ignore_player, "$g_encountered_party", 72),
	(party_set_ignore_with_player_party, "p_main_party", 72),

	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),

	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),

	  (le, ":dist", 25),
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	(try_end),

    (assign, "$g_leave_encounter",1)
       ]],
  
  [anyone, "party_encounter_offer_dont_fight", [
                    ],
   "Ha-ha. But I wish to fight with you.", "close_window", []],
  
##  [anyone,"start", [(eq,"$talk_context",tc_party_encounter),
##                    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
##                    (lt,"$g_encountered_party_relation",0),
##                    (neg|encountered_party_is_attacker),
##                    ],
##   "What do you want?", "party_encounter_lord_hostile_defender",
##   []],


#  [anyone|plyr,"party_encounter_lord_hostile_defender", [],
#   "Nothing. We'll leave you in peace.", "close_window", [(assign, "$g_leave_encounter",1)]],



 
#Betrayal texts should go here


##  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
##                     (troop_slot_eq,"$g_talk_troop",slot_troop_last_quest_betrayed, 1),
##                     (troop_slot_eq,"$g_talk_troop",slot_troop_last_quest, "qst_deliver_message_to_lover"),
##                     (le,"$talk_context",tc_siege_commander),
##                     ],
##   "I had trusted that letter to you, thinking you were a {man/lady} of honor, and you handed it directly to the girl's father.\
## I should have known you were not to be trusted. Anyway, I have learned my lesson and I won't make that mistake again.", "close_window",
##   [(call_script, "script_clear_last_quest", "$g_talk_troop")]],



	
	

#Rebellion changes begin
	
	
  [anyone ,"start",
   [
     (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
     (faction_slot_eq, "$g_talk_troop_faction", slot_faction_state, 2),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
     ],
   "Our first task is to seize a fortress. Then, others will join us.", "pretender_start", [
	]],

  [anyone ,"start",
   [
     (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
     (eq, "$g_talk_troop", "$supported_pretender"),
     ],
   "I await your counsel, {playername}.", "supported_pretender_talk", [
     ]],

  [anyone ,"start",
   [
     (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
     (assign, "$pretender_told_story", 0),
     (eq, "$g_talk_troop_met", 0),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
     ],
   "Do I know you?", "pretender_intro_1", []],
  [anyone|plyr ,"pretender_intro_1", [], "My name is {playername}.", "pretender_intro_2", []],
  [anyone|plyr ,"pretender_intro_1", [], "I am {playername}. Perhaps you have heard of my exploits.", "pretender_intro_2", []],

  [anyone ,"pretender_intro_2", [(troop_get_slot, ":rebellion_string", "$g_talk_troop", slot_troop_original_faction),
                                 (val_sub, ":rebellion_string", "fac_kingdom_1"),
                                 (val_add, ":rebellion_string", "str_swadian_rebellion_pretender_intro"),
                                 (str_store_string, 48, ":rebellion_string"),],
   "{s48}", "pretender_intro_3", []],

  [anyone|plyr ,"pretender_intro_3", [(troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
                                      (str_store_faction_name, s12, ":original_faction"),
                                      (faction_get_slot, ":original_ruler", ":original_faction", slot_faction_leader),
                                      (str_store_troop_name, s11, ":original_ruler"),],
   "I thought {s12} was ruled by {s11}...", "pretender_rebellion_cause_1", [(troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),]],

  [anyone ,"start",
   [
     (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
	 #code
	 
     ],
   "Greetings, {playername}.", "pretender_start", [
		(assign, "$pretender_told_story", 0),
	]],

   #oim code 
  [anyone|plyr ,"pretender_start",
   [
		(check_quest_active, "qst_oim_getman_barabash"),
		(neg|check_quest_succeeded, "qst_oim_getman_barabash"),
		(neg|check_quest_finished,"qst_oim_getman_barabash"),
		(quest_slot_eq, "qst_oim_getman_barabash", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_kingdom_5_pretender"), 
     ],
   "Tell me of the Black Mace.", "oim_getman_barabash_story", []],

  [anyone|plyr ,"pretender_start",
   [
		(check_quest_active, "qst_oim_dmitriy_razin"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_razin"),
		(neg|check_quest_finished,"qst_oim_dmitriy_razin"),
		(quest_slot_eq, "qst_oim_dmitriy_razin", slot_quest_current_state, 0),
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
     ],
   "You were looking for me?", "oim_dmitriy_talk_razin_first", []],

 [anyone|plyr ,"pretender_start",
   [
		(check_quest_active, "qst_oim_dmitriy_razin"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_razin"),
		(neg|check_quest_finished,"qst_oim_dmitriy_razin"),
		(quest_slot_eq, "qst_oim_dmitriy_razin", slot_quest_current_state, 1),
		(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
     ],
   "I changed my mind.", "oim_dmitriy_talk_razin_first_5_pos_1", []],
   
   
   
  [anyone|plyr ,"pretender_start",
   [
		(check_quest_active, "qst_oim_getman_nesvizh_pernach"),
		(check_quest_succeeded, "qst_oim_getman_nesvizh_pernach"),
		(neg|check_quest_finished,"qst_oim_getman_nesvizh_pernach"),
		(eq, "$g_talk_troop", "trp_kingdom_5_pretender"), 
     ],
   "The Black Mace is mine, Colonel!", "oim_getman_barabash_pernach_taken", []],
   
   

  [anyone|plyr ,"pretender_start",
   [
     (troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
     (eq, "$pretender_told_story", 0)
     ],
   "What was your story again, {reg65?my lady:sir}?", "pretender_rebellion_cause_prelim", [
     ]],

  [anyone,"pretender_rebellion_cause_prelim", [],
   "I shall tell you.", "pretender_rebellion_cause_1", [
                     ]],


  [anyone,"pretender_rebellion_cause_1", [],
   "{s48}", "pretender_rebellion_cause_2", [
                     (assign, "$pretender_told_story", 1),
                     (troop_get_slot, ":rebellion_string", "$g_talk_troop", slot_troop_original_faction),
                     (val_sub, ":rebellion_string", "fac_kingdom_1"),                                
                     (val_add, ":rebellion_string", "str_swadian_rebellion_pretender_story_1"),
                     (str_store_string, 48, ":rebellion_string"),
                     ]],

  [anyone,"pretender_rebellion_cause_2", [],
   "{s48}", "pretender_rebellion_cause_3", [
                     (troop_get_slot, ":rebellion_string", "$g_talk_troop", slot_troop_original_faction),
                     (val_sub, ":rebellion_string", "fac_kingdom_1"),                                
                     (val_add, ":rebellion_string", "str_swadian_rebellion_pretender_story_2"),
                     (str_store_string, 48, ":rebellion_string"),
                     ]],

  [anyone,"pretender_rebellion_cause_3", [],
   "{s48}", "pretender_start", [
                     (troop_get_slot, ":rebellion_string", "$g_talk_troop", slot_troop_original_faction),
                     (val_sub, ":rebellion_string", "fac_kingdom_1"),                                
                     (val_add, ":rebellion_string", "str_swadian_rebellion_pretender_story_3"),
                     (str_store_string, 48, ":rebellion_string"),
                     ]],

  [anyone|plyr ,"pretender_start", [
                    (troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
					(assign, ":flag", 0), 
					(try_begin),
						(check_quest_active, "qst_oim_dmitriy_razin"),
						(neg|check_quest_succeeded, "qst_oim_dmitriy_razin"),
						(neg|check_quest_finished,"qst_oim_dmitriy_razin"),
						(quest_slot_eq, "qst_oim_dmitriy_razin", slot_quest_current_state, 0),
						(eq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
						(assign, ":flag", 1),
					(end_try), 
					(try_begin),
						(check_quest_active, "qst_oim_potop_main"),
						(neg|check_quest_succeeded, "qst_oim_potop_main"),
						(neg|check_quest_finished,"qst_oim_potop_main"),
						(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
						(assign, ":flag", 1),
					(end_try), 					
					(eq, ":flag", 0),
					
                     ],
   "I wish to take up your cause, and help you reclaim the throne!", "pretender_discuss_rebellion_1", [
     ]],

  [anyone|plyr ,"pretender_start", [
                     ],
   "I must leave now.", "pretender_end", [
     ]],

  [anyone ,"pretender_discuss_rebellion_1", [(troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
                                             (faction_get_slot, ":original_ruler", ":original_faction", slot_faction_leader),
                                             (str_store_troop_name, s11, ":original_ruler")],
   "Your words are a great comfort, but are you certain that you are equal to the task, {playername}? Taking the throne is no simple matter. The nobles of our realm have all sworn oaths of fealty to {s11} -- a very powerful man. Oaths to such a usurper are invalid, of course, and we may expect some of the nobles to side with us, but it will be a very difficult and challenging struggle nevertheless.", "pretender_discuss_rebellion_2", []],
 
  [anyone|plyr ,"pretender_discuss_rebellion_2", [],  "I am ready for whatever may come.", "pretender_discuss_rebellion_3", []],
  [anyone|plyr ,"pretender_discuss_rebellion_2", [],  "You are right. Perhaps I should think on this further...", "pretender_end", []],

  [anyone ,"pretender_discuss_rebellion_3", [(neg|troop_slot_ge, "trp_player",slot_troop_renown, 200),
                                             (troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
                                             (faction_get_slot, ":original_ruler", ":original_faction", slot_faction_leader),
                                             (str_store_troop_name, s11, ":original_ruler")],
   "I have no doubt that your support for my cause is heartfelt, {playername}, and I am grateful to you for it. But I cannot think that we have much chance of success. However, if you prove yourself on the battlefield, and make a name for yourself as a great commander, then our friends will not hesitate to join our cause -- and our enemies will be wary to take up arms against us. When that time comes, I will join with you gladly. But until then, it would be wiser to quietly gather our strengths, and not openly challenge the usurper, {s11}.", "close_window", []],

  [anyone ,"pretender_discuss_rebellion_3", [(gt, "$supported_pretender", 0),
                                             (str_store_troop_name, s17, "$supported_pretender")],
   "Have you not already taken up the banner of {s17}? You would play two sides against the middle, it seems. Thank you kindly, but no -- I think I will not be a part of this game.", "close_window", []],

  [anyone ,"pretender_discuss_rebellion_3", [(gt, "$players_kingdom", 0),
                                             (neq, "$players_kingdom", "fac_player_supporters_faction"),
                                             (neq, "$players_kingdom", "fac_player_faction"),
                                             (troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
                                             (neq, "$players_kingdom", ":original_faction"),
                                             (gt, "$player_has_homage", 0),
                                             (str_store_faction_name, s16, "$players_kingdom"),
                                             (faction_get_slot, ":player_ruler", "$players_kingdom", slot_faction_leader),
                                             (str_store_troop_name, s15, ":player_ruler"),
                                             (str_store_faction_name, s17, ":original_faction"),
                                             ],
   "{playername}, you are already oath-bound to serve {s15}. Thus, I cannot allow you to take up my cause, or my enemies would claim that I am but a mere puppet of {s16}. No, if I am to gain the throne of {s17}, I shall only do it through the righteousness of my cause, and the support of my loyal subjects. If you wish to lend me your arms, you must first free yourself of your oath to {s15}.", "close_window", []],

  [anyone ,"pretender_discuss_rebellion_3", [(troop_get_slot, ":original_faction", "$g_talk_troop", slot_troop_original_faction),
                                             (str_store_faction_name, s12, ":original_faction"),
                                             (faction_get_slot, ":original_ruler", ":original_faction", slot_faction_leader),
                                             (str_store_troop_name, s11, ":original_ruler")],
   "You are a capable warrior, {playername}, and I am sure that with your renown as a commander, and the righteousness of our cause, the nobles and the good people of {s12} will eagerly support us. Indeed, the time is ripe to act! I will join with you, and together, we shall topple the usurper {s11} and retake the throne from his bloody hands. But first, you must give me your oath of homage, and accept me as your {reg65?lady and master:liege lord}.", "pretender_rebellion_ready", []],


  [anyone ,"pretender_discuss_rebellion", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     (assign, "$town_to_rebel",    0),
                     (assign, "$town_to_approach", 0),
                     (troop_get_slot, ":rebellion_target_faction", "$g_talk_troop", slot_troop_original_faction),
                     (try_for_range, ":town", towns_begin, towns_end),
                        (store_faction_of_party, ":town_faction", ":town"),
                        (eq, ":town_faction", ":rebellion_target_faction"),
                        (party_get_slot, ":siege_state", ":town", slot_village_state),
                        (neq, ":siege_state", svs_under_siege),
                        (try_begin),
                            (party_slot_ge, ":town", slot_town_rebellion_readiness, 30),
                            (assign, "$town_to_rebel", ":town"),
                        (else_try),
#                            (party_get_slot, ":contact", ":town", slot_town_rebellion_contact), 
#                            (lt, ":contact", 2),
                            (assign, "$town_to_approach", ":town"),
                            (assign, ":support_base_is_available", 1),
                            (try_begin),
#Check to see if support base is captured or under siege
                            (try_end),
                        (try_end),
                     (try_end),
                     (eq, "$town_to_rebel", 0),
                     (gt, "$town_to_approach", 0),
                     (gt, ":support_base_is_available", 0),
                     ],
   "Before we rebel, I ask that you raise support for my cause. I have always enjoyed strong backing from {s4}, but you may be able to find friends in other places. Are you willing to do this for me?", "pretender_town_quest", [
                     (troop_get_slot, ":support_base", "$g_talk_troop", slot_troop_support_base),
                     (str_store_party_name, s4, ":support_base"),
     ]],

  [anyone ,"pretender_discuss_rebellion", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     (eq, "$town_to_rebel", 0),
                     (gt, "$town_to_approach", 0),
                     ],
   "Before we rebel, I ask that you raise support for my cause. If you have good ties with any of the towns, you should try there. Are you willing to do this for me?", "pretender_town_quest", [
     ]],


  [anyone ,"pretender_discuss_rebellion", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     (eq, "$town_to_approach", 0),

                     ],
   "The time is not yet right for a rebellion. Let us spend a while in quiet preparation.", "pretender_start", [
     ]],


  [anyone ,"pretender_discuss_rebellion", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     (gt, "$town_to_rebel", 0),
                     (gt, "$players_kingdom", 0),
                     ],
   "You have laid the groundwork for a rebellion, but you have sworn allegiance to another noble.", "pretender_start", [
     ]],

  [anyone ,"pretender_discuss_rebellion", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     (gt, "$town_to_rebel", 0),
                     ],   "You have done well. {s4}, and possibly other towns, are ready to join us. When you are ready, we shall ride forth to war.", "pretender_rebellion_ready", [
                     (str_store_party_name, 4, "$town_to_rebel"),
     ]],


  [anyone|plyr ,"pretender_rebellion_ready", [
                     (troop_get_type, reg3, "$g_talk_troop"),
                     ],
   "I am ready to pledge myself to your cause, {reg3?my lady:my lord}.", "lord_give_oath_2", [
     ]],

  [anyone|plyr ,"pretender_rebellion_ready", [
                     ],
   "Let us bide our time a little longer.", "pretender_end", [
     ]],

  [anyone ,"lord_give_conclude_2", [(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                     ],
   "Forward, then! Our first task is to take hold of a fortress, and persuade other nobles to join us. You shall lead the way!", "close_window", [

            (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 50), #should be higher
            (faction_set_slot, "$g_talk_troop_faction", slot_faction_state, sfs_active),
##            (faction_set_slot, "$g_talk_troop_faction", slot_faction_ai_state, sfai_nascent_rebellion),

            (party_force_add_members, "p_main_party", "$supported_pretender", 1),
            (troop_set_slot, "$supported_pretender", slot_troop_cur_center, 0),
            (troop_set_auto_equip, "$supported_pretender",0),
            (str_store_troop_name_link, s6, "$supported_pretender"),
            (display_message, "@{s6} has joined your party."),
            
#            (faction_get_slot, ":location", "$g_talk_troop_faction", slot_faction_inactive_leader_location),
#            (faction_set_slot, "$g_talk_troop_faction", slot_faction_inactive_leader_location, 0),

#            (call_script, "script_create_kingdom_hero_party", "$g_talk_troop", ":location"),
#            (party_set_slot, "$pout_party", slot_party_commander_party, "p_main_party"),
#            (call_script, "script_party_decide_next_ai_state_under_command", "$pout_party"),
#            (store_current_hours, ":follow_until_time"),
#            (store_add, ":follow_period", 60, "$g_talk_troop_relation"),
#            (val_div, ":follow_period", 2),
#            (val_add, ":follow_until_time", ":follow_period"),
#            (party_set_slot, "$pout_party", slot_party_follow_player_until_time, ":follow_until_time"),
#            (party_set_slot, "$pout_party", slot_party_following_player, 1),


            (assign, "$player_made_legitimacy_claim", 0),
            (assign, "$player_made_benefit_claim", 0),
            (assign, "$player_made_strength_claim", 0),
            (assign, "$player_made_benefit_claim", 0),


#            (assign, ":rebellion_target", "$supported_pretender_old_faction"),
            (store_relation, ":reln", "$supported_pretender_old_faction", "fac_player_supporters_faction"),
            (val_min, ":reln", -50),
            (call_script, "script_set_player_relation_with_faction", "$supported_pretender_old_faction", ":reln"),
			
            (str_store_faction_name, s1, "$supported_pretender_old_faction"),
            (faction_set_name, "fac_player_supporters_faction", "@{s1} Rebels"),
            (faction_set_color, "fac_player_supporters_faction", 0xFF0000),

## Let us handle relation with other kingdoms later.
##            (try_for_range, ":existing_kingdom", kingdoms_begin, kingdoms_end),
##                (store_relation, ":relation", ":existing_kingdom", ":rebellion_target"),
##                (store_sub, ":relation_w_rebels", 0, ":relation"),
##                (store_relation, ":player_relation", ":existing_kingdom", "fac_player_supporters_faction"),
##                (val_div, ":player_relation", 3),
##                (val_add, ":relation_w_rebels", ":player_relation"),
##				  #WARNING: Never use set_relation!
##                (set_relation, ":existing_kingdom", "$g_talk_troop_faction", ":relation_w_rebels"),
##            (try_end),

# we have alrady joined.
##            (str_store_faction_name, 4, "$g_talk_troop_faction"),
##            (display_message, "@Player joins {s4}"),
##            (call_script, "script_player_join_faction", "$g_talk_troop_faction"),
            (call_script, "script_update_all_notes"),
            ]],



  [anyone|plyr ,"pretender_town_quest", [
                                 ],
   "The town is ready.", "pretender_discuss_rebellion", [
                     (troop_get_slot, ":support_base", "$g_talk_troop", slot_troop_support_base),

                     (party_set_slot, ":support_base", slot_town_rebellion_readiness, 40),
     ]],

  [anyone|plyr ,"pretender_town_quest", [                    
                     ],
   "I am not interested, thank you.", "pretender_end", [
     ]],


  [anyone ,"pretender_end", [
                     ],
   "Farewell for now, then.", "close_window", [
     ]],



# Events....
# Choose friend.  
#Post 0907 changes begin
  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (neq, "$g_talk_troop_met", 0),
                     (gt, "$g_time_since_last_talk", 24),
                     (gt, "$g_talk_troop_relation", -10),
                     (store_random_in_range, ":random_num", 0, 100),
                     (lt, ":random_num", 30),
                     (eq,"$talk_context",tc_town_talk),
                     (call_script, "script_cf_troop_get_random_enemy_troop_with_occupation", "$g_talk_troop", slto_kingdom_hero),
                     (assign, ":other_lord",reg0),
                     (troop_get_slot, ":other_lord_relation", ":other_lord", slot_troop_player_relation),
                     (ge, ":other_lord_relation", 20),
                     (str_store_troop_name, s6, ":other_lord"),
                     (assign, "$temp", ":other_lord"),
                     ],
   "I heard that you have befriended that {s43} also known as {s6}. Believe me, you can't trust that man. You would be wise to end your dealings with him.", "lord_event_choose_friend", [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_insult_default"),

     ]],

  [anyone|plyr ,"lord_event_choose_friend", [],  "I assure you, {s65}, I am no friend of {s6}.", "lord_event_choose_friend_renounce", [
      (call_script, "script_change_player_relation_with_troop","$g_talk_troop",5),
      (call_script, "script_change_player_relation_with_troop","$temp",-10),
      ]],

  [anyone ,"lord_event_choose_friend_renounce", [],  "That is well, {playername}. Otherwise, one might fear for your safety. If you do encounter {s6}, be on your guard -- and don't believe a word uttered by that snake's tongue.", "lord_pretalk", []],
  
  [anyone|plyr ,"lord_event_choose_friend", [],  "{s6} is an honorable man. You've no right to speak of him thus.", "lord_event_choose_friend_defend", [
      (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-10),
      (call_script, "script_change_player_relation_with_troop","$temp",5),
      ]],
  [anyone ,"lord_event_choose_friend_defend", [],  "As you will, {playername}. A fool you may be, but a loyal fool at the least. Be warned that {s6}'s loyalty may not be so constant...", "lord_pretalk", []],
#Post 0907 changes end
  
  [anyone|plyr ,"lord_event_choose_friend", [],  "I have no wish to involve myself in your quarrel with {s6}.", "lord_event_choose_friend_neutral", [
      (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-2),
      (call_script, "script_change_player_relation_with_troop","$temp",-3),
      ]],

  [anyone ,"lord_event_choose_friend_neutral", [],  "Hmm... As you wish, {playername}. Just remember that a {man/woman} needs friends in this world, and you may find but few, if you will stand with no one.", "lord_pretalk", []],

#Meeting.

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (check_quest_active, "qst_join_faction"),
                     (eq, "$g_invite_faction_lord", "$g_talk_troop"),
                     (try_begin),
                       (gt, "$g_invite_offered_center", 0),
                       (store_faction_of_party, ":offered_center_faction", "$g_invite_offered_center"),
                       (neq, ":offered_center_faction", "$g_talk_troop_faction"),
                       (call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
                       (assign, "$g_invite_offered_center", reg0),
                     (try_end),
                     ],
   #TODO: change conversations according to relation.
   "{playername}, I've been expecting you. Word has reached my ears of your exploits. Why, I keep hearing tales of such prowess and bravery that my mind was quickly made up. I know I have found someone worthy of becoming my vassal.", "lord_invite_1",
   []],


  [anyone|plyr ,"lord_invite_1", [],  "Thank you, {s65}. You honor me.", "lord_invite_2",  []],
  [anyone|plyr ,"lord_invite_1", [],  "It is good to have my true value recognized.", "lord_invite_2",  []],
   
  [anyone ,"lord_invite_2", [],  "Aye. Let us dispense with formalities, {playername}; are you prepared to swear your fealty to me?", "lord_invite_3",  []],
    
  [anyone|plyr ,"lord_invite_3", [],  "Yes, {s65}.", "lord_give_oath_2",  []],
  [anyone|plyr ,"lord_invite_3", [],  "No, {s65}. I cannot serve you at present.", "lord_enter_service_reject",  []],

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (neq, "$g_talk_troop_met", 0),
                     (gt, "$g_time_since_last_talk", 24),
                     (gt, "$g_talk_troop_relation", 50),
                     (gt, "$g_talk_troop_faction_relation", 10),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "If it isn't my brave champion, {playername}!", "lord_start",  []],
  
  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (neq, "$g_talk_troop_met", 0),
                     (gt, "$g_time_since_last_talk", 24),
                     (gt, "$g_talk_troop_relation", 10),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "It is good to see you again {playername}...", "lord_start", []],

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (neq, "$g_talk_troop_met", 0),
                     (gt, "$g_time_since_last_talk", 24),
#                     (lt, "$g_talk_troop_faction_relation", 0),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "And so we meet again, {playername}...", "lord_start", []],

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (eq, "$g_talk_troop_met", 0),
                     (ge, "$g_talk_troop_faction_relation", 0),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "Do I know you?", "lord_meet_neutral", []],
  [anyone|plyr ,"lord_meet_neutral", [],  "I am {playername}.", "lord_intro", []],
  [anyone|plyr ,"lord_meet_neutral", [],  "My name is {playername}. At your service, sir.", "lord_intro", []],

  [anyone ,"lord_intro", [],
   "{s11}", "lord_start", [(faction_get_slot, ":faction_leader", "$g_talk_troop_faction", slot_faction_leader),
                          (str_store_faction_name, s6, "$g_talk_troop_faction"),
                          (assign, reg4, 0),
                          (str_store_troop_name, s4, "$g_talk_troop"),
                          (try_begin),
                            (eq, ":faction_leader", "$g_talk_troop"),
                            (str_store_string, s9, "@I am {s4}, the ruler of {s6}", 0),
                          (else_try),
                            (str_store_string, s9, "@I am {s4}, a vassal of {s6}", 0),
                          (try_end),
                          (assign, ":num_centers", 0),
                          (str_clear, s8),
                          (try_for_range_backwards, ":cur_center", centers_begin, centers_end),
                            (party_slot_eq, ":cur_center", slot_town_lord, "$g_talk_troop"),
                            (try_begin),
                              (eq, ":num_centers", 0),
                              (str_store_party_name, s8, ":cur_center"),
                            (else_try),
                              (eq, ":num_centers", 1),
                              (str_store_party_name, s7, ":cur_center"),
                              (str_store_string, s8, "@{s7} and {s8}"),
                            (else_try),
                              (str_store_party_name, s7, ":cur_center"),
                              (str_store_string, s8, "@{s7}, {s8}"),
                            (try_end),
                            (val_add, ":num_centers", 1),
                          (try_end),
                          (assign, reg5, ":num_centers"),
                          (str_store_string, s11, "@{s9}{reg5? and the lord of {s8}.:.", 0),
                          ]],

#  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
#                     (eq, "$g_talk_troop_met", 0),
#                     (ge, "$g_talk_troop_faction_relation", 0),
#                     (le,"$talk_context",tc_siege_commander),
#                     ],
#   "Who is this then?", "lord_meet_ally", []],
#  [anyone|plyr ,"lord_meet_ally", [],  "I am {playername} sir. A warrior of {s4}.", "lord_start", []],
#  [anyone|plyr ,"lord_meet_ally", [],  "I am but a soldier of {s4} sir. My name is {playername}.", "lord_start", []],

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (eq, "$g_talk_troop_met", 0),
                     (lt, "$g_talk_troop_faction_relation", 0),
#                     (str_store_faction_name, s4,  "$players_kingdom"),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "{s43}", "lord_meet_enemy", [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_enemy_meet_default"),
       ]],
  [anyone|plyr ,"lord_meet_enemy", [],  "I am {playername}, {s65}.", "lord_intro", []],  #A warrior of {s4}.
  [anyone|plyr ,"lord_meet_enemy", [],  "They call me {playername}. You have no doubt heard of my exploits.", "lord_intro", []],
#  [anyone, "lord_meet_enemy_2", [],  "{playername} eh? Never heard of you. What do want?", "lord_talk", []],

  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_hero),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "Well, {playername}...", "lord_start",
   []],


  [anyone,"lord_start", [(gt, "$g_comment_found", 0), #changed to s32 from s62 because overlaps with setup_talk_info strings
                        ],  "{s42}", "lord_start", [
#                         (store_current_hours, ":cur_time"),
#                         (troop_set_slot, "$g_talk_troop", slot_troop_last_comment_time, ":cur_time"),
                         (try_begin),
                           (neq, "$log_comment_relation_change", 0),
                           (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", "$log_comment_relation_change"),
                         (try_end),
                         (assign, "$g_comment_found", 0),
                         ]],  


	
  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
    (eq,":lords_quest","qst_lend_surgeon"),
                         (quest_slot_eq, "qst_lend_surgeon", slot_quest_giver_troop, "$g_talk_troop")],
   "Your surgeon managed to convince my friend to agree to the operation. The matter is in God's hands now -- all we can do is pray. No matter the outcome, I thank you for lending your surgeon to me, {sir/madam}. I shall never forget your generosity.", "lord_generic_mission_completed",
  [
    (call_script, "script_finish_quest", "qst_lend_surgeon", 100),
    (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
  ]],
##### TODO: QUESTS COMMENT OUT BEGIN

##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_bring_prisoners_to_enemy"),
##                         (quest_slot_eq, "qst_bring_prisoners_to_enemy", slot_quest_current_state, 0),
##                         (check_quest_succeeded, "qst_bring_prisoners_to_enemy"),
##                         (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                         (assign, reg1, ":quest_target_amount")],
##   "TODO: You have brought the prisoners and received {reg1} denars. Give me the money now.", "lord_bring_prisoners_complete_2",[]],
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_bring_prisoners_to_enemy"),
##                         (quest_slot_eq, "qst_bring_prisoners_to_enemy", slot_quest_current_state, 1),#Some of them were brought only
##                         (check_quest_succeeded, "qst_bring_prisoners_to_enemy"),
##                         (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                         (assign, reg1, ":quest_target_amount")],
##   "TODO: You have brought the prisoners but some of them died during your expedition. Give me the full money of {reg1} denars.", "lord_bring_prisoners_complete_2",[]],
##
##
##  [anyone|plyr,"lord_bring_prisoners_complete_2", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                                   (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                                   (ge, ":cur_gold", ":quest_target_amount")],
##   "TODO: Here it is.", "lord_generic_mission_thank", [(quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                                  (troop_remove_gold, "trp_player", ":quest_target_amount"),
##                                                  (call_script, "script_finish_quest", "qst_bring_prisoners_to_enemy", 100)]],
##  
##  [anyone|plyr,"lord_bring_prisoners_complete_2", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                                   (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                                   (lt, ":cur_gold", ":quest_target_amount")],
##   "TODO: I'm afraid I spent some of it, I don't have that much money with me.", "lord_bring_prisoners_no_money", [(quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                                                                                                   (call_script, "script_change_debt_to_troop", "$g_talk_troop", ":quest_target_amount"),#Adding the taken money as a debt
##                                                                                                                   (call_script, "script_finish_quest", "qst_bring_prisoners_to_enemy", 100)]],
##
##  [anyone,"lord_bring_prisoners_no_money", [],
##   "TODO: You owe me that money!", "lord_pretalk", []],
##
##
  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_incriminate_loyal_commander"),
                         (check_quest_active, "qst_incriminate_loyal_commander"),
                         (check_quest_succeeded, "qst_incriminate_loyal_commander"),
                         (quest_get_slot, ":quest_target_troop", "qst_incriminate_loyal_commander", slot_quest_target_troop),
                         (str_store_troop_name, s3, ":quest_target_troop"),
                         (quest_get_slot, reg5, "qst_incriminate_loyal_commander", slot_quest_gold_reward),
                         ],
   "Hah! That poor fool {s3} -- our little plot against him worked perfectly, {playername}. He has lost one of his most valuable nobles, and we are one step closer to bringing him to his knees. Here, this purse contains {reg5} thaler. I wish you to have it. And need I remind you -- there's much more to come for those with a mind to earn it...", "lord_generic_mission_completed",[
     (call_script, "script_end_quest", "qst_incriminate_loyal_commander"),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",5),
     (call_script, "script_change_player_honor", -10),
     ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_incriminate_loyal_commander"),
                         (check_quest_failed, "qst_incriminate_loyal_commander")],
   "You proved yourself unable to complete even a simple task. I had arranged everything. All you needed to do was sacrifice a simple messenger, and we would be celebrating now. But no, I suppose your precious honor got in the way, eh?", "close_window",[
     (call_script, "script_end_quest", "qst_incriminate_loyal_commander"),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-5),
     (call_script, "script_change_player_honor", 3),
 ]],
  #TODO: NO GENERIC MISSION FAILED ANYMORE!!!!


  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_meet_spy_in_enemy_town"),
                         (check_quest_active, "qst_meet_spy_in_enemy_town"),
                         (check_quest_succeeded, "qst_meet_spy_in_enemy_town"),
                         ],
   "Have you brought me any news of that task I gave you? You know the one I mean...", "quest_meet_spy_in_enemy_town_completed",
   []],

  [anyone|plyr, "quest_meet_spy_in_enemy_town_completed", [],
   "I have the reports you wanted right here.", "quest_meet_spy_in_enemy_town_completed_2",[]],

  [anyone, "quest_meet_spy_in_enemy_town_completed_2", [],
   "Ahh, very good! Very good indeed. It is good to have competent {men/people} at my side. Here is the payment I promised you.", "lord_pretalk",
   [
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 3),
     (add_xp_as_reward, 500),
     (quest_get_slot, ":gold", "qst_meet_spy_in_enemy_town", slot_quest_gold_reward),
     (call_script, "script_troop_add_gold", "trp_player", ":gold"),
     (call_script, "script_end_quest", "qst_meet_spy_in_enemy_town"),
     ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_raid_caravan_to_start_war"),
                         (check_quest_active, "qst_raid_caravan_to_start_war"),
                         (check_quest_succeeded, "qst_raid_caravan_to_start_war"),
                         (quest_get_slot, ":quest_target_faction", "qst_raid_caravan_to_start_war", slot_quest_target_faction),
                         (str_store_faction_name, s13, ":quest_target_faction"),
                         ],
   "Excellent work, {playername}! Your raids really got their attention, I must say. I've just received word that {s13} has declared war! Now the time has come for us to reap the benefits of our hard work, {playername}. This war is sure to make us rich {men/souls}, mark my words!", "lord_pretalk",
   [
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
    (try_for_range, ":vassal", kingdom_heroes_begin, kingdom_heroes_end),
		(store_troop_faction, ":vassal_fac", ":vassal"),
      (eq, ":vassal_fac", "$players_kingdom"),
      (neq,  ":vassal", "$g_talk_troop"),
      (store_random_in_range, ":rel_change", -5, 4),
      (call_script, "script_change_player_relation_with_troop", ":vassal", ":rel_change"),
    (try_end),
    #TODO: Add gold reward notification before the quest is given. 500 gold is not mentioned anywhere.
    (call_script, "script_troop_add_gold", "trp_player", 500),
    (add_xp_as_reward, 2000),
    (call_script, "script_change_player_honor", -5),
    (call_script, "script_end_quest", "qst_raid_caravan_to_start_war")
    ]],

  [anyone,"lord_start", [(store_partner_quest, ":lords_quest"),
                         (eq, ":lords_quest", "qst_raid_caravan_to_start_war"),
                         (check_quest_failed, "qst_raid_caravan_to_start_war"),
                         ],
   "You incompetent buffoon! What in Hell made you think that it would be wise to get yourself captured while we're trying to start a war?! These plans were months in preparation -- and now everything's been ruined! I shan't forget this, {playername}. Oh, rest assured that I will not.", "lord_pretalk",
   [
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -10),
    (call_script, "script_end_quest", "qst_raid_caravan_to_start_war")
    ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_collect_debt"),
                         (quest_slot_eq, "qst_collect_debt", slot_quest_current_state, 1),
                         (quest_get_slot, ":target_troop", "qst_collect_debt", slot_quest_target_troop),
                         (str_store_troop_name, s7, ":target_troop"),
                         (quest_get_slot, ":total_collected","qst_collect_debt",slot_quest_target_amount),
                         (store_div, reg3, ":total_collected", 5),
                         (store_sub, reg4, ":total_collected", reg3)],
   "I am told that you have collected the money owed me from {s7}. This is well -- it is past time I had it back. I believe I promised to give you one-fifth of it, eh? Well, that makes {reg3} thaler, so if you give me my share -- that's {reg4} thaler -- you can keep the rest.", "lord_collect_debt_completed", []],

  
  [anyone|plyr,"lord_collect_debt_completed", [(store_troop_gold, ":gold", "trp_player"),
                                               (ge, ":gold", reg4)],
   "Of course, {s65}. {reg4} thaler, all here.", "lord_collect_debt_pay",[]],

  [anyone,"lord_collect_debt_pay", [],
   "I must admit I'm impressed, {playername}. I had lost hope of ever getting this money back. Please accept my sincere thanks.", "lord_pretalk",[
     (troop_remove_gold, "trp_player", reg4),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3),
     (add_xp_as_reward, 100),
     (call_script, "script_end_quest", "qst_collect_debt")
     ]],
  
  [anyone|plyr,"lord_collect_debt_completed", [], "I am afraid I don't have the money with me sir.", "lord_collect_debt_no_pay",[]],
  [anyone,"lord_collect_debt_no_pay", [], "Do you jest? I know full well that {s7} gave you the money, and I want every thaler owed me, {sir/madam}. As far as I'm concerned, you are personally in my debt until I see every last silver coin.", "close_window",[
     (call_script, "script_change_debt_to_troop", "$g_talk_troop", reg4),
     (call_script, "script_end_quest", "qst_collect_debt"),

     (call_script, "script_objectionable_action", tmt_honest, "str_squander_money"),
     ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_kill_local_merchant"),
                         (check_quest_active, "qst_kill_local_merchant"),
                         (check_quest_succeeded, "qst_kill_local_merchant"),
                         (quest_slot_eq, "qst_kill_local_merchant", slot_quest_current_state, 1)],
   "I heard you got rid of that damnable merchant that was causing me so much grief. -- And I can see you're not afraid to get your hands dirty, eh? I like that in a {man/woman}. Here's your reward. Remember, {playername}, stick with me and we'll go a long, long way together.", "close_window",
   [ (call_script, "script_troop_add_gold", "trp_player", 600),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",4),
     (add_xp_as_reward, 300),
     (call_script, "script_end_quest", "qst_kill_local_merchant"),

     (call_script, "script_objectionable_action", tmt_humanitarian, "str_murder_merchant"), 
     
     (assign, "$g_leave_encounter", 1)]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_kill_local_merchant"),
                         (check_quest_failed, "qst_kill_local_merchant")],
   "Oh, it's you. Enlighten me, how exactly does one lose a simple fight with some poxy, lowborn merchant? Verily, if ever I need my guardsmen to take a lesson in how to lay down and die, I'll be sure to come straight to your door. You are dismissed, {playername}, I have matters to attend.", "close_window",
   [(call_script, "script_end_quest", "qst_kill_local_merchant"),
    (assign, "$g_leave_encounter", 1)]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_kill_local_merchant"),
                         (check_quest_active, "qst_kill_local_merchant"),
                         (check_quest_succeeded, "qst_kill_local_merchant"),
                         (quest_slot_eq, "qst_kill_local_merchant", slot_quest_current_state, 2)],
   "You! Do you have sawdust between your ears? Did you think when I said to kill the merchant, I meant you should have a nice chat with him and then let him go?! What on earth possessed you?", "lord_kill_local_merchant_let_go",[]],

  [anyone|plyr,"lord_kill_local_merchant_let_go", [],
   "Sir, I made certain that he will not act against you.", "lord_kill_local_merchant_let_go_2",[]],

  [anyone,"lord_kill_local_merchant_let_go_2", [],
   "Piffle. You were to remove him without a fuss, not give him a sermon and send him on his merry way. He had better do as you say, or you'll both regret it. Here, this is half the money I promised you. Don't utter a word, {playername}, you're lucky to get even that. I have little use for {men/people} who cannot follow orders.", "lord_pretalk",
   [(call_script, "script_troop_add_gold", "trp_player", 300),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",2),
     (add_xp_as_reward, 500),
     (call_script, "script_end_quest", "qst_kill_local_merchant"),
     (assign, "$g_leave_encounter", 1)
    ]],

##  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_hunt_down_raiders"),
##                         (check_quest_failed, "qst_hunt_down_raiders")],
##   "I heard that those raiders you were after have got away. Do you have an explanation?", "quest_hunt_down_raiders_failed",[]],
##  [anyone|plyr,"quest_hunt_down_raiders_failed", [],  "They were too quick for us my lord. But next time we'll get them", "quest_hunt_down_raiders_failed_2",[]],
##  [anyone|plyr,"quest_hunt_down_raiders_failed", [],  "They were too strong and well armed my lord. But we'll be ready for them next time.", "quest_hunt_down_raiders_failed_2",[]],
##  
##  [anyone|plyr,"quest_hunt_down_raiders_failed", [],  "Well, it was a long call anyway. Next time do make sure that you are better prepared.",
##   "lord_pretalk",[(call_script, "script_end_quest", "qst_hunt_down_raiders")]],
##
##
##
##  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_hunt_down_raiders"),
##                         (check_quest_succeeded, "qst_hunt_down_raiders")],
##   "I heard that you have given those raiders the punishment they deserved. Well done {playername}.\
## ", "lord_generic_mission_completed",[(call_script, "script_finish_quest", "qst_hunt_down_raiders", 100),
##                                      (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3)]],
##


##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_defend_nobles_against_peasants"),
##                         (this_or_next|check_quest_succeeded, "qst_defend_nobles_against_peasants"),
##                         (check_quest_failed, "qst_defend_nobles_against_peasants"),
##                         (assign, ":num_saved", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee_woman"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (assign, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_saved"),
##                         (eq, ":num_saved", "$qst_defend_nobles_against_peasants_num_nobles_to_save")],
##   "TODO: You have saved all of them. Good boy.", "lord_generic_mission_completed",
##   [(party_remove_members, "p_main_party", "trp_noble_refugee", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##    (party_remove_members, "p_main_party", "trp_noble_refugee_woman", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##    (call_script, "script_finish_quest", "qst_defend_nobles_against_peasants", 100)]],
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_defend_nobles_against_peasants"),
##                         (this_or_next|check_quest_succeeded, "qst_defend_nobles_against_peasants"),
##                         (check_quest_failed, "qst_defend_nobles_against_peasants"),
##                         (assign, ":num_saved", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee_woman"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (assign, "$qst_defend_nobles_against_peasants_num_nobles_saved", ":num_saved"),
##                         (lt, ":num_saved", "$qst_defend_nobles_against_peasants_num_nobles_to_save"),
##                         (gt, "$qst_defend_nobles_against_peasants_num_nobles_saved", 0)],
##   "TODO: You have saved some of them. Half good boy.", "lord_capture_conspirators_half_completed",
##   [(party_remove_members, "p_main_party", "trp_noble_refugee", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##    (party_remove_members, "p_main_party", "trp_noble_refugee_woman", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##    (assign, ":ratio", 100),
##    (val_mul, ":ratio", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##    (val_div, ":ratio", "$qst_defend_nobles_against_peasants_num_nobles_to_save"),
##    (call_script, "script_finish_quest", "qst_defend_nobles_against_peasants", ":ratio")]],
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_defend_nobles_against_peasants"),
##                         (this_or_next|check_quest_succeeded, "qst_defend_nobles_against_peasants"),
##                         (check_quest_failed, "qst_defend_nobles_against_peasants"),
##                         (assign, ":num_saved", "$qst_defend_nobles_against_peasants_num_nobles_saved"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (party_count_companions_of_type, ":num_nobles", "p_main_party", "trp_noble_refugee_woman"),
##                         (val_add, ":num_saved", ":num_nobles"),
##                         (eq, ":num_saved", 0)],
##   "TODO: You have saved none of them. Bad boy.", "lord_generic_mission_failed", []],
##
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_capture_conspirators"),
##                         (this_or_next|check_quest_succeeded, "qst_capture_conspirators"),
##                         (check_quest_failed, "qst_capture_conspirators"),
##                         (party_count_prisoners_of_type, ":num_conspirators", "p_main_party", "trp_conspirator"),
##                         (party_count_prisoners_of_type, ":num_conspirator_leaders", "p_main_party", "trp_conspirator_leader"),
##                         (store_add, ":sum_captured", ":num_conspirators", ":num_conspirator_leaders"),
##                         (ge, ":sum_captured", "$qst_capture_conspirators_num_troops_to_capture")],
##   "TODO: You have captured all of them. Good boy.", "lord_generic_mission_completed",
##   [(party_remove_prisoners, "p_main_party", "trp_conspirator_leader", "$qst_capture_conspirators_num_troops_to_capture"),
##    (party_remove_prisoners, "p_main_party", "trp_spy_partner", "$qst_capture_conspirators_num_troops_to_capture"),
##    (call_script, "script_finish_quest", "qst_capture_conspirators", 100)]],
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_capture_conspirators"),
##                         (this_or_next|check_quest_succeeded, "qst_capture_conspirators"),
##                         (check_quest_failed, "qst_capture_conspirators"),
##                         (party_count_prisoners_of_type, ":num_conspirators", "p_main_party", "trp_conspirator"),
##                         (party_count_prisoners_of_type, ":num_conspirator_leaders", "p_main_party", "trp_conspirator_leader"),
##                         (store_add, ":sum_captured", ":num_conspirators", ":num_conspirator_leaders"),
##                         (lt, ":sum_captured", "$qst_capture_conspirators_num_troops_to_capture"),
##                         (gt, ":sum_captured", 0)],
##   "TODO: You have captured some of them. Half good boy.", "lord_capture_conspirators_half_completed",
##   [(assign, ":sum_removed", 0),
##    (party_remove_prisoners, "p_main_party", "trp_conspirator_leader", "$qst_capture_conspirators_num_troops_to_capture"),
##    (val_add, ":sum_removed", reg0),
##    (party_remove_prisoners, "p_main_party", "trp_conspirator", "$qst_capture_conspirators_num_troops_to_capture"),
##    (val_add, ":sum_removed", reg0),
##    (val_mul, ":sum_removed", 100),
##    (val_div, ":sum_removed", "$qst_capture_conspirators_num_troops_to_capture"),
##    (call_script, "script_finish_quest", "qst_capture_conspirators", ":sum_removed")]],
##
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (store_partner_quest,":lords_quest"),
##                         (eq,":lords_quest","qst_capture_conspirators"),
##                         (this_or_next|check_quest_succeeded, "qst_capture_conspirators"),
##                         (check_quest_failed, "qst_capture_conspirators"),
##                         (party_count_prisoners_of_type, ":num_conspirators", "p_main_party", "trp_conspirator"),
##                         (party_count_prisoners_of_type, ":num_conspirator_leaders", "p_main_party", "trp_conspirator_leader"),
##                         (store_add, ":sum_captured", ":num_conspirators", ":num_conspirator_leaders"),
##                         (eq, ":sum_captured", 0)],
##   "TODO: You have captured none of them. Bad boy.", "lord_generic_mission_failed", []],
##
##  [anyone|plyr,"lord_capture_conspirators_half_completed", [],
##   "TODO: That's all I can do.", "lord_pretalk", []],


  [anyone,"lord_start", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
						 (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                         (store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_follow_spy"),
                         (eq, "$qst_follow_spy_no_active_parties", 1),
                         (party_count_prisoners_of_type, ":num_spies", "p_main_party", "trp_spy"),
                         (party_count_prisoners_of_type, ":num_spy_partners", "p_main_party", "trp_spy_partner"),
                         (gt, ":num_spies", 0),
                         (gt, ":num_spy_partners", 0)],
   "Beautiful work, {playername}! You captured both the spy and his handler, just as I'd hoped. Even now, the pair are safely tucked away in my dungeon, awaiting questioning. My torturer shall have a busy night! I'm most pleased with your success, {playername}. Here, let me give you this purse as a token of my gratitude.", "lord_follow_spy_completed",
   [(party_remove_prisoners, "p_main_party", "trp_spy", 1),
    (party_remove_prisoners, "p_main_party", "trp_spy_partner", 1),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",4),
    (call_script, "script_troop_add_gold", "trp_player", 2000),
    (add_xp_as_reward, 4000),
    (call_script, "script_end_quest", "qst_follow_spy")]],

  [anyone,"lord_start", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
						 (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                         (store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_follow_spy"),
                         (eq, "$qst_follow_spy_no_active_parties", 1),
                         (party_count_prisoners_of_type, ":num_spies", "p_main_party", "trp_spy"),
                         (party_count_prisoners_of_type, ":num_spy_partners", "p_main_party", "trp_spy_partner"),
                         (gt, ":num_spies", 0),
                         (eq, ":num_spy_partners", 0),],
   "Blast and damn you! I wanted two prisoners, {playername}. What you've brought me is one step short of useless! I already know everything the spy knows. It was the handler I was after. Here, half a job gets you half a reward. Take it and begone.", "lord_follow_spy_half_completed",
   [(party_remove_prisoners, "p_main_party", "trp_spy", 1),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-1),
    (call_script, "script_troop_add_gold", "trp_player", 1000),
    (add_xp_as_reward, 400),
    (call_script, "script_end_quest", "qst_follow_spy")]],

  [anyone,"lord_start", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
					     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                         (store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_follow_spy"),
                         (eq, "$qst_follow_spy_no_active_parties", 1),
                         (party_count_prisoners_of_type, ":num_spies", "p_main_party", "trp_spy"),
                         (party_count_prisoners_of_type, ":num_spy_partners", "p_main_party", "trp_spy_partner"),
                         (eq, ":num_spies", 0),
                         (gt, ":num_spy_partners", 0),
                         ],
   "I asked you for two prisoners, {playername}, not one. Two. Still, I suppose you did capture the spy's handler, the more important member of the pair. The spy will never dare return, and will show himself quite useless to whatever master he served. 'Tis better than nothing. However, you'll understand if I pay you only half the promised reward for what is but a half success.", "lord_follow_spy_half_completed",
   [(party_remove_prisoners, "p_main_party", "trp_spy_partner", 1),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",1),
    (call_script, "script_troop_add_gold", "trp_player", 1000),
    (add_xp_as_reward, 400),
    (call_script, "script_end_quest", "qst_follow_spy")]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_follow_spy"),
                         (eq, "$qst_follow_spy_no_active_parties", 1),
                         (party_count_prisoners_of_type, ":num_spies", "p_main_party", "trp_spy"),
                         (party_count_prisoners_of_type, ":num_spy_partners", "p_main_party", "trp_spy_partner"),
                         (eq, ":num_spies", 0),
                         (eq, ":num_spy_partners", 0),
                         ],
   "Truly, {playername}, you are nothing short of an oaf. Failing to capture neither the spy and his handler -- why, you plumb astonishing new depths of failure. Forget about the reward I offered you. You've done nothing to earn it.", "lord_follow_spy_failed",
   [
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-2),
    (call_script, "script_end_quest", "qst_follow_spy"),
    ]],

  [anyone|plyr,"lord_follow_spy_half_completed", [],
   "I did my best, {s65}.", "lord_pretalk", []],

  [anyone|plyr,"lord_follow_spy_completed", [],
   "Thank you, {s65}.", "lord_pretalk", []],

  [anyone|plyr,"lord_follow_spy_failed", [],
   "Hrm. As you wish, {s65}.", "lord_pretalk", []],


  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_bring_back_runaway_serfs"),
                         (check_quest_active, "qst_bring_back_runaway_serfs"),
                         (check_quest_succeeded, "qst_bring_back_runaway_serfs")],
   "Damn me, but you've done it, {playername}. All the serfs have returned, and they're busy preparing for the harvest. You have certainly earned your reward. Here, take it with my compliments.", "lord_generic_mission_completed",
   [(call_script, "script_change_player_relation_with_troop","$g_talk_troop",4),
    (call_script, "script_troop_add_gold", "trp_player", 300),
    (add_xp_as_reward, 300),
    (call_script, "script_end_quest", "qst_bring_back_runaway_serfs"),
    (call_script, "script_objectionable_action", tmt_humanitarian, "str_round_up_serfs"),
    ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_bring_back_runaway_serfs"),
                         (check_quest_failed, "qst_bring_back_runaway_serfs"),],
   "{playername}... I have been waiting patiently for my serfs, but not a one has returned. Have you an explanation for this? Outwitted by simple field hands were you? Or perhaps you merely incompetent -- or even plotting with my enemies, and intent on my ruin...", "lord_bring_back_runaway_serfs_failed", []],
  [anyone|plyr,"lord_bring_back_runaway_serfs_failed", [],
   "Forgive me, {s65}, those serfs were slippery as eels.", "lord_bring_back_runaway_serfs_failed_1a", []],
  [anyone|plyr,"lord_bring_back_runaway_serfs_failed", [],
   "Perhaps if you had treated them better...", "lord_bring_back_runaway_serfs_failed_1b", []],
  [anyone,"lord_bring_back_runaway_serfs_failed_1a", [],
   "Hah! 'Tis hardly an excuse for failure, {playername}. Now if you will excuse me, I must recruit some new men to work the fields before we all starve.", "lord_pretalk",
   [(call_script, "script_change_player_relation_with_troop","$g_talk_troop",-1),
    (call_script, "script_end_quest", "qst_bring_back_runaway_serfs")]],
  [anyone,"lord_bring_back_runaway_serfs_failed_1b", [],
   "Hah, now you finally reveal your true colors, traitor! And your words match your actions all too well. I should never have trusted you.", "close_window",
   [(call_script, "script_change_player_relation_with_troop","$g_talk_troop",-10),
    (quest_get_slot, ":home_village", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (call_script, "script_change_player_relation_with_center",":home_village",6),
    (call_script, "script_end_quest", "qst_bring_back_runaway_serfs"),
    (assign, "$g_leave_encounter", 1),
    ]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_bring_back_runaway_serfs"),
                         (check_quest_concluded, "qst_bring_back_runaway_serfs"),
                         (assign, reg17, "$qst_bring_back_runaway_serfs_num_parties_returned")],
   "You disappoint me, {playername}. There were three groups of serfs that I charged you to return. Three. Not {reg17}. Ah well, I suppose those who did return shall have to work twice as hard to make up for those that got away. As for your reward, {playername}, I'll only pay you for the serfs you returned, not the ones you let slip. Here. Take it, and let this business be done.", "lord_runaway_serf_half_completed",
   [(store_mul, ":reward", "$qst_bring_back_runaway_serfs_num_parties_returned", 100),
    (val_div, ":reward", 2),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop","$qst_bring_back_runaway_serfs_num_parties_returned"),
    (call_script, "script_troop_add_gold", "trp_player", ":reward"),
    (add_xp_as_reward, ":reward"),


    (call_script, "script_objectionable_action", tmt_humanitarian, "str_round_up_serfs"),
    
    (call_script, "script_end_quest", "qst_bring_back_runaway_serfs"),
    ]],

  [anyone|plyr,"lord_runaway_serf_half_completed", [],
   "Thank you, {s65}. You are indeed generous.", "lord_pretalk", []],
  [anyone|plyr,"lord_runaway_serf_half_completed", [],
   "Bah, this has proven a waste of my time.", "lord_pretalk", []],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_deal_with_bandits_at_lords_village"),
                         (check_quest_succeeded, "qst_deal_with_bandits_at_lords_village")],
   "{playername}, I was told that you crushed the bandits at my village of {s5}. Please know that I am most grateful to you for this. Please, let me help pay for the expenses of your campaign. Here, I hope these {reg14} thaler will be adequate.", "lord_deal_with_bandits_completed",
   [
       (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 3),
       (store_character_level, ":level", "trp_player"),
       (store_mul, ":reward", ":level", 20),
       (val_add, ":reward", 300),
       (call_script, "script_troop_add_gold", "trp_player", ":reward"),
       (add_xp_as_reward, 350),
       (call_script, "script_end_quest", "qst_deal_with_bandits_at_lords_village"),
       (assign, reg14, ":reward"),
       (quest_get_slot, ":village", "qst_deal_with_bandits_at_lords_village", slot_quest_target_center),
       (str_store_party_name, s5, ":village"),
       ]],

  [anyone|plyr, "lord_deal_with_bandits_completed", [],
   "It was my pleasure, {s65}.", "lord_pretalk",[]],
  [anyone|plyr, "lord_deal_with_bandits_completed", [],
   "Glad to be of service.", "lord_pretalk",[]],
  [anyone|plyr, "lord_deal_with_bandits_completed", [],
   "It was mere child's play.", "lord_pretalk",[]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq,":lords_quest","qst_deal_with_bandits_at_lords_village"),
                         (check_quest_concluded, "qst_deal_with_bandits_at_lords_village")],
   "Damn it, {playername}. I hear that you were unable to drive off the bandits from my village of {s5}. Indeed, thanks to you my village now lies in ruins. Everyone told me that you were an adept fighter, but apparently I was misinformed.", "lord_pretalk",
   [
       (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -5),
       (call_script, "script_end_quest", "qst_deal_with_bandits_at_lords_village"),
       (quest_get_slot, ":village", "qst_deal_with_bandits_at_lords_village", slot_quest_target_center),
       (str_store_party_name, s5, ":village"),
       ]],


  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq, ":lords_quest", "qst_deliver_cattle_to_army"),
                         (check_quest_active, "qst_deliver_cattle_to_army"),
                         (check_quest_succeeded, "qst_deliver_cattle_to_army"),
                         (quest_get_slot, reg13, "qst_deliver_cattle_to_army", slot_quest_target_amount),
                         ],
   "{playername}, my quartermaster has informed me that you delivered the cattle! I don't know whether to count the heads or the tails, but either way, there's {reg13} of them. I'm impressed!", "lord_deliver_cattle_to_army_thank",
   [
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 2),
     (quest_get_slot, ":quest_target_amount", "qst_deliver_cattle_to_army", slot_quest_target_amount),
     #TODO: Change reward
     (store_mul, ":reward", ":quest_target_amount", 100),
     (call_script, "script_troop_add_gold", "trp_player", ":reward"),
     (val_div, ":reward", 5),
     (add_xp_as_reward, ":reward"),
     (call_script, "script_end_quest", "qst_deliver_cattle_to_army"),
     #Reactivating follow army quest
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (setup_quest_text, "qst_follow_army"),
     (str_store_string, s2, "@Your mission is complete, {s9} wants you to resume following his army until further notice."),
     (call_script, "script_start_quest", "qst_follow_army", "$g_talk_troop"),
     (assign, "$g_player_follow_army_warnings", 0),
     ]],

  [anyone|plyr, "lord_deliver_cattle_to_army_thank", [],
   "You are welcome, {s65}.", "lord_pretalk",[]],
  [anyone|plyr, "lord_deliver_cattle_to_army_thank", [],
   "Glad to be of service.", "lord_pretalk",[]],
  [anyone|plyr, "lord_deliver_cattle_to_army_thank", [],
   "Heh... Mere child's play.", "lord_pretalk",[]],

  [anyone,"lord_start", [(store_partner_quest,":lords_quest"),
                         (eq, ":lords_quest", "qst_scout_waypoints"),
                         (check_quest_active, "qst_scout_waypoints"),
                         (check_quest_succeeded, "qst_scout_waypoints"),
                         (str_store_party_name, s13, "$qst_scout_waypoints_wp_1"),
                         (str_store_party_name, s14, "$qst_scout_waypoints_wp_2"),
                         (str_store_party_name, s15, "$qst_scout_waypoints_wp_3"),
                         ],
   "You make a good scout, {playername}. My runner just brought me the reports of your work at {s13}, {s14} and {s15}. Well done.", "lord_scout_waypoints_thank",
   [
     #TODO: Change reward
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
#     (call_script, "script_troop_add_gold", "trp_player", 100),
     (add_xp_as_reward, 100),
     (call_script, "script_end_quest", "qst_scout_waypoints"),
     #Reactivating follow army quest
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (setup_quest_text, "qst_follow_army"),
     (str_store_string, s2, "@Your mission is complete, {s9} wants you to resume following his army until further notice."),
     (call_script, "script_start_quest", "qst_follow_army", "$g_talk_troop"),
     (assign, "$g_player_follow_army_warnings", 0),
     ]],

  [anyone|plyr, "lord_scout_waypoints_thank", [],
   "A simple task, {s65}.", "lord_pretalk",[]],
  [anyone|plyr, "lord_scout_waypoints_thank", [],
   "It was nothing I couldn't handle.", "lord_pretalk",[]],
  [anyone|plyr, "lord_scout_waypoints_thank", [],
   "My pleasure, sir.", "lord_pretalk",[]],
  


  [anyone, "lord_start",
   [
     (check_quest_active, "qst_follow_army"),
     (faction_slot_eq, "$g_talk_troop_faction", slot_faction_marshall, "$g_talk_troop"),
     (eq, "$g_random_army_quest", "qst_deliver_cattle_to_army"),
     (quest_get_slot, ":quest_target_amount", "$g_random_army_quest", slot_quest_target_amount),
     (assign, reg3, ":quest_target_amount"),
     ],
   "The army's supplies are running out, {playername}. I need you to bring {reg3} head of cattle so I can keep the troops fed. I care not where you get them, just bring them to me as soon as you can.", "lord_mission_told_deliver_cattle_to_army",
   [
   ]
   ],

  [anyone|plyr,"lord_mission_told_deliver_cattle_to_army", [], "Very well, I will find you some cattle.", "lord_mission_told_deliver_cattle_to_army_accepted",[]],
  [anyone|plyr,"lord_mission_told_deliver_cattle_to_army", [], "Sorry, sir, I have other plans.", "lord_mission_told_deliver_cattle_to_army_rejected",[]],

  [anyone,"lord_mission_told_deliver_cattle_to_army_accepted", [], "Excellent! Now you know what to do, {playername}, so get to it. I need that cattle sooner than later.", "close_window",
   [
     (call_script, "script_end_quest", "qst_follow_army"),
     (quest_get_slot, ":quest_target_amount", "$g_random_army_quest", slot_quest_target_amount),
     (str_store_troop_name_link, s13, "$g_talk_troop"),
     (assign, reg3, ":quest_target_amount"),
     (setup_quest_text, "$g_random_army_quest"),
     (str_store_string, s2, "@{s13} asked you to gather {reg3} heads of cattle and deliver them back to him."),
     (call_script, "script_start_quest", "$g_random_army_quest", "$g_talk_troop"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
     (assign, "$g_leave_encounter",1),
    ]],

  [anyone, "lord_mission_told_deliver_cattle_to_army_rejected", [], "That is... unfortunate, {playername}. I shall have to find someone else who's up to the task. Please go now. I've much work to do.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    (assign, "$g_leave_encounter",1),]],
  


  [anyone,"lord_start",[(check_quest_active,"qst_report_to_army"),
                        (quest_slot_eq, "qst_report_to_army", slot_quest_target_troop, "$g_talk_troop"),
                        ],
   "Ah, you have arrived at last, {playername}. We've been expecting you. I hope your troops are experienced -- and in strong numbers.", "lord_report_to_army_asked",
   []],

  [anyone|plyr,"lord_report_to_army_asked", [(quest_get_slot, ":quest_target_amount", "qst_report_to_army", slot_quest_target_amount),
                                             (call_script, "script_party_count_fit_for_battle", "p_main_party"),
                                             (gt, reg0, ":quest_target_amount"), # +1 for player
                                             ],
   "Yes, I have a company of good, hardened soldiers with me. We are ready to join you.", "lord_report_to_army_completed",
   []],

  [anyone|plyr,"lord_report_to_army_asked", [],
   "I don't have the sufficient number of troops yet. I still need more time.", "lord_report_to_army_continue",
   []],

  [anyone,"lord_report_to_army_completed", [], "Excellent. I shall send word when I have a task for you. For the moment, simply follow us and stay close. We'll be moving shortly.", "close_window",[
     (call_script, "script_end_quest", "qst_report_to_army"),
     (quest_set_slot, "qst_report_to_army", slot_quest_giver_troop, "$g_talk_troop"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 2),
     #Activating follow army quest
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (setup_quest_text, "qst_follow_army"),
     (str_store_string, s2, "@{s9} wants you to follow his army until further notice."),
     (call_script, "script_start_quest", "qst_follow_army", "$g_talk_troop"),
     (assign, "$g_player_follow_army_warnings", 0),
     (assign, "$g_leave_encounter", 1),
   ]],

  [anyone,"lord_report_to_army_continue", [], "Then you had better hurry. We will soon be moving against the enemy, and I need every able hand we can muster.", "close_window",
   [(assign, "$g_leave_encounter",1),
    #Must be closed because of not letting player to terminate this quest on the general conversation
    ]],


  [anyone, "lord_start",
   [
     (check_quest_active, "qst_follow_army"),
     (faction_slot_eq, "$g_talk_troop_faction", slot_faction_marshall, "$g_talk_troop"),
     (eq, "$g_random_army_quest", "qst_scout_waypoints"),
     (str_store_party_name, s13, "$qst_scout_waypoints_wp_1"),
     (str_store_party_name, s14, "$qst_scout_waypoints_wp_2"),
     (str_store_party_name, s15, "$qst_scout_waypoints_wp_3"),
     ],
   "{playername}, I need a volunteer to scout the area. We are sorely lacking information, and I simply must have a clearer picture of the situation before we can proceed. I want you to go to {s13}, {s14}, and {s15} -- and report back whatever you find.", "lord_mission_told_scout_waypoints",
   [
   ]],

  [anyone|plyr, "lord_mission_told_scout_waypoints", [], "Agree...", "lord_mission_told_scout_waypoints_accepted",[]],
  [anyone|plyr, "lord_mission_told_scout_waypoints", [], "Refuse...", "lord_mission_told_scout_waypoints_rejected",[]],

  [anyone,"lord_mission_told_scout_waypoints_accepted", [], "Pass near {s13}, {s14}, and {s15} and find out what's going on there. Make a note of anything you discover, and return here to me.", "close_window",
   [
     (call_script, "script_end_quest", "qst_follow_army"),
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (str_store_party_name_link, s13, "$qst_scout_waypoints_wp_1"),
     (str_store_party_name_link, s14, "$qst_scout_waypoints_wp_2"),
     (str_store_party_name_link, s15, "$qst_scout_waypoints_wp_3"),
     (setup_quest_text, "$g_random_army_quest"),
     (str_store_string, s2, "@{s9} asked you to scout {s13}, {s14} and {s15}, then report back."),
     (call_script, "script_start_quest", "$g_random_army_quest", "$g_talk_troop"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
     (assign, "$g_leave_encounter",1),
    ]],

  [anyone,"lord_mission_told_scout_waypoints_rejected", [], "Hm. I'm disappointed, {playername}. Most disappointed. We shall talk later. At present I must go and find a capable scout.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],


  

##
##  [anyone,"lord_start",[(check_quest_active,"qst_rescue_lady_under_siege"),
##                        (quest_slot_eq, "qst_rescue_lady_under_siege", slot_quest_target_troop, "$g_talk_troop"),
##                        (quest_slot_eq, "qst_rescue_lady_under_siege", slot_quest_current_state, 1)],
##   "I heard that you have rescued my {s7} from the siege of {s5} and brought her to safety.\
## I am in your debt for this {playername}. Thank you.", "lord_generic_mission_completed",
##   [(quest_get_slot, ":quest_object_troop", "qst_rescue_lady_under_siege", slot_quest_object_troop),
##    (try_begin),
##      (troop_slot_eq, "$g_talk_troop", slot_troop_daughter, ":quest_object_troop"),
##      (str_store_string, s7, "str_daughter"),
##    (else_try),
##      (str_store_string, s7, "str_wife"),
##    (try_end),
##    (remove_member_from_party, ":quest_object_troop"),
##    (try_begin),
##      (is_between, "$g_encountered_party", centers_begin, centers_end),#Lord might be in wilderness
##      (troop_set_slot, ":quest_object_troop", slot_troop_cur_center, "$g_encountered_party"),
##    (try_end),
##    (call_script, "script_finish_quest", "qst_rescue_lady_under_siege", 100),
##    (call_script, "script_change_player_relation_with_troop","$g_talk_troop", 4),    
##    ]],
##
##### TODO: QUESTS COMMENT OUT END
  [anyone,"lord_generic_mission_thank", [],
   "You have been most helpful, {playername}. You have my gratitude.", "lord_generic_mission_completed",[]],

  [anyone|plyr,"lord_generic_mission_completed", [],
   "It is an honor to serve.", "lord_pretalk",[]],

##  [anyone|plyr,"lord_generic_mission_failed", [],
##   "I'm sorry I failed you sir. It won't happen again.", "lord_pretalk",
##   [(store_partner_quest,":lords_quest"),
##    (call_script, "script_finish_quest", ":lords_quest"),
##    ]],
  
  [anyone,"lord_start", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                         (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                         (troop_get_slot, ":cur_debt", "$g_talk_troop", slot_troop_player_debt),
                         (gt, ":cur_debt", 0),
                         (assign, reg1, ":cur_debt")],
   "I do believe you owe me {reg1} thaler, {playername}. Might I expect you to pay your debt any time soon?", "lord_pay_debt_2",[]],

  [anyone|plyr, "lord_pay_debt_2", [(troop_get_slot, ":cur_debt", "$g_talk_troop", slot_troop_player_debt),
                                    (store_troop_gold, ":cur_gold", "trp_player"),
                                    (le, ":cur_debt", ":cur_gold")],
   "That's why I came, {s65}. Here it is, all I owe you down to the last cooper.", "lord_pay_debt_3_1", [(troop_get_slot, ":cur_debt", "$g_talk_troop", slot_troop_player_debt),
                                                   (troop_remove_gold, "trp_player", ":cur_debt"),
                                                   (troop_set_slot, "$g_talk_troop", slot_troop_player_debt, 0)]],

  [anyone|plyr, "lord_pay_debt_2", [],
   "Alas, I am still a bit short on cash, {s65}. But I shall return what I owe soon enough.", "lord_pay_debt_3_2", []],

  [anyone, "lord_pay_debt_3_1", [],
   "Ah, excellent. You are a {man/woman} of honor, {playername}. I am satisfied -- your debt to me has been paid in full.", "lord_pretalk", []],

  [anyone, "lord_pay_debt_3_2", [],
   "Very well -- but don't keep me waiting much longer.", "lord_pretalk", []],

##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (is_between,"$g_talk_troop_faction_relation",0,3),
###                         (eq,"$players_kingdom",0),
##                         ],
##   "Why don't you join us in our cause? You seem to be an able fighter.\
## We need {men/people} like you who will take part in our glory and share the spoils of our victory.", "lord_talk",[]],


#Claim center begin
##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (eq,"$g_talk_troop_faction","$players_kingdom"),
##                         (faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
##                         (call_script, "script_get_number_of_unclaimed_centers_by_player"),
##                         (gt, reg1, 0),
##                         (assign, "$center_to_be_claimed", reg1),
##                         (str_store_party_name, s4, "$center_to_be_claimed"),
##                         ],
##   "I heard that your forces have taken {s4}. I commend you for your victory {playername}.\
## But we need to decide what to do with this new castle now.", "lord_claim_center_begin", []],


##  [anyone,"lord_start", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                         (ge,"$g_talk_troop_faction_relation",0),
##                         (call_script, "script_get_number_of_unclaimed_centers_by_player"),
##                         (gt, reg1, 0),
##                         (assign, "$center_wanted_to_be_bought", reg1),
##                         (str_store_party_name, s4, "$center_wanted_to_be_bought"),
##                         (call_script, "script_get_number_of_hero_centers", "$g_talk_troop"),
##                         (assign, ":no_of_owned_centers", reg0),
##                         (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
##                         (lt, ":no_of_owned_centers", 2),
##                         (troop_get_slot, ":wealth", "$g_talk_troop", slot_troop_wealth),
##                         (ge, ":wealth", 6000)],
##   "I heard that your forces have taken {s4}. I applaud your victory {playername}, but you know as well as I do that\
## as a person of low rank and status you cannot be permitted to hold that castle for yourself.\
## It is to your benefit to sell it to a Lord like myself who can hold and protect the castle and the surrounding estates.\
## Anyway, I am ready to make you an offer of 5000 denars, should you decide to sell that castle.", "lord_buy_center", []],
##
##
##  [anyone|plyr,"lord_buy_center", [],
##   "I accept your offer sir. The castle is yours for 5000 denars.", "lord_buy_center_accept", []],
##  [anyone|plyr,"lord_buy_center", [],
##   "I am afraid I can't accept that offer.", "lord_buy_center_deny", []],
##
##  [anyone,"lord_buy_center_accept", [],
##   "Excellent, {playername}! You have decided wisely.\
## Why bother yourself with the necessities of keeping a castle while you can leave all those boring details to noble Lords like me?\
## I am sure money will be much more useful to you than a castle would.", "lord_buy_center_accept_2", []],
##
##  [anyone|plyr,"lord_buy_center_accept_2", [],
##   "One day sir, one day I'll have my own castle.", "lord_buy_center_accept_3", []],
##  [anyone|plyr,"lord_buy_center_accept_2", [],
##   "Everyone needs money sir. I can take another castle anytime.", "lord_buy_center_accept_3", []],
##
##  [anyone,"lord_buy_center_accept_3", [],
##   "Of course, of course, {playername}.  Then let us conclude our deal. Here's the 5000 denars I offered you.\
## I'll have my clerk handle the necessary details.\
## I guess from now on, {s4} belongs to me. Well, that worked very well for both of us, I guess.", "lord_pretalk",
##   [(troop_get_slot, ":wealth", "$g_talk_troop", slot_troop_wealth),
##    (val_sub, ":wealth", 6000),
##    (troop_set_slot, "$g_talk_troop", slot_troop_wealth, ":wealth"),
##    (call_script, "script_troop_add_gold", "trp_player", 5000),
##    (party_set_slot, "$center_wanted_to_be_bought", slot_town_lord, "$g_talk_troop"),
##    #Changing center faction
##    (party_set_faction, "$center_wanted_to_be_bought", "$g_talk_troop_faction"),
##    (set_spawn_radius, 1),
##    (spawn_around_party, "$center_wanted_to_be_bought", "pt_old_garrison"),
##    (assign, ":new_party", reg0),
##    (party_set_ai_behavior, ":new_party", ai_bhvr_attack_party),
##    (party_set_ai_object, ":new_party", "p_main_party"),
##    (party_set_flags, ":new_party", pf_default_behavior, 0),
##    (call_script, "script_party_copy", ":new_party", "$center_wanted_to_be_bought"),
##    (party_clear, "$center_wanted_to_be_bought"),
##
##    (faction_get_slot, ":reinforcement_template_archers", "$g_talk_troop_faction", slot_faction_reinforcements_archers),
##    (faction_get_slot, ":reinforcement_template_infantry", "$g_talk_troop_faction", slot_faction_reinforcements_infantry),
##    (party_add_template, "$center_wanted_to_be_bought", ":reinforcement_template_archers"),
##    (party_add_template, "$center_wanted_to_be_bought", ":reinforcement_template_infantry"),
##    ]],
##
##  [anyone,"lord_buy_center_deny", [],
##   "As you wish {playername}. But don't forget, the great lords of the country won't like a low born {man/woman} like you holding such an estate without their consent.\
## It is the nature of this world {playername}. Everyone should know their place.", "lord_pretalk", []],

  [anyone,"lord_start", [(party_slot_eq, "$g_encountered_party",slot_town_lord, "$g_talk_troop"),#we are talking to Town's Lord.
                         (ge,"$g_talk_troop_faction_relation",0),
                         (neq, "$g_ransom_offer_rejected", 1),
                         (lt, "$g_encountered_party_2", 0), #town is not under siege
                         (hero_can_join_as_prisoner, "$g_encountered_party"),
                         (store_random_in_range, ":random_no", 0, 100),
                         (lt, ":random_no", 10),#start this conversation with a 10% chance
                         (party_get_num_prisoner_stacks,":num_prisoner_stacks","p_main_party"),
                         (assign, "$prisoner_lord_to_buy", -1),
                         (try_for_range,":i_pris_stack",0,":num_prisoner_stacks"),
                           (party_prisoner_stack_get_troop_id, ":t_id", "p_main_party", ":i_pris_stack"),
                           (troop_slot_eq, ":t_id", slot_troop_occupation, slto_kingdom_hero),
                           (store_troop_faction, ":fac", ":t_id"),
                           (store_relation, ":rel", ":fac", "$g_talk_troop_faction"),
                           (lt,  ":rel", 0),
                           (assign, "$prisoner_lord_to_buy", ":t_id"),
                         (try_end),
                         (gt, "$prisoner_lord_to_buy", 0), #we have a prisoner lord.
                         (assign, ":continue", 1),
                         (try_begin),
                           (check_quest_active, "qst_capture_enemy_hero"),
                           (store_troop_faction, ":prisoner_faction", "$prisoner_lord_to_buy"),
                           (quest_slot_eq, "qst_capture_enemy_hero", slot_quest_target_faction, ":prisoner_faction"),
                           (assign, ":continue", 0),
                         (try_end),
                         (eq, ":continue", 1),
                         (str_store_troop_name, s3, "$prisoner_lord_to_buy"),
                         (assign, reg5, "$prisoner_lord_to_buy"),
                         (call_script, "script_calculate_ransom_amount_for_troop", "$prisoner_lord_to_buy"),
                         (assign, reg6, reg0),
                         (val_div, reg6, 2),
                         (assign, "$temp", reg6),
                         ],
   "I have received word you captured our enemy {s3} -- and indeed that he is with you this very moment. I can pay you {reg6} thaler for him, if you would care to be rid of him. You might also wait for his family to pay his ransom of course, but there's no telling how long that will take, eh?", "lord_buy_prisoner", []],

  [anyone|plyr,"lord_buy_prisoner", [],
   "I accept your offer. I shall leave {s3} to you for {reg6} thaler.", "lord_buy_prisoner_accept", []],
  [anyone|plyr,"lord_buy_prisoner", [],
   "I'm afraid I can't accept your offer.", "lord_buy_prisoner_deny", [(assign, "$g_ransom_offer_rejected", 1),]],

  [anyone,"lord_buy_prisoner_accept", [],
   "Excellent! Here's your {reg6} thaler. I shall send my men to take him to our prison with all due haste.", "lord_pretalk", [
     (remove_troops_from_prisoners,  "$prisoner_lord_to_buy", 1),
     (call_script, "script_troop_add_gold", "trp_player", "$temp"),
     (party_add_prisoners, "$g_encountered_party", "$prisoner_lord_to_buy", 1),
     #(troop_set_slot, "$prisoner_lord_to_buy", slot_troop_is_prisoner, 1),
     (troop_set_slot, "$prisoner_lord_to_buy", slot_troop_prisoner_of_party, "$g_encountered_party"),
     ]],

  [anyone,"lord_buy_prisoner_deny", [],
   "Mmm. As you wish, {playername}, but you shan't get a better offer. Take my word for it.", "lord_pretalk", []],

  [anyone,"lord_start", [],
   "So, what is your business?", "lord_talk",[]],

#  [anyone,"lord_start_2", [],
#   "Yes?", "lord_talk",[]],

  [anyone,"lord_pretalk", [
	#(store_faction_of_party, "$g_encountered_party_faction","$g_encountered_party"),
	#(store_relation, "$g_encountered_party_relation", "$g_encountered_party_faction", "fac_player_faction"),
  ],
   "Anything else?", "lord_talk",[]],

  [anyone,"hero_pretalk", [],
   "Anything else?", "lord_talk",[]],

##### TODO: QUESTS COMMENT OUT BEGIN

  [anyone|plyr,"lord_talk",[#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                            (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                            (check_quest_active,"qst_lend_companion"),
                            (quest_slot_eq, "qst_lend_companion", slot_quest_giver_troop, "$g_talk_troop"),
                            (store_current_day, ":cur_day"),
                            (quest_get_slot, ":quest_target_amount", "qst_lend_companion", slot_quest_target_amount),
                            (ge, ":cur_day", ":quest_target_amount"),
                            (quest_get_slot, ":quest_target_troop", "qst_lend_companion", slot_quest_target_troop),
                            (str_store_troop_name,s14,":quest_target_troop"),
                            (troop_get_type, reg3, ":quest_target_troop"),
                            ],
   "I should like {s14} returned to me, {s65}, if you no longer require {reg3?her:his} services.", "lord_lend_companion_end",
   []],

  [anyone,"lord_lend_companion_end",[(neg|hero_can_join, "p_main_party")],
   "You have too many men in your company already, {playername}. You could not lead any more at the moment.", "lord_pretalk",
   []],

  [anyone,"lord_lend_companion_end",[],
   "Certainly, {playername}. {reg3?She:He} is a bright {reg3?girl:fellow}. You're lucky to have such worthy companions.", "lord_pretalk",
   [(quest_get_slot, ":quest_target_troop", "qst_lend_companion", slot_quest_target_troop),
    (party_add_members, "p_main_party", ":quest_target_troop", 1),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 3),
    (add_xp_as_reward, 100),
    (call_script, "script_end_quest", "qst_lend_companion"),
    (str_store_troop_name,s14,":quest_target_troop"),
    (troop_get_type, reg3, ":quest_target_troop"),
    ]],
   
  [anyone|plyr,"lord_talk",[(check_quest_active,"qst_collect_debt"),
                            (quest_slot_eq,  "qst_collect_debt", slot_quest_current_state, 0),
                            (quest_get_slot, ":quest_target_troop", "qst_collect_debt", slot_quest_target_troop),
                            (eq,"$g_talk_troop",":quest_target_troop"),
                            (quest_get_slot, ":quest_giver_troop", "qst_collect_debt", slot_quest_giver_troop),
                            (str_store_troop_name, s1, ":quest_giver_troop")],
   "I've come to collect the debt you owe to {s1}.", "lord_ask_to_collect_debt",
   [(assign, "$g_convince_quest", "qst_collect_debt")]],

  [anyone,"lord_ask_to_collect_debt", [],  "Oh. Well {s1} did lend me some silver a ways back... but I've done him quite a few favors in the past -- and that money was due to me!", "lord_ask_to_collect_debt_2",[]],
  [anyone|plyr,"lord_ask_to_collect_debt_2", [],  "{s1} considers it a debt.", "convince_begin",[]],
  [anyone|plyr,"lord_ask_to_collect_debt_2", [],  "Then I will not press the matter any further.", "lord_pretalk",[]],


  [anyone,"convince_accept",[(check_quest_active, "qst_collect_debt"),
                             (quest_slot_eq, "qst_collect_debt", slot_quest_target_troop, "$g_talk_troop"),
                             (quest_get_slot, ":quest_giver_troop", "qst_collect_debt", slot_quest_giver_troop),
                             (str_store_troop_name,s8,":quest_giver_troop"),
                             (quest_get_slot, reg10, "qst_collect_debt", slot_quest_target_amount)],
   "My debt to {s8} has long been overdue, and I was always troubled by it. Thank you for taking the money to him. Please give him this purse of {reg10} thaler, and thank him on my behalf.", "close_window",
   [(call_script, "script_troop_add_gold", "trp_player", reg10),
    (quest_set_slot,  "qst_collect_debt", slot_quest_current_state, 1),
    (call_script, "script_succeed_quest", "qst_collect_debt"),
    (assign, "$g_leave_encounter", 1),
    ]],


  [anyone|plyr,"lord_talk",[(check_quest_active,"qst_persuade_lords_to_make_peace"),
                            (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
                            (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
                            (this_or_next|eq, ":quest_target_troop", "$g_talk_troop"),
                            (eq, ":quest_object_troop", "$g_talk_troop"),
                            (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
                            (quest_get_slot, ":quest_object_faction", "qst_persuade_lords_to_make_peace", slot_quest_object_faction),
                            (str_store_faction_name, s12, ":quest_target_faction"),
                            (str_store_faction_name, s13, ":quest_object_faction"),
                            ],
   "It's high time to end this war between {s12} and {s13}, {s64}!", "lord_ask_to_make_peace",
   [(assign, "$g_convince_quest", "qst_persuade_lords_to_make_peace")]],

  [anyone,"lord_ask_to_make_peace", [], "Eh? I'm not sure I heard you right, {playername}. War is never easily forgotten by either side, and I myself have a very long memory. Why should I take any interest in brokering a peace with those dogs?", "lord_ask_to_make_peace_2",[]],

  [anyone|plyr,"lord_ask_to_make_peace_2", [],  "Perhaps I might persuade you...", "convince_begin",[]],
  [anyone|plyr,"lord_ask_to_make_peace_2", [],  "Never mind, no one seems interested in peace at present.", "lord_pretalk",[]],

  [anyone,"convince_accept",[(check_quest_active, "qst_persuade_lords_to_make_peace"),
                             (this_or_next|quest_slot_eq, "qst_persuade_lords_to_make_peace", slot_quest_target_troop, "$g_talk_troop"),
                             (quest_slot_eq, "qst_persuade_lords_to_make_peace", slot_quest_object_troop, "$g_talk_troop"),
                             (quest_get_slot, ":quest_object_faction", "qst_persuade_lords_to_make_peace", slot_quest_object_faction),
                             (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
                             (str_store_faction_name, s12, ":quest_object_faction"),
                             (str_store_faction_name, s13, ":quest_target_faction"),
                             (try_begin), # store name of other faction
                               (eq,":quest_object_faction","$g_talk_troop_faction"),
                               (str_store_faction_name, s14, ":quest_target_faction"),
                               (else_try),
                               (str_store_faction_name, s14, ":quest_object_faction"),
                             (try_end),
                             ],
   "You... Yes, {playername}, I see the truth in what you say. Very well then, you have my blessing to bring an offer of peace to {s14}. I cannot guarantee they will accept it, but if they do, then I shall stand by it.", "close_window",
   [(store_mul, ":new_value", "$g_talk_troop", -1),
    (try_begin),
      (quest_slot_eq, "qst_persuade_lords_to_make_peace", slot_quest_target_troop, "$g_talk_troop"),
      (quest_set_slot, "qst_persuade_lords_to_make_peace", slot_quest_target_troop, ":new_value"),
    (else_try),
      (quest_set_slot, "qst_persuade_lords_to_make_peace", slot_quest_object_troop, ":new_value"),
    (try_end),
    (quest_set_slot, "qst_persuade_lords_to_make_peace", slot_quest_convince_value, 1500),#reseting convince value for the second persuasion
    (assign, "$g_leave_encounter", 1),
    (neg|quest_slot_ge, "qst_persuade_lords_to_make_peace", slot_quest_target_troop, 0),
    (neg|quest_slot_ge, "qst_persuade_lords_to_make_peace", slot_quest_object_troop, 0),
    (call_script, "script_succeed_quest", "qst_persuade_lords_to_make_peace"),
    ]],

	[anyone|plyr,"lord_talk", [
	#code OiM check quest active
			(check_quest_active,"qst_oim_potop_deliver_swedish_solders"),
			(neg|check_quest_succeeded,"qst_oim_potop_deliver_swedish_solders"),
			(neg|check_quest_failed,"qst_oim_potop_deliver_swedish_solders"),
			(neg|check_quest_finished,"qst_oim_potop_deliver_swedish_solders"),
			(quest_slot_eq, "qst_oim_potop_deliver_swedish_solders", slot_quest_current_state, 0),
			(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
			(eq, "$g_swedish_prisoner_finished", 0), 
	],  "I want to talk about the Swedes...", "potop_deliver_swedish_troops",[]],

	[anyone|plyr,"lord_talk", [
			(check_quest_active,"qst_oim_potop_defend_church"),
			(check_quest_succeeded,"qst_oim_potop_defend_church"),
			(neg|check_quest_failed,"qst_oim_potop_defend_church"),
			(neg|check_quest_finished,"qst_oim_potop_defend_church"),
			(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
	],  "I want to talk about the monastery...", "potop_defend_monastery_done",[]],

	
	[anyone|plyr,"lord_talk", [
			(check_quest_active,"qst_oim_potop_defend_church"),
			(check_quest_failed,"qst_oim_potop_defend_church"),
			(neg|check_quest_finished,"qst_oim_potop_defend_church"),
			(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
	],  "I want to talk about the monastery...", "potop_defend_monastery_done_failed",[]],

	
	[anyone|plyr,"lord_talk", [
	#code OiM check quest active
			(check_quest_active,"qst_oim_potop_deliver_swedish_troops_reward"),
			(neg|check_quest_succeeded, "qst_oim_potop_deliver_swedish_troops_reward"),
			(neg|check_quest_failed,"qst_oim_potop_deliver_swedish_troops_reward"),
			(quest_slot_ge, "qst_oim_potop_deliver_swedish_troops_reward", slot_quest_current_state, 0),
			(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
			(eq, "$g_swedish_prisoner_finished", 0), 
	],  "I want to talk about the captive Swede...", "potop_deliver_swedish_troops_reward",[]],

	
	[anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_knight_2_7"), 
		(check_quest_active,"qst_oim_lendliz"),
		(neg|check_quest_finished,"qst_oim_lendliz"),
		(quest_slot_eq, "qst_oim_lendliz", slot_quest_current_state, 1), 
	], "Here be the goods that the Tsar of Moscow gave you.", "oim_lendliz_talk_to_naum",[]],
	

##
##
##  [anyone|plyr,"lord_talk",[(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                            (check_quest_active,"qst_bring_reinforcements_to_siege"),
##                             (quest_get_slot, ":quest_target_troop", "qst_bring_reinforcements_to_siege", slot_quest_target_troop),
##                             (eq,"$g_talk_troop",":quest_target_troop"),
##                             (quest_get_slot, ":quest_giver_troop", "qst_bring_reinforcements_to_siege", slot_quest_giver_troop),
##                             (quest_get_slot, ":quest_target_amount", "qst_bring_reinforcements_to_siege", slot_quest_target_amount),
##                             (quest_get_slot, ":quest_object_troop", "qst_bring_reinforcements_to_siege", slot_quest_object_troop),
##                             (party_count_companions_of_type, ":num_companions", "p_main_party", ":quest_object_troop"),
##                             (ge, ":num_companions", ":quest_target_amount"),
##                             (str_store_troop_name,1,":quest_giver_troop"),
##                             (assign, reg1, ":quest_target_amount"),
##                             (str_store_troop_name,2,":quest_object_troop")],
##   "Sir, {s1} ordered me to bring {reg1} {s2} to reinforce your siege.", "lord_reinforcement_brought",
##   [(quest_get_slot, ":quest_target_amount", "qst_bring_reinforcements_to_siege", slot_quest_target_amount),
##    (quest_get_slot, ":quest_target_party", "qst_bring_reinforcements_to_siege", slot_quest_target_party),
##    (quest_get_slot, ":quest_object_troop", "qst_bring_reinforcements_to_siege", slot_quest_object_troop),
##    (party_remove_members, "p_main_party", ":quest_object_troop", ":quest_target_amount"),
##    (party_add_members, ":quest_target_party", ":quest_object_troop", ":quest_target_amount"),
##    (call_script, "script_finish_quest", "qst_bring_reinforcements_to_siege", 100),
##    ]],
##
##  [anyone|plyr,"lord_talk",[(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                            (check_quest_active,"qst_bring_reinforcements_to_siege"),
##                             (quest_get_slot, ":quest_target_troop", "qst_bring_reinforcements_to_siege", slot_quest_target_troop),
##                             (eq,"$g_talk_troop",":quest_target_troop"),
##                             (quest_get_slot, ":quest_giver_troop", "qst_bring_reinforcements_to_siege", slot_quest_giver_troop),
##                             (quest_get_slot, ":quest_target_amount", "qst_bring_reinforcements_to_siege", slot_quest_target_amount),
##                             (quest_get_slot, ":quest_object_troop", "qst_bring_reinforcements_to_siege", slot_quest_object_troop),
##                             (party_count_companions_of_type, ":num_companions", "p_main_party", ":quest_object_troop"),
##                             (lt, ":num_companions", ":quest_target_amount"),
##                             (gt, ":num_companions", 0),
##                             (str_store_troop_name,1,":quest_giver_troop"),
##                             (assign, reg1, ":quest_target_amount"),
##                             (str_store_troop_name,2,":quest_object_troop")],
##   "Sir, {s1} ordered me to bring {reg1} {s2} as a reinforcement to your siege, but unfortunately I lost some of them during my expedition.", "lord_reinforcement_brought_some",
##   [(quest_get_slot, ":quest_target_amount", "qst_bring_reinforcements_to_siege", slot_quest_target_amount),
##    (quest_get_slot, ":quest_target_party", "qst_bring_reinforcements_to_siege", slot_quest_target_party),
##    (quest_get_slot, ":quest_object_troop", "qst_bring_reinforcements_to_siege", slot_quest_object_troop),
##    (party_count_companions_of_type, ":num_companions", "p_main_party", ":quest_object_troop"),
##    (party_remove_members, "p_main_party", ":quest_object_troop", ":num_companions"),
##    (party_add_members, ":quest_target_party", ":quest_object_troop", ":num_companions"),
##    (assign, ":percentage_completed", 100),
##    (val_mul, ":percentage_completed", ":num_companions"),
##    (val_div, ":percentage_completed", ":quest_target_amount"),
##    (call_script, "script_finish_quest", "qst_bring_reinforcements_to_siege", ":percentage_completed"),
##     ]],
##
##  [anyone,"lord_reinforcement_brought", [], "Well done {playername}. These men will no doubt be very useful. I will speak to {s1} of your help.", "lord_pretalk",[]],
##  [anyone,"lord_reinforcement_brought_some", [], "That's not quite good enough {playername}. But I suppose it is better than no reinforcements at all. Whatever, I'll tell {s1} you tried your best.", "lord_pretalk",[]],
##

  [anyone|plyr,"lord_talk",[#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
    (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
    (check_quest_active,"qst_duel_for_lady"),
    (neg|check_quest_concluded,"qst_duel_for_lady"),
    (quest_slot_eq, "qst_duel_for_lady", slot_quest_target_troop, "$g_talk_troop"),
    (quest_get_slot, ":quest_giver_troop", "qst_duel_for_lady", slot_quest_giver_troop),
                            (str_store_troop_name,1,":quest_giver_troop")],
   "I hear word that you have slandered {s1}. You shall take back these foul words, or I'll still your lying tongue!", "lord_challenge_duel_for_lady", []],
   [anyone,"lord_challenge_duel_for_lady", [], "What slander? Everyone knows that whenever her husband is away, she beds her stable boys and anyone else she can lay her hands on. I merely repeat the words of many.", "lord_challenge_duel_for_lady_2",[]],
  [anyone|plyr,"lord_challenge_duel_for_lady_2", [], "You had better stop this filthy gossip, sir, or you shall face my sword!", "lord_challenge_duel_for_lady_3",[]],
  [anyone|plyr,"lord_challenge_duel_for_lady_2", [], "Ahem... I'm not so sure...", "lord_pretalk",[]],
  [anyone,"lord_challenge_duel_for_lady_3", [], "You are challenging me to a duel? How amusing! Very well, as you wish, {playername} -- it will be good sport to bash your head in!", "close_window",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -20),
    (assign, "$g_leave_encounter", 1),
    #(try_begin),
    #  (is_between, "$g_encountered_party", towns_begin, towns_end),
    #  (party_get_slot, ":arena_scene", "$g_encountered_party", slot_town_arena),
    #(else_try),
    #  (assign, ":closest_dist", 100000),
    #  (assign, ":closest_town", -1),
    #  (try_for_range, ":cur_town", towns_begin, towns_end),
    #    (store_distance_to_party_from_party, ":dist", ":cur_town", "p_main_party"),
    #    (lt, ":dist", ":closest_dist"),
    #    (assign, ":closest_dist", ":dist"),
    #    (assign, ":closest_town", ":cur_town"),
    #  (try_end),
    #  (party_get_slot, ":arena_scene", ":closest_town", slot_town_arena),
    #(try_end),
	(assign, ":arena_scene", "scn_oim_arena_scene_generik"),
    (modify_visitors_at_site, ":arena_scene"),
    (reset_visitors),
    (set_visitor, 0, "trp_player"),
    (set_visitor, 1, "$g_talk_troop"),
    (set_jump_mission, "mt_arena_challenge_fight"),
    (jump_to_scene, ":arena_scene"),
    (try_begin),
      (neq, "$talk_context", tc_court_talk),
      (jump_to_menu, "mnu_arena_duel_fight"),
    (try_end),  
   ]],

	
  [anyone|plyr,"lord_talk",[(check_quest_active,"qst_deliver_message"),
                             (quest_get_slot, ":quest_target_troop", "qst_deliver_message", slot_quest_target_troop),
                             (eq,"$g_talk_troop",":quest_target_troop"),
                             (quest_get_slot, ":quest_giver_troop", "qst_deliver_message", slot_quest_giver_troop),
                             (str_store_troop_name,s9,":quest_giver_troop")],
   "I bring a letter from {s9}.", "lord_message_delivered",
   []],

  [anyone,"lord_message_delivered", [], "Oh? Let me see it... Well well well! My gratitude, {playername}. Take my seal as proof that I've received it, and give my regards to {s9} when next you see him.", "lord_pretalk",[
     (call_script, "script_end_quest", "qst_deliver_message"),
     (quest_get_slot, ":quest_giver", "qst_deliver_message", slot_quest_giver_troop),
     (str_store_troop_name,s9,":quest_giver"),
	 (call_script, "script_change_player_relation_with_troop", ":quest_giver", 1),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
   ]],

  [anyone|plyr,"lord_talk",[(check_quest_active,"qst_deliver_message_to_enemy_lord"),
                            (quest_get_slot, ":quest_target_troop", "qst_deliver_message_to_enemy_lord", slot_quest_target_troop),
                            (eq,"$g_talk_troop",":quest_target_troop"),
                            (quest_get_slot, ":quest_giver_troop", "qst_deliver_message_to_enemy_lord", slot_quest_giver_troop),
                            (str_store_troop_name,s9,":quest_giver_troop")],
   "I bring a message from {s9}.", "lord_message_delivered_enemy",
   []],


  [anyone,"lord_message_delivered_enemy", [], "Oh? Let me see that... Hmmm. My gratitude, {playername}. Take my seal as proof that I've received it, with my thanks.", "close_window",[
     (call_script, "script_end_quest", "qst_deliver_message_to_enemy_lord"),
     (quest_get_slot, ":quest_giver", "qst_deliver_message_to_enemy_lord", slot_quest_giver_troop),
     (call_script, "script_change_player_relation_with_troop", ":quest_giver", 3),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
     (assign, "$g_leave_encounter", 1),
     ]],



  [anyone|plyr,"lord_talk", [(check_quest_active,"qst_deliver_message_to_prisoner_lord"),
                             (quest_slot_eq, "qst_deliver_message_to_prisoner_lord", slot_quest_target_troop, "$g_talk_troop"),
                             (quest_get_slot, ":quest_giver_troop", "qst_deliver_message_to_prisoner_lord", slot_quest_giver_troop),
                             (str_store_troop_name, s11, ":quest_giver_troop")],
   "I bring a message from {s11}.", "lord_deliver_message_prisoner",
   [
     #TODO: Add reward
     (call_script, "script_end_quest", "qst_deliver_message_to_prisoner_lord"),
     ]],

  [anyone,"lord_deliver_message_prisoner", [], "Can it be true? Oh, thank you! Thank you, {playername}! You have brought hope and a small ray of light to these bleak walls. Perhaps one day I shall be able to repay you.", "lord_deliver_message_prisoner_2",[]],
  [anyone|plyr,"lord_deliver_message_prisoner_2", [], " 'Twas the least I could do, {s65}.", "lord_deliver_message_prisoner_2a",[]],
  [anyone,"lord_deliver_message_prisoner_2a", [], "You've no idea how grateful I am, {playername}. A thousand thanks and more.", "close_window",[]],
  [anyone|plyr,"lord_deliver_message_prisoner_2", [], "Worry not, {s65}. You'll have ample opportunity to repay me once you are free again.", "lord_deliver_message_prisoner_2b",[]],
  [anyone,"lord_deliver_message_prisoner_2b", [], "Ha ha, of course, {playername}. My eternal thanks go with you.", "close_window",[]],

  [anyone|plyr,"lord_talk", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 1),
                             (troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (check_quest_active,"qst_rescue_lord_by_replace"),
                             (quest_slot_eq, "qst_rescue_lord_by_replace", slot_quest_target_troop, "$g_talk_troop"),
                             (neg|check_quest_succeeded, "qst_rescue_lord_by_replace")],
   "Fear not, I am here to rescue you.", "lord_rescue_by_replace_offer",[]],
  [anyone,"lord_rescue_by_replace_offer", [],
   "By God, are you serious? What is your plan?", "lord_rescue_by_replace_offer_2",[]],
  [anyone|plyr,"lord_rescue_by_replace_offer_2", [],
   "A simple ruse, {s65}. If we exchange garments, I shall take your place here in prison, while you make your escape disguised as myself. Today the guards received a handsome bribe, with which I am sure they already purchased half the wine stocks of the nearest tavern. With some luck they'll soon be so drunk they'd have trouble recognizing their own mothers, let alone telling one of us from the other. And they won't be sober again for quite a while.", "lord_rescue_by_replace_offer_3",[]],
  [anyone,"lord_rescue_by_replace_offer_3", [],
   "Hmm, it just might work... But what of you, my {friend/lady}? The guards won't take kindly to this trickery. What would they do to you when they find out?!", "lord_rescue_by_replace_offer_4",[]],
  [anyone|plyr,"lord_rescue_by_replace_offer_4", [],
   "Not to worry, {s65}. This place is already starting to grow on me.", "lord_rescue_by_replace_offer_5a",[]],
  [anyone|plyr,"lord_rescue_by_replace_offer_4", [],
   "I shall be fine so long as there is an ample reward awaiting me.", "lord_rescue_by_replace_offer_5b",[]],
  [anyone,"lord_rescue_by_replace_offer_5a",[],
   "You are a brave soul indeed. I won't forget this.", "lord_rescue_by_replace_offer_6",[]],
  [anyone,"lord_rescue_by_replace_offer_5b",[],
   "Of course, my {friend/lady}, of course! Come to me when you have regained your freedom, and perhaps I shall be able to repay the debt I owe you.", "lord_rescue_by_replace_offer_6",[]],
  [anyone|plyr,"lord_rescue_by_replace_offer_6",[],
   "Quickly, {s65}, let us change garments. It is past time you were away from here.", "close_window",
   [(call_script, "script_succeed_quest", "qst_rescue_lord_by_replace"),
    (quest_get_slot, ":quest_target_troop", "qst_rescue_lord_by_replace", slot_quest_target_troop),
    (quest_get_slot, ":quest_target_center", "qst_rescue_lord_by_replace", slot_quest_target_center),
    (party_remove_prisoners, ":quest_target_center", ":quest_target_troop", 1),
    #(troop_set_slot, ":quest_target_troop", slot_troop_is_prisoner, 0),
    (troop_set_slot, ":quest_target_troop", slot_troop_prisoner_of_party, -1),
    (assign, "$auto_menu", -1),
    (assign, "$capturer_party", "$g_encountered_party"),
    (jump_to_menu, "mnu_captivity_rescue_lord_taken_prisoner"),
    (finish_mission),
    ]],

##  
##  [anyone|plyr,"lord_talk", [(check_quest_active, "qst_deliver_message_to_lover"),
##                             (troop_get_slot, ":cur_daughter", "$g_talk_troop", slot_troop_daughter),
##                             (quest_slot_eq, "qst_deliver_message_to_lover", slot_quest_target_troop, ":cur_daughter"),
##                             (quest_get_slot, ":troop_no", "qst_deliver_message_to_lover", slot_quest_giver_troop),
##                             (str_store_troop_name, 3, ":troop_no"),
##                             (str_store_troop_name, 4, ":cur_daughter")],
##   "My lord, {s3} asked me to give this letter to your daughter, but I think you should read it first.", "lord_deliver_message_to_lover_tell_father",[]],
##
##  [anyone,"lord_deliver_message_to_lover_tell_father", [],
##   "That swine called {s3} is trying to approach my daughter eh? You have made the right decision by bringing this letter to me. I'll have a long talk with {s4} about it.", "lord_pretalk",
##   [(add_xp_as_reward, 200),
##    (call_script, "script_troop_add_gold", "trp_player", 1000),
##    (quest_get_slot, ":quest_giver", "qst_deliver_message_to_lover", slot_quest_giver_troop),
##    (quest_get_slot, ":target_troop", "qst_deliver_message_to_lover", slot_quest_target_troop),
##    (call_script, "script_change_player_relation_with_troop", ":quest_giver", -20),
##    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
##    (call_script, "script_change_player_relation_with_troop", ":target_troop", -10),
##    (call_script, "script_end_quest", "qst_deliver_message_to_lover"),
##    #Adding betrayal to the quest giver
##    (troop_set_slot, ":quest_giver", slot_troop_last_quest, "qst_deliver_message_to_lover"),
##    (troop_set_slot, ":quest_giver", slot_troop_last_quest_betrayed, 1)]],
##
##
##### TODO: QUESTS COMMENT OUT END



##  [anyone|plyr,"lord_talk", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                             (ge,"$g_talk_troop_faction_relation",0),
##                             (party_slot_eq, "$g_encountered_party", slot_party_type, spt_castle),
##                             (party_slot_eq, "$g_encountered_party", slot_town_lord, "$g_talk_troop"),
##                             (eq, "$g_permitted_to_center",0),
##                             (party_get_num_companions, reg7, "p_main_party"),
##                             (val_sub, reg7, 1),
##                             ],
##   "{reg7?Me and my men:I} need shelter for the night my lord. Can we rest in your castle for a while?", "lord_castle_let_in",[]],
##
##  [anyone, "lord_castle_let_in", [(lt,"$g_talk_troop_relation",-10)],
##   "What? Do I look like I am running an inn here? I have no place here for {reg7?you and your lot:you}. Now get off my lands...", "close_window",[(assign, "$g_permitted_to_center",1)]],
##  [anyone, "lord_castle_let_in", [(lt,"$g_talk_troop_relation",2), (lt, "$g_talk_troop_faction_relation", 10),(assign, reg6, 100)],
##   "I'll give you shelter if you pay a toll of {reg6} denars.", "lord_castle_let_in_toll",[]],
##  [anyone|plyr,"lord_castle_let_in_toll", [(store_troop_gold, ":gold", "trp_player"),(gt,":gold",reg6)], "Of course sir. I'll pay the toll.", "lord_castle_let_in_toll_pay",
##   [(troop_remove_gold, "trp_player",reg6)]],
##  [anyone, "lord_castle_let_in_toll_pay", [(str_store_party_name, s1, "$g_encountered_party")],
##   "Then you are welcome to {s1}.", "close_window",[(assign, "$g_permitted_to_center",1),(jump_to_menu, "mnu_town")]],
##  [anyone|plyr,"lord_castle_let_in_toll", [], "I can't pay that sum sir.", "lord_castle_let_in_toll_nopay",[]],
##  [anyone,"lord_castle_let_in_toll_nopay", [], "Then you are out of luck, I guess.", "lord_pretalk",[]],
##  
##  [anyone, "lord_castle_let_in", [(str_store_party_name, s1, "$g_encountered_party")],
##   "Of course {playername}. You are welcome here. You may rest at {s1} as long as you wish.", "close_window",[(assign, "$g_permitted_to_center",1)]],

  [anyone|plyr,"lord_talk", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
							 (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (eq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
                             (str_store_faction_name, s4, "$g_talk_troop_faction"),],
   "{s66}, I wish to restore my old oath to {s4}.", "lord_ask_pardon_after_oath_renounced",[]],

  [anyone,"lord_ask_pardon_after_oath_renounced",
   [
     (faction_get_slot, ":faction_leader", "$g_talk_troop_faction", slot_faction_leader),
     (neq, ":faction_leader", "$g_talk_troop"),
     (str_store_troop_name, s4, ":faction_leader"),
     ], "That is too great a matter for me to decide, {playername}. You should seek out {s4}. Such clemency is his alone to grant or deny.", "lord_pretalk",[]],

  [anyone,"lord_ask_pardon_after_oath_renounced",
   [
     (assign, ":num_centers_captured_by_player"),
     (try_for_range, ":cur_center", walled_centers_begin, walled_centers_end),
       (store_faction_of_party, ":cur_center_faction", ":cur_center"),
       (eq, ":cur_center_faction", "fac_player_supporters_faction"),
       (party_slot_eq, ":cur_center", slot_center_faction_when_oath_renounced, "$g_talk_troop_faction"),
       (val_add, ":num_centers_captured_by_player", 1),
     (try_end),
     (store_mul, ":peace_score", ":num_centers_captured_by_player", 500),
     (store_current_hours, ":cur_hours"),
     (val_sub, ":cur_hours", "$players_oath_renounced_begin_time"),
     (val_add, ":peace_score", ":cur_hours"),
     (try_begin),
       (gt, ":peace_score", 800),
       #Do not agree to give any centers but agree to make peace
       (assign, ":given_center", -1),
       (try_begin),
         (gt, ":peace_score", 1500),
         (try_begin),
           #Agree to give one center
           (eq, "$players_oath_renounced_given_center", 0),
           (store_random_in_range, ":given_center", 0, ":num_centers_captured_by_player"),
         (try_end),
       (else_try),
         (assign, "$players_oath_renounced_given_center", 0),
       (try_end),
       (assign, ":num_centers_written", 0),
       (try_for_range, ":cur_center", walled_centers_begin, walled_centers_end),
         (store_faction_of_party, ":cur_center_faction", ":cur_center"),
         (eq, ":cur_center_faction", "fac_player_supporters_faction"),
         (party_slot_eq, ":cur_center", slot_center_faction_when_oath_renounced, "$g_talk_troop_faction"),
         (try_begin),
           (eq, ":given_center", 0),
           (assign, "$players_oath_renounced_given_center", ":cur_center"),
         (else_try),
           (neq, "$players_oath_renounced_given_center", ":cur_center"),
           (try_begin),
             (eq, ":num_centers_written", 0),
             (str_store_party_name, s17, ":cur_center"),
           (else_try),
             (eq, ":num_centers_written", 1),
             (str_store_party_name, s16, ":cur_center"),
             (str_store_string, s17, "@{s16} and {s17}"),
           (else_try),
             (str_store_party_name, s16, ":cur_center"),
             (str_store_string, s17, "@{s16}, {s17}"),
           (try_end),
           (val_add, ":num_centers_written", 1),
         (try_end),
         (val_sub, ":given_center", 1),
       (try_end),
       (try_begin),
         (eq, ":num_centers_written", 0),#white peace
         (str_store_string, s11, "@Very well, I will accept you back into my ranks, if you're ready to swear your solemn oath once more."),
         (assign, "$players_oath_renounced_terms_state", 1),
       (else_try),
         (str_store_string, s11, "@A pardon will only be possible if you are willing to cede {s17} to me. Do you agree my terms?"),
         (assign, "$players_oath_renounced_terms_state", 2),
       (try_end),
     (else_try),
       #Do not agree to make peace
       (str_store_string, s11, "@No. There is no chance of peace between us, I am not interested."),
       (assign, "$players_oath_renounced_terms_state", 0),
     (try_end),
     ], "{s11}.", "lord_ask_pardon_terms",[]],


  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 0),
    ],
   "As you like, {s65}. I shall accept your judgment.", "lord_pretalk",[]],
  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 0),
    ],
   "A shame, {s65}. A sad shame.", "lord_pretalk",[]],
  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 0),
    ],
   "Very well, go and die without me.", "lord_pretalk",[]],

  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 1),
    ],
   "Aye, I am ready.", "lord_ask_pardon_after_renounce_peace",[]],

  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 1),
    ],
   "On second thought, no. I do not wish to enter once more into your service.", "lord_ask_pardon_terms_rejected",[]],

  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 2),
    ],
   "Aye, I agree to the terms.", "lord_ask_pardon_after_renounce_peace",[]],

  [anyone|plyr,"lord_ask_pardon_terms",
   [(eq, "$players_oath_renounced_terms_state", 2),
    ],
   "The price is too high, {s65}. I must decline.", "lord_ask_pardon_terms_rejected",[]],


  [anyone,"lord_ask_pardon_after_renounce_peace",
   [], "Excellent. Though you have strayed from us, {playername}, it gladdens our hearts that you have found your way back to the right path. I hereby restore your homage to me. Rise once more as an honored warrior in my service.", "lord_pretalk",
   [
     (try_for_range, ":cur_center", walled_centers_begin, walled_centers_end),
       (store_faction_of_party, ":cur_center_faction", ":cur_center"),
       (eq, ":cur_center_faction", "fac_player_supporters_faction"),
       (party_slot_eq, ":cur_center", slot_center_faction_when_oath_renounced, "$g_talk_troop_faction"),
       (neq, ":cur_center", "$players_oath_renounced_given_center"),
       (call_script, "script_give_center_to_faction", ":cur_center", "$g_talk_troop_faction"),
     (try_end),

     (call_script, "script_player_join_faction", "$g_talk_troop_faction"),
     (assign, "$player_has_homage", 1),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 3),
     ]],


  [anyone,"lord_ask_pardon_terms_rejected",
   [], "Then get out of my sight, you foul breed! Begone with you, and do not return!", "close_window",
   [
     (assign, "$g_leave_encounter", 1),
     #TODO: Add relation drop. $players_oath_renounced_begin_time can also be reset to current time for worse conditions in the next conversation.
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -5),
     ]],


  [anyone|plyr,"lord_talk", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (lt, "$g_talk_troop_faction_relation", 0),
                             (this_or_next|eq, "$players_kingdom", 0),
								(eq, "$players_kingdom", "fac_player_supporters_faction"),
                             (neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
                             (assign, ":continue", 1),
                             (try_begin),
                               (gt, "$supported_pretender", 0),
                               (eq, "$supported_pretender_old_faction", "$g_talk_troop_faction"),
                               (assign, ":continue", 0),
                             (try_end),
                             (eq, ":continue", 1),
                             (str_store_faction_name, s4, "$g_talk_troop_faction"),],
   "I wish to make peace with {s4}.", "lord_ask_pardon",[]],
  [anyone,"lord_ask_pardon", [(lt, "$g_talk_troop_relation", -10)], "Do you indeed, {playername}? Then fall upon your sword and give us all a bit of peace.", "lord_pretalk",[]],
  [anyone,"lord_ask_pardon",
   [
     (assign, ":has_center", 0),
	 (eq, 1, 0),
     (try_for_range, ":cur_center", centers_begin, centers_end),
       (store_faction_of_party, ":cur_center_faction", ":cur_center"),
       (eq, ":cur_center_faction", "fac_player_supporters_faction"),
       (assign, ":has_center", 1),
     (try_end),
     (eq, ":has_center", 1),
    ], "{playername}, you are a {noble/noble} without a master, holding lands in your name, but with allegiance to no kingdom. So long as this continues, no regent would accept a lasting peace with you.", "lord_pretalk",[]],
  [anyone,"lord_ask_pardon", [(store_sub, ":hostility", 4, "$g_talk_troop_faction_relation"),
    (val_mul, ":hostility", ":hostility"), #square it
                                  (store_mul, reg16, ":hostility", 15),
    (str_store_faction_name, s4, "$g_talk_troop_faction"),
      ], "Hmm. I could use my considerable influence to arrange a pardon for you, {playername}, but your enemies shall not be satisfied unless you pay tribute. All in all, you would need to bring no less than {reg16} thaler, if you would hope to find friends in {s4}.", "lord_ask_pardon_2",[]],

  [anyone|plyr,"lord_ask_pardon_2", [(store_troop_gold, ":gold","trp_player"),(ge, ":gold", reg16)], "I have the money here. {reg16} thaler.", "lord_ask_pardon_tribue_accept",[]],
  [anyone|plyr,"lord_ask_pardon_2", [], "I fear I cannot pay so much.", "lord_ask_pardon_tribue_deny",[]],

  [anyone,"lord_ask_pardon_tribue_accept", [], "Excellent, {playername}. I shall use this coin to smooth the feathers of those who might oppose your pardon, and I'm sure word will soon spread that you are no longer an enemy of {s4}.", "close_window",
   [
     (troop_remove_gold, "trp_player", reg16),
     (try_begin),
       (eq, "$players_kingdom", 0),
       (call_script, "script_set_player_relation_with_faction", "$g_talk_troop_faction", 0),
     (else_try),
       (call_script, "script_diplomacy_start_peace_between_kingdoms", "$g_talk_troop_faction", "$players_kingdom", 1),
     (try_end),
     (assign,"$g_leave_town_outside",1),
     (assign, "$g_leave_encounter", 1),
     ]],

  [anyone,"lord_ask_pardon_tribue_deny", [], "Then there's nothing I can do for you, {playername}. No silver, no pardon.", "lord_pretalk",[]],


  [anyone|plyr,"lord_talk", [(store_partner_quest,":lords_quest"),
                             (ge,":lords_quest",0),
                             ],
   "About that task you assigned me...", "lord_active_mission_1",[]],


  [anyone|plyr,"lord_talk", [(faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader, "$g_talk_troop"),
                             (eq, "$players_kingdom", "$g_talk_troop_faction"),
                             (eq, "$player_has_homage", 0),
                             (gt, "$mercenary_service_accumulated_pay", 0),
  ],
   "{Sir/Madam}, I humbly request the weekly payment for my service.", "lord_pay_mercenary",[]],
   
  [anyone,"lord_pay_mercenary", [(assign, reg8, "$mercenary_service_accumulated_pay")],
   "Hmm, let me see... According to my chancellery report, you are entitled to {reg8} thaler for your work. Here you are.", "lord_pay_mercenary_2",
   [(troop_add_gold, "trp_player", "$mercenary_service_accumulated_pay"),
    (assign, "$mercenary_service_accumulated_pay", 0)]],
   
  [anyone|plyr,"lord_pay_mercenary_2", [], "Thank you, {sir/madam}.", "lord_pretalk", []],

  [anyone|plyr,"lord_talk", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (ge, "$g_talk_troop_faction_relation", 0),
                             (store_partner_quest,":lords_quest"),
                             (lt,":lords_quest",0),
							 #                             (eq,"$g_talk_troop_faction","$players_kingdom")
                             ],
   "Do you have any tasks for me?", "lord_request_mission_ask",[]],

   
   

  [anyone|plyr,"lord_talk", [(le,"$talk_context", tc_party_encounter),
                             (ge, "$g_talk_troop_faction_relation", 0),
                             #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
							 (neq, "$g_main_quest_active", 1),
                             (neq, "$players_kingdom", "$g_talk_troop_faction"),
                             (store_partner_quest, ":lords_quest"),
                             (neq, ":lords_quest", "qst_join_faction"),
                            ],
   "{s66}, I have come to offer you my service!", "lord_ask_enter_service",[]],


  [anyone|plyr,"lord_talk", [(le,"$talk_context", tc_party_encounter),
                             (faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
                             (eq, "$players_kingdom", "$g_talk_troop_faction"),
                             (eq, "$player_has_homage", 0),
                             (store_partner_quest, ":lords_quest"),
                             (neq, ":lords_quest", "qst_join_faction"),
							 (neq, "$g_main_quest_active", 1),
                            ],
   "I wish to swear an oath of fealty and fight for your cause, {s66}.", "lord_ask_enter_service",[]],

  [anyone|plyr,"lord_talk", [(le,"$talk_context", tc_party_encounter),
                             (ge, "$g_talk_troop_faction_relation", 0),
                             #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             (faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
                             (eq, "$players_kingdom", "$g_talk_troop_faction"),
                             (eq, "$player_has_homage", 1),
							 (assign, ":flag", 0),
							 (try_begin), 
								(check_quest_active, "qst_oim_potop_main"), 
								(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
								(assign, ":flag", 1),
							 (end_try),
							 (try_begin), 
								(check_quest_active, "qst_oim_potop_main"), 
								(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
								(assign, ":flag", 1),
							 (end_try),
							 (try_begin), 
								(check_quest_active, "qst_oim_getman_main"), 
								(eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
								(assign, ":flag", 1),
							 (end_try),
							 (eq, ":flag", 0),
                            ],
   "I wish to be released from my oath to you, {s66}.", "lord_ask_leave_service",[]],

   #oim code
  [anyone|plyr,"lord_talk", [(check_quest_active, "qst_oim_potop_return"), 
							 (quest_slot_eq, "qst_oim_potop_return", slot_quest_current_state, 1), 
							 (eq, "$g_talk_troop", "trp_kingdom_3_pretender"),
                            ],
   "I wish to leave your service.", "oim_mehmet_ask_leave_service",[]],
   #oim code end   
   

##  [anyone|plyr,"lord_talk", [(le,"$talk_context", tc_party_encounter),
##                             (ge, "$g_talk_troop_faction_relation", 0),
##                             (troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                             (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
##                             (eq, "$players_kingdom", 0),
##                             (eq,1,0)],
##   "TODO2:I want to fight alongside you against your enemies.", "close_window",[]],

  [anyone|plyr,"lord_talk", [(eq, 1, 0),(le,"$talk_context", tc_party_encounter),(ge, "$g_talk_troop_faction_relation", 0)],
   "I have an offer for you.", "lord_talk_preoffer",[]],

  [anyone|plyr,"lord_talk", [
	#(is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"), 
	(eq, "$g_talk_troop_faction", "fac_kingdom_1"),
	(neq, "$g_talk_troop", "trp_kingdom_1_lord"),
	(check_quest_active,"qst_oim_potop_defend_get_back_warshaw"),
	(neg|check_quest_succeeded,"qst_oim_potop_defend_get_back_warshaw"),
	(neg|check_quest_finished,"qst_oim_potop_defend_get_back_warshaw"),
	(quest_slot_eq, "qst_oim_potop_defend_get_back_warshaw", slot_quest_current_state, 0),
  ],
   "I have a letter from the king...", "oim_potop_follow_me",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_main"),
	(neg|check_quest_finished,"qst_oim_potop_main"),
	(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 8), 
  ],
   "You summoned me, sire?", "oim_potop_start_qst_shtirlic_dlg",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_shtirlic"),
	(neg|check_quest_finished,"qst_oim_potop_shtirlic"),
	(neg|check_quest_succeeded,"qst_oim_potop_shtirlic"),
	(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 0), 
  ],
   "I wish to relieve you of your oath.", "oim_potop_leave_rp",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
	(check_quest_active, "qst_oim_potop_main"),
	(neg|check_quest_finished,"qst_oim_potop_main"),
	(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 10), 
  ],
   "I wish to speak of my oath, Khan.", "oim_potop_soyuznichek",[]],   


  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_3"), 
	(check_quest_active,"qst_oim_potop_return"),
	(neg|check_quest_succeeded,"qst_oim_potop_return"),
	(neg|check_quest_finished,"qst_oim_potop_return"),
	(neg|check_quest_active,"qst_oim_potop_kshetuskiy"),
	(check_quest_succeeded,"qst_oim_potop_alias"),
	(check_quest_finished,"qst_oim_potop_alias"),
	(neg|check_quest_succeeded,"qst_oim_potop_kshetuskiy"),
	(neg|check_quest_finished,"qst_oim_potop_kshetuskiy"),
	
	
  ],
   "There is a matter on which we must speak...", "oim_potop_kshetuskiy_start_dlg",[]],   

 
  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_3_pretender"), 
	(check_quest_active,"qst_oim_potop_alias"),
	(check_quest_succeeded,"qst_oim_potop_alias"),
	(neg|check_quest_finished,"qst_oim_potop_alias"),
	(neg|quest_slot_eq, "qst_oim_potop_alias", slot_quest_current_state, 1),
  ],
   "The towns of Muscovy have fallen!", "oim_potop_soyuznichek_finish",[]], 
   
  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active,"qst_oim_potop_alias"),
	(check_quest_succeeded,"qst_oim_potop_alias"),
	(quest_slot_eq, "qst_oim_potop_alias", slot_quest_current_state, 1), 
	(neg|check_quest_finished,"qst_oim_potop_alias"),
  ],
   "The Khan is now our ally!", "oim_potop_soyuznichek_last_dlg",[]], 
   
#new 

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_1"), 
	(check_quest_active,"qst_oim_potop_return"),
	(quest_slot_eq, "qst_oim_potop_return", slot_quest_current_state, 2), 
	(neg|check_quest_succeeded,"qst_oim_potop_return"),
	(neg|check_quest_finished,"qst_oim_potop_return"),
	(check_quest_succeeded,"qst_oim_potop_alias"),
	(check_quest_finished,"qst_oim_potop_alias"),
	(neg|check_quest_finished, "qst_oim_potop_kmitic"),
	(eq, "$g_oim_kmitic_finished", 0), 
  ],
   "There is a matter on which we must speak...", "oim_potop_kmitic_start_dlg",[]], 

#  [anyone|plyr,"lord_talk", [
#	(eq, "$g_talk_troop", "trp_knight_1_1"), 
#	(check_quest_active,"qst_oim_potop_kmitic"),
#	#(quest_slot_eq, "qst_oim_potop_return", slot_quest_current_state, 1), 
#	(quest_slot_eq, "qst_oim_potop_kmitic", slot_quest_current_state, 1), 
#	(neg|check_quest_finished,"qst_oim_potop_kmitic"),
#  ],
#   "Ja po povodu Khovankogo...", "oim_potop_kmitic_last_dlg",[]], 
   
   [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_3"), 
	(check_quest_active,"qst_oim_potop_kshetuskiy"),
	(neg|check_quest_succeeded,"qst_oim_potop_kshetuskiy"),
	(neg|check_quest_finished,"qst_oim_potop_kshetuskiy"),
	(quest_slot_eq, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 10), 
	#(player_has_item, "itm_oim_qst_horse"), 
  ],
   "Take this steed, friend.", "oim_potop_kshetuskiy_last_dlg",[]],   
   
  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_capture_swedish_lord"),
	(neg|check_quest_succeeded,"qst_oim_potop_capture_swedish_lord"),
	(neg|check_quest_finished,"qst_oim_potop_capture_swedish_lord"),
  ],
   "I wish to discuss your assignment.", "oim_potop_capture_lord",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_2"), 
	(check_quest_active,"qst_oim_potop_return"),
	(quest_slot_eq, "qst_oim_potop_return", slot_quest_current_state, 2), 
	(neg|check_quest_succeeded,"qst_oim_potop_return"),
	(neg|check_quest_finished,"qst_oim_potop_return"),
	(neg|check_quest_active,"qst_oim_potop_volodievskiy"),
	(neg|check_quest_succeeded,"qst_oim_potop_volodievskiy"),
	(neg|check_quest_finished,"qst_oim_potop_volodievskiy"),
	
	(check_quest_succeeded,"qst_oim_potop_alias"),
	(check_quest_finished,"qst_oim_potop_alias"),
  ],
   "There is a matter on which we must speak...", "oim_potop_volodievskiy_start_dlg",[]],    
		
 [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_2"), 
	(check_quest_active,"qst_oim_potop_volodievskiy"),
	(quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 2), 
	(neg|check_quest_finished,"qst_oim_potop_volodievskiy"),
	(neq, "$oim_potop_has_letter", 1),
  ],
   "And one more word, Colonel Wolodyjowski...", "oim_potop_volodievskiy_letter_dlg",[]],    
 
 [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_1_2"), 
	(check_quest_active,"qst_oim_potop_volodievskiy"),
	(quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 10), 
	(neg|check_quest_succeeded, "qst_oim_potop_volodievskiy"), 
	(neg|check_quest_finished, "qst_oim_potop_volodievskiy"),
  ],
   "I have brought your bride, Colonel.", "oim_potop_volodievskiy_last_dlg",[]],    

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active,"qst_oim_potop_defend_get_back_warshaw"),
	(check_quest_succeeded,"qst_oim_potop_defend_get_back_warshaw"),
	(neg|check_quest_finished,"qst_oim_potop_defend_get_back_warshaw"),
  ],
   "Warsaw is ours once more!", "oim_potop_end_quest_warshaw",[]],
   

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active,"qst_oim_potop_marshal"),
	(neg|check_quest_succeeded,"qst_oim_potop_marshal"),
	(neg|check_quest_finished,"qst_oim_potop_marshal"),
  ],
   "I am ready for the elections.", "oim_potop_start_elections",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active,"qst_oim_potop_marshal"),
	(check_quest_succeeded,"qst_oim_potop_marshal"),
	(check_quest_active,"qst_oim_potop_marshal_started"),
	(check_quest_succeeded,"qst_oim_potop_marshal_started"),
	(neg|check_quest_finished,"qst_oim_potop_marshal"),
	(neg|check_quest_finished,"qst_oim_potop_marshal_started"),
  ],
   "So, now I am the Hetman of the Crown!", "oim_potop_mission_impossible_start",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_mission_impossible"),
	(check_quest_succeeded, "qst_oim_potop_mission_impossible"), 
	(neg|check_quest_finished,"qst_oim_potop_mission_impossible"),
  ],
   "The cities are united under our rule!", "oim_potop_mission_impossible_last",[]],


   [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_capture_tszar"),
	(check_quest_succeeded, "qst_oim_potop_capture_tszar"), 
	(neg|check_quest_finished,"qst_oim_potop_capture_tszar"),
  ],
   "I want to discuss the captive Tsar of Moscow...", "oim_potop_capture_tzar_last_dlg",[]],

  [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
	(check_quest_active, "qst_oim_potop_zagloba_revoult"),
	(check_quest_succeeded, "qst_oim_potop_zagloba_revoult"), 
	(neg|check_quest_finished,"qst_oim_potop_zagloba_revoult"),
  ],
   "Here, King, feast your eyes on this royal deed...", "oim_potop_universal_delivered",[]],

   [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop", "trp_knight_2_7"), 
	(check_quest_active, "qst_oim_lendliz2"),
	(check_quest_succeeded, "qst_oim_lendliz2"), 
	(neg|check_quest_finished,"qst_oim_lendliz2"),
  ],
   "I would like to talk about the carts...", "oim_lendliz_talk_to_naum2",[]],
   
   [anyone|plyr,"lord_talk", [
	(eq, "$g_talk_troop_faction", "fac_kingdom_1"), 
	(ge, "$g_talk_troop_faction_relation", 10), 
	(eq, "$g_oim_potop_story_suggested", 0), 
	(eq, "$g_main_quest_active", 0), 
  ],
   "Tell me -- what news have we from the Polish Commonwealth?", "oim_potop_intro_to_the_quest",[(assign, "$g_oim_potop_story_suggested", 1),]],   
   
   
	######################################################################
	## OiM Black Getman code
	######################################################################
	
   [anyone|plyr,"lord_talk", [ 
	 (quest_slot_eq, "qst_oim_getman_defend_villages", slot_quest_giver_troop, "$g_talk_troop"), 
	 (check_quest_active, "qst_oim_getman_defend_villages"),
	 (check_quest_succeeded, "qst_oim_getman_defend_villages"), 
	 (neg|check_quest_finished,"qst_oim_getman_defend_villages"),
   ],
   "I have protected the village!", "oim_getman_defend_villages_report",[]],



   
	#(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 10),	 
   [anyone|plyr,"lord_talk", [
 	 (eq, "$g_talk_troop", "trp_kingdom_1_pretender"), 
	 (check_quest_active, "qst_oim_getman_nesviz_grobnica_radzivilov"),
	 (neg|check_quest_succeeded, "qst_oim_getman_nesviz_grobnica_radzivilov"), 
	 (neg|check_quest_finished,"qst_oim_getman_nesviz_grobnica_radzivilov"),
   ],
   "Sir, where would the Radziwill family crypt be?", "oim_getman_nesviz_location_redz",[]],

   [anyone|plyr,"lord_talk", [
 	 (is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"), 
	 (check_quest_active, "qst_oim_getman_nesviz_grobnica_radzivilov"),
	 (gt, "$g_talk_troop_relation", 0),
	 (neg|check_quest_succeeded, "qst_oim_getman_nesviz_grobnica_radzivilov"), 
	 (neg|check_quest_finished,"qst_oim_getman_nesviz_grobnica_radzivilov"),
   ],
   "Sir, do you know where the Radziwill crypt might be?", "oim_getman_nesviz_location_lord",[]],


   [anyone|plyr,"lord_talk", [
 	 (is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
	 (check_quest_active, "qst_oim_getman_voron_translate"),
	 (neg|check_quest_succeeded, "qst_oim_getman_voron_translate"), 
	 (neg|check_quest_finished,"qst_oim_getman_voron_translate"),
	 (quest_slot_eq, "qst_oim_getman_voron_translate", slot_quest_current_state, 0), 
   ],
   "Do you know anyone who is able to read ancient writ? There is a certain book I must read...", "oim_getman_buy_book_pufnutiy_search",[]],

  [anyone|plyr,"lord_talk", [
 	 (is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
	 (check_quest_active, "qst_oim_getman_kozak_legend"),
	 (neg|check_quest_succeeded, "qst_oim_getman_kozak_legend"), 
	 (neg|check_quest_finished,"qst_oim_getman_kozak_legend"),
	 (quest_slot_eq, "qst_oim_getman_kozak_legend", slot_quest_current_state, 0), 
   ],
   "To your health, my friend. Tell me, who among the Cossacks best knows the old legends?", "oim_getman_kozak_legends_init_dlgs",[]],
   
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_za_barabasha"),
	 (neg|check_quest_succeeded, "qst_oim_getman_za_barabasha"), 
	 (neg|check_quest_finished,"qst_oim_getman_za_barabasha"),
	 (quest_slot_ge, "qst_oim_getman_za_barabasha", slot_quest_current_state, 0), 
	 (neg|quest_slot_ge, "qst_oim_getman_za_barabasha", slot_quest_current_state, 10), 
	 (eq, "$g_talk_troop_faction", "fac_kingdom_5"),
	 (neq, "$g_talk_troop", "trp_kingdom_5_lord"),
	 (neq, "$g_talk_troop", "trp_kingdom_5_pretender"),
	 (neg|troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, 1), 	
	 (neg|troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, -1), 	
   ],
   "I want to speak to you of the future of the Cossacks.", "oim_getman_za_barabasha_lords_dlg",[]],

  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_za_barabasha"),
	 (neg|check_quest_succeeded, "qst_oim_getman_za_barabasha"), 
	 (neg|check_quest_finished,"qst_oim_getman_za_barabasha"),
	 (quest_slot_eq, "qst_oim_getman_za_barabasha", slot_quest_current_state, 1), 
	 (eq, "$g_talk_troop", "trp_kingdom_5_lord"),
   ],
   "What do you say about Barabash, Hetman?", "oim_getman_hmel_barabash_story",[]],
   
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_caravan"),
	 (check_quest_succeeded, "qst_oim_getman_caravan"), 
	 (neg|check_quest_finished,"qst_oim_getman_caravan"),
	 (eq, "$g_talk_troop", "trp_kingdom_5_lord"),
   ],
   "You were right about Barabash...", "oim_getman_hmel_letter_captured",[]],

   
   #trp_kingdom_5_lord
   #qst_oim_getman_hmel_casus_beli
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_hmel_casus_beli"),
	 (neg|check_quest_succeeded, "qst_oim_getman_hmel_casus_beli"), 
	 (neg|check_quest_finished,"qst_oim_getman_hmel_casus_beli"),
	 (quest_slot_eq, "qst_oim_getman_hmel_casus_beli", slot_quest_current_state, 0), 
	 (eq, "$g_talk_troop", "trp_kingdom_5_lord"),
   ],
   "You summoned me?", "oim_getman_hmel_casus_beli_dlg",[]],

  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_barabash_casus_beli"),
	 (neg|check_quest_succeeded, "qst_oim_getman_barabash_casus_beli"), 
	 (neg|check_quest_finished,"qst_oim_getman_barabash_casus_beli"),
	 (quest_slot_eq, "qst_oim_getman_barabash_casus_beli", slot_quest_current_state, 0), 
	 (eq, "$g_talk_troop", "trp_kingdom_5_pretender"),
   ],
   "You summoned me?", "oim_getman_barabash_casus_beli_dlg",[]],

   
  #qst_oim_getman_hmel_casus_beli
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_hmel_casus_beli"),
	 (check_quest_succeeded, "qst_oim_getman_hmel_casus_beli"), 
	 (neg|check_quest_finished,"qst_oim_getman_hmel_casus_beli"),
	 (eq, "$g_talk_troop", "trp_kingdom_5_lord"),
   ],
   "Our enemies are defeated!", "oim_getman_hmel_casus_beli_end_dlg",[]],

  #qst_oim_getman_hmel_casus_beli
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_barabash_casus_beli"),
	 (check_quest_succeeded, "qst_oim_getman_barabash_casus_beli"), 
	 (neg|check_quest_finished,"qst_oim_getman_barabash_casus_beli"),
	 (eq, "$g_talk_troop", "trp_kingdom_5_pretender"),
   ],
   "Enemies defeated!", "oim_getman_hmel_casus_beli_end_dlg",[]],   

   
   #qst_oim_getman_korona_vitovta
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_korona_vitovta"),
	 (neg|check_quest_succeeded, "qst_oim_getman_korona_vitovta"), 
	 (neg|check_quest_finished,"qst_oim_getman_korona_vitovta"),
	 (quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 3), 
	 (quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_giver_troop, "$g_talk_troop"), 
   ],
   "The crown has been found!", "oim_getman_hmel_korna_finded",[]],

  

	#qst_oim_getman_korona_vitovta  
  [anyone|plyr,"lord_talk", [
	 (check_quest_active, "qst_oim_getman_korona_vitovta"),
	 (check_quest_succeeded, "qst_oim_getman_korona_vitovta"), 
	 (neg|check_quest_finished,"qst_oim_getman_korona_vitovta"),
	 (quest_slot_eq, "qst_oim_getman_korona_vitovta", slot_quest_giver_troop, "$g_talk_troop"), 
   ],
   "My congratulations, prince.", "oim_getman_hmel_election_end_dlg",[]],
   
	######################################################################
	## OiM Dmitriy code
	######################################################################
   [anyone|plyr,"lord_talk", [
 	   (is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),	
       (eq, "$g_talk_troop_faction", "fac_kingdom_2"),
	   (ge, "$g_talk_troop_faction_relation", 10),
	   (neq, "$g_talk_troop", "trp_kingdom_2_lord"),
	   (neq, "$g_main_quest_active", 1),
	   (neq, "$g_main_quest_active", 2),
	   (neg|check_quest_active, "qst_oim_dmitriy_main"),
	   (neg|check_quest_failed, "qst_oim_dmitriy_main"),
	], "Advise me how to win fame and honor.", "oim_dmitriy_initial_dlg", []],
   
   #
   [anyone|plyr,"lord_talk", [
		(quest_slot_eq, "qst_dmitriy_loot_villages", slot_quest_giver_troop, "$g_talk_troop"),        
		(check_quest_active, "qst_dmitriy_loot_villages"),
		(check_quest_succeeded, "qst_dmitriy_loot_villages"), 
		(neg|check_quest_finished,"qst_dmitriy_loot_villages"),
	], "Everything has been done as you ordered...", "oim_dmitriy_loot_villages_end_dlg",[]],
   
   
   #qst_oim_dmitriy_eleonora
   [anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_kingdom_4_lord"),        
		(check_quest_active, "qst_oim_dmitriy_eleonora"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_eleonora"), 
		(neg|check_quest_finished,"qst_oim_dmitriy_eleonora"),
		(quest_slot_ge, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 1),
	], "I have delivered Eleanor...", "oim_dmitriy_eleonora_delivered_shwed",[]],
   
   [anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_knight_2_17"),        
		(check_quest_active, "qst_oim_dmitriy_eleonora_home"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_eleonora_home"), 
		(neg|check_quest_finished,"qst_oim_dmitriy_eleonora_home"),
	], "I have delivered Eleanor...", "oim_dmitriy_eleonora_delivered_odoevskiy",[]],
   
   
    #qst_oim_dmitriy_deliver_letter_msk
	#qst_oim_dmitriy_deliver_letter_shwed
    [anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_kingdom_2_lord"),        
		(check_quest_active, "qst_oim_dmitriy_deliver_letter_msk"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_deliver_letter_msk"), 
		(neg|check_quest_finished,"qst_oim_dmitriy_deliver_letter_msk"),
	], "I delivered the letter for you...", "oim_dmitriy_leter_delevered_msk",[]],
   
    [anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_kingdom_2_lord"),        
		(check_quest_active, "qst_oim_dmitriy_deliver_letter_shwed"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_deliver_letter_shwed"), 
		(neg|check_quest_finished,"qst_oim_dmitriy_deliver_letter_shwed"),
	], "I delivered the letter for you...", "oim_dmitriy_leter_delevered_shwed",[]],

    [anyone|plyr,"lord_talk", [
		(quest_slot_eq, "qst_oim_alevtina_hanum", slot_quest_target_troop, "$g_talk_troop"),
		(check_quest_active, "qst_oim_alevtina_hanum"),
		(neg|check_quest_succeeded, "qst_oim_alevtina_hanum"), 
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
	], "I am here at the behest of Boyar Nikita Odoyevsky. He greatly wishes that his daughter rejoins him.", "oim_dmitriy_aletina_hanum_murza_dlg",[]],

	#(call_script, "script_succeed_quest", "qst_oim_alevtina_hanum"),
	
    #oim_dmitriy_tsar_elections	
    [anyone|plyr,"lord_talk", [
		#qst_oim_dmitriy_elections
		(eq, "$g_talk_troop_faction", "fac_kingdom_2"),
		(check_quest_active, "qst_oim_dmitriy_elections"),
		(neg|check_quest_succeeded, "qst_oim_dmitriy_elections"), 
		(neg|check_quest_finished,"qst_oim_dmitriy_elections"),
		(troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, 0),
		(neq, "$g_talk_troop", "trp_kingdom_2_pretender"), 
	], "I must speak with you.", "oim_dmitriy_tsar_elections",[]],
	
   	######################################################################
   
   [anyone|plyr,"lord_talk", [(eq, "$g_talk_troop_faction", "fac_player_supporters_faction"),
                             #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             ],
   "I want to give you some troops.", "lord_give_troops",[]],

  [anyone,"lord_give_troops", [],
   "Well, I could use some good soldiers. Thank you.", "lord_pretalk",
   [
     (change_screen_give_members),
     ]],
  
  
  


  [anyone|plyr,"lord_talk",
   [
     (eq, "$g_talk_troop_faction", "$players_kingdom"),
     (this_or_next|faction_slot_eq, "$players_kingdom", slot_faction_marshall, "trp_player"),
	 (             faction_slot_eq, "$players_kingdom", slot_faction_leader, "trp_player"),
     #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
     ],
   "I have a new task for you.", "lord_give_order_ask",[]],

  [anyone,"lord_give_order_ask", [],
   "Yes?", "lord_give_order",[]],




  [anyone|plyr,"lord_give_order", [],
   "Follow me.", "lord_give_order_answer",
   [
     (assign, "$temp", spai_accompanying_army),
     (assign, "$temp_2", "p_main_party"),
     ]],

  [anyone|plyr,"lord_give_order", [],
   "Go to...", "lord_give_order_details_ask",
   [
     (assign, "$temp", spai_holding_center),
     ]],

  [anyone|plyr,"lord_give_order", [],
   "Raid the village of...", "lord_give_order_details_ask",
   [
     (assign, "$temp", spai_raiding_around_center),
     ]],

  [anyone|plyr,"lord_give_order", [],
   "Patrol the area around...", "lord_give_order_details_ask",
   [
     (assign, "$temp", spai_patrolling_around_center),
     ]],

  

  [anyone|plyr,"lord_give_order",
   [
     (neg|troop_slot_eq, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
     ],
   "I won't need you for some time. You are free to do as you like.", "lord_give_order_stop",
   []],

  [anyone|plyr,"lord_give_order", [],
   "Return...", "lord_pretalk",
   []],
  
  [anyone,"lord_give_order_details_ask", [],
   "All right...", "lord_give_order_details",[]],

  [anyone|plyr|repeat_for_parties, "lord_give_order_details",
   [
     (store_repeat_object, ":party_no"),
     (store_faction_of_party, ":party_faction", ":party_no"),
     (store_relation, ":relation", ":party_faction", "$players_kingdom"),
     (assign, ":continue", 0),
     (try_begin),
         (eq, "$temp", spai_holding_center),
       (try_begin),
         (this_or_next|party_slot_eq, ":party_no", slot_party_type, spt_castle),
			(party_slot_eq, ":party_no", slot_party_type, spt_town),
         (eq, ":party_faction", "$players_kingdom"),
         (assign, ":continue", 1),
       (try_end),
     (else_try),
       (eq, "$temp", spai_raiding_around_center),
       (try_begin),
         (party_slot_eq, ":party_no", slot_party_type, spt_village),
         (lt, ":relation", 0),
         (assign, ":continue", 1),
       (try_end),
     (else_try),
       (eq, "$temp", spai_patrolling_around_center),
       (try_begin),
         (eq, ":party_faction", "$players_kingdom"),
         (is_between, ":party_no", centers_begin, centers_end),
         (assign, ":continue", 1),
       (try_end),
     (try_end),
     (eq, ":continue", 1),
     (neq, ":party_no", "$g_encountered_party"),
     (str_store_party_name, s1, ":party_no")],
   "{s1}", "lord_give_order_answer",
   [
    (store_repeat_object, "$temp_2"),
     ]],

  [anyone|plyr, "lord_give_order_details",
   [], "Return...", "lord_pretalk",[]],



  [anyone,"lord_give_order_stop",
   [],
   "All right. I will do that.", "lord_pretalk",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, -1),
    (troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
    (try_begin),
       (gt, ":party_no", 0),
       (call_script, "script_party_set_ai_state", ":party_no", spai_undefined, -1),
       (party_set_slot, ":party_no", slot_party_commander_party, -1),
    (try_end),
     ]],
	 

  [anyone,"lord_give_order_answer",
   [
     (assign, ":continue", 0),
     (try_begin),
       (troop_slot_ge, "$g_talk_troop", slot_troop_readiness_to_follow_orders, 60),
       (assign, ":continue", 1),
     (else_try),
       (troop_slot_ge, "$g_talk_troop", slot_troop_readiness_to_follow_orders, 10),
       (neg|troop_slot_eq, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
       (assign, ":continue", 1),
     (try_end),
     (troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
     (this_or_next|le, ":party_no", 0),
     (eq, ":continue", 0),
     #Meaning that hero does not want to follow player orders for a while.
	],
   "I am sorry. I must attend my own business at the moment.", "lord_pretalk",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, -1),
     ]],
	
  [anyone|auto_proceed,"lord_give_order_answer",
   [],
   ".", "lord_give_order_answer_2",
   [
     (troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
     (call_script, "script_party_set_ai_state", ":party_no", "$temp", "$temp_2"),
	(try_begin),
       (eq, "$temp", spai_accompanying_army),
       (party_set_slot, ":party_no", slot_party_commander_party, "$temp_2"),
     (else_try),
       (party_set_slot, ":party_no", slot_party_commander_party, -1),
	(try_end),   
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, "$temp"),
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, "$temp_2"),
     #Checking if the order is accepted by the ai
     (call_script, "script_recalculate_ai_for_troop", "$g_talk_troop"),
     ]],
	
  [anyone,"lord_give_order_answer_2",
   [
     (troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
     (party_slot_eq, ":party_no", slot_party_ai_state, "$temp"),
     (party_slot_eq, ":party_no", slot_party_ai_object, "$temp_2"),
    (assign, "$g_leave_encounter", 1),
     ],
   "I will do that.", "close_window",
   []],

  [anyone,"lord_give_order_answer_2",
   [
     #Meaning that the AI decision function did not follow the order.
     ],
   "I am sorry, it is not possible for me to do that.", "lord_pretalk",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
     (troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, -1),
     ]],

  [anyone|plyr,"lord_talk",
   [
     (eq, "$g_talk_troop_faction", "$players_kingdom"),
     (faction_slot_eq, "$players_kingdom", slot_faction_marshall, "trp_player"),
     #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
     (faction_slot_eq, "$players_kingdom", slot_faction_ai_state, sfai_default),
     ],
   "I wish to start a new campaign. Let us assemble the army here.", "lord_give_order_call_to_arms_verify",
   []],

  [anyone,"lord_give_order_call_to_arms_verify", [],
   "You wish to summon forces for a new campaign?", "lord_give_order_call_to_arms_verify_2",[]],

  [anyone|plyr,"lord_give_order_call_to_arms_verify_2", [], "Yes. We must gather all our forces, then march on the enemy.", "lord_give_order_call_to_arms",[]],
  [anyone|plyr,"lord_give_order_call_to_arms_verify_2", [], "On second thought, it won't be necessary to summon everyone.", "lord_pretalk",[]],

  [anyone,"lord_give_order_call_to_arms",
   [],
   "Very well, then. I shall send messengers and tell everyone to gather here.", "lord_pretalk",
   [
     (faction_set_slot, "$players_kingdom", slot_faction_ai_state, sfai_gathering_army),
	 (assign, "$g_recalculate_ais", 1),
     ]],

  [anyone|plyr,"lord_talk",
   [
     (eq, "$g_talk_troop_faction", "$players_kingdom"),
     (faction_slot_eq, "$players_kingdom", slot_faction_marshall, "trp_player"),
     #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
     (neg|faction_slot_eq, "$players_kingdom", slot_faction_ai_state, sfai_default),
     ],
   "I wish to end the campaign and allow everyone to return home.", "lord_give_order_disband_army_verify", []],

  [anyone,"lord_give_order_disband_army_verify", [],
   "You want to end the current campaign and release all our troops from duty?", "lord_give_order_disband_army_2",[]],

  [anyone|plyr,"lord_give_order_disband_army_2", [], "Yes. We no longer need all of our forces here.", "lord_give_order_disband_army",[]],
  [anyone|plyr,"lord_give_order_disband_army_2", [], "On second thought, it will be better if we stand together for now.", "lord_pretalk",[]],

  [anyone,"lord_give_order_disband_army",
   [],
   "Very well. I will inform our forces that they are released from duty.", "lord_pretalk",
   [
     (faction_set_slot, "$players_kingdom", slot_faction_ai_state, sfai_default),
     (try_for_range, ":cur_troop", kingdom_heroes_begin, kingdom_heroes_end),
       (troop_get_slot, ":party_no", ":cur_troop", slot_troop_leaded_party),
       (gt, ":party_no", 0),
       (party_slot_eq, ":party_no", slot_party_commander_party, "p_main_party"),
       (call_script, "script_party_set_ai_state", ":party_no", spai_undefined, -1),
       (party_set_slot, ":party_no", slot_party_commander_party, -1),
     (try_end),
     (assign, "$g_recalculate_ais", 1),
     ]],

  [anyone|plyr,"lord_talk", [(ge, "$g_talk_troop_faction_relation", 0)],
   "I wish to ask you something.", "lord_talk_ask_something",[]],

  [anyone|plyr,"lord_talk", [(ge, "$g_talk_troop_faction_relation", 0)], "I would be glad to take upon myself a special mission.", "oim_lord_sp_task",[]],
   
  [anyone,"lord_talk_ask_something", [],
   "What is your business?", "lord_talk_ask_something_2",[]],

  [anyone|plyr,"lord_talk_ask_something_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
  ],
   "I want to know the location of someone.", "lord_talk_ask_location",[]],
   
  [anyone|plyr,"lord_talk_ask_something_2", [],
   "What are you and your men doing here?", "lord_tell_objective",[]],
   
  [anyone|plyr,"lord_talk_ask_something_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
			                                             (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
  ],
   "Tell me of the war.", "lord_talk_ask_about_war",[]],

   #OiM code
   
   #lord_talk_ask_something

   [anyone|plyr,"lord_talk", [
			(check_quest_active,"qst_oim_potop_main"),
			(neg|check_quest_failed,"qst_oim_potop_main"),
			(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 0),
   ],
	"Perhaps you can tell me of a way to help the Polish Commonwealth?", "lord_find_zagloba_dlg",[]],

   [anyone|plyr,"lord_talk", [
			(check_quest_active,"qst_oim_potop_deliver_letter"),
			(neg|check_quest_succeeded,"qst_oim_potop_deliver_letter"),
			(neg|check_quest_finished,"qst_oim_potop_deliver_letter"),
			(quest_slot_eq, "qst_oim_potop_deliver_letter", slot_quest_current_state, 0),
			(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
   ],
	"I bring a letter for you...", "lord_king_delivered_letter_oim",[]],

	#(quest_set_slot, "qst_oim_potop_kmitic", slot_quest_current_state, 0),
	#(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_giver_troop, "$g_talk_troop"), 
	#(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_giver_troop, "$g_talk_troop"), 
    
	[anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
		(eq, "$volodievskiy_supported", 1), 
		(eq, "$kshetuskiy_supported", 1), 
		(eq, "$g_oim_kmitic_finished", 1),
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 11),			
	],
		"Well, we should talk about the reply...", "oim_potop_letter_back_to_the_rp",[]],
	
	[anyone|plyr,"lord_talk", [
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 13),			
		(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
    ],
		"I would like to talk about the elections...", "oim_potop_marshal_elections",[]],

	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_potop_marshal"),
		(neg|check_quest_failed,"qst_oim_potop_marshal"),
		(neg|check_quest_finished,"qst_oim_potop_marshal"),
		(quest_slot_eq, "qst_oim_potop_marshal", slot_quest_current_state, 1),			
		(eq, "$g_talk_troop_faction", "fac_kingdom_1"),
		(neq, "$g_talk_troop", "trp_kingdom_1_lord"), 
		(neg|troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, 1), 
    ],
		"I would like to talk about the elections...", "oim_potop_lord_talk_support_elections",[]],		
	
	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_potop_king_elections_kings_node"),
		(neg|check_quest_failed,"qst_oim_potop_king_elections_kings_node"),
		(neg|check_quest_finished,"qst_oim_potop_king_elections_kings_node"),
		(quest_slot_eq, "qst_oim_potop_king_elections_kings_node", slot_quest_current_state, 0),			
		(eq, "$g_talk_troop", "trp_kingdom_1_lord"), 
    ],
		"Why, that's high treason, Sire!", "oim_potop_zagloba_uprising",[]],		

	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_potop_king_elections_kings_node"),
		(neg|check_quest_failed,"qst_oim_potop_king_elections_kings_node"),
		(neg|check_quest_finished,"qst_oim_potop_king_elections_kings_node"),
		(quest_slot_eq, "qst_oim_potop_king_elections_kings_node", slot_quest_current_state, 1),			
		(neq, "$g_talk_troop", "trp_kingdom_1_lord"), 
		(neq, "$g_talk_troop", "trp_knight_1_1"), 
		(neq, "$g_talk_troop", "trp_knight_1_2"), 
		(neq, "$g_talk_troop", "trp_knight_1_3"), 
		(eq, "$g_talk_troop_faction", "fac_kingdom_1"), 
    ],
		"What do you know of Zagloba's uprising?", "oim_potop_zagloba_uprising_lord_dlg",[]],		
		
		
  	#lord_dlg_king_dismiss
	#qst_oim_potop_dismiss_king
	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_potop_dismiss_king"),
		(neg|check_quest_failed,"qst_oim_potop_dismiss_king"),
		(neg|check_quest_finished,"qst_oim_potop_dismiss_king"),
		#(quest_slot_eq, "qst_oim_potop_dismiss_king", slot_quest_current_state, 1),			
		(neq, "$g_talk_troop", "trp_kingdom_1_lord"), 
		(eq, "$g_talk_troop_faction", "fac_kingdom_1"), 
		(troop_slot_eq, "$g_talk_troop", slot_troop_support_hero, 0), 
    ],
		"I would like to talk about our king...", "lord_dlg_king_dismiss",[]],		
		
		
  ######################################################################################	
  ## OiM Black Getman lords dialogs 	
  ######################################################################################	  
  
  	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_getman_main"),
		(neg|check_quest_failed,"qst_oim_getman_main"),
		(neg|check_quest_finished,"qst_oim_getman_main"),
		(quest_slot_eq, "qst_oim_getman_main", slot_quest_current_state, 0),			
		(is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end), 
    ],
		"What do you know of the Black Mace?", "oim_getman_asking_about_getman",[]],		

	#
  	[anyone|plyr,"lord_talk", [
		#oim_potop_marshal
		(check_quest_active,"qst_oim_getman_kozaks_service"),
		(neg|check_quest_failed,"qst_oim_getman_kozaks_service"),
		(neg|check_quest_finished,"qst_oim_getman_kozaks_service"),
		(quest_slot_eq, "qst_oim_getman_kozaks_service", slot_quest_target_troop, "$g_talk_troop"), 
    ],
		"Word came to me you know the secret of the Black Mace.", "oim_getman_kozaks_service_dlg",[
		(try_begin),
			(quest_slot_eq, "qst_oim_getman_kozaks_service", slot_quest_current_state, 0),			
			(quest_set_slot, "qst_oim_getman_kozaks_service", slot_quest_current_state, 1),			
		(end_try), 
	]],		
  
  
   	[anyone|plyr,"lord_talk", [
		#qst_biyars_specnaz
		(check_quest_active,"qst_biyars_specnaz"),
		(neg|check_quest_failed,"qst_biyars_specnaz"),
		(neg|check_quest_finished,"qst_biyars_specnaz"),
		(quest_slot_eq, "qst_biyars_specnaz", slot_quest_current_state, 0),			
		(eq, "$g_talk_troop", "trp_knight_2_17"), 
		(eq, "$oim_alevtina_qst_given", 0),
    ],
		"Answer me, Boyar -- are you pleased with Tsar Alexei Mikhailovich?", "oim_biyars_specnaz_init_dlg",[(assign, "$oim_alevtina_qst_given", 1),]],		


		
   	[anyone|plyr,"lord_talk", [
		(check_quest_active,"qst_oim_alevtina_hanum"),
		(check_quest_succeeded,"qst_oim_alevtina_hanum"),
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
		(eq, "$g_talk_troop", "trp_knight_2_17"), 
		#qst_oim_alevtina_hanum
		#(eq, "$oim_dmitriy_can_recruit", 0),
    ],
		"I delivered Alevtina, Boyar...", "oim_alevtina_delivered_dlg",[]],		
 
   	[anyone|plyr,"lord_talk", [
		(eq, "$g_talk_troop_faction", "fac_kingdom_2"), 
		(party_slot_eq, "fac_kingdom_2", slot_faction_marshall, "$g_talk_troop"), 
		(party_slot_eq, "fac_kingdom_2", slot_faction_leader, "trp_player"), 
    ],
		"What say you, warlord?", "oim_dmitriy_voevoda_talk",[]],		
	
  
  ######################################################################################
  ## OiM Black Getman end
  ####################################################################################
  [anyone|plyr,"lord_talk_ask_something_2", [],
   "Never mind.", "lord_pretalk",[]],

  [anyone,"lord_talk_ask_location", [],
   "Very well. I cannot promise you answer, but you may ask. Whom do you wish to discuss?", "lord_talk_ask_location_2",[]],


  [anyone|plyr|repeat_for_troops,"lord_talk_ask_location_2", [(store_repeat_object, ":troop_no"),
                                                              (neq, "$g_talk_troop", ":troop_no"),
                                                              (is_between, ":troop_no", heroes_begin, heroes_end),
                                                              (this_or_next|troop_slot_eq, ":troop_no", slot_troop_occupation, slto_kingdom_hero),
																(troop_slot_eq, ":troop_no", slot_troop_occupation, slto_kingdom_lady),
                                                              (store_troop_faction, ":faction_no", ":troop_no"),
                                                              (eq, "$g_encountered_party_faction", ":faction_no"),
                                                              (str_store_troop_name, s1, ":troop_no")],
   "{s1}", "lord_talk_ask_location_3",[(store_repeat_object, "$hero_requested_to_learn_location")]],

  [anyone|plyr,"lord_talk_ask_location_2", [], "Return...", "lord_pretalk",[]],
  
  [anyone,"lord_talk_ask_location_3",
   [
     (call_script, "script_update_troop_location_notes", "$hero_requested_to_learn_location", 1),
     (call_script, "script_get_information_about_troops_position", "$hero_requested_to_learn_location", 0),
     ],
   "{s1}", "lord_pretalk",[]],

  [anyone,"lord_talk_ask_about_war", [],
   "{s12}", "lord_talk_ask_about_war_2",[
                                                                      (assign, ":num_enemies", 0),
                                                                      (try_for_range_backwards, ":cur_faction", kingdoms_begin, kingdoms_end),
                                                                        (faction_slot_eq, ":cur_faction", slot_faction_state, sfs_active),
                                                                        (store_relation, ":cur_relation", ":cur_faction", "$g_talk_troop_faction"),
                                                                        (lt, ":cur_relation", 0),
                                                                        (try_begin),
                                                                          (eq, ":num_enemies", 0),
                                                                          (str_store_faction_name_link, s12, ":cur_faction"),
                                                                        (else_try),
                                                                          (eq, ":num_enemies", 1),
                                                                          (str_store_faction_name_link, s11, ":cur_faction"),
                                                                          (str_store_string, s12, "@{s11} and {s12}"),
                                                                        (else_try),
                                                                          (str_store_faction_name_link, s11, ":cur_faction"),
                                                                          (str_store_string, s12, "@{s11}, {s12}"),
                                                                        (try_end),
                                                                        (val_add, ":num_enemies", 1),
                                                                      (try_end),
                                                                      (try_begin),
                                                                        (eq, ":num_enemies", 0),
                                                                        (str_store_string, s12, "@We are not at war with anyone."),
                                                                      (else_try),
                                                                        (str_store_string, s12, "@We are at war with {s12}."),
                                                                      (try_end),
                                                                      ]],

  [anyone|plyr|repeat_for_factions, "lord_talk_ask_about_war_2", [(store_repeat_object, ":faction_no"),
                                                                  (is_between, ":faction_no", kingdoms_begin, kingdoms_end),
                                                                  (faction_slot_eq, ":faction_no", slot_faction_state, sfs_active),
                                                                     (store_relation, ":cur_relation", ":faction_no", "$g_talk_troop_faction"),
                                                                     (lt, ":cur_relation", 0),
                                                                     (str_store_faction_name, s1, ":faction_no")],
   "Tell me more about the war of {s1}.", "lord_talk_ask_about_war_details",[(store_repeat_object, "$faction_requested_to_learn_more_details_about_the_war_against")]],

  [anyone|plyr,"lord_talk_ask_about_war_2", [], "That's all I wanted to know. Thank you.", "lord_pretalk",[]],

  [anyone,"lord_talk_ask_about_war_details", [],
   "We have {reg5?{reg5}:no} {reg3?armies:army} and they have {reg6?{reg6}:none}. Overall, {s9}.",
   "lord_talk_ask_about_war_2",[(call_script, "script_faction_get_number_of_armies", "$g_encountered_party_faction"),
                                (assign, reg5, reg0),
                                (assign, reg3, 1),
		(try_begin),
                                  (eq, reg5, 1),
                                  (assign, reg3, 0),
		(try_end),
                                (call_script, "script_faction_get_number_of_armies", "$faction_requested_to_learn_more_details_about_the_war_against"),
                                (assign, reg6, reg0),
                                (assign, reg4, 1),
		(try_begin),
                                  (eq, reg6, 1),
                                  (assign, reg4, 0),
        (try_end),
                                (store_div, ":our_str", reg5, 2),
                                (store_div, ":enemy_str", reg6, 2),
                                (store_sub, ":advantage", ":our_str", ":enemy_str"),
                                (val_clamp, ":advantage", -4, 5),
                                (val_add, ":advantage", 4),
                                (store_add, ":adv_str", "str_war_report_minus_4", ":advantage"),
                                (str_store_string, s9, ":adv_str"),
		]],


		
  [anyone|plyr,"lord_talk", [ (eq,"$talk_context",tc_party_encounter),
							  (store_faction_of_party, ":p_faction_temp","$g_encountered_party"),
							  (store_relation, "$g_encountered_party_relation", ":p_faction_temp", "fac_player_faction"),
                              (lt, "$g_encountered_party_relation", 0),
                              (str_store_troop_name,s4,"$g_talk_troop")],
   "I shall say this only once, {s4}! Surrender or die!", "party_encounter_lord_hostile_ultimatum_surrender", []],
  [anyone,"party_encounter_lord_hostile_ultimatum_surrender", [],
   "{s43}", "close_window", [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_challenged_default"),
       (call_script, "script_make_kingdom_hostile_to_player", "$g_encountered_party_faction", -3),	   

       (store_relation, "$g_encountered_party_relation", "$g_encountered_party_faction", "fac_player_faction"),	
	   (assign, "$encountered_party_friendly", 0),
  (try_begin),
         (gt, "$g_talk_troop_relation", -10),
         (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
  (try_end),
       (assign,"$encountered_party_hostile",1)]],
  

  [anyone|plyr,"lord_talk", [(eq,"$talk_context", tc_party_encounter),
                             (neq,"$g_encountered_party_faction","$players_kingdom"),
                             (ge, "$g_encountered_party_relation", 0),
                                 ], "I'm here to deliver my demands!", "lord_predemand",[]],
  [anyone,"lord_predemand", [], "Eh? What do you want?", "lord_demand",[]],

  [anyone|plyr,"lord_demand", [(store_faction_of_party, "$g_encountered_party_faction","$g_encountered_party"),
							   (neq,"$g_encountered_party_faction","$players_kingdom"),
                               (ge, "$g_encountered_party_relation", 0),], "Surrender or die!", "lord_ultimatum_surrender",[]],
  
  [anyone,"lord_ultimatum_surrender", [(ge, "$g_encountered_party_relation", 0)], "{s43}", "lord_attack_verify",[#originally, speak you rascal
        (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_unprovoked_attack_default"),
   ]],
	
  [anyone|plyr,"lord_attack_verify", [], "Forgive me sir. I don't know what I was thinking.", "lord_attack_verify_cancel",[]],
  [anyone,"lord_attack_verify_cancel", [], "Be gone, then.", "close_window",[(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),(assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"lord_attack_verify", [], "That is none of your business. Prepare to fight!", "lord_attack_verify_commit",[]],
	
  [anyone,"lord_ultimatum_surrender", [], "{s43}", "lord_attack_verify_b", #originally, you will not survive this
   [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_unnecessary_attack_default"),
    (call_script, "script_make_kingdom_hostile_to_player", "$g_encountered_party_faction", -3),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -5),

    (store_relation, "$g_encountered_party_relation", "$g_encountered_party_faction", "fac_player_faction"),	
	(assign, "$encountered_party_friendly", 0),
   ]],	
	
  [anyone|plyr,"lord_attack_verify_b", [],  "Forgive me sir. I don't know what I was thinking.", "lord_attack_verify_cancel",[]],
  [anyone|plyr,"lord_attack_verify_b", [],   "I shall stand my ground. Prepare to fight!", "lord_attack_verify_commit",[]],

  [anyone,"lord_attack_verify_commit", [], "{s43}", "close_window",
  [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_challenged_default"),
    (call_script, "script_make_kingdom_hostile_to_player", "$g_encountered_party_faction", -3),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -30),

	(store_relation, "$g_encountered_party_relation", "$g_encountered_party_faction", "fac_player_faction"),	
	(assign, "$encountered_party_friendly", 0),
   ]],
#Post 0907 changes end

  [anyone|plyr,"lord_demand", [], "Forgive me. It's nothing.", "lord_pretalk",[]],
    
	
##  [anyone|plyr,"lord_talk", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                             (ge, "$g_talk_troop_faction_relation", 0),
##                             ],
##   "I wish to ask for a favor.", "lord_ask_for_favor_ask",[]],
    
    
	
  [anyone|plyr,"lord_talk", [
                            (faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
                            (troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 0),                      
                            (assign, ":pretender", 0),
                            (try_for_range, ":possible_pretender", pretenders_begin, pretenders_end),
                                (troop_slot_eq, ":possible_pretender", slot_troop_original_faction, "$g_talk_troop_faction"),
                                (assign, ":pretender", ":possible_pretender"),
                            (try_end),
                            (troop_slot_ge, ":pretender", slot_troop_met, 1),
                            (str_store_troop_name, s45, ":pretender"),
                            (troop_get_type, reg3, ":pretender"),
  ],
   "In my travels I met one who calls {reg3?herself:himself} {s45}...", "liege_defends_claim_1",[
   ]],
   
  [anyone,"liege_defends_claim_1", [],
   "Oh really? It is not everyone who dares mention that name in my presence. I am not sure whether to reward your bravery, or punish your impudence.", "liege_defends_claim_2", [
                            (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
   ]],

  [anyone,"liege_defends_claim_2", [],
   "Very well. I shall indulge your curiosity. But listen carefully, for I do not wish to speak of this matter again.", "liege_defends_claim_3", [
   ]],  
  
  [anyone,"liege_defends_claim_3", [],
   "{s48}", "liege_defends_claim_4", [
                     (store_sub, ":rebellion_string", "$g_talk_troop_faction", "fac_kingdom_1"),                                
                     (val_add, ":rebellion_string", "str_swadian_rebellion_monarch_response_1"),
                     (str_store_string, 48, ":rebellion_string"),
   ]],
   
  [anyone,"liege_defends_claim_4", [],
   "{s48}", "lord_talk", [
                     (store_sub, ":rebellion_string", "$g_talk_troop_faction", "fac_kingdom_1"),                                
                     (val_add, ":rebellion_string", "str_swadian_rebellion_monarch_response_2"),
                     (str_store_string, 48, ":rebellion_string"),
   ]],


#Rebellion changes begin
  [anyone|plyr,"lord_talk", [
                             (gt, "$supported_pretender", 0),
                             (eq, "$supported_pretender_old_faction", "$g_talk_troop_faction"),
#                             (is_between, "$players_kingdom", rebel_factions_begin, rebel_factions_end),
#                             (faction_slot_eq, "$players_kingdom", slot_faction_rebellion_target, "$g_talk_troop_faction"),
                             (troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 0),
  (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
                             (troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1),
                             (str_store_troop_name, s12, "$supported_pretender"),
                             (str_store_faction_name, s14, "$supported_pretender_old_faction"),
                             (faction_get_slot, ":old_faction_lord", "$supported_pretender_old_faction", slot_faction_leader),
                             (str_store_troop_name, s15, ":old_faction_lord"),
							 (neq, "$g_talk_troop", "trp_knight_2_17"),
  ],
   "{s12} is the rightful ruler of {s14}. Join our cause against the usurper, {s15}!", "lord_join_rebellion_suggest",[]],
  [anyone|plyr,"lord_talk",
   [
     (eq, "$cheat_mode", 1),
     (gt, "$supported_pretender", 0),
     (eq, "$supported_pretender_old_faction", "$g_talk_troop_faction"),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
     (troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1),
  ],
   "{!}CHEAT: Join our cause by force.", "lord_join_rebellion_suggest_cheat",[]],

  [anyone|plyr,"party_encounter_lord_hostile_attacker_2",
   [
     (eq, "$cheat_mode", 1),
     (gt, "$supported_pretender", 0),
     (eq, "$supported_pretender_old_faction", "$g_talk_troop_faction"),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
     (troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1),
  ],
   "{!}CHEAT: Join our cause by force.", "lord_join_rebellion_suggest_cheat",[]],
   
  [anyone,"lord_join_rebellion_suggest_cheat",
   [], "{!}Cheat: All right.",
   "lord_join_rebellion_ask_for_order",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
     (call_script, "script_change_troop_faction", "$g_talk_troop", "$players_kingdom"),
     (assign, "$g_leave_encounter", 1),
   ]],

  [anyone|plyr,"party_encounter_lord_hostile_attacker_2", [
                             (gt, "$supported_pretender", 0),
                             (eq, "$supported_pretender_old_faction", "$g_talk_troop_faction"),
#                             (is_between, "$players_kingdom", rebel_factions_begin, rebel_factions_end),
#                             (faction_slot_eq, "$players_kingdom", slot_faction_rebellion_target, "$g_talk_troop_faction"),
                             (troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 0),
                             (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
                             (troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1),
                             (str_store_troop_name, s12, "$supported_pretender"),
                             (str_store_faction_name, s14, "$supported_pretender_old_faction"),
                             (faction_get_slot, ":old_faction_lord", "$supported_pretender_old_faction", slot_faction_leader),
                             (str_store_troop_name, s15, ":old_faction_lord"),
  ],
   "{s12} is your rightful ruler. Join our cause against the usurper, {s15}!", "lord_join_rebellion_suggest",[]],
   
   
  [anyone,"lord_join_rebellion_suggest", [
                    (eq,"$talk_context",tc_party_encounter),
                    (encountered_party_is_attacker),
                    (lt, "$g_talk_troop_relation", -5),
      ], "I have no time to bandy words with the likes of you. Defend yourself!",
   "party_encounter_lord_hostile_attacker_2",
   [
        (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
   ]],

  [anyone,"lord_join_rebellion_suggest", [
                (lt, "$g_talk_troop_relation", -10),
      ], "I have no time to bandy words with the likes of you.", "lord_start",
   [
        (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
   ]],

  [anyone,"lord_join_rebellion_suggest",
   [
     (assign, "$g_rebellion_suggest_friends_stronger", 0),
     (call_script, "script_init_ai_calculation"), #recalculating friend and enemy strengths
     (troop_get_slot, ":leaded_party", "$g_talk_troop", slot_troop_leaded_party),
     (gt, ":leaded_party", 0),
     (party_get_slot, ":friend_strength", ":leaded_party", slot_party_nearby_friend_strength),
     (party_get_slot, ":enemy_strength", ":leaded_party", slot_party_nearby_enemy_strength),
     (party_get_slot, ":cached_strength", ":leaded_party", slot_party_cached_strength),
     (val_sub, ":friend_strength", ":cached_strength"),
     (val_add, ":enemy_strength", ":cached_strength"),
     (gt, ":friend_strength", ":enemy_strength"),
     (assign, "$g_rebellion_suggest_friends_stronger", 1),
     (encountered_party_is_attacker),
     ], "{s43}", "party_encounter_lord_hostile_attacker_2", #This is hardly the time or the place for such a discussion.
   [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_talk_later_default"),
   ]],
   
  [anyone,"lord_join_rebellion_suggest",
   [
    (eq, "$g_rebellion_suggest_friends_stronger", 1),
    ], "{s43}", "lord_start",
  [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_talk_later_default"),
   ]],

  [anyone,"lord_join_rebellion_suggest", [
              ], "{s43}", "lord_join_rebellion_suggest_1b",
  [
    
       (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
    
       (faction_get_slot, ":pretender", "$players_kingdom", slot_faction_leader),
       (troop_get_type, reg3, ":pretender"),
       (faction_get_slot, ":current_ruler", "$g_talk_troop_faction", slot_faction_leader),
    
       (str_store_troop_name, 45, ":pretender"),
       (str_store_troop_name, 46, ":current_ruler"),
      
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_dilemma_default"),
       (call_script, "script_find_rival_from_faction", "$g_talk_troop", "$players_kingdom"),
       (assign, "$rival_lord", reg0),
       (assign, "$rebellion_chance", 40),
    
       (assign, "$prior_argument_value", 0),
    
       (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_claim),
       (store_mul, ":prior_claim", reg0, "$player_made_legitimacy_claim"),
       (val_add, "$prior_argument_value", ":prior_claim"),        
     
       (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_ruler),
       (store_mul, ":prior_claim", reg0, "$player_made_ruler_claim"),
       (val_add, "$prior_argument_value", ":prior_claim"),        
   
       (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_victory),
       (store_mul, ":prior_claim", reg0, "$player_made_strength_claim"),
       (val_add, "$prior_argument_value", ":prior_claim"),        
        
       (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_benefit),
       (store_mul, ":prior_claim", reg0, "$player_made_benefit_claim"),
       (val_add, "$prior_argument_value", ":prior_claim"),        
      
       (val_div, "$prior_argument_value", 5),
      
      
      
    ]],
         
  [anyone,"lord_join_rebellion_suggest_1b", [
              ], "{s43}", "lord_join_rebellion_suggest_2",
  [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_dilemma_2_default"),
    
]],

    
        
#Mentions prior arguments
  [anyone,"lord_join_rebellion_suggest_2", [
            (neq, "$prior_argument_value", 0),
      ], "{s47}", "lord_join_rebellion_suggest_2",
  [
	
	(try_begin),
                (gt, "$prior_argument_value", 10),
                (str_store_string, s47, "str_rebellion_prior_argument_very_favorable"),
                (str_store_string, s49, "str_but_comma_3"),
	(else_try),
                (gt, "$prior_argument_value", 0),
                (str_store_string, s47, "str_rebellion_prior_argument_favorable"),
                (str_store_string, s49, "str_but_comma_3"),
	(else_try),
                (is_between, "$prior_argument_value", -10, 0),
                (str_store_string, s47, "str_rebellion_prior_argument_unfavorable"),
                (str_store_string, s49, "str_and_comma_3"),
	(else_try),
                (lt, "$prior_argument_value", -10),
                (str_store_string, s47, "str_rebellion_prior_argument_very_unfavorable"),
                (str_store_string, s49, "str_and_comma_3"),
	(try_end),
	
            (val_add, "$rebellion_chance", "$prior_argument_value"),
	
            (assign, reg6, "$prior_argument_value"), #diagnostic only
            (assign, "$prior_argument_value", 0),
	
            (assign, reg7, "$rebellion_chance"), #diagnostic only
            #(display_message, "@Prior argument effect: {reg6}, rebellion chance: {reg7}"),#diagnostic only
	  
    ]],
	
#Mentions rivals
  [anyone,"lord_join_rebellion_suggest_2", [
            (gt, "$rival_lord", 0),
      ], "{s43}", "lord_join_rebellion_suggest_2",
   [
            (str_store_troop_name, 44, "$rival_lord"),
            (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_rival_default"),

            (assign, "$rival_lord", 0),
	  
            (val_sub, "$rebellion_chance", 30),

            (assign, reg7, "$rebellion_chance"), #diagnostic only
            #(display_message, "@Rebellion chance -30 from rival = {reg7}"),#diagnostic only
			   				
   ]],
								
   
			
  [anyone,"lord_join_rebellion_suggest_2", [
      ], "So tell me. Why should I throw my support behind {s45}?", "lord_join_rebellion_suggest_3",
   [
    ]],
			
  [anyone|plyr,"lord_join_rebellion_suggest_3", [(troop_get_type, reg39, "$g_talk_troop"),
      ], "For the sake of lawful rule -- {s45} has the clearest claim to the throne.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_claim),
        (val_add, "$player_made_legitimacy_claim", 1),
			

        (assign, "$current_argument", argument_claim),
        (assign, "$current_argument_value", reg0),
								
   ]],

  [anyone|plyr,"lord_join_rebellion_suggest_3", [(troop_get_type, reg39, "$g_talk_troop"),
      ], "In the name of justice -- {s45} will treat {reg39?her:his} subjects far better than {s46}.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_ruler),
        (val_add, "$player_made_ruler_claim", 1),
   

        (assign, "$current_argument", argument_ruler),
        (assign, "$current_argument_value", reg0),
    ]],

  [anyone|plyr,"lord_join_rebellion_suggest_3", [(troop_get_type, reg39, "$g_talk_troop"),
      ], "It's the wiser move -- {s45} will win sooner or later, and the sooner it happens, the better it will be for us all.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_victory),
        (val_add, "$player_made_strength_claim", 1),
   

        (assign, "$current_argument", argument_victory),
        (assign, "$current_argument_value", reg0),
  
   ]],

  [anyone|plyr,"lord_join_rebellion_suggest_3", [(troop_get_type, reg39, "$g_talk_troop"),
      ], "Think of yourself -- {s45} will reward {reg39?her:his} followers well.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_benefit),
        (val_add, "$player_made_benefit_claim", 1),
       
   
   
        (assign, "$current_argument", argument_benefit),
        (assign, "$current_argument_value", reg0),
   
   ]],
   
  [anyone|plyr,"lord_join_rebellion_suggest_3", [
      ], "You are a smart man, I think you will see your way to the right choice.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_none),
   
        (assign, "$current_argument", argument_none),
        (assign, "$current_argument_value", 0),
      
   ]],

   
  [anyone|plyr,"lord_join_rebellion_suggest_3", [
      ], "There are many reasons. I shall let you make up your own mind.", "lord_join_rebellion_suggest_4",
   [
        (call_script, "script_rebellion_arguments", "$g_talk_troop", argument_none),
   
        (assign, "$current_argument", argument_none),
        (assign, "$current_argument_value", 0),
   
   ]],


  [anyone|plyr,"lord_join_rebellion_suggest_3", [
      ], "Perhaps you should remain loyal to {s46}.", "lord_join_rebellion_suggest_5",
   [
        (assign, "$rebellion_check", 1),
        (assign, "$rebellion_chance", 0),
   ]],

	#lord_join_rebellion_suggest_3
  [anyone|plyr,"lord_join_rebellion_suggest_3", [
		(eq, "$oim_dmitriy_can_recruit", 1), 
		(eq, "$g_talk_troop_faction", "fac_kingdom_2"),
   ], "Here is a letter from Odoyevsky.", "oim_dmitriy_rebelion_suggest_letter",
   [
   ]],
   
  [anyone|plyr,"lord_join_rebellion_suggest_3", [
		#
		(check_quest_active,"qst_oim_black_lord"),
		(neg|check_quest_succeeded,"qst_oim_black_lord"),
		(neg|check_quest_failed,"qst_oim_black_lord"),
		(neg|check_quest_finished,"qst_oim_black_lord"),

      ], "I am the rightful sovereign of the Muscovite Tsardom!", "oim_dmitriy_rebelion_suggest_samozvanec",
   [
   ]],   
   
   
   

  [anyone,"lord_join_rebellion_suggest_4", [
        (neq, "$current_argument", argument_none),
        (gt, "$current_argument_value", 0),
#Check for inconsistency
        (assign, ":arguments_used", 0),
        (assign, ":most_common_argument", 0),
        (try_begin), 
            (gt, "$player_made_benefit_claim", 0),
            (val_add, ":arguments_used", 1),
            (assign, ":most_common_argument", argument_benefit),
        (try_end),
        (try_begin), 
            (gt, "$player_made_strength_claim", 0),
            (val_add, ":arguments_used", 1),
            (try_begin),
                (gt, "$player_made_strength_claim", "$player_made_benefit_claim"),
                (assign, ":most_common_argument", argument_victory),
            (try_end),
        (try_end),
        (try_begin), 
            (gt, "$player_made_ruler_claim", 0),
            (val_add, ":arguments_used", 1),
            (try_begin),
                (gt, "$player_made_ruler_claim", "$player_made_strength_claim"),
                (gt, "$player_made_ruler_claim", "$player_made_benefit_claim"),
                (assign, ":most_common_argument", argument_ruler),
            (try_end),
        (try_end),
        (try_begin), 
            (gt, "$player_made_benefit_claim", 0),
            (val_add, ":arguments_used", 1),
            (try_begin),
                (gt, "$player_made_legitimacy_claim", "$player_made_ruler_claim"),
                (gt, "$player_made_legitimacy_claim", "$player_made_strength_claim"),
                (gt, "$player_made_legitimacy_claim", "$player_made_benefit_claim"),
                (assign, ":most_common_argument", argument_claim),
            (try_end),
        (try_end),
   
        (neq, "$current_argument", ":most_common_argument"),
        (store_random_in_range, ":consistency", 1, 5),
        (assign, reg10, ":consistency"),
        (assign, reg11, ":arguments_used"),
        #(display_message, "@Consistency check: {reg10}/{reg11}"),
        (lt, ":consistency", ":arguments_used"),

], "Hmm. Do you perhaps tell each man something different, depending on what you think he most wants to hear?", "lord_join_rebellion_suggest_4",
[
        (assign, "$current_argument_value", -5),
]],

   
  [anyone,"lord_join_rebellion_suggest_4", [
   
      ], "Very well. {s51}{s52}{s53}{s54}{s55}", "lord_join_rebellion_suggest_5",
   [
   
        (try_for_range, ":clear", 51, 60),
            (str_clear, ":clear"),
        (try_end),
   
        (try_begin),
            (neq, "$current_argument", argument_none),
            (try_begin),
                (gt, "$current_argument_value", 0),
                (str_store_string, 51, "str_rebellion_argument_favorable"),
            (else_try),
                (eq, "$current_argument_value", 0),
                (str_store_string, 51, "str_rebellion_argument_neutral"),
            (else_try),
                (lt, "$current_argument_value", 0),
                (str_store_string, 51, "str_rebellion_argument_unfavorable"),
            (try_end),
   
            (val_add, "$rebellion_chance", "$current_argument_value"),
   
            (assign, reg6, "$current_argument_value"), #diagnostic only
            (assign, reg7, "$rebellion_chance"), #diagnostic only
            #(display_message, "@Current argument effect: {reg6}, rebellion chance: {reg7}"),#diagnostic only
   
            (store_skill_level, ":persuasion_level", "skl_persuasion", "trp_player"),
            (val_mul, ":persuasion_level", 5), 
            (store_random_in_range, ":persuasion_value", -10, ":persuasion_level"),
   

            (store_add, ":persuasion_plus_argument", ":persuasion_value", "$current_argument_value"),
   
            (str_store_string, 52, "str_and_comma_1"),
	   
       (try_begin),
                (gt, ":persuasion_value", 10),
                (str_store_string, 53, "str_rebellion_persuasion_favorable"), 
                (try_begin),
                    (lt, "$current_argument_value", 0),
                    (str_store_string, 52, "str_but_comma_1"),
       (try_end),
            (else_try),
                (lt, ":persuasion_plus_argument", 0),
                (lt, ":persuasion_value", 0),
                (str_store_string, 53, "str_rebellion_persuasion_unfavorable"), 
	    (try_begin),
                    (ge, "$current_argument_value", 0),
                    (str_store_string, 52, "str_but_comma_1"),
	    (try_end),
            (else_try),
                (str_store_string, 53, "str_rebellion_persuasion_neutral"), 
	    (try_begin),
                    (lt, "$current_argument_value", 0),
                    (str_store_string, 52, "str_but_comma_1"),
                (try_end),
	    (try_end),
	
            (val_add, "$rebellion_chance", ":persuasion_value"),
  
            (assign, reg6, ":persuasion_value"), #diagnostic only
            (assign, reg7, "$rebellion_chance"), #diagnostic only
            #(display_message, "@Persuasion effect: {reg6}, rebellion chance: {reg7}"),#diagnostic only

            (str_store_string, 54, "str_and_comma_2"),
            (try_begin),
                (gt, ":persuasion_plus_argument", 0),
                (lt, "$g_talk_troop_relation", 5),
                (str_store_string, 54, "str_but_comma_2"),
            (else_try),
                (le, ":persuasion_plus_argument", 0),
                (ge, "$g_talk_troop_relation", 5),
                (str_store_string, 54, "str_but_comma_2"),
            (try_end),

        (try_end),

	(try_begin),
            (gt, "$g_talk_troop_relation", 20),
            (str_store_string, 55, "str_rebellion_relation_very_favorable"),
        (else_try),
            (gt, "$g_talk_troop_relation", 5),
            (str_store_string, 55, "str_rebellion_relation_favorable"),
        (else_try),
            (gt, "$g_talk_troop_relation", -5),
            (str_store_string, 55, "str_rebellion_relation_neutral"),
	(else_try),	
            (str_store_string, 55, "str_rebellion_relation_unfavorable"),
	(try_end),

        (val_add, "$rebellion_chance", "$g_talk_troop_relation"),

        (assign, reg6, "$g_talk_troop_relation"), #diagnostic only
        (assign, reg7, "$rebellion_chance"), #diagnostic only
        #(display_message, "@Personal relation effect: {reg6}, rebellion chance: {reg7}"),#diagnostic only


        (store_random_in_range, "$rebellion_check", 0, 100),

        (assign, reg6, "$rebellion_check"), #diagnostic only
        #(display_message, "@Rebellion check: {reg6}"),#diagnostic only


                     ]],



  [anyone,"lord_join_rebellion_suggest_5", [
        (lt, "$rebellion_check", "$rebellion_chance"),
      ], "{s43}", "lord_join_rebellion_ask_for_order",
   [

        (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_agree_default"),

     (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
     (call_script, "script_change_troop_faction", "$g_talk_troop", "$players_kingdom"),
        (troop_get_slot, ":lords_party", "$g_talk_troop", slot_troop_leaded_party),
        (party_set_faction, ":lords_party", "$players_kingdom"),
     (assign, "$g_leave_encounter", 1),
     ]],

  [anyone,"lord_join_rebellion_suggest_5", [
            (encountered_party_is_attacker),
      ], "{s43}", "party_encounter_lord_hostile_attacker_2",
   [
        (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_refuse_default"),

    ]],

  [anyone,"lord_join_rebellion_suggest_5", [
      ], "{s43}", "lord_talk",
   [
        (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_rebellion_refuse_default"),
   
    ]],

  [anyone,"lord_join_rebellion_ask_for_order", [],
   "Very well. So, what is the plan? What is it that you want me to do?", "lord_give_order",
   []],
	

#Rebellion changes end

  [anyone|plyr,"lord_talk", [(eq, "$cheat_mode", 1),
                             #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
    (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                             #(ge, "$g_talk_troop_faction_relation", 10),
  ],
   "{!}CHEAT: I would like to suggest a course of action.", "lord_suggest_action_ask",[]],
   
  [anyone,"lord_tell_objective", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 1),
    (troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
  ],
  "What do you mean? What does it look like I'm doing?! I'm a prisoner here, waiting to be set free!", "lord_pretalk",[]],

  [anyone,"lord_tell_objective", [(troop_slot_eq, "$g_talk_troop", slot_troop_leaded_party, -1)],
  "I am not commanding any men at the moment.", "lord_pretalk",[]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_holding_center),
  (party_get_attached_to, ":cur_center_no", "$g_talk_troop_party"),
  (try_begin),
    (lt, ":cur_center_no", 0),
    (party_get_cur_town, ":cur_center_no", "$g_talk_troop_party"),
  (try_end),
  (is_between, ":cur_center_no", centers_begin, centers_end),
  ],
   "We are resting at {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
    (str_store_party_name, s1, ":ai_object")]],
	
  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_holding_center)],
   "We are travelling to {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
    (str_store_party_name, s1, ":ai_object")]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_recruiting_troops)],
   "We are recruiting new soldiers from {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
    (str_store_party_name, s1, ":ai_object")]],
	
  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_patrolling_around_center)],
   "We are scouting for the enemy around {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                      (str_store_party_name, s1, ":ai_object")]],

#  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_raiding_around_center)],
#   "We ride out to lay waste to village of {s1} to punish the foe for his misdeeds.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
#                                                               (str_store_party_name, s1, ":ai_object")]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_raiding_around_center)],
   "We are laying waste to {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                               (str_store_party_name, s1, ":ai_object")]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_retreating_to_center)],
   "We are retreating to {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                               (str_store_party_name, s1, ":ai_object")]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_besieging_center)],
   "We are besieging {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                               (str_store_party_name, s1, ":ai_object")]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_engaging_army),
                                  (party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                  (party_is_active, ":ai_object"),
                                  ],
   "We are fighting against {s1}.", "lord_pretalk",
   [
     (party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
     (str_store_party_name, s1, ":ai_object")
     ]],

  [anyone,"lord_tell_objective", [(party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_accompanying_army)],
   "We are accompanying {s1}.", "lord_pretalk",[(party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                      (str_store_party_name, s1, ":ai_object")]],


  [anyone,"lord_tell_objective",
   [
     (assign, ":pass", 0),
     (try_begin),
       (party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_undefined),
       (assign, ":pass", 1),
     (else_try),
       (party_slot_eq, "$g_talk_troop_party", slot_party_ai_state, spai_engaging_army),
       (party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
       (neg|party_is_active, ":ai_object"),
       (assign, ":pass", 1),
     (try_end),
     (eq, ":pass", 1),
     ],
   "We are considering our next move.", "lord_pretalk",[]],

  [anyone,"lord_tell_objective", [],
   "I don't know: {reg1} {s1}", "lord_pretalk",[(party_get_slot, reg1, "$g_talk_troop_party", slot_party_ai_state),
                                                (party_get_slot, ":ai_object", "$g_talk_troop_party", slot_party_ai_object),
                                                               (str_store_party_name, s1, ":ai_object")]],

  [anyone|plyr,"lord_talk",
   [
     (eq, "$talk_context", tc_party_encounter),
     (eq, "$g_talk_troop_faction", "$players_kingdom"),
     (party_slot_eq, "$g_encountered_party", slot_party_following_player, 0),
     (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_marshall, "trp_player"),
     ],
   "Will you follow me? I have some ideas...", "lord_ask_follow",[]],

  [anyone,"lord_ask_follow", [(party_get_slot, ":dont_follow_until_time", "$g_encountered_party", slot_party_dont_follow_player_until_time),
                              (store_current_hours, ":cur_time"),
                              (lt, ":cur_time", ":dont_follow_until_time")],
   "I enjoy your company, {playername}, but there are other things I must attend to. Perhaps in a few days I can ride with you once more.", "close_window",
   [(assign, "$g_leave_encounter",1)]],

  [anyone,"lord_ask_follow", [(troop_get_slot, ":troop_renown", "$g_talk_troop", slot_troop_renown),
                              (troop_get_slot, ":player_renown", "trp_player", slot_troop_renown),
                              (val_mul, ":troop_renown", 3),
                              (val_div, ":troop_renown", 4),
                              (lt, ":player_renown", ":troop_renown"),
                              ],
   "That would hardly be proper, {playername}. Why don't you follow me instead?", "close_window",
   [(assign, "$g_leave_encounter",1)]],

  [anyone,"lord_ask_follow", [(lt, "$g_talk_troop_relation", 25)],
   "{s43}", "close_window",
   [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_follow_refusal_default"),
       (assign, "$g_leave_encounter",1)]],
#Post 0907 changes end

  [anyone,"lord_ask_follow", [],
   "Lead the way, {playername}! Let us bring death and destruction to our enemies!", "close_window",
   [(party_set_slot, "$g_talk_troop_party", slot_party_commander_party, "p_main_party"),
    (call_script, "script_party_decide_next_ai_state_under_command", "$g_talk_troop_party"),
    (store_current_hours, ":follow_until_time"),
    (store_add, ":follow_period", 30, "$g_talk_troop_relation"),
    (val_div, ":follow_period", 2),
    (val_add, ":follow_until_time", ":follow_period"),
    (party_set_slot, "$g_encountered_party", slot_party_follow_player_until_time, ":follow_until_time"),
    (party_set_slot, "$g_encountered_party", slot_party_following_player, 1),
    (assign, "$g_leave_encounter",1)]],

  [anyone,"lord_talk_preoffer", [], "Yes?", "lord_talk_offer",[]],

  
##  [anyone|plyr,"lord_talk_offer", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                             (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"), #he is not a faction leader!
##                             (call_script, "script_get_number_of_hero_centers", "$g_talk_troop"),
##                             (eq, reg0, 0), #he has no castles or towns
##                             (hero_can_join),
##                             ],
##   "I need capable men like you. Will you join me?", "knight_offer_join",[
##       ]],

  [anyone|plyr,"lord_talk_offer", [(eq,1,0)],
   "I wish to ransom one of your prisoners.", "knight_offer_join",[
       ]],

  [anyone|plyr,"lord_talk_offer", [], "Return...", "lord_pretalk",[]],

  [anyone ,"knight_offer_join", [(call_script, "script_cf_is_quest_troop", "$g_talk_troop")],
   "I fear I cannot join you at the moment, {playername}. I've important business to attend to, which cannot wait.", "hero_pretalk",[]],

  [anyone ,"knight_offer_join", [(lt, "$g_talk_troop_relation", 5),
                                 (store_character_level,":player_level","trp_player"),
                                 (store_character_level,":talk_troop_level","$g_talk_troop"),
                                 (val_mul,":player_level",2),
                                 (lt, ":player_level", ":talk_troop_level")],
   "You forget your place, {sir/madam}. I do not take orders from the likes of you.", "hero_pretalk",[]],
  
  [anyone ,"knight_offer_join", [
       (assign, ":num_player_companions",0),
       (try_for_range, ":hero_id", heroes_begin, heroes_end),
         (troop_slot_eq, ":hero_id",slot_troop_occupation, slto_player_companion),
         (val_add, ":num_player_companions",1),
       (try_end),
       (assign, reg5, ":num_player_companions"),
       (store_add, reg6, reg5, 1),
       (val_mul, reg6,reg6),
       (val_mul, reg6, 1000),
       (gt, reg6,0)], #note that we abuse the value of reg6 in the next line.
 "I would be glad to fight at your side, my friend, but there is a complication... I find myself in a bit of debt -- a debt that must be repaid very soon. {reg6} thaler altogether, and I am honor-bound to return every coin. Unless you have {reg6} thaler with you, I shall have to focus my efforts on clearing my debt, and my name.", "knight_offer_join_2",[]],
  [anyone ,"knight_offer_join", [(gt,reg6, 100000)], "Join you? I think not.", "close_window",[]],
  [anyone ,"knight_offer_join", [], "Aye, my friend, I'll be happy to join you.", "knight_offer_join_2",[]],

  [anyone|plyr,"knight_offer_join_2", [(gt, reg6,0),(store_troop_gold, ":gold", "trp_player"),(gt,":gold",reg6)],
   "Here, take it, all {reg6} thaler you need. 'Tis only money, after all.", "knight_offer_join_accept",[(troop_remove_gold, "trp_player",reg6)]],
  [anyone|plyr,"knight_offer_join_2", [(le, reg6,0)], "Then let us ride together, my friend.", "knight_offer_join_accept",[]],
   
  [anyone|plyr,"knight_offer_join_2", [(eq, "$talk_context", tc_hero_freed)], "This is good to know. I shall think on it.", "close_window",[]],
  [anyone|plyr,"knight_offer_join_2", [(neq, "$talk_context", tc_hero_freed)], "This is good to know. I shall think on it.", "hero_pretalk",[]],
  
  
  [anyone ,"knight_offer_join_accept", [(troop_slot_ge, "$g_talk_troop", slot_troop_leaded_party, 1)],
   "I've some trusted men in my band who might be of use to you. What do you wish to do with them?", "knight_offer_join_accept_party",[
      ]],
  [anyone ,"knight_offer_join_accept", [], "Ah, certainly, that I would not refuse!", "close_window",[
      (call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
      (assign, "$g_leave_encounter",1)
      ]],
  
  [anyone|plyr,"knight_offer_join_accept_party", [], "You may disband your men. I've no need for more troops.", "knight_join_party_disband",[]],
  [anyone|plyr,"knight_offer_join_accept_party", [(troop_get_slot, ":companions_party","$g_talk_troop", slot_troop_leaded_party),
                                       (party_can_join_party,":companions_party","p_main_party"),
      ], "Your men may join as well. Every able soldier counts.", "knight_join_party_join",[]],
  [anyone|plyr,"knight_offer_join_accept_party", [(is_between,"$g_encountered_party",centers_begin, centers_end)], "Lead your men out of the town. I will catch up with you on the road.", "knight_join_party_lead_out",[]],
  [anyone|plyr,"knight_offer_join_accept_party", [(neg|is_between,"$g_encountered_party",centers_begin, centers_end)],
   "Proceed as you were. I shall catch up with you later.", "knight_join_party_lead_out",[]],


  [anyone ,"knight_join_party_disband", [], "Very well, {playername}. Much as I dislike losing good men, the decision is yours. I shall disband my troops and join you.", "close_window",[
      (call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),

      (troop_get_slot, ":companions_party","$g_talk_troop", slot_troop_leaded_party),
      (party_detach, ":companions_party"),
      (remove_party, ":companions_party"),
      (assign, "$g_leave_encounter",1)
      ]],

  [anyone ,"knight_join_party_join", [], "Excellent. My lads and I shall ride with you.", "close_window",[
      (call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
      (party_remove_members, "p_main_party", "$g_talk_troop", 1),
      
      (troop_get_slot, ":companions_party","$g_talk_troop", slot_troop_leaded_party),
      (assign, "$g_move_heroes", 1),
      (call_script, "script_party_add_party", "p_main_party", ":companions_party"),
      (party_detach, ":companions_party"),
      (remove_party, ":companions_party"),
      (assign, "$g_leave_encounter",1)
      ]],

  [anyone ,"knight_join_party_lead_out", [], "Very well then. I shall maintain a patrol of this area. Return if you have further orders for me.", "close_window",[
      (call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
      (party_remove_members, "p_main_party", "$g_talk_troop", 1),
      
      (troop_get_slot, ":companions_party","$g_talk_troop", slot_troop_leaded_party),
      (party_set_faction, ":companions_party", "fac_player_supporters_faction"),
      (party_detach, ":companions_party"),
      (party_set_ai_behavior, ":companions_party", ai_bhvr_patrol_location),
      (party_set_flags, ":companions_party", pf_default_behavior, 0),
      ]],


  [anyone,"lord_enter_service_reject", [], "What pigswill! And to think I would offer you a place among my nobles. Begone, beggar, before I lose my temper!", "close_window",
   [
     (try_begin),
       (store_partner_quest, ":lords_quest"),
       (eq, ":lords_quest", "qst_join_faction"),
       (call_script, "script_abort_quest", "qst_join_faction", 1),
     (try_end),
     (assign, "$g_invite_faction", 0),
     (assign, "$g_invite_faction_lord", 0),
     (assign, "$g_invite_offered_center", 0),
     (assign, "$g_leave_encounter", 1),
    ]],

  [anyone,"lord_ask_enter_service", [(gt, "$players_kingdom", 0),
                                     (neq, "$players_kingdom", "$g_talk_troop_faction"),
                                     (faction_get_slot, ":players_lord", "$players_kingdom", slot_faction_leader),
                                     (neq, ":players_lord", "trp_player"),
                                     (str_store_troop_name, s5, ":players_lord"),
                                     ], "You are already oath-bound to serve {s5}, are you not?", "lord_give_oath_under_oath_already",[]],
  [anyone|plyr ,"lord_give_oath_under_oath_already", [], "Indeed I am, {s65}. Forgive my rambling.", "lord_pretalk",[]],

  [anyone,"lord_ask_enter_service", [(lt, "$g_talk_troop_relation", -5)], "I accept oaths only from those I can trust to keep them, {playername}.", "lord_pretalk",[]],
  

    [anyone,"lord_ask_enter_service",
   [
     (assign, "$g_invite_offered_center", -1),
     (troop_get_slot, ":renown", "trp_player", slot_troop_renown),
     (store_mul, ":vassal_potential", "$g_talk_troop_relation", 5),
     (val_add, ":vassal_potential", ":renown"),
     (call_script, "script_get_number_of_hero_centers", "trp_player"),
     (assign, ":num_centers_owned", reg0),
     (store_mul, ":center_affect", ":num_centers_owned", 50),
     (val_add, ":vassal_potential", ":center_affect"),
     (ge, ":vassal_potential", 150),
     (try_begin),
       (eq, ":num_centers_owned", 0),
       (call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
       (gt, reg0, 0),
       (assign, "$g_invite_offered_center", reg0),
     (try_end),
     ],
   "You are known as a brave warrior and a fine leader of men, {playername}. I shall be pleased to accept your sword into my service and become your lord, if you are ready to swear homage to me.", "lord_give_oath_1",[]],

  [anyone,"lord_ask_enter_service", [], "You've yet to show yourself a competent commander, {playername}. Take your sword to my enemies and prove to me that you are worthy of my favor. Then we may speak more of this.", "lord_pretalk",[]],

  [anyone|plyr,"lord_give_oath_1", [],  "I am ready, {s65}.", "lord_give_oath_2", []],
  [anyone|plyr,"lord_give_oath_1", [],  "Forgive me, {s65}, I must give the matter further thought first...", "lord_give_oath_give_up", []],

  [anyone,"lord_give_oath_give_up", [],  "What are you playing at, {playername}? Go make up your mind, and stop wasting my time.", "close_window", [(assign, "$g_leave_encounter",1)]],
  [anyone,"lord_give_oath_2", [],  "Good. Then repeat the words of the oath with me: I swear homage to you as lawful ruler of the {s41}.", "lord_give_oath_3", [
            (str_store_faction_name, 41, "$g_talk_troop_faction"),
            (try_begin),
                (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
                (troop_get_slot, ":rebel_faction", "$g_talk_troop", slot_troop_original_faction),
                (str_store_faction_name, 41, ":rebel_faction"),
            (try_end),
      ]],

  [anyone|plyr,"lord_give_oath_3", [],  "I pledge homage to you as lawful ruler of the {s41}.", "lord_give_oath_4", []],
  [anyone|plyr,"lord_give_oath_3", [],  "Excuse me, {reg65?my lady:sir}. But I feel I must think on this further.", "lord_give_oath_give_up", []],

  [anyone,"lord_give_oath_4", [],  "I will remain as your loyal and devoted {man/follower} to my final breath...", "lord_give_oath_5", []],

  [anyone|plyr,"lord_give_oath_5", [],  "I will remain as your loyal and devoted {man/follower} to my final breath...", "lord_give_oath_6", []],
  [anyone|plyr,"lord_give_oath_5", [],  "{reg65?My lady:Sir}, may I ask for some time to consider this further?", "lord_give_oath_give_up", []],

  [anyone,"lord_give_oath_6", [],  "...and I shall stand by your side to fight your enemies, whensoever you should need my sword.", "lord_give_oath_7", []],

  [anyone|plyr,"lord_give_oath_7", [],  "...and I shall stand by your side to fight your enemies, whensoever you should need my sword.", "lord_give_oath_8", []],
  [anyone|plyr,"lord_give_oath_7", [],  "{reg65?My lady:My lord}, please give me more time to think about this.", "lord_give_oath_give_up", []],

  [anyone,"lord_give_oath_8", [],  "And I will uphold your lawful claims, and the claims of your legitimate heirs.", "lord_give_oath_9", []],

  [anyone|plyr,"lord_give_oath_9", [],  "And I will uphold your lawful claims, and the claims of your legitimate heirs.", "lord_give_oath_10", []],
  [anyone|plyr,"lord_give_oath_9", [],  "{reg65?My lady:Sir}, I must have more time to consider this.", "lord_give_oath_give_up", []],

  [anyone,"lord_give_oath_10", [],  "Very well. You have given me your solemn oath, {playername}. May you uphold it always, with honor, courage, and devotion.", "lord_give_oath_go_on_2", []],

  [anyone,"lord_give_oath_go_on_2",
   [
     (assign, reg1, 1),
     (try_begin),
       (le, "$g_invite_offered_center", 0),
       (assign, reg1, 0),
     (else_try),
       (str_store_party_name, s1, "$g_invite_offered_center"),
     (try_end),
     ],
   "Let it be known that from this day forward, you are my subject. I offer you my protection, and grant you the right to bear arms in my name, and I pledge that I shall not deprive you of your life, liberty, or property except by the lawful judgment of your peers or by the law and custom of the land.{reg1? Furthermore I give you the fief of {s1} with all its rents and revenues.:}", "lord_give_oath_go_on_3", []],

  [anyone,"lord_give_oath_go_on_3",
   [
     ],
   "You have done a wise thing, {playername}. Serve me well and by my word, you will rise high.", "lord_give_conclude", []],


  
##  [anyone,"lord_give_oath_go_on_2", [],  "Then let it be know that from now on, you are my sworn {man/follower}.\
## I give you my protection and grant you the right to bear arms in my name.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],
  
#  [anyone,"lord_ask_enter_service", [(lt, "$g_talk_troop_relation", 10),
#                                     (store_character_level, ":player_level", "trp_player"),
#                                     (lt, ":player_level", 10),
#                                     ], "I know not much about you. Keep serving me {playername}. Prove your loyality, then I will know I can trust you and accept your oath.", "lord_pretalk",[]],

##  [anyone,"lord_ask_enter_service", [], "What kind of oath are you willing to make?", "lord_oath_what_kind",[]],
##
##  [anyone|plyr ,"lord_oath_what_kind", [], "I will give you my oath to serve you for two months.", "lord_oath_what_kind_2",[(assign, "$temp", 60)]],
##  [anyone|plyr ,"lord_oath_what_kind", [], "I will give you my oath to serve you for three months.", "lord_oath_what_kind_2",[(assign, "$temp", 90)]],
##  [anyone|plyr ,"lord_oath_what_kind", [], "I will give you my oath to serve you for six months.", "lord_oath_what_kind_2",[(assign, "$temp", 180)]],
##  [anyone|plyr ,"lord_oath_what_kind", [], "I will give you my oath to serve you indefinitely.", "lord_oath_what_kind_2",[(assign, "$temp", 720)]],
##  [anyone|plyr ,"lord_oath_what_kind", [], "Maybe I should give more thought to this, my lord.", "lord_oath_what_kind_cancel",[]],
##  [anyone ,"lord_oath_what_kind_cancel", [], "What nonsense is this? Now go make up your mind and stop wasting my time.", "close_window",[]],
##
##  [anyone, "lord_oath_what_kind_2", [], "Hmmm. Do you ask for anything in return?", "lord_oath_what_do_you_want",[]],
##  
##  [anyone|plyr, "lord_oath_what_do_you_want", [], "I ask for nothing but your blessing, my lord.", "lord_oath_consider",[(assign,"$temp2",0)]],
##  [anyone|plyr, "lord_oath_what_do_you_want", [], "I only ask for the right to have my own banner, my lord.", "lord_oath_consider",[(assign,"$temp2",1)]],
##  [anyone|plyr, "lord_oath_what_do_you_want", [], "I just ask for the right to hold one castle, my lord.", "lord_oath_consider",[(assign,"$temp2",2)]],
##  [anyone|plyr, "lord_oath_what_do_you_want", [], "I ask for the right to hold two castles, my lord.", "lord_oath_consider",[(assign,"$temp2",4)]],
##  [anyone|plyr, "lord_oath_what_do_you_want", [], "I ask for the right to hold three castles, my lord.", "lord_oath_consider",[(assign,"$temp2",6)]],
##  [anyone|plyr ,"lord_oath_what_do_you_want", [], "Maybe I should give more thought to this, my lord.", "lord_oath_what_kind_cancel",[]],
##  
##  [anyone ,"lord_oath_consider", [
##      (store_character_level, ":player_level", "trp_player"),
##      (store_mul, ":benefit", ":player_level", 5),
##      (val_add, ":benefit", "$temp"),
##      (val_add, ":benefit", "$g_talk_troop_relation"),
##      
##      (store_mul, ":cost", "$temp2", 100),
##      (lt, ":cost", ":benefit"),
##      ], "That is agreeable {playername}. Give me your oath now and I will accept you as my follower and offer you my protection.", "lord_give_oath_go_on",[]],
##
##  [anyone ,"lord_oath_consider", [], "Hmmm. What you ask for is not acceptible {playername}.", "close_window",[]],
##
##  [anyone|plyr,"lord_give_oath_go_on", [(eq, "$temp", 60)],  "I give you my oath lord, that I will remain in your service for two months.\
## During this time, I will be faithful to you,\
## I will not act in a way to cause you harm, and I will be at your side to fight your enemies should you need my sword.", "lord_give_oath_go_on_2", []],
##  [anyone|plyr,"lord_give_oath_go_on", [(eq, "$temp", 90)],  "I give you my oath lord, that I will remain in your service for three months.\
## During this time, I will be faithful to you,\
## I will not act in a way to cause you harm, and I will be at your side to fight your enemies should you need my sword.", "lord_give_oath_go_on_2", []],
##  [anyone|plyr,"lord_give_oath_go_on", [(eq, "$temp", 180)],  "I give you my oath lord, that I will remain in your service for six months.\
## During this time, I will be faithful to you,\
## I will not act in a way to cause you harm, and I will be at your side to fight your enemies should you need my sword.", "lord_give_oath_go_on_2", []],
##  [anyone|plyr,"lord_give_oath_go_on", [(gt, "$temp", 700)],  "I give you my oath lord, that I will remain as your loyal and devoted {man/follower} as long as my breath remains.\
## I will never act in a way to cause you harm, and I will be at your side to fight your enemies should you need my sword.", "lord_give_oath_go_on_2", []],
##  
##  [anyone,"lord_give_oath_go_on_2", [(eq,"$temp2",0)],  "Then let it be know that from now on, you are my sworn {man/follower}.\
## I give you my protection and grant you the right to bear arms in my name.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],
##
##  [anyone,"lord_give_oath_go_on_2", [(eq,"$temp2",1)],  "Then let it be know that from now on, you are my sworn {man/follower}.\
## I give you my protection and grant you the right to hold your own banner.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],
##  
##  [anyone,"lord_give_oath_go_on_2", [(eq,"$temp2",2)],  "Then let it be know that from now on, you are my sworn {man/follower} and vassal.\
## I give you my protection and grant you the right to hold a castle.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],
##
##  [anyone,"lord_give_oath_go_on_2", [(eq,"$temp2",4)],  "Then let it be know that from now on, you are my sworn {man/follower} and vassal.\
## I give you my protection and grant you the right to hold two castles.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],
##
##  [anyone,"lord_give_oath_go_on_2", [],  "Then let it be know that from now on, you are my sworn {man/follower} and vassal.\
## I give you my protection and grant you the right to hold three castles.\
## You have done wisely {playername}. Serve me well and I promise, you will rise high.", "lord_give_oath_5", []],

  [anyone|plyr,"lord_give_conclude", [
            (troop_get_type, reg39, "$g_talk_troop"),
      ],  "I thank you, my {reg39?lady:lord}.", "lord_give_conclude_2", [

    (try_begin),
      (is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
#      (faction_set_slot, "$g_talk_troop_faction", slot_faction_marshall, "trp_player"),
      (assign, "$supported_pretender", "$g_talk_troop"),
      (troop_get_slot, "$supported_pretender_old_faction", "$g_talk_troop", slot_troop_original_faction),
      (troop_set_faction, "$g_talk_troop", "fac_player_supporters_faction"),
      (faction_set_slot, "fac_player_supporters_faction", slot_faction_leader, "$g_talk_troop"),
      (assign, "$g_talk_troop_faction", "fac_player_supporters_faction"),

      (quest_set_slot, "qst_rebel_against_kingdom", slot_quest_giver_troop, "$g_talk_troop"),
      (quest_set_slot, "qst_rebel_against_kingdom", slot_quest_target_faction, "$supported_pretender_old_faction"),

      (str_store_faction_name_link, s14, "$supported_pretender_old_faction"),
      (str_store_troop_name_link, s13, "$g_talk_troop"),
      (setup_quest_text,"qst_rebel_against_kingdom"),
      (str_store_string, s2, "@You promised to help {s13} claim the throne of {s14}."),
      (call_script, "script_start_quest", "qst_rebel_against_kingdom", "$g_talk_troop"),
    (try_end),
            
	(try_begin),
      (is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
      (neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
      (store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
      (val_min, ":relation", -40),
      (call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
      (call_script, "script_update_all_notes"),
      (assign, "$g_recalculate_ais", 1),
    (try_end),
    (try_begin),
      (is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
      (neq, "$players_kingdom", "fac_player_supporters_faction"),
      (faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
      (call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
      (call_script, "script_player_leave_faction", 1),
    (try_end),
    (call_script, "script_player_join_faction", "$g_talk_troop_faction"),
    (try_begin),
		(gt, "$g_invite_offered_center", 0),
		(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
      (call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
    (try_end),
    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),

    
    (try_begin),
      (check_quest_active, "qst_join_faction"),
      (eq, "$g_invite_faction_lord", "$g_talk_troop"),
      (call_script, "script_end_quest", "qst_join_faction"),
    (else_try),
      (check_quest_active, "qst_join_faction"),
      (call_script, "script_abort_quest", "qst_join_faction", 0),
    (try_end),
    (assign, "$player_has_homage" ,1),
    (assign, "$g_player_banner_granted", 1),
    (assign, "$g_invite_faction", 0),
    (assign, "$g_invite_faction_lord", 0),
    (assign, "$g_invite_offered_center", 0),
    (assign, "$g_leave_encounter",1)]],

  [anyone,"lord_give_conclude_2", [],  "I have great hopes for you, {playername}, and I know you shall prove yourself worthy of the trust I have placed in you.", "close_window", [(assign, "$g_leave_encounter",1)]],

  

  [anyone,"lord_ask_enter_service", [(str_store_faction_name,5,"$g_talk_troop_faction")], "Ha ha, a wise move, {playername}! With loyal service, a {man/woman} under my charge may become wealthy and powerful, and our enemies... Our enemies shall fall as wheat before the scythe. However, to enter my service you must swear to serve only the {s5}.", "lord_enter_service_swear",[]],
  [anyone|plyr ,"lord_enter_service_swear", [], "I do so swear, {s65}.", "lord_enter_service_swear_accepted",[]],
  [anyone|plyr ,"lord_enter_service_swear", [], "I need some time to think about this.", "lord_enter_service_swear_denied",[]],
  [anyone ,"lord_enter_service_swear_denied", [], "Do you jest? I've no time for games, {playername}. Make up your mind and stop wasting my time.", "close_window",[(assign, "$g_leave_encounter",1)]],

  [anyone ,"lord_enter_service_swear_accepted", [(str_store_faction_name,5,"$g_talk_troop_faction")],
 "Then it is my pleasure to welcome you into the service of my house. From this day forth, {playername}, you are a soldier and defender of the {s5}, with all the duties and privileges this entails.", "lord_enter_service_swear_accepted_2",
   [
   ]],

  [anyone ,"lord_enter_service_swear_accepted_2", [(str_store_faction_name,5,"$g_talk_troop_faction")],
 "I charge you with rooting out and destroying the forces of our enemies wheresoever you may find them. Moreover, I shall have special tasks for you from time to time, as may other of the warlords in my service. Serve well, fight boldly, and honor your oaths. This will take you far, if you have a mind for promotion. May God grant us long lives, and bring us many victories to toast in the great hall!", "close_window",[(assign, "$g_leave_encounter",1)]],

  [anyone,"lord_ask_leave_service", [(ge, "$g_talk_troop_relation", 1)], "Hrm. Has your oath become a burden, {playername}? It is unusual to request release from homage, but in respect of your fine service, I shall not hold you if you truly wish to end it. Though I must say, you would be sorely missed.", "lord_ask_leave_service_verify",[]],
  [anyone,"lord_ask_leave_service", [], "Release from homage? Hmm, perhaps that would be for the best... However, {playername}, you must be sure this is true and certain wish, for this is not a thing to be done lightly.", "lord_ask_leave_service_verify",[]],

  [anyone|plyr ,"lord_ask_leave_service_verify", [], "It is something I must do, {s65}.", "lord_ask_leave_service_2",[]],
  [anyone|plyr ,"lord_ask_leave_service_verify", [], "Perhaps you are right, {s65}. I suppose my true place is here.", "lord_ask_leave_service_giveup",[]],

  [anyone,"lord_ask_leave_service_giveup", [], "I am pleased to hear it, {playername}. I hope that henceforth you will banish such unworthy thoughts from your mind.", "lord_pretalk",[]],

  [anyone,"lord_ask_leave_service_2", [], "Then you are sure?", "lord_ask_leave_service_verify_again",[]],
  [anyone|plyr ,"lord_ask_leave_service_verify_again", [], "Yes, {s65}.", "lord_ask_leave_service_3",[]],
  [anyone|plyr ,"lord_ask_leave_service_verify_again", [], "Of course not, {s65}. I am and shall always be your loyal subject.", "lord_ask_leave_service_giveup",[]],

  [anyone,"lord_ask_leave_service_3", [], "As you wish. I hereby declare your oaths to be null and void. You will no longer hold land or titles in my name. You are free, {playername}.", "lord_ask_leave_service_end",
   [
        (call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
        (call_script, "script_player_leave_faction", 1),
    ]],

  [anyone|plyr ,"lord_ask_leave_service_end", [], "Thank you, my {lord/lady}. It was an honor to serve you.", "lord_ask_leave_service_end_2",[]],
  [anyone|plyr ,"lord_ask_leave_service_end", [], "Many thanks. It feels good to be {a free man/free} once again.", "lord_ask_leave_service_end_2",[]],

  [anyone ,"lord_ask_leave_service_end_2", [], "Farewell then, {playername}, and may good fortune follow you wherever you may go.", "close_window",
   [(assign, "$g_leave_encounter", 1)]],

#Active quests
##### TODO: QUESTS COMMENT OUT BEGIN

  [anyone,"lord_active_mission_1", [(store_partner_quest,":lords_quest"),
                                    (eq,":lords_quest","qst_lend_companion"),
                                    #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                                    (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                                    (check_quest_active,"qst_lend_companion"),
                                    (quest_slot_eq, "qst_lend_companion", slot_quest_giver_troop, "$g_talk_troop"),
                                    (store_current_day, ":cur_day"),
                                    (quest_get_slot, ":quest_target_amount", "qst_lend_companion", slot_quest_target_amount),
                                    (ge, ":cur_day", ":quest_target_amount"),
##                                    (quest_get_slot, ":quest_target_troop", "qst_lend_companion", slot_quest_target_troop),
##                                    (str_store_troop_name,s14,":quest_target_troop"),
##                                    (troop_get_type, reg3, ":quest_target_troop"),
                                    ],
   "Oh, you want your companion back? I see...", "lord_lend_companion_end",[]],




  [anyone,"lord_active_mission_1", [(store_partner_quest,":lords_quest"),(eq,":lords_quest","qst_lend_companion")],
   "{playername}, I must beg your patience, but I still have need of your companion. Please return later when things have settled.", "lord_pretalk",[]],
  [anyone,"lord_active_mission_1", [], "Yes, have you made any progress?", "lord_active_mission_2",[]],

  [anyone|plyr,"lord_active_mission_2",[#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                            (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                            (check_quest_active,"qst_capture_prisoners"),
                            (quest_slot_eq, "qst_capture_prisoners", slot_quest_giver_troop, "$g_talk_troop"),
                            (quest_get_slot, ":quest_target_amount", "qst_capture_prisoners", slot_quest_target_amount),
                            (quest_get_slot, ":quest_target_troop", "qst_capture_prisoners", slot_quest_target_troop),
                            (party_count_prisoners_of_type, ":count_prisoners", "p_main_party", ":quest_target_troop"),
							(store_add, ":quest_target_troop_add_1", ":quest_target_troop", 1),
							(party_count_prisoners_of_type, ":count_prisoners_veteran", "p_main_party", ":quest_target_troop_add_1"),
							(val_add, ":count_prisoners", ":count_prisoners_veteran"),
                            (ge, ":count_prisoners", ":quest_target_amount"),
                            (assign, reg1, ":quest_target_amount"),
                            (str_store_troop_name_plural, s1, ":quest_target_troop")],
   "Indeed. I brought you {reg1} {s1} as prisoners.", "lord_generic_mission_thank",
   [(quest_get_slot, ":quest_target_amount", "qst_capture_prisoners", slot_quest_target_amount),
    (quest_get_slot, ":quest_target_troop", "qst_capture_prisoners", slot_quest_target_troop),

	(try_begin),
      (party_count_prisoners_of_type, ":count_prisoners", "p_main_party", ":quest_target_troop"),
	  (le, ":quest_target_amount", ":count_prisoners"),
	  (party_remove_prisoners, "p_main_party", ":quest_target_troop", ":quest_target_amount"),
      (party_add_prisoners, "$g_encountered_party", ":quest_target_troop", ":quest_target_amount"),
    (else_try),
	  (party_remove_prisoners, "p_main_party", ":quest_target_troop", ":count_prisoners"),
	  (party_add_prisoners, "$g_encountered_party", ":quest_target_troop", ":count_prisoners"),

	  (store_sub, ":remaining_prisoners", ":quest_target_amount", ":count_prisoners"),
      
	  (store_add, ":quest_target_troop_add_1", ":quest_target_troop", 1),
	  (party_remove_prisoners, "p_main_party", ":quest_target_troop_add_1", ":remaining_prisoners"),	  
      (party_add_prisoners, "$g_encountered_party", ":quest_target_troop_add_1", ":remaining_prisoners"),
	(try_end),

    (call_script, "script_finish_quest", "qst_capture_prisoners", 100)]],


  [anyone|plyr,"lord_active_mission_2",
   [
     #(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
     (store_partner_quest, ":lords_quest"),
     (eq, ":lords_quest", "qst_capture_enemy_hero"),
     (assign, ":has_prisoner", 0),
     (quest_get_slot, ":quest_target_faction", "qst_capture_enemy_hero", slot_quest_target_faction),
     (party_get_num_prisoner_stacks, ":num_stacks", "p_main_party"),
     (try_for_range, ":i_stack", 0, ":num_stacks"),
       (party_prisoner_stack_get_troop_id, ":stack_troop", "p_main_party", ":i_stack"),
       (troop_is_hero, ":stack_troop"),
       (store_troop_faction, ":stack_faction", ":stack_troop"),
       (eq, ":quest_target_faction", ":stack_faction"),
       (troop_slot_eq, ":stack_troop", slot_troop_occupation, slto_kingdom_hero),
       (assign, ":has_prisoner", 1),
       (quest_set_slot, "qst_capture_enemy_hero", slot_quest_target_troop, ":stack_troop"),
     (try_end),
     (eq, ":has_prisoner", 1),
     (str_store_faction_name, s13, ":quest_target_faction")
     ],
   "Oh, indeed. I've captured the master of {s13} for you.", "capture_enemy_hero_thank",
   []],

  [anyone,"capture_enemy_hero_thank", [],
   "Many thanks, my friend. He will serve very well as a bargaining chip. You have done fine work here. Please accept these {reg5} thaler for your help.", "capture_enemy_hero_thank_2",
   [(quest_get_slot, ":quest_target_troop", "qst_capture_enemy_hero", slot_quest_target_troop),
     (quest_get_slot, ":quest_target_faction", "qst_capture_enemy_hero", slot_quest_target_faction),
     (party_remove_prisoners, "p_main_party", ":quest_target_troop", 1),
     (store_relation, ":reln", "$g_encountered_party_faction", ":quest_target_faction"),
     (try_begin),
       (lt, ":reln", 0),
       (party_add_prisoners, "$g_encountered_party", ":quest_target_troop", 1), #Adding him to the dungeon
     (else_try),
       #Do not add a non-enemy lord to the dungeon (due to recent diplomatic changes or due to a neutral town/castle)
       #(troop_set_slot, ":quest_target_troop", slot_troop_is_prisoner, 0),
       (troop_set_slot, ":quest_target_troop", slot_troop_prisoner_of_party, -1),
     (try_end),
     (quest_get_slot, ":reward", "qst_capture_enemy_hero", slot_quest_gold_reward),
     (call_script, "script_troop_add_gold", "trp_player", ":reward"),
     (add_xp_as_reward, 2500),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 4),
     (call_script, "script_end_quest", "qst_capture_enemy_hero"),
   ]],

  [anyone|plyr,"capture_enemy_hero_thank_2", [],
   "Certainly, {s65}.", "lord_pretalk",[]],
  [anyone|plyr,"capture_enemy_hero_thank_2", [],
   "It was nothing.", "lord_pretalk",[]],
  [anyone|plyr,"capture_enemy_hero_thank_2", [],
   "Let it be more of a challenge next time!", "lord_pretalk",[]],

##
##  [anyone|plyr,"lord_active_mission_2", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                                         (store_partner_quest,":lords_quest"),
##                                         (eq,":lords_quest","qst_capture_messenger"),
##                                         (quest_get_slot, ":quest_target_troop", ":lords_quest", slot_quest_target_troop),
##                                         (quest_get_slot, ":quest_target_amount", ":lords_quest", slot_quest_target_amount),
##                                         (store_num_parties_destroyed_by_player, ":num_destroyed", "pt_messenger_party"),
##                                         (gt, ":num_destroyed", ":quest_target_amount"),
##                                         (party_count_prisoners_of_type, ":num_prisoners", "p_main_party", ":quest_target_troop"),
##                                         (ge, ":num_prisoners", 1),
##                                         (str_store_troop_name, 3, ":quest_target_troop")],
##   "Indeed sir. I have captured a {s3} my lord.", "lord_generic_mission_thank",[(quest_get_slot, ":quest_target_troop", "qst_capture_messenger", slot_quest_target_troop),
##                                                                     (party_remove_prisoners, "p_main_party", ":quest_target_troop", 1),
##                                                                     (party_add_prisoners, "$g_encountered_party", ":quest_target_troop", 1),#Adding him to the dungeon
##                                                                     (call_script, "script_finish_quest", "qst_capture_messenger", 100)]],
##  
##
  [anyone|plyr,"lord_active_mission_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
										 (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                                         (store_partner_quest,":lords_quest"),
                                         (eq,":lords_quest","qst_raise_troops"),
                                         (quest_get_slot, ":quest_target_troop", ":lords_quest", slot_quest_target_troop),
                                         (quest_get_slot, ":quest_target_amount", ":lords_quest", slot_quest_target_amount),
                                         (party_count_companions_of_type, ":num_companions", "p_main_party", ":quest_target_troop"),
                                         (ge, ":num_companions", ":quest_target_amount"),
                                         (assign, reg1, ":quest_target_amount"),
                                         (str_store_troop_name_plural, s13, ":quest_target_troop")],
   "Indeed. I have raised {reg1} {s13}. You can take them.", "lord_raise_troops_thank",[(quest_get_slot, ":quest_target_troop", "qst_raise_troops", slot_quest_target_troop),
                                                                                         (quest_get_slot, ":quest_target_amount", "qst_raise_troops", slot_quest_target_amount),
                                                                                         (call_script,"script_change_player_relation_with_troop","$g_talk_troop",8),
                                                                                         (party_remove_members, "p_main_party", ":quest_target_troop", ":quest_target_amount"),
                                                                                         (call_script, "script_end_quest", "qst_raise_troops"),
                                                                                         (troop_get_slot, ":cur_lords_party", "$g_talk_troop", slot_troop_leaded_party),
                                                                                         (gt, ":cur_lords_party", 0),
                                                                                         (party_add_members, ":cur_lords_party", ":quest_target_troop", ":quest_target_amount"),
                                                                                         ]],

  [anyone,"lord_raise_troops_thank", [],
   "These men may well turn the tides in our favor, {playername}. I am confident you've trained them well. My thanks and my compliments to you.", "lord_raise_troops_thank_2",[]],

  [anyone|plyr,"lord_raise_troops_thank_2", [],
   "Very well -- the lads are at your command, sire. I am sure you will take good care of them.", "lord_pretalk",[]],
  

  [anyone|plyr,"lord_active_mission_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
									     (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                                         (store_partner_quest,":lords_quest"),
                                         (eq, ":lords_quest", "qst_collect_taxes"),
										 (check_quest_active, "qst_collect_taxes"),
                                         (check_quest_succeeded, "qst_collect_taxes"),
                                         (eq, "$qst_collect_taxes_halve_taxes", 0),
                                         (quest_get_slot, ":quest_gold_reward", "qst_collect_taxes", slot_quest_gold_reward),
                                         (store_mul, ":required_gold", ":quest_gold_reward", 8),
                                         (val_div, ":required_gold", 10),
                                         (store_troop_gold, ":gold", "trp_player"),
                                         (ge, ":gold", ":required_gold"),
                                         (assign, reg19, ":quest_gold_reward"),
                                         (quest_get_slot, ":quest_target_center", "qst_collect_taxes", slot_quest_target_center),
                                         (str_store_party_name, s3, ":quest_target_center"),
                                         ],
   "Here are all the taxes from {s3}. It comes to {reg19} thaler.", "lord_collect_taxes_success",
   []],

  [anyone|plyr,"lord_active_mission_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                                         (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                                         (store_partner_quest,":lords_quest"),
                                         (eq, ":lords_quest", "qst_collect_taxes"),
										 (check_quest_active, "qst_collect_taxes"),
                                         (check_quest_succeeded, "qst_collect_taxes"),
                                         (eq, "$qst_collect_taxes_halve_taxes", 1),
                                         (quest_get_slot, ":quest_gold_reward", "qst_collect_taxes", slot_quest_gold_reward),
                                         (store_mul, ":required_gold", ":quest_gold_reward", 95),
                                         (val_div, ":required_gold", 100),
                                         (store_troop_gold, ":gold", "trp_player"),
                                         (ge, ":gold", ":required_gold"),
                                         (assign, reg19, ":quest_gold_reward"),
                                         (quest_get_slot, ":quest_target_center", "qst_collect_taxes", slot_quest_target_center),
                                         (str_store_party_name, s3, ":quest_target_center"),
                                         ],
   "Here are the taxes from {s3}. It comes to {reg19} thaler.", "lord_collect_taxes_half_success",
   []],

  [anyone|plyr,"lord_active_mission_2", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
										 (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
                                         (store_partner_quest,":lords_quest"),
                                         (eq, ":lords_quest", "qst_collect_taxes"),
                                         (check_quest_failed, "qst_collect_taxes"),
                                         (quest_get_slot, ":quest_gold_reward", "qst_collect_taxes", slot_quest_gold_reward),
                                         (store_troop_gold, ":gold", "trp_player"),
                                         (ge, ":gold", ":quest_gold_reward"),
                                         (assign, reg19, ":quest_gold_reward"),
                                         (quest_get_slot, ":quest_target_center", "qst_collect_taxes", slot_quest_target_center),
                                         (str_store_party_name, s3, ":quest_target_center"),
                                         ],
   "Unfortunately, a revolt broke out while I was collecting the taxes. I could only collect {reg19} thaler.", "lord_collect_taxes_fail",
   []],

  [anyone,"lord_collect_taxes_success", [(quest_get_slot, ":total_revenue", "qst_collect_taxes", slot_quest_gold_reward),
                                         (store_mul, ":owner_share", ":total_revenue", 8),
                                         (val_div, ":owner_share", 10),
                                         (assign, reg20, ":owner_share"),
                                         (store_sub, reg21, ":total_revenue", ":owner_share")],
   "Well done, {playername}, very well done indeed! You were truly the right {man/person} for the job. I promised you a fifth of the taxes, so that amounts to {reg21} thaler. If you give me {reg20} thaler, you may keep the difference. That's a fine day for everyone, wouldn't you say?", "lord_pretalk",
   [
    (troop_remove_gold, "trp_player", reg20),
    (quest_set_slot, "qst_collect_taxes", slot_quest_gold_reward, 0),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 4),
    (call_script, "script_end_quest", "qst_collect_taxes"),
    ]],


  [anyone,"lord_collect_taxes_half_success", [(quest_get_slot, ":gold_reward", "qst_collect_taxes", slot_quest_gold_reward),
                                         (val_mul, ":gold_reward", 95),
                                         (val_div, ":gold_reward", 100),
                                         (assign, reg20, ":gold_reward")],
   "What?! Is this some scheme of yours, {playername}? That's less than half the taxes I'm owed! It seems you would let them get away with murder -- and my money. What a farce! You can forget the amount I promised you. I'm taking {reg20} thaler from what you collected. You're lucky I'm leaving you a few coins for honor's sake.", "lord_pretalk",
   [(troop_remove_gold, "trp_player", reg20),
    (quest_set_slot, "qst_collect_taxes", slot_quest_gold_reward, 0),
    (call_script, "script_end_quest", "qst_collect_taxes"),
    ]],


  [anyone,"lord_collect_taxes_fail", [],
   "God, what a bloody mess you've gotten us into, {playername}.This might turn very ugly if I do not take immediate action. I certainly hope you're not here expecting to be paid for your failure. Hand over my {reg19} thaler, if you please, and let us end our business together.", "lord_pretalk",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
    (quest_get_slot, ":gold_reward", "qst_collect_taxes", slot_quest_gold_reward),
    (troop_remove_gold, "trp_player", ":gold_reward"),
    (quest_set_slot, "qst_collect_taxes", slot_quest_gold_reward, 0),
    (call_script, "script_end_quest", "qst_collect_taxes"),
    ]],

  [anyone|plyr,"lord_active_mission_2", [(store_partner_quest,":lords_quest"),
                                         (eq, ":lords_quest", "qst_hunt_down_fugitive"),
                                         (check_quest_active, "qst_hunt_down_fugitive"),
                                         (check_quest_succeeded, "qst_hunt_down_fugitive"),
                                         (quest_get_slot, ":quest_target_center", "qst_hunt_down_fugitive", slot_quest_target_center),
                                         (str_store_party_name, s3, ":quest_target_center"),
                                         (quest_get_slot, ":quest_target_dna", "qst_hunt_down_fugitive", slot_quest_target_dna),
                                         (call_script, "script_get_name_from_dna_to_s50", ":quest_target_dna"),
                                         (str_store_string, s4, s50),],
   "I found {s4} hiding at {s3}, and delivered his punishment.", "lord_hunt_down_fugitive_success",
   []],

  [anyone|plyr,"lord_active_mission_2", [(store_partner_quest,":lords_quest"),
                                         (eq, ":lords_quest", "qst_hunt_down_fugitive"),
                                         (check_quest_failed, "qst_hunt_down_fugitive"),
                                         ],
   "I'm afraid he got away.", "lord_hunt_down_fugitive_fail",
   []],

  [anyone,"lord_hunt_down_fugitive_success", [],
   "And we'll all be a lot better off without him! Thank you, {playername}, for removing this long-festering thorn from my side. 'Tis good to know you can be trusted to handle things without too much fuss. A bounty I promised, and a bounty you shall have. 300 thaler and not a copper less!", "lord_hunt_down_fugitive_success_2",
   [
     (add_xp_as_reward, 300),
    ]],
  
  [anyone|plyr,"lord_hunt_down_fugitive_success_2", [],
   "I shall take the money, {s65}, and thank you for it.", "lord_hunt_down_fugitive_reward_accept",[]],
  [anyone|plyr,"lord_hunt_down_fugitive_success_2", [],
   "This is blood money. I cannot accept it.", "lord_hunt_down_fugitive_reward_reject",[]],

#Post 0907 changes begin
  [anyone,"lord_hunt_down_fugitive_reward_accept", [],
   "Of course, {playername}. Here you are. Once again, you've my thanks for ridding me of that {s44}.", "lord_pretalk",[
       (troop_get_slot, ":insult_string", "$g_talk_troop", slot_lord_reputation_type),
       (val_add, ":insult_string", "str_lord_insult_default"),
       (str_store_string, s44, ":insult_string"),

		(call_script, "script_troop_add_gold", "trp_player", 300),
       (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 2),
		(call_script, "script_end_quest", "qst_hunt_down_fugitive"),
		]],

  [anyone,"lord_hunt_down_fugitive_reward_reject", [],
   "You are a {man/woman} for whom justice is its own reward, eh? As you wish, {playername}, as you wish. An honorable sentiment, to be true. Regardless, you've my thanks for ridding me of that {s44}.", "lord_pretalk",[

       (troop_get_slot, ":insult_string", "$g_talk_troop", slot_lord_reputation_type),
       (val_add, ":insult_string", "str_lord_insult_default"),
       (str_store_string, s44, ":insult_string"),
       
       (call_script, "script_change_player_honor", 3),
       (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 2),
       (call_script, "script_end_quest", "qst_hunt_down_fugitive"),
       ]],

  [anyone,"lord_hunt_down_fugitive_fail", [],
   "You disappoint me. That {s44} managed to avoid the hand of justice once more. I thought you would be equal to the task, {playername}. Clearly I was wrong.", "lord_pretalk",
   [
    (troop_get_slot, ":insult_string", "$g_talk_troop", slot_lord_reputation_type),
    (val_add, ":insult_string", "str_lord_insult_default"),
    (str_store_string, 44, ":insult_string"),

    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
    (call_script, "script_end_quest", "qst_hunt_down_fugitive"),
    ]],
#Post 0907 changes end



##
##
##  [anyone|plyr,"lord_active_mission_2", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                                         (store_partner_quest,":lords_quest"),
##                                         (eq,":lords_quest","qst_bring_back_deserters"),
##                                         (quest_get_slot, ":quest_target_troop", ":lords_quest", slot_quest_target_troop),
##                                         (quest_get_slot, ":quest_target_amount", ":lords_quest", slot_quest_target_amount),
##                                         (party_count_prisoners_of_type, ":num_prisoners", "p_main_party", ":quest_target_troop"),
##                                         (ge, ":num_prisoners", ":quest_target_amount"),
##                                         (assign, reg1, ":quest_target_amount")],
##   "Yes sir. I have brought {reg1} deserters as you asked me to.", "lord_generic_mission_thank",[(quest_get_slot, ":quest_target_troop", "qst_bring_back_deserters", slot_quest_target_troop),
##                                                                                     (quest_get_slot, ":quest_target_amount", "qst_bring_back_deserters", slot_quest_target_amount),
##                                                                                     (party_remove_prisoners, "p_main_party", ":quest_target_troop", ":quest_target_amount"),
##                                                                                     (faction_get_slot, ":faction_tier_2_troop", "$g_talk_troop_faction", slot_faction_tier_2_troop),
##                                                                                     (try_begin),
##                                                                                       (gt, ":faction_tier_2_troop", 0),
##                                                                                       (troop_get_slot, ":cur_lords_party", "$g_talk_troop", slot_troop_leaded_party),
##                                                                                       (gt, ":cur_lords_party", 0),
##                                                                                       (party_add_members, ":cur_lords_party", ":faction_tier_2_troop", ":quest_target_amount"),
##                                                                                     (try_end),
##                                                                                     (call_script, "script_finish_quest", "qst_bring_back_deserters", 100)]],
## 
##
##### TODO: QUESTS COMMENT OUT END
  [anyone|plyr,"lord_active_mission_2", [], "I am still working on it.", "lord_active_mission_3",[]],
  [anyone|plyr,"lord_active_mission_2", [], "I am afraid I won't be able to accept this quest.", "lord_mission_failed",[]],
                                                                                                                                                   
  [anyone,"lord_active_mission_3", [], "Good. Remember, I am counting on you.", "lord_pretalk",[]],
  
  
#Post 0907 changes begin
  [anyone,"lord_mission_failed", [], "{s43}", "lord_pretalk",
   [
    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_mission_failed_default"),
    (store_partner_quest,":lords_quest"),
    (call_script, "script_abort_quest", ":lords_quest", 1)]],
#Post 0907 changes end
  

#Claim center
##  [anyone,"lord_claim_center_begin", [],
##   "What do you want to do with {s4}?", "lord_claim_center_ask",[]],
##
##  [anyone|plyr,"lord_claim_center_ask", [],
##   "I want to claim it for myself.", "lord_claim_center_2",[]],
##  [anyone|plyr,"lord_claim_center_ask", [],
##   "I will leave it to you my lord. I have no interest in holding {s4}.", "lord_claim_center_leave_to_lord",[]],


##  [anyone,"lord_claim_center_2", [(eq, "$g_player_permitted_castles", 0),],
##   "You are an able warrior {playername} and there is no question of your bravery.\
## Alas, you are not noble born, and there are those who will be upset if I allow you to hold a castle.\
## So, it saddens me but I must decline your request.", "lord_claim_center_deny", []],
##  
##  [anyone|plyr,"lord_claim_center_deny", [],
##   "This is not fair my lord. I shed my blood to take {s4}. Now another {man/master} will rule over it.", "lord_claim_center_deny_2", []],
##  [anyone|plyr,"lord_claim_center_deny", [],
##   "I understand sir. Do as you will.", "lord_claim_center_leave_to_lord", []],
##  [anyone,"lord_claim_center_deny_2", [],
##   "Remember that you gave me your oath {playername}. And you agreed to do as told.", "lord_claim_center_deny_3", []],
##  [anyone,"lord_claim_center_deny_3", [],
##   "Yes sir.", "lord_claim_center_leave_to_lord", []],
##
##  [anyone,"lord_claim_center_leave_to_lord", [],
##   "Very well.  Then I will find a suitable master for {s4}.\
## In recognition of your bravery and service, I give you these 5000 denars.", "lord_pretalk",
##   [(troop_get_slot, ":wealth", "$g_talk_troop", slot_troop_wealth),
##    (val_sub, ":wealth", 6000),
##    (troop_set_slot, "$g_talk_troop", slot_troop_wealth, ":wealth"),
##    (call_script, "script_troop_add_gold", "trp_player", 5000),
##
##    (assign, ":new_master", "$g_talk_troop"),
##    (assign, ":max_wealth", 0),
##
##    (try_for_range, ":hero_no", kingdom_heroes_begin, kingdom_heroes_end),
##      (troop_slot_eq, ":hero_no", slot_troop_is_prisoner, 0),
##      (troop_slot_eq, ":hero_no", slot_troop_occupation, slto_kingdom_hero),
##      (store_troop_faction, ":hero_faction", ":hero_no"),
##      (eq, ":hero_faction", "$players_kingdom"),
##      (call_script, "script_get_number_of_hero_centers", "$g_talk_troop"),
##      (assign, ":no_of_owned_centers", reg0),
##      (neg|faction_slot_eq, "$players_kingdom", slot_faction_leader, ":hero_no"),
##      (lt, ":no_of_owned_centers", 2),
##      (troop_get_slot, ":wealth", "$g_talk_troop", slot_troop_wealth),
##      (ge, ":wealth", ":max_wealth"),
##      (assign, ":new_master", ":hero_no"),
##      (assign, ":max_wealth", ":wealth"),
##    (try_end),
##
##    (call_script, "script_give_center_to_lord", "$center_to_be_claimed", ":new_master"),
##    (set_spawn_radius, 1),
##    (spawn_around_party, "$center_to_be_claimed", "pt_old_garrison"),
##    (assign, ":new_party", reg0),
##    (party_set_ai_behavior, ":new_party", ai_bhvr_attack_party),
##    (party_set_ai_object, ":new_party", "p_main_party"),
##    (party_set_flags, ":new_party", pf_default_behavior, 0),
##    (call_script, "script_party_copy", ":new_party", "$center_to_be_claimed"),
##    (party_clear, "$center_to_be_claimed"),
##
##    (faction_get_slot, ":reinforcement_template_a", "$g_talk_troop_faction", slot_faction_reinforcements_a),
##    (faction_get_slot, ":reinforcement_template_b", "$g_talk_troop_faction", slot_faction_reinforcements_b),
##    (party_add_template, "$center_to_be_claimed", ":reinforcement_template_a"),
##    (party_add_template, "$center_to_be_claimed", ":reinforcement_template_b"),
##    ]],
##  
##
##  [anyone,"lord_claim_center_2", [(assign, ":number_of_claimed_centers", 0),
##                                  (try_for_range, ":center_no", centers_begin, centers_end),
##                                    (party_slot_eq, ":center_no", slot_party_type, spt_castle),
##                                    (store_faction_of_party, ":faction_no", ":center_no"),
##                                    (eq, ":faction_no", "fac_player_supporters_faction"),
##                                    (party_slot_eq, ":center_no", slot_town_claimed_by_player, 1),
##                                    (val_add, ":number_of_claimed_centers", 1),
##                                  (try_end),
##                                  (lt, ":number_of_claimed_centers", "$g_player_permitted_castles"),
##                                  (assign, reg7, ":number_of_claimed_centers"),
##                                  ],
##   "I had promised you to defend your right to hold {reg7?a:another} castle {playername}. Now I honor that promise.\
## I can think of {no man finer than you/no one better than you} to be the {lord/lady} of {s4}.\
## Renew your oath to me now. Then I will be your liege,\
## and I'll support you and protect you against all those who oppose your claim.",
##  "lord_claim_center_give_oath",[]],
##
##                                    
##  [anyone|plyr,"lord_claim_center_give_oath", [],  "I give you my oath lord, I will forever be faithful to you,\
## I will never act in a way to cause you harm, and I will be at your side to fight your enemies should you need my sword.", "lord_claim_center_direct_3", []],
##  [anyone,"lord_claim_center_direct_3", [],  "You have given your oath of fealty {playername}. I accept your oath and give you the fief of {s4}.\
## Rule it wisely and protect it against our enemies.", "lord_claim_center_direct_4", [
##     (party_set_slot, "$center_to_be_claimed", slot_town_claimed_by_player, 1),
##     (call_script, "script_give_center_to_lord", "$center_to_be_claimed", "trp_player")]],
##  [anyone|plyr,"lord_claim_center_direct_4", [],  "I thank you lord.", "close_window", [(assign, "$g_leave_encounter",1)]],

#Ask for favor
##  [anyone,"lord_ask_for_favor_ask", [],
##   "What is it? I don't have time for personal requests.", "lord_ask_for_favor",[]],
##  [anyone,"lord_ask_for_favor_ask", [],
##   "Say it then. If it's something possible...", "lord_ask_for_favor",[]],
##
##  [anyone|plyr,"lord_ask_for_favor", [],
##   "Nothing my lord. It's not important.", "lord_pretalk",[]],
#Suggest action
  [anyone,"lord_suggest_action_ask", [],
   "What do you suggest?", "lord_suggest_action",[]],


  [anyone|plyr,"lord_suggest_action", [],
   "I wish to become a subject of your nation.", "lord_suggest_join_faction",[]],
  [anyone,"lord_suggest_join_faction", [],
   "Very well then.", "lord_give_oath_5",[]],

  [anyone|plyr,"lord_suggest_action", [],
   "{!}Cheat: I want to know the ID of the party you command.", "lord_suggest_learn_party_id",[]],
  [anyone,"lord_suggest_learn_party_id", [(troop_get_slot, reg0, "$g_talk_troop", slot_troop_leaded_party)],
   "It is {reg0}.", "lord_pretalk",[]],

  [anyone|plyr,"lord_suggest_action", [(eq, "$players_kingdom", "$g_talk_troop_faction"),],
   "I want to be your nation's marshal.", "lord_suggest_become_marshall",[]],
  [anyone,"lord_suggest_become_marshall", [],
   "Very well then.", "lord_pretalk",
   [
     (faction_set_slot, "$g_talk_troop_faction", slot_faction_marshall, "trp_player"),
     (faction_set_slot, "$g_talk_troop_faction", slot_faction_ai_state, sfai_default),
     (assign, "$g_recalculate_ais", 1),
   ]],

  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Let us attack an enemy town or fortress.", "lord_suggest_attack_enemy_castle",[]],
  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Let us return to a friendly town.", "lord_suggest_go_to_friendly_town",[]],
  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Let us attack an enemy war party.", "lord_suggest_attack_enemy_party",[]],
  [anyone|plyr,"lord_suggest_action", [(eq, "$talk_context", tc_siege_commander)],
   "Let us lift this siege.", "lord_suggest_lift_siege",[]],
  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Follow me.", "lord_suggest_follow_me",[]],
  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Follow someone.", "lord_suggest_follow_other",[]],
  [anyone|plyr,"lord_suggest_action", [(neq, "$talk_context", tc_siege_commander)],
   "Raid a village.", "lord_suggest_raid_village",[]],
  [anyone|plyr,"lord_suggest_action", [],
   "Like me.", "lord_pretalk",[(call_script,"script_change_player_relation_with_troop","$g_talk_troop",20)]],

  [anyone,"lord_suggest_lift_siege", [],
   "As you wish, {playername}.", "close_window",[(call_script, "script_party_set_ai_state", "$g_talk_troop_party", spai_undefined),
                                           (party_leave_cur_battle, "$g_talk_troop_party"),
                                           (assign, "$g_leave_encounter", 1)]],
  
  [anyone,"lord_suggest_go_to_friendly_town", [],
   "Hmm. To which town or fortress do you suggest we go?", "lord_suggest_go_to_friendly_town2",[]],
  [anyone|plyr|repeat_for_parties,"lord_suggest_go_to_friendly_town2", [
                                                                       (store_repeat_object, ":center_no"),
                                                                       (this_or_next|party_slot_eq,":center_no",slot_party_type, spt_castle),
                                                                       (party_slot_eq,":center_no",slot_party_type, spt_town),
                                                                       (neq, ":center_no", "$g_encountered_party"),
                                                                       (store_faction_of_party, ":town_faction", ":center_no"),
                                                                       (eq, ":town_faction", "$g_talk_troop_faction"),
                                                                       (str_store_party_name, s1, ":center_no")],
   "{s1}", "lord_suggest_go_to_friendly_town3",[(store_repeat_object, "$town_suggested_to_go_to")]],
  [anyone|plyr,"lord_suggest_go_to_friendly_town2", [],
   "Never mind.", "lord_pretalk",[]],

  [anyone,"lord_suggest_go_to_friendly_town3", [(str_store_party_name, 1, "$town_suggested_to_go_to")],
   "Very well, we shall go to {s1}.", "lord_pretalk",
   [
       (call_script, "script_party_set_ai_state", "$g_talk_troop_party", spai_holding_center, "$town_suggested_to_go_to"),
       ]],

  
  
  [anyone,"lord_suggest_attack_enemy_party", [],
   "Hmm. Which party do you suggest we attack?", "lord_suggest_attack_enemy_party2",[]],
  [anyone|plyr|repeat_for_parties,"lord_suggest_attack_enemy_party2", [
                                                                       (store_repeat_object, ":party_no"),
                                                                       (party_slot_eq,":party_no",slot_party_type, spt_kingdom_hero_party),
                                                                       (party_is_active, ":party_no"),
                                                                       (store_faction_of_party, ":party_faction", ":party_no"),
                                                                       (store_relation, ":party_relation", ":party_faction", "$g_talk_troop_faction"),
                                                                       (le, ":party_relation", -10),
                                                                       (call_script, "script_get_closest_walled_center", ":party_no"),
                                                                       (assign, ":center_no", reg0),
                                                                       (str_store_party_name, s3, ":center_no"),
                                                                       (str_store_faction_name, s2, ":party_faction"),
                                                                       (str_store_party_name, s1, ":party_no")],
   "There is a detachment under the command {s1} of {s2}. It is far from {s3}, making it an excellent target.", "lord_suggest_attack_enemy_party3",[(store_repeat_object, "$suggested_to_attack_party")]],
  [anyone|plyr,"lord_suggest_attack_enemy_party2", [],
   "Never mind.", "lord_pretalk",[]],

  [anyone,"lord_suggest_attack_enemy_party3", [(str_store_party_name, 1, "$suggested_to_attack_party")],
   "As you wish, we shall attack {s1}.", "lord_pretalk",
   [
       (call_script, "script_party_set_ai_state", "$g_talk_troop_party", spai_engaging_army, "$suggested_to_attack_party"),
       ]],


##  [anyone,"lord_suggest_attack_enemy_castle", [(troop_get_slot, ":player_favor", "$g_talk_troop", slot_troop_player_favor),
##                                               (lt, ":player_favor", 20)],
##   "Hmm. No, I don't think that's a good idea.", "lord_pretalk",[]],

  [anyone,"lord_suggest_attack_enemy_castle", [],
   "Hmm. Which one do you suggest we attack?", "lord_suggets_attack_enemy_castle2",[]],
  [anyone|plyr|repeat_for_parties,"lord_suggets_attack_enemy_castle2", [
                                                                       (store_repeat_object, ":center_no"),
                                                                       (this_or_next|party_slot_eq,":center_no",slot_party_type, spt_castle),
                                                                       (party_slot_eq,":center_no",slot_party_type, spt_town),
                                                                       (store_faction_of_party, ":town_faction", ":center_no"),
                                                                       (store_relation, ":town_relation", ":town_faction", "$g_talk_troop_faction"),
                                                                       (le, ":town_relation", -10),
                                                                       (str_store_faction_name, s2, ":town_faction"),
                                                                       (str_store_party_name, s1, ":center_no")],
   "{s1} of {s2}.", "lord_suggets_attack_enemy_castle3",[(store_repeat_object, "$suggested_to_attack_center")]],

  [anyone|plyr,"lord_suggets_attack_enemy_castle2", [],
   "Return...", "lord_pretalk",[]],

  [anyone,"lord_suggets_attack_enemy_castle3", [(str_store_party_name, 1, "$suggested_to_attack_center")],
   "That should be possible. Very well, we shall attack {s1}.", "lord_pretalk",
   [
       (call_script, "script_party_set_ai_state", "$g_talk_troop_party", spai_besieging_center, "$suggested_to_attack_center"),
       
       ]],

  [anyone,"lord_suggest_raid_village", [],
   "Hmm. Which village do you suggest we attack?", "lord_suggest_raid_village_2",[]],
  [anyone|plyr|repeat_for_parties,"lord_suggest_raid_village_2", [
                                                                       (store_repeat_object, ":center_no"),
                                                                       (party_slot_eq,":center_no",slot_party_type, spt_village),
                                                                       (store_faction_of_party, ":town_faction", ":center_no"),
                                                                       (store_relation, ":town_relation", ":town_faction", "$g_talk_troop_faction"),
                                                                       (le, ":town_relation", -10),
                                                                       (str_store_faction_name, s2, ":town_faction"),
                                                                       (str_store_party_name, s1, ":center_no")],
   "{s1} of {s2}.", "lord_suggest_raid_village_3",[(store_repeat_object, "$suggested_to_attack_center")]],
  [anyone|plyr,"lord_suggest_raid_village_2", [],
   "Return...", "lord_pretalk",[]],

  [anyone,"lord_suggest_raid_village_3", [(str_store_party_name, s1, "$suggested_to_attack_center")],
   "That should be possible. Very well, we'll attack {s1}.", "lord_pretalk",
   [
     (call_script, "script_party_set_ai_state", "$g_talk_troop_party", spai_raiding_around_center, "$suggested_to_attack_center"),
   ]],


  [anyone,"lord_suggest_follow_me", [],
   "Aye, I'll follow you.", "lord_pretalk",[(party_set_slot, "$g_talk_troop_party", slot_party_commander_party, "p_main_party"),
                                (call_script, "script_party_decide_next_ai_state_under_command", "$g_talk_troop_party")]],


  [anyone,"lord_suggest_follow_other", [],
   "Who do you want me to follow?", "lord_suggest_follow_other_2",[]],
  [anyone|plyr|repeat_for_parties,"lord_suggest_follow_other_2", [
                                                                       (store_repeat_object, ":party_no"),
                                                                       (party_slot_eq,":party_no",slot_party_type, spt_kingdom_hero_party),
                                                                       (neq, ":party_no", "$g_talk_troop"),
                                                                       (store_faction_of_party, ":party_faction", ":party_no"),
                                                                       (eq, ":party_faction", "$g_talk_troop_faction"),
                                                                       (str_store_party_name, s1, ":party_no")],
   "{s1}", "lord_suggest_follow_other_3",[(store_repeat_object, "$town_suggested_to_go_to")]],
  [anyone|plyr,"lord_suggest_follow_other_2", [],
   "Return...", "lord_pretalk",[]],

  [anyone,"lord_suggest_follow_other_3", [(str_store_party_name, 1, "$town_suggested_to_go_to")],
   "As you wish, I shall be accompanying {s1}.", "lord_pretalk",
   [
     (party_set_slot, "$g_talk_troop_party", slot_party_commander_party, "$town_suggested_to_go_to"),
       (call_script, "script_party_decide_next_ai_state_under_command", "$g_talk_troop_party"),
   ]],

  [anyone|plyr,"lord_suggest_action", [],
   "Nothing, {s65}. It's not important.", "lord_pretalk",[]],


##### TODO: QUESTS COMMENT OUT BEGIN
#Request Mission

  [anyone|auto_proceed,"lord_request_mission_ask",
   [(eq, "$players_kingdom", 0),
    (ge, "$g_talk_troop_faction_relation", 0),
    (ge, "$g_talk_troop_relation", 0),
    (troop_slot_ge, "trp_player", slot_troop_renown, 30),
    (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"),
    (faction_get_slot, ":last_offer_time", "$g_talk_troop_faction", slot_faction_last_mercenary_offer_time),
	(neq, "$g_main_quest_active", 1),
    (assign, ":num_enemies", 0),
    (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
      (faction_slot_eq, "$g_talk_troop_faction", slot_faction_state, sfs_active),
      (store_relation, ":reln", "$g_talk_troop_faction", ":faction_no"),
      (lt, ":reln", 0),
      (val_add, ":num_enemies", 1),
    (try_end),
    (ge, ":num_enemies", 1),
    (store_current_hours, ":cur_hours"),
    (store_add,  ":week_past_last_offer_time", ":last_offer_time", 7 * 24),
    (val_add,  ":last_offer_time", 24),
    (ge, ":cur_hours", ":last_offer_time"),
    (store_random_in_range, ":rand", 0, 100),
    (this_or_next|lt, ":rand", 20),
		(ge, ":cur_hours", ":week_past_last_offer_time"),
    ],
   "Warning: This line should never display.", "lord_propose_mercenary",[(store_current_hours, ":cur_hours"),
                                  (faction_set_slot, "$g_talk_troop_faction", slot_faction_last_mercenary_offer_time,  ":cur_hours")]],

  [anyone,"lord_propose_mercenary", [(call_script, "script_party_calculate_strength", "p_main_party", 0),
                                     (assign, ":offer_value", reg0),
                                     (val_add, ":offer_value", 100),
                                     (call_script, "script_round_value", ":offer_value"),
                                     (assign, ":offer_value", reg0),
                                     (assign, "$temp", ":offer_value"),
                                     (faction_get_slot, ":faction_leader", "$g_talk_troop_faction", slot_faction_leader),
                                     (neq, ":faction_leader", "$g_talk_troop"),
                                     (str_store_faction_name, s9, "$g_talk_troop_faction"),
                                     (str_store_troop_name, s10, ":faction_leader"),],
   "As it happens, {playername}, I promised {s10} that I would provide a company of mercenaries for an upcoming campaign. What do you say to entering the service of {s9} as a mercenary captain? I've no doubt that you would be equal to the task.", "lord_mercenary_service", []],
  [anyone|plyr,"lord_mercenary_service", [], "I'm not interested, thank you.", "lord_mercenary_service_reject", []],
  [anyone|plyr,"lord_mercenary_service", [], "Aye, I'll join {s9}.", "lord_mercenary_service_accept", []],
  [anyone|plyr,"lord_mercenary_service", [], "Sounds interesting. Tell me more.", "lord_mercenary_elaborate_pay", []],

  [anyone,"lord_mercenary_service_accept", [(str_store_faction_name, s9, "$g_talk_troop_faction")],
   "Perfect. Of course you shall have to make a formal declaration of allegiance, and give your oath that you and your company will remain in service to {s9} for a period of no less than three months.", "lord_mercenary_service_verify", []],
  [anyone|plyr,"lord_mercenary_service_verify", [], "As you wish. Your enemies are my enemies.", "lord_mercenary_service_verify_2", []],
  [anyone|plyr,"lord_mercenary_service_verify", [], "On second thought, I might rather keep my independence.", "lord_mercenary_service_reject", []],

  [anyone,"lord_mercenary_service_verify_2", [], "Aye, that will do. You've made a wise choice, my friend. {s9} does well by its loyal fighters. You will receive many rewards for your service.", "lord_mercenary_service_accept_3", [
     (call_script, "script_troop_add_gold", "trp_player", "$temp"),
     (store_current_hours, ":cur_hours"),
     (store_add, "$mercenary_service_next_pay_time", ":cur_hours", 7 * 24),
     (assign, "$mercenary_service_accumulated_pay", 0),
     (store_current_day, ":cur_day"),
     (store_add, "$mercenary_service_next_renew_day", ":cur_day", 90),
     (call_script, "script_player_join_faction", "$g_talk_troop_faction"),
     (str_store_faction_name, s9, "$g_talk_troop_faction"),]],

  [anyone,"lord_mercenary_service_accept_3", [], "Now, I suggest you prepare yourself for a serious campaign. Respond quickly when you are summoned for duty, and meanwhile train and equip your soldiers as best you can.", "lord_pretalk", []],

  [anyone,"lord_mercenary_service_reject", [(str_store_faction_name, s9, "$g_talk_troop_faction")],
   "I'm very sorry to hear that. You'll find no better place than {s9}, be sure of that.", "lord_pretalk", []],

  [anyone,"lord_mercenary_elaborate_pay", [(assign, reg12, "$temp")],
   "I'll offer you a contract for three months. At the end of those three, it can be extended monthly. An initial sum of {reg12} thaler will be paid to you to seal the contract. After that, you'll receive wages from {s10} each week, according to the number and quality of the soldiers in your company. You'll retain all rights to battlefield loot and salvage, as well as any prisoners you capture. As I'm sure you know, war can be quite profitable...", "lord_mercenary_elaborate_1",
   [(faction_get_slot, ":faction_leader", "$g_talk_troop_faction", slot_faction_leader),
    (str_store_troop_name, s10, ":faction_leader")]],

  
  [anyone,"lord_mercenary_service_elaborate_duty", [], 
   "Your duties... There are only a few, and none of them are difficult. The first thing is to declare your allegiance, an oath of loyalty to our cause. Once that's done, you shall be required to fulfill certain responsibilities. You'll participate in military campaigns, fulfill any tasks given to you by your commanders, and most of all -- attack the enemies of our nation wherever you might find them.", "lord_mercenary_elaborate_1",
   [(faction_get_slot, ":faction_leader", "$g_talk_troop_faction", slot_faction_leader),
    (str_store_troop_name, s10, ":faction_leader")]],
  
  [anyone|plyr,"lord_mercenary_elaborate_1", [], "And what about my duties as a mercenary?", "lord_mercenary_service_elaborate_duty", []],
  [anyone|plyr,"lord_mercenary_elaborate_1", [], "Can I hold any fortresses I may take?", "lord_mercenary_elaborate_castle", []],
  [anyone|plyr,"lord_mercenary_elaborate_1",
   [
     (neg|troop_slot_ge, "trp_player", slot_troop_banner_scene_prop, 1),
#custom_banner begin  	
##    (eq, "trp_player", slot_troop_custom_banner_flag_type, -1),
#custom_banner end
     ], "Can I fly my own banner?", "lord_mercenary_elaborate_banner", []],
  [anyone|plyr,"lord_mercenary_elaborate_1", [], "How much will you pay me for my service?", "lord_mercenary_elaborate_pay", []],
  [anyone|plyr,"lord_mercenary_elaborate_1", [], "Sounds good. I wish to enter your service as a mercenary.", "lord_mercenary_service_accept", []],
  [anyone|plyr,"lord_mercenary_elaborate_1", [], "I'm sorry, but my sword is not for hire.", "lord_mercenary_service_reject", []],

  [anyone,"lord_mercenary_elaborate_castle", [(faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop")],
   "Only my loyal subjects can own lands and fortresses in my realm. A mercenary cannot be trusted with such a responsibility. However, after serving for a time, you can swear homage to me and become my subject. Then you will be rewarded with a fief.", "lord_mercenary_elaborate_1", []],
  [anyone,"lord_mercenary_elaborate_castle", [], "Only loyal subjects of {s10} can own lands and castles. A simple mercenary cannot be trusted with such responsibility, you understand. However, after serving for a time, you may earn the right to swear homage to {s10}. Then you would be rewarded with a fief.", "lord_mercenary_elaborate_1", []],

  [anyone,"lord_mercenary_elaborate_banner", [(faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop")],
   "Only my nobles have the honor of carrying their own banners. However, after some time in mercenary service, you may earn the opportunity to swear homage to me and become my subject, gaining the right to choose a banner of your own, and fight under it in battle.", "lord_mercenary_elaborate_1", []],
  [anyone,"lord_mercenary_elaborate_banner", [], "{s10} holds old tradition dear. Only nobles have the honor of carrying their own banners. However, after some time of mercenary service, perhaps you can earn the opportunity to swear homage to {s10}, with which comes the right to choose a banner of your own and fight under it in battle.", "lord_mercenary_elaborate_1", []],

  [anyone,"lord_request_mission_ask", [(store_partner_quest,":lords_quest"),(ge,":lords_quest",0)],
   "You still haven't finished the last task I gave you, {playername}. You should be working on that, not asking me for other things to do.", "lord_pretalk",[]],

  [anyone,"lord_request_mission_ask", [(troop_slot_eq, "$g_talk_troop", slot_troop_does_not_give_quest, 1)],
   "I don't have any other tasks for you right now.", "lord_pretalk",[]],
  [anyone|auto_proceed,"lord_request_mission_ask", [], "A task?", "lord_tell_mission",
   [
       (call_script, "script_get_random_quest", "$g_talk_troop"),
       (assign, "$random_quest_no", reg0),
   ]],


  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_deliver_message")],
   "I must send a letter to {s13}, who should currently be at {s4}. If you will be heading in that direction, would you kindly deliver it to him? The letter must be in his hands within 30 days.", "lord_mission_deliver_message",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_troop_name_link,s9,"$g_talk_troop"),
     (str_store_troop_name_link,s13,":quest_target_troop"),
     (str_store_party_name_link,s4,":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
##     (try_begin),
##       (is_between, "$g_encountered_party", centers_begin, centers_end),
##       (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##     (else_try),
##       (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##     (try_end),
     (str_store_string, s2, "@{s9} asked you to take a message to {s13}. {s13} was believed to be at {s4} when you were given this quest."),
   ]],

  [anyone|plyr,"lord_mission_deliver_message", [], "Certainly, I was planning to pass by {s4}.", "lord_mission_deliver_message_accepted",[]],
  [anyone|plyr,"lord_mission_deliver_message", [], "I doubt I'll be seeing {s13} any time soon, {s65}. You had best send it with a courier.", "lord_mission_deliver_message_rejected",[]],
  [anyone|plyr,"lord_mission_deliver_message", [], "I am no errand boy, sir. Hire a courier.", "lord_mission_deliver_message_rejected_rudely",[]],

  [anyone,"lord_mission_deliver_message_accepted", [], "Thank you, {playername}. Here is the letter, and a small sum to cover your travel expenses. Give my regards to {s13} when you see him.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_troop_add_gold", "trp_player",30),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",1),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_mission_deliver_message_rejected", [], "Ah, very well then. I am sure I will find someone else.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],
  
  [anyone,"lord_mission_deliver_message_rejected_rudely", [], "Hmm, is this how you respond to a polite request for a small favor? Poor show, {playername}. I am surprised that you would take offence.", "lord_mission_deliver_message_rejected_rudely_2",[]],
    
  [anyone|plyr,"lord_mission_deliver_message_rejected_rudely_2", [], "Then you shall know better from now on.", "lord_mission_deliver_message_rejected_rudely_3",[]],
  [anyone|plyr,"lord_mission_deliver_message_rejected_rudely_2", [], "Forgive my temper, {s65}. I will deliver your letter.", "lord_mission_deliver_message_accepted",[]],

  [anyone,"lord_mission_deliver_message_rejected_rudely_3", [], "Indeed. I will remember...", "close_window",[
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",-4),
    (quest_set_slot, "$random_quest_no", slot_quest_dont_give_again_remaining_days, 150),
    (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),    
    (assign, "$g_leave_encounter",1),
      ]],

  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_deliver_message_to_enemy_lord")],
   "I need a letter delivered to {s13} of {s15}, who is currently at {s4}. If you are traveling in that direction, would you deliver my letter to him? The letter needs to reach him within 40 days.", "lord_mission_deliver_message",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_troop_name_link,s9,"$g_talk_troop"),
##     (str_store_party_name,2,"$g_encountered_party"),
     (str_store_troop_name_link,s13,":quest_target_troop"),
     (str_store_party_name_link,s4,":quest_target_center"),
     (store_troop_faction, ":target_faction", ":quest_target_troop"),
     (str_store_faction_name_link,s15,":target_faction"),
     (setup_quest_text,"$random_quest_no"),
##     (try_begin),
##       (is_between, "$g_encountered_party", centers_begin, centers_end),
##       (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##     (else_try),
##       (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##     (try_end),
     (str_store_string, s2, "@{s9} asked you to take a message to {s13} of {s15}. {s13} was believed to be at {s4} when you were given this quest."),
   ]],

  
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_deliver_message_to_lover")],
##   "My dear friend, I have a deep affection for {s3} and I believe she feels the same way for me as well.\
## Alas, her father {s5} finds me unsuitable for her and will do anything to prevent our union.\
## I really need your help. Please, will you take this letter to her? She should be at {s4} at the moment.", "lord_mission_told",
##   [
##     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##     (str_store_troop_name_link,1,"$g_talk_troop"),
##     (str_store_party_name_link,2,"$g_encountered_party"),
##     (str_store_troop_name_link,3,":quest_target_troop"),
##     (str_store_party_name_link,4,":quest_target_center"),
##     (setup_quest_text,"$random_quest_no"),
##     (try_begin),
##       (is_between, "$g_encountered_party", centers_begin, centers_end),
##       (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##     (else_try),
##       (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##     (try_end),
##   ]],
##
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_escort_lady")],
   "There is one small matter... My {s17} {s13} is due to visit her relatives at {s14}. In fact, the visit has been postponed several times already, what with all the trouble on the roads -- but this time she is adamant about going. So I would at least like to make sure she's well-guarded. I trust you well, {playername}, and I would be very grateful if you could escort her to {s14} and make sure she arrives safely.", "lord_mission_told",
   [
     (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (try_begin),
       (troop_slot_eq, "$g_talk_troop", slot_troop_daughter, ":quest_object_troop"),
       (str_store_string, s17, "str_daughter"),
     (else_try),
       (str_store_string, s17, "str_wife"),
     (try_end),
     (str_store_troop_name_link, s11, "$g_talk_troop"),
     (str_store_troop_name_link, s13, ":quest_object_troop"),
     (str_store_party_name_link, s14, ":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s11} asked you to escort his {s17} {s13} to {s14}."),
   ]],

##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_hunt_down_raiders")],
## "A messenger came with important news a few hours ago.\
## A group of enemy raiders have attacked a village near {s3}.\
## They have murdered anyone who tried to resist, stolen everything they could carry and put the rest to fire.\
## Now, they must be on their way back to their base at {s4}.\
## You must catch them on the way and make them pay for their crimes.", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_object_center", "$random_quest_no", slot_quest_object_center),
##       (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##       (str_store_party_name_link,3,":quest_object_center"),
##       (str_store_party_name_link,4,":quest_target_center"),
##    ]],
##  
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_bring_back_deserters")],
## "I am worried about the growing number of deserters. If we don't do something about it, we may soon have noone left to fight in our wars.\
## I want you to go now and bring back {reg1} {s3}. I would ask you to hang the bastards but we are short of men and we need them back in the ranks.", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
##       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##      
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name_plural,3,":quest_target_troop"),
##       (assign, reg1, ":quest_target_amount"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_deliver_supply_to_center_under_siege")],
## "The enemy has besieged {s5}. Our brothers there are doing their best to fend off attacks, but they can't hold for long without supplies.\
## We need someone to take the supplies they need and make it into the town as soon as possible.\
## It's a very dangerous job, but if there's one person who can do it, it's you {playername}.\
## You can take the supplies from seneschal {s3}. When you arrive at {s5}, give them to the seneschal of that town.", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
##       (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##       (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##      
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name_link,3,":quest_object_troop"),
##       (str_store_troop_name,4,":quest_target_troop"),
##       (str_store_party_name_link,5,":quest_target_center"),
##       (assign, reg1, ":quest_target_amount"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_bring_reinforcements_to_siege")],
## "{s4} has besieged {s5} and God willing, that town will not hold for long.\
## Still I promised him to send {reg1} {s3} as reinforcements and I need someone to lead those men.\
## Can you take them to {s4}?", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
##       (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##       (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##      
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name_plural,3,":quest_object_troop"),
##       (str_store_troop_name_link,4,":quest_target_troop"),
##       (str_store_party_name_link,5,":quest_target_center"),
##       (assign, reg1, ":quest_target_amount"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_rescue_lady_under_siege")],
## "The enemy has besieged {s4} and my dear {s7} {s3} has been trapped within the town walls.\
## As you may guess, I am greatly distressed by this. I need a very reliable commander, to rescue her from the town and bring her back to me.\
## Will you do that {playername}?", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##       (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##
##       (try_begin),
##         (troop_slot_eq, "$g_talk_troop", slot_troop_daughter, ":quest_object_troop"),
##         (str_store_string, s7, "str_daughter"),
##       (else_try),
##         (str_store_string, s7, "str_wife"),
##       (try_end),
##      
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name_link,3,":quest_object_troop"),
##       (str_store_party_name_link,4,":quest_target_center"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_bring_prisoners_to_enemy")],
##   "The enemy wants to ransom some of their soldiers that we captured at the last battle.\
## They'll pay 100 denars in return for giving them back {reg1} {s3}.\
## God knows I can use that money so I accepted their offer.\
## Now, what I need is someone to take the prisoners to {s4} and come back with the money.", "lord_mission_told",
##   [
##     (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##     (quest_get_slot, reg1, "$random_quest_no", slot_quest_target_amount),
##     (str_store_troop_name_link,1,"$g_talk_troop"),
##     (str_store_party_name_link,2,"$g_encountered_party"),
##     (str_store_troop_name_plural,3,":quest_object_troop"),
##     (str_store_party_name_link,4,":quest_target_center"),
##     (setup_quest_text,"$random_quest_no"),
##     (try_begin),
##       (is_between, "$g_encountered_party", centers_begin, centers_end),
##       (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##     (else_try),
##       (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##     (try_end),
##   ]],
##


# Deal with bandits
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_deal_with_bandits_at_lords_village")],
   "A group of bandits have taken refuge in my village of {s1}. They plunder the nearby farms, feasting upon my cattle and stealing my taxes. I should like nothing better than to ride out there and teach them a lesson, but I have my hands full at the moment, so I cannot handle the problem personally.", "lord_mission_deal_with_bandits_told",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_party_name_link,s15,":quest_target_center"),
     (str_store_troop_name_link,s13,"$g_talk_troop"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s13} asked you to deal with the bandits who are occupying the village of {s15} and then report back to him."),
   ]],

  [anyone|plyr,"lord_mission_deal_with_bandits_told", [],
   "Worry not, I shall go to {s1} and deal with these scum for you.", "lord_mission_deal_with_bandits_accepted",[]],
  [anyone|plyr,"lord_mission_deal_with_bandits_told", [], "You shall have to find help elsewhere. I too am busy.", "lord_mission_deal_with_bandits_rejected",[]],

  [anyone,"lord_mission_deal_with_bandits_accepted", [], "Would you do that? Many thanks -- and know that I will be most grateful to you. Here, take this for the expenses of your campaign. And make an example of those bastards for me!", "close_window",
   [

    (troop_get_slot, ":insult_string", "$g_talk_troop", slot_lord_reputation_type),
    (val_add, ":insult_string", "str_lord_insult_default"),
    (str_store_string, 44, ":insult_string"),

    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_troop_add_gold", "trp_player", 200),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_mission_deal_with_bandits_rejected", [], "Ah... Very well then, forget I mentioned it.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],

# Raise troops
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_raise_troops")],
   "It shames me to say this, {playername}, but I was inspecting my soldiers the other day, and found several who scarcely know which end of the sword to hold. {s44} You are a warrior of some renown, {playername}. Will you perhaps train some of these muddlers for me? I would be most grateful to you.", "lord_tell_mission_raise_troops",[
    (troop_get_slot, ":training_string", "$g_talk_troop", slot_lord_reputation_type),
    (val_add, ":training_string", "str_troop_train_request_default"),
    (str_store_string, 44, ":training_string")
     ]],

  [anyone|plyr,"lord_tell_mission_raise_troops", [], "How many men do you need?", "lord_tell_mission_raise_troops_2",[]],

  [anyone,"lord_tell_mission_raise_troops_2", [], "I need capable {s14}, numbering {reg1}. Bring them to me when their training is complete.", "lord_mission_raise_troops_told",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
     (quest_get_slot, reg1, "$random_quest_no", slot_quest_target_amount),
     (str_store_troop_name_link,s9,"$g_talk_troop"),
     (str_store_troop_name_plural,s14,":quest_target_troop"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s9} asked you to raise {reg1} {s14} and bring them to him."),
   ]],

  [anyone|plyr,"lord_mission_raise_troops_told", [(quest_get_slot, reg1, "$random_quest_no", slot_quest_target_amount)],
   "Of course, {s65}. Give me {reg1} fresh recruits and I'll train them to be {s14}.", "lord_mission_raise_troops_accepted",[]],
  [anyone|plyr,"lord_mission_raise_troops_told", [], "I am too busy these days to handle the training of recruits.", "lord_mission_raise_troops_rejected",[]],

  [anyone,"lord_mission_raise_troops_accepted", [], "You have taken a great weight off my shoulders, {playername}. I shall tell my sergeants to convey these recruits to your command. Also, I'll advance you some money to help cover your expenses. Here, take this purse, and my thanks for your help.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_troop_add_gold", "trp_player", 100),
    (quest_get_slot, ":recruit_troop", "$random_quest_no", slot_quest_object_troop),
    (quest_get_slot, ":num_recruits", "$random_quest_no", slot_quest_target_amount),
    (party_add_members, "p_main_party", ":recruit_troop", ":num_recruits"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",2),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_mission_raise_troops_rejected", [], "Oh, of course. I should have expected as much. Well, good luck to you then.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],
  

#Collect Taxes
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_collect_taxes"),
                                (assign, reg9, 0),
                                (try_begin),
                                  (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
                                  (party_slot_eq, ":quest_target_center", slot_party_type, spt_town),
                                  (assign, reg9, 1),
                                (try_end),
                                ], "You probably know that I am the lord of the {reg9?town:village} of {s3}. However, it has been months since {s3} has delivered its taxes and rents due to me, its rightful lord. Apparently, the populace there has grown unruly of late, and I shall have to send someone there to remind them of their obligations. And to... persuade them if they refuse to listen to reason. If you go there and raise the taxes they owe, I shall grant you one-fifth of everything you collect.", "lord_mission_collect_taxes_told",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_troop_name_link,s9,"$g_talk_troop"),
     (str_store_party_name_link,s3,":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s9} asked you to collect taxes from {s3}. He offered to leave you one-fifth of all the money you collect there."),
   ]],

  [anyone|plyr,"lord_mission_collect_taxes_told", [],
   "A fair offer, {s65}. We have an agreement.", "lord_mission_collect_taxes_accepted",[]],
  [anyone|plyr,"lord_mission_collect_taxes_told", [], "Forgive me, but I don't have the time.", "lord_mission_collect_taxes_rejected",[]],

  [anyone,"lord_mission_collect_taxes_accepted", [], "Welcome news, {playername}. I shall entrust this matter to you. Remember, those {reg9?townsmen:peasants} are foxes and devils. They will make every excuse not to pay me my rightful incomes. Do not listen to their lies.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",2),
    (assign, "$g_leave_encounter",1),
    (assign, reg9, 0),
    (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
    (try_begin),
      (party_slot_eq, ":quest_target_center", slot_party_type, spt_town),
      (assign, reg9, 1),
    (try_end),
   ]],
  
  [anyone,"lord_mission_collect_taxes_rejected", [], "Ah, very well then. Well, good luck to you.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],

#Hunt down fugitive
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_hunt_down_fugitive")],
   "I have something you could help with -- it involves the lawless villain known as {s4}. He murdered one of my men, and has been on the run from justice ever since. I cannot afford to let him get away with this, so I've put a bounty of 300 thaler on his head. Some friends of the murdered man reckon that this assassin may have taken refuge with his kinsmen at {s3}. You might be able to hunt him down there and give him what he deserves -- and claim the bounty for yourself!", "lord_mission_hunt_down_fugitive_told",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (quest_get_slot, ":quest_target_dna", "$random_quest_no", slot_quest_target_dna),
     (str_store_troop_name_link,s9, "$g_talk_troop"),
     (str_store_party_name_link,s3, ":quest_target_center"),
     (call_script, "script_get_name_from_dna_to_s50", ":quest_target_dna"),
     (str_store_string, s4, s50),
     (setup_quest_text, "$random_quest_no"),
     (str_store_string, s2, "@{s9} asked you to hunt down a fugitive named {s4}. He is currently believed to be at {s3}."),
   ]],

  [anyone|plyr,"lord_mission_hunt_down_fugitive_told", [],
   "Then I shall hunt down this snake, and execute the law.", "lord_mission_hunt_down_fugitive_accepted",[]],
  [anyone|plyr,"lord_mission_hunt_down_fugitive_told", [], "I am too busy to go after him at the moment.", "lord_mission_hunt_down_fugitive_rejected",[]],

  [anyone,"lord_mission_hunt_down_fugitive_accepted", [], "Marvelous, {playername}. I would be most grateful to you, as will the family of the man he murdered. Well, good hunting to you.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_mission_hunt_down_fugitive_rejected", [], "As you wish, {playername}. I suppose there are plenty of bounty hunters around that might get the job done...", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],



##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_capture_messenger")],
##   "The enemy seems to be preparing for some kind of action and I want to know what their plans are.\
## Capture one of their messengers and bring him to me.", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##      
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name,3,":quest_target_troop"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##   ]],
##
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_kill_local_merchant")],
   "The wretched truth is that I owe a considerable sum of money to one of the merchants here in {s3}. I have no intention of paying it back, of course, but that loud-mouthed fool is making a terrible fuss about it. He even had the audacity to come and threaten me with a letter of complaint to the trade guilds and bankers. Why, he would ruin my reputation! So I need a {man/woman} I can trust, someone who will guarantee the man's silence. For good.", "lord_mission_told_kill_local_merchant",
   [
       (str_store_troop_name_link,s9,"$g_talk_troop"),
       (str_store_party_name_link,s3,"$current_town"),
       (setup_quest_text,"$random_quest_no"),
       (str_store_string, s2, "@{s9} asked you to assassinate a local merchant at {s3}."),
   ]],
  
  [anyone|plyr,"lord_mission_told_kill_local_merchant", [], "Worry not, he shan't breathe another word.", "lord_mission_accepted_kill_local_merchant",[]],
  [anyone|plyr,"lord_mission_told_kill_local_merchant", [], "I'm no common murderer, sir.", "lord_mission_rejected",[]],

  [anyone,"lord_mission_accepted_kill_local_merchant", [], "Very good. I trust in your skill and discretion, {playername}. Do not disappoint me. Go now and wait for my word. I shall dispatch a message telling you when and where you can find this merchant. Dispose of him for me, and I shall reward you generously.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (assign, "$g_leave_town",1),
    (assign, "$qst_kill_local_merchant_center", "$current_town"),
    (rest_for_hours, 10, 4, 0),
    (finish_mission),
    ]],

  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_meet_spy_in_enemy_town"),
                                (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
                                (str_store_party_name, s13, ":quest_target_center"),
                                (store_faction_of_party,":quest_target_center_faction",),
                                (str_store_faction_name, s14, ":quest_target_center_faction"),
                                ],
   "I have a delicate matter which needs tending to, {playername} -- and there is no one I can trust to handle it for me. The fact is that I have placed a spy in {s13} to keep an eye on things for me, and report anything that might warrant my attention. Every week I send someone to collect the spy's reports and bring them back here to me. The job is yours if you want it.", "lord_mission_told_meet_spy_in_enemy_town",
   [
   ]],

  [anyone|plyr,"lord_mission_told_meet_spy_in_enemy_town", [], "Sounds interesting -- a bit of espionage. Count me in.", "quest_meet_spy_in_enemy_town_accepted",[]],
  [anyone|plyr,"lord_mission_told_meet_spy_in_enemy_town", [], "I'm afraid I must decline. Cloak-and-dagger work isn't fit for me.", "quest_meet_spy_in_enemy_town_rejected",[]],

  [anyone,"quest_meet_spy_in_enemy_town_accepted", [], "Excellent! Make your way to {s13} as soon as you can. The spy will be waiting.", "quest_meet_spy_in_enemy_town_accepted_response",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (quest_get_slot, ":secret_sign", "$random_quest_no", slot_quest_target_amount),
     (store_sub, ":countersign", ":secret_sign", secret_signs_begin),
     (val_add, ":countersign", countersigns_begin),
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (str_store_string, s11, ":secret_sign"),
     (str_store_string, s12, ":countersign"),
     (str_store_party_name_link, s13, ":quest_target_center"),
     (setup_quest_text, "$random_quest_no"),
     (str_store_string, s2, "@{s9} has asked you to meet with a spy in {s13}."),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     (call_script, "script_cf_center_get_free_walker", ":quest_target_center"),
     (call_script, "script_center_set_walker_to_type", ":quest_target_center", reg0, walkert_spy),
     (str_store_item_name,s14,"$spy_item_worn"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
     (assign, "$g_leave_encounter",1),
    ]],
  [anyone|plyr,"quest_meet_spy_in_enemy_town_accepted_response", [(quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
                                                                  (str_store_party_name_link, s13, ":quest_target_center")],
   "{s13} is heavily defended. How can I even get close without being noticed?", "quest_meet_spy_in_enemy_town_accepted_2",
   []],
  [anyone,"quest_meet_spy_in_enemy_town_accepted_2", [], "You shall have to use stealth. Take care to avoid enemy strongholds, villages, and patrols -- and don't bring too many men with you. If you fail to sneak in the first time, wait a while for the garrison to lower its guard again, or you may have a difficult time infiltrating the town.", "quest_meet_spy_in_enemy_town_accepted_response",
   []],
  [anyone|plyr,"quest_meet_spy_in_enemy_town_accepted_response", [], "How will I recognize the spy?", "quest_meet_spy_in_enemy_town_accepted_3",
   []],
  [anyone,"quest_meet_spy_in_enemy_town_accepted_3", [(quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
                                                      (str_store_party_name_link, s13, ":quest_target_center"),
                                                      (troop_get_type, reg7, "$spy_quest_troop"),
                                                      (quest_get_slot, ":secret_sign", "$random_quest_no", slot_quest_target_amount),
                                                      (store_sub, ":countersign", ":secret_sign", secret_signs_begin),
                                                      (val_add, ":countersign", countersigns_begin),
                                                      (str_store_string, s11, ":secret_sign"),
                                                      (str_store_string, s12, ":countersign"),],
   "Once you arrive in {s13}, speak with the locals -- the spy will be one of them. If you think you've found the spy, say the phrase '{s11}' The spy will respond with the phrase '{s12}'. Thus you will know the other, and {reg7?she:he} will give you any information {reg7?she:he}'s gathered in my service.", "quest_meet_spy_in_enemy_town_accepted_response",
   []],
  [anyone|plyr,"quest_meet_spy_in_enemy_town_accepted_response", [], "Will I be paid for my labors?", "quest_meet_spy_in_enemy_town_accepted_4",
   []],
  [anyone,"quest_meet_spy_in_enemy_town_accepted_4", [], "Of course, I have plenty of silver in my coffers for loyal {men/women} such as yourself. Do well by me, {playername}, and you shall rise high.", "quest_meet_spy_in_enemy_town_accepted_response",
   []],
  [anyone|plyr,"quest_meet_spy_in_enemy_town_accepted_response", [], "I know what to do. Farewell, my lord.", "quest_meet_spy_in_enemy_town_accepted_end",
   []],
  [anyone,"quest_meet_spy_in_enemy_town_accepted_end", [(quest_get_slot, ":secret_sign", "$random_quest_no", slot_quest_target_amount),
                                                        (store_sub, ":countersign", ":secret_sign", secret_signs_begin),
                                                        (val_add, ":countersign", countersigns_begin),
                                                        (str_store_string, s11, ":secret_sign"),
                                                        (str_store_string, s12, ":countersign")],
   "Good luck, {playername}. Remember, the secret phrase is '{s11}' and the counterphrase is '{s12}'. Bring any reports back to me, and I shall reward you with an open hand.", "lord_pretalk",
   []],

  [anyone,"quest_meet_spy_in_enemy_town_rejected", [], "As you wish, {playername} -- but I strongly advise you to forget anything I might have mentioned about any spies. I have no such people in my employ, and I never have. And no one would ever find me making use of such men. Remember that.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],


    

  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_raid_caravan_to_start_war"),
                                (quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
                                (str_store_faction_name_link, s13, ":quest_target_faction")],
   "This peace with {s13} ill suits me, {playername}. We have let those swine have their way for far too long. Now they grow stronger with each passing day, and their arrogance knows no bounds. I say we should wage war on them before it's too late! Unfortunately, some of the bleeding hearts among our realm's lords are blocking the declaration of war. -- Witless cowards with no stomach for blood!", "lord_mission_told_raid_caravan_to_start_war",
   [
   ]],

  [anyone|plyr,"lord_mission_told_raid_caravan_to_start_war", [], "You are right, {s65}, but what can we do?", "lord_mission_tell_raid_caravan_to_start_war_2",[]],
  [anyone|plyr,"lord_mission_told_raid_caravan_to_start_war", [], "I disagree, sir. Peace is preferable to war.", "quest_raid_caravan_to_start_war_rejected_1",[]],

  [anyone,"lord_mission_tell_raid_caravan_to_start_war_2", [(quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
                                                            (str_store_faction_name_link, s13, ":quest_target_faction")],
   "Ah, 'tis good to hear a like-minded soul! As a matter of fact, there is something we can do, {playername} -- a little bit of provocation. The dogs in {s13} are very fond of their merchant carts, and rely on them overmuch. If one of our war parties managed to enter their territory and pillage some of their carts, they would have ample motive to declare war on us. And then, well, even the cowards amongst us would be forced to rise up -- if only to defend themselves. So what say you? Are you interested?", "lord_mission_tell_raid_caravan_to_start_war_3",[]],

  [anyone|plyr,"lord_mission_tell_raid_caravan_to_start_war_3", [], "An excellent plan. Count me in.", "quest_raid_caravan_to_start_war_accepted",[]],
  [anyone|plyr,"lord_mission_tell_raid_caravan_to_start_war_3", [], "Why do you ask me? Are your own men incapable of dealing with a few merchants?", "lord_mission_tell_raid_caravan_to_start_war_4",[]],

  [anyone,"lord_mission_tell_raid_caravan_to_start_war_4", [
  	], "Well, {playername}, some of my subjects would not look too fondly upon a ruler who would incite war without their consent. Many of them are already looking for an excuse to get at me, and if I did this they could make me pay for it dearly. You, on the other hand, are young, well-liked and daring, so you might just get away with it. And then of course I will throw my support behind you and defend your actions against your opponents. All in all, a few of our high and mighty might be upset at your endeavor, but I am sure you won't be terribly bothered with that.", "lord_mission_tell_raid_caravan_to_start_war_5",[]],

  [anyone|plyr,"lord_mission_tell_raid_caravan_to_start_war_5", [], "Then I will go and raid those carts at your behest.", "quest_raid_caravan_to_start_war_accepted",[]],
  [anyone|plyr,"lord_mission_tell_raid_caravan_to_start_war_5", [], "I don't like this. Find yourself someone else to take the blame for your schemes.", "quest_raid_caravan_to_start_war_rejected_2",[]],

  [anyone,"quest_raid_caravan_to_start_war_accepted", [], "Very good! Now, if I were you, I'd try to capture and loot at least {reg13} caravan carts, to make sure you really infuriate those fools in {s13}. With that done, return to me -- and make sure you keep away from their patrols. If they catch you, our plan will certainly fail, and you'll be facing a long time in their prisons. Go on now, and good luck to you -- and good hunting!", "close_window",
   [
     (quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
     (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
     (str_store_troop_name_link, s9, "$g_talk_troop"),
     (str_store_faction_name_link, s13, ":quest_target_faction"),
     (assign, reg13, ":quest_target_amount"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s9} asked you to capture and loot {reg13} caravans so as to provoke a war with {s13}."),
	 (quest_set_slot, "$random_quest_no", slot_quest_current_state, 0),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     (call_script, "script_change_player_relation_with_troop","$g_talk_troop",5),
     (assign, "$g_leave_encounter",1),
    ]],


  [anyone,"quest_raid_caravan_to_start_war_rejected_1", [], "Ah, you think so? But how long will your precious peace last? Not long, believe me.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],
  [anyone,"quest_raid_caravan_to_start_war_rejected_2", [], "Hmm. As you wish, {playername}. I thought you had some fire in you, but it seems I was mistaken.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],


  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_bring_back_runaway_serfs")],
 "Some of the serfs working my fields in {s4} have run away. The ungrateful swine! I let them plough my fields and rent my cottages, and this is how they repay me! From what I've been hearing, they're running toward {s3} as fast as they can, and they've split up into three groups in an attempt to avoid capture. I want you to capture all three groups, and take them back to {s4} by whatever means necessary. I should really have them hung for attempting to escape, but we'll need every hand for the upcoming harvest. I suppose I'll have to let them off this time with a good beating.", "lord_mission_told",
   [
       (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
       (quest_get_slot, ":quest_object_center", "$random_quest_no", slot_quest_object_center),
      
       (str_store_troop_name_link, s9, "$g_talk_troop"),
       (str_store_party_name_link, s3, ":quest_target_center"),
       (str_store_party_name_link, s4, ":quest_object_center"),
       (setup_quest_text,"$random_quest_no"),
       (str_store_string, s2, "@{s9} asked you to catch the three groups of runaway serfs and bring them back to {s4}, alive and breathing. He said that all three groups are heading towards {s3}."),
    ]],

  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_follow_spy")],
 "I have it on good authority that there is a man in this very town who is actually an enemy spy. He must be seized and hanged for his impudence -- but we also believe that very soon he will be leaving town to meet with his master, the man to whom the spy feeds all his little whispers. The spy himself is of little import, but the master is a dangerous man, and might tell us a great deal if we could only get our hands on him...", "lord_tell_mission_follow_spy",[]],
  [anyone,"lord_tell_mission_follow_spy", [],
 "I want you to wait here until the spy leaves town. Then you must follow him, stealthily, to the meeting place. You must take absolute care not to be seen by the spy on your way, or he may suspect foul play and turn back. When the master appears, you must swiftly ambush and arrest them both, and bring the pair back to me. Alive, if you please.", "lord_tell_mission_follow_spy_2",
   [
    ]],

  [anyone|plyr, "lord_tell_mission_follow_spy_2", [],
 "I'll do it, {s65}.", "lord_tell_mission_follow_spy_accepted", []],
  [anyone|plyr, "lord_tell_mission_follow_spy_2", [],
 "No, I don't have the time for this.", "lord_tell_mission_follow_spy_rejected", []],


  [anyone,"lord_tell_mission_follow_spy_accepted", [],
   "Good! I'm sure I can count on you. One of my men will point out the spy for you when he leaves, so you'll know who to follow. Remember, I want them both, and I want them alive!", "close_window",
   [
     (str_store_troop_name_link, s11, "$g_talk_troop"),
     (str_store_party_name_link, s12, "$g_encountered_party"),
     (setup_quest_text, "$random_quest_no"),
     (str_store_string, s2, "@{s11} asked you to follow the spy that will leave {s12}. Be careful not to let the spy see you on the way, or he may get suspicious and turn back. Once the spy meets with his accomplice, you are to capture them and bring them back to {s11}."),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),

     (spawn_around_party, "p_main_party", "pt_spy_partners"),
     (assign, "$qst_follow_spy_spy_partners_party", reg0),
     (party_set_position, "$qst_follow_spy_spy_partners_party", pos63),
     (party_set_ai_behavior, "$qst_follow_spy_spy_partners_party", ai_bhvr_hold),
     (party_set_flags, "$qst_follow_spy_spy_partners_party", pf_default_behavior, 0),
     (set_spawn_radius, 0),
     (spawn_around_party, "$g_encountered_party", "pt_spy"),
     (assign, "$qst_follow_spy_spy_party", reg0),
     (party_set_ai_behavior, "$qst_follow_spy_spy_party", ai_bhvr_travel_to_party),
     (party_set_ai_object, "$qst_follow_spy_spy_party", "$qst_follow_spy_spy_partners_party"),
     (party_set_flags, "$qst_follow_spy_spy_party", pf_default_behavior, 0),
     (assign, "$g_leave_town", 1),
     (rest_for_hours, 2, 4, 0),
     #no need to set g_leave_encounter to 1 since this quest can only be given at a town
   ]],

  [anyone,"lord_tell_mission_follow_spy_rejected", [],
   "What a shame. Ah well, carry on as you were, {playername}...", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],




  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_capture_enemy_hero")],
 "There is a difficult job I need done, {playername}, and you may be just the one who can carry it off. I need someone to capture one of the nobles of {s13} and bring him to me. Afterwards, I'll be able to exchange for a relative of mine who is currently being held by {s13}. It is a simple enough job, but whomever you target will be guarded by an elite band of personal retainers. Are you up for that kind of fight?", "lord_tell_mission_capture_enemy_hero",
   [
     (quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
     (str_store_faction_name, s13, ":quest_target_faction"),
    ]],

  [anyone|plyr, "lord_tell_mission_capture_enemy_hero", [],
 "Consider it done, {s65}.", "lord_tell_mission_capture_enemy_hero_accepted", []],
  [anyone|plyr, "lord_tell_mission_capture_enemy_hero", [],
 "I must refuse, {s65}. I am no kidnapper.", "lord_tell_mission_capture_enemy_hero_rejected", []],

  [anyone,"lord_tell_mission_capture_enemy_hero_accepted", [],
   "I like your spirit! Go and bring me one of our enemies, and we shall toast your name in my hall upon you return! And reward you for your efforts, of course...", "close_window",
   [
     (quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
     (str_store_troop_name_link, s11, "$g_talk_troop"),
     (str_store_faction_name_link, s13, ":quest_target_faction"),
     (setup_quest_text, "$random_quest_no"),
     (str_store_string, s2, "@{s11} asked you to capture a lord from {s13}, any lord, and then drag your victim back to {s11} for safekeeping."),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 1),
     (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_tell_mission_capture_enemy_hero_rejected", [],
   "Clearly you lack the mettle I thought you possessed. Very well, I will find someone else.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],




  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_lend_companion")],
 "I don't have a job for you right now, but your companion {s3} is a skilled {reg3?lass:fellow}, and I need someone with {reg3?her:his} talents. Will you lend me {reg3?her:his} services for a while?", "lord_tell_mission_lend_companion",
   [
       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
       (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
       (val_add, ":quest_target_amount", 1),
       (assign, reg1, ":quest_target_amount"),
       (str_store_troop_name_link,s9,"$g_talk_troop"),
       (str_store_troop_name,s3,":quest_target_troop"),
       (setup_quest_text,"$random_quest_no"),
       (troop_get_type, reg3, ":quest_target_troop"),
       (str_store_string, s2, "@{s9} asked you to lend your companion {s3} to him for a week."),
    ]],
  [anyone|plyr,"lord_tell_mission_lend_companion", [],
 "How long will you be needing {reg3?her:him}?", "lord_tell_mission_lend_companion_2", []],
  [anyone,"lord_tell_mission_lend_companion_2", [],
 "Just a few days, or a week at the most.", "lord_mission_lend_companion_told", []],

  [anyone|plyr,"lord_mission_lend_companion_told",
   [(quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),(str_store_troop_name,s3,":quest_target_troop"),],
   "Then I will leave {s3} with you for one week.", "lord_tell_mission_lend_companion_accepted", []],
  [anyone|plyr,"lord_mission_lend_companion_told", [(quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
                                                    (str_store_troop_name,s3,":quest_target_troop"),],
   "I am sorry, but I cannot do without {s3} for a whole week.", "lord_tell_mission_lend_companion_rejected", []],

  [anyone,"lord_tell_mission_lend_companion_accepted", [],
   "I cannot thank you enough, {playername}. Worry not, your companion shall be returned to you with all due haste.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3),
    (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
    (party_remove_members, "p_main_party", ":quest_target_troop", 1),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_tell_mission_lend_companion_rejected", [],
   "Well, that's most unfortunate, but I suppose I cannot force you or {s3} to agree. I shall have to make do without.", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],

 
  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_collect_debt")],
   "Some time ago, I loaned a considerable sum of money to {s3}. {reg4} thaler, to be precise. He was supposed to pay it back within the month, but I haven't received a copper from him since, and this was months ago. If you could collect the debt from him on my behalf, I would be grateful indeed. I would even let you keep one fifth of the amount for your trouble. What say you?", "lord_tell_mission_collect_debt",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (quest_get_slot, reg4, "$random_quest_no", slot_quest_target_amount),
     (str_store_troop_name_link,s9,"$g_talk_troop"),
     (str_store_troop_name_link,s3,":quest_target_troop"),
     (str_store_party_name_link,s4,":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s9} asked you to collect the debt of {reg4} denars {s3} owes to him. {s3} was at {s4} when you were given this quest."),
   ]],
  [anyone|plyr,"lord_tell_mission_collect_debt", [],
 "Do you know where I can find {s3}, {s65}?", "lord_tell_mission_collect_debt_2", []],
  [anyone,"lord_tell_mission_collect_debt_2", [],
 "If you leave now and move quickly, you should be able to find him at {s4}. I've little doubt that he will be suitably embarrassed by his conduct, and will give you all the money he owes.", "lord_tell_mission_collect_debt_3", []],
  [anyone|plyr,"lord_tell_mission_collect_debt_3", [], "Then I will make sure {s3} returns the debt.", "lord_tell_mission_collect_debt_accepted", []],
  [anyone|plyr,"lord_tell_mission_collect_debt_3", [], "Forgive me, {s65}, but I believe it better to collect one's own debts in person.", "lord_tell_mission_collect_debt_rejected", []],

  [anyone,"lord_tell_mission_collect_debt_accepted", [], "You have made me very happy, {playername}. Please, talk to {s3}, and don't let him off unless he returns my money.", "close_window",
   [(call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",2),
    (assign, "$g_leave_encounter",1),
   ]],

  [anyone,"lord_tell_mission_collect_debt_rejected", [], "Perhaps you are right, {playername}. Ah, I suppose I'm never getting that money back...", "lord_pretalk",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1)]],
 
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_capture_conspirators")],
## "TODO: I want you to capture troops in {reg1} conspirator parties that plan to rebel against me and join {s3}.", "lord_mission_told",
##   [
##       (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
##       (assign, reg1, "$qst_capture_conspirators_num_parties_to_spawn"),
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (str_store_troop_name,3,":quest_target_troop"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##
##  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_defend_nobles_against_peasants")],
## "TODO: I want you to defend {reg1} noble parties against peasants.", "lord_mission_told",
##   [
##       (assign, reg1, "$qst_defend_nobles_against_peasants_num_noble_parties_to_spawn"),
##       (str_store_troop_name_link,1,"$g_talk_troop"),
##       (str_store_party_name_link,2,"$g_encountered_party"),
##       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
##    ]],
##
##
  [anyone,"lord_tell_mission", [(eq, "$random_quest_no", "qst_incriminate_loyal_commander"),
                                (quest_get_slot, ":quest_target_troop", "qst_incriminate_loyal_commander", slot_quest_target_troop),
                                (quest_get_slot, ":quest_object_troop", "qst_incriminate_loyal_commander", slot_quest_object_troop),
                                (quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
                                (str_store_troop_name_link, s13,":quest_target_troop"),
                                (str_store_party_name_link, s14,":quest_target_center"),
                                (str_store_troop_name_link, s15,":quest_object_troop"),
                                ],
 "I tell you, that blubbering fool {s13} is not fit to rule {s14}. God knows he would be divested of his lands in an instant, were it not for one of his loyal subjects, {s15}. As long as he has {s15} aiding him, taking him down will be a difficult job indeed. So I shall need to get {s15} out of the picture -- and I have a plan to do just that... With your help, naturally.", "lord_tell_mission_incriminate_commander",[]],

  [anyone|plyr,"lord_tell_mission_incriminate_commander", [], "I am all ears, {s66}.", "lord_tell_mission_incriminate_commander_2",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander", [], "I don't wish to involve myself in anything dishonorable against {s15}.", "lord_tell_mission_incriminate_commander_rejected",[]],

  [anyone,"lord_tell_mission_incriminate_commander_rejected", [], "Dishonorable? Bah! I was hoping I could count on you, {playername}, but you've shown me what a fool I was to entertain such hopes. I shall have to find someone else -- someone whose loyalty I can trust.", "lord_pretalk",
   [(call_script, "script_change_player_relation_with_troop","$g_talk_troop",-5),
    (call_script, "script_change_player_honor", 2)]],

  [anyone,"lord_tell_mission_incriminate_commander_2", [], "I have written a letter addressed to {s15}, bearing my own seal, which implicates him in a plan to stage a coup in {s14}, in my favor. There is no such plan and {s15} is innocent of course. But if we can make {s13} believe the letter is genuine, he will deal with {s15} very swiftly. Of course, the challenge is to convince {s13} that the letter is indeed real...", "lord_tell_mission_incriminate_commander_3",[]],

  [anyone|plyr,"lord_tell_mission_incriminate_commander_3", [], "Please continue, {s65}...", "lord_tell_mission_incriminate_commander_4",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander_3", [], "No, I shall not sully myself with such dishonorable schemes.", "lord_tell_mission_incriminate_commander_rejected",[]],

  [anyone,"lord_tell_mission_incriminate_commander_4", [], "This is where you come into play. You shall take the letter to {s14}, convey it to one of your soldiers, and instruct him to deliver it to {s15}. Meanwhile, I shall have one of my spies inform the town garrison, so that your man will be arrested along the way. The guards will then find the letter and take it to {s13}. They'll torture your man, of course, to try and get the truth out of him, but all he knows is that you ordered the letter to be delivered to {s15} under the utmost secrecy. {s13} knows you serve me, so the fool will most likely believe the whole charade, and turn upon one of his allies.", "lord_tell_mission_incriminate_commander_5",[]],
  
  [anyone|plyr,"lord_tell_mission_incriminate_commander_5", [], "Is that all?", "lord_tell_mission_incriminate_commander_7",[]],
  [anyone,"lord_tell_mission_incriminate_commander_7", [(str_store_troop_name, s8, "$incriminate_quest_sacrificed_troop"),
                                                        (str_store_troop_name_plural, s9, "$incriminate_quest_sacrificed_troop"),
      ], "There is one other matter... Your messenger must be someone trustworthy. If you sent the letter with a simple peasant, someone expendable, {s13} might suspect a plot. He may have the wits of a snail, but even a snail can see what's right in front of him. Give the letter to someone of rank. One of your {s9}, perhaps.", "lord_tell_mission_incriminate_commander_8",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander_8", [], "What? I can't send one of my trusted {s9} to his death!", "lord_tell_mission_incriminate_commander_9",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander_8", [], "Then a {s8} it will be.", "lord_tell_mission_incriminate_commander_fin",[]],
  [anyone,"lord_tell_mission_incriminate_commander_9", [], "Come now, {playername}. There is a place for sentimentality, but this is not it. Believe me, you shall be generously compensated, and what is the purpose of our soldiers, if not to die at our orders?", "lord_tell_mission_incriminate_commander_10",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander_10", [], "Very well, a {s8} it shall be.", "lord_tell_mission_incriminate_commander_fin",[]],
  [anyone|plyr,"lord_tell_mission_incriminate_commander_10", [], "No, I'll not sacrifice one of my best men.", "lord_tell_mission_incriminate_commander_rejected",[]],
   
 [anyone,"lord_tell_mission_incriminate_commander_fin", [], "I can't tell you how pleased I am to hear you say this, {playername}. You are removing one of the greatest obstacles in my path. Here is the letter, as well as 300 thaler for your expenses. Remember, there'll be more if you should succeed. Much, much more...", "lord_pretalk",
   [
       (quest_get_slot, ":quest_target_troop", "qst_incriminate_loyal_commander", slot_quest_target_troop),
       (quest_get_slot, ":quest_object_troop", "qst_incriminate_loyal_commander", slot_quest_object_troop),
       (quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
       (call_script, "script_troop_add_gold", "trp_player", 300),
       (call_script, "script_change_player_relation_with_troop","$g_talk_troop",3),
       (str_store_troop_name_link, s11,"$g_talk_troop"),
       (str_store_troop_name_link, s13,":quest_target_troop"),
       (str_store_party_name_link, s14,":quest_target_center"),
       (str_store_troop_name_plural, s15,"$incriminate_quest_sacrificed_troop"),
       (str_store_troop_name_link, s16,":quest_object_troop"),
       (setup_quest_text,"$random_quest_no"),
       (str_store_string, s2, "@{s11} gave you a fake letter to fool {s13} into banishing his vassal {s16}.\
 You are to go near {s14}, give the letter to one of your {s15} and send him into the town as a messenger,\
 believing his orders to be genuine."),
       (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],

  [anyone,"lord_tell_mission", [(eq,"$random_quest_no","qst_capture_prisoners")],
 "A group of my soldiers were captured in a recent skirmish with the enemy. Thankfully, we have a mutual agreement on prisoner exchange, and they will release my men -- but naturally they demand we give them prisoners of equal rank and number. And such prisoners we do not currently have. So, I need a good {man/warrior} to find me {reg1} {s3} as prisoners, so that I can make the exchange.", "lord_mission_told",
   [
       (quest_get_slot, ":quest_target_troop", "qst_capture_prisoners", slot_quest_target_troop),
       (quest_get_slot, ":quest_target_amount", "qst_capture_prisoners", slot_quest_target_amount),
       (assign,reg1,":quest_target_amount"),
       (str_store_troop_name_link,s9,"$g_talk_troop"),
##       (str_store_party_name,2,"$g_encountered_party"),
       (str_store_troop_name_by_count,3,":quest_target_troop",":quest_target_amount"),
       (setup_quest_text,"$random_quest_no"),
##       (try_begin),
##         (is_between, "$g_encountered_party", centers_begin, centers_end),
##         (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##       (else_try),
##         (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##       (try_end),
       (str_store_string, s2, "@{s9} has requested you to bring him {reg1} {s3} as prisoners."),
    ]],
  

  [anyone,"lord_tell_mission", [], "No {playername}. I do not need your help at this time.", "lord_pretalk",[]],


  [anyone|plyr,"lord_mission_told", [], "You can count on me, {s65}.", "lord_mission_accepted",[]],
  [anyone|plyr,"lord_mission_told", [], "I fear I cannot accept such a mission at the moment.", "lord_mission_rejected",[]],

  [anyone,"lord_mission_accepted", [], "Excellent, {playername}, excellent. Do not fail me.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (try_begin),
      (eq, "$random_quest_no", "qst_escort_lady"),
      (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
      (troop_set_slot, ":quest_object_troop", slot_troop_cur_center, 0),
      (troop_join, ":quest_object_troop"),
##    (else_try),
##      (eq, "$random_quest_no", "qst_hunt_down_raiders"),
##      (quest_get_slot, ":quest_object_center", "$random_quest_no", slot_quest_object_center),
##      (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##      (quest_get_slot, ":quest_target_faction", "$random_quest_no", slot_quest_target_faction),
##      (set_spawn_radius, 3),
##      (call_script, "script_cf_create_kingdom_party", ":quest_target_faction", spt_raider),
###      (spawn_around_party,":quest_object_center",":quest_target_party_template"),
##      (assign, ":quest_target_party", reg0),
##      (party_relocate_near_party, reg0, ":quest_object_center"),
##      (quest_set_slot, "$random_quest_no", slot_quest_target_party, ":quest_target_party"),
##      (party_set_ai_behavior,":quest_target_party",ai_bhvr_travel_to_party),
##      (party_set_ai_object,":quest_target_party",":quest_target_center"),
##      (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
##      (party_set_faction,":quest_target_party",":quest_target_faction"),
##      (str_store_troop_name,1,"$g_talk_troop"),
##      (str_store_party_name,2,"$g_encountered_party"),
##      (str_store_party_name,3,":quest_object_center"),
##      (str_store_party_name,4,":quest_target_center"),
##      (setup_quest_text,"$random_quest_no"),
##      (try_begin),
##        (is_between, "$g_encountered_party", centers_begin, centers_end),
##        (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##      (else_try),
##        (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##      (try_end),
##    (else_try),
##      (eq, "$random_quest_no", "qst_bring_reinforcements_to_siege"),
##      (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##      (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
##      (troop_get_slot, ":cur_party", "$g_talk_troop", slot_troop_leaded_party),
##      (party_remove_members, ":cur_party", ":quest_object_troop", ":quest_target_amount"),
##      (party_add_members, "p_main_party", ":quest_object_troop", ":quest_target_amount"),
##    (else_try),
##      (eq, "$random_quest_no", "qst_bring_prisoners_to_enemy"),
##      (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
##      (quest_get_slot, ":quest_target_amount", "$random_quest_no", slot_quest_target_amount),
##      (party_add_prisoners, "p_main_party", ":quest_object_troop", ":quest_target_amount"),
    (else_try),
      (eq, "$random_quest_no", "qst_deliver_message_to_enemy_lord"),
      (call_script, "script_troop_add_gold", "trp_player", 10),
    (else_try),
      (eq, "$random_quest_no", "qst_bring_back_runaway_serfs"),
      (quest_get_slot, ":quest_giver_center", "$random_quest_no", slot_quest_giver_center),
      (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
      (quest_get_slot, ":quest_target_party_template", "$random_quest_no", slot_quest_target_party_template),

      (set_spawn_radius, 3),
      (spawn_around_party,":quest_giver_center",":quest_target_party_template"),
      (assign, "$qst_bring_back_runaway_serfs_party_1", reg0),
      (party_set_ai_behavior,"$qst_bring_back_runaway_serfs_party_1",ai_bhvr_travel_to_party),
      (party_set_ai_object,"$qst_bring_back_runaway_serfs_party_1",":quest_target_center"),
      (party_set_flags, "$qst_bring_back_runaway_serfs_party_1", pf_default_behavior, 0),
      (spawn_around_party,":quest_giver_center",":quest_target_party_template"),
      (assign, "$qst_bring_back_runaway_serfs_party_2", reg0),
      (party_set_ai_behavior,"$qst_bring_back_runaway_serfs_party_2",ai_bhvr_travel_to_party),
      (party_set_ai_object,"$qst_bring_back_runaway_serfs_party_2",":quest_target_center"),
      (party_set_flags, "$qst_bring_back_runaway_serfs_party_2", pf_default_behavior, 0),
      (spawn_around_party,":quest_giver_center",":quest_target_party_template"),
      (assign, "$qst_bring_back_runaway_serfs_party_3", reg0),
      (party_set_ai_behavior,"$qst_bring_back_runaway_serfs_party_3",ai_bhvr_travel_to_party),
      (party_set_ai_object,"$qst_bring_back_runaway_serfs_party_3",":quest_target_center"),
      (party_set_flags, "$qst_bring_back_runaway_serfs_party_3", pf_default_behavior, 0),
      (rest_for_hours, 1, 4),
##    (else_try),
##      (eq, "$random_quest_no", "qst_capture_conspirators"),
##      (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##      (spawn_around_party,"p_main_party","pt_conspirator_leader"),
##      (assign, "$qst_capture_conspirators_party_1", reg0),
##      (assign, "$qst_capture_conspirators_num_parties_spawned", 1),
##      (party_set_ai_behavior, "$qst_capture_conspirators_party_1", ai_bhvr_hold),
##      (party_set_flags, "$qst_capture_conspirators_party_1", pf_default_behavior, 0),
##      (party_get_position, pos1, ":quest_target_center"),
##      (call_script, "script_map_get_random_position_around_position_within_range", 17, 19),
##      (party_set_position, "$qst_capture_conspirators_party_1", pos2),
##      (party_get_num_companions, ":num_companions", "$qst_capture_conspirators_party_1"),
##      (val_add, "$qst_capture_conspirators_num_troops_to_capture", ":num_companions"),
##    (else_try),
##      (eq, "$random_quest_no", "qst_defend_nobles_against_peasants"),
##      (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
##      (set_spawn_radius, 9),
##      (try_for_range, ":unused", 0, "$qst_defend_nobles_against_peasants_num_peasant_parties_to_spawn"),
##        (spawn_around_party, ":quest_target_center", "pt_peasant_rebels"),
##        (try_begin),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_1", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_1", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_2", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_2", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_3", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_3", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_4", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_4", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_5", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_5", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_6", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_6", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_7", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_7", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_peasant_party_8", 0),
##          (assign, "$qst_defend_nobles_against_peasants_peasant_party_8", reg0),
##        (try_end),
##      (try_end),
##      (set_spawn_radius, 0),
##      (party_get_position, pos1, ":quest_target_center"),
##      (try_for_range, ":unused", 0, "$qst_defend_nobles_against_peasants_num_noble_parties_to_spawn"),
##        (spawn_around_party, ":quest_target_center", "pt_noble_refugees"),
##        (assign, ":cur_noble_party", reg0),
##        (party_set_ai_behavior, ":cur_noble_party", ai_bhvr_travel_to_party),
##        (party_set_ai_object, ":cur_noble_party", ":quest_target_center"),
##	    (party_set_flags, ":cur_noble_party", pf_default_behavior, 0),
##        (call_script, "script_map_get_random_position_around_position_within_range", 13, 17),
##        (party_set_position, ":cur_noble_party", pos2),
##        (party_get_num_companions, ":num_companions", ":cur_noble_party"),
##        (val_add, "$qst_defend_nobles_against_peasants_num_nobles_to_save", ":num_companions"),
##        (try_begin),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_1", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_1", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_2", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_2", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_3", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_3", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_4", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_4", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_5", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_5", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_6", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_6", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_7", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_7", reg0),
##        (else_try),
##          (le, "$qst_defend_nobles_against_peasants_noble_party_8", 0),
##          (assign, "$qst_defend_nobles_against_peasants_noble_party_8", reg0),
##        (try_end),
##      (try_end),
    (try_end),
    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    (try_begin),
      (eq, "$random_quest_no", "qst_lend_surgeon"),
      (assign, "$g_leave_town_outside", 1),
      (assign,"$auto_enter_town","$g_encountered_party"),
#      (store_current_hours, "$quest_given_time"),
      (rest_for_hours, 4),
      (assign, "$lord_requested_to_talk_to", "$g_talk_troop"),
    (try_end),
    ]],
  [anyone,"lord_mission_rejected", [], "Is that so? Well, I suppose you're just not up to the task. I shall have to look for someone of firmer mettle.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
    (try_begin),
      (quest_slot_eq, "$random_quest_no", slot_quest_dont_give_again_remaining_days, 0),
      (quest_set_slot, "$random_quest_no", slot_quest_dont_give_again_remaining_days, 1),
    (try_end),
    (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],


##### TODO: QUESTS COMMENT OUT END

#Leave
  [anyone|plyr,"lord_talk", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 1),
    (troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
							 (eq, 0, 1),
  ], "I must leave now.", "lord_leave_prison",[]],
  [anyone|plyr,"lord_talk", [(lt, "$g_talk_troop_faction_relation", 0)], "I must hurry...", "lord_leave",[]],
  [anyone|plyr,"lord_talk", [(ge, "$g_talk_troop_faction_relation", 0)], "I beg my leave of you.", "lord_leave",[]],

  [anyone,"lord_leave", [#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
      (neg|troop_slot_ge, "$g_talk_troop", slot_troop_prisoner_of_party, 0),
      (lt, "$g_talk_troop_faction_relation", 0),
      (store_partner_quest,":enemy_lord_quest"),
      (lt, ":enemy_lord_quest", 0),
      (troop_slot_eq, "$g_talk_troop", slot_troop_does_not_give_quest, 0),      
      (call_script, "script_get_random_quest", "$g_talk_troop"),
      (assign, "$random_quest_no", reg0),
      (ge, "$random_quest_no", 0),
    ],
   "Before you go, {playername}, I have something to ask of you... We may be enemies in this war, but I pray that you believe, as I do, that we can still treat each other with civility and respect. Thus I hoped that you might be kind enough to assist me in a matter of great importance.", "lord_leave_give_quest",[]],

  [anyone|plyr,"lord_leave_give_quest", [],
   "I am listening.", "enemy_lord_tell_mission",[]],


  [anyone,"enemy_lord_tell_mission", [(eq,"$random_quest_no","qst_lend_surgeon")],
   "I have a friend here -- he was once a mighty warrior, but now he has grown deathly ill. Pestilence has infected an old battle wound, and unless he is seen to by a doctor soon, he will surely die. This man is most dear to me, {playername}, but he's as stubborn as a hog and refuses to allow anyone look at his injury. Seems he doesn't trust any of the physicians here. But I've heard that you have a capable surgeon with you. If you would let your surgeon come here and have a look at him, {reg3?she:he} may be able to convince him to give his consent to the necessary surgery. Please, I would be deeply indebted to you if you would but grant me this request.", "lord_mission_told",
   [
     (quest_get_slot, ":quest_object_troop", "$random_quest_no", slot_quest_object_troop),
     (str_store_troop_name_link,1,"$g_talk_troop"),
##     (str_store_party_name,2,"$g_encountered_party"),
     (str_store_troop_name,3,":quest_object_troop"),
     (troop_get_type, reg3, ":quest_object_troop"),
     (setup_quest_text,"$random_quest_no"),
##     (try_begin),
##       (is_between, "$g_encountered_party", centers_begin, centers_end),
##       (setup_quest_giver, "$random_quest_no", "str_given_by_s1_at_s2"),
##     (else_try),
##       (setup_quest_giver,"$random_quest_no", "str_given_by_s1_in_wilderness"),
##     (try_end),
     (str_store_string, s2, "@Lend your experienced surgeon {s3} to {s1}."),
   ]],

  [anyone,"enemy_lord_tell_mission", [(str_store_quest_name, s7, "$random_quest_no")],
   "ERROR: MATCHED WITH QUEST: {s7}.", "close_window",
   []],

  [anyone,"lord_leave_prison", [],
   "We shall meet again.", "close_window",[]],

  [anyone|auto_proceed,"lord_leave", [(faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader,"$g_talk_troop")],
   "Of course, {playername}. Farewell.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],
  [anyone|auto_proceed,"lord_leave", [(ge,"$g_talk_troop_relation",10)],
   "Good journeys to you, {playername}.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],
  [anyone|auto_proceed,"lord_leave", [(ge, "$g_talk_troop_faction_relation", 0)],
   "Farewell.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],
  [anyone|auto_proceed,"lord_leave", [],
   "We shall meet again.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],


#Royal family members

  [anyone|plyr,"member_chat", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady)],
   "Are you enjoying your travels, {s65}?", "lady_journey_1",[]],
  [anyone,"lady_journey_1", [],
   "I am doing quite fine, {playername}. Thank you for your concern.", "close_window",[]],
  
  [anyone,"start",
   [
    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
    (check_quest_active, "qst_duel_for_lady"),
    (check_quest_succeeded, "qst_duel_for_lady"),
    (quest_slot_eq, "qst_duel_for_lady", slot_quest_giver_troop, "$g_talk_troop"),
    (le, "$talk_context", tc_siege_commander),
    (quest_get_slot, ":quest_target_troop", "qst_duel_for_lady", slot_quest_target_troop),
    (str_store_troop_name_link, s13, ":quest_target_troop"),
    ],
   "My dear {playername}, how good it is to see you again! I heard you gave that vile {s13} a well-deserved lesson. I should hope he never forgets his humiliation. I've a reward for you, but I fear it's but little compared to what you've done for me.", "lady_qst_duel_for_lady_succeeded_1",[]],
 [anyone|plyr,"lady_qst_duel_for_lady_succeeded_1", [], "It will just have to do.", "lady_qst_duel_for_lady_succeeded_2",[
  (str_store_string,s10,"@Then take it, with my eternal thanks. You are a noble {man/woman}.\
 I will never forget that you helped me in my time of need.")
  ]],
  [anyone|plyr,"lady_qst_duel_for_lady_succeeded_1", [], "{s66}, this is far too much!", "lady_qst_duel_for_lady_succeeded_2",[
  (str_store_string,s10,"@Forgive me, {playername}, but I must insist you accept it.\
 The money means little to me, and I owe you so much.\
 Here, take it, and let us speak no more of this."),
    (call_script, "script_change_player_honor", 1),
  ]],
  [anyone|plyr,"lady_qst_duel_for_lady_succeeded_1", [], "Please, {s65}, no reward is necessary.", "lady_qst_duel_for_lady_succeeded_2",[
  (str_store_string,s10,"@{playername}, what a dear {man/woman} you are,\
 but I will not allow you to refuse this. I owe you far more than I can say,\
 and I am sure you can put this money to far better use than I."),
    (call_script, "script_change_player_honor", 2),
  ]],
  [anyone,"lady_qst_duel_for_lady_succeeded_2", [], "{s10}", "lady_pretalk",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
    (add_xp_as_reward, 1000),
    (call_script, "script_troop_add_gold", "trp_player", 2000),
    (call_script, "script_end_quest", "qst_duel_for_lady"),
    ]],

  [anyone,"start",
   [
     (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
     (check_quest_active, "qst_duel_for_lady"),
     (check_quest_failed, "qst_duel_for_lady"),
     (quest_slot_eq, "qst_duel_for_lady", slot_quest_giver_troop, "$g_talk_troop"),
     (le, "$talk_context", tc_siege_commander),
     (quest_get_slot, ":quest_target_troop", "qst_duel_for_lady", slot_quest_target_troop),
     (str_store_troop_name_link, s13, ":quest_target_troop"),
     ],
   "I was told that you demanded satisfaction from {s13} to defend my innocence, {playername}. It was a fine gesture, and I thank you for it.", "lady_qst_duel_for_lady_failed", []],
  [anyone|plyr,"lady_qst_duel_for_lady_failed", [], "I beg your forgiveness for my defeat, {s65}...", "lady_qst_duel_for_lady_failed_2",[]],
  [anyone,"lady_qst_duel_for_lady_failed_2", [], "It matters not, dear {playername}. It was the attempt that mattered, not the outcome. The truth cannot be proven at the point of a sword, but you willingly put your life at stake for my honor. This alone will convince many of my innocence.", "lady_pretalk",
   [(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 6),
    (add_xp_as_reward, 400),
    (call_script, "script_end_quest", "qst_duel_for_lady"),
    ]],


  [anyone,"start", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
                    (check_quest_active, "qst_escort_lady"),
                    (eq, "$talk_context", tc_entering_center_quest_talk),
                    (quest_slot_eq, "qst_escort_lady", slot_quest_object_troop, "$g_talk_troop")],
   "Thank you for escorting me here, {playername}. Please accept this gift as a token of my gratitude. I hope that someday we shall meet once more.", "lady_escort_lady_succeeded",
   [
     (quest_get_slot, ":cur_center", "qst_escort_lady", slot_quest_target_center),
     (add_xp_as_reward, 300),
     (call_script, "script_troop_add_gold", "trp_player", 250),
     (call_script, "script_end_quest", "qst_escort_lady"),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 2),
     (troop_set_slot, "$g_talk_troop", slot_troop_cur_center, ":cur_center"),
     (remove_member_from_party,"$g_talk_troop"),
     ]],

	[anyone|plyr,"lady_escort_lady_succeeded", [], "It was an honor to serve you, {s65}.", "close_window",[]],

	
  [anyone,"start", [
    (troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
    (le, "$talk_context", tc_siege_commander),
    (check_quest_active, "qst_rescue_lord_by_replace"),
    (check_quest_succeeded, "qst_rescue_lord_by_replace"),
    (quest_slot_eq, "qst_rescue_lord_by_replace", slot_quest_giver_troop, "$g_talk_troop"),
    (troop_get_slot, ":cur_lord", "$g_talk_troop", slot_troop_father),
    (try_begin),
      (gt, ":cur_lord", 0),
      (str_store_string, s17, "str_father"),
    (else_try),
      (str_store_string, s17, "str_husband"),
    (try_end),
    ],
   "Oh, {playername}, you have returned him to me! Thank you ever so much for rescuing my {s17}. Please, take this as some small repayment for your noble deed.", "lady_generic_mission_succeeded",
   [
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 8),
     (add_xp_as_reward, 2000),
     (call_script, "script_troop_add_gold", "trp_player", 1500),
     (call_script, "script_end_quest", "qst_rescue_lord_by_replace"),
     ]],
	
  [anyone|plyr,"lady_generic_mission_succeeded", [], "'Tis always an honor to serve, {s65}.", "lady_pretalk",[]],
  
  
  [anyone ,"start", [(troop_slot_eq,"$g_talk_troop",slot_troop_occupation, slto_kingdom_lady),
                     (eq, "$g_talk_troop_met", 0),
                     (le,"$talk_context",tc_siege_commander),
                     ],
   "I say, you don't look familiar...", "lady_premeet", []],
  [anyone|plyr ,"lady_premeet", [],  "I am {playername}.", "lady_meet", []],
  [anyone|plyr ,"lady_premeet", [],  "My name is {playername}.", "lady_meet", []],

  [anyone, "lady_meet", [],  "{playername}? I do not believe I've heard of you before.", "lady_meet_end", []],

  [anyone, "lady_meet_end", [],  "Can I help you with anything?", "lady_talk", []],

  [anyone,"start", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_lady),
                    (le,"$talk_context",tc_siege_commander),
  ],
   "Yes?", "lady_talk",[]],

##### TODO: QUESTS COMMENT OUT BEGIN
##  [anyone|plyr,"lady_talk", [(check_quest_active, "qst_deliver_message_to_lover"),
##                             (quest_slot_eq, "qst_deliver_message_to_lover", slot_quest_target_troop, "$g_talk_troop"),
##                             (quest_get_slot, ":troop_no", "qst_deliver_message_to_lover", slot_quest_giver_troop),
##                             (str_store_troop_name_link, 3, ":troop_no")],
##   "I have brought you a message from {s3}", "lady_message_from_lover_success",[(call_script, "script_finish_quest", "qst_deliver_message_to_lover", 100)]],
##
##  [anyone|plyr,"lady_talk", [(check_quest_active, "qst_rescue_lady_under_siege"),
##                             (quest_slot_eq, "qst_rescue_lady_under_siege", slot_quest_object_troop, "$g_talk_troop"),
##                             (quest_slot_eq, "qst_rescue_lady_under_siege", slot_quest_current_state, 0)],
##   "TODO: I'm taking you home!", "lady_rescue_from_siege_check",[]],
##
##
##  [anyone,"lady_rescue_from_siege_check", [(neg|hero_can_join)],
##   "TODO: You don't have enough room for me!", "close_window",[]],
##
##
##  [anyone,"lady_rescue_from_siege_check", [], "TODO: Thank you so much!", "lady_pretalk",[(quest_set_slot, "qst_rescue_lady_under_siege", slot_quest_current_state, 1),
##                                                                                          (troop_set_slot, "$g_talk_troop", slot_troop_cur_center, 0),
##                                                                                          (troop_join, "$g_talk_troop")]],
##  [anyone,"lady_message_from_lover_success", [], "TODO: Thank you so much!", "lady_pretalk",[]],
##
  [anyone,"lady_pretalk", [], "Anything else?", "lady_talk",[]],
	
  [anyone|plyr,"lady_talk",
    [
     (store_partner_quest, ":ladys_quest"),
     (lt, ":ladys_quest", 0)
     ],
   "Is there anything I can do to win your favor?", "lady_ask_for_quest",[(call_script, "script_get_random_quest", "$g_talk_troop"),
                                                                 (assign, "$random_quest_no", reg0)]],
  [anyone,"lady_ask_for_quest", [(troop_slot_eq, "$g_talk_troop", slot_troop_does_not_give_quest, 1)],
   "I don't have anything else for you to do right now.", "lady_pretalk", []],
  
  [anyone,"lady_ask_for_quest", [(eq, "$random_quest_no", "qst_rescue_lord_by_replace")],
   "Oh, I fear I may never see my {s17}, {s13}, again... He is a prisoner in the dungeon of {s14}. We have tried to negotiate his ransom, but it is simply too high. We could never hope to raise that much money without selling everything we own, and God knows that {s13} would rather spend his life in prison than make us destitute. Instead I have come up with a plan to get him out of there, but it requires someone else to make a great sacrifice, and thus far my pleas have fallen on deaf ears...", "lady_mission_told",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),

     (try_begin),
       (troop_get_slot, ":cur_lord", "$g_talk_troop", slot_troop_spouse),
       (gt, ":cur_lord", 0),
       (str_store_string, s17, "str_husband"),
     (else_try),
       (str_store_string, s17, "str_father"),
     (try_end),
    
     (str_store_troop_name, s11, "$g_talk_troop"),
     (str_store_troop_name_link, s13, ":quest_target_troop"),
     (str_store_party_name_link, s14, ":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
       (str_store_string, s2, "@{s11} asked you to rescue her {s17}, {s13}, from {s14} by switching clothes and taking his place in prison."),
    ]],

  [anyone,"lady_ask_for_quest", [(eq, "$random_quest_no", "qst_deliver_message_to_prisoner_lord")],
   "My poor {s17}, {s13}, is a prisoner in the {s14} dungeons. The only way we can talk to each other is by exchanging letters whenever we can, but the journey is so dangerous that we have little opportunity to do so. Please, would you deliver a letter for me?", "lady_mission_told",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),

     (try_begin),
       (troop_get_slot, ":cur_lord", "$g_talk_troop", slot_troop_spouse),
       (gt, ":cur_lord", 0),
       (str_store_string, s17, "str_husband"),
     (else_try),
       (str_store_string, s17, "str_father"),
     (try_end),
	
     (str_store_troop_name, s11, "$g_talk_troop"),
     (str_store_troop_name_link, s13, ":quest_target_troop"),
     (str_store_party_name_link, s14, ":quest_target_center"),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@{s11} asked you to deliver a message to {s13}, who is imprisoned at {s14}."),
    ]],
  

  [anyone,"lady_ask_for_quest", [(eq, "$random_quest_no", "qst_duel_for_lady")],
   "Oh, {playername}! You know little of my troubles, and I can't possibly ask you to throw yourself into danger on my behalf.", "lady_quest_duel_for_lady",[]],
  [anyone|plyr,"lady_quest_duel_for_lady", [], "Tell me what the matter is, and I may be able to lend you my aid.", "lady_quest_duel_for_lady_2",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),

     (str_store_troop_name, s11, "$g_talk_troop"),
     (str_store_troop_name_link, s13, ":quest_target_troop"),
     (str_store_string, s2, "@You agreed to challenge {s13} to defend {s11}'s honour."),
     (setup_quest_text,"$random_quest_no"),
    ]],
  [anyone,"lady_quest_duel_for_lady_2", [], "Very well... In his life, my husband has... made certain enemies, {playername}. Of these, perhaps the most insidious is {s13}. He goes around making terrible accusations against me, impugning my honor at every turn! He cannot harm my husband directly, so he slanders me instead, in the hopes of ruining our good name. One shudders to hear the awful things he has said! If only there were someone brave enough to make him recant his slander... but {s13} is quite skilled with both the saber and the pistol, and he's widely feared...", "lady_quest_duel_for_lady_3",[]],

  [anyone|plyr,"lady_quest_duel_for_lady_3", [], "I fear him not, {s65}, my lady. I shall force his lies back down his throat!", "lady_quest_duel_for_lady_3_accepted",[]],
  [anyone,"lady_quest_duel_for_lady_3_accepted", [], "Oh! I could never ask you to defend my honor, {playername}! But... you seem so sure of yourself... If you could do this, I would be forever in your debt. It would mean so much if you would defend my honor. Thank you a thousand times, all my prayers and my favor go with you.", "close_window",
   [
     (quest_get_slot, ":quest_target_troop", "$random_quest_no", slot_quest_target_troop),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     (call_script, "script_report_quest_troop_positions", "$random_quest_no", ":quest_target_troop", 3),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 3),
     ]],

  [anyone|plyr,"lady_quest_duel_for_lady_3", [], "If he's that dangerous, perhaps it would be better to simply ignore him...", "lady_quest_duel_for_lady_3_rejected",[]],
  [anyone,"lady_quest_duel_for_lady_3_rejected", [], "Oh... Yes, I suppose you're right, {playername}. I should let go of my silly childhood ideas of chivalry and honor. People are not like that... not anymore. Farewell.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
    ]],


  [anyone,"lady_ask_for_quest", [], "No, {playername}, I've no need for a champion right now.", "lady_pretalk",[]],

  [anyone|plyr,"lady_mission_told", [], "As you wish, {s65}. It shall be done.", "lady_mission_accepted",[]],
  [anyone|plyr,"lady_mission_told", [], "{s66}, I fear I cannot help you right now.", "lady_mission_rejected",[]],

  [anyone,"lady_mission_accepted", [], "You are a true {gentleman/lady}, {playername}. Thank you so much for helping me.", "close_window",
   [
     (try_begin),
       (eq, "$random_quest_no", "qst_deliver_message_to_prisoner_lord"),
       (call_script, "script_troop_add_gold", "trp_player", 10),
     (try_end),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],
  [anyone,"lady_mission_rejected", [], "You'll not help a woman in need? You should be ashamed, {playername}... Please -- leave me. I have some important embroidery to catch up on.", "close_window",
   [
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
     (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],

#Leave
  [anyone|plyr,"lady_talk", [], "I want to improve my relation with a noble. Can you help me?", "lady_restore_relation",[]],
  [anyone,"lady_restore_relation", [(le, "$g_talk_troop_relation", 0)], "{playername}, I don't know you well enough to act on your behalf. I am very sorry.", "lady_pretalk",[]],
  [anyone,"lady_restore_relation", [], "Hmm. I see you've gotten yourself on somebody's bad side. Very well, with whom do you want to restore your relations?", "lady_restore_relation_2",[]],

  [anyone|plyr|repeat_for_troops,"lady_restore_relation_2", [(store_repeat_object, ":troop_no"),
                                                             (is_between, ":troop_no", heroes_begin, heroes_end),
                                                             (store_troop_faction, ":faction_no", ":troop_no"),
                                                             (eq, "$g_talk_troop_faction", ":faction_no"),
                                                             (call_script, "script_troop_get_player_relation", ":troop_no"),
                                                             (lt, reg0, 0),
                                                             (str_store_troop_name, s1, ":troop_no")],
   "{s1}", "lady_restore_relation_2b",[(store_repeat_object, "$troop_to_restore_relations_with")]],
  [anyone|plyr,"lady_restore_relation_2", [], "Never mind. I get along with everyone well enough.", "lady_pretalk",[]],

  [anyone,"lady_restore_relation_2b", [(str_store_troop_name, s10, "$troop_to_restore_relations_with")], "Well, yes, I can try to help you with this. I'm sure a few expensive gifts would make {s10} look upon you more favorably.", "lady_restore_relation_3",[]],
  
  [anyone,"lady_restore_relation_3", [(str_store_troop_name, s10, "$troop_to_restore_relations_with"),
                                      (assign, "$lady_restore_cost_1", 1000),
                                      (assign, "$lady_restore_cost_2", 2000),
                                      (assign, "$lady_restore_cost_3", 3000),
                                      (assign, reg10, "$lady_restore_cost_1"),
                                      (assign, reg11, "$lady_restore_cost_2"),
                                      (assign, reg12, "$lady_restore_cost_3"),
                                      (troop_get_type, reg4, "$troop_to_restore_relations_with"),
                                      ],
   "You can improve your relation with {s10} by sending {reg4?her:him} a gift worth {reg10} thaler. But if you could afford to spend {reg11} thaler on the gift, it would make a very fine impression on {reg4?her:him}. If you might go further, up to {reg12} thaler, this would really help smooth things over.", "lady_restore_relation_4",[]],

  [anyone|plyr,"lady_restore_relation_4", [(store_troop_gold,":gold", "trp_player"),
                                           (ge, ":gold", "$lady_restore_cost_1"),
                                           (assign, reg10, "$lady_restore_cost_1")],
   "I think a gift of {reg10} thaler would do perfectly.", "lady_restore_relation_5",[(assign, "$temp", 1), (assign, "$temp_2", "$lady_restore_cost_1")]],
  [anyone|plyr,"lady_restore_relation_4", [(store_troop_gold,":gold", "trp_player"),
                                           (ge, ":gold", "$lady_restore_cost_2"),
                                           (assign, reg11, "$lady_restore_cost_2")],
   "Perhaps I can afford {reg11} thaler.", "lady_restore_relation_5",[(assign, "$temp", 2), (assign, "$temp_2", "$lady_restore_cost_2")]],
  [anyone|plyr,"lady_restore_relation_4", [(store_troop_gold,":gold", "trp_player"),
                                           (ge, ":gold", "$lady_restore_cost_3"),
                                           (assign, reg12, "$lady_restore_cost_3")],
   "In that case, I am ready to spend {reg12} thaler.", "lady_restore_relation_5",[(assign, "$temp", 3), (assign, "$temp_2", "$lady_restore_cost_3")]],
  
  [anyone|plyr,"lady_restore_relation_4", [], "I don't think I can afford any such gifts at the moment.", "lady_restore_relation_cant_afford",[]],
  
  [anyone,"lady_restore_relation_5", [], "Excellent. Then I shall choose an appropriate gift for you, and send it to {s10} with your compliments. I am sure {reg4?she:he} will appreciate the gesture.", "lady_restore_relation_6",[
     (troop_remove_gold, "trp_player","$temp_2"),
     (call_script, "script_change_player_relation_with_troop", "$troop_to_restore_relations_with", "$temp"),
     (troop_get_type, reg4, "$troop_to_restore_relations_with"),
     ]],

  [anyone|plyr,"lady_restore_relation_6", [], "Thank you for your help, madam.", "lady_pretalk",[]],

  [anyone,"lady_restore_relation_cant_afford", [], "I'm afraid I can't be of much help in that case, {playername}. I am sorry.", "lady_pretalk",[]],
 
  [anyone|plyr,"lady_talk", [], "I must beg my leave.", "lady_leave",[]],
  
  [anyone|auto_proceed,"lady_leave", [], "Farewell, {playername}.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],



#Convincing bargaining
  [anyone,"convince_begin", [], "I still don't see why I should go along with what you're asking of me.", "convince_options",
   [(quest_get_slot, "$convince_value", "$g_convince_quest", slot_quest_convince_value),
    ]],
    
  [anyone|plyr,"convince_options", [(assign, reg8, "$convince_value")], "Then I'll make it worth your while. ({reg8} thaler)", "convince_bribe",[]],
  [anyone|plyr,"convince_options", 
  [(store_div, "$convince_relation_penalty", "$convince_value", 300),
   (val_add, "$convince_relation_penalty", 1),
   (assign, reg9, "$convince_relation_penalty")], 
   "Please, do it for the sake of our friendship. (-{reg9} to relation)", "convince_friendship",[]],
  [anyone|plyr,"convince_options", [], "Let me try and convince you... (Persuasion)", "convince_persuade_begin", []],
  [anyone|plyr,"convince_options", [], "Never mind.", "lord_pretalk",[]],

  [anyone,"convince_bribe", [], "Mmm, a generous gift to my coffers would certainly help matters... {reg8} thaler should do it. And I'll go with your suggestion.", "convince_bribe_verify",[]],

  [anyone|plyr,"convince_bribe_verify", [(store_troop_gold, ":gold", "trp_player"),
                                         (lt, ":gold", "$convince_value")],
   "I'm afraid my finances do not permit me to offer such a gift.", "convince_bribe_cant_afford",[]],
  [anyone|plyr,"convince_bribe_verify", [(store_troop_gold, ":gold", "trp_player"),
                                         (ge, ":gold", "$convince_value")],
  "Very well, please accept these {reg8} thaler.", "convince_bribe_goon",[]],
  [anyone|plyr,"convince_bribe_verify", [], "Let me think about this some more.", "convince_begin",[]],

  [anyone,"convince_bribe_cant_afford", [], "Ah. In that case, there is little I can do, unless you have some further argument to make...", "convince_options",[]],
   [anyone,"convince_bribe_goon", [], "Good {playername}! Consider this matter decided!", "convince_accept",[(troop_remove_gold, "trp_player","$convince_value")]],

  [anyone,"convince_friendship",
   [(store_add, ":min_relation", 5, "$convince_relation_penalty"),
    (ge, "$g_talk_troop_relation", ":min_relation")], "You've done well by me in the past, {playername}, and for that I will go along with your request, but know that I do not like your using our relationship this way.", "convince_friendship_verify",[]],

  [anyone|plyr,"convince_friendship_verify", [], "I am sorry, my friend, but I need your help in this.", "convince_friendship_go_on",[]],
  [anyone|plyr,"convince_friendship_verify", [], "If it will not please you, then I shall try something else.", "lord_pretalk",[]],

  [anyone,"convince_friendship_go_on", [], "All right then, {playername}, I will accept this for your sake. But remember, you owe me for this.", "convince_accept",
   [(store_sub, ":relation_change", 0, "$convince_relation_penalty"),
    (call_script, "script_change_player_relation_with_troop","$g_talk_troop",":relation_change")]],

  [anyone,"convince_friendship",
   [(ge, "$g_talk_troop_relation", -5)], "I don't think I owe you such a favor {playername}. I see no reason to accept this, even for you.", "lord_pretalk",[]],

  [anyone,"convince_friendship", [], "Is this some kind of a joke? You've some nerve asking me for favors, {playername} -- and let me assure you you'll receive none.", "lord_pretalk",[]],

  [anyone,"convince_persuade_begin", 
  [(troop_get_slot, ":last_persuasion_time", "$g_talk_troop", slot_troop_last_persuasion_time),
   (store_current_hours, ":cur_hours"),
   (store_add, ":valid_time", ":last_persuasion_time", 24),
   (gt, ":cur_hours", ":valid_time"),
   ], 
   "Very well. Make your case.", "convince_persuade_begin_2",[]],
   
   
  [anyone|plyr,"convince_persuade_begin_2", [], "Attempt to persuade...", "convince_persuade",[
        (try_begin),
          (store_random_in_range, ":rand", 0, 100),
          (lt, ":rand", 30),
          (store_current_hours, ":cur_hours"),
          (troop_set_slot, "$g_talk_troop", slot_troop_last_persuasion_time, ":cur_hours"),
        (try_end),
        (store_skill_level, ":persuasion_level", "skl_persuasion", "trp_player"),
        (store_add, ":persuasion_potential", ":persuasion_level", 5),

        (store_random_in_range, ":random_1", 0, ":persuasion_potential"),
        (store_random_in_range, ":random_2", 0, ":persuasion_potential"),
        (store_add, ":rand", ":random_1", ":random_2"),

        (assign, ":persuasion_difficulty", "$convince_value"),
        (convert_to_fixed_point, ":persuasion_difficulty"),
        (store_sqrt, ":persuasion_difficulty", ":persuasion_difficulty"),
        (convert_from_fixed_point, ":persuasion_difficulty"),
        (val_div, ":persuasion_difficulty", 10),
        (val_add, ":persuasion_difficulty", 4),

        (store_sub, "$persuasion_strength", ":rand", ":persuasion_difficulty"),
        (val_mul, "$persuasion_strength", 20),
        (assign, reg5, "$persuasion_strength"),
        (val_sub, "$convince_value", "$persuasion_strength"),
        (quest_set_slot, "$g_convince_quest", slot_quest_convince_value, "$convince_value"),
        (str_store_troop_name, s50, "$g_talk_troop"),
        (troop_get_type, reg51, "$g_talk_troop"),
        (try_begin),
          (lt, "$persuasion_strength", -30),
          (str_store_string, s5, "str_persuasion_summary_very_bad"),
        (else_try),
          (lt, "$persuasion_strength", -10),
          (str_store_string, s5, "str_persuasion_summary_bad"),
        (else_try),
          (lt, "$persuasion_strength", 10),
          (str_store_string, s5, "str_persuasion_summary_average"),
        (else_try),
          (lt, "$persuasion_strength", 30),
          (str_store_string, s5, "str_persuasion_summary_good"),
        (else_try),
          (str_store_string, s5, "str_persuasion_summary_very_good"),
        (try_end),
        (dialog_box, "@{s5} (Persuasion strength: {reg5})", "@Persuasion Attempt"),
  ]],
  [anyone|plyr,"convince_persuade_begin_2", [], "Try another way...", "convince_begin",[]],

  [anyone,"convince_persuade_begin", [], "By God's grace, {playername}! I am tired of listening to you. Your arguments are clearly lacking.", "lord_pretalk",[]],
 
  [anyone,"convince_persuade", [(le, "$convince_value", 0)], "All right, all right. You have convinced me. I'll go ahead with what you suggest.", "convince_accept",[]],
  [anyone,"convince_persuade", [(gt, "$persuasion_strength", 5)], "You've a point, {playername}, I'll admit that much. However I am not yet convinced that I should do as you bid.", "convince_options",[]],
  [anyone,"convince_persuade", [(gt, "$persuasion_strength", -5)], "Enough, {playername}. You've a lot of arguments, but none of them are truly convincing. I stand by what I said before.", "convince_options",[]],
  [anyone,"convince_persuade", [], "Truthfully, {playername}, I fail to see the virtue of your reasoning. What you ask makes even less sense now than it did before.", "convince_options",[]],

#Seneschal

  [anyone,"start", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_seneschal),
                    (eq, "$talk_context", tc_siege_won_seneschal),
                    (str_store_party_name, s1, "$g_encountered_party"),
                    ],
   "I must congratulate you on your victory, my {lord/lady}. Welcome to {s1}. We, the caretakers of this fortress, are at your service.", "siege_won_seneschal_1",[]],
  [anyone|plyr,"siege_won_seneschal_1", [], "Are you the steward?", "siege_won_seneschal_2",[]],
  [anyone,"siege_won_seneschal_2", [], "Indeed I am, my {lord/lady}. I have always served the masters of {s1} to the best of my ability, whichever side they might be on. Thus you may count on my utmost loyalty for as long as you are the {lord/lady} of this place. Now -- I do hope you intend to keep me on as steward? I promise you will not be disappointed.", "siege_won_seneschal_3",[]],
  [anyone|plyr,"siege_won_seneschal_3", [], "Very well, you may keep your post for the time being.", "siege_won_seneschal_4",[]],
  [anyone|plyr,"siege_won_seneschal_3", [], "You can stay, but I shall be keeping a close watch on you.", "siege_won_seneschal_4",[]],
  [anyone,"siege_won_seneschal_4", [], "Thank you, my {lord/lady}. If you do not mind my impudence, may I inquire as to your plans for the fortress?", "siege_won_seneschal_5",[]],

  [anyone|plyr,"siege_won_seneschal_5", [], "I will sell it to some noble.", "siege_won_seneschal_6",[]],
  [anyone|plyr,"siege_won_seneschal_5", [], "I intend to claim it for myself.", "siege_won_seneschal_6",[]],
  
  [anyone|plyr,"siege_won_seneschal_5", [], "I haven't given it much thought. What are my options?", "siege_won_seneschal_list_options",[]],

  [anyone,"siege_won_seneschal_list_options", [], "Oh, you might do any number of things my {lord/lady}. First, you could station a garrison here to protect the fortress from any immediate counterattacks. Then you could request an audience with some wealthy noble, and ask him to make you an offer on the fortress. It would be worth a tidy sum, believe you me. If you do not wish to sell, then you will have to find yourself a sovereign and protector who would accept homage from you. Without a royal investiture and an army at your back, you would have a difficult time holding on to such a fortress. Both you and {s1} would become very attractive targets for every man out there with a few soldiers and a scrap of ambition. ", "siege_won_seneschal_list_options_2",[]],

  [anyone|plyr,"siege_won_seneschal_list_options_2", [], "What do you mean, a sovereign? I won this place by my own hand, I don't need anyone else!", "siege_won_seneschal_list_options_3",[]],
  [anyone,"siege_won_seneschal_list_options_3", [], "Of course you don't, my {lord/lady}. However, no lord in the land will recognize your claim to the castle unless it is verified by royal decree. They would call {s1} an outlaw stronghold, and seize it for themselves at the earliest opportunity. Surely not even you could stand against a whole army.", "siege_won_seneschal_list_options_4",[]],
  [anyone|plyr,"siege_won_seneschal_list_options_4", [], "Hmm. I'll give it some thought.", "siege_won_seneschal_6",[]],

  [anyone,"siege_won_seneschal_6", [], "I am very pleased to hear it, my {lord/lady}. I am only trying to serve you to the best of my ability. Now, if at any time you find you have further need of me, you shall find me in the great hall. ", "close_window",[]],

  
  [anyone,"start", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_seneschal),(eq,"$g_talk_troop_met",0),(str_store_party_name,s1,"$g_encountered_party")],
   "Good day, {sir/madam}. I do not believe I've seen you here before. Let me extend my welcome to you as the steward of {s1}.", "seneschal_intro_1",[]],

  [anyone|plyr,"seneschal_intro_1", [],  "A pleasure to meet you, {s65}.", "seneschal_intro_1a",[]],
  [anyone,"seneschal_intro_1a", [], "How can I help you?", "seneschal_talk",[]],
  [anyone|plyr,"seneschal_intro_1", [],  "What exactly do you do here?", "seneschal_intro_1b",[]],
  [anyone,"seneschal_intro_1b", [], "Ah, a steward's duties are many, {sire/my lady}. For example, I collect the rents from my lord's estates, manage the fortress storerooms, deal with the local peasantry, take care of fortress staff, arrange supplies for the garrison... In short, all the mundane matters of this fief are my responsibility, which I carry out on behalf of my lord. Everything except commanding the soldiers, of course.", "seneschal_talk",[]],
  
  [anyone,"start", [(troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_seneschal)],
   "Good day, {sir/madam}.", "seneschal_talk",[]],

  [anyone,"seneschal_pretalk", [], "Will there be anything else?", "seneschal_talk",[]],


##### TODO: QUESTS COMMENT OUT BEGIN
##  [anyone|plyr,"seneschal_talk", [(check_quest_active, "qst_deliver_supply_to_center_under_siege"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_target_troop, "$g_talk_troop"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_current_state, 1),
##                                  (store_item_kind_count, ":no_supplies", "itm_siege_supply"),
##                                  (quest_get_slot, ":target_amount", "qst_deliver_supply_to_center_under_siege", slot_quest_target_amount),
##                                  (ge, ":no_supplies", ":target_amount")],
##   "TODO: Here are the supplies.", "seneschal_supplies_given",[]],
##
##  [anyone|plyr,"seneschal_talk", [(check_quest_active, "qst_deliver_supply_to_center_under_siege"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_target_troop, "$g_talk_troop"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_current_state, 1),
##                                  (store_item_kind_count, ":no_supplies", "itm_siege_supply"),
##                                  (quest_get_slot, ":target_amount", "qst_deliver_supply_to_center_under_siege", slot_quest_target_amount),
##                                  (lt, ":no_supplies", ":target_amount"),
##                                  (gt, ":no_supplies", 0)],
##   "TODO: Here are the supplies, but some of them are missing.", "seneschal_supplies_given_missing",[]],
##  
##  [anyone|plyr,"seneschal_talk", [(check_quest_active, "qst_deliver_supply_to_center_under_siege"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_object_troop, "$g_talk_troop"),
##                                  (quest_slot_eq, "qst_deliver_supply_to_center_under_siege", slot_quest_current_state, 0)],
##   "TODO: Give me the supplies.", "seneschal_supplies",[]],
##  
##  [anyone,"seneschal_supplies", [(store_free_inventory_capacity, ":free_inventory"),
##                                 (quest_get_slot, ":quest_target_amount", "qst_deliver_supply_to_center_under_siege", slot_quest_target_amount),
##                                 (ge, ":free_inventory", ":quest_target_amount"),
##                                 (quest_get_slot, ":quest_target_center", "qst_deliver_supply_to_center_under_siege", slot_quest_target_center),
##                                 (str_store_party_name, 0, ":quest_target_center"),
##                                 (troop_add_items, "trp_player", "itm_siege_supply", ":quest_target_amount")],
##   "TODO: Here, take these supplies. You must deliver them to {s0} as soon as possible.", "seneschal_pretalk",[(quest_set_slot, "qst_deliver_supply_to_center_under_siege", slot_quest_current_state, 1)]],
##
##  [anyone,"seneschal_supplies", [],
##   "TODO: You don't have enough space to take the supplies. Free your inventory and return back to me.", "seneschal_pretalk",[]],
##
##
##  [anyone,"seneschal_supplies_given", [],
##   "TODO: Thank you.", "seneschal_pretalk",[(party_get_slot, ":town_siege_days", "$g_encountered_party", slot_town_siege_days),
##                                            (quest_get_slot, ":target_amount", "qst_deliver_supply_to_center_under_siege", slot_quest_target_amount),
##                                            (val_sub, ":town_siege_days", ":target_amount"),
##                                            (try_begin),
##                                              (lt, ":town_siege_days", 0),
##                                              (assign, ":town_siege_days", 0),
##                                            (try_end),
##                                            (party_set_slot, "$g_encountered_party", slot_town_siege_days, ":town_siege_days"),
##                                            (troop_remove_items, "trp_player", "itm_siege_supply", ":target_amount"),
##                                            (call_script, "script_finish_quest", "qst_deliver_supply_to_center_under_siege", 100)]],
##
##  [anyone,"seneschal_supplies_given_missing", [],
##   "TODO: Thank you but it's not enough...", "seneschal_pretalk",[(store_item_kind_count, ":no_supplies", "itm_siege_supply"),
##                                                                  (quest_get_slot, ":target_amount", "qst_deliver_supply_to_center_under_siege", slot_quest_target_amount),
##                                                                  (assign, ":percentage_completed", 100),
##                                                                  (val_mul, ":percentage_completed", ":no_supplies"),
##                                                                  (val_div, ":percentage_completed", ":target_amount"),
##                                                                  (call_script, "script_finish_quest", "qst_deliver_supply_to_center_under_siege", ":percentage_completed"),
##                                                                  (party_get_slot, ":town_siege_days", "$g_encountered_party", slot_town_siege_days),
##                                                                  (val_sub, ":town_siege_days", ":no_supplies"),
##                                                                  (try_begin),
##                                                                    (lt, ":town_siege_days", 0),
##                                                                    (assign, ":town_siege_days", 0),
##                                                                  (try_end),
##                                                                  (party_set_slot, "$g_encountered_party", slot_town_siege_days, ":town_siege_days"),
##                                                                  (troop_remove_items, "trp_player", "itm_siege_supply", ":no_supplies"),
##                                                                  (call_script, "script_end_quest", "qst_deliver_supply_to_center_under_siege")]],
##
##### TODO: QUESTS COMMENT OUT END

  [anyone|plyr,"seneschal_talk", [(store_relation, ":cur_rel", "fac_player_supporters_faction", "$g_encountered_party_faction"),
                                  (ge, ":cur_rel", 0),],
   "I would like to ask you a question...", "seneschal_ask_something",[]],

  [anyone|plyr,"seneschal_talk", [(store_relation, ":cur_rel", "fac_player_supporters_faction", "$g_encountered_party_faction"),
                                  (ge, ":cur_rel", 0),],
   "I wish to know more about someone...", "seneschal_ask_about_someone",[]],

  [anyone,"seneschal_ask_about_someone", [],
   "Perhaps I might be able to help. Who did you have in mind?", "seneschal_ask_about_someone_2",[]],

  [anyone|plyr|repeat_for_troops,"seneschal_ask_about_someone_2", [(store_repeat_object, ":troop_no"),
                                                                  (is_between, ":troop_no", heroes_begin, heroes_end),
                                                                  (store_troop_faction, ":faction_no", ":troop_no"),
                                                                  (eq, "$g_encountered_party_faction", ":faction_no"),
                                                                  (str_store_troop_name, s1, ":troop_no")],
   "{s1}", "seneschal_ask_about_someone_3",[(store_repeat_object, "$hero_requested_to_learn_relations")]],

  [anyone|plyr,"seneschal_ask_about_someone_2", [], "Return...", "seneschal_pretalk",[]],

  [anyone, "seneschal_ask_about_someone_3", [(call_script, "script_troop_write_family_relations_to_s1", "$hero_requested_to_learn_relations"),
                                           (call_script, "script_troop_write_owned_centers_to_s2", "$hero_requested_to_learn_relations")],
   "{s2}{s1}", "seneschal_ask_about_someone_4",[(add_troop_note_from_dialog, "$hero_requested_to_learn_relations", 2)]],
  
  [anyone, "seneschal_ask_about_someone_relation", [(call_script, "script_troop_count_number_of_enemy_troops", "$hero_requested_to_learn_relations"),
                                            (assign, ":no_enemies", reg0),
                                            (try_begin),
                                              (gt, ":no_enemies", 1),
                                              (try_for_range, ":i_enemy", 1, ":no_enemies"),
                                                (store_add, ":slot_no", slot_troop_enemies_begin, ":i_enemy"),
                                                (troop_get_slot, ":cur_enemy", "$hero_requested_to_learn_relations", ":slot_no"),
                                                (str_store_troop_name_link, s50, ":cur_enemy"),
                                                (try_begin),
                                                  (eq, ":i_enemy", 1),
                                                  (troop_get_slot, ":cur_enemy", "$hero_requested_to_learn_relations", slot_troop_enemy_1),
                                                  (str_store_troop_name_link, s51, ":cur_enemy"),
                                                  (str_store_string, s51, "str_s50_and_s51"),
                                                (else_try),
                                                  (str_store_string, s51, "str_s50_comma_s51"),
                                                (try_end),
                                              (try_end),
                                            (else_try),
                                              (eq, ":no_enemies", 1),
                                              (troop_get_slot, ":cur_enemy", "$hero_requested_to_learn_relations", slot_troop_enemy_1),
                                              (str_store_troop_name_link, s51, ":cur_enemy"),
                                            (else_try),
                                              (str_store_string, s51, "str_noone"),
                                            (try_end),
                                            (troop_get_type, reg1, "$hero_requested_to_learn_relations")],
   "{reg1?She:He} hates {s51}.", "seneschal_ask_about_someone_4",[(add_troop_note_from_dialog, "$hero_requested_to_learn_relations", 3)]],
# Ryan END

  [anyone|plyr,"seneschal_ask_about_someone_4", [], "Where does {s1} stand with others?", "seneschal_ask_about_someone_relation",[]],
  [anyone|plyr,"seneschal_ask_about_someone_4", [], "My thanks, this was helpful.", "seneschal_pretalk",[]],

 
  [anyone|plyr,"seneschal_talk", [], "I must take my leave of you now. Farewell.", "close_window",[]],


  [anyone,"seneschal_ask_something", [],
   "I'll do what I can to help, of course. What is it you wish to ask?", "seneschal_ask_something_2",[]],

  [anyone|plyr,"seneschal_ask_something_2", [],
   "Perhaps you know where I might find someone...", "seneschal_ask_location",[]],

  [anyone,"seneschal_ask_location", [],
   "Well, a man in my position does hear a lot of things. Who is it that you seek?", "seneschal_ask_location_2",[]],

  [anyone|plyr|repeat_for_troops,"seneschal_ask_location_2", [(store_repeat_object, ":troop_no"),
                                                              (is_between, ":troop_no", heroes_begin, heroes_end),
                                                              (store_troop_faction, ":faction_no", ":troop_no"),
                                                              (eq, "$g_encountered_party_faction", ":faction_no"),
                                                              (str_store_troop_name, s1, ":troop_no")],
   "{s1}", "seneschal_ask_location_3",[(store_repeat_object, "$hero_requested_to_learn_location")]],

  [anyone|plyr,"seneschal_ask_location_2", [], "Return...", "seneschal_pretalk",[]],

  [anyone,"seneschal_ask_location_3", [(call_script, "script_get_information_about_troops_position", "$hero_requested_to_learn_location", 0)],
   "{s1}", "seneschal_pretalk",[]],

#caravan merchants
  [anyone,"start",
   [(eq,"$caravan_escort_state",1),
    (eq,"$g_encountered_party","$caravan_escort_party_id"),
    (le,"$talk_context",tc_party_encounter),
    (store_distance_to_party_from_party, reg(0),"$caravan_escort_destination_town","$caravan_escort_party_id"),
    (lt,reg(0),5),
    (str_store_party_name,s3,"$caravan_escort_destination_town"),
    (assign,reg(3), "$caravan_escort_agreed_reward"),
    ],
   "I see the walls of {s3} right ahead! We arrive a last. Here is your reward, {reg3} thaler -- I hope it is enough! And I do hope we meet again.", "close_window",
   [
    (assign,"$caravan_escort_state",0),
    (call_script, "script_troop_add_gold", "trp_player", "$caravan_escort_agreed_reward"),
    (assign,reg(4), "$caravan_escort_agreed_reward"),
    (val_mul,reg(4), 1),
    (add_xp_as_reward,reg(4)),
    (assign, "$g_leave_encounter",1),
    ]],
  
  [anyone,"start",
   [(eq,"$caravan_escort_state",1),
    (eq,"$g_encountered_party","$caravan_escort_party_id"),
    (eq, "$talk_context", tc_party_encounter),
    ],
   "We've made it this far... Is everything clear up ahead?", "talk_caravan_escort",[]],
  [anyone|plyr,"talk_caravan_escort", [],
   "There might be bandits nearby. Stay close.", "talk_caravan_escort_2a",[]],
  [anyone,"talk_caravan_escort_2a", [],
   "Trust me, {playername}, we're already staying as close to you as we can. Lead the way.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"talk_caravan_escort", [],
   "No sign of trouble, we can breathe easy.", "talk_caravan_escort_2b",[]],
  [anyone,"talk_caravan_escort_2b", [],
   "I'll breathe easy when we reach {s1}, and not a moment sooner. Let's keep moving.", "close_window",[[str_store_party_name,s1,"$caravan_escort_destination_town"],(assign, "$g_leave_encounter",1)]],

  [anyone,"start", [(eq,"$talk_context", tc_party_encounter),
                    (eq, "$g_encountered_party_type", spt_kingdom_caravan),
                    (party_slot_ge, "$g_encountered_party", slot_party_last_toll_paid_hours, "$g_current_hours"),
                    ],
   "What do you want? We paid our toll to you less than three days ago.", "merchant_talk",[]],

  [anyone,"start", [(eq,"$talk_context", tc_party_encounter),(eq, "$g_encountered_party_type", spt_kingdom_caravan),(ge,"$g_encountered_party_relation",0)],
   "Hail, friend.", "merchant_talk",[]],

  [anyone,"start", [(eq,"$talk_context", tc_party_encounter),
                    (eq, "$g_encountered_party_type", spt_kingdom_caravan),
                    (lt,"$g_encountered_party_relation",0),
                    (eq, "$g_encountered_party_faction", "fac_merchants"),
                    ],
   "What do you want? We are but simple merchants. We've no quarrel with you. Leave us be.", "merchant_talk",[]],

  [anyone,"start", [(eq,"$talk_context", tc_party_encounter),
                    (eq, "$g_encountered_party_type", spt_kingdom_caravan),
                    (lt,"$g_encountered_party_relation",0),
                    (faction_get_slot, ":faction_leader", "$g_encountered_party_faction",slot_faction_leader),
					#pt_oim_merchant_caravan
					(try_begin), 
						(is_between, "$g_encountered_party_faction", kingdoms_begin, kingdoms_end), 
                    (str_store_troop_name, s9, ":faction_leader"),
					(else_try), 
						(str_store_troop_name, s9, "trp_kingdom_1_lord"),
					(end_try), 
                    ],
   "Be warned, knave! This caravan is under the protection of {s9}. Step out of our way or face his fury!", "merchant_talk",[]],


  [anyone,"start", [(party_slot_eq, "$g_encountered_party", slot_party_type, spt_kingdom_caravan),(this_or_next|eq,"$talk_context", tc_party_encounter),(eq,"$talk_context", 0)],
   "Yes? What do you want?", "merchant_talk",[]],
  [anyone,"merchant_pretalk", [], "Anything else?", "merchant_talk",[]],

  [anyone|plyr,"merchant_talk", [(le,"$talk_context", tc_party_encounter),
                                 (check_quest_active, "qst_raid_caravan_to_start_war"),
                                 (neg|check_quest_concluded, "qst_raid_caravan_to_start_war"),
                                 (quest_slot_eq, "qst_raid_caravan_to_start_war", slot_quest_target_faction, "$g_encountered_party_faction"),
                                 (str_store_faction_name, s17, "$players_kingdom"),
  ],
   "You are trespassing in {s17} territory. I am confiscating these carts and all their goods!", "caravan_start_war_quest_1",[]],
  [anyone,"caravan_start_war_quest_1", [(str_store_faction_name, s17, "$players_kingdom"),],
   "What? What nonsense is this? We are nowhere near your territory, {mate/wench}, and besides, we have a peace treaty with {s17}!", "caravan_start_war_quest_2",[]],
  [anyone|plyr,"caravan_start_war_quest_2", [], "We'll see about that! Defend yourselves!", "merchant_attack",[]],
  [anyone|plyr,"caravan_start_war_quest_2", [], "Never mind, 'twas but a joke. Farewell.", "close_window",[(assign, "$g_leave_encounter",1)]],


  [anyone|plyr,"merchant_talk", [
	(le,"$talk_context", tc_party_encounter),
	(eq, "$g_encountered_party_faction", "$players_kingdom"),
	(neg|quest_slot_eq, "qst_oim_deliver_caravan", slot_quest_target_party, "$g_encountered_party"),  
   ], "I have an offer for you.", "merchant_talk_offer",[]],
  [anyone,"merchant_talk_offer", [], "What is it?", "merchant_talk_offer_2",[]],
  
  [anyone|plyr,"merchant_talk_offer_2", [(eq,"$talk_context", tc_party_encounter),(eq, "$g_encountered_party_faction", "$players_kingdom")],
   "I can escort you to your destination, for a price.", "caravan_offer_protection",[]],

##  [anyone|plyr,"merchant_talk_offer_2", [(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
##                                 (neg|faction_slot_eq, "$g_talk_troop_faction", slot_faction_leader, "$g_talk_troop"), #he is not a faction leader!
##                                 (call_script, "script_get_number_of_hero_centers", "$g_talk_troop"),
##                                 (eq, reg0, 0), #he has no castles or towns
##                                 (hero_can_join),
##                             ],
##   "I need capable men like you. Will you join me?", "knight_offer_join",[
##       ]],
  
  [anyone|plyr,"merchant_talk_offer_2", [], "Return...", "merchant_pretalk",[]],

  
  [anyone|plyr,"merchant_talk", [(eq,"$talk_context", tc_party_encounter), #TODO: For the moment don't let attacking if merchant has paid toll.
                                 (neg|party_slot_ge, "$g_encountered_party", slot_party_last_toll_paid_hours, "$g_current_hours"),

								 (neq, "$g_encountered_party_faction", "$players_kingdom"),
								 (neq, "$g_encountered_party_faction", "fac_player_faction"),
                                 ], "Hold, there, my good men.", "merchant_demand",[]],

  [anyone|plyr,"merchant_talk", [(eq,"$talk_context", tc_party_encounter), #TODO: For the moment don't let attacking if merchant has paid toll.
                                 (neg|party_slot_ge, "$g_encountered_party", slot_party_last_toll_paid_hours, "$g_current_hours"),

								 (this_or_next|eq, "$g_encountered_party_faction", "$players_kingdom"),
								 (eq, "$g_encountered_party_faction", "fac_player_faction"),
								 
								 (quest_get_slot, ":party_no", "qst_oim_deliver_caravan", slot_quest_target_party),  
								 (eq, ":party_no", "$g_encountered_party"),
                                 ], "What are you carrying?", "merchant_carried_items",[]],

  [anyone,"merchant_carried_items", [], "{s64}, we are carrying {reg1} {s1} to {s2}.", "merchant_talk",
  [
    (troop_get_type, reg65, "$g_talk_troop"),
    (try_begin),
      (faction_slot_eq,"$g_talk_troop_faction",slot_faction_leader,"$g_talk_troop"),
      (str_store_string,s64,"@{reg65?My Lady:My Lord}"),
    (else_try),
      (str_store_string,s64,"@{reg65?Madame:Sir}"),
    (try_end),

	(quest_get_slot, ":goods", "qst_oim_deliver_caravan", slot_quest_target_item), 
	(str_store_item_name, s1, ":goods"),
	(quest_get_slot, ":count", "qst_oim_deliver_caravan", slot_quest_target_amount),
	(assign, reg1, ":count"),
	(quest_get_slot, ":target_center", "qst_oim_deliver_caravan", slot_quest_target_center),
	(str_store_party_name, s2, ":target_center"),
  ]],

  [anyone,"merchant_demand", [(eq,"$talk_context", tc_party_encounter)], "What do you want?", "merchant_demand_2",[]],

  [anyone|plyr,"merchant_demand_2", [(neq,"$g_encountered_party_faction","$players_kingdom")], "You must pay a toll to pass here!", "merchant_demand_toll",[]],
  
  [anyone,"merchant_demand_toll", [(gt, "$g_strength_ratio", 70),
                                        (store_div, reg6, "$g_ally_strength", 2),
                                        (val_add, reg6, 40),
                                        (assign, "$temp", reg6),
                                        ], "Please, I don't want any trouble. I can give you {reg6} thaler -- just let us go.", "merchant_demand_toll_2",[]],
  [anyone,"merchant_demand_toll", [(store_div, reg6, "$g_ally_strength", 4),
                                        (val_add, reg6, 10),
                                        (assign, "$temp", reg6),
                                        ], "I don't want any trouble. I can give you {reg6} thaler if you'll let us go.", "merchant_demand_toll_2",[]],
  
  [anyone|plyr,"merchant_demand_toll_2", [], "Agreed, hand it over and you may go in peace.", "merchant_demand_toll_accept",[]],
  [anyone,"merchant_demand_toll_accept", [(assign, reg6, "$temp")], "Very well then. Here's {reg6} thaler. ", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_troop_add_gold", "trp_player", "$temp"),
    (store_add, ":toll_finish_time", "$g_current_hours", merchant_toll_duration),
    (party_set_slot, "$g_encountered_party", slot_party_last_toll_paid_hours, ":toll_finish_time"),
    (try_begin),
      (ge, "$g_encountered_party_relation", -5),
      (store_relation,":rel", "$g_encountered_party_faction","fac_player_supporters_faction"),
      (try_begin),
        (gt, ":rel", 0),
        (val_sub, ":rel", 1),
      (try_end),
      (val_sub, ":rel", 1),
      (call_script, "script_set_player_relation_with_faction", "$g_encountered_party_faction", ":rel"),
    (try_end),
### Troop commentaries changes begin
    (call_script, "script_add_log_entry", logent_caravan_accosted, "trp_player",  -1, -1, "$g_encountered_party_faction"),
### Troop commentaries changes end
    (assign, reg6, "$temp"),
    ]],
  
  [anyone|plyr,"merchant_demand_toll_2", [], "I changed my mind. I can't take your money.", "merchant_pretalk",[]],
  
  [anyone|plyr,"merchant_demand_toll_2", [], "No, I think I shall take -- everything! [Attack]", "merchant_attack",[]],
  
  [anyone|plyr,"merchant_demand_2", [(neq,"$g_encountered_party_faction","$players_kingdom")], "Hand over your gold and valuables -- now!", "merchant_attack_begin",[]],
  [anyone|plyr,"merchant_demand_2", [], "No. Forget it.", "merchant_pretalk",[]],
  
  
  [anyone,"merchant_attack_begin", [], "Are you robbing us?", "merchant_attack_verify",[]],
  [anyone|plyr,"merchant_attack_verify", [], "Robbing you? No, no! It was only a joke.", "merchant_attack_verify_norob",[]],
  [anyone,"merchant_attack_verify_norob", [], "God, don't joke about that, {lad/lass}. For a moment I thought we were in real trouble.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"merchant_attack_verify", [], "Of course I'm robbing you. Now hand over your goods.", "merchant_attack",[]],
  
  [anyone,"merchant_attack", [], "Damn you, you won't get anything from us without a fight!", "close_window",
   [(store_relation,":rel", "$g_encountered_party_faction","fac_player_supporters_faction"),
    (try_begin),
      (gt, ":rel", 0),
      (val_sub, ":rel", 10),
    (try_end),
    (val_sub, ":rel", 5),
	(try_begin), 
		(neq, "$g_encountered_party_faction", "fac_commoners"), 
    (call_script, "script_set_player_relation_with_faction", "$g_encountered_party_faction", ":rel"),
		(call_script, "script_add_log_entry", logent_caravan_accosted, "trp_player",  -1, -1, "$g_encountered_party_faction"),
	(end_try), 
### Troop commentaries changes begin
	#(assign, "$cant_leave_encounter", 1),	
### Troop commentaries changes end
    ]],

  [anyone,"caravan_offer_protection", [],
   "These roads are dangerous indeed. One can never have enough protection.", "caravan_offer_protection_2",
   [(get_party_ai_object,":caravan_destination","$g_encountered_party"),
    (store_distance_to_party_from_party, "$caravan_distance_to_target",":caravan_destination","$g_encountered_party"),
    (assign,"$caravan_escort_offer","$caravan_distance_to_target"),
    (val_sub, "$caravan_escort_offer", 10),
    (call_script, "script_party_calculate_strength", "p_main_party",0),
    (assign, ":player_strength", reg0),
    (val_min, ":player_strength", 200),
    (val_add, ":player_strength", 20),
    (val_mul,"$caravan_escort_offer",":player_strength"),
    (val_div,"$caravan_escort_offer",50),
    (val_max, "$caravan_escort_offer", 5),
    ]],
  [anyone,"caravan_offer_protection_2", [[lt,"$caravan_distance_to_target",10]],
   "An escort? We're almost there already! Thank you for the offer, though.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone,"caravan_offer_protection_2", [(get_party_ai_object,":caravan_destination","$g_encountered_party"),
    (str_store_party_name,1,":caravan_destination"),
    (assign,reg(2),"$caravan_escort_offer")],
   "We are heading to {s1}. I will pay you {reg2} thaler if you will escort us there.", "caravan_offer_protection_3",
   []],
  [anyone|plyr,"caravan_offer_protection_3", [],
   "Agreed.", "caravan_offer_protection_4",[]],
  [anyone,"caravan_offer_protection_4", [],
   "You must stay close to us along the way. We'll greatly need your help if we are ambushed by bandits.", "caravan_offer_protection_5",[]],
  [anyone|plyr,"caravan_offer_protection_5", [],
   "Don't worry, you can trust me.", "caravan_offer_protection_6",[]],
  [anyone,"caravan_offer_protection_6", [(get_party_ai_object,":caravan_destination","$g_encountered_party"),
    (str_store_party_name,1,":caravan_destination")],
   "Good. You can come and collect your money when we're within sight of {s1}. Alright then, let's get underway.", "close_window",
   [(get_party_ai_object,":caravan_destination","$g_encountered_party"),
    (assign, "$caravan_escort_destination_town", ":caravan_destination"),
    (assign, "$caravan_escort_party_id", "$g_encountered_party"),
    (assign, "$caravan_escort_agreed_reward", "$caravan_escort_offer"),
    (assign, "$caravan_escort_state", 1),
    (assign, "$g_leave_encounter",1)
   ]],
  [anyone|plyr,"caravan_offer_protection_3", [],
   "Return...", "caravan_offer_protection_4b",[]],
  [anyone,"caravan_offer_protection_4b", [],
   "Perhaps another time, then.", "close_window",[(assign, "$g_leave_encounter",1)]],

  [anyone|plyr,"merchant_talk", [(eq,"$talk_context", tc_party_encounter),(lt, "$g_talk_troop_faction_relation", 0)],
   "Not so fast. First, hand over all your goods and money.", "talk_caravan_enemy_2",[]],

  [anyone,"talk_caravan_enemy_2", [],
   "Never! It is our duty to protect these goods. You shall have to fight us, brigand!", "close_window",
   [
    (store_relation,":rel","$g_encountered_party_faction","fac_player_supporters_faction"),
    (val_min,":rel",0),
    (val_sub,":rel",4),
    (call_script, "script_set_player_relation_with_faction", "$g_encountered_party_faction", ":rel"),
    (call_script, "script_add_log_entry", logent_caravan_accosted, "trp_player",  -1, -1, "$g_encountered_party_faction"),
    ]],

  [anyone|plyr,"merchant_talk", [], "Leave...", "close_window",[(assign, "$g_leave_encounter",1)]],




# Prison Guards
  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_prison_guard_troop, "$g_talk_troop"),
                    (this_or_next|eq, "$g_encountered_party_faction", "fac_player_supporters_faction"),
                    (             party_slot_eq, "$g_encountered_party", slot_town_lord, "trp_player")
                    ],
   "Good day, my {lord/lady}. Will you be visiting the prison?", "prison_guard_players",[]],
  [anyone|plyr,"prison_guard_players", [],
   "Yes. Unlock the door.", "close_window",[(call_script, "script_enter_dungeon", "$current_town", "mt_visit_town_castle")]],
  [anyone|plyr,"prison_guard_players", [],
   "No, not now.", "close_window",[]],

  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_prison_guard_troop, "$g_talk_troop")],
   "Yes? What do you want?", "prison_guard_talk",[]],

  [anyone|plyr,"prison_guard_talk", [],
   "Who is imprisoned here?", "prison_guard_ask_prisoners",[]],
  [anyone|plyr,"prison_guard_talk", [],
   "I want to speak with prisoners.", "prison_guard_visit_prison",[]],

  [anyone,"prison_guard_ask_prisoners", [],
   "Currently, {s51} {reg1?are:is} imprisoned here.","prison_guard_talk",[(party_clear, "p_temp_party"),
                                                                              (assign, ":num_heroes", 0),
    (party_get_num_prisoner_stacks, ":num_stacks","$g_encountered_party"),
    (try_for_range, ":i_stack", 0, ":num_stacks"),
        (party_prisoner_stack_get_troop_id, ":stack_troop","$g_encountered_party",":i_stack"),
        (troop_is_hero, ":stack_troop"),
			(party_add_members, "p_temp_party", ":stack_troop", 1),
                                                                                (val_add, ":num_heroes", 1),
    (try_end),
    (call_script, "script_print_party_members", "p_temp_party"),
    (try_begin),
                                                                                (gt, ":num_heroes", 1),
        (assign, reg1, 1),
    (else_try),
        (assign, reg1, 0),
                                                                              (try_end)]],
	
  [anyone,"prison_guard_visit_prison", [(this_or_next|faction_slot_eq, "$g_encountered_party_faction",slot_faction_marshall,"trp_player"),
    (this_or_next|party_slot_eq, "$g_encountered_party", slot_town_lord, "trp_player"),
    (eq, "$g_encountered_party_faction", "$players_kingdom"),
  ],
   "Of course, {sir/madam}. Go in.", "close_window",[(call_script, "script_enter_dungeon", "$current_town", "mt_visit_town_castle")]],

  [anyone,"prison_guard_visit_prison", [],
   "You shall need permission from our lord to talk to the prisoners.", "prison_guard_visit_prison_2",[]],

  [anyone|plyr,"prison_guard_visit_prison_2", [], "All right then. I'll do that.", "close_window",[]],
  [anyone|plyr,"prison_guard_visit_prison_2", [], "Come on now. I thought you were in charge here.", "prison_guard_visit_prison_3",[]],
  [anyone,"prison_guard_visit_prison_3", [], "He-heh, you're quite right -- I'm the man in charge. But I still can't let you into the prison.", "prison_guard_visit_prison_4",[]],
  
  [anyone|plyr,"prison_guard_visit_prison_4", [], "All right then. I'll leave now.", "close_window",[]],
  [anyone|plyr,"prison_guard_visit_prison_4", [(store_troop_gold,":gold","trp_player"),(ge,":gold",100)],
   "I found a purse with 100 thaler a few paces away. I reckon it belongs to you.", "prison_guard_visit_prison_5",[]],

  [anyone,"prison_guard_visit_prison_5", [], "Ah! I was looking for that all day. How good of you to return it, {sir/madam}. Well, now that I know what an honest {fellow/lady} you are, there can be no harm in letting you inside for a short while.", "close_window",[(troop_remove_gold, "trp_player",100),(call_script, "script_enter_dungeon", "$current_town", "mt_visit_town_castle")]],
 
  [anyone|plyr,"prison_guard_talk", [],
   "Never mind.", "close_window",[]],




# Castle Guards
  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_castle_guard_troop, "$g_talk_troop"),
                    (this_or_next|eq, "$g_encountered_party_faction", "fac_player_supporters_faction"),
                    (             party_slot_eq, "$g_encountered_party", slot_town_lord, "trp_player")
                    ],
   "Your orders, my {lord/lady}?", "castle_guard_players",[]],
  [anyone|plyr,"castle_guard_players", [],
   "Open the door. I'll go in.", "close_window",[(call_script, "script_enter_court", "$current_town")]],
  [anyone|plyr,"castle_guard_players", [],
   "Return...", "close_window",[]],


  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_castle_guard_troop, "$g_talk_troop"),(eq, "$sneaked_into_town",1),
                    (gt,"$g_time_since_last_talk",0)],
   "Get out of my sight, beggar! You stink!", "castle_guard_sneaked_intro_1",[]],
  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_castle_guard_troop, "$g_talk_troop"),(eq, "$sneaked_into_town",1)],
   "Begone and tempt not my patience, beggar!", "close_window",[]],
  [anyone|plyr,"castle_guard_sneaked_intro_1", [], "I wish to enter the hall and speak to the lord.", "castle_guard_sneaked_intro_2",[]],
  [anyone|plyr,"castle_guard_sneaked_intro_1", [], "Leave...", "close_window",[]],
  [anyone,"castle_guard_sneaked_intro_2", [], "Are you out of your mind, {serf/bondswoman}? Beggars are not allowed into the hall. Now get lost or I'll beat you bloody.", "close_window",[]],
  
  
  [anyone,"start", [(eq, "$talk_context", 0),(faction_slot_eq, "$g_encountered_party_faction", slot_faction_castle_guard_troop, "$g_talk_troop")],
   "What do you want?", "castle_guard_intro_1",[]],
  [anyone|plyr,"castle_guard_intro_1", [],
   "I want to enter the hall and speak to the lord.", "castle_guard_intro_2",[]],
  [anyone|plyr,"castle_guard_intro_1", [],
   "Never mind.", "close_window",[]],
  [anyone,"castle_guard_intro_2", [], "You may go in, but you must leave your weapons with me. No one is allowed to carry arms into the lord's hall.", "castle_guard_intro_2",
   []],
  [anyone|plyr,"castle_guard_intro_2", [], "Here then, take my arms. I shall go in.", "close_window", [(call_script, "script_enter_court", "$current_town")]],
  [anyone|plyr,"castle_guard_intro_2", [], "No, I give my arms to no one.", "castle_guard_intro_2b", []],
  [anyone,"castle_guard_intro_2b", [], "Then you cannot go in.", "close_window", []],
  
##  [anyone|plyr,"castle_guard_intro_1", [],
##   "Never mind.", "close_window",[]],
##  [anyone,"castle_guard_intro_2", [],
##   "Does the lord expect you?", "castle_guard_intro_3",[]],
##  [anyone|plyr,"castle_guard_intro_3", [], "Yes.", "castle_guard_intro_check",[]],
##  [anyone|plyr,"castle_guard_intro_3", [], "No.", "castle_guard_intro_no",[]],
##  [anyone,"castle_guard_intro_check", [], "Hmm. All right {sir/madam}.\
## You can go in. But you must leave your weapons with me. Noone's allowed into the court with weapons.", "close_window",[]],
##  [anyone,"castle_guard_intro_check", [], "You liar!\
## Our lord would have no business with a filthy vagabond like you. Get lost now before I kick your butt.", "close_window",[]],
##  [anyone,"castle_guard_intro_no", [], "Well... What business do you have here then?", "castle_guard_intro_4",[]],
##  [anyone|plyr,"castle_guard_intro_4", [], "I wish to present the lord some gifts.", "castle_guard_intro_gifts",[]],
##  [anyone|plyr,"castle_guard_intro_4", [], "I have an important matter to discuss with the lord. Make way now.", "castle_guard_intro_check",[]],
##  [anyone,"castle_guard_intro_gifts", [], "Really? What gifts?", "castle_guard_intro_5",[]],
##  [anyone|plyr,"castle_guard_intro_4", [], "Many gifts. For example, I have a gift of 20 denars here for his loyal servants.", "castle_guard_intro_gifts",[]],
##  [anyone|plyr,"castle_guard_intro_4", [], "My gifts are of no concern to you. They are for your lords and ladies..", "castle_guard_intro_check",[]],
##  [anyone,"castle_guard_intro_gifts", [], "Oh! you can give those 20 denars to me. I can distribute them for you.\
## You can enter the court and present your gifts to the lord. I'm sure he'll be pleased.\
## But you must leave your weapons with me. Noone's allowed into the court with weapons.", "close_window",[]],

#Kingdom Parties
#  [anyone,"start", [(this_or_next|eq,"$g_encountered_party_template","pt_swadian_foragers"),
#                    (eq,"$g_encountered_party_template","pt_vaegir_foragers"),
##  [anyone,"start", [(this_or_next|party_slot_eq,"$g_encountered_party",slot_party_type, spt_forager),
##                    (this_or_next|party_slot_eq,"$g_encountered_party",slot_party_type, spt_scout),
##                    (party_slot_eq,"$g_encountered_party",slot_party_type, spt_patrol),
##                    (str_store_faction_name,5,"$g_encountered_party_faction")],
##   "In the name of the {s5}.", "kingdom_party_encounter",[]],
##  
##  [anyone,"kingdom_party_encounter", [(le,"$g_encountered_party_relation",-10)],
##   "Surrender now, and save yourself the indignity of defeat!", "kingdom_party_encounter_war",[]],
##  [anyone|plyr,"kingdom_party_encounter_war", [],  "[Go to Battle]", "close_window",[(encounter_attack)]],
##
##  [anyone,"kingdom_party_encounter", [(ge,"$g_encountered_party_relation",10)],
##   "Greetings, fellow warrior.", "close_window",[(eq,"$talk_context",tc_party_encounter),(assign, "$g_leave_encounter", 1)]],
##
##  [anyone,"kingdom_party_encounter", [],
##   "You can go.", "close_window",[]],








#Player Parties
##  [party_tpl|pt_old_garrison,"start", [],
##   "They told us to leave the castle to the new garrison {sir/madam}. So we left and came to rejoin you.", "player_old_garrison_encounter",[]],
##  
##  [anyone|plyr,"player_old_garrison_encounter", [(party_can_join)],
##   "You have done well. You'll join my command now.", "close_window",[(assign, "$g_move_heroes", 1),
##                                        (call_script, "script_party_add_party", "p_main_party", "$g_encountered_party"),
##                                        (remove_party, "$g_encountered_party"),
##                                        (assign, "$g_leave_encounter", 1)]],
##  [anyone|plyr,"player_old_garrison_encounter", [(assign, reg1, 0),
##                                                 (try_begin),
##                                                   (neg|party_can_join),
##                                                   (assign, reg1, 1),
##                                                 (try_end)],
##   "You can't join us now{reg1?, I can't command all the lot of you:}. Follow our lead.", "close_window",[(party_set_ai_behavior, "$g_encountered_party", ai_bhvr_attack_party),
##                                                                         (party_set_ai_object, "$g_encountered_party", "p_main_party"),
##                                                                         (party_set_flags, "$g_encountered_party", pf_default_behavior, 0),
##                                                                         (assign, "$g_leave_encounter", 1)]],
##
##  [anyone|plyr,"player_old_garrison_encounter", [(assign, reg1, 0),
##                                                 (try_begin),
##                                                   (neg|party_can_join),
##                                                   (assign, reg1, 1),
##                                                 (try_end)],
##   "You can't join us now{reg1?, I can't command all the lot of you:}. Stay here and wait for me.", "close_window",[
##       (party_set_ai_behavior, "$g_encountered_party", ai_bhvr_travel_to_point),
##       (party_get_position, pos1, "$g_encountered_party"),
##       (party_set_ai_target_position, "$g_encountered_party", pos1),
##       (party_set_flags, "$g_encountered_party", pf_default_behavior, 0),
##       (assign, "$g_leave_encounter", 1)]],
##






  [anyone,"start", [(eq, "$talk_context", tc_castle_gate)],
   "What do you want?", "castle_gate_guard_talk",[]],

  [anyone,"castle_gate_guard_pretalk", [],
   "Yes?", "castle_gate_guard_talk",[]],

  [anyone|plyr,"castle_gate_guard_talk", [(ge, "$g_encountered_party_relation", 0)], 
  "We need shelter for the night. Will you let us in?", "castle_gate_open",[]],
  [anyone|plyr,"castle_gate_guard_talk", [(party_slot_ge, "$g_encountered_party", slot_town_lord, 1)], "I want to speak with the lord of this fortress.", "request_meeting_castle_lord",[]],
  [anyone|plyr,"castle_gate_guard_talk", [], "I want to speak with someone in the fortress.", "request_meeting_other",[]],

  [anyone|plyr,"castle_gate_guard_talk", [], "Leave...", "close_window",[]],

  [anyone,"request_meeting_castle_lord", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                                         (call_script, "script_get_troop_attached_party", ":castle_lord"),
                                         (eq, "$g_encountered_party", reg0),
                                         (str_store_troop_name, s2, ":castle_lord"),
                                         (assign, "$lord_requested_to_talk_to", ":castle_lord"),
                                          ],  "Wait here. {s2} will see you.", "close_window",[]],
  
  [anyone,"request_meeting_castle_lord", [],  "My lord is not here now.", "castle_gate_guard_pretalk",[]],

  [anyone,"request_meeting_other", [],  "Who is that?", "request_meeting_3",[]],

  [anyone|plyr|repeat_for_troops,"request_meeting_3", [(store_repeat_object, ":troop_no"),
                                                       (troop_is_hero, ":troop_no"),
                                                       (troop_slot_eq, ":troop_no", slot_troop_occupation, slto_kingdom_hero),
                                                       (call_script, "script_get_troop_attached_party", ":troop_no"),
                                                       (eq, "$g_encountered_party", reg0),
                                                       (str_store_troop_name, s3, ":troop_no"),
                                                       ],
   "{s3}", "request_meeting_4",[(store_repeat_object, "$lord_requested_to_talk_to")]],

  [anyone|plyr,"request_meeting_3", [], "Never mind.", "close_window",[(assign, "$lord_requested_to_talk_to", 0)]],

  [anyone,"request_meeting_4", [], "Wait there. I'll send him your request.", "request_meeting_5",[]],

  [anyone|plyr,"request_meeting_5", [], "I'm waiting...", "request_meeting_6",[]],

  [anyone,"request_meeting_6",
   [
     (call_script, "script_troop_get_player_relation", "$lord_requested_to_talk_to"),
     (assign, ":lord_relation", reg0),
     (gt, ":lord_relation", -20),
    ], "All right. {s2} will talk to you now.", "close_window",[(str_store_troop_name, s2, "$lord_requested_to_talk_to")]],

  [anyone,"request_meeting_6", [(str_store_troop_name, s2, "$lord_requested_to_talk_to")], "{s2} says he will not see you. Begone now.", "close_window",[]],

  [anyone,"castle_gate_open", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                                         (call_script, "script_get_troop_attached_party", ":castle_lord"),
                                         (eq, "$g_encountered_party", reg0),
                                         (ge, "$g_encountered_party_relation", 0),
                                         (call_script, "script_troop_get_player_relation", ":castle_lord"),
                                         (assign, ":castle_lord_relation", reg0),
                                         #(troop_get_slot, ":castle_lord_relation", ":castle_lord", slot_troop_player_relation),
                                         (ge, ":castle_lord_relation", 5),
                                         (str_store_troop_name, s2, ":castle_lord")
                                         ],  "My lord {s2} will be happy to see you {sir/madam}. Come in, we are opening the gates.", "close_window",[(assign,"$g_permitted_to_center",1)]],


  [anyone,"castle_gate_open", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                                         (call_script, "script_get_troop_attached_party", ":castle_lord"),
                                         (neq, "$g_encountered_party", reg0),
                                         (ge, "$g_encountered_party_relation", 0),
                                         (call_script, "script_troop_get_player_relation", ":castle_lord"),
                                         (assign, ":castle_lord_relation", reg0),
                                         #(troop_get_slot, ":castle_lord_relation", ":castle_lord", slot_troop_player_relation),
                                         (ge, ":castle_lord_relation", 5),
                                         (str_store_troop_name, s2, ":castle_lord")
                                         ],  "My lord {s2} is not in the fortress now, but he would want me to make you welcome. Come in! We are opening the gates.", "close_window",[(assign,"$g_permitted_to_center",1)]],
 
  [anyone,"castle_gate_open", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                               (call_script, "script_troop_get_player_relation", ":castle_lord"),
                               (assign, ":castle_lord_relation", reg0),
                               #(troop_get_slot, ":castle_lord_relation", ":castle_lord", slot_troop_player_relation),
                               (ge, ":castle_lord_relation", -2),
                                         ],  "Come in, we are opening the gates for you.", "close_window",[(assign,"$g_permitted_to_center",1)]],
                                         
  [anyone,"castle_gate_open", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                               (call_script, "script_troop_get_player_relation", ":castle_lord"),
                               (assign, ":castle_lord_relation", reg0),
                               #(troop_get_slot, ":castle_lord_relation", ":castle_lord", slot_troop_player_relation),
                               (ge, ":castle_lord_relation", -19),
                               (str_store_troop_name, s2, ":castle_lord")
                                         ],  "Come in, but make sure your men behave sensibly within the walls. My lord {s2} does not take kindly to trouble here.", "close_window",[(assign,"$g_permitted_to_center",1)]],
 
  [anyone,"castle_gate_open", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
                               (str_store_troop_name, s2, ":castle_lord"),
  ],  "My lord {s2} does not want you here. Begone now.", "close_window",[]],


#Enemy Kingdom Meetings


#  [anyone,"start", [(eq, "$talk_context", tc_lord_talk_in_center)],
#   "Greetings {playername}.", "request_meeting_1",[]],

#  [anyone,"request_meeting_pretalk", [(eq, "$talk_context", tc_lord_talk_in_center)],
#   "Yes?", "request_meeting_1",[]],
  
#  [anyone|plyr,"request_meeting_1", [(ge, "$g_encountered_party_faction", 0)], "Open the gates and let me in!", "request_meeting_open_gates",[]],
  
#  [anyone|plyr,"request_meeting_1", [(party_slot_ge, "$g_encountered_party", slot_town_lord, 1)], "I want to speak with the lord of the castle.", "request_meeting_castle_lord",[]],
#  [anyone|plyr,"request_meeting_1", [], "I want to speak with someone in the castle.", "request_meeting_other",[]],

##### TODO: QUESTS COMMENT OUT BEGIN
##  [anyone|plyr,"request_meeting_1",[(check_quest_active,"qst_bring_prisoners_to_enemy"),
##                                    (neg|check_quest_succeeded, "qst_bring_prisoners_to_enemy"),
##                                    (quest_get_slot, ":quest_giver_troop", "qst_bring_prisoners_to_enemy", slot_quest_giver_troop),
##                                    (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                    (quest_get_slot, ":quest_object_troop", "qst_bring_prisoners_to_enemy", slot_quest_object_troop),
##                                    (quest_slot_eq, "qst_bring_prisoners_to_enemy", slot_quest_target_center, "$g_encountered_party"),
##                                    (party_count_prisoners_of_type, ":num_prisoners", "p_main_party", ":quest_object_troop"),
##                                    (ge, ":num_prisoners", ":quest_target_amount"),
##                                    (str_store_troop_name,1,":quest_giver_troop"),
##                                    (assign, reg1, ":quest_target_amount"),
##                                    (str_store_troop_name_plural,2,":quest_object_troop")],
##   "TODO: Sir, lord {s1} ordered me to bring {reg1} {s2} for ransom.", "guard_prisoners_brought",
##   [(quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##    (quest_get_slot, ":quest_target_center", "qst_bring_prisoners_to_enemy", slot_quest_target_center),
##    (quest_get_slot, ":quest_object_troop", "qst_bring_prisoners_to_enemy", slot_quest_object_troop),
##    (party_remove_prisoners, "p_main_party", ":quest_object_troop", ":quest_target_amount"),
##    (party_add_members, ":quest_target_center", ":quest_object_troop", ":quest_target_amount"),
##    (call_script, "script_game_get_join_cost", ":quest_object_troop"),
##    (assign, ":reward", reg0),
##    (val_mul, ":reward", ":quest_target_amount"),
##    (val_div, ":reward", 2),
##    (call_script, "script_troop_add_gold", "trp_player", ":reward"),
##    (party_get_slot, ":cur_lord", "$g_encountered_party", slot_town_lord),#Removing gold from the town owner's wealth
##    (troop_get_slot, ":cur_wealth", ":cur_lord", slot_troop_wealth),
##    (val_sub, ":cur_wealth", ":reward"),
##    (troop_set_slot, ":cur_lord", slot_troop_wealth, ":cur_wealth"),
##    (quest_set_slot, "qst_bring_prisoners_to_enemy", slot_quest_target_amount, ":reward"),
##    (succeed_quest, "qst_bring_prisoners_to_enemy"),
##    ]],
##
##  [anyone|plyr,"request_meeting_1",[(check_quest_active,"qst_bring_prisoners_to_enemy"),
##                                    (neg|check_quest_succeeded, "qst_bring_prisoners_to_enemy"),
##                                    (quest_get_slot, ":quest_giver_troop", "qst_bring_prisoners_to_enemy", slot_quest_giver_troop),
##                                    (quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##                                    (quest_get_slot, ":quest_object_troop", "qst_bring_prisoners_to_enemy", slot_quest_object_troop),
##                                    (quest_slot_eq, "qst_bring_prisoners_to_enemy", slot_quest_target_center, "$g_encountered_party"),
##                                    (party_count_prisoners_of_type, ":num_prisoners", "p_main_party", ":quest_object_troop"),
##                                    (lt, ":num_prisoners", ":quest_target_amount"),
##                                    (gt, ":num_prisoners", 0),
##                                    (str_store_troop_name,1,":quest_giver_troop"),
##                                    (assign, reg1, ":quest_target_amount"),
##                                    (str_store_troop_name_plural,2,":quest_object_troop")],
##   "TODO: Sir, lord {s1} ordered me to bring {reg1} {s2} for ransom, but some of them died during my expedition.", "guard_prisoners_brought_some",
##   [(quest_get_slot, ":quest_target_amount", "qst_bring_prisoners_to_enemy", slot_quest_target_amount),
##    (quest_get_slot, ":quest_target_center", "qst_bring_prisoners_to_enemy", slot_quest_target_center),
##    (quest_get_slot, ":quest_object_troop", "qst_bring_prisoners_to_enemy", slot_quest_object_troop),
##    (party_count_prisoners_of_type, ":num_prisoners", "p_main_party", ":quest_object_troop"),
##    (party_remove_prisoners, "p_main_party", ":quest_object_troop", ":num_prisoners"),
##    (party_add_members, ":quest_target_center", ":quest_object_troop", ":num_prisoners"),
##    (call_script, "script_game_get_join_cost", ":quest_object_troop"),
##    (assign, ":reward", reg0),
##    (val_mul, ":reward", ":num_prisoners"),
##    (val_div, ":reward", 2),
##    (call_script, "script_troop_add_gold", "trp_player", ":reward"),
##    (party_get_slot, ":cur_lord", "$g_encountered_party", slot_town_lord),#Removing gold from the town owner's wealth
##    (troop_get_slot, ":cur_wealth", ":cur_lord", slot_troop_wealth),
##    (val_sub, ":cur_wealth", ":reward"),
##    (troop_set_slot, ":cur_lord", slot_troop_wealth, ":cur_wealth"),
##    (call_script, "script_game_get_join_cost", ":quest_object_troop"),
##    (assign, ":reward", reg0),
##    (val_mul, ":reward", ":quest_target_amount"),
##    (val_div, ":reward", 2),
##    (quest_set_slot, "qst_bring_prisoners_to_enemy", slot_quest_current_state, 1),#Some of the prisoners are given, so it's state will change for remembering that.
##    (quest_set_slot, "qst_bring_prisoners_to_enemy", slot_quest_target_amount, ":reward"),#Still needs to pay the lord the full price of the prisoners
##    (succeed_quest, "qst_bring_prisoners_to_enemy"),
##    ]],
##
##
##  [anyone,"guard_prisoners_brought", [],
##   "TODO: Thank you. Here is the money for prisoners.", "request_meeting_pretalk",[]],
##
##  [anyone,"guard_prisoners_brought_some", [],
##   "TODO: Thank you, but that's not enough. Here is the money for prisoners.", "request_meeting_pretalk",[]],

#  [anyone|plyr,"request_meeting_1", [], "[Leave]", "close_window",[]],




  
##  [anyone,"request_meeting_open_gates", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
##                                         (call_script, "script_get_troop_attached_party", ":castle_lord"),
##                                         (eq, "$g_encountered_party", reg0),
##                                         (str_store_troop_name, 1, ":castle_lord")
##                                         ],  "My lord {s1} is in the castle now. You must ask his permission to enter.", "request_meeting_pretalk",[]],
##
##  [anyone,"request_meeting_open_gates", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),
##                                         (call_script, "script_get_troop_attached_party", ":castle_lord"),
##                                         (neq, "$g_encountered_party", reg0),
##                                         (ge, "$g_encountered_party_relation", 0),
##                                         (troop_get_slot, ":castle_lord_relation", ":castle_lord", slot_troop_player_relation),
##                                         (ge, ":castle_lord_relation", 20),
##                                         (str_store_troop_name, 1, ":castle_lord")
##                                         ],  "My lord {s1} is not in the castle now.\
## But I think he would approve of you taking shelter here, {sir/madam}.\
## Come on in. I am opening the gates for you.", "close_window",[]],
##  
##  [anyone,"request_meeting_open_gates", [(party_get_slot, ":castle_lord", "$g_encountered_party", slot_town_lord),(str_store_troop_name, 1, ":castle_lord")],
##   "My lord {s1} is not in the castle now. I can't allow you into the castle without his orders.", "request_meeting_pretalk",[]],
  

  

# Quest conversations

##### TODO: QUESTS COMMENT OUT BEGIN
  
##  [party_tpl|pt_peasant_rebels,"start", [],
##   "TODO: What.", "peasant_rebel_talk",[]],
##  [anyone|plyr, "peasant_rebel_talk", [], "TODO: Die.", "close_window",[]],
##  [anyone|plyr, "peasant_rebel_talk", [], "TODO: Nothing.", "close_window",[(assign, "$g_leave_encounter",1)]],
##
##  [party_tpl|pt_noble_refugees,"start", [],
##   "TODO: What.", "noble_refugee_talk",[]],
##  [anyone|plyr, "noble_refugee_talk", [], "TODO: Nothing.", "close_window",[(assign, "$g_leave_encounter",1)]],
##


  [anyone,"start", [(eq,"$talk_context",tc_join_battle_ally),
                    ],
   "You have come just in time. Let us join forces, and teach our enemy a lesson!", "close_window",
   []],

  [anyone,"start", [(eq,"$talk_context",tc_join_battle_enemy),
                    ],
   "You make a terrible mistake fighting against us.", "close_window",
   []],

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (eq, "$g_talk_troop_met", 0),
                    (ge, "$g_talk_troop_relation", 17),
                    ],
   "I don't think we have yet met properly, friend. You just saved my life out there, and I still don't know your name...", "ally_thanks_meet", []],


  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (eq, "$g_talk_troop_met", 0),
                    (ge, "$g_talk_troop_relation", 5),
					(str_store_troop_name, s1, "$g_talk_troop"),
                    ],
   "Your help was most welcome, stranger. My name is {s1}. Might I learn yours?", "ally_thanks_meet", []],

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (eq, "$g_talk_troop_met", 0),
                    (ge, "$g_talk_troop_relation", 0),
                    (str_store_troop_name, s1, "$g_talk_troop"),
                    ],
   "Thanks for your help, stranger. We haven't met properly yet, have we? What is your name?", "ally_thanks_meet", []],

  [anyone|plyr,"ally_thanks_meet", [], "My name is {playername}.", "ally_thanks_meet_2", []],

  [anyone, "ally_thanks_meet_2", [(ge, "$g_talk_troop_relation", 15),(str_store_troop_name, s1, "$g_talk_troop")],
   "Well met indeed {playername}. My name is {s1} and I am forever in your debt. If there is ever anything I can help you with, please let me know...", "close_window", []],
  [anyone, "ally_thanks_meet_2", [(ge, "$g_talk_troop_relation", 5),], "Well met {playername}. I am in your debt for what you just did. I hope one day I will find a way to repay you.", "close_window", []],
  [anyone, "ally_thanks_meet_2", [], "Well met {playername}. I am {s1}. Thanks for your help -- and I hope we meet again.", "close_window", []],

#Post 0907 changes begin
  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (ge, "$g_talk_troop_relation", 30),
                    (ge, "$g_relation_boost", 10),
                    ],
   "You saved us once again, {playername}! You are a true friend. {s43}", "close_window", [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_default"),
       (try_begin),
         (party_stack_get_troop_id, ":enemy_party_leader", "p_encountered_party_backup", 0),
         (is_between, ":enemy_party_leader", kingdom_heroes_begin, kingdom_heroes_end),
         (call_script, "script_add_log_entry", logent_lord_helped_by_player, "trp_player",  -1, ":enemy_party_leader", -1),
       (try_end),
       ]],
  
  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (ge, "$g_talk_troop_relation", 20),
                    (ge, "$g_relation_boost", 5),
                    ],
   "You arrived just in time, {playername}. You have my deepest gratitude! {s43}", "close_window", [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_default"),
       (try_begin),
         (party_stack_get_troop_id, ":enemy_party_leader", "p_encountered_party_backup", 0),
         (is_between, ":enemy_party_leader", kingdom_heroes_begin, kingdom_heroes_end),
         (call_script, "script_add_log_entry", logent_lord_helped_by_player, "trp_player",  -1, ":enemy_party_leader", -1),
       (try_end),
       ]],
  
  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (ge, "$g_talk_troop_relation", 0),
                    (ge, "$g_relation_boost", 3),
                    ],
   "You turned up just in time, {playername}. I will not forget your help. {s43}", "close_window", [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_default"),
       (try_begin),
         (party_stack_get_troop_id, ":enemy_party_leader", "p_encountered_party_backup", 0),
         (is_between, ":enemy_party_leader", kingdom_heroes_begin, kingdom_heroes_end),
         (call_script, "script_add_log_entry", logent_lord_helped_by_player, "trp_player",  -1, ":enemy_party_leader", -1),
       (try_end),
       ]],

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (ge, "$g_talk_troop_relation", -5),
                    ],
   "Good to see you here, {playername}. {s43}", "close_window", [
                    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_default"),
       ]],


  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    (ge, "$g_relation_boost", 4),
                    ],
   "{s43}", "close_window", [
                    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_grudging_default"),
                    ]],


  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (troop_is_hero, "$g_talk_troop"),
                    ],
   "{s43}", "close_window", [
                    (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_battle_won_unfriendly_default"),
                    ]],


#  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
#                    (troop_is_hero, "$g_talk_troop"),
#                    (ge, "$g_talk_troop_relation", -20),
#                    ],
#   "So, this is {playername}. Well, your help wasn't really needed, but I guess you had nothing better to do, right?", "close_window", []],

#  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
#                    (troop_is_hero, "$g_talk_troop"),
#                    ],
#   "Who told you to come to our help? I certainly didn't. Begone now. I want nothing from you and I will not let you steal my victory.", "close_window", []],

#Post 0907 changes begin

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (ge, "$g_relation_boost", 10),
                    (party_get_num_companions, reg1, "$g_encountered_party"),
                    (val_sub, reg1, 1),
                    ],
   "Thank you for your help {sir/madam}. You saved {reg1?our lives:my life} out there.", "close_window", []],

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks),
                    (ge, "$g_relation_boost", 5),
                    ],
   "Thank you for your help {sir/madam}. Things were starting to look grim, but everything changed with your arrival.", "close_window", []],

  [anyone,"start", [(eq,"$talk_context",tc_ally_thanks)],
   "Thank you for your help, {sir/madam}. It was fortunate that you were nearby.", "close_window", []],
  
  [anyone,"start", [(eq, "$talk_context", tc_hero_freed),
                    (store_conversation_troop,":cur_troop"),
                    (eq,":cur_troop","trp_kidnapped_girl"),],
   "Oh {sir/madam}. Thank you so much for rescuing me. Will you take me to my family now?", "kidnapped_girl_liberated_battle",[]],

  [anyone,"start", [(eq,"$talk_context",tc_hero_freed)],
   "I am in your debt for freeing me, my friend.", "freed_hero_answer",
   []],

  [anyone|plyr,"freed_hero_answer", [],
   "You're not going anywhere. You'll be my prisoner now!", "freed_hero_answer_1",
   [
     (store_conversation_troop, ":cur_troop_id"), 
     (party_add_prisoners, "p_main_party", ":cur_troop_id", 1),#take prisoner
    ]],

  [anyone,"freed_hero_answer_1", [],
   "Alas. Will my luck never change?", "close_window",
   []],

  [anyone|plyr,"freed_hero_answer", [],
   "You're free to go, {s65}.", "freed_hero_answer_2",
   [
    ]],

  [anyone,"freed_hero_answer_2", [],
   "Thank you, my good {man/lady}. I never forget someone who's done me a good turn.", "close_window",
   []],

  [anyone|plyr,"freed_hero_answer", [],
   "Would you like to join me?", "freed_hero_answer_3",
   []],

  [anyone,"freed_hero_answer_3", [(store_random_in_range, ":random_no",0,2),(eq, ":random_no", 0)],
   "Very well, I will join you.", "close_window",
   [
     (store_conversation_troop, ":cur_troop_id"), 
     (party_add_members, "p_main_party", ":cur_troop_id", 1),#join hero
   ]],

  [anyone,"freed_hero_answer_3", [],
   "No, I wish to go my own way.", "close_window",
   [
    ]],

  [anyone,"start", [(eq,"$talk_context",tc_hero_defeated)],
   "You'll not live long to enjoy your victory. My kinsmen will soon wipe out this stain of defeat.", "defeat_hero_answer",
   [
    ]],

  [anyone|plyr,"defeat_hero_answer", [],
   "You are my prisoner now.", "defeat_hero_answer_1",
   [
     (party_add_prisoners, "p_main_party", "$g_talk_troop", 1),#take prisoner
     #(troop_set_slot, "$g_talk_troop", slot_troop_is_prisoner, 1),
     (troop_set_slot, "$g_talk_troop", slot_troop_prisoner_of_party, "p_main_party"),
     (call_script, "script_event_hero_taken_prisoner_by_player", "$g_talk_troop"),
    ]],

  [anyone,"defeat_hero_answer_1", [],
   "Damn you! You'll regret this.", "close_window",
   []],

  [anyone|plyr,"defeat_hero_answer", [],
   "You're free to go this time, but don't cross my path again.", "defeat_hero_answer_2",
   []],

  [anyone,"defeat_hero_answer_2", [],
   "We shall meet again.", "close_window",
   []],


   
# Local merchant

  [trp_local_merchant,"start", [], "Mercy! Please don't kill me!", "local_merchant_mercy",[]],
  [anyone|plyr,"local_merchant_mercy", [(quest_get_slot, ":quest_giver_troop", "qst_kill_local_merchant", slot_quest_giver_troop),(str_store_troop_name, s2, ":quest_giver_troop")],
   "I have nothing against you, but {s2} wants you dead. My apologies...", "local_merchant_mercy_no",[]],
  [anyone,"local_merchant_mercy_no", [], "Damn you! May you burn in Hell!", "close_window",[]],
  [anyone|plyr,"local_merchant_mercy", [], "I'll let you live, if you promise me...", "local_merchant_mercy_yes",[]],

  [anyone,"local_merchant_mercy_yes", [], "Of course, I promise, I'll do anything. Please just spare my life... ", "local_merchant_mercy_yes_2",[]],
  [anyone|plyr,"local_merchant_mercy_yes_2", [], "You are going to forget all about {s2}'s debt to you. And you shall sign a paper stating that he owes you nothing.", "local_merchant_mercy_yes_3",[]],
  [anyone,"local_merchant_mercy_yes_3", [], "Yes, of course. I'll do just as you say.", "local_merchant_mercy_yes_4",[]],
  [anyone|plyr,"local_merchant_mercy_yes_4", [], "And if my lord hears so much as a whisper on this matter, then I shall return for you, and it won't matter how much you scream for mercy. Do I make myself clear?", "local_merchant_mercy_yes_5",[]],
  [anyone,"local_merchant_mercy_yes_5", [], "Yes {sir/madam}. Don't worry. The whole thing was just a big mistake!", "local_merchant_mercy_yes_6",[]],
  [anyone|plyr,"local_merchant_mercy_yes_6", [], "Good. Go now, before I change my mind.", "close_window",
   [(quest_set_slot, "qst_kill_local_merchant", slot_quest_current_state, 2),
    (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
    (finish_mission),
    ]],

# Village traitor

  [trp_fugitive,"start", [], "Yes, what do you want?", "fugitive_1",[]],
  [trp_fugitive|plyr,"fugitive_1", [
     (quest_get_slot, ":quest_target_dna", "qst_hunt_down_fugitive", slot_quest_target_dna),
     (call_script, "script_get_name_from_dna_to_s50", ":quest_target_dna"),
     (str_store_string, s4, s50),
      ], "I am looking for a murderer by the name of {s4}. You fit his description.", "fugitive_2",[]],
  [trp_fugitive|plyr,"fugitive_1", [], "Nothing. Sorry to trouble you.", "close_window",[]],
  [trp_fugitive,"fugitive_2", [], "I do not know what you are talking about {sir/madam}. I assure you, I am just another one of the people who lives here.", "fugitive_3",[]],
  [trp_fugitive|plyr,"fugitive_3", [], "Then drop your sword. If you are indeed innocent, then you have nothing to fear. We'll go now and talk to your neighbors, and if they verify your story, I'll be on my way.", "fugitive_4",[]],
  [anyone,"fugitive_4", [], "Damn you! You're not going anywhere!", "close_window",
   [(set_party_battle_mode),
    (try_for_agents, ":cur_agent"),
      (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
      (eq, ":cur_agent_troop", "trp_fugitive"),
      (agent_set_team, ":cur_agent", 1),
    (try_end),
    (quest_set_slot, "qst_hunt_down_fugitive", slot_quest_current_state, 1),
   ]],
	
	
  [anyone,"member_chat", [(check_quest_active, "qst_incriminate_loyal_commander"),
                          (quest_slot_eq, "qst_incriminate_loyal_commander", slot_quest_current_state, 0),
                          (store_conversation_troop, "$g_talk_troop"),
                          (eq, "$g_talk_troop", "$incriminate_quest_sacrificed_troop"),
                          (quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
                          (store_distance_to_party_from_party, ":distance", "p_main_party", ":quest_target_center"),
                          (lt, ":distance", 10),
                          ], "Yes {sir/madam}?", "sacrificed_messenger_1",[]],

  [anyone|plyr,"sacrificed_messenger_1", [(quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
                                          (str_store_party_name, s1, ":quest_target_center"),
                                          (quest_get_slot, ":quest_object_troop", "qst_incriminate_loyal_commander", slot_quest_object_troop),
                                          (str_store_troop_name, s2, ":quest_object_troop"),],
   "Take this letter to {s1} and give it to {s2}.", "sacrificed_messenger_2",[]],
  [anyone|plyr,"sacrificed_messenger_1", [],
   "Nothing. Nothing at all.", "close_window",[]],

  [anyone,"sacrificed_messenger_2", [],
   "Yes {sir/madam}. You can trust me. I will not fail you.", "sacrificed_messenger_3",[]],

  [anyone|plyr,"sacrificed_messenger_3", [],
   "Good. I will not forget your service. You will be rewarded when you return.", "close_window",[(party_remove_members, "p_main_party", "$g_talk_troop", 1),
                                     (set_spawn_radius, 0),
                                     (spawn_around_party, "p_main_party", "pt_sacrificed_messenger"),
                                     (assign, ":new_party", reg0),
                                     (party_add_members, ":new_party", "$g_talk_troop", 1),
                                     (party_set_ai_behavior, ":new_party", ai_bhvr_travel_to_party),
                                     (quest_get_slot, ":quest_target_center", "qst_incriminate_loyal_commander", slot_quest_target_center),
                                     (party_set_ai_object, ":new_party", ":quest_target_center"),
                                     (party_set_flags, ":new_party", pf_default_behavior, 0),
                                     (quest_set_slot, "qst_incriminate_loyal_commander", slot_quest_current_state, 2),
                                     (quest_set_slot, "qst_incriminate_loyal_commander", slot_quest_target_party, ":new_party")]],
  [anyone|plyr,"sacrificed_messenger_3", [], "Argh! I can't do this. I can't send you to your own death!", "sacrificed_messenger_cancel",[]],
  [anyone,"sacrificed_messenger_cancel", [], "What do you mean {sir/madam}?", "sacrificed_messenger_cancel_2",[]],
  [anyone|plyr,"sacrificed_messenger_cancel_2", [(quest_get_slot, ":quest_giver", "qst_incriminate_loyal_commander", slot_quest_giver_troop),
                                                 (str_store_troop_name, s3, ":quest_giver"),
      ], "There's a trap set up for you in the town. {s3} ordered me to sacrifice one of my chosen warriors to fool the enemy -- but he will just need to find another way.", "sacrificed_messenger_cancel_3",[
     (quest_get_slot, ":quest_giver", "qst_incriminate_loyal_commander", slot_quest_giver_troop),
     (quest_set_slot, "qst_incriminate_loyal_commander", slot_quest_current_state, 1),
     (call_script, "script_change_player_relation_with_troop",":quest_giver",-5),
     (call_script, "script_change_player_honor", 3),
     (call_script, "script_fail_quest", "qst_incriminate_loyal_commander"),
     ]],
  [anyone,"sacrificed_messenger_cancel_3", [], "Thank you, {sir/madam}. I would follow you to the gates of hell, as you well know. But this would not have been a noble death.", "close_window",[]],

  [party_tpl|pt_sacrificed_messenger,"start", [],
   "I beg your pardon, {my lord/my lady}. I have important business to attend. There is no time to talk.", "close_window",[(assign, "$g_leave_encounter",1)]],

#Spy

  [party_tpl|pt_spy,"start", [], "Good day {sir/madam}. Such fine weather don't you think? If you'll excuse me now I must be on my way.", "follow_spy_talk",[]],

  [anyone|plyr, "follow_spy_talk",
   [
     (quest_get_slot, ":quest_giver", "qst_follow_spy", slot_quest_giver_troop),
     (str_store_troop_name, s1, ":quest_giver"),
     ],
   "In the name of {s1}, you are under arrest!", "follow_spy_talk_2", []],
  [anyone, "follow_spy_talk_2", [], "You won't get me alive!", "close_window", []],
  [anyone|plyr, "follow_spy_talk", [], "Never mind me. I was just passing by.", "close_window", [(assign, "$g_leave_encounter",1)]],

  [party_tpl|pt_spy_partners,"start", [], "What now?", "spy_partners_talk",[]],

  [anyone|plyr,"spy_partners_talk",
   [
     (quest_get_slot, ":quest_giver", "qst_follow_spy", slot_quest_giver_troop),
     (str_store_troop_name, s1, ":quest_giver"),
     ],
   "In the name of {s1}, you are under arrest!", "spy_partners_talk_2",[]],
  [anyone,"spy_partners_talk_2", [], "Over our dead bodies!", "close_window",[]],
  [anyone|plyr,"spy_partners_talk", [], "Never mind me. I was just passing by.", "close_window",[(assign, "$g_leave_encounter",1)]],


###Conspirator
##
##  [party_tpl|pt_conspirator_leader,"start", [], "TODO: Hello.", "conspirator_talk",[]],
##  [party_tpl|pt_conspirator,"start", [], "TODO: Hello.", "conspirator_talk",[]],
##
##  [anyone|plyr,"conspirator_talk", [(gt, "$qst_capture_conspirators_leave_meeting_counter", 0),
##                                    (quest_get_slot,":quest_giver","qst_capture_conspirators",slot_quest_giver_troop),
##                                    (str_store_troop_name,s1,":quest_giver")],
##   "TODO: In the name of {s1}, you are under arrest!", "conspirator_talk_2",[]],
##
##  [anyone|plyr,"conspirator_talk", [], "TODO: Bye.", "close_window",[(assign, "$g_leave_encounter",1)]],
##
##  [anyone,"conspirator_talk_2", [], "You won't get me alive!", "close_window",[]],
##
#Runaway Peasants


  [party_tpl|pt_runaway_serfs,"start", [(party_slot_eq, "$g_encountered_party", slot_town_center, 0)],#slot_town_center is used for first time meeting
   "Good day {sir/madam}.", "runaway_serf_intro_1",
   [(party_set_slot, "$g_encountered_party", slot_town_center, 1)]],
  
  [anyone|plyr,"runaway_serf_intro_1", [(quest_get_slot, ":lord", "qst_bring_back_runaway_serfs", slot_quest_giver_troop),
                                        (str_store_troop_name, s4, ":lord")],
   "I have been sent by your {s4}. There will be no punishment if you return now.", "runaway_serf_intro_2",[]],
   
  [anyone,"runaway_serf_intro_2", [(quest_get_slot, ":target_center", "qst_bring_back_runaway_serfs", slot_quest_target_center),
                                   (str_store_party_name, s6, ":target_center"),
                                   (quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
                                   (str_store_party_name, s1, ":quest_object_center")],
   "My good {sir/madam}. Our lives in {s1} were unbearable. We worked all day long and still went to bed hungry. We are going to {s6} to start a new life, a life where we may be treated like humans.", "runaway_serf_intro_3",[]],

  [anyone|plyr,"runaway_serf_intro_3", [(quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
                                        (str_store_party_name, s1, ":quest_object_center"),],
   "You have gone against our laws by running from your bondage. You will go back to {s1} now!", "runaway_serf_go_back",
   [(quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (call_script, "script_change_player_relation_with_center", ":quest_object_center", -1)]],

  [anyone|plyr,"runaway_serf_intro_3", [], "Well, maybe you are right. Alright then. If anyone asks, I haven't seen you.", "runaway_serf_let_go",
   [(quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (call_script, "script_change_player_relation_with_center", ":quest_object_center", 1)]],

  [party_tpl|pt_runaway_serfs,"runaway_serf_go_back", [(quest_get_slot, ":home_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
                                                       (str_store_party_name, s5, ":home_center")],
   "Alright {sir/madam}. As you wish. We'll head back to {s5} now.", "close_window",
   [(quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (party_set_ai_object, "$g_encountered_party", ":quest_object_center"),
    (assign, "$g_leave_encounter",1)]],
  
  [anyone,"runaway_serf_let_go", [], "God bless you, {sir/madam}. We will not forget your help.", "close_window",
   [(party_set_slot, "$g_encountered_party", slot_town_castle, 1),
    (assign, "$g_leave_encounter",1)]],
  

  [party_tpl|pt_runaway_serfs,"start", [(party_slot_eq, "$g_encountered_party", slot_town_castle, 1),
                                        ],
   "Good day {sir/madam}. Don't worry. If anyone asks, we haven't seen you.", "runaway_serf_reconsider",[]],

  [anyone|plyr,"runaway_serf_reconsider", [], "I have changed my mind. You must return to your village!", "runaway_serf_go_back",
   [(party_set_slot, "$g_encountered_party", slot_town_castle, 0),
    (quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (call_script, "script_change_player_relation_with_center", ":quest_object_center", -2)]],

  [anyone|plyr,"runaway_serf_reconsider", [], "Good. Go quickly now before I change my mind.", "runaway_serf_let_go",[]],
  
  
  [party_tpl|pt_runaway_serfs,"start", [(party_slot_eq, "$g_encountered_party", slot_town_castle, 0),
                                        (get_party_ai_object, ":cur_ai_object"),
                                        (quest_get_slot, ":home_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
                                        (neq, ":home_center", ":cur_ai_object")],
   "Good day {sir/madam}. We were just heading back to {s5}, but I fear we lost our way.", "runaway_serf_talk_caught",[]],

  [anyone|plyr,"runaway_serf_talk_caught", [], "Do not test my patience. You are going back now!", "runaway_serf_go_back",[]],
  [anyone|plyr,"runaway_serf_talk_caught", [], "Well, if you are that eager to go, then go.", "runaway_serf_let_go",
   [(quest_get_slot, ":quest_object_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (call_script, "script_change_player_relation_with_center", ":quest_object_center", 1)]],
  
  [party_tpl|pt_runaway_serfs,"start",
   [(quest_get_slot, ":home_center", "qst_bring_back_runaway_serfs", slot_quest_object_center),
    (str_store_party_name, s5, ":home_center")], "We are on our way back to {s5} {sir/madam}.", "runaway_serf_talk_again_return",[]],
  
  [anyone|plyr,"runaway_serf_talk_again_return", [], "Make haste now. The sooner you return the better.", "runaway_serf_talk_again_return_2",[]],
  [anyone|plyr,"runaway_serf_talk_again_return", [], "Good. Keep moving.", "runaway_serf_talk_again_return_2",[]],
  
  [anyone|plyr,"runaway_serf_talk_again_return_2", [], "Yes sir. As you wish.", "close_window",[(assign, "$g_leave_encounter",1)]],
  

  [anyone, "start", [(eq,"$talk_context",tc_bandit_talk),], 
  "If you want to save your caravan you have to pay us.", "looting_bandits_talk",[]],

  [anyone|plyr,"looting_bandits_talk", [], "I only pay those who deserve payment!", "looting_bandits_barter_3b",[]],
  [anyone|plyr,"looting_bandits_talk", [], "There's no need to fight. I am ready to pay.", "looting_bandits_barter",[]],


  [anyone,"looting_bandits_barter", [], "Good. You are clever. Pay us {reg5} thaler, and we will leave you and your caravan.", "looting_bandits_barter_2",[

    (try_begin),
	  #(bandits and looters wants only 3% of player's total richness + player character level * 30 + member size * 10 + 50)
	  (neq, "$g_encountered_party_template", "pt_deserters"),      
	  (store_character_level, ":player_character_level", "trp_player"),
	  (store_mul, ":tribute_amount", ":player_character_level", 30),
	  (val_add, ":tribute_amount", 50),
	
      (store_troop_gold, ":total_value", "trp_player"),
      (troop_get_inventory_capacity, ":inv_size", "trp_player"),
      (try_for_range, ":i_slot", 0, ":inv_size"),
        (troop_get_inventory_slot, ":item_id", "trp_player", ":i_slot"),
        (ge, ":item_id", 0),
        (try_begin),
          (is_between, ":item_id", trade_goods_begin, trade_goods_end),
          (store_item_value, ":item_value", ":item_id"),
          (val_add, ":total_value", ":item_value"),
        (try_end),
      (try_end),    
	  (store_div, ":total_value_div_33", ":total_value", 333), 
	  (val_mul, ":total_value_div_33", 10), 
	  (val_add, ":tribute_amount", ":total_value_div_33"),
	(else_try),
	  #(deserters wants only 5% of player's total richness + player character level * 20 + 50)
	  (store_character_level, ":player_character_level", "trp_player"),
	  (store_mul, "$g_tribute_amount", ":player_character_level", 20),	
	  (val_add, "$g_tribute_amount", 50),
	
      (store_troop_gold, ":total_value", "trp_player"),
      (troop_get_inventory_capacity, ":inv_size", "trp_player"),
      (try_for_range, ":i_slot", 0, ":inv_size"),
        (troop_get_inventory_slot, ":item_id", "trp_player", ":i_slot"),
        (ge, ":item_id", 0),
        (try_begin),
          (is_between, ":item_id", trade_goods_begin, trade_goods_end),
          (store_item_value, ":item_value", ":item_id"),
          (val_add, ":total_value", ":item_value"),
        (try_end),
      (try_end),    
	  (store_div, ":total_value_div_20", ":total_value", 200), 
	  (val_mul, ":total_value_div_20", 10), 
	  (val_add, "$g_tribute_amount", ":total_value_div_20"),
	(try_end),

	(val_mul, "$g_tribute_amount", 3),
	(val_div, "$g_tribute_amount", 2),
	(val_add, "$g_tribute_amount", 50), #tribute amount increases to (1.5x + 50) if deserters/bandits/looters are currently fighting with a player's caravan.

    (assign,reg5,"$g_tribute_amount"),
	
	]],
  [anyone|plyr,"looting_bandits_barter_2", [(store_troop_gold,reg2),(ge,reg2,"$g_tribute_amount"),(assign,reg5,"$g_tribute_amount")],
   "All right, here's your {reg5} thaler.", "looting_bandits_barter_3a",[
	(troop_remove_gold, "trp_player","$g_tribute_amount"), 
	#oim code	
	(call_script, "script_get_closest_walled_center", "$g_encountered_party"), #":spawn_party"),
	(assign, ":party_to_patrol", reg0),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_main_object, ":party_to_patrol"),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_attack, 0),
	(call_script, "script_party_set_ai_state", "$g_encountered_party", spai_patrolling_around_center, ":party_to_patrol"),
	(party_set_ai_behavior, "$g_encountered_party", ai_bhvr_patrol_location),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_is_control, 17),
	(party_relocate_near_party, "$g_encountered_party", "p_main_party", 2),
	#oim code
   ]],
  [anyone|plyr,"looting_bandits_barter_2", [],
   "I don't have that much money with me.", "looting_bandits_barter_3b",[]],
  [anyone,"looting_bandits_barter_3b", [],
   "Too bad. Now we'll have to take everything you are carrying as payment.", "close_window",[(leave_encounter),(change_screen_return),]],

  [anyone,"looting_bandits_barter_3a", [], "Ha ha! Good. Now take your caravan and go.", "close_window",[
    (store_current_hours,":protected_until"),
    (val_add, ":protected_until", 72),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,":protected_until"),
    (party_ignore_player, "$g_encountered_party", 72),
	(party_set_ignore_with_player_party, "p_main_party", 72),
      
	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (str_store_party_name, s1, ":party_no"),	  
	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),
	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),
	  (assign, reg1, ":dist"),
	  (le, ":dist", 25),	  
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	  (str_store_party_name, s1, ":party_no"),
	(try_end),

    (party_end_battle, "$g_encountered_party"),
    (leave_encounter),
    (change_screen_return),

    (assign, "$g_leave_encounter",1),
    ]],



#Deserters
  [party_tpl|pt_deserters, "start", [(eq,"$talk_context",tc_party_encounter),
                                     (party_get_slot,":protected_until_hours", "$g_encountered_party",slot_party_ignore_player_until),
                                     (store_current_hours,":cur_hours"),
                                     (store_sub, ":protection_remaining",":protected_until_hours",":cur_hours"),
                                     (gt, ":protection_remaining", 0)], "What do you want? You want to pay us some more money?", "deserter_paid_talk",[]],
  [anyone|plyr,"deserter_paid_talk", [], "Sorry to trouble you. I'll be on my way now.", "deserter_paid_talk_2a",[]],
  [anyone,"deserter_paid_talk_2a", [], "Yeah. Stop fooling around here and go make some money. I want to see that purse full next time I see you.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"deserter_paid_talk", [], "No. This time it's your turn to pay me!", "deserter_paid_talk_2b",[]],
  [anyone,"deserter_paid_talk_2b", [], "What is this nonsense? You want trouble?! You've got it!", "close_window",[
       (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,0),
       (party_ignore_player, "$g_encountered_party", 0),
	   (party_set_ignore_with_player_party, "p_main_party", 0),
    ]],

  
  [party_tpl|pt_deserters,"start", [
      (eq,"$talk_context",tc_party_encounter),
                    ], "We are free, and from now on we will fight only for ourselves.^ Now give us your silver, or taste our steel.", "deserter_talk",[]],
##  [anyone|plyr,"deserter_talk", [(check_quest_active, "qst_bring_back_deserters"),
##                                 (quest_get_slot, ":target_deserter_troop", "qst_bring_back_deserters", slot_quest_target_troop),
##                                 (party_count_members_of_type, ":num_deserters", "$g_encountered_party",":target_deserter_troop"),
##                                 (gt, ":num_deserters", 1)],
##   "If you surrender to me now, you will rejoin the army of your kingdom without being punished. Otherwise you'll get a taste of my sword.", "deserter_join_as_prisoner",[]],
  [anyone|plyr,"deserter_talk", [], "I only pay those who deserve payment!", "close_window",[]],
  [anyone|plyr,"deserter_talk", [], "There's no need to fight. I am ready to pay.", "deserter_barter",[]],

##  [anyone,"deserter_join_as_prisoner", [(call_script, "script_party_calculate_strength", "p_main_party"),
##                                        (assign, ":player_strength", reg0),
##                                        (store_encountered_party,":encountered_party"),
##                                        (call_script, "script_party_calculate_strength", ":encountered_party"),
##                                        (assign, ":enemy_strength", reg0),
##                                        (val_mul, ":enemy_strength", 2),
##                                        (ge, ":player_strength", ":enemy_strength")],
##   "All right we join you then.", "close_window",[(assign, "$g_enemy_surrenders", 1)]],
##  [anyone,"deserter_join_as_prisoner", [], "TODO: We will never surrender!", "close_window",[(encounter_attack)]],

  [anyone,"deserter_barter", [], "Good. You are clever. Pay us {reg5} thaler, and you can go.", "deserter_barter_2",[
    #(deserters wants only 5% of player's total richness + player character level * 20 + 50)
	(store_character_level, ":player_character_level", "trp_player"),
	(store_mul, "$g_tribute_amount", ":player_character_level", 20),	
	(val_add, "$g_tribute_amount", 50),
	
    (store_troop_gold, ":total_value", "trp_player"),
    (troop_get_inventory_capacity, ":inv_size", "trp_player"),
    (try_for_range, ":i_slot", 0, ":inv_size"),
         (troop_get_inventory_slot, ":item_id", "trp_player", ":i_slot"),
         (ge, ":item_id", 0),
         (try_begin),
           (is_between, ":item_id", trade_goods_begin, trade_goods_end),
           (store_item_value, ":item_value", ":item_id"),
           (val_add, ":total_value", ":item_value"),
         (try_end),
    (try_end),    
	(store_div, ":total_value_div_20", ":total_value", 200), 
	(val_mul, ":total_value_div_20", 10), 
	(val_add, "$g_tribute_amount", ":total_value_div_20"),	

    (assign,reg5,"$g_tribute_amount"),
	
	]],
  [anyone|plyr,"deserter_barter_2", [(store_troop_gold,reg2),(ge,reg2,"$g_tribute_amount"),(assign,reg5,"$g_tribute_amount")],
   "All right, here's your {reg5} thaler.", "deserter_barter_3a",[
	(troop_remove_gold, "trp_player","$g_tribute_amount"), 
	#oim code	
	(call_script, "script_get_closest_walled_center", "$g_encountered_party"), #":spawn_party"),
	(assign, ":party_to_patrol", reg0),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_main_object, ":party_to_patrol"),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_attack, 0),
	(call_script, "script_party_set_ai_state", "$g_encountered_party", spai_patrolling_around_center, ":party_to_patrol"),
	(party_set_ai_behavior, "$g_encountered_party", ai_bhvr_patrol_location),
	(party_set_slot, "$g_encountered_party", slot_spawn_party_is_control, 17),
	(party_relocate_near_party, "$g_encountered_party", "p_main_party", 2),

	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),

	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),

	  (le, ":dist", 25),
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	(try_end),
	#oim code
   ]],
  [anyone|plyr,"deserter_barter_2", [],
   "I don't have that much money with me.", "deserter_barter_3b",[]],
  [anyone,"deserter_barter_3b", [],
   "Too bad. Then we'll have to sell you to the slavers.", "close_window",[]],


  [anyone,"deserter_barter_3a", [], "Ha ha! Good. Now go.", "close_window",[
    (store_current_hours,":protected_until"),
    (val_add, ":protected_until", 72),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,":protected_until"),
    (party_ignore_player, "$g_encountered_party", 72),
	(party_set_ignore_with_player_party, "p_main_party", 72),
      
	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (str_store_party_name, s1, ":party_no"),	  
	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),
	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),
	  (assign, reg1, ":dist"),
	  (le, ":dist", 25),	  
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	  (str_store_party_name, s1, ":party_no"),
	(try_end),

    (assign, "$g_leave_encounter",1),
    ]],

##### TODO: QUESTS COMMENT OUT END

#Tavernkeepers

  [anyone ,"start", [(store_conversation_troop,reg(1)),(ge,reg(1),tavernkeepers_begin),(lt,reg(1),tavernkeepers_end)],
   "Good day my dear {sir/lady}. How can I help you?", "tavernkeeper_talk",
   [
#    (store_encountered_party,reg(2)),
#    (party_get_slot,"$tavernkeeper_party",reg(2),slot_town_mercs),
    ]],
  
  [anyone,"tavernkeeper_pretalk", [], "Anything else?", "tavernkeeper_talk",[]],

  [anyone|plyr,"tavernkeeper_talk", [(check_quest_active,"qst_deliver_wine"),
                                     (quest_slot_eq, "qst_deliver_wine", slot_quest_target_center, "$g_encountered_party"),
                                     (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
                                     (quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
                                     (store_item_kind_count, ":item_count", ":quest_target_item"),
                                     (ge, ":item_count", ":quest_target_amount"),
                                     (assign, reg9, ":quest_target_amount"),
                                     (str_store_item_name, s4, ":quest_target_item"),
                                     ],
   "I was told to deliver you {reg9} units of {s4}.", "tavernkeeper_deliver_wine",[]],
  [anyone,"tavernkeeper_deliver_wine", [],
 "At last! My stores were nearly depleted. I had paid for the {s4} in advance. Here, take these {reg5} thaler. That should cover you expenses. And give {s9} my regards. I'll put in a good word for you next time I speak with him.", "tavernkeeper_pretalk",
   [(quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
    (quest_get_slot, ":quest_gold_reward", "qst_deliver_wine", slot_quest_gold_reward),
    (quest_get_slot, ":quest_giver_troop", "qst_deliver_wine", slot_quest_giver_troop),
	(assign, reg8, ":quest_target_item"),
	(assign, reg9, ":quest_target_amount"),
    (troop_remove_items, "trp_player", ":quest_target_item", ":quest_target_amount"),
    (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
    (assign, ":xp_reward", ":quest_gold_reward"),
    (val_mul, ":xp_reward", 4),
    (add_xp_as_reward, ":xp_reward"),
    (assign, reg5, ":quest_gold_reward"),
    (str_store_item_name, s4, ":quest_target_item"),
    (str_store_troop_name, s9, ":quest_giver_troop"),
    
    (quest_get_slot, ":giver_town", "qst_deliver_wine", slot_quest_giver_center),
    (call_script, "script_change_player_relation_with_center", ":giver_town", 2),
    (call_script, "script_change_player_relation_with_center", "$current_town", 1),
    (call_script, "script_end_quest", "qst_deliver_wine"),
    ]],

  [anyone|plyr,"tavernkeeper_talk", [(check_quest_active,"qst_deliver_wine"),
                                     (quest_slot_eq, "qst_deliver_wine", slot_quest_target_center, "$g_encountered_party"),
                                     (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
                                     (quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
                                     (store_item_kind_count, ":item_count", ":quest_target_item"),
                                     (lt, ":item_count", ":quest_target_amount"),
									 (store_div, ":quest_target_amount_div_2", ":quest_target_amount", 2),
                                     (ge, ":item_count", ":quest_target_amount_div_2"),
                                     (assign, reg9, ":quest_target_amount"),
                                     (str_store_item_name, s4, ":quest_target_item"),
                                     ],
   "I was told to deliver you {reg9} units of {s4}, but I lost some of the cargo along the way.", "tavernkeeper_deliver_wine_incomplete",[]],
  [anyone,"tavernkeeper_deliver_wine_incomplete", [],
 "Attacked by bandits, eh? You're lucky they let you live. I'm afraid I can pay you no more than {reg5} thaler for this. And I will let the seller know that my order was not delivered in full. You will probably be charged for this loss.", "tavernkeeper_pretalk",
   [(quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
    (quest_get_slot, ":quest_gold_reward", "qst_deliver_wine", slot_quest_gold_reward),
    (quest_get_slot, ":quest_giver_troop", "qst_deliver_wine", slot_quest_giver_troop),
    (store_item_kind_count, ":item_count", ":quest_target_item"),
    (troop_remove_items, "trp_player", ":quest_target_item", ":item_count"),
    (val_mul, ":quest_gold_reward", ":item_count"),
    (val_div, ":quest_gold_reward", ":quest_target_amount"),
    (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
    (assign, reg5, ":quest_gold_reward"),
    (assign, ":xp_reward", ":quest_gold_reward"),
    (val_mul, ":xp_reward", 4),
    (add_xp_as_reward, ":xp_reward"),
    (str_store_troop_name, s1, ":quest_giver_troop"),
    (assign, ":debt", "$qst_deliver_wine_debt"),
    (store_sub, ":item_left", ":quest_target_amount", ":item_count"),
    (val_mul, ":debt", ":item_left"),
    (val_div, ":debt", ":quest_target_amount"),
    (val_add, "$debt_to_merchants_guild", ":debt"),
    (quest_get_slot, ":giver_town", "qst_deliver_wine", slot_quest_giver_center),
    (call_script, "script_change_player_relation_with_center", ":giver_town", 1),
    (call_script, "script_end_quest", "qst_deliver_wine"),
    ]],
  
  [anyone|plyr,"tavernkeeper_talk", [(check_quest_active,"qst_deliver_wine"),
                                     (quest_slot_eq, "qst_deliver_wine", slot_quest_target_center, "$g_encountered_party"),
                                     (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
                                     (store_item_kind_count, ":item_count", ":quest_target_item"),        
                                     (quest_get_slot, reg9, "qst_deliver_wine", slot_quest_target_amount),									 
									 (assign, ":quest_target_amount", reg9),
									 (store_div, ":quest_target_amount_div_2", ":quest_target_amount", 2),
                                     (lt, ":item_count", ":quest_target_amount_div_2"),
                                     (str_store_item_name, s4, ":quest_target_item"),
                                     ],
   "I was told to deliver you {reg9} units of {s4}, but I lost the cargo along the way.", "tavernkeeper_deliver_wine_lost",[]],
  
  [anyone,"tavernkeeper_deliver_wine_lost", [],
 "What? I have been waiting for that {s4} for weeks! And now you are telling me that you lost it?! You may rest assured that {s1} will hear all about this!", "tavernkeeper_pretalk",
   [(add_xp_as_reward, 40),
    (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (quest_get_slot, ":quest_giver_troop", "qst_deliver_wine", slot_quest_giver_troop),
    (str_store_item_name, s4, ":quest_target_item"),
    (str_store_troop_name, s1, ":quest_giver_troop"),
    (val_add, "$debt_to_merchants_guild", "$qst_deliver_wine_debt"),
    (call_script, "script_end_quest", "qst_deliver_wine"),
   ]],

##  [anyone|plyr,"tavernkeeper_talk", [], "I need to hire some soldiers. Can you help me?", "tavernkeeper_buy_peasants",[]],
##  [anyone,"tavernkeeper_buy_peasants",
##   [
##       (store_encountered_party,reg(3)),
##       (store_faction_of_party,reg(4),reg(3)),
##       (store_relation,reg(5),"fac_player_supporters_faction",reg(4)),
##       (lt, reg(5), -3),
##    ], "I don't think anyone from this town will follow somebody like you. Try your luck elsewhere.", "tavernkeeper_buy_peasants_2",[]],
##  [anyone,"tavernkeeper_buy_peasants", [], "I know a few fellows who would follow you if you paid for their equipment.", "tavernkeeper_buy_peasants_2",[(set_mercenary_source_party,"$tavernkeeper_party"),[change_screen_buy_mercenaries]]],
##  [anyone,"tavernkeeper_buy_peasants_2", [], "Anything else?", "tavernkeeper_talk",[]],
##
##  [anyone|plyr,"tavernkeeper_talk", [], "I want to rest for a while.", "tavernkeeper_rest",[]],
###  [anyone,"tavernkeeper_rest", [], "Of course... How long do you want to rest?", "tavernkeeper_rest_2",[]],
##  [anyone,"tavernkeeper_rest",
##   [
##       (store_encountered_party,reg(3)),
##       (store_faction_of_party,reg(4),reg(3)),
##       (store_relation,reg(5),"fac_player_supporters_faction",reg(4)),
##       (lt, reg(5), -3),
##      ], "You look like trouble stranger. I can't allow you to stay for the night. No.", "close_window",
##   []],
##  [anyone,"tavernkeeper_rest", [], "Of course... That will be {reg3} denars for the room and food. How long do you want to rest?", "tavernkeeper_rest_2",
##   [(store_party_size,reg(3)),
##    (val_add,reg(3),1),
##    (val_div,reg(3),3),
##    (val_max,reg(3),1),
##    (assign,"$tavern_rest_cost",reg(3))]],
##  [anyone|plyr,"tavernkeeper_rest_2", [(store_time_of_day,reg(1)),
##                                       (val_add,reg(1),7),
##                                       (val_mod,reg(1),24),
##                                       (lt,reg(1),12),
##                                       (store_troop_gold,reg(8),"trp_player"),
##                                       (ge,reg(8),"$tavern_rest_cost"),
##                                       ],
##   "I want to rest until morning.", "close_window",
##   [(assign, reg(2), 13),(val_sub,reg(2),reg(1)),(assign, "$g_town_visit_after_rest", 1),(rest_for_hours, reg(2)),(troop_remove_gold, "trp_player","$tavern_rest_cost"),(call_script, "script_change_player_party_morale", 2)]],
##  [anyone|plyr,"tavernkeeper_rest_2", [(store_time_of_day,reg(1)),
##                                       (val_add,reg(1),7),
##                                       (val_mod,reg(1),24),
##                                       (ge,reg(1),12),
##                                       (store_troop_gold,reg(8),"trp_player"),
##                                       (ge,reg(8),"$tavern_rest_cost"),
##                                       ],
##   "I want to rest until evening.", "close_window",
##   [(assign, reg(2), 28),(val_sub,reg(2),reg(1)),(assign, "$g_town_visit_after_rest", 1),(rest_for_hours, reg(2)),(troop_remove_gold, "trp_player","$tavern_rest_cost"),(call_script, "script_change_player_party_morale", 2)]],
##  [anyone|plyr,"tavernkeeper_rest_2", [], "Forget it.", "close_window",[]],

  [anyone|plyr,"tavernkeeper_talk", [
      (store_current_hours,":cur_hours"),
      (val_sub, ":cur_hours", 24),
      (gt, ":cur_hours", "$buy_drinks_last_time"),
      ], "I'd like to buy every man who enters here tonight a jar of your best wine.", "tavernkeeper_buy_drinks",[]],

  [anyone,"tavernkeeper_buy_drinks",
   [
    ], "Of course, {my lord/my lady}. I reckon {reg5} thaler should be enough for that. What should I tell the lads?", "tavernkeeper_buy_drinks_2",[
        (assign, "$temp", 1000),
        (assign, reg5, "$temp"),
        ]],

  [anyone|plyr,"tavernkeeper_buy_drinks_2",
   [
        (store_troop_gold, ":gold", "trp_player"),
        (ge, ":gold", "$temp"),
        (str_store_party_name, s10, "$current_town"),
    ], "Tell everyone of the generosity of {playername} to the people of {s10}.", "tavernkeeper_buy_drinks_end",
	[
      (unlock_achievement, ACHIEVEMENT_NA_ZDOROVIE),	  
    ]],

  [anyone,"tavernkeeper_buy_drinks_end",
   [], "Don't worry {sir/madam}. Your name will be cheered and toasted here all night.", "tavernkeeper_pretalk",
   [
       (troop_remove_gold, "trp_player", "$temp"),
       (call_script, "script_change_player_relation_with_center", "$current_town", 1),
       (store_current_hours,":cur_hours"),
       (assign, "$buy_drinks_last_time", ":cur_hours"),
       ]],
  

  [anyone|plyr,"tavernkeeper_buy_drinks_2", [], "Actually, never mind. Cancel that order.", "tavernkeeper_pretalk",[]],

  [anyone|plyr,"tavernkeeper_talk", [
	(neg|party_slot_eq,"$current_town",slot_party_type, spt_castle),
  ], "I would have some wine, I suppose... And perhaps I might spend the night...", "oim_tavern_rich_visitor",[]],
  
#  [anyone|plyr,"tavernkeeper_talk", [
#	#(neg|party_slot_eq,"$current_town",slot_party_type, spt_castle),
#  ], "I'd like to stay there for a while ", "oim_tavern_rich_visitor",[]],
#  
  
  [anyone|plyr,"tavernkeeper_talk", [], "I think it's about time I leave now.", "close_window",[]],

#Tavern Talk (with companions)
#  [anyone, "companion_recruit_yes", [(neg|hero_can_join, "p_main_party"),], "I don't think can lead any more men than you do now.\
# You need to release someone from service if you want me to join your party.", "close_window", []],




#Tavern Talk (with ransom brokers)


  [anyone,"start", [(is_between, "$g_talk_troop", ransom_brokers_begin, ransom_brokers_end),
                    (eq, "$g_talk_troop_met", 0)],
   "Good day, {sir/madam}. I suppose I could be of use to you...", "ransom_broker_intro",[]],

  [anyone|plyr,"ransom_broker_intro",[], "How could you be of use to me, anyway?", "ransom_broker_intro_2",[]],
  [anyone, "ransom_broker_intro_2", [], "You know what me do for a living, no? Ah, listen then... Me broker ransom for prisoners. Me travels long, long way -- from the salt mines to the slave markets on the coast... Along the way, me comes across some misters dragging captive men. Me buys prisoners and sell to the slavers. You have prisoners to sell, my lord? I pay good price, you know.", "ransom_broker_info_talk",[(assign, "$ransom_broker_families_told",0),
                                                                                            (assign, "$ransom_broker_prices_told",0),
                                                                                            (assign, "$ransom_broker_ransom_me_told",0),
                                                                                            ]],

  [anyone|plyr,"ransom_broker_info_talk",[(eq, "$ransom_broker_families_told",0)], "What if their families can't pay?", "ransom_broker_families",[]],
  [anyone, "ransom_broker_families", [], "Oh, then me spin them a sad-sad tale -- a life on the galleys. Suddenly even very poor peasants digs treasures out of his cowshed, oh my!", "ransom_broker_info_talk",[(assign, "$ransom_broker_families_told",1)]],
  [anyone|plyr,"ransom_broker_info_talk",[(eq, "$ransom_broker_prices_told",0)], "What would you pay for a prisoner?", "ransom_broker_prices",[]],
  [anyone, "ransom_broker_prices", [], "It vary. Me have a good nose for ransoms. One look at the man can tell me whether they goes to bed hungry, or dines each night on soft dumplings and goose. The real monies of course is the gentry... Me know every land-owning house here, the estates, the heraldry, their offspring, and, of course, their credit with the merchants.", "ransom_broker_info_talk",[(assign, "$ransom_broker_prices_told",1)]],
  [anyone|plyr,"ransom_broker_info_talk",[(eq, "$ransom_broker_ransom_me_told",0)], "Would you be able to ransom me if I were taken?", "ransom_broker_ransom_me",[]],
  [anyone, "ransom_broker_ransom_me", [], "Of course, my {lord/lady}, of course. Keep the silver buried somewhere deep, and tell a loyal servant what to do when you get captured.", "ransom_broker_info_talk",[(assign, "$ransom_broker_ransom_me_told",1)]],
  [anyone|plyr,"ransom_broker_info_talk",[], "That's all I need to know. Thanks.", "ransom_broker_pretalk",[]],

  [anyone,"start", [(is_between, "$g_talk_troop", ransom_brokers_begin, ransom_brokers_end),],
   "Got some prisoners, my good {man/woman}?", "ransom_broker_talk",[]],
  [anyone,"ransom_broker_pretalk", [],
   "My {lord/lady}, you have some to sell, and I will gladly buy!", "ransom_broker_talk",[]],

  [anyone|plyr,"ransom_broker_talk",
   [[store_num_regular_prisoners,reg(0)],[ge,reg(0),1]],
   "Then you'd better bring your purse. I have got some to sell.", "ransom_broker_sell_prisoners",[]],
  [anyone|plyr,"ransom_broker_talk", [], "Tell me about what you do again.", "ransom_broker_intro_2",[]],
  
    #oim code
  [anyone|plyr,"ransom_broker_talk", [
		(check_quest_active, "qst_oim_alevtina_hanum"),
		(neg|check_quest_succeeded, "qst_oim_alevtina_hanum"),
		(neg|check_quest_finished,"qst_oim_alevtina_hanum"),
		(quest_slot_eq, "qst_oim_alevtina_hanum", slot_quest_current_state, 0),	
  ], "Have you perhaps heard of a Russian Boyarina captured recently?", "oim_dmitriy_ransom_brok_dlg",[]],
  
  
    [anyone|plyr,"ransom_broker_talk",[], "Not this time. Good-bye.", "close_window",[(jump_to_menu, "mnu_auto_return_to_map"),]],
  [anyone,"ransom_broker_sell_prisoners", [],
  "Let me look...", "ransom_broker_sell_prisoners_2",
   [[change_screen_trade_prisoners]]],
#  [anyone, "ransom_broker_sell_prisoners_2", [], "You take more prisoners, bring them to me. I will pay well.", "close_window",[]],
  [anyone, "ransom_broker_sell_prisoners_2", [], "My few days a-staying here, good man. Sell me prisoner, me pay very well.", "close_window",[
		(jump_to_menu, "mnu_auto_return_to_map"),
  ]],


#Tavern Talk (with travelers)
  [anyone, "start", [(is_between, "$g_talk_troop", tavern_travelers_begin, tavern_travelers_end),
                     (str_store_troop_name, s10, "$g_talk_troop"),
                     (eq,"$g_talk_troop_met",0),
                     ],
   "Somehow I feel you are the kind of {man/person} who'd do well to know me, {sir/madam}. I travel much, and keep an open ear. I can provide you information that you might find useful. For a small price, of course.", "tavern_traveler_talk", [(assign, "$traveler_land_asked", 0)]],

  [anyone, "start",
   [
     (is_between, "$g_talk_troop", tavern_travelers_begin, tavern_travelers_end),
     (gt, "$last_lost_companion", 0),
     (assign, ":companion_found_town", -1),
     (troop_get_slot, ":companion_found_town", "$last_lost_companion", slot_troop_cur_center),
     (is_between, ":companion_found_town", towns_begin, towns_end),
     (str_store_troop_name, s10, "$last_lost_companion"),
     (str_store_party_name, s11, ":companion_found_town"),
     ],
   "Greetings, {playername}. I saw your companion {s10} at a tavern in {s11} some days ago. It's a small world, as they say. I thought you might like to know.", "tavern_traveler_lost_companion_thanks",
   [(assign, "$last_lost_companion", 0)]],

  [anyone|plyr, "tavern_traveler_lost_companion_thanks", [(troop_get_type, reg3, "$last_lost_companion")], "Thanks. I'll go and find {reg3?her:him} there.", "tavern_traveler_pretalk", []],
  [anyone|plyr, "tavern_traveler_lost_companion_thanks", [], "Thanks, but I'm not particularly interested.", "tavern_traveler_pretalk", []],

  [anyone, "start", [(is_between, "$g_talk_troop", tavern_travelers_begin, tavern_travelers_end),
                     ],
   "Greetings, {playername}.", "tavern_traveler_talk", [(assign, "$traveler_land_asked", 0)]],



  [anyone, "tavern_traveler_pretalk", [], "Yes?", "tavern_traveler_talk", []],

  [anyone|plyr, "tavern_traveler_talk", [(eq, "$traveler_land_asked", 0)], "What can you tell me about this land?", "tavern_traveler_tell_kingdoms", [(assign, "$traveler_land_asked", 1)]],
  [anyone, "tavern_traveler_tell_kingdoms", [], "There's seldom a break from the bitter wars... Well, at least that makes it a good place to be, for daring people such as yourself. With some luck and skill, you can make a name for yourself here, perhaps even amass a fortune, or gain great power.", "tavern_traveler_tell_kingdoms_2", []],
  
  [anyone|plyr, "tavern_traveler_tell_kingdoms_2", [], "Interesting... Tell me more.", "tavern_traveler_tell_kingdoms_3", []],
  [anyone|plyr, "tavern_traveler_tell_kingdoms_2", [], "All right, I understand. Now I must go...", "close_window", []],

  [anyone, "tavern_traveler_tell_kingdoms_3", [(gt, "$player_has_homage", 0)], "Well, you probably know everything I could tell you already...",
   "tavern_traveler_tell_kingdoms_4", []],
  [anyone, "tavern_traveler_tell_kingdoms_3", [], "Nations engaged in war will pay good money for mercenaries. If you've done even a bit of fighting, speaking with one of the sovereigns will probably result in a mercenary contract. However, the real rewards come if you can manage to become a sworn subject of one of these sovereigns. Subjects can own villages, fortresses, and towns -- and grow wealthy from the taxes and revenues of their estates. Normally only nobles of the realm own land in this way, but in times of war, a regent will not hesitate to accept as his confidant someone who distinguishes {himself/herself} on the battlefield, and grant {him/her} the right to own land.",
   "tavern_traveler_tell_kingdoms_4", []],
   
  [anyone, "tavern_traveler_tell_kingdoms_4", [], "Nowadays there is no rest for the kings! Each has his own rivals, other men born to the right family, who might go around stirring up trouble, claiming a right to the throne. If these men find supporters, they could easily start civil wars, and perhaps even win the crown one day.",
   "tavern_traveler_tell_kingdoms_5", []],

  [anyone|plyr, "tavern_traveler_tell_kingdoms_5", [], "Interesting. Where can I find men who hold such claims?", "tavern_traveler_tell_kingdoms_6", []],
  [anyone|plyr, "tavern_traveler_tell_kingdoms_5", [], "I guess I have heard enough already. Thank you.", "close_window", []],

  [anyone, "tavern_traveler_tell_kingdoms_6", [], "A claim holder's life is in danger in his own country, of course. Therefore, they usually travel constantly through the towns and cities of their nation, raising their supporters. I often hear rumors about some of them, and may be able to tell you their location with some precision. But of course, I would ask for a little something in return for such a service.",
   "tavern_traveler_pretalk", [(assign, "$traveller_claimants_mentioned", 1)]],

  [anyone|plyr, "tavern_traveler_talk", [(eq, "$traveller_claimants_mentioned", 1)], "I want to know the location of a claimant.", "tavern_traveler_pretender_location", []],
  [anyone, "tavern_traveler_pretender_location", [], "Whose location do you want to know?", "tavern_traveler_pretender_location_ask", []],

  [anyone|plyr|repeat_for_troops, "tavern_traveler_pretender_location_ask",
   [
     (store_repeat_object, ":troop_no"),
     (is_between, ":troop_no", pretenders_begin, pretenders_end),
     (neg|troop_slot_eq, ":troop_no", slot_troop_occupation, slto_kingdom_hero),
     (troop_slot_ge, ":troop_no", slot_troop_cur_center, 1),
     (str_store_troop_name, s11, ":troop_no"),
     (neq, ":troop_no", "$supported_pretender"),
     ],  "{s11}", "tavern_traveler_pretender_location_ask_2",
   [
     (store_repeat_object, "$temp"),
     ]],

  [anyone|plyr, "tavern_traveler_pretender_location_ask",
   [],  "Return...", "tavern_traveler_pretalk", []],


  [anyone, "tavern_traveler_pretender_location_ask_2", [], "I can reveal this information to you for a small price... Let us say 30 thaler.", "tavern_traveler_pretender_location_ask_money", []],
  
  [anyone|plyr, "tavern_traveler_pretender_location_ask_money",
   [
     (store_troop_gold, ":cur_gold", "trp_player"),
     (ge, ":cur_gold", 30),
     ], "All right. Here is 30 thaler.", "tavern_traveler_pretender_location_tell",
   [
     (troop_remove_gold, "trp_player", 30),
   ]],
  
  [anyone|plyr, "tavern_traveler_pretender_location_ask_money", [], "Never mind.", "tavern_traveler_pretalk", []],

  [anyone, "tavern_traveler_pretender_location_tell", [], "{s15} is currently at {s11}.", "tavern_traveler_pretalk",
   [
     (str_store_troop_name, s15, "$temp"),
     (troop_get_slot, ":cur_center", "$temp", slot_troop_cur_center),
     (str_store_party_name, s11, ":cur_center"),
   ]],


  [anyone|plyr, "tavern_traveler_talk", [], "I am looking for one of my companions...", "tavern_traveler_companion_location", []],

  [anyone, "tavern_traveler_companion_location", [], "I'm not sure I can help you. Who are you looking for?", "tavern_traveler_companion_location_ask", []],

  [anyone|plyr|repeat_for_troops, "tavern_traveler_companion_location_ask",
   [
     (store_repeat_object, ":troop_no"),
     (is_between, ":troop_no", companions_begin, companions_end),
     (troop_slot_ge, ":troop_no", slot_troop_cur_center, 1),
     (troop_slot_ge, ":troop_no", slot_troop_playerparty_history, 1),
     (str_store_troop_name, s11, ":troop_no"),
     ],  "{s11}", "tavern_traveler_companion_location_ask_2",
   [
     (store_repeat_object, "$temp"),
     ]],
     
  [anyone|plyr, "tavern_traveler_companion_location_ask",
   [],  "Never mind.", "tavern_traveler_pretalk", []],
     
  [anyone, "tavern_traveler_companion_location_ask_2", [(str_store_troop_name, s15, "$temp")], "I guess I know where {s15} is. For 30 thaler, I'll tell you.", "tavern_traveler_companion_location_ask_money", []],
	 
  [anyone|plyr, "tavern_traveler_companion_location_ask_money",
   [
     (store_troop_gold, ":cur_gold", "trp_player"),
     (ge, ":cur_gold", 30),
     ], "All right. Here is 30 thaler.", "tavern_traveler_companion_location_tell",
   [
     (troop_remove_gold, "trp_player", 30),
     ]],
       
  [anyone|plyr, "tavern_traveler_companion_location_ask_money", [], "Never mind.", "tavern_traveler_pretalk", []],
          
  [anyone, "tavern_traveler_companion_location_tell", [], "{s15} is currently at {s11}.", "tavern_traveler_pretalk",
   [
     (str_store_troop_name, s15, "$temp"),
     (troop_get_slot, ":cur_center", "$temp", slot_troop_cur_center),
     (str_store_party_name, s11, ":cur_center"),
   ]],

  [anyone|plyr, "tavern_traveler_talk", [], "I'm looking for a certain Frenchman...", "mon_tavern_traveler_companion_location", []],

  [anyone, "mon_tavern_traveler_companion_location", [], "I'm not sure I can help you. Who interests you?", "mon_tavern_traveler_companion_location_ask", []],

  [anyone|plyr, "mon_tavern_traveler_companion_location_ask",
   [
     (assign, ":troop_no", "trp_oim_monfor"),
     (str_store_troop_name, s11, ":troop_no"),
     ],  "{s11}", "mon_tavern_traveler_companion_location_ask_2",
   [
     (assign, "$temp", "trp_oim_monfor"),
     ]],

  [anyone|plyr, "mon_tavern_traveler_companion_location_ask",
   [],  "Never mind.", "tavern_traveler_pretalk", []],

  [anyone, "mon_tavern_traveler_companion_location_ask_2", [(str_store_troop_name, s15, "$temp")], "Perhaps I know where {s15} is. I'll tell for 30 thaler.", "mon_tavern_traveler_companion_location_ask_money", []],

  [anyone|plyr, "mon_tavern_traveler_companion_location_ask_money",
   [
     (store_troop_gold, ":cur_gold", "trp_player"),
     (ge, ":cur_gold", 30),
     ], "Good. Here's 30 thaler.", "mon_tavern_traveler_companion_location_tell",
   [
     (troop_remove_gold, "trp_player", 30),
     ]],
  
  [anyone|plyr, "mon_tavern_traveler_companion_location_ask_money", [], "No, thank you.", "tavern_traveler_pretalk", []],

  [anyone, "mon_tavern_traveler_companion_location_tell", [], "{s15} is now in {s11}.", "tavern_traveler_pretalk",
   [
     (str_store_troop_name, s15, "$temp"),
	 (try_begin), 
		(check_quest_active,"qst_oim_monfor_shved"),
		(neg|check_quest_succeeded, "qst_oim_monfor_shved"), 
		(neg|check_quest_finished, "qst_oim_monfor_shved"),
		(str_store_party_name, s11, "p_town_9"),
	 (else_try), 		
		(check_quest_active,"qst_oim_monfor_shved"),
		(check_quest_succeeded, "qst_oim_monfor_shved"), 
		(neg|check_quest_finished, "qst_oim_monfor_shved"),
		(str_store_party_name, s5, 0),
		(str_store_string, s11, "str_s5_s_party"),
	 (else_try), 
		(str_store_party_name, s11, "p_town_13"),
	 (end_try), 
     ]],
  
  [anyone|plyr, "tavern_traveler_talk", [],
   "I must leave now.", "close_window", []],

  [anyone, "start", [(is_between, "$g_talk_troop", tavern_travelers_begin, tavern_travelers_end),
                     (party_get_slot, ":info_faction", "$g_encountered_party", slot_center_traveler_info_faction),
                     (str_store_faction_name, s17, ":info_faction"),
                     ],
   "They say you're the kind of {man/woman} who'd be interested to hear that I travel frequently to {s17}. I'll tell you all I know for a mere 100 thaler.", "tavern_traveler_answer", []],

  [anyone|plyr, "tavern_traveler_answer", [(store_troop_gold, ":cur_gold", "trp_player"),
                                            (ge, ":cur_gold", 100)],
   "Valuable information indeed! Here's 100 thaler. Tell me what you know.", "tavern_traveler_continue", [(party_get_slot, ":info_faction", "$g_encountered_party", slot_center_traveler_info_faction),
                                           (call_script, "script_update_faction_traveler_notes", ":info_faction"),
                                           (change_screen_notes, 2, ":info_faction"),
                                           ]],

  [anyone|plyr, "tavern_traveler_answer", [],
   "Sorry friend. I am not interested.", "close_window", []],

  [anyone, "tavern_traveler_continue", [],
   "Well, that's all I can tell you. Good bye.", "close_window", [(troop_remove_gold, "trp_player", 100),]],

#Tavern Talk (with book sellers)
  [anyone, "start", [(is_between, "$g_talk_troop", tavern_booksellers_begin, tavern_booksellers_end),
                     ],
   "Good day {sir/madam}, will you be looking at my books?", "bookseller_talk", []],
  [anyone|plyr, "bookseller_talk", [], "Yes. Show me what you have for sale.", "bookseller_buy", []],
   
  [anyone|plyr, "bookseller_talk", [
		(check_quest_active, "qst_oim_getman_voron_book"),
		(neg|check_quest_succeeded, "qst_oim_getman_voron_book"), 
		(neg|check_quest_finished,"qst_oim_getman_voron_book"),
  ], "I would want to buy a special book from you...", "oim_getman_buy_book_trader", []],
  
  [anyone,"bookseller_buy", [], "Of course {sir/madam}.", "book_trade_completed",[[change_screen_trade]]],
  [anyone,"book_trade_completed", [], "Anything else?", "bookseller_talk",[]],

  [anyone|plyr,"bookseller_talk", [], "Nothing. Thanks.", "close_window",[]],
   


#Tavern Talk (with minstrels)
  [anyone, "start", [(is_between, "$g_talk_troop", tavern_minstrels_begin, tavern_minstrels_end),
                     ],
   "TODO: Hello. I am a minstrel. (Not implemented yet)", "close_window", []],
   
#Tavern Talk (with farmers)
  [anyone, "start", [(eq, "$talk_context", tc_tavern_talk),
                     (eq, "$g_talk_troop", "trp_farmer_from_bandit_village"),
                     (neg|check_quest_active, "qst_eliminate_bandits_infesting_village"),
                     (neg|check_quest_active, "qst_deal_with_bandits_at_lords_village"),
                     (assign, ":end_cond", villages_end),
                     (try_for_range, ":cur_village", villages_begin, ":end_cond"),
                       (party_slot_eq, ":cur_village", slot_village_bound_center, "$g_encountered_party"),
                       (party_slot_ge, ":cur_village", slot_village_infested_by_bandits, 1),
                       (str_store_party_name, s1, ":cur_village"),
                       (quest_set_slot, "qst_eliminate_bandits_infesting_village", slot_quest_target_center, ":cur_village"),
                       (quest_set_slot, "qst_eliminate_bandits_infesting_village", slot_quest_current_state, 0),
                       (party_get_slot, ":village_elder", ":cur_village", slot_town_elder),
                       (quest_set_slot, "qst_eliminate_bandits_infesting_village", slot_quest_giver_troop, ":village_elder"),
                       (quest_set_slot, "qst_eliminate_bandits_infesting_village", slot_quest_giver_center, ":cur_village"),
                       (assign, ":end_cond", 0),
                     (try_end),
                     ],
   "{My lord/Madam}, you look like a seasoned warrior, and one who could help us. Will you hear my plea?", "farmer_from_bandit_village_1", []],

  [anyone|plyr, "farmer_from_bandit_village_1", [],
   "What is the matter, my good man?", "farmer_from_bandit_village_2", []],
  [anyone|plyr, "farmer_from_bandit_village_1", [],
   "What are you blubbering about peasant? Out with it!", "farmer_from_bandit_village_2", []],

  [anyone, "farmer_from_bandit_village_2", [],
   "A band of brigands has taken refuge in our village. They take everything we have, force us to serve them, and do us much evil. If one of us so much as breathes a word against them, they kill the poor soul on the spot. Our lives have become unbearable. I risked my skin running away to find someone who can help us.", "farmer_from_bandit_village_3", []],
  [anyone|plyr, "farmer_from_bandit_village_3", [],
   "Why don't you just go to your master? He should take care of these vermin.", "farmer_from_bandit_village_4", []],
  [anyone, "farmer_from_bandit_village_4", [],
   "I did, {sir/madam}, but our lord's men did not let me see him, and said he was occupied with more important matters -- and that we should deal with our own problem ourselves. Please {sir/madam}, you look like a {man/lady} of valor and a fearsome warrior, and you have no doubt many friends and soldiers in your service. If there is anyone who can help us, it's you.", "farmer_from_bandit_village_5", [(assign, "$temp", 0)]],
  [anyone|plyr, "farmer_from_bandit_village_5", [],
   "Very well, I'll help you. Where is this village?", "farmer_from_bandit_village_accepted", []],
  [anyone|plyr, "farmer_from_bandit_village_5", [],
   "I can't be bothered with this right now.", "farmer_from_bandit_village_denied", []],
  [anyone|plyr, "farmer_from_bandit_village_5", [(eq, "$temp", 0)],
   "Why would I fight these bandits? What's in it for me?", "farmer_from_bandit_village_barter", []],

  
  [anyone, "farmer_from_bandit_village_accepted", [],
   "God bless you, {sir/madam}. Our village is {s7}. It is not too far from here.", "close_window",
   [(quest_get_slot, ":target_center", "qst_eliminate_bandits_infesting_village", slot_quest_target_center),
    (str_store_party_name_link,s7,":target_center"),
    (setup_quest_text, "qst_eliminate_bandits_infesting_village"),
    (str_store_string, s2, "@A villager from {s7} begged you to save their village from the bandits that took refuge there."),
    (call_script, "script_start_quest", "qst_eliminate_bandits_infesting_village", "$g_talk_troop"),
    ]],

  [anyone, "farmer_from_bandit_village_denied", [],"As you say {sir/madam}. Forgive me for bothering you.", "close_window", []],

  [anyone, "farmer_from_bandit_village_barter", [],
   "We are but poor farmers {sir/madam}, and the bandits have already taken most of what we have in this world. But we'll be glad to share with you whatever we have left!", "farmer_from_bandit_village_5", [(assign, "$temp", 1)]],
  
  [anyone, "start", [(eq, "$talk_context", tc_tavern_talk),
                     (eq, "$g_talk_troop", "trp_farmer_from_bandit_village"),
                     (check_quest_active, "qst_eliminate_bandits_infesting_village"),
                     ],
   "Thank you for helping us {sir/madam}. Crush those bandits!", "close_window", []],



#Tavern Talk (with troops)

  [anyone, "start", [(eq, "$talk_context", tc_tavern_talk),
                     (party_get_slot, ":mercenary_troop", "$g_encountered_party", slot_center_mercenary_troop_type),
                     (party_get_slot, ":mercenary_amount", "$g_encountered_party", slot_center_mercenary_troop_amount),
                     (gt, ":mercenary_amount", 0),
                     (store_sub, reg3, ":mercenary_amount", 1),
                     (store_sub, reg4, reg3, 1),
                     (call_script, "script_game_get_join_cost", ":mercenary_troop"),
                     (assign, ":join_cost", reg0),
                     (store_mul, reg5, ":mercenary_amount", reg0),
                     (party_get_free_companions_capacity, ":free_capacity", "p_main_party"),
                     (val_min, ":mercenary_amount", ":free_capacity"),
                     (store_troop_gold, ":cur_gold", "trp_player"),
                     (try_begin),
                       (gt, ":join_cost", 0),
                       (val_div, ":cur_gold", ":join_cost"),
                       (val_min, ":mercenary_amount", ":cur_gold"),
                     (try_end),
                     (assign, "$temp", ":mercenary_amount"),
					 (neq, "$g_talk_troop", "trp_npc1"),
                     ],
   "Do you have a need for mercenaries, {sir/madam}? {reg3?Me and {reg4?{reg3} of my mates:one of my mates} are:I am} looking for a famed commander. We'll join you for {reg5} thaler.", "mercenary_tavern_talk", []],

  [anyone, "start", [(eq, "$talk_context", tc_tavern_talk),],
   "Any orders, {sir/madam}?", "mercenary_after_recruited", []],

  [anyone|plyr, "mercenary_after_recruited", [],
   "Make your preparations. We'll move at dawn.", "mercenary_after_recruited_2", []],
  [anyone|plyr, "mercenary_after_recruited", [],
   "Take your time. We'll be staying in this town for a while.", "mercenary_after_recruited_2", []],

  [anyone, "mercenary_after_recruited_2", [], "Yes, {sir/madam}. We'll be ready as soon as you give us the word.", "close_window", []],

  [anyone|plyr, "mercenary_tavern_talk", [(party_get_slot, ":mercenary_amount", "$g_encountered_party", slot_center_mercenary_troop_amount),
                                          (eq, ":mercenary_amount", "$temp"),
                                          (party_get_slot, ":mercenary_troop", "$g_encountered_party", slot_center_mercenary_troop_type),
                                          (call_script, "script_game_get_join_cost", ":mercenary_troop"),
                                          (store_mul, reg5, "$temp", reg0),                                          
                                          ],
   "All right. For fine swordsmen I would not begrudge {reg5} thaler.", "mercenary_tavern_talk_hire", []],

  [anyone|plyr, "mercenary_tavern_talk", [(party_get_slot, ":mercenary_amount", "$g_encountered_party", slot_center_mercenary_troop_amount),
                                          (lt, "$temp", ":mercenary_amount"),
                                          (gt, "$temp", 0),
                                          (assign, reg6, "$temp"),
                                          (party_get_slot, ":mercenary_troop", "$g_encountered_party", slot_center_mercenary_troop_type),
                                          (call_script, "script_game_get_join_cost", ":mercenary_troop"),
                                          (store_mul, reg5, "$temp", reg0),
                                          ],
   "All right. But I can only hire {reg6} of you. Here is {reg5} thaler.", "mercenary_tavern_talk_hire", []],


  [anyone, "mercenary_tavern_talk_hire", [(store_random_in_range, ":rand", 0, 4),
                                          (try_begin),
                                            (eq, ":rand", 0),
                                            (gt, "$temp", 1),
                                            (str_store_string, s17,
                                             "@You chose well, {sir/madam}. My lads know how to keep their word and earn their pay."),
                                          (else_try),
                                            (eq, ":rand", 1), 
                                            (str_store_string, s17,
                                             "@Well done, {sir/madam}. Keep the money and wine coming our way, and there's no foe in Calradia you need fear."),
                                          (else_try),
                                            (eq, ":rand", 2), 
                                            (str_store_string, s17,
                                             "@We are at your service, {sir/madam}. Point us in the direction of those who need hurting, and we'll do the rest."),
                                          (else_try),
                                            (str_store_string, s17,
                                             "@You will not be dissapointed {sir/madam}. You will not find better warriors in all Calradia."),
                                          (try_end),],
   "{s17}", "close_window", [
                                          (party_get_slot, ":mercenary_troop", "$g_encountered_party", slot_center_mercenary_troop_type),
                                          (call_script, "script_game_get_join_cost", ":mercenary_troop"),
                                          (store_mul, ":total_cost", "$temp", reg0),
                                          (troop_remove_gold, "trp_player", ":total_cost"),
                                          (party_add_members, "p_main_party", ":mercenary_troop", "$temp"),
                                          (party_set_slot, "$g_encountered_party", slot_center_mercenary_troop_amount, 0),
                                          ]],

  [anyone|plyr, "mercenary_tavern_talk", [(eq, "$temp", 0),
                                          (party_get_free_companions_capacity, ":free_capacity", "p_main_party"),
                                          (ge, ":free_capacity", 1)],
   "Alas, I can't afford to hire any more men right now.", "tavern_mercenary_cant_lead", []],
  
  [anyone, "tavern_mercenary_cant_lead", [], "That's a pity. Well, {reg3?we will:I will} be lingering here a while yet, if you need to hire anyone.", "close_window", []],
  
  [anyone|plyr, "mercenary_tavern_talk", [(eq, "$temp", 0),
                                          (party_get_free_companions_capacity, ":free_capacity", "p_main_party"),
                                          (eq, ":free_capacity", 0)],
   "It's a good offer, but I can't take on any more men right now.", "tavern_mercenary_cant_lead", []],


  [anyone|plyr, "mercenary_tavern_talk", [],
   "I don't need any more men right now.", "close_window", []],

#Trainers
  [anyone,"start", [(is_between, "$g_talk_troop", training_gound_trainers_begin, training_gound_trainers_end),
                    (eq, "$g_talk_troop_met", 0)],
   "Good day to you {lad/lass}. You look like another adventurer who has come to try {his/her} chance in these lands. Well believe you me, you won't survive long here unless you know how to get yourself out of a tight spot.", "trainer_intro_1",[]],

  [anyone|plyr, "trainer_intro_1", [],
   "Thank you for your advice. This place looks like a training field. Maybe I can learn about fighting here?", "trainer_intro_2", []],

  [anyone,"trainer_intro_2", [],
   "Indeed you can. I am a veteran soldier... earned my scars in the old wars. But these days, I train young novices in this area. I can find you some opponents to practice with if you like. Or if you have any questions about fighting, feel free to ask me.", "trainer_intro_3",[]],
  
  [anyone|plyr, "trainer_intro_3", [],
   "Yes, I do have a few questions.", "trainer_intro_4a", []],
  [anyone|plyr, "trainer_intro_3", [],
   "Actually, I'd like to start practicing.", "trainer_intro_4b", []],

  [anyone, "trainer_intro_4a", [],
   "Well, ask anything you like.", "trainer_talk_combat", []],
  [anyone, "trainer_intro_4b", [],
   "Good. It's good to find someone eager to train. Let's see what you can do.", "trainer_practice_1", []],

 [anyone,"start", [(is_between, "$g_talk_troop", training_gound_trainers_begin, training_gound_trainers_end),
                   (neq,"$waiting_for_training_fight_result", 0),
                   (neq,"$training_fight_won", 0)],
 "That was a good fight. ", "trainer_practice_1",
  [(val_sub, "$num_opponents_to_beat_in_a_row", 1),
   (assign,"$waiting_for_training_fight_result",0),
   ]],
  [anyone,"start", [(is_between, "$g_talk_troop", training_gound_trainers_begin, training_gound_trainers_end),
                    (neq, "$waiting_for_training_fight_result", 0)],
 "Ha! Looks like you've got a bit of a limp there. Don't worry, losses are often just as valuable as victories. Shake the stars out of your head and get back in there. There's no other way to win.", "trainer_practice_1",
   [(assign,"$num_opponents_to_beat_in_a_row",3),(assign,"$waiting_for_training_fight_result",0)]],

    [anyone,"start", [(is_between, "$g_talk_troop", training_gound_trainers_begin, training_gound_trainers_end)],
   "Hello there. Ready for some training today?", "trainer_talk",[]],

    [anyone,"trainer_pretalk", [],
   "Ah, are you ready for some training?", "trainer_talk",[]],
  
    [anyone|plyr,"trainer_talk", [],
   "I am ready to practice.", "trainer_practice_1",[]],

    [anyone|plyr,"trainer_talk", [],
   "First, tell me something about combat...", "trainer_combat_begin",[]],

##    [anyone|plyr,"trainer_talk", [],
##   "I have some novice soldiers with me. Can you train them?", "trainer_train_novices_1",[]],

    [anyone|plyr,"trainer_talk", [],
   "I must leave now. Farewell.", "close_window",[]],


    [anyone,"trainer_combat_begin", [],
   "What do you want to know?", "trainer_talk_combat",[]],
    [anyone,"trainer_combat_pretalk", [],
   "What else do you want to know?", "trainer_talk_combat",[]],

    [anyone|plyr,"trainer_talk_combat", [], "Tell me about how I can defend myself.", "trainer_explain_defense",[]],
    [anyone|plyr,"trainer_talk_combat", [], "Tell me about attacking with weapons.", "trainer_explain_attack",[]],
    [anyone|plyr,"trainer_talk_combat", [], "Tell me about cavalry attacks.", "trainer_explain_horseback",[]],
#    [anyone|plyr,"trainer_talk_combat", [], "Tell me about using ranged weapons.", "trainer_explain_ranged",[]],
#    [anyone|plyr,"trainer_talk_combat", [], "Tell me about weapon types.", "trainer_explain_weapon_types",[]],
    [anyone|plyr,"trainer_talk_combat", [], "I guess I know just about all I need. Let's talk about something else.", "trainer_pretalk",[]],

   [anyone,"trainer_explain_defense", [], "Good question. The first thing fighters need to know is how to defend themselves. Keeping out of harm's way is the first rule of combat, and it is much more important than dealing harm to others. Anybody can swing a sword around and hope to cut some flesh, but only those fighters that are experts at defense live to tell the story.",
	"trainer_explain_defense_2",[]],
  [anyone,"trainer_explain_defense_2", [], "Now. Defending yourself is easiest if you are equipped with a shield. Just block with your shield. [Hold down the right mouse button to defend yourself with the shield.] While you're defending yourself like this, you will be able to deflect all attacks that come from your front. However, you still need to watch for strikes from the sides and rear.", "trainer_explain_defense_3",[]],
  [anyone|plyr,"trainer_explain_defense_3", [], "What if I don't have shield?", "trainer_explain_defense_4",[]],
  [anyone,"trainer_explain_defense_4", [], "If you don't have a shield, you'll have to block with your weapon. It's a bit more difficult than defending with a shield, but it only takes a little practice. When defending with a weapon, you can block against only ONE attack direction. That is, you can block against either overhead swings, side swings, or thrusts. Therefore you have to watch your opponent carefully, and start to block only AFTER he starts his attack. This way you can block against the direction of his current attack. If you start to block BEFORE he makes his move, he may just attack in another direction than the one you are blocking against -- and score a hit.", "trainer_combat_pretalk",[]],
  [anyone,"trainer_explain_attack", [], "Good question. A strong attack is the best defense, as they say. A common tactic is to take an offensive stance and ready your weapon for attack, waiting for just the right moment to swing. [You can ready your weapon for attack by pressing and holding down the left mouse button.]", "trainer_explain_attack_2",[]],
  [anyone|plyr,"trainer_explain_attack_2", [], "That sounds useful.", "trainer_explain_attack_3",[]],
  [anyone,"trainer_explain_attack_3", [], "It is a good tactic, but remember that your opponent may see that, and take a defensive stance against the direction you are swinging your weapon. If that happens, you should break your attack and quickly attack from another direction. [You can cancel your current attack by quickly tapping the right mouse button.]", "trainer_explain_attack_4",[]],
  [anyone|plyr,"trainer_explain_attack_4", [], "Oh, so if my opponent is defending against the direction I am attacking from, I will break off the attack, and attack from another direction?", "trainer_explain_attack_5",[]],
  [anyone,"trainer_explain_attack_5", [], "Yes, selecting the direction of your attack is a critical skill. There are four main directions you can use: right swing, left swing, overhead swing and thrust. Use each one wisely. [To control your swing direction with the default controls, move your mouse in the direction you want to swing from as you press the left mouse button.]", "trainer_combat_pretalk",[]],
  [anyone,"trainer_explain_horseback", [], "Ah, very good question. A horse is the warrior's most powerful weapon in combat. It gives you speed, height, power, and initiative. Many weapons become even deadlier on horseback. However you must pay particular attention to horse-mounted enemies couching their lances, as they can take down an opponent in a single hit. [To use a couched lance yourself, wield a lance or similar weapon, and speed up your horse without pressing any attack or defense buttons. After you reach a certain speed, you'll automatically lower your lance. Then just try to target your enemies by maneuvering your horse.]", "trainer_combat_pretalk",[]],
 
  [anyone,"trainer_practice_1", [(eq,"$training_system_explained", 0)],
 "I train novices in four stages, each more challenging than the one before. To finish a stage and advance to the next one, you have to win three fights in a row.", "trainer_practice_1",
   [
     (assign, "$num_opponents_to_beat_in_a_row", 3),
     (assign, "$novicemaster_opponent_troop", "trp_novice_fighter"),
     (assign, "$training_system_explained", 1),
     ]],
  [anyone,"trainer_practice_1",
   [(ge,"$novice_training_difficulty",4)],
 "You have passed all the stages of training. But if you wish, you can still practice. Are you ready for more?", "novicemaster_are_you_ready",
   [(assign,"$num_opponents_to_beat_in_a_row",99999)]],
  [anyone,"trainer_practice_1",
   [(eq,"$num_opponents_to_beat_in_a_row",0),(eq,"$novice_training_difficulty",0)],
 "Well done, {lad/lass}. With that victory, you have advanced to the next training level. From now on, your opponents will be regular fighters, not the riff-raff off the street -- so keep on your toes.",
   "trainer_practice_1",
   [[assign,"$num_opponents_to_beat_in_a_row",3],
    [val_add,"$novice_training_difficulty",1],
    [add_xp_to_troop,100],
    [assign,"$novicemaster_opponent_troop","trp_regular_fighter"]]],
  [anyone,"trainer_practice_1",
   [[eq,"$num_opponents_to_beat_in_a_row",0],[eq,"$novice_training_difficulty",1]],
 "Excellent, my {lad/lass}. You have risen to the third training level. From now on, your opponents will be veteran fighters; soldiers and arena regulars and the like. These fellows know some dirty tricks, so keep up your defenses.",
   "trainer_practice_1",
   [[assign,"$num_opponents_to_beat_in_a_row",3],
    [val_add,"$novice_training_difficulty",1],
    [add_xp_to_troop,100],
    [assign,"$novicemaster_opponent_troop","trp_veteran_fighter"]]],
  [anyone,"trainer_practice_1",
   [[eq,"$num_opponents_to_beat_in_a_row",0],[eq,"$novice_training_difficulty",2]],
 "You've got the heart of a champion, {lad/lass}, and a sword arm to match. From now on your opponents will be champion fighters. These are the cream of the crop, the finest warriors I have ever trained. If you can best three of them in a row, you will join their ranks.",
   "trainer_practice_1",
   [[assign,"$num_opponents_to_beat_in_a_row",3],
    [val_add,"$novice_training_difficulty",1],
    [add_xp_to_troop,100],
    [assign,"$novicemaster_opponent_troop","trp_champion_fighter"]]],
  [anyone,"trainer_practice_1",
   [[eq,"$num_opponents_to_beat_in_a_row",0],[eq,"$novice_training_difficulty",3]],
 "It does my heart good to see such promising talent. You have passed all the training levels. You can now boast that you have been trained by the master of the training field.",
   "novicemaster_finish_training",
   [[assign,"$num_opponents_to_beat_in_a_row",3],
    [val_add,"$novice_training_difficulty",1],
    [add_xp_to_troop,300]]],
  [anyone|plyr,"novicemaster_finish_training", [], "Thank you for the lesson, master.", "novicemaster_finish_training_2",[]],
  [anyone,"novicemaster_finish_training_2", [], "I wish you good luck in the tournaments! And, don't forget -- if ever you want to practice your swordsmanship, just come say the word.", "close_window",[]],
  [anyone,"trainer_practice_1",
   [
     (assign, reg8, "$num_opponents_to_beat_in_a_row"),
     (str_store_troop_name, s9, "$novicemaster_opponent_troop"),
     ],
 "Your next opponent will be a {s9}. What's that now? Wondering how many fights 'til the next round? Only {reg8} more. Well, are you ready?", "novicemaster_are_you_ready",
   []],
  [anyone|plyr,"novicemaster_are_you_ready", [], "Yes, I'm ready.", "novicemaster_ready_to_fight",[]],
  [anyone,"novicemaster_ready_to_fight", [], "Get out there, then. Good luck.", "close_window",
   [
     (assign, "$training_fight_won", 0),
     (assign, "$waiting_for_training_fight_result", 1),
     (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
     (reset_visitors),
     (assign, reg0, 0),
     (assign, reg1, 1),
     (assign, reg2, 2),
     (assign, reg3, 3),
     (shuffle_range, 0, 4),
     (set_visitor, reg0, "trp_player"),
     (set_visitor, reg1, "$novicemaster_opponent_troop"),
     (set_visitor, 4, "$g_talk_troop"),
     (set_jump_mission, "mt_training_ground_trainer_training"),
     (jump_to_scene, "$g_training_ground_melee_training_scene"),
     ]],

  [anyone|plyr,"novicemaster_are_you_ready", [], "Just a minute. I am not ready yet.", "novicemaster_not_ready",[]],
  [anyone,"novicemaster_not_ready", [], "Hey, You'll never make it if you don't practice.", "close_window",[]],


#Crooks

##  [anyone ,"start", [(is_between,"$g_talk_troop",crooks_begin,crooks_end),(eq,"$g_talk_troop_met",0),(eq,"$sneaked_into_town",0),(store_random_in_range, reg2, 2)],
##   "You {reg2?looking for:want} something?:", "crook_intro_1",[]],
##  [anyone|plyr,"crook_intro_1",[],"I am trying to learn my way around the town.", "crook_intro_2",[]],
##  
##  [anyone,"crook_intro_2",[(eq,"$crook_talk_order",0),(val_add,"$crook_talk_order",1),(str_store_troop_name,s1,"$g_talk_troop")],
##"Then you came to the right guy. My name is {s1}, and I know everyone and everything that goes around in this town.\
## Anyone you want to meet, I can arrange it. Anything you need to know, I can find out. For the the right price, of course. Do you have gold?", "crook_intro_2a",[]],
##  [anyone|plyr,"crook_intro_2a",[],"I have gold. Plenty of it.", "crook_intro_2a_1a",[]],
##  [anyone|plyr,"crook_intro_2a",[],"Not really.", "crook_intro_2a_1b",[]],
##  [anyone,"crook_intro_2a_1a",[],"Good. That means you and I will be great friends.", "crook_talk",[]],
##  [anyone,"crook_intro_2a_1b",[],"Then you should look into earning some. Listen to me now, for I'll give you some free advice.\
## The easiest way to make money is to fight in the tournaments and bet on yourself. If you are good, you'll quickly get yourself enough money to get going.", "crook_talk",[]],
##
##  [anyone,"crook_intro_2",[(eq,"$crook_talk_order",1),(val_add,"$crook_talk_order",1),(str_store_troop_name,s1,"$g_talk_troop")],
##"Then you need to go no further. I am {s1}, and I can provide you anything... For the the right price.", "crook_intro_2b",[]],
##  [anyone|plyr,"crook_intro_2b",[],"Are you a dealer?", "crook_intro_2b_1",[]],
##  [anyone,"crook_intro_2b_1",[],"A dealer? Yes. I deal in knowledge... connections.. lies... secrets... Those are what I deal in. Interested?", "crook_talk",[]],
##
##  [anyone,"crook_intro_2",[(eq,"$crook_talk_order",2),(val_add,"$crook_talk_order",1),(str_store_troop_name,s1,"$g_talk_troop")],
##"Then this is your lucky day. Because you are talking to {s1}, and I know every piss-stained brick of this wicked town.\
##I know every person, every dirty little secret. And all that knowledge can be yours. For a price.", "crook_talk",[]],
##
##  [anyone,"crook_intro_2",[(val_add,"$crook_talk_order",1),(str_store_troop_name,s1,"$g_talk_troop")],
## "Then {s1} is at your service {sir/madam}. If you want to know what's really going on in this town, or arrange a meeting in secret, then come to me. I can help you.", "crook_talk",[]],
##
##  [anyone ,"start", [(is_between,"$g_talk_troop",crooks_begin,crooks_end),(eq,"$g_talk_troop_met",0),(eq,"$sneaked_into_town",1),(eq,"$crook_sneak_intro_order",0),(val_add,"$crook_sneak_intro_order",1)],
##   "Good day. {playername} right?", "crook_intro_sneak_1",[]],
##  [anyone|plyr,"crook_intro_sneak_1", [], "You must be mistaken. I'm just a poor pilgrim. I don't answer to that name.", "crook_intro_sneak_2",[]],
##  [anyone,"crook_intro_sneak_2", [(str_store_troop_name,s1,"$g_talk_troop")], "Of course you do. And if the town guards knew you were here, they'd be upon you this minute.\
## But don't worry. Noone knows it is {playername} under that hood. Except me of course. But I am {s1}. It is my business to know things.", "crook_intro_sneak_3",[]],
##  [anyone|plyr,"crook_intro_sneak_3", [], "You won't tip off the guards about my presence?", "crook_intro_sneak_4",[]],
##  [anyone,"crook_intro_sneak_4", [], "What? Of course not! Well, maybe I would, but the new captain of the guards is a dung-eating cheat.\
## I led him to this fugitive, and the man was worth his weight in silver as prize money. But I swear, I didn't see a penny of it.\
## The bastard took it all to himself. So your secret is safe with me.", "crook_intro_sneak_5",[]],
##  [anyone,"crook_intro_sneak_5", [], "Besides, I heard you have a talent for surviving any kind of ordeal.\
## I wouldn't want you to survive this one as well and then come after me with a sword. Ha-hah.", "crook_talk",[]],
##
##
##  [anyone ,"start", [(is_between,"$g_talk_troop",crooks_begin,crooks_end),(eq,"$g_talk_troop_met",0),(eq,"$sneaked_into_town",1),(str_store_troop_name,s1,"$g_talk_troop")],
##   "{s1} is at your service {sir/madam}. If you want to know what's really going on in this town, or arrange a meeting in secret, then come to me. I can help you.", "crook_talk",[]],
##
##  [anyone ,"start", [(is_between,"$g_talk_troop",crooks_begin,crooks_end),(store_character_level, ":cur_level", "trp_player"),(lt,":cur_level",8)],
##   "{You again?/Delighted to see you again my pretty.}", "crook_talk",[]],
##  [anyone ,"start", [(is_between,"$g_talk_troop",crooks_begin,crooks_end)],
##   "I see that you need my services {sir/madam}...", "crook_talk",[]],
##  [anyone ,"crook_pretalk", [],
##   "Is that all?", "crook_talk",[]],


  
##  [anyone|plyr,"crook_talk", [], "I'm looking for a person...", "crook_search_person",[]],
##  [anyone|plyr,"crook_talk", [], "I want you to arrange me a meeting with someone...", "crook_request_meeting",[]],
##  [anyone|plyr,"crook_talk", [], "[Leave]", "close_window",[]],



#  [anyone,"crook_enter_dungeon", [],
#   "Alright but this will cost you 50 denars.", "crook_enter_dungeon_2", []],

#  [anyone|plyr, "crook_enter_dungeon_2", [(store_troop_gold, ":cur_gold", "trp_player"),
#                                            (ge, ":cur_gold", 50)],
#   "TODO: Here it is. 50 denars.", "crook_enter_dungeon_3_1",[(troop_remove_gold, "trp_player", 50)]],

#  [anyone|plyr, "crook_enter_dungeon_2", [(store_troop_gold, ":cur_gold", "trp_player"),
#                                            (ge, ":cur_gold", 50)],
#   "Never mind then.", "crook_pretalk",[]],

#  [anyone|plyr, "crook_enter_dungeon_2", [(store_troop_gold, ":cur_gold", "trp_player"),
#                                            (lt, ":cur_gold", 50)],
#   "TODO: I don't have that much money.", "crook_enter_dungeon_3_2",[]],

#  [anyone,"crook_enter_dungeon_3_1", [],
#   "TODO: There you go.", "close_window", [(call_script, "script_enter_dungeon", "$current_town", "mt_visit_town_castle")]],

#  [anyone,"crook_enter_dungeon_3_2", [],
#   "TODO: Come back later then.", "crook_pretalk",[]],
 

##  [anyone, "crook_request_meeting", [],
##   "Who do you want to meet with?", "crook_request_meeting_2",[]],
##  [anyone|plyr|repeat_for_troops,"crook_request_meeting_2", [(store_encountered_party, ":center_no"),
##                                                             (store_repeat_object, ":troop_no"),
##                                                             (is_between, ":troop_no", heroes_begin, heroes_end),
##                                                             (troop_get_slot, ":cur_center", ":troop_no", slot_troop_cur_center),
##                                                             (call_script, "script_get_troop_attached_party", ":troop_no"),
##                                                             (assign, ":cur_center_2", reg0),
##                                                             (this_or_next|eq, ":cur_center", ":center_no"),
##                                                             (eq, ":cur_center_2", ":center_no"),
##                                                             (neg|party_slot_eq, ":center_no", slot_town_lord, ":troop_no"),#Neglect the ruler of the center
##                                                             (str_store_troop_name, s1, ":troop_no")],
##   "{s1}", "crook_request_meeting_3", [(store_repeat_object, "$selected_troop")]],
##
##  [anyone|plyr,"crook_request_meeting_2", [], "Never mind.", "crook_pretalk", []],
##
##  [anyone,"crook_request_meeting_3", [],
##   "Alright but this will cost you 50 denars.", "crook_request_meeting_4", []],
##
##  [anyone|plyr, "crook_request_meeting_4", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                            (ge, ":cur_gold", 50)],
##   "TODO: Here it is. 50 denars.", "crook_search_person_5_1",[(troop_remove_gold, "trp_player", 50)]],
##
##  [anyone|plyr, "crook_request_meeting_4", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                            (ge, ":cur_gold", 50)],
##   "Never mind then.", "crook_pretalk",[]],
##
##  [anyone|plyr, "crook_request_meeting_4", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                            (lt, ":cur_gold", 50)],
##   "TODO: I don't have that much money.", "crook_search_person_5_2",[]],
##
##  [anyone, "crook_search_person_5_1", [],
##   "TODO: Ok.", "close_window",[(party_get_slot, ":town_alley", "$g_encountered_party", slot_town_alley),
##                                (modify_visitors_at_site,":town_alley"),(reset_visitors),
##                                (set_visitor,0,"trp_player"),
##                                (set_visitor,17,"$selected_troop"),
##                                (set_jump_mission,"mt_conversation_encounter"),
##                                (jump_to_scene,":town_alley"),
##                                (assign, "$talk_context", tc_back_alley),
##                                (change_screen_map_conversation, "$selected_troop")]],
##
##  [anyone, "crook_search_person_5_2", [],
##   "TODO: Come back later then.", "crook_pretalk",[]],
##
##  [anyone, "crook_search_person", [],
##   "TODO: Who are you searching for?", "crook_search_person_2",[]],
##  [anyone|plyr|repeat_for_factions,"crook_search_person_2", [(store_repeat_object, ":faction_no"),
##                                                             (is_between, ":faction_no", kingdoms_begin, kingdoms_end),
##                                                             (str_store_faction_name, s1, ":faction_no")],
##   "TODO: I'm looking for a {s1}.", "crook_search_person_3", [(store_repeat_object, "$selected_faction")]],
##
##  [anyone|plyr,"crook_search_person_2", [], "Never mind.", "crook_pretalk", []],
##
##  
##  [anyone, "crook_search_person_3", [],
##   "TODO: Who?", "crook_search_person_4",[]],
##  
##  [anyone|plyr|repeat_for_troops,"crook_search_person_4", [(store_repeat_object, ":troop_no"),
##                                                           (is_between, ":troop_no", heroes_begin, heroes_end),
##                                                           (store_troop_faction, ":faction_no", ":troop_no"),
##                                                           (eq, ":faction_no", "$selected_faction"),
##                                                           (str_store_troop_name, s1, ":troop_no")],
##   "{s1}", "crook_search_person_5", [(store_repeat_object, "$selected_troop")]],
##
##  [anyone|plyr,"crook_search_person_4", [], "Never mind.", "crook_pretalk", []],
##
##  [anyone, "crook_search_person_5", [(call_script, "script_get_information_about_troops_position", "$selected_troop", 0),
##                                     (eq, reg0, 1),
##                                     (str_store_troop_name, s1, "$selected_troop")],
##   "TODO: I know where {s1} is at the moment, but hearing it will cost you 50 denars.", "crook_search_person_6",[]],
##
##  [anyone, "crook_search_person_5", [],
##   "TODO: Sorry I don't know anything.", "crook_pretalk",[]],
##
##  [anyone|plyr, "crook_search_person_6", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                          (ge, ":cur_gold", 50)],
##   "TODO: Here it is. 50 denars.", "crook_search_person_7_1",[(troop_remove_gold, "trp_player", 50)]],
##
##  [anyone|plyr, "crook_search_person_6", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                          (ge, ":cur_gold", 50)],
##   "Never mind then.", "crook_pretalk",[]],
##
##  [anyone|plyr, "crook_search_person_6", [(store_troop_gold, ":cur_gold", "trp_player"),
##                                          (lt, ":cur_gold", 50)],
##   "TODO: I don't have that much money.", "crook_search_person_7_2",[]],
##
##  [anyone, "crook_search_person_7_1", [(call_script, "script_get_information_about_troops_position", "$selected_troop", 0)],
##   "{s1}", "crook_pretalk",[]],
##
##  [anyone, "crook_search_person_7_2", [],
##   "TODO: Come back later then.", "crook_pretalk",[]],
##  

#Mayor talk (town elder)

  [anyone ,"start", [(this_or_next|is_between,"$g_talk_troop",mayors_begin,mayors_end),
					 (is_between,"$g_talk_troop",castle_mayors_begin,castle_mayors_end),
					 (eq,"$g_talk_troop_met",0),
                     (this_or_next|eq, "$players_kingdom", "$g_encountered_party_faction"),
                     (             eq, "$g_encountered_party_faction", "fac_player_supporters_faction"),],
   "Good day, my lord.", "mayor_begin",[]],
  [anyone ,"start", [(this_or_next|is_between,"$g_talk_troop",mayors_begin,mayors_end),
					 (is_between,"$g_talk_troop",castle_mayors_begin,castle_mayors_end),
					 (eq,"$g_talk_troop_met",0),
                     (str_store_party_name, s9, "$current_town")],
   "Hello stranger, you seem to be new to {s9}. I am the mayor of the town.", "mayor_talk",[]],
  
  [anyone ,"start", [(this_or_next|is_between,"$g_talk_troop",mayors_begin,mayors_end),
					 (is_between,"$g_talk_troop",castle_mayors_begin,castle_mayors_end),],
   "Good day, {playername}.", "mayor_begin",
   [
     #Delete last offered quest if peace is formed.
     (try_begin),
       (eq, "$merchant_offered_quest", "qst_persuade_lords_to_make_peace"),
       (party_get_slot, ":target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
       (party_get_slot, ":object_faction", "qst_persuade_lords_to_make_peace", slot_quest_object_faction),
       (store_relation, ":reln", ":target_faction", ":object_faction"),
       (ge, ":reln", 0),
       (assign, "$merchant_quest_last_offerer", -1),
       (assign, "$merchant_offered_quest", -1),
     (try_end),
     ]],


  [anyone,"mayor_begin", [(check_quest_active, "qst_persuade_lords_to_make_peace"),
                          (quest_slot_eq, "qst_persuade_lords_to_make_peace", slot_quest_giver_troop, "$g_talk_troop"),
                          (check_quest_active, "qst_persuade_lords_to_make_peace"),
                          (check_quest_succeeded, "qst_persuade_lords_to_make_peace"),
                          (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
                          (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
                          (val_mul, ":quest_target_troop", -1),
                          (val_mul, ":quest_object_troop", -1),
                          (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
                          (quest_get_slot, ":quest_object_faction", "qst_persuade_lords_to_make_peace", slot_quest_object_faction),
                          (str_store_troop_name, s12, ":quest_target_troop"),
                          (str_store_troop_name, s13, ":quest_object_troop"),
                          (str_store_faction_name, s14, ":quest_target_faction"),
                          (str_store_faction_name, s15, ":quest_object_faction"),
                          (str_store_party_name, s19, "$current_town"),
                         ],
   "{playername}, it was an incredible feat, bringing {s14} and {s15} to the peace table -- and you made it happen! In doing this, you have saved our town from disaster, and put an end to all the grief this bitter war has caused. Know that the townspeople of {s19} will be true to our word. We are ready to pay the {reg12} thaler we promised.", "lord_persuade_lords_to_make_peace_completed",
   [(quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
    (quest_get_slot, ":quest_object_faction", "qst_persuade_lords_to_make_peace", slot_quest_object_faction),
    #Forcing 2 factions to make peace within 72 hours.
    (assign, "$g_force_peace_faction_1", ":quest_target_faction"),
    (assign, "$g_force_peace_faction_2", ":quest_object_faction"),
    (quest_get_slot, ":quest_reward", "qst_persuade_lords_to_make_peace", slot_quest_gold_reward),
    (assign, reg12, ":quest_reward"),
    #TODO: Change these values
    (add_xp_as_reward, 4000),
    ]],


  [anyone|plyr,"lord_persuade_lords_to_make_peace_completed", [],
   "Thank you.", "lord_persuade_lords_to_make_peace_pay",[]],
  [anyone|plyr,"lord_persuade_lords_to_make_peace_completed", [],
   "No need for a payment. I only did what was right.", "lord_persuade_lords_to_make_peace_no_pay",[]],

  [anyone ,"lord_persuade_lords_to_make_peace_pay", [],
   "Oh, yes, of course. We already gathered the money for you. Here, please accept these {reg12} thaler together with our most sincere thanks. The people of our town will never forget your help.", "close_window",
   [(quest_get_slot, ":quest_reward", "qst_persuade_lords_to_make_peace", slot_quest_gold_reward),
    (call_script, "script_troop_add_gold", "trp_player", ":quest_reward"),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
    (call_script, "script_end_quest", "qst_persuade_lords_to_make_peace"),
    (quest_get_slot, ":quest_reward", "qst_persuade_lords_to_make_peace", slot_quest_gold_reward),
    (assign, reg12, ":quest_reward")
    ]],

  [anyone ,"lord_persuade_lords_to_make_peace_no_pay", [],
   "You are indeed an extraordinary person, {sir/madam}, and it is an honor to have known you. You not only did you accomplish the impossible and put an end to this terrible war, but you won't even accept a reward for it! Very well, I will not insist, but please know that you will have our eternal respect and gratitude.", "close_window",
   [
    (call_script, "script_change_player_honor", 3),
    (call_script, "script_change_player_relation_with_center", "$current_town", 8),
    (call_script, "script_end_quest", "qst_persuade_lords_to_make_peace"),
    ]],

  [anyone,"mayor_begin", [(check_quest_active, "qst_deal_with_night_bandits"),
                          (quest_slot_eq, "qst_deal_with_night_bandits", slot_quest_giver_troop, "$g_talk_troop"),
                          (check_quest_active, "qst_deal_with_night_bandits"),
                          (check_quest_succeeded, "qst_deal_with_night_bandits"),
                         ],
   "Very nicely done, {playername}! You made short work of those lawless dogs! Thank you kindly for all your help -- and please accept this bounty of 150 thaler.", "lord_deal_with_night_bandits_completed",
   [
     (add_xp_as_reward,200),
     (call_script, "script_troop_add_gold", "trp_player", 150),
     (call_script, "script_change_player_relation_with_center", "$current_town", 1),
     (call_script, "script_end_quest", "qst_deal_with_night_bandits"),
    ]],


  [anyone|plyr,"lord_deal_with_night_bandits_completed", [],
   "It was my pleasure, {s65}.", "close_window",[]],

# Ryan BEGIN
  [anyone,"mayor_begin", [(check_quest_active, "qst_deal_with_looters"),
                          (quest_slot_eq, "qst_deal_with_looters", slot_quest_giver_troop, "$g_talk_troop"),
                         ],
   "Ah, {playername}. Have you any progress to report?", "mayor_looters_quest_response",
   [
    ]],

  [anyone|plyr,"mayor_looters_quest_response",
   [
     (store_num_parties_destroyed_by_player, ":num_looters_destroyed", "pt_looters"),
     (party_template_get_slot,":previous_looters_destroyed","pt_looters",slot_party_template_num_killed),
     (val_sub,":num_looters_destroyed",":previous_looters_destroyed"),
     (quest_get_slot,":looters_paid_for","qst_deal_with_looters",slot_quest_current_state),
     (lt,":looters_paid_for",":num_looters_destroyed"),
     ],
   "I've killed some looters.", "mayor_looters_quest_destroyed",[]],
  [anyone|plyr,"mayor_looters_quest_response", [(eq,1,0)
  ],
   "I've brought you some goods.", "mayor_looters_quest_goods",[]],
  [anyone|plyr,"mayor_looters_quest_response", [
  ],
   "Not yet, sir. Farewell.", "close_window",[]],

  [anyone,"mayor_looters_quest_destroyed", [],
   "Aye, my scouts saw the whole thing. That should make anyone else think twice before turning outlaw! The bounty was 40 thaler for every band, so that makes {reg1} in total. Here's your money, as promised.",
   "mayor_looters_quest_destroyed_2",[
      (store_num_parties_destroyed_by_player, ":num_looters_destroyed", "pt_looters"),
      (party_template_get_slot,":previous_looters_destroyed","pt_looters",slot_party_template_num_killed),
      (val_sub,":num_looters_destroyed",":previous_looters_destroyed"),
      (quest_get_slot,":looters_paid_for","qst_deal_with_looters",slot_quest_current_state),
      (store_sub,":looter_bounty",":num_looters_destroyed",":looters_paid_for"),
      (val_mul,":looter_bounty",40),
      (assign,reg1,":looter_bounty"),
      (call_script, "script_troop_add_gold", "trp_player", ":looter_bounty"),
      (assign,":looters_paid_for",":num_looters_destroyed"),
      (quest_set_slot,"qst_deal_with_looters",slot_quest_current_state,":looters_paid_for"),
      ]],
  [anyone,"mayor_looters_quest_destroyed_2", [
      (quest_get_slot,":total_looters","qst_deal_with_looters",slot_quest_target_amount),
      (quest_slot_ge,"qst_deal_with_looters",slot_quest_current_state,":total_looters"), # looters paid for >= total looters
      (quest_get_slot,":xp_reward","qst_deal_with_looters",slot_quest_xp_reward),
      (quest_get_slot,":gold_reward","qst_deal_with_looters",slot_quest_gold_reward),
      (add_xp_as_reward, ":xp_reward"),
      (call_script, "script_troop_add_gold", "trp_player", ":gold_reward"),
      (call_script, "script_change_troop_renown", "trp_player", 1),
      (call_script, "script_change_player_relation_with_center", "$current_town", 5),
      (call_script, "script_end_quest", "qst_deal_with_looters"),
      (try_for_parties, ":cur_party_no"),
        (party_get_template_id, ":cur_party_template", ":cur_party_no"),
        (eq, ":cur_party_template", "pt_looters"),
        (party_set_flags, ":cur_party_no", pf_quest_party, 0),
      (try_end),
  ],
   "And that's not the only good news! Thanks to you, the looters are no longer a threat. We've not had a single attack reported for some time now. If there's any of them left, they've either run off or gone deep into hiding. That's good for business, and what's good for business is good for the town! I say this happily concludes our arrangement, {playername}. Please accept this silver as a token of my gratitude. Thank you, and farewell.",
   "close_window",[
      ]],
  [anyone,"mayor_looters_quest_destroyed_2", [],
   "Is there anything else you need?",
   "mayor_looters_quest_response",[
      ]],

  [anyone,"mayor_looters_quest_goods", [
      (quest_get_slot,reg1,"qst_deal_with_looters",slot_quest_target_item),
  ],
   "Hah, I knew I could count on you! Just tell me which item to take from your baggage, and I'll send my men to collect it. I still need {reg1} thaler worth of goods.",
   "mayor_looters_quest_goods_response",[
      ]],
  [anyone|plyr|repeat_for_100,"mayor_looters_quest_goods_response", [
      (store_repeat_object,":goods"),
      (val_add,":goods",trade_goods_begin),
      (is_between,":goods",trade_goods_begin,trade_goods_end),
      (player_has_item,":goods"),
      (str_store_item_name,s5,":goods"),
  ],
   "{s5}.", "mayor_looters_quest_goods_2",[
      (store_repeat_object,":goods"),
      (val_add,":goods",trade_goods_begin),
      (troop_remove_items,"trp_player",":goods",1),
      (assign,":value",reg0),
      (call_script, "script_troop_add_gold", "trp_player", ":value"),
      (quest_get_slot,":gold_num","qst_deal_with_looters",slot_quest_target_item),
      (val_sub,":gold_num",":value"),
      (quest_set_slot,"qst_deal_with_looters",slot_quest_target_item,":gold_num"),
      (str_store_item_name,s6,":goods"),
   ]],
  [anyone|plyr,"mayor_looters_quest_goods_response", [
  ],
   "Nothing at the moment, {sir/madam}.", "mayor_looters_quest_goods_3",[]],

  [anyone,"mayor_looters_quest_goods_3", [
  ],
   "Anything else you need?",
   "mayor_looters_quest_response",[
      ]],

  [anyone,"mayor_looters_quest_goods_2", [
      (quest_slot_ge,"qst_deal_with_looters",slot_quest_target_item,1),
      (quest_get_slot,reg1,"qst_deal_with_looters",slot_quest_target_item),
  ],
   "Excellent, here is the money for your {s6}. Do you have any more goods to give me? I still need {reg1} thaler worth of goods.",
   "mayor_looters_quest_goods_response",[
      ]],
  [anyone,"mayor_looters_quest_goods_2", [
      (neg|quest_slot_ge,"qst_deal_with_looters",slot_quest_target_item,1),
      (quest_get_slot,":xp_reward","qst_deal_with_looters",slot_quest_xp_reward),
      (quest_get_slot,":gold_reward","qst_deal_with_looters",slot_quest_gold_reward),
      (add_xp_as_reward, ":xp_reward"),
      (call_script, "script_troop_add_gold", "trp_player", ":gold_reward"),
#      (call_script, "script_change_troop_renown", "trp_player", 1),
      (call_script, "script_change_player_relation_with_center", "$current_town", 3),
      (call_script, "script_end_quest", "qst_deal_with_looters"),
      (try_for_parties, ":cur_party_no"),
        (party_get_template_id, ":cur_party_template", ":cur_party_no"),
        (eq, ":cur_party_template", "pt_looters"),
        (party_set_flags, ":cur_party_no", pf_quest_party, 0),
      (try_end),
  ],
   "Well done, {playername}, that's the last of the goods I need. Here's the money for your {s6}, and a small bonus for helping me out. I'm afraid I won't be paying for any more goods, nor bounties on looters, but you're welcome to keep hunting the bastards if any still remain. Thank you for your help -- I won't forget it.",
   "close_window",[
      ]],
# Ryan END



  [anyone,"mayor_begin", [(check_quest_active, "qst_move_cattle_herd"),
                          (quest_slot_eq, "qst_move_cattle_herd", slot_quest_giver_troop, "$g_talk_troop"),
                          (check_quest_active, "qst_move_cattle_herd"),
                          (check_quest_succeeded, "qst_move_cattle_herd"),
                          ],
   "Good to see you again {playername}! I hear you delivered the cattle! I'll tell all the merchants how reliable you are. And here is your pay, {reg8} thaler.", "close_window",
   [(quest_get_slot, ":quest_gold_reward", "qst_move_cattle_herd", slot_quest_gold_reward),
    (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
    (store_div, ":xp_reward", ":quest_gold_reward", 3),
    (add_xp_as_reward, ":xp_reward"),
    (call_script, "script_change_troop_renown", "trp_player", 1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 3),    
    (call_script, "script_end_quest", "qst_move_cattle_herd"),
    (assign, reg8, ":quest_gold_reward"),
    ]],
  
  [anyone,"mayor_begin", [(check_quest_active, "qst_move_cattle_herd"),
                          (quest_slot_eq, "qst_move_cattle_herd", slot_quest_giver_troop, "$g_talk_troop"),
                          (check_quest_failed, "qst_move_cattle_herd"),
                          ],
   "I heard that you lost the cattle herd on your way to {s9}. I had a difficult time explaining this to the owner of that herd, {sir/madam}. What do you have to say for yourself?", "move_cattle_herd_failed",
   []],

  [anyone|plyr ,"move_cattle_herd_failed", [],
   "I am sorry, but I was attacked on the way.", "move_cattle_herd_failed_2",[]],
  [anyone|plyr ,"move_cattle_herd_failed", [],
   "I am sorry. The stupid animals wandered off during the night.", "move_cattle_herd_failed_2",[]],

  [anyone,"move_cattle_herd_failed_2", [],
   "Well, it was your responsibility to deliver that herd safely, no matter what. You should know that the owner of the herd demanded compensation for his loss, and I had to pay him 1000 thaler. So you now owe me that money.", "merchant_ask_for_debts",
   [(assign, "$debt_to_merchants_guild", 1000),
    (call_script, "script_end_quest", "qst_move_cattle_herd"),]],

  [anyone,"mayor_begin", [(check_quest_active, "qst_kidnapped_girl"),
                          (party_count_members_of_type, ":count", "p_main_party", "trp_kidnapped_girl"),
                          (this_or_next|quest_slot_eq, "qst_kidnapped_girl", slot_quest_current_state, 4),
                          (ge, ":count", 1),
                          (quest_slot_eq, "qst_kidnapped_girl", slot_quest_giver_troop, "$g_talk_troop"),
                          ],
   "Oh my dear {playername}. I am in your debt for bringing back my friend's daughter. Please take these {reg8} thaler that I promised you. My friend wished he could give you more, but paying that ransom has brought him to his knees.", "close_window",
   [(quest_get_slot, ":quest_gold_reward", "qst_kidnapped_girl", slot_quest_gold_reward),
    (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
    (assign, reg8, ":quest_gold_reward"),
    (assign, ":xp_reward", ":quest_gold_reward"),
    (val_mul, ":xp_reward", 2),
    (val_add, ":xp_reward", 100),
    (add_xp_as_reward, ":xp_reward"),
    (call_script, "script_change_troop_renown", "trp_player", 3),
    (call_script, "script_change_player_relation_with_center", "$current_town", 2),    
    (call_script, "script_end_quest", "qst_kidnapped_girl"),
    (try_begin), 
      (party_count_members_of_type, ":count", "p_main_party", "trp_kidnapped_girl"),
      (ge, ":count", 1),
      (remove_member_from_party, "trp_kidnapped_girl"),
    (end_try), 
    ]],
  
  [anyone,"mayor_begin", [(check_quest_active, "qst_troublesome_bandits"),
                          (check_quest_succeeded, "qst_troublesome_bandits"),
                          (quest_slot_eq, "qst_troublesome_bandits", slot_quest_giver_troop, "$g_talk_troop"),
                          ],
   "I have heard the stories of your deeds, and you certainly gave those bandits the punishment they deserved. You are really as good as they say! Here is your reward: {reg5} thaler. I would like to give you more, but those bandits have nearly bled my dry.",
   "mayor_friendly_pretalk", [(quest_get_slot, ":quest_gold_reward", "qst_troublesome_bandits", slot_quest_gold_reward),
                              (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
                              (assign, ":xp_reward", ":quest_gold_reward"),
                              (val_mul, ":xp_reward", 7),
                              (add_xp_as_reward, ":xp_reward"),
                              (call_script, "script_change_player_relation_with_center", "$current_town", 2),
                              (call_script, "script_change_troop_renown", "trp_player", 3),
                              (call_script, "script_end_quest", "qst_troublesome_bandits"),
                              (assign, reg5, ":quest_gold_reward"),
                              ]],
							  
  [anyone,"mayor_begin", [(ge, "$debt_to_merchants_guild", 50)],
   "According to my accounts, you owe the merchant guild {reg1} thaler. I'd better collect that now.", "merchant_ask_for_debts",[(assign,reg(1),"$debt_to_merchants_guild")]],
  [anyone|plyr,"merchant_ask_for_debts", [[store_troop_gold,reg(5),"trp_player"],[ge,reg(5),"$debt_to_merchants_guild"]],
   "Alright. I'll pay my debt to you.", "merchant_debts_paid",[[troop_remove_gold, "trp_player","$debt_to_merchants_guild"],
                                                                [assign,"$debt_to_merchants_guild",0]]],
  [anyone, "merchant_debts_paid", [], "Excellent. I'll let my fellow merchants know that you are clear of any debts.", "mayor_pretalk",[]],

  [anyone|plyr, "merchant_ask_for_debts", [], "I'm afraid I can't pay that sum just now.", "merchant_debts_not_paid",[]],
  [anyone, "merchant_debts_not_paid", [(assign,reg(1),"$debt_to_merchants_guild")], "In that case, I am afraid I can't deal with you. Guild rules, you see... Come back when you can pay the {reg1} thaler. And know that we'll be charging interest to your debt. So the sooner you pay it, the better.", "close_window",[]],

#oim cityelder remark

  [anyone,"mayor_begin", [], "What can I do for you?", "mayor_talk", []],
  [anyone,"mayor_friendly_pretalk", [], "Now... What else can I do for you?", "mayor_talk",[]],
  [anyone,"mayor_pretalk", [], "Yes?", "mayor_talk",[]],
  
  [anyone|plyr,"mayor_talk", [], "Can you tell me about what you do?", "mayor_info_begin",[]],

  ##oim code!!!
  [anyone|plyr,"mayor_talk", [
  #code to check quest "lendliz"
	(check_quest_active, "qst_oim_lendliz"), 
	(quest_slot_eq, "qst_oim_lendliz", slot_quest_current_state, 0),   
	(eq, "$g_encountered_party", "p_town_8"), 
  ], "Good day to you. I come to collect some supplies for Naum Vasiliev. Here is the deed...", "oim_lendliz_giving_goods",[]],

  [anyone|plyr,"prison_guard_talk", [
	(check_quest_active, "qst_oim_dmitriy_eleonora"), 
	(quest_slot_eq, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 0),   
	(neg|check_quest_succeeded, "qst_oim_dmitriy_eleonora"),
	(neg|check_quest_finished, "qst_oim_dmitriy_eleonora"),
	(eq, "$g_encountered_party", "p_castle_6"), 
	#(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 0),
  ], "I come from the warlord. Here is the deed...", "oim_dmitriy_eleonora_mayor_talk",[]],
  
  [anyone|plyr,"mayor_talk", [
	(party_slot_eq, "$current_town", slot_town_lord, "trp_player"), 
  ], "I would like to talk about developing the city.", "ms_talk_to_elder_to_construct",[]],
  
    #oim_guild_master
	[anyone|plyr, "mayor_talk", [
		#(is_between, "$g_talk_troop", oim_guild_master_begin, oim_guild_master_end), 
		#add code
	], "I'd like to talk about trade...", "oim_guild_master_talk",[]],	
  
  
  [anyone|plyr,"mayor_talk", [
  #code to check quest "keiv_burgomistr"
	(check_quest_active, "qst_oim_getman_kiev_burgomistr"), 
	(neg|check_quest_succeeded, "qst_oim_getman_kiev_burgomistr"), 
	(neg|check_quest_finished, "qst_oim_getman_kiev_burgomistr"),
	(quest_slot_eq, "qst_oim_getman_kiev_burgomistr", slot_quest_current_state, 0),   
	(eq, "$g_encountered_party", "p_town_3"), 
  ], "I have an assignment for you from Radziwill.", "oim_getman_kiev_burgomistr",[]],
  
  [anyone|plyr,"mayor_talk", [
  #code to check quest "keiv_burgomistr_gold"
	(check_quest_active, "qst_oim_getman_kiev_burgomistr_gold"), 
	(neg|check_quest_succeeded, "qst_oim_getman_kiev_burgomistr_gold"), 
	(neg|check_quest_finished, "qst_oim_getman_kiev_burgomistr_gold"),
	(quest_slot_eq, "qst_oim_getman_kiev_burgomistr_gold", slot_quest_current_state, 0),   
	(eq, "$g_encountered_party", "p_town_3"), 
	(store_troop_gold, ":gold", "trp_player"),
	(ge, ":gold", 5000),
  ], "Here is a cure for a failing memory...", "oim_getman_kiev_burgomistr_gold_given",[]],

  [anyone|plyr,"mayor_talk", [
  #code to check quest "keiv_burgomistr"
	(check_quest_active, "qst_oim_getman_tampliers_archives"), 
	(neg|check_quest_finished, "qst_oim_getman_tampliers_archives"),
	(eq, "$g_encountered_party", "p_town_12"), 
  ], "I want to talk about the archives...", "oim_getman_riga_burgomistr_dlg_init",[]],

  
  
  [anyone|plyr,"mayor_talk", [(store_partner_quest, ":partner_quest"),
                              (lt, ":partner_quest", 0),
                              (neq, "$merchant_quest_last_offerer", "$g_talk_troop")],
   "Do you happen to have a job for me?", "merchant_quest_requested",[
     (assign,"$merchant_quest_last_offerer", "$g_talk_troop"),
     (call_script, "script_get_random_quest", "$g_talk_troop"),
     (assign, "$random_merchant_quest_no", reg0),
     (assign,"$merchant_offered_quest","$random_merchant_quest_no"),
     ]],
  [anyone|plyr,"mayor_talk", [(store_partner_quest, ":partner_quest"),
                              (lt, ":partner_quest", 0),
                              (eq,"$merchant_quest_last_offerer", "$g_talk_troop"),
                              (ge,"$merchant_offered_quest",0)
                              ],
   "About that job you offered me...", "merchant_quest_last_offered_job",[]],
  [anyone|plyr,"mayor_talk", [(store_partner_quest,reg(2)),(ge,reg(2),0)],
   "About the job you gave me...", "merchant_quest_about_job",[]],

  [anyone|plyr,"mayor_talk", [], "Leave...", "close_window",[]],

  [anyone, "mayor_info_begin", [(str_store_party_name, s9, "$current_town")],
   "I am the mayor of the town. You may say that I am the leader of the good people of {s9}. I can help you find a job if you are looking for some good, honest work.", "mayor_info_talk",[(assign, "$mayor_info_lord_told",0)]],

  [anyone|plyr,"mayor_info_talk",[(eq, "$mayor_info_lord_told",0)], "Who rules this town?", "mayor_info_lord",[]],
  [anyone, "mayor_info_lord", [
									(party_get_slot, ":town_lord","$current_town",slot_town_lord),
									(try_begin),
		(ge, ":town_lord", 0), 
		(str_store_troop_name, s10, ":town_lord"),
									(else_try),
		(party_slot_eq, "$current_town", slot_center_original_faction, "fac_kingdom_3"), 
		(str_store_string, s10, "str_town_lord_allah"), 
								(else_try),	
		(str_store_string, s10, "str_town_lord_god"), 
	(end_try),], "Our town's protector is {s10}. We levy judgments and collect taxes in his name. However, we handle ourselves in most matters that concern us. As the town's mayor I have the authority to decide most cases.", "mayor_info_talk",[(assign, "$mayor_info_lord_told",1)]],
   
  [anyone|plyr,"mayor_info_talk",[], "That's all I need to know. Thanks.", "mayor_pretalk",[]],
  

  [anyone,"merchant_quest_about_job", [], "What about it?", "merchant_quest_about_job_2",[]],
  [anyone|plyr,"merchant_quest_about_job_2", [], "What if I can't finish it?", "merchant_quest_what_if_fail",[]],
  [anyone|plyr,"merchant_quest_about_job_2", [], "Well, I'm still working on it.", "merchant_quest_about_job_working",[]],
  [anyone,"merchant_quest_about_job_working", [], "Good. I'm sure you will handle it.", "mayor_pretalk",[]],


  [anyone,"merchant_quest_last_offered_job", [], "Eh, so you want to reconsider. Very well...", "merchant_quest_brief",
   [[assign,"$random_merchant_quest_no","$merchant_offered_quest"]]],


  [anyone,"merchant_quest_what_if_fail", [(store_partner_quest,":partner_quest"),(eq,":partner_quest","qst_deliver_wine")],
   "I hope you do not fail. In that case, I shall have to demand you repay the value of the cargo you were carrying.", "mayor_pretalk",[]],
  [anyone,"merchant_quest_what_if_fail", [], "Well, just do your best to finish it.", "mayor_pretalk",[]],

  [anyone,"merchant_quest_taken", [], "Excellent. I am counting on you then. Good luck.", "mayor_pretalk",
   []],
  [anyone,"merchant_quest_stall", [], "Well, the job will be available for a few more days. Tell me if you decide to take it.", "mayor_pretalk",[]],

###################################################################3
# Random Merchant quests....
##############################

# Ryan BEGIN
  # deal with looters
  [anyone,"merchant_quest_requested",
   [
     (eq,"$random_merchant_quest_no","qst_deal_with_looters"),
     ],
   "Well, you look able enough. I think I might have something you could do.", "merchant_quest_brief", []],

  [anyone,"merchant_quest_brief",
   [
     (eq,"$random_merchant_quest_no","qst_deal_with_looters"),
     (try_begin),
       (party_slot_eq,"$g_encountered_party",slot_party_type,spt_town),
       (str_store_string,s5,"@town"),
     (else_try),
       (party_slot_eq,"$g_encountered_party",slot_party_type,spt_castle),
       (str_store_string,s5,"@castle"),
     (else_try),
       (party_slot_eq,"$g_encountered_party",slot_party_type,spt_village),
       (str_store_string,s5,"@village"),
     (try_end),
     ],
   "We've had some fighting near the {s5} lately, with all the chaos that comes with it -- and that's led some of our less upstanding locals to try to make their fortune by looting the shops and farms during the confusion. A lot of valuable goods were taken. I need someone to teach these bastards a lesson. Sound like your kind of work?", "merchant_quest_looters_choice", []],

  [anyone|plyr,"merchant_quest_looters_choice", [], "Aye, I'll do it.", "merchant_quest_looters_brief", []],

  [anyone|plyr,"merchant_quest_looters_choice", [], "I'm afraid I can't take the job at the moment.", "merchant_quest_stall",[]],

  [anyone,"merchant_quest_looters_brief", [
   (try_begin),
	(party_slot_eq,"$g_encountered_party",slot_party_type,spt_town),
	(str_store_string,s5,"@town"),
   (else_try),
   (party_slot_eq,"$g_encountered_party",slot_party_type,spt_castle),
   (str_store_string,s5,"@castle"),
   (else_try),
	(party_slot_eq,"$g_encountered_party",slot_party_type,spt_village),
	(str_store_string,s5,"@village"),
   (try_end),

#     (party_get_slot,":merchant","$current_town",slot_town_merchant),
#     (troop_clear_inventory,":merchant"),
   (store_random_in_range,":random_num_looters",3,7),
   (quest_set_slot,"qst_deal_with_looters",slot_quest_target_amount,":random_num_looters"),
   (try_for_range,":unused",0,":random_num_looters"),
     (store_random_in_range,":random_radius",5,14),
     (set_spawn_radius,":random_radius"),
     (spawn_around_party,"$g_encountered_party","pt_looters"),
	 (assign, ":party_no", reg0), 
     (party_set_flags, ":party_no", pf_quest_party, 1),
	 (party_set_ai_behavior, ":party_no", ai_bhvr_patrol_location),
     (party_set_ai_patrol_radius, ":party_no", 2),
     (party_get_position, pos0, ":party_no"),
     (party_set_ai_target_position, ":party_no", pos0),
	 (party_set_faction, ":party_no", "fac_oim_outlaws"),
   (try_end),
   (str_store_troop_name_link, s9, "$g_talk_troop"),
   (str_store_party_name_link, s13, "$g_encountered_party"),
   (str_store_party_name, s4, "$g_encountered_party"),
   (setup_quest_text, "qst_deal_with_looters"),
   (str_store_string, s2, "@The Guildmaster of {s13} has asked you to deal with looters in the surrounding countryside."),
   (call_script, "script_start_quest", "qst_deal_with_looters", "$g_talk_troop"),
   (assign, "$g_leave_encounter",1),
  ],
   "Excellent! You'll find the looters roaming the countryside, probably trying to rob more of our good people. Kill or capture the bastards -- I don't care what you do with them. I'll pay you a bounty of 40 thaler for every band of looters you destroy, until all the looters are dealt with.", "close_window",
   []],
# Ryan END

  # deliver wine:
  [anyone,"merchant_quest_requested", [(eq,"$random_merchant_quest_no","qst_deliver_wine"),], "You're looking for a job? Actually I was looking for someone to deliver some {s4}. Would something like that suit you?", "merchant_quest_brief",
   [(quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (str_store_item_name, s4, ":quest_target_item"),
    ]],

  [anyone,"merchant_quest_brief", [(eq,"$random_merchant_quest_no","qst_deliver_wine")],
   "I have a cargo of {s6} that needs to be delivered to the tavern in {s4}. If you can take {reg5} units of {s6} to {s4} within the next 7 days, you'll earn yourself {reg8} thaler. What do you say?", "merchant_quest_brief_deliver_wine",
   [(quest_get_slot, reg5, "qst_deliver_wine", slot_quest_target_amount),
    (quest_get_slot, reg8, "qst_deliver_wine", slot_quest_gold_reward),
    (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (quest_get_slot, ":quest_target_center", "qst_deliver_wine", slot_quest_target_center),
    (str_store_troop_name, s9, "$g_talk_troop"),
    (str_store_party_name_link, s3, "$g_encountered_party"),
    (str_store_party_name_link, s4, ":quest_target_center"),
    (str_store_item_name, s6, ":quest_target_item"),
    (setup_quest_text,"qst_deliver_wine"),
    (str_store_string, s2, "@{s9} of {s3} asked you to deliver {reg5} units of {s6} to the tavern in {s4} in 7 days."),
    #s2 should not be changed until the decision is made
   ]],
  
  [anyone|plyr,"merchant_quest_brief_deliver_wine", [(store_free_inventory_capacity,":capacity"),
                                                     (quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
                                                     (ge, ":capacity", ":quest_target_amount"),
                                                     ],
      "Alright. I will make the delivery.", "merchant_quest_taken",
   [(quest_get_slot, ":quest_target_amount", "qst_deliver_wine", slot_quest_target_amount),
    (quest_get_slot, ":quest_target_item", "qst_deliver_wine", slot_quest_target_item),
    (troop_add_items, "trp_player", ":quest_target_item", ":quest_target_amount"),
    (call_script, "script_start_quest", "qst_deliver_wine", "$g_talk_troop"),
    ]],

  [anyone|plyr,"merchant_quest_brief_deliver_wine", [], "I am afraid I can't carry all that cargo just now.", "merchant_quest_stall",[]],

#escort merchant caravan:
  [anyone,"merchant_quest_requested", [(eq,"$random_merchant_quest_no","qst_escort_merchant_caravan")], "You're looking for a job? Actually I was looking for someone to escort a caravan. Would something like that suit you?", "merchant_quest_brief",
   []],

  [anyone,"merchant_quest_brief", [(eq, "$random_merchant_quest_no", "qst_escort_merchant_caravan")],
   "I am planning to send carts of goods to {s8}. However, with all those bandits and deserters on the roads, I don't want to send them out without an escort. If you can get these carts to {s8} before 15 days have passed, you will earn {reg8} thaler. Of course, your party must be at least {reg4} strong, if you hope to offer them any protection.", "escort_merchant_caravan_quest_brief",
   [(quest_get_slot, reg8, "qst_escort_merchant_caravan", slot_quest_gold_reward),
    (quest_get_slot, reg4, "qst_escort_merchant_caravan", slot_quest_target_amount),
    (quest_get_slot, ":quest_target_center", "qst_escort_merchant_caravan", slot_quest_target_center),
    (str_store_party_name, s8, ":quest_target_center"),
   ]],
  
  [anyone|plyr,"escort_merchant_caravan_quest_brief", [(store_party_size_wo_prisoners, ":party_size", "p_main_party"),
                                                       (quest_get_slot, ":quest_target_amount", "qst_escort_merchant_caravan", slot_quest_target_amount),
                                                       (ge,":party_size",":quest_target_amount"),
                                                       ],
   "All right. I will take the job.", "merchant_quest_taken",
   [(quest_get_slot, ":quest_target_center", "qst_escort_merchant_caravan", slot_quest_target_center),
    (set_spawn_radius, 1),
    (spawn_around_party,"$g_encountered_party","pt_merchant_caravan"),
    (assign, ":quest_target_party", reg0),
    (party_set_ai_behavior, ":quest_target_party", ai_bhvr_track_party),
    (party_set_ai_object, ":quest_target_party", "p_main_party"),
    (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
    (quest_set_slot, "qst_escort_merchant_caravan", slot_quest_target_party, ":quest_target_party"),
    (quest_set_slot, "qst_escort_merchant_caravan", slot_quest_current_state, 0),
    (str_store_party_name_link, s8, ":quest_target_center"),
    (setup_quest_text, "qst_escort_merchant_caravan"),
    (str_store_string, s2, "@Escort the merchant caravan to the town of {s8}."),
    (call_script, "script_start_quest", "qst_escort_merchant_caravan", "$g_talk_troop"),
    ]],
  
  [anyone|plyr,"escort_merchant_caravan_quest_brief", [(store_party_size_wo_prisoners, ":party_size", "p_main_party"),
                                                       (quest_get_slot, ":quest_target_amount", "qst_escort_merchant_caravan", slot_quest_target_amount),
                                                       (lt,":party_size",":quest_target_amount"),],
   "I am afraid I don't have that many soldiers with me.", "merchant_quest_stall",[]],
  [anyone|plyr,"escort_merchant_caravan_quest_brief", [(store_party_size_wo_prisoners, ":party_size", "p_main_party"),
                                                       (quest_get_slot, ":quest_target_amount", "qst_escort_merchant_caravan", slot_quest_target_amount),
                                                       (ge,":party_size",":quest_target_amount"),],
   "Sorry. I can't take that on just now.", "merchant_quest_stall",[]],

  [party_tpl|pt_merchant_caravan,"start", [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                                           (eq,"$g_encountered_party",":quest_target_party"),
                                           (quest_slot_eq,"qst_escort_merchant_caravan", slot_quest_current_state, 2),
                                           ],
   "We can get the rest of the way ourselves. Thank you.", "close_window",[(assign, "$g_leave_encounter", 1)]],
  
  [party_tpl|pt_merchant_caravan,"start", [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                                           (eq,"$g_encountered_party",":quest_target_party"),
                                           (quest_get_slot, ":quest_target_center", "qst_escort_merchant_caravan", slot_quest_target_center),
                                           (store_distance_to_party_from_party, ":dist", ":quest_target_center",":quest_target_party"),
                                           (lt,":dist",4),
                                           (quest_slot_eq, "qst_escort_merchant_caravan", slot_quest_current_state, 1),
                                           ],
   "Well, there's {s21} down the way. We can cover the rest of the road ourselves. Here's your pay... {reg14} thaler. Thanks for the escort. Good luck.", "close_window",[(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                                                       (quest_get_slot, ":quest_target_center", "qst_escort_merchant_caravan", slot_quest_target_center),
                                                       (quest_get_slot, ":quest_giver_center", "qst_escort_merchant_caravan", slot_quest_giver_center),
                                                       (quest_get_slot, ":quest_gold_reward", "qst_escort_merchant_caravan", slot_quest_gold_reward),
                                                       (party_set_ai_behavior, ":quest_target_party", ai_bhvr_travel_to_party),
                                                       (party_set_ai_object, ":quest_target_party", ":quest_target_center"),
                                                       (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
                                                       (str_store_party_name, s21, ":quest_target_center"),
                                                       (call_script, "script_change_player_relation_with_center", ":quest_giver_center", 1),
                                                       (call_script, "script_end_quest","qst_escort_merchant_caravan"),
                                                       (quest_set_slot, "qst_escort_merchant_caravan", slot_quest_current_state, 2),
                                                       (call_script, "script_troop_add_gold", "trp_player", ":quest_gold_reward"),
                                                       (assign, ":xp_reward", ":quest_gold_reward"),
                                                       (val_mul, ":xp_reward", 5),
                                                       (val_add, ":xp_reward", 100),
                                                       (add_xp_as_reward, ":xp_reward"),
                                                       (call_script, "script_change_troop_renown", "trp_player", 2),
                                                       (assign, reg14, ":quest_gold_reward"),
                                                       (assign, "$g_leave_encounter", 1),
                                                       ]],
  
  [party_tpl|pt_merchant_caravan,"start", [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                                           (eq,"$g_encountered_party",":quest_target_party"),
                                           (quest_slot_eq, "qst_escort_merchant_caravan", slot_quest_current_state, 0),
                                           ],
   "You must be our escort, right?", "merchant_caravan_intro_1",[(quest_set_slot, "qst_escort_merchant_caravan", slot_quest_current_state, 1),]],
  
  [anyone|plyr,"merchant_caravan_intro_1", [], "Yes. My name is {playername}. I'm here to lead you to {s1}.",
   "merchant_caravan_intro_2",[(quest_get_slot, ":quest_target_center", "qst_escort_merchant_caravan", slot_quest_target_center),
                               (str_store_party_name, s1, ":quest_target_center"),
                               ]],
  
  [anyone,"merchant_caravan_intro_2", [], "Well, It is good to know we won't be traveling alone. What do would your instructions be now?", "escort_merchant_caravan_talk",[]],
  
  [party_tpl|pt_merchant_caravan,"start", [(quest_get_slot, ":quest_target_party", "qst_escort_merchant_caravan", slot_quest_target_party),
                                           (eq, "$g_encountered_party", ":quest_target_party"),
                                           ],
   "Eh, so we've made it this far... What do you want us to do?", "escort_merchant_caravan_talk",[]],
  
  [anyone|plyr,"escort_merchant_caravan_talk", [], "You follow my lead. I'll take you by the safest route.", "merchant_caravan_follow_lead",[]],
  [anyone,"merchant_caravan_follow_lead", [], "Alright. We'll be right behind you.", "close_window",[(assign, "$escort_merchant_caravan_mode", 0),
                                                                                                     (assign, "$g_leave_encounter", 1)]],
  [anyone|plyr,"escort_merchant_caravan_talk", [], "You stay here for a while. I'll go ahead and check the road.", "merchant_caravan_stay_here",[]],
  [anyone,"merchant_caravan_stay_here", [], "Alright. We'll be waiting here for you.", "close_window",[(assign, "$escort_merchant_caravan_mode", 1),
                                                                                                       (assign, "$g_leave_encounter", 1)]],
#  [anyone|plyr,"escort_merchant_caravan_talk", [], "You go ahead to {s1}. I'll catch up with you.", "merchant_caravan_go_to_destination",[]],
#  [anyone,"merchant_caravan_go_to_destination", [], "Alright. But stay close.", "close_window",[[assign,"escort_merchant_caravan_mode",2]]],


# Troublesome bandits:
  [anyone,"merchant_quest_requested", [(eq, "$random_merchant_quest_no", "qst_troublesome_bandits")],
 "Actually, I've been looking for a fellow like you. You see, there's this group of particularly troublesome bandits, who have infested the environs of our town, and are preying on my trade carts. So far, they've avoided all the soldiers and the militias, and if someone doesn't stop them soon, I'll be ruined...", "merchant_quest_brief",
   []],

  [anyone,"merchant_quest_brief", [(eq,"$random_merchant_quest_no", "qst_troublesome_bandits")],
  "I will pay you {reg8} thaler, if you will hunt down these troublesome bandits. It's dangerous work, but I think you might be just the one to do it. What do you say?", "troublesome_bandits_quest_brief",[(quest_get_slot, reg8, "qst_troublesome_bandits", slot_quest_gold_reward),
                                                       ]],

  [anyone|plyr,"troublesome_bandits_quest_brief", [],
   "All right. I will hunt down those bandits.", "merchant_quest_taken_bandits",
   [(set_spawn_radius,7),
    (quest_get_slot, ":quest_giver_center", "qst_troublesome_bandits", slot_quest_giver_center),
    (spawn_around_party,":quest_giver_center","pt_troublesome_bandits"),
    (quest_set_slot, "qst_troublesome_bandits", slot_quest_target_party, reg0),
    (store_num_parties_destroyed,"$qst_troublesome_bandits_eliminated","pt_troublesome_bandits"),
    (store_num_parties_destroyed_by_player, "$qst_troublesome_bandits_eliminated_by_player", "pt_troublesome_bandits"),
    (str_store_troop_name, s9, "$g_talk_troop"),
    (str_store_party_name_link, s4, "$g_encountered_party"),
    (setup_quest_text,"qst_troublesome_bandits"),
    (str_store_string, s2, "@Merchant {s9} of {s4} asked you to hunt down the troublesome bandits in the vicinity of the town."),
    (call_script, "script_start_quest", "qst_troublesome_bandits", "$g_talk_troop"),
    ]],
  [anyone,"merchant_quest_taken_bandits", [], "You will? It does my heart good to hear you say that. Good luck to you!", "close_window",
   []],
  
  [anyone|plyr,"troublesome_bandits_quest_brief", [],
   "Sorry. I don't have time for this right now.", "merchant_quest_stall",[]],

# Kidnapped girl:
  [anyone,"merchant_quest_requested", [(eq, "$random_merchant_quest_no", "qst_kidnapped_girl")],
 "Actually, I was looking for a reliable assistant to undertake an important mission. A group of bandits have kidnapped the daughter of a friend of mine and are holding her for ransom. My friend is ready to pay them, but we need someone to take the money to those rascals -- and bring the girl back safely.", "merchant_quest_brief",
   []],

  [anyone,"merchant_quest_brief", [(eq, "$random_merchant_quest_no", "qst_kidnapped_girl")],
  "The bandits are asking for {reg12} thaler, which I will hand over to you as soon as you accept the quest. You have 15 days to take the money to the bandits, who will be waiting near the village of {s4}. The bastards said that they'll kill the poor girl if they don't get the money by then. You will get your pay of {reg8} thaler after you bring the girl safely back here.",
   "kidnapped_girl_quest_brief",[(quest_get_slot, ":quest_target_center", "qst_kidnapped_girl", slot_quest_target_center),
                                 (str_store_party_name, s4, ":quest_target_center"),
                                 (quest_get_slot, reg8, "qst_kidnapped_girl", slot_quest_gold_reward),
                                 (quest_get_slot, reg12, "qst_kidnapped_girl", slot_quest_target_amount),
                                 ]],

  [anyone|plyr,"kidnapped_girl_quest_brief", [],
      "Alright. I will take the ransom money to the bandits and bring back the girl.",
   "kidnapped_girl_quest_taken",[(set_spawn_radius, 4),
                                 (quest_get_slot, ":quest_target_center", "qst_kidnapped_girl", slot_quest_target_center),
                                 (quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                                 (spawn_around_party,":quest_target_center","pt_bandits_awaiting_ransom"),
                                 (assign, ":quest_target_party", reg0),
                                 (quest_set_slot, "qst_kidnapped_girl", slot_quest_target_party, ":quest_target_party"),
                                 (party_set_ai_behavior, ":quest_target_party", ai_bhvr_hold),
                                 (party_set_ai_object, ":quest_target_party", "p_main_party"),
                                 (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
                                 (call_script, "script_troop_add_gold", "trp_player", ":quest_target_amount"),
                                 (assign, reg12, ":quest_target_amount"),
                                 (str_store_troop_name, s1, "$g_talk_troop"),
                                 (str_store_party_name_link, s4, "$g_encountered_party"),
                                 (str_store_party_name_link, s3, ":quest_target_center"),
                                 (setup_quest_text, "qst_kidnapped_girl"),
                                 (str_store_string, s2, "@Guildmaster of {s4} gave you {reg12} denars to pay the ransom of a girl kidnapped by bandits.\
 You are to meet the bandits near {s3} and pay them the ransom fee.\
 After that you are to bring the girl back to {s4}."),
                                 (call_script, "script_start_quest", "qst_kidnapped_girl", "$g_talk_troop"),
                                 ]],
  
  [anyone,"kidnapped_girl_quest_taken", [], "Good. I knew we could count on you for this. Here is the ransom money, all {reg12} thaler. Count it before you take it. And please, don't attempt to do anything rash. Keep in mind that the girl's life is more important than anything else...", "close_window",
   []],
  
  [anyone|plyr,"kidnapped_girl_quest_brief", [],
   "Sorry. I don't have the time for this right now.", "merchant_quest_stall",[]],


  [trp_kidnapped_girl,"start",
   [
     (eq, "$talk_context", tc_entering_center_quest_talk),
     ],
   "Thank you for saving my life, {sir/madam}! It has been horrible here...",
   "close_window",
   [(remove_member_from_party, "trp_kidnapped_girl"),
    (quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 4),
    ]],



  [trp_kidnapped_girl|plyr,"kidnapped_girl_liberated_map", [], "Yes. Come with me. We're going home.", "kidnapped_girl_liberated_map_2a",[]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_map_2a", [(neg|party_can_join)], "But you don't have room in your party for me.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_map_2a", [], "Oh really? Thank you!",
   "close_window", [(party_join),
                    (quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 3),
                    (assign, "$g_leave_encounter",1)]],
  [trp_kidnapped_girl|plyr,"kidnapped_girl_liberated_map", [], "Just wait here a while longer. I'll be back for you.", "kidnapped_girl_liberated_map_2b",[]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_map_2b", [], "Oh, please {sir/madam}, don't leave me here all alone!", "close_window",[(assign, "$g_leave_encounter",1)]],


  [trp_kidnapped_girl,"start", [],
   "Oh thank you so much for rescuing me. Will you take me to my family now?", "kidnapped_girl_liberated_map",[]],
  
  [trp_kidnapped_girl|plyr,"kidnapped_girl_liberated_battle", [], "Yes. Come with me. We're going home.", "kidnapped_girl_liberated_battle_2a",[]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_battle_2a", [(neg|hero_can_join, "p_main_party")], "But you don't have room in your party for me.", "kidnapped_girl_liberated_battle_2b",[]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_battle_2a", [], "Oh really? Thank you!",
   "close_window",[(party_add_members, "p_main_party","trp_kidnapped_girl",1),
                   (quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 3),
                   ]],
  [trp_kidnapped_girl|plyr,"kidnapped_girl_liberated_battle", [], "Just wait here a while longer. I'll be back for you.", "kidnapped_girl_liberated_battle_2b",[]],
  [trp_kidnapped_girl,"kidnapped_girl_liberated_battle_2b", [], "Oh, please {sir/madam}, don't leave me here all alone!",
   "close_window", [(add_companion_party,"trp_kidnapped_girl"),
                    (assign, "$g_leave_encounter",1)]],

  [trp_kidnapped_girl,"start", [], "Can I come with you now?", "kidnapped_girl_liberated_map",[]],


  [party_tpl|pt_bandits_awaiting_ransom,"start", [(quest_slot_eq, "qst_kidnapped_girl", slot_quest_current_state, 0),],
   "Are you the one that brought the ransom? Quick, give us the money! -- Now!", "bandits_awaiting_ransom_intro_1",[(quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 1),]],
  [party_tpl|pt_bandits_awaiting_ransom,"start", [(quest_slot_eq, "qst_kidnapped_girl", slot_quest_current_state, 1),],
   "You came back? Quick, give us the money! Now!", "bandits_awaiting_ransom_intro_1",[]],
  [party_tpl|pt_bandits_awaiting_ransom|plyr, "bandits_awaiting_ransom_intro_1", [(store_troop_gold, ":cur_gold"),
                                                                                  (quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                                                                                  (ge, ":cur_gold", ":quest_target_amount")
                                                                                  ],
   "Here, take the money. Just set the girl free.", "bandits_awaiting_ransom_pay",[]],
  [party_tpl|pt_bandits_awaiting_ransom, "bandits_awaiting_ransom_pay", [],
   "Heh. Looks like it's all here. Alright, you can take the girl. It was a pleasure doing business with you...", "close_window",
   [(quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
    (quest_get_slot, ":quest_target_party", "qst_kidnapped_girl", slot_quest_target_party),
    (quest_get_slot, ":quest_target_center", "qst_kidnapped_girl", slot_quest_target_center),
    (troop_remove_gold, "trp_player", ":quest_target_amount"),
    (remove_member_from_party, "trp_kidnapped_girl", ":quest_target_party"),
    (set_spawn_radius, 1),
    (spawn_around_party, ":quest_target_party", "pt_kidnapped_girl"),
    (assign, ":girl_party", reg0),
    (party_set_ai_behavior, ":girl_party", ai_bhvr_hold),
    (party_set_flags, ":girl_party", pf_default_behavior, 0),
    (quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 2),
    (party_set_ai_behavior, ":quest_target_party", ai_bhvr_travel_to_party),
    (party_set_ai_object, ":quest_target_party", ":quest_target_center"),
    (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
    (add_gold_to_party, ":quest_target_amount", ":quest_target_party"),
    (assign, "$g_leave_encounter",1),
    ]],
  
  [anyone|plyr, "bandits_awaiting_ransom_intro_1", [],
   "No way! Release the girl first.", "bandits_awaiting_ransom_b",[]],
  [anyone, "bandits_awaiting_ransom_b", [],
   "You fool! Stop playing games and give us the money! ", "bandits_awaiting_ransom_b2",[]],
  [anyone|plyr, "bandits_awaiting_ransom_b2", [(store_troop_gold, ":cur_gold"),
                                               (quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                                               (ge, ":cur_gold", ":quest_target_amount")],
   "All right. Here's your money. Now let the girl go.", "bandits_awaiting_ransom_pay",[]],
  [anyone|plyr, "bandits_awaiting_ransom_b2", [],
   "I hid the money in a safe place. I'll go fetch it.", "bandits_awaiting_ransom_no_money",[]],
  [anyone, "bandits_awaiting_ransom_no_money", [],
   "Are you testing our patience or something? Go and bring that money back here -- fast!", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone|plyr, "bandits_awaiting_ransom_b2", [],
   "I have no intention of paying you anything. I demand that you release the girl now!", "bandits_awaiting_ransom_fight",[]],
  [anyone, "bandits_awaiting_ransom_fight", [],
   "You won't be demanding anything when you're dead.", "close_window",[(encounter_attack),]],

  [party_tpl|pt_bandits_awaiting_ransom,"start", [(quest_slot_ge, "qst_kidnapped_girl", slot_quest_current_state, 2),],
   "What do you want? You gave us the money. We have no more business with you.", "bandits_awaiting_remeet",[]],
  [anyone|plyr,"bandits_awaiting_remeet", [],
   "Sorry to bother you. I'll be on my way now.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"bandits_awaiting_remeet", [],
   "Actually, we do have one more piece of business. You will return the money to me.", "bandits_awaiting_remeet_2",[]],
  [anyone,"bandits_awaiting_remeet_2", [],
   "Oh, that business! Of course. Alright, let us get to it!", "close_window",[(encounter_attack)]],

  [party_tpl|pt_kidnapped_girl,"start", [],
   "Oh, thank you so much for rescuing me! Will you take me to my family now?", "kidnapped_girl_encounter_1",[]],
  [anyone|plyr,"kidnapped_girl_encounter_1", [], "Yes. Come with me. I'll take you home.", "kidnapped_girl_join",[]],
  [anyone,"kidnapped_girl_join", [(neg|party_can_join)], "But you don't have room in your party for me.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone,"kidnapped_girl_join", [], "Oh, thank you so much!",
   "close_window",[(party_join),
                   (quest_set_slot, "qst_kidnapped_girl", slot_quest_current_state, 3),
                   (assign, "$g_leave_encounter",1)]],
  [anyone|plyr,"kidnapped_girl_encounter_1", [], "Wait here a while longer. I'll come back for you.", "kidnapped_girl_wait",[]],
  [anyone,"kidnapped_girl_wait", [], "Oh, please {sir/madam}, don't leave me here all alone!", "close_window",[(assign, "$g_leave_encounter",1)]],

  [anyone|plyr,"merchant_quest_about_job_2", [(store_partner_quest, ":partner_quest"),
                                              (eq, ":partner_quest", "qst_kidnapped_girl"),
                                              (quest_slot_eq, "qst_kidnapped_girl", slot_quest_current_state, 3),
                                              (neg|main_party_has_troop, "trp_kidnapped_girl")],
   "Unfortunately the girl ran off while we were on the way here...", "lost_kidnapped_girl",[]],
  [anyone,"lost_kidnapped_girl", [],
   "Oh no! How am I going to tell my friend?", "lost_kidnapped_girl_2",[]],
  [anyone|plyr,"lost_kidnapped_girl_2", [],
   "I'm sorry. There was nothing I could do.", "lost_kidnapped_girl_3",[]],
  [anyone,"lost_kidnapped_girl_3", [],
   "I had trusted you, {playername}, and you let me down. I will tell everyone of your incompetence. -- And I want you to return that {reg8} thaler I gave you as the ransom fee.", "lost_kidnapped_girl_4",
   [(quest_get_slot, reg8, "qst_kidnapped_girl", slot_quest_target_amount),
    (try_for_parties, ":cur_party"),
      (party_count_members_of_type, ":num_members", ":cur_party", "trp_kidnapped_girl"),
      (gt, ":num_members", 0),
      (party_remove_members, ":cur_party", "trp_kidnapped_girl", 1),
      (party_remove_prisoners, ":cur_party", "trp_kidnapped_girl", 1),
    (try_end),
    (call_script, "script_end_quest", "qst_kidnapped_girl"),
    (call_script, "script_change_troop_renown", "trp_player", -5),
    ]],
  [anyone|plyr, "lost_kidnapped_girl_4", [(store_troop_gold,":gold"),
                                          (quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                                          (ge,":gold",":quest_target_amount"),
                                          ],
   "Of course. Here you are...", "merchant_quest_about_job_5a",[(quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                                                                (troop_remove_gold, "trp_player",":quest_target_amount"),
                                                                ]],
  [anyone,"merchant_quest_about_job_5a", [],
   "Very well, at least you have the decency to return the money.", "close_window",[]],
  [anyone|plyr,"lost_kidnapped_girl_4", [],
   "Sorry. I don't have that much with me at the moment.", "merchant_quest_about_job_5b",[]],
  [anyone,"merchant_quest_about_job_5b", [],
   "Do you expect me to believe that? You are going to repay that ransom fee!",
   "close_window",[(quest_get_slot, ":quest_target_amount", "qst_kidnapped_girl", slot_quest_target_amount),
                   (val_add, "$debt_to_merchants_guild", ":quest_target_amount"),
                   ]],


#  Give us the money now. Quick.
# Here, take the money. Just set the girl free.
# Heh, It was a pleasure doing business with you. 
  
# You set the girl free first. You'll have the money afterwards.
# Stop playing games.  

#persuade_lords_to_make_peace
  [anyone,"merchant_quest_requested", [(eq, "$random_merchant_quest_no", "qst_persuade_lords_to_make_peace"),
                                       (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
                                       (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
                                       (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
                                       (str_store_troop_name_link, s12, ":quest_object_troop"),
                                       (str_store_troop_name_link, s13, ":quest_target_troop"),
                                       (str_store_faction_name_link, s14, ":quest_target_faction"),
                                       (str_store_faction_name_link, s15, "$g_encountered_party_faction"),],
   "This war between {s15} and {s14} has brought our town to the verge of ruin. Our carts are raided before they can reach their destination. Our merchants are afraid to leave the safety of the town walls. And as if that isn't enough, the taxes we are charged to maintain the war have deprived us of our last scraps of savings. We pray for peace, but we will not be able to hold out much longer.", "merchant_quest_persuade_peace_1",
   []],

  [anyone|plyr,"merchant_quest_persuade_peace_1", [], "You are right. But who can stop this madness called war?", "merchant_quest_brief",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_1", [], "It is your duty to help the nobles in their war efforts. You shouldn't complain about it.", "merchant_quest_persuade_peace_reject",[]],

  [anyone,"merchant_quest_persuade_peace_reject", [], "Hah. The nobles fight their wars for greed and dreams of glory. And it is poor honest folk like us who bear the real burden. But obviously you don't want to hear about that.", "close_window",[]],

  [anyone,"merchant_quest_brief", [(eq,"$random_merchant_quest_no","qst_persuade_lords_to_make_peace")],
   "There have been attempts to reconcile the two sides and reach a settlement. However, there are powerful nobles on both sides whose interests lie in continuing the war. These men urge the others not to heed to the words of sensible men, but to keep fighting. While these leaders remain influential, no peace settlement can be reached.", "merchant_quest_persuade_peace_3",[]],

  [anyone|plyr,"merchant_quest_persuade_peace_3", [], "Who are these warmongers who block the way to peace?", "merchant_quest_persuade_peace_4",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_3", [], "Who are these nobles you speak of?", "merchant_quest_persuade_peace_4",[]],

  [anyone,"merchant_quest_persuade_peace_4", [], "They are {s12} of the {s15} and {s13} of the {s14}. Until they change their ways or lose their influence, there is little chance of peace between the two sides.", "merchant_quest_persuade_peace_5",[
       (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
       (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
       (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
       (str_store_troop_name_link, s12, ":quest_object_troop"),
       (str_store_troop_name_link, s13, ":quest_target_troop"),
       (str_store_faction_name_link, s14, ":quest_target_faction"),
       (str_store_faction_name_link, s15, "$g_encountered_party_faction"),     
     ]],

  [anyone|plyr,"merchant_quest_persuade_peace_5", [], "What is it you would have me do?", "merchant_quest_persuade_peace_6",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_5", [], "It seems a hopeless case...", "merchant_quest_persuade_peace_6",[]],

  [anyone,"merchant_quest_persuade_peace_6", [], "There is a way to resolve the issue. A particularly determined person could persuade one or both of them to accept peace. And even if that fails, it might be possible to see that they are defeated by force and taken prisoner. If they were taken captive, they would lose their influence, and they could no longer oppose peace... What do you think?",
   "merchant_quest_persuade_peace_7",[]],

  [anyone|plyr,"merchant_quest_persuade_peace_7", [], "It seems difficult. But I will try.", "merchant_quest_persuade_peace_8",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_7", [], "If the price is right, I may be able to help.", "merchant_quest_persuade_peace_8",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_7", [], "Forget it. This is not my concern.", "merchant_quest_persuade_peace_8",[]],

  [anyone,"merchant_quest_persuade_peace_8", [], "Most of the merchants in the town will gladly open up their purses to support such a plan. I think we can collect {reg12} thaler amongst ourselves. We will be happy to reward you with that sum, if you can win a peace. Convince {s12} and {s13} to accept a peace settlement, and if either of them proves too stubborn, make sure he falls captive and is not be ransomed until the peace deal is settled.",
   "merchant_quest_persuade_peace_9",[
       (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
       (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
       (str_store_troop_name_link, s12, ":quest_object_troop"),
       (str_store_troop_name_link, s13, ":quest_target_troop"),
       (quest_get_slot, ":quest_reward", "qst_persuade_lords_to_make_peace", slot_quest_gold_reward),
       (assign, reg12, ":quest_reward")]],
  
  [anyone|plyr,"merchant_quest_persuade_peace_9", [], "All right. I will do my best.", "merchant_quest_persuade_peace_10",[]],
  [anyone|plyr,"merchant_quest_persuade_peace_9", [], "Sorry. I cannot do this.", "merchant_quest_persuade_peace_no",[]],
  
  [anyone,"merchant_quest_persuade_peace_10", [], "Excellent. Now go with our blessings. We will be waiting and hoping for the good news.", "close_window",[
     (str_store_party_name_link, s4, "$g_encountered_party"),
     (quest_get_slot, ":quest_target_faction", "qst_persuade_lords_to_make_peace", slot_quest_target_faction),
     (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
     (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
     (quest_get_slot, ":quest_reward", "qst_persuade_lords_to_make_peace", slot_quest_gold_reward),
     (assign, reg12, ":quest_reward"),
     (str_store_troop_name_link, s12, ":quest_object_troop"),
     (str_store_troop_name_link, s13, ":quest_target_troop"),
     (str_store_faction_name_link, s14, ":quest_target_faction"),
     (str_store_faction_name_link, s15, "$g_encountered_party_faction"),     
     (setup_quest_text,"qst_persuade_lords_to_make_peace"),
     (str_store_string, s2, "@Guildmaster of {s4} promised you {reg12} denars if you can make sure that\
 {s12} and {s13} no longer pose a threat to a peace settlement between {s15} and {s14}.\
 In order to do that, you must either convince them or make sure they fall captive and remain so until a peace agreement is made."),
     (call_script, "script_start_quest", "qst_persuade_lords_to_make_peace", "$g_talk_troop"),
     (quest_get_slot, ":quest_object_troop", "qst_persuade_lords_to_make_peace", slot_quest_object_troop),
     (quest_get_slot, ":quest_target_troop", "qst_persuade_lords_to_make_peace", slot_quest_target_troop),
     (call_script, "script_report_quest_troop_positions", "qst_persuade_lords_to_make_peace", ":quest_object_troop", 3),
     (call_script, "script_report_quest_troop_positions", "qst_persuade_lords_to_make_peace", ":quest_target_troop", 4),
     ]],
  
  [anyone,"merchant_quest_persuade_peace_no", [], "Do not refuse so quickly. Think on this. If there is one {man/lady} who can manage to do this, it is you.",
   "close_window",[]],


#deal with night bandits
  [anyone,"merchant_quest_requested",
   [
     (eq, "$random_merchant_quest_no", "qst_deal_with_night_bandits"),
     ],
   "There's a group of bandits infesting the town, and I'm at the end of my rope as to how to deal with them. They've been ambushing and robbing our townspeople under the cover of night, and then fading into the shadows when the guards finally show up. We've not been able to catch even a one of them. They only attack lone people, never daring to show themselves when there's a group about. I need someone who has a chance of taking on these bandits alone -- and winning. That seems the only way of bringing them to justice. Are you up to the task?", "merchant_quest_deal_with_night_bandits",
   []],

  [anyone,"merchant_quest_brief",
   [
     (eq,"$random_merchant_quest_no","qst_deal_with_night_bandits"),
     ],
   "Do I indeed! There's a group of bandits infesting the town, and I'm at the end of my rope as to how to deal with them. They've been ambushing and robbing our townspeople under the cover of night, and then fading into the shadows when the guards finally show up. We've not been able to catch even a one of them. They only attack lone people, never daring to show themselves when there's a group about. I need someone who has a chance of taking on these bandits alone -- and winning. That seems the only way of bringing them to justice. Are you up to the task?", "merchant_quest_deal_with_night_bandits",
   []],

  [anyone|plyr,"merchant_quest_deal_with_night_bandits", [],
   "Killing bandits? Why, it would be a pleasure!",
   "deal_with_night_bandits_quest_taken",
   [
     (str_store_party_name_link, s14, "$g_encountered_party"),
     (setup_quest_text, "qst_deal_with_night_bandits"),
     (str_store_string, s2, "@The Guildmaster of {s14} has asked you to deal with a group of bandits terrorising the streets of {s14}. They only come out at night, and only attack lone travellers on the streets."),
     (call_script, "script_start_quest", "qst_deal_with_night_bandits", "$g_talk_troop"),
     ]],
  
  [anyone|plyr, "merchant_quest_deal_with_night_bandits", [],
   "This is of no interest to me.", "merchant_quest_stall",[]],

  [anyone,"deal_with_night_bandits_quest_taken", [], "That takes a great weight off my shoulders, {playername}. You can expect a fine reward if you come back successful. Just don't get yourself killed, eh?", "mayor_pretalk",[]],


#move cattle herd
  [anyone,"merchant_quest_requested", [(eq, "$random_merchant_quest_no", "qst_move_cattle_herd"),
                                       (quest_get_slot, ":target_center", "qst_move_cattle_herd", slot_quest_target_center),
                                       (str_store_party_name,s13,":target_center"),],
   "One of the merchants here is looking for herdsmen to take his cattle to the market at {s13}.", "merchant_quest_brief",
   []],

  [anyone,"merchant_quest_brief",
   [
    (eq,"$random_merchant_quest_no","qst_move_cattle_herd"),
    (quest_get_slot, reg8, "qst_move_cattle_herd", slot_quest_gold_reward),
    (quest_get_slot, ":target_center", "qst_move_cattle_herd", slot_quest_target_center),
    (str_store_party_name, s13, ":target_center"),
    ],
   "The herd must be at {s13} within the next 30 days. The sooner the better, but it must be absolutely no later than 30 days. If you can do it, I'd be willing to pay you {reg8} thaler for your trouble. Sound interesting?", "move_cattle_herd_quest_brief",
   []],
  
  [anyone|plyr,"move_cattle_herd_quest_brief", [],  "Aye, I can take the herd to {s13}.",
   "move_cattle_herd_quest_taken",
   [
     (call_script, "script_create_cattle_herd", "$g_encountered_party", 0),
     (quest_set_slot, "qst_move_cattle_herd", slot_quest_target_party, reg0),
     (str_store_party_name_link, s10,"$g_encountered_party"),
     (quest_get_slot, ":target_center", "qst_move_cattle_herd", slot_quest_target_center),
     (str_store_party_name_link, s13, ":target_center"),
     (quest_get_slot, reg8, "qst_move_cattle_herd", slot_quest_gold_reward),
     (setup_quest_text, "qst_move_cattle_herd"),
     (str_store_string, s2, "@Guildmaster of {s10} asked you to move a cattle herd to {s13}. You will earn {reg8} denars in return."),
     (call_script, "script_start_quest", "qst_move_cattle_herd", "$g_talk_troop"),
     ]],
  [anyone|plyr,"move_cattle_herd_quest_brief", [],
   "I am sorry, but no.", "merchant_quest_stall",[]],

  [anyone,"move_cattle_herd_quest_taken", [], "Excellent. You can find the herd right outside town. After you take the animals to {s13}, come back here to me and I will give you your pay.", "mayor_pretalk",[]],


################################################# 
#################### Random merchant quests end

  [anyone,"merchant_quest_requested", [], "I am afraid I can't offer you a job right now.", "mayor_pretalk",[]],


#Village elders

  [anyone,"start", [(is_between,"$g_talk_troop",village_elders_begin,village_elders_end),
                    (store_partner_quest,":elder_quest"),
                    (eq,":elder_quest","qst_deliver_cattle"),
                    (check_quest_active, ":elder_quest"),
                    (check_quest_succeeded, ":elder_quest"),
                    (quest_get_slot, reg5, "qst_deliver_cattle", slot_quest_target_amount)],
   "My good {sir/madam}. Our village is grateful for your help. Thanks to the {reg5} head of cattle you brought, we now have enough to raise our own herd.", "village_elder_deliver_cattle_thank",
   [(add_xp_as_reward, 400),
    (quest_get_slot, ":num_cattle", "qst_deliver_cattle", slot_quest_target_amount),
    (party_set_slot, "$current_town", slot_village_number_of_cattle, ":num_cattle"),	
    (call_script, "script_change_center_prosperity", "$current_town", 4),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
    (call_script, "script_end_quest", "qst_deliver_cattle"),
#Troop commentaries begin
    (call_script, "script_add_log_entry", logent_helped_peasants, "trp_player",  "$current_town", -1, -1),
#Troop commentaries end

    ]],

  [anyone,"village_elder_deliver_cattle_thank", [],
   "My good {lord/lady}, please, is there anything I can do for you?", "village_elder_talk",[]],
  

##  [anyone,"start",
##   [
##     (is_between, "$g_talk_troop", village_elders_begin, village_elders_end),
##     (store_partner_quest, ":elder_quest"),
##     (eq, ":elder_quest", "qst_train_peasants_against_bandits"),
##     (check_quest_succeeded, ":elder_quest"),
##     (quest_get_slot, reg5, "qst_train_peasants_against_bandits", slot_quest_target_amount)],
##   "Oh, thank you so much for training our men. Now we may stand a chance against those accursed bandits if they come again.", "village_elder_train_peasants_against_bandits_thank",
##   [
##     (add_xp_as_reward, 400),
##     (call_script, "script_change_player_relation_with_center", "$current_town", 5),
##     (call_script, "script_end_quest", "qst_train_peasants_against_bandits"),
##     (call_script, "script_add_log_entry", logent_helped_peasants, "trp_player",  "$current_town", -1, -1),
##    ]],

#  [anyone,"village_elder_train_peasants_against_bandits_thank", [],
#   "Now, good {sire/lady}, is there anything I can do for you?", "village_elder_talk",[]],



	[anyone,"start", [
	        (quest_slot_eq, "qst_oim_hunt_down_thieves", slot_quest_target_center, "$current_town"),
			(check_quest_active,"qst_oim_hunt_down_thieves"),
			(check_quest_succeeded,"qst_oim_hunt_down_thieves"),			
			(is_between,"$g_talk_troop",village_elders_begin,village_elders_end),
	],  "Good day, {sir/madam}. We heard you caught the thieves. Thank you, we're ever so grateful. Our villagers want to reward you with the fruits of their labor.", "oim_hunt_down_thieves_succeeded",[]],

  [anyone|plyr,"oim_hunt_down_thieves_succeeded", 
  [    
    (try_for_range, ":cur_good", trade_goods_begin, trade_goods_end),
      (store_sub, ":cur_good_slot", ":cur_good", trade_goods_begin),
      (val_add, ":cur_good_slot", slot_town_trade_good_productions_begin),
      (party_get_slot, ":production", "$g_encountered_party", ":cur_good_slot"),
      (ge, ":production", 18),
	  (troop_add_item, "trp_player", ":cur_good"),
    (try_end),

    (add_xp_as_reward, 50),

	(call_script, "script_change_player_relation_with_center", "$current_town", 10),

	(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),

	(call_script, "script_end_quest", "qst_oim_hunt_down_thieves"),
  ],
   "No problem, it was an easy job for me. Thanks for the reward.", "village_elder_pretalk",[]],

  [anyone,"start", [(is_between,"$g_talk_troop", village_elders_begin, village_elders_end),(eq,"$g_talk_troop_met",0),
                    (str_store_party_name, s9, "$current_town")],
   "Good day, {sir/madam}, and welcome to {s9}. I am the elder of this village.", "village_elder_talk",[]],

  [anyone,"start", [(is_between,"$g_talk_troop", village_elders_begin, village_elders_end),(eq,"$g_talk_troop_met",0),
                    (str_store_party_name, s9, "$current_town"),
                    (party_slot_eq, "$current_town", slot_town_lord, "trp_player")],
   "Welcome to {s9}, my {lord/lady}. We are rejoicing at the news that you are the new {lord/lady} of our humble village. I am the village elder, and I would be honored to serve you in any way I can.", "village_elder_talk",[]],
  
  [anyone ,"start", [(is_between,"$g_talk_troop",village_elders_begin,village_elders_end),
                     (party_slot_eq, "$current_town", slot_town_lord, "trp_player")],
   "{My lord/My lady}, you honor our humble village with your presence.", "village_elder_talk",[]],

  [anyone ,"start", [(is_between,"$g_talk_troop",village_elders_begin,village_elders_end)],
   "Good day, {sir/madam}.", "village_elder_talk",[]],

  [anyone ,"village_elder_pretalk", [],
   "Is there anything else I can do for you?", "village_elder_talk",[]],

  [anyone|plyr,"village_elder_talk", [(check_quest_active, "qst_hunt_down_fugitive"),
                                      (neg|check_quest_concluded, "qst_hunt_down_fugitive"),
                                      (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_target_center, "$current_town"),
                                      (quest_get_slot, ":quest_target_dna", "qst_hunt_down_fugitive", slot_quest_target_dna),
                                      (call_script, "script_get_name_from_dna_to_s50", ":quest_target_dna"),
                                      (str_store_string, s4, s50),
                                      ],
   "I am looking for a man by the name of {s4}. I was told he may be hiding here.", "village_elder_ask_fugitive",[]],

  [anyone|plyr,"village_elder_talk", [
		(party_slot_eq, "$current_town", slot_town_lord, "trp_player"), 
                                      ],
   "I would like to talk about developing the village.", "ms_talk_to_elder_to_construct",[]],   
   
   #ms_talk_to_elder_to_construct

  [anyone ,"village_elder_ask_fugitive", [(is_currently_night)],
   "Strangers come and go in our village, {sir/madam}, but I doubt you'll run into him at this hour. You would have better luck during the day.", "village_elder_pretalk",[]],
  [anyone ,"village_elder_ask_fugitive", [],
   "Strangers come and go here, {sir/madam}, but the village folk remain. If you wish to look for him, do as you would please.", "close_window",[]],

  [anyone|plyr,"village_elder_talk", [(store_partner_quest,":elder_quest"),(ge,":elder_quest",0)],
   "About the task you asked of me...", "village_elder_active_mission_1",[]],

  [anyone|plyr,"village_elder_talk", [(ge, "$g_talk_troop_faction_relation", 0),(store_partner_quest,":elder_quest"),(lt,":elder_quest",0), (neq, "$g_talk_troop", "trp_village_66_elder"),],
   "Do you have any tasks I can help you with?", "village_elder_request_mission_ask",[]],

  [anyone|plyr,"village_elder_talk", [(party_slot_eq, "$current_town", slot_village_state, 0),
                                      (neg|party_slot_ge, "$current_town", slot_village_infested_by_bandits, 1),],
   "I want to buy some supplies. I will pay in silver.", "village_elder_trade_begin",[]],

#OiM village elders inputs oimelders

  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_66_elder"), (check_quest_active, "qst_talk_to_zamoshie_elder"), (neg|check_quest_finished, "qst_talk_to_zamoshie_elder"), ], 
	"May your days be long, father. Tell me -- what is happening around here?", "oim_intro_zamoshie_elder",[
		(call_script, "script_end_quest", "qst_talk_to_zamoshie_elder"), 
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", 1),
	]],  
  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_66_elder"), (check_quest_succeeded, "qst_deal_with_zamoshie_bandits"), (neg|check_quest_finished, "qst_deal_with_zamoshie_bandits"),], "I come to talk about the bandits...", "oim_zamoshie_killed_bandits",[]],  
  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_66_elder"), (check_quest_succeeded, "qst_zamoshie_lower_taxes"), (neg|check_quest_finished, "qst_zamoshie_lower_taxes"),], "I come to talk about the taxes...", "oim_zamoshie_lower_taxes_done",[]],  
  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_66_elder"), (check_quest_active, "qst_oim_bring_goods_zamoshie"), (neg|check_quest_finished, "qst_oim_bring_goods_zamoshie"),], "I come to talk about the goods...", "oim_check_bring_goods",[]],  
  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_66_elder"), (check_quest_finished, "qst_talk_to_zamoshie_elder"),], "Perhaps I could offer more aid?", "oim_choose_quests",[]],  
  
 #oim trakay elder start 
  [anyone|plyr,"village_elder_talk", [
	(eq, "$g_talk_troop", "trp_village_82_elder"), 
	(check_quest_active, "qst_oim_dmitriy_gerasim"), 
	(quest_slot_eq, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 0)
  ], "I have heard tell that Gerasim Evangelic lives here. Where can I find him?", "oim_start_quest_trakay_icon",[
	(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 1)
  ]],      

  [anyone|plyr,"village_elder_talk", [
	(eq, "$g_talk_troop", "trp_village_82_elder"), 
	(check_quest_succeeded, "qst_oim_trakay_icon"), 
	(neg|check_quest_finished, "qst_oim_trakay_icon"),
  ], "I come to talk about the icon...", "oim_tracai_icon_done",[]],  
  
  [anyone|plyr,"village_elder_talk", [(eq, "$g_talk_troop", "trp_village_82_elder"), (check_quest_failed, "qst_oim_trakay_icon"), (neg|check_quest_finished, "qst_oim_trakay_icon"),], "I come to talk about the icon...", "oim_tracai_icon_failed",[]],  

  [anyone|plyr,"village_elder_talk", [
		(eq, "$g_talk_troop", "trp_village_4_elder"), 
		(check_quest_active, "qst_oim_invest"), 
		(neg|check_quest_finished, "qst_oim_invest"),
		(quest_slot_eq, "qst_oim_invest", slot_quest_current_state, 0),
   ], "I want to talk about the money...", "oim_get_money_invest_dlg",[]],  

  [anyone|plyr,"village_elder_talk", [
	(eq, "$g_talk_troop", "trp_village_28_elder"), 
	(check_quest_active, "qst_oim_sem_samuraev"),
	(neg|check_quest_succeeded, "qst_oim_sem_samuraev"), 
	(neg|check_quest_failed, "qst_oim_sem_samuraev"),
	(quest_slot_eq, "qst_oim_sem_samuraev", slot_quest_current_state, 0),
  ], "Elder, I understand that you need protection from bandits.", "oim_sem_samuraev_defend_village",[]],  

  
  ################################################################################################
  ##																							##
  ##    OiM Black Getman code																	##
  ##																							##
  ################################################################################################
  
    [anyone|plyr,"village_elder_talk", [
		(eq, "$g_talk_troop", "trp_village_53_elder"), 
	], "One question I have, father... Why would your village bear such a name?", "oim_getman_nesviz_elder_village_name",[]],  
  
    [anyone|plyr,"village_elder_talk", [
		(eq, "$g_talk_troop", "trp_village_53_elder"), 
		(check_quest_active, "qst_oim_getman_nesviz_legend"),
		(neg|check_quest_finished, "qst_oim_getman_nesviz_legend"),
	], "Father, word has come to me that a few years ago some stone coffins were brought here...", "oim_getman_nesviz_elder_dlg",[]],  
  

  [anyone ,"village_elder_trade_begin", [], "Of course, {sir/madam}. Do you want to buy goods or cattle?", "village_elder_trade_talk",[]],

  [anyone|plyr,"village_elder_trade_talk", [], "I want to buy food and supplies.", "village_elder_trade",[]],

  [anyone ,"village_elder_trade", [],
   "We have some food and other supplies in our storehouse. Come have a look.", "village_elder_pretalk",[(change_screen_trade, "$g_talk_troop"),]],

  [anyone|plyr,"village_elder_trade_talk", [(party_slot_eq, "$current_town", slot_village_state, 0),
                                      (neg|party_slot_ge, "$current_town", slot_village_infested_by_bandits, 1),
                                      (assign, ":quest_village", 0),
                                      (try_begin),
                                        (check_quest_active, "qst_deliver_cattle"),
                                        (quest_slot_eq, "qst_deliver_cattle", slot_quest_target_center, "$current_town"),
                                        (assign, ":quest_village", 1),
                                      (try_end),
                                      (eq, ":quest_village", 0),
                                      ],
   "I want to buy some cattle.", "village_elder_buy_cattle",[]],
  
  [anyone|plyr,"village_elder_trade_talk", [], "I've changed my mind. I don't need to buy anything.", "village_elder_pretalk",[]],

  [anyone|plyr,"village_elder_talk",
   [
	(neg|eq, "$g_talk_troop", "trp_village_66_elder"),
     ],
   "Have you seen any enemies around here recently?", "village_elder_ask_enemies",[]],

  [anyone,"village_elder_ask_enemies",
   [
     (assign, ":give_report", 0),
     (party_get_slot, ":original_faction", "$g_encountered_party", slot_center_original_faction),
     (store_relation, ":original_faction_relation", ":original_faction", "fac_player_supporters_faction"),
     (try_begin),
       (gt, ":original_faction_relation", 0),
       (party_slot_ge, "$g_encountered_party", slot_center_player_relation, 0),
       (assign, ":give_report", 1),
     (else_try),
       (party_slot_ge, "$g_encountered_party", slot_center_player_relation, 30),
       (assign, ":give_report", 1),
     (try_end),
     (eq, ":give_report", 0),
     ],
   "I am sorry, {sir/madam}. We have neither seen nor heard of any war parties in this area.", "village_elder_pretalk",
   []],

  [anyone,"village_elder_ask_enemies",
   [],
   "Hmm. Let me think about it...", "village_elder_tell_enemies",
   [
     (assign, "$temp", 0),
     ]],

  #village_elder_talk	 
  #mayor_talk
  [anyone|plyr,"village_elder_talk", [
	(faction_slot_eq, "$players_kingdom", slot_faction_leader, "trp_player"), 
	(eq, "$g_encountered_party_faction", "$players_kingdom"), 
	(party_slot_ge, "$current_town", slot_town_lord, "trp_player"),
	(neg|party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
  ], "I think it's time to change the leadership here.", "oim_change_ruler_village",[]],
	[anyone,"oim_change_ruler_village", [], "Are you sure, my {lord/lady}?", "oim_change_ruler_village_goon",[]],
		[anyone|plyr,"oim_change_ruler_village_goon", [], "Yes, that is my will.", "village_elder_pretalk",[
			(party_get_slot, ":lord", "$current_town", slot_town_lord),
			(call_script, "script_change_player_relation_with_troop", ":lord", -20),
			(call_script, "script_change_player_relation_with_center", "$current_town", -5),
			(call_script, "script_give_center_to_lord", "$current_town", "trp_player", 0),
		]],
		[anyone|plyr,"oim_change_ruler_village_goon", [], "Never mind.", "village_elder_pretalk",[]],

  [anyone|plyr,"mayor_talk", [
	(faction_slot_eq, "$players_kingdom", slot_faction_leader, "trp_player"), 
	(eq, "$g_encountered_party_faction", "$players_kingdom"), 
	(party_slot_ge, "$current_town", slot_town_lord, "trp_player"),
	(neg|party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
  ], "I think it's time to change the leadership here.", "oim_change_ruler_town",[]],
	[anyone,"oim_change_ruler_town", [], "Are you sure, my {lord/lady}?", "oim_change_ruler_town_goon",[]],
		[anyone|plyr,"oim_change_ruler_town_goon", [], "Yes, that is my will.", "mayor_pretalk",[
			(party_get_slot, ":lord", "$current_town", slot_town_lord),
			(call_script, "script_change_player_relation_with_troop", ":lord", -40),
			(call_script, "script_change_player_relation_with_center", "$current_town", -5),
			(call_script, "script_give_center_to_lord", "$current_town", "trp_player", 0),
		]],
		[anyone|plyr,"oim_change_ruler_town_goon", [], "Never mind.", "mayor_pretalk",[]],
		
  		

  [anyone,"village_elder_tell_enemies",
   [
     (assign, ":target_hero_index", "$temp"),
     (assign, ":end_cond", kingdom_heroes_end),
     (try_for_range, ":cur_troop", kingdom_heroes_begin, ":end_cond"),
       (troop_get_slot, ":cur_party", ":cur_troop", slot_troop_leaded_party),
       (gt, ":cur_party", 0),
       (store_troop_faction, ":cur_faction", ":cur_troop"),
       (store_relation, ":reln", ":cur_faction", "fac_player_supporters_faction"),
       (lt, ":reln", 0),
       (store_distance_to_party_from_party, ":dist", "$g_encountered_party", ":cur_party"),
       (lt, ":dist", 10),
       (call_script, "script_get_information_about_troops_position", ":cur_troop", 0),
       (eq, reg0, 1), #Troop's location is known.
       (val_sub, ":target_hero_index", 1),
       (lt, ":target_hero_index", 0),
       (assign, ":end_cond", 0),
       (str_store_string, s2, "@He is not commanding any men at the moment."),
       (assign, ":num_troops", 0),
       (assign, ":num_wounded_troops", 0),
       (party_get_num_companion_stacks, ":num_stacks", ":cur_party"),
       (try_for_range_backwards, ":i_stack", 0, ":num_stacks"),
         (party_stack_get_troop_id, ":stack_troop", ":cur_party", ":i_stack"),
         (neg|troop_is_hero, ":stack_troop"),
         (party_stack_get_size, ":stack_size", ":cur_party", ":i_stack"),
         (party_stack_get_num_wounded, ":num_wounded", ":cur_party", ":i_stack"),
         (val_add, ":num_troops", ":stack_size"),
         (val_add, ":num_wounded_troops", ":num_wounded"),
       (try_end),
       (gt, ":num_troops", 0),
       (call_script, "script_round_value", ":num_wounded_troops"),
       (assign, reg1, reg0),
       (call_script, "script_round_value", ":num_troops"),
       (str_store_string, s2, "@He currently commands {reg0} men{reg1?, of which around {reg1} are wounded:}."),
     (try_end),
     (eq, ":end_cond", 0),
     ],
   "{s1} {s2}", "village_elder_tell_enemies",
   [
     (val_add, "$temp", 1),
     ]],

  [anyone,"village_elder_tell_enemies",
   [(eq, "$temp", 0)],
   "No, {sir/madam}. We haven't seen any war parties in this area for some time.", "village_elder_pretalk",
   []],

  [anyone,"village_elder_tell_enemies",
   [],
   "Well, I suppose that is all.", "village_elder_pretalk",
   []],


  [anyone|plyr,"village_elder_talk", 
  [    
    (call_script, "script_cf_village_recruit_volunteers_cond"),
  ],
   "Are there any lads from this village who might like to seek their fortune in the wars?", "village_elder_recruit_start",[]],

   

	[anyone|plyr,"village_elder_talk", [
	        (quest_slot_eq, "qst_oim_hunt_down_thieves", slot_quest_target_center, "$current_town"),
			(check_quest_active,"qst_oim_hunt_down_thieves"),
			(check_quest_failed,"qst_oim_hunt_down_thieves"),
			(neg|check_quest_finished,"qst_oim_hunt_down_thieves"),
			(is_between,"$g_talk_troop",village_elders_begin,village_elders_end),
	],  "I want to talk about the thieves you wanted me to catch.", "oim_hunt_down_thieves_failed",[]],

  [anyone,"oim_hunt_down_thieves_failed", [],
   "I see you are wounded. What happened?", "oim_hunt_down_thieves_failed_2",[]],

  [anyone|plyr,"oim_hunt_down_thieves_failed_2", [],
   "I saw the thieves when I entered the village at midnight and I tried to stop them. But alas, they were too powerful for me. I am sorry.", "oim_hunt_down_thieves_failed_3",[]],

  [anyone,"oim_hunt_down_thieves_failed_3", [],
   "This is very bad news indeed. We were hoping you would help. Well, at least you tried.", "village_elder_pretalk",
   [
     (call_script, "script_end_quest", "qst_oim_hunt_down_thieves"),
	 (call_script, "script_change_player_relation_with_center", "$current_town", -5),
     (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -5),
   ]],



  [anyone|plyr,"village_elder_talk", [
	        (quest_slot_eq, "qst_oim_get_feast_supplies", slot_quest_target_center, "$current_town"),
			(check_quest_active,"qst_oim_get_feast_supplies"),			
			(neg|check_quest_finished,"qst_oim_get_feast_supplies"),
			(is_between,"$g_talk_troop",village_elders_begin,village_elders_end),
	],  "I've brought the goods you wanted. You can start the feast now.", "oim_get_feast_supplies_finish",[]],

  [anyone,"oim_get_feast_supplies_finish", 
  [
    (store_item_kind_count, ":item_count", "itm_ale"),
	(ge, ":item_count", 5),
    (store_item_kind_count, ":item_count", "itm_raw_grapes"),
	(ge, ":item_count", 5),
    (store_item_kind_count, ":item_count", "itm_oim_alcohol"),
	(ge, ":item_count", 1),
    (store_item_kind_count, ":item_count", "itm_wine"),
	(ge, ":item_count", 1),
    (store_item_kind_count, ":item_count", "itm_oim_tutun"),
	(ge, ":item_count", 1),
  ],  
   "Great! I can see you collected all the goods we need for the feast. Now, our people will have a good time and forget their worries for a few short days. We are grateful to you. We've also prepared a reward. Here, please accept this.", "oim_get_feast_supplies_succeeded",[]],

  [anyone,"oim_get_feast_supplies_finish", 
  [
    (assign, ":missing_goods", 0),
    (try_begin),
      (store_item_kind_count, ":item_count", "itm_ale"),
	  (lt, ":item_count", 10),
	  (str_store_item_name, s1, "itm_ale"),
	  (val_add, ":missing_goods", 1),
    (try_end),

    (try_begin),
      (store_item_kind_count, ":ale_count", "itm_ale"),
	  (store_item_kind_count, ":grape_count", "itm_raw_grapes"),
	  (store_item_kind_count, ":oim_alcohol_count", "itm_oim_alcohol"),
	  (store_item_kind_count, ":wine_count", "itm_wine"),
	  (store_item_kind_count, ":oim_tutun_count", "itm_oim_tutun"),

	  (assign, ":missing_goods", 0),
	  (try_begin),
	    (lt, ":ale_count", 5),
	    (str_store_item_name, s1, "itm_ale"),
		(val_add, ":missing_goods", 1),
	  (try_end),

	  (try_begin),
	    (lt, ":grape_count", 5),
        (assign, reg2, ":missing_goods"),
		(str_store_item_name, s2, "itm_raw_grapes"),
	    (try_begin),
	      (this_or_next|lt, ":oim_alcohol_count", 1),
		  (this_or_next|lt, ":wine_count", 1),
		  (lt, ":oim_tutun_count", 1),
		  (str_store_string, s1, "str_reg2_s1_s2_s2"),
	    (else_try),
		  (str_store_string, s1, "str_reg2_s1_and_s2_s2"),  
        (try_end),
	    (val_add, ":missing_goods", 1),
	  (try_end),

	  (try_begin),
	    (lt, ":oim_alcohol_count", 1),
        (assign, reg2, ":missing_goods"),
		(str_store_item_name, s2, "itm_oim_alcohol"),
	    (try_begin),
		  (this_or_next|lt, ":wine_count", 1),
		  (lt, ":oim_tutun_count", 1),
	      (str_store_string, s1, "str_reg2_s1_s2_s2"),
	    (else_try),
	      (str_store_string, s1, "str_reg2_s1_and_s2_s2"),
        (try_end),
	    (val_add, ":missing_goods", 1),
	  (try_end),

	  (try_begin),
	    (lt, ":wine_count", 1),
        (assign, reg2, ":missing_goods"),
		(str_store_item_name, s2, "itm_wine"),
	    (try_begin),
		  (lt, ":oim_tutun_count", 1),
	      (str_store_string, s1, "str_reg2_s1_s2_s2"),
	    (else_try),
	      (str_store_string, s1, "str_reg2_s1_and_s2_s2"),
        (try_end),
	    (val_add, ":missing_goods", 1),
	  (try_end),

	  (try_begin),
	    (lt, ":oim_tutun_count", 1),
        (assign, reg2, ":missing_goods"),
		(str_store_item_name, s2, "itm_oim_tutun"),
        (str_store_string, s1, "str_reg2_s1_and_s2_s2"),
	    (val_add, ":missing_goods", 1),
	  (try_end),
    (try_end),
  ],  
   "Unfortunately you do not have enough {s1} with you, so we'll not be able to start the feast.", "village_elder_pretalk",[]],

  [anyone|plyr,"oim_get_feast_supplies_succeeded", 
  [    
    (try_for_range, ":cur_good", trade_goods_begin, trade_goods_end),
      (store_sub, ":cur_good_slot", ":cur_good", trade_goods_begin),
      (val_add, ":cur_good_slot", slot_town_trade_good_productions_begin),
      (party_get_slot, ":production", "$g_encountered_party", ":cur_good_slot"),
      (ge, ":production", 18),

	  #twice for this quest - it's harder...
	  (troop_add_item, "trp_player", ":cur_good"),
	  (troop_add_item, "trp_player", ":cur_good"),
    (try_end),

    (add_xp_as_reward, 200),

	(call_script, "script_troop_add_gold", "trp_player", 500),

	(call_script, "script_change_player_party_morale", 20),

	(call_script, "script_change_player_relation_with_center", "$current_town", 10),

	(troop_remove_items, "trp_player", "itm_raw_grapes", 5),
	(troop_remove_items, "trp_player", "itm_ale", 5),
	(troop_remove_items, "trp_player", "itm_oim_alcohol", 1),
	(troop_remove_items, "trp_player", "itm_wine", 1),
	(troop_remove_items, "trp_player", "itm_oim_tutun", 1),

	(unlock_achievement, ACHIEVEMENT_SUMMER_FEST),
	
	(call_script, "script_end_quest", "qst_oim_get_feast_supplies"),
  ],
   "Thank you for the reward. I am happy I was of help.", "village_elder_pretalk",[]],



  [anyone|plyr,"village_elder_talk", [],
   "Leave...", "close_window",[]],

  [anyone ,"village_elder_buy_cattle", [(party_get_slot, reg5, "$g_encountered_party", slot_village_number_of_cattle),
                                        (gt, reg5, 0),
                                        (store_item_value, ":cattle_cost", "itm_cattle_meat"),
                                        (call_script, "script_game_get_item_buy_price_factor", "itm_cattle_meat"),
                                        (val_mul, ":cattle_cost", reg0),
                                        #Multiplied by 2 and divided by 100
                                        (val_div, ":cattle_cost", 50),
                                        (assign, "$temp", ":cattle_cost"),
                                        (assign, reg6, ":cattle_cost"),
                                        ],
   "We have {reg5} head of cattle, each for {reg6} thaler. How many do you want to buy?", "village_elder_buy_cattle_2",[]],

  [anyone ,"village_elder_buy_cattle", [],
   "I am afraid we have no cattle left in the village {sir/madam}.", "village_elder_buy_cattle_2",[]],


  [anyone|plyr,"village_elder_buy_cattle_2", [(party_get_slot, ":num_cattle", "$g_encountered_party", slot_village_number_of_cattle),
                                              (ge, ":num_cattle", 1),
                                              (store_troop_gold, ":gold", "trp_player"),
                                              (ge, ":gold", "$temp"),],
   "One.", "village_elder_buy_cattle_complete",[(call_script, "script_buy_cattle_from_village", "$g_encountered_party", 1, "$temp"),
                                                       ]],
  
  [anyone|plyr,"village_elder_buy_cattle_2", [(party_get_slot, ":num_cattle", "$g_encountered_party", slot_village_number_of_cattle),
                                              (ge, ":num_cattle", 2),
                                              (store_troop_gold, ":gold", "trp_player"),
                                              (store_mul, ":cost", "$temp", 2),
                                              (ge, ":gold", ":cost"),],
   "Two.", "village_elder_buy_cattle_complete",[(call_script, "script_buy_cattle_from_village", "$g_encountered_party", 2, "$temp"),
                                                       ]],
  
  [anyone|plyr,"village_elder_buy_cattle_2", [(party_get_slot, ":num_cattle", "$g_encountered_party", slot_village_number_of_cattle),
                                              (ge, ":num_cattle", 3),
                                              (store_troop_gold, ":gold", "trp_player"),
                                              (store_mul, ":cost", "$temp", 3),
                                              (ge, ":gold", ":cost"),],
   "Three.", "village_elder_buy_cattle_complete",[(call_script, "script_buy_cattle_from_village", "$g_encountered_party", 3, "$temp"),
                                                       ]],
  
  [anyone|plyr,"village_elder_buy_cattle_2", [(party_get_slot, ":num_cattle", "$g_encountered_party", slot_village_number_of_cattle),
                                              (ge, ":num_cattle", 4),
                                              (store_troop_gold, ":gold", "trp_player"),
                                              (store_mul, ":cost", "$temp", 4),
                                              (ge, ":gold", ":cost"),],
   "Four.", "village_elder_buy_cattle_complete",[(call_script, "script_buy_cattle_from_village", "$g_encountered_party", 4, "$temp"),
                                                       ]],
  
  [anyone|plyr,"village_elder_buy_cattle_2", [(party_get_slot, ":num_cattle", "$g_encountered_party", slot_village_number_of_cattle),
                                              (ge, ":num_cattle", 5),
                                              (store_troop_gold, ":gold", "trp_player"),
                                              (store_mul, ":cost", "$temp", 5),
                                              (ge, ":gold", ":cost"),],
   "Five.", "village_elder_buy_cattle_complete",[(call_script, "script_buy_cattle_from_village", "$g_encountered_party", 5, "$temp"),
                                                       ]],
  
  [anyone|plyr,"village_elder_buy_cattle_2", [],
   "On second thought, I don't need any cattle.", "village_elder_pretalk",[]],

  [anyone ,"village_elder_buy_cattle_complete", [],
   "I will tell the herders to round up the animals and bring them to you, {sir/madam}. I am sure you will approve of the animals.", "village_elder_pretalk",[]],


  [anyone ,"village_elder_recruit_start", [(party_slot_eq, "$current_town", slot_center_volunteer_troop_amount, 0)],
   "I don't think there is anyone here who would be interested, {sir/madam}. Is there anything else I can do for you?", "village_elder_talk",[]],
  
  [anyone ,"village_elder_recruit_start", [(party_get_slot, ":num_volunteers", "$current_town", slot_center_volunteer_troop_amount),
                                           (party_get_free_companions_capacity, ":free_capacity", "p_main_party"),
                                           (val_min, ":num_volunteers", ":free_capacity"),
                                           (assign, "$temp",  ":num_volunteers"),
                                           (assign, reg5, ":num_volunteers"),
                                           (store_add, reg7, ":num_volunteers", -1),
                                           ],
   "I can think of {reg5} who I suspect would jump at the chance -- if you could pay 10 thaler {reg7?each for their equipment:for his equipment}. Does that suit you?", "village_elder_recruit_decision",[]],

  [anyone|plyr,"village_elder_recruit_decision", [(party_slot_eq, "$current_town", slot_center_volunteer_troop_amount, 0)],
   "So be it.", "village_elder_pretalk",[(party_set_slot, "$current_town", slot_center_volunteer_troop_amount, -1),]],

  [anyone|plyr,"village_elder_recruit_decision", [(assign, ":num_volunteers", "$temp"),
                                                  (ge, ":num_volunteers", 1),
                                                  (store_add, reg7, ":num_volunteers", -1)],
   "Tell {reg7?them:him} I am ready.", "village_elder_pretalk",[(call_script, "script_village_recruit_volunteers_recruit"),]],

  [anyone|plyr,"village_elder_recruit_decision", [(party_slot_ge, "$current_town", slot_center_volunteer_troop_amount, 1)],
   "No, not now.", "village_elder_pretalk",[]],

  [anyone,"village_elder_active_mission_1", [], "Yes {sir/madam}, have you made any progress on it?", "village_elder_active_mission_2",[]],

  [anyone|plyr,"village_elder_active_mission_2",[(store_partner_quest,":elder_quest"),
                                                 (eq, ":elder_quest", "qst_deliver_grain"),
                                                 (quest_get_slot, ":quest_target_amount", "qst_deliver_grain", slot_quest_target_amount),
                                                 (call_script, "script_get_troop_item_amount", "trp_player", "itm_grain"),
                                                 (assign, ":cur_amount", reg0),
                                                 (ge, ":cur_amount", ":quest_target_amount"),
                                                 (assign, reg5, ":quest_target_amount"),
                                                 ],
   "Indeed. I brought you {reg5} packs of wheat.", "village_elder_deliver_grain_thank",
   []],

  [anyone,"village_elder_deliver_grain_thank", [(str_store_party_name, s13, "$current_town")],
   "My good {lord/lady}. You have saved us from hunger and desperation. We cannot thank you enough -- but you'll always be in our prayers. The village of {s13} will not forget what you have done for us.", "village_elder_deliver_grain_thank_2",
   [(quest_get_slot, ":quest_target_amount", "qst_deliver_grain", slot_quest_target_amount),
    (troop_remove_items, "trp_player", "itm_grain", ":quest_target_amount"),
    (add_xp_as_reward, 400),	
    (call_script, "script_change_center_prosperity", "$current_town", 4),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
    (call_script, "script_end_quest", "qst_deliver_grain"),
#Troop commentaries begin
    (call_script, "script_add_log_entry", logent_helped_peasants, "trp_player",  "$current_town", -1, -1),
#Troop commentaries end
   ]],

  [anyone,"village_elder_deliver_grain_thank_2", [],
   "My good {lord/lady}, please, is there anything I can do for you?", "village_elder_talk",[]],


  [anyone|plyr,"village_elder_active_mission_2", [], "I am still working on it.", "village_elder_active_mission_3",[]],
  [anyone|plyr,"village_elder_active_mission_2", [], "I am afraid I won't be able to finish it.", "village_elder_mission_failed",[]],
                                                                                                                                                   
  [anyone,"village_elder_active_mission_3", [], "Thank you, {sir/madam}. We pray for your success every day.", "village_elder_pretalk",[]],

  [anyone,"village_elder_mission_failed", [], "Ah, I am sorry to hear that {sir/madam}. Worry not -- we'll find another way.", "village_elder_pretalk",
   [(store_partner_quest,":elder_quest"),
    (call_script, "script_abort_quest", ":elder_quest", 1)]],
##
##  [anyone,"village_elder_generic_mission_thank", [],
##   "You have been so helpful {sir/madam}. I do not know how to thank you.", "village_elder_generic_mission_completed",[]],
##
##  [anyone|plyr,"village_elder_generic_mission_completed", [],
##   "Speak not of it. I only did what needed to be done.", "village_elder_pretalk",[]],

# Currently not needed.
##  [anyone|plyr,"village_elder_generic_mission_failed", [],
##   "TODO: I'm sorry I failed you sir. It won't happen again.", "village_elder_pretalk",
##   [(store_partner_quest,":elder_quest"),
##    (call_script, "script_finish_quest", ":elder_quest", 0),
##    ]],


  [anyone,"village_elder_request_mission_ask", [(store_partner_quest,":elder_quest"),(ge,":elder_quest",0)],
   "Nay, {sir/madam}, you are already engaged in a task helping us. We could not ask yet more of you.", "village_elder_pretalk",[]],

  [anyone,"village_elder_request_mission_ask", [(troop_slot_eq, "$g_talk_troop", slot_troop_does_not_give_quest, 1)],
   "No {sir/madam}, We don't have any other tasks for you.", "village_elder_pretalk",[]],
  
  [anyone|auto_proceed,"village_elder_request_mission_ask", [], "A task?", "village_elder_tell_mission",
   [
       (call_script, "script_get_random_quest", "$g_talk_troop"),
       (assign, "$random_quest_no", reg0),	   
   ]],

  [anyone,"village_elder_tell_mission", [(eq,"$random_quest_no","qst_deliver_grain")],
   "{My good sir/My good lady}, our village has undergone such hardships of late. The harvest was poor, and recently some merciless bandits even took away our seed grain -- the seed that we had reserved for the next planting season. If we cannot find some grain soon, we will not be able to plant our fields, and then we will have nothing to eat for the coming year. If you can help us, we would be forever in your debt.", "village_elder_tell_deliver_grain_mission",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_party_name_link,s3,":quest_target_center"),
     (quest_get_slot, reg5, "$random_quest_no", slot_quest_target_amount),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@The elder of the village of {s3} asked you to bring them {reg5} packs of wheat."),
   ]],

  [anyone|plyr,"village_elder_tell_deliver_grain_mission", [],
   "Hmmm. How much grain do you need?", "village_elder_tell_deliver_grain_mission_2",[]],
  [anyone|plyr,"village_elder_tell_deliver_grain_mission", [],
   "I can't be bothered with this.", "village_elder_deliver_grain_mission_reject",[]],
  
  [anyone,"village_elder_tell_deliver_grain_mission_2", [(quest_get_slot, reg5, "$random_quest_no", slot_quest_target_amount)],
   "We could start the planting with {reg5} packs of wheat. Hopefully our neighbors will be charitable and help us with the rest.", "village_elder_tell_deliver_grain_mission_3",[]],
  
  [anyone|plyr,"village_elder_tell_deliver_grain_mission_3", [],
   "Then I will go and find you the wheat you need.", "village_elder_deliver_grain_mission_accept",[]],
  [anyone|plyr,"village_elder_tell_deliver_grain_mission_3", [],
   "I am afraid I don't have time for this.", "village_elder_deliver_grain_mission_reject",[]],

  [anyone,"village_elder_deliver_grain_mission_accept", [], "Thank you, {sir/madam}. We'll be praying for you night and day.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],
  
  [anyone,"village_elder_deliver_grain_mission_reject", [], "Yes {sir/madam}, of course. I am sorry if I have bothered you with our troubles.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],

  [anyone,"village_elder_tell_mission", [(eq,"$random_quest_no", "qst_train_peasants_against_bandits")],
   "We are suffering greatly at the hands of a group of bandits. They take our food and livestock, and kill anyone who would stand against them. Our men are furious that we cannot defend ourselves -- but we are only simple farmers... However, with some help and training, I think that some of our people here might be able to stand against them. We just need an experienced warrior to teach us how to fight.",
   "village_elder_tell_train_peasants_against_bandits_mission",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_party_name_link, s13, ":quest_target_center"),
     (quest_get_slot, reg5, "$random_quest_no", slot_quest_target_amount),
     (setup_quest_text, "$random_quest_no"),
     (str_store_string, s2, "@The elder of the village of {s13} asked you to train {reg5} peasants to fight against local bandits."),
   ]],

  [anyone|plyr, "village_elder_tell_train_peasants_against_bandits_mission", [],
   "I can teach you how to defend yourselves.", "village_elder_train_peasants_against_bandits_mission_accept",[]],
  [anyone|plyr, "village_elder_tell_train_peasants_against_bandits_mission", [],
   "You peasants have no business taking up arms. Just pay the bandits and be done with it.", "village_elder_train_peasants_against_bandits_mission_reject",[]],
  
  [anyone,"village_elder_train_peasants_against_bandits_mission_accept", [], "You will? Oh, splendid! We will be greatly in your debt, {sir/madam}. I'll instruct the men of the village to assemble here and receive your training. If you can teach us how to defend ourselves, I promise you'll receive everything we can give in return for your efforts.", "close_window",
   [
     (assign, "$g_leave_encounter",1),
     #TODO: Change this value
     (call_script, "script_change_player_relation_with_center", "$current_town", 3),
     (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
     ]],
  
  [anyone,"village_elder_train_peasants_against_bandits_mission_reject", [], "Yes, of course {sir/madam}.", "close_window",
   [
     (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
     ]],

  [anyone,"village_elder_tell_mission", [(eq,"$random_quest_no","qst_deliver_cattle")],
   "Bandits have driven away our cattle, and our pastures are empty. If we had but a few head of cattle, we could start to raise a new herd.",
   "village_elder_tell_deliver_cattle_mission",
   [
     (quest_get_slot, ":quest_target_center", "$random_quest_no", slot_quest_target_center),
     (str_store_party_name_link,s3,":quest_target_center"),
     (quest_get_slot, reg5, "$random_quest_no", slot_quest_target_amount),
     (setup_quest_text,"$random_quest_no"),
     (str_store_string, s2, "@The elder of the village of {s3} asked you to bring them {reg5} heads of cattle."),
   ]],

  [anyone|plyr,"village_elder_tell_deliver_cattle_mission", [],
   "How many animals do you need?", "village_elder_tell_deliver_cattle_mission_2",[]],
  [anyone|plyr,"village_elder_tell_deliver_cattle_mission", [],
   "I don't have the time for this.", "village_elder_deliver_cattle_mission_reject",[]],
  
  [anyone,"village_elder_tell_deliver_cattle_mission_2", [(quest_get_slot, reg5, "$random_quest_no", slot_quest_target_amount)],
   "I think {reg5} heads will suffice for a small herd.", "village_elder_tell_deliver_cattle_mission_3",[]],
  
  [anyone|plyr,"village_elder_tell_deliver_cattle_mission_3", [],
   "Then I shall bring you the cattle you need.", "village_elder_deliver_cattle_mission_accept",[]],
  [anyone|plyr,"village_elder_tell_deliver_cattle_mission_3", [],
   "I am afraid I don't have the time for this.", "village_elder_deliver_cattle_mission_reject",[]],

  [anyone,"village_elder_deliver_cattle_mission_accept", [], "Thank you, {sir/madam}. We'll be praying for you night and day.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 3),
    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],
  
  [anyone,"village_elder_deliver_cattle_mission_reject", [], "Yes {sir/madam}, of course. I am sorry if I have bothered you with our troubles.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],




  [anyone,"village_elder_tell_mission", [(eq,"$random_quest_no","qst_oim_hunt_down_thieves")],
   "A group of cattle thieves are in the area. They come at night and ride away any animals they can lay their hands on. If you think you can stop them, come by tonight and be prepared for a fight.",
   "village_elder_oim_hunt_down_thieves_mission",
   [
     (setup_quest_text,"$random_quest_no"),
	 (str_store_party_name_link, s3, "$g_encountered_party"),
     (str_store_string, s2, "str_oim_hunt_down_thieves_explanation"),
   ]],

  [anyone|plyr,"village_elder_oim_hunt_down_thieves_mission", [],
   "Ok I will be here when night comes.", "village_elder_oim_hunt_down_thieves_mission_accept",[]],
  [anyone|plyr,"village_elder_oim_hunt_down_thieves_mission", [],
   "Sorry. I don't have the time for this.", "village_elder_oim_hunt_down_thieves_mission_reject",[]],

  [anyone,"village_elder_oim_hunt_down_thieves_mission_accept", [], "Thank you, {sir/madam}. I hope you can catch and punish those damn thieves.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 3),
    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],

  [anyone,"village_elder_oim_hunt_down_thieves_mission_reject", [], "Yes {sir/madam}, of course. I am sorry if I have bothered you with our troubles.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],



  [anyone,"village_elder_tell_mission", [(eq,"$random_quest_no","qst_oim_get_feast_supplies")],
   "Our village, like the others in this region holds feasts to celebrate the harvest every summer. This year we want to do the same. Lord knows the folks here need something lift up their spirits in the middle of all this misery and mayhem. If you can find 5 barrels of ale, 5 grapes, 1 barrel of wine, 1 barrel of alcohol and 1 bunch of tobacco, we can start this feast. Can you get these things around villages and towns? And of course you're welcome to join us for the festivities.",
   "village_elder_oim_get_feast_supplies_mission",
   [
     (setup_quest_text,"$random_quest_no"),
	 (str_store_party_name_link, s3, "$g_encountered_party"),
     (str_store_string, s2, "str_oim_get_feast_supplies_explanation"),
   ]],

  [anyone|plyr,"village_elder_oim_get_feast_supplies_mission", [],
   "Ok I will collect them and will be back here again.", "village_elder_oim_get_feast_supplies_mission_accept",[]],
  [anyone|plyr,"village_elder_oim_get_feast_supplies_mission", [],
   "I don't have the time for this.", "village_elder_oim_get_feast_supplies_mission_reject",[]],

  [anyone,"village_elder_oim_get_feast_supplies_mission_accept", [], "Thank you, {sir/madam}. Please be quick, our people are impatient for this year's feast.", "close_window",
   [(assign, "$g_leave_encounter",1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 3),
    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
    ]],

  [anyone,"village_elder_oim_get_feast_supplies_mission_reject", [], "Yes {sir/madam}, of course. I am sorry if I have bothered you with our troubles.", "close_window",
   [(troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
    ]],



  [anyone,"village_elder_tell_mission", [], "Thank you, {sir/madam}, but we do not really need anything right now, thanks be to God.", "village_elder_pretalk",[]],

##  [anyone|plyr,"village_elder_mission_told", [], "TODO: As you wish sir. You can count on me.", "village_elder_mission_accepted",[]],
##  [anyone|plyr,"village_elder_mission_told", [], "TODO: I'm afraid I can't carry out this mission right now, sir.", "village_elder_mission_rejected",[]],
##
##  [anyone,"village_elder_mission_accepted", [], "TODO: Excellent. Do this {playername}. I really have high hopes for you.", "close_window",
##   [(assign, "$g_leave_encounter",1),
##    (try_begin),
##    #TODO: Add quest initializations here
##    (try_end),
##    (call_script, "script_start_quest", "$random_quest_no", "$g_talk_troop"),
##    ]],
  
##  [anyone,"village_elder_mission_rejected", [], "TODO: Is that so? Perhaps you are not up for the task anyway...", "close_window",
##   [(assign, "$g_leave_encounter",1),
##    (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -1),
##    (troop_set_slot, "$g_talk_troop", slot_troop_does_not_give_quest, 1),
##    ]],




#Goods Merchants
  
  [anyone ,"start", [(is_between,"$g_talk_troop",goods_merchants_begin,goods_merchants_end),
                     (party_slot_eq, "$current_town", slot_town_lord, "trp_player")],
   "{My lord/my lady}, you honor my humble shop with your presence.", "goods_merchant_talk",[]],
  [anyone ,"start", [(is_between,"$g_talk_troop",goods_merchants_begin,goods_merchants_end)],
   "Welcome {sir/madam}. What can I do for you?", "goods_merchant_talk",[]],

#  [trp_salt_mine_merchant,"start", [], "Hello.", "goods_merchant_talk",[]],

#  [anyone,"merchant_begin", [], " What can I do for you?", "goods_merchant_talk",[]],

  [anyone,"goods_merchant_pretalk", [], "Anything else?", "goods_merchant_talk",[]],

  [anyone|plyr,"goods_merchant_talk", [], "I want to buy a few items... and perhaps sell some.", "goods_trade_requested",[]],
  [anyone,"goods_trade_requested", [], "Sure, sure... Here, have a look at my stock...", "goods_trade_completed",[[change_screen_trade]]],
  [anyone,"goods_trade_completed", [], "Anything else?", "goods_merchant_talk",[]],

  [anyone|plyr,"goods_merchant_talk", [], "What goods would it be well to buy here, to trade with other towns?", "trade_info_request",[]],

  [anyone|plyr,"goods_merchant_talk", [], "Nothing. Thanks.", "close_window",[]],

  [anyone,"trade_info_request", [], "That kind of information can be best obtained from travelling merchants. If you want, I can send you to the district where foreign merchants stay when they come into town. If you spend some time there and listen to them talk, you can learn a lot about what to buy and where to sell it.", "trade_info_request_2",[]],

  [anyone|plyr,"trade_info_request_2", [], "Then I'll go and spend some time with these merchants.", "close_window",
   [
       (jump_to_menu,"mnu_town_trade_assessment_begin"),
       (finish_mission),
    ]],
  
  [anyone|plyr,"trade_info_request_2", [], "I have no time for this right now.", "goods_merchant_pretalk",[]],
  

#  [anyone|plyr,"goods_merchant_talk", [], "What do caravans buy and sell in this town?", "goods_merchant_town_info",[]],
#  [anyone,"goods_merchant_town_info_completed", [], "Anything else?", "goods_merchant_talk",[]],
  

##  [anyone,"goods_merchant_town_info", [],
##   "TODO: We produce {s1}, and we consume {s2}.", "goods_merchant_town_info_completed",
##   [(call_script, "script_print_productions_above_or_below_50", "$g_encountered_party", 1),
##    (str_store_string_reg, s1, s51),
##    (call_script, "script_print_productions_above_or_below_50", "$g_encountered_party", -1),
##    (str_store_string_reg, s2, s51)]],
##  
##  [anyone,"goods_merchant_town_info", [(store_encountered_party,reg(1)),(eq,reg(1),"p_zendar")],
##"You can buy tools from here at a very good price.\
## The best place to sell them would be Tulga. Heard they pay quite well for tools over there.\
## And next time you come here bring some salt. I will pay well for salt.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [(store_encountered_party,reg(1)),(eq,reg(1),"p_town_1")],
##"Sargoth is famous for its fine linen. Many caravans come here to buy that.\
## I heard you can sell it at Halmar and make a nice profit.\
## And next time you come here bring some iron. I will pay well for iron.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_2"]],
##"I can sell you some smoked fish with a special price.\
## I heard that caravans take smoked fish to Uxkhal and make a good profit.\
## And next time you come here bring some wool. I will pay you well for wool.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_3"]],
##"I can sell you some wine with a special price.\
## I heard that caravans buy wine from here and sell it at Wercheg, making a good profit.\
## And next time you come here, bring some dried meat. I will pay you well for dried meat.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_4"]],
##"I have a stock of oil which I can sell you with a good price.\
## They say they offer a fortune for oil in Rivacheg, so maybe you can sell it there.\
## And next time you come here, bring some furs. I will pay you well for furs.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_5"]],
##"Jelkala is famous for its velvet. Many caravans come here to buy that.\
## They say merchants will buy it at insane prices in Reyvadin, so maybe you can take it there.\
## And next time you come here, bring some pottery. I will pay you well for pottery.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_6"]],
##"We produce some excellent ale here in Praven. Most caravans come here to buy that.\
## They say that the folks at Khudan will sell their right arms for ale, so maybe you can take it there.\
## And next time you come here, bring some spice. I have sold out my stock of spice and I will pay you well for it.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_7"]],
##"We produce mostly wheat here in Uxkhal. I would suggest you buy that.\
## I heard you can sell it with a good profit in Tulga, so maybe you can take it there.\
## And next time you come here, bring some smoked fish. I will pay you well for it.", "goods_merchant_town_info_completed",[]],
##
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_8"]],
##"Most caravans come to Reyvadin to buy wool.\
## I heard that they take it to Tihr where they pay well for wool.\
## And next time you come here, bring some velvet. I will buy it from you at a good price.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_9"]],
##"Most caravans come to Khudan to buy furs.\
## I heard that they take it to Suno where they pay well for it.\
## And next time you come here, bring some ale. I will buy it from you at a good price.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_10"]],
##"Most caravans come to Tulga to buy spice.\
## They say that in Praven they pay well for spice, so you may think of selling it to the mechants there.\
## And next time you come here, bring some wheat. I will buy it from you at a good price.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_11"]],
##"We mine a lot of iron here in Curaw. I would suggest you buy that.\
## I heard you can take it to Sargoth and sell it with a good profit.\
## And next time you come here, bring some dried meat. I will pay you well for it.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_12"]],
##"I can sell you some smoked fish with a special price.\
## I heard that caravans take smoked fish to Uxkhal and make a good profit.\
## And next time you come here bring some wine. I will pay you well for wine.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_13"]],
##"I have a stock of dried meat which I can sell you with a good price.\
## They say they pay very well for dried meat in Veluca, so maybe you can sell it there.\
## And next time you come here, bring some oil. I have sold out my stock of oil and I will pay you well for it.", "goods_merchant_town_info_completed",[]],
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_town_14"]],
##"We produce some good quality pottery here in Halmar. Most caravans come here to buy that.\
## I heard that caravans buy pottery from here and sell it at Jelkala, making a good profit.\
## And next time you come here, bring some linen. I have sold out my stock of linen and I will pay you well for it.", "goods_merchant_town_info_completed",[]],
##
##  [anyone,"goods_merchant_town_info", [[store_encountered_party,reg(1)],[eq,reg(1),"p_salt_mine"]],
##"Heh. Are you joking with me? This is the salt mine. Merchants come here to buy salt.", "goods_merchant_town_info_completed",[]],
##
##  [anyone,"goods_merchant_town_info", [
##                                       (store_encountered_party,reg(9)),
##                                       (party_get_slot,reg(5),reg(9),slot_town_export_good),
##                                       (party_get_slot,reg(6),reg(9),slot_town_import_good),
##                                       (ge,reg(5),1),
##                                       (ge,reg(6),1),
##                                       (str_store_item_name,1,reg(5)),
##                                       (str_store_item_name,2,reg(6)),
##                                       ],
##  "I can sell you some {s1} with a special price.\
##And next time you come here bring some {s2}. I will pay you well for that.", "goods_merchant_town_info_completed",[]],
##
##  [anyone,"goods_merchant_town_info", [
##                                       (store_encountered_party,reg(9)),
##                                       (party_get_slot,reg(5),reg(9),slot_town_export_good),
##                                       (ge,reg(5),1),
##                                       (str_store_item_name,1,reg(5)),
##                                       ],
##  "I can sell you some {s1} with a special price.", "goods_merchant_town_info_completed",[]],
##
##  [anyone,"goods_merchant_town_info", [
##                                       (store_encountered_party,reg(9)),
##                                       (party_get_slot,reg(6),reg(9),slot_town_import_good),
##                                       (ge,reg(6),1),
##                                       (str_store_item_name,2,reg(6)),
##                                       ],
##  "If you have some {s2} with you, I am ready to pay you good money for it.", "goods_merchant_town_info_completed",[]],
##  
##  [anyone,"goods_merchant_town_info", [],
##"Sorry. Caravans hardly ever trade anything here.", "goods_merchant_town_info_completed",[]],






#############################################################################
#### ARENA MASTERS
#############################################################################
  [anyone ,"start", [(store_conversation_troop,reg(1)),
                     (is_between,reg(1),arena_masters_begin,arena_masters_end),
     ],
   "Warning: This line is never displayed. It is just for storing conversation variables.", "close_window",[]],
#  [anyone ,"start", [(store_conversation_troop,reg(1)),
#                     (is_between,reg(1),arena_masters_begin,arena_masters_end),
#                     (eq,"$arena_master_first_talk", 0),
#                     ],
#   "Good day friend. If you came to watch the tournaments you came in vain. There won't be a tournament here anytime soon.", "arena_intro_1",[(assign,"$arena_master_first_talk", 1)]],
#  [anyone|plyr,"arena_intro_1", [], "Tournaments? So they hold the tournaments here...", "arena_intro_2",[]],
#  [anyone,"arena_intro_2", [], "Yes. You should see this place during one of the tournament fights.\
# Everyone from the town and nearby villages comes here. The crowd becomes mad with excitement.\
# Anyway, as I said, there won't be an event here soon, so there isn't much to see.\
# Except, there is an official duel every now and then, and  of course we have melee fights almost every day.", "arena_intro_3",[]],
#  [anyone|plyr,"arena_intro_3", [], "Tell me about the melee fights.", "arena_training_melee_intro",[]],
#  [anyone,"arena_training_melee_intro", [], "The fighters and knights get bored waiting for the next tournament,\
# so they have invented the training melee. It is a simple idea really.\
# Fighters jump into the arena with a weapon. There are no rules, no teams.\
# Everyone beats at each other until there is only fighter left standing.\
# Sounds like fun, eh?", "arena_training_melee_intro_2",[]],
#  [anyone|plyr,"arena_training_melee_intro_2", [(eq, "$arena_reward_asked", 0)], "Is there a reward?", "arena_training_melee_intro_reward",[(assign, "$arena_reward_asked", 1)]],
#  [anyone,"arena_training_melee_intro_reward", [(assign, reg1, arena_tier1_opponents_to_beat),(assign, reg11, arena_tier1_prize),
#      (assign, reg2, arena_tier2_opponents_to_beat),(assign, reg12, arena_tier2_prize),
#      (assign, reg3, arena_tier3_opponents_to_beat),(assign, reg13, arena_tier3_prize),
#      (assign, reg4, arena_tier4_opponents_to_beat),(assign, reg14, arena_tier4_prize),
#      (assign, reg15, arena_grand_prize)
#    ], "There is, actually. Some of the wealthy townsmen offer prizes for those fighters who show great skill in the fights.\
# If you can beat {reg1} opponents before going down, you'll earn {reg11} denars. You'll get {reg12} denars for striking down at least {reg2} opponents,\
# {reg13} denars if you can defeat {reg3} opponents, and {reg14} denars if you can survive long enough to beat {reg4} opponents.\
# If you can manage to be the last {man/fighter} standing, you'll earn the great prize of the fights, {reg15} denars. Sounds good, eh?", "arena_training_melee_intro_2",[(assign, "$arena_tournaments_asked", 1),]],
#  [anyone,"arena_training_melee_explain_reward", [
#      (assign, reg1, arena_tier1_opponents_to_beat),(assign, reg11, arena_tier1_prize),
#      (assign, reg2, arena_tier2_opponents_to_beat),(assign, reg12, arena_tier2_prize),
#      (assign, reg3, arena_tier3_opponents_to_beat),(assign, reg13, arena_tier3_prize),
#      (assign, reg4, arena_tier4_opponents_to_beat),(assign, reg14, arena_tier4_prize),
#      (assign, reg15, arena_grand_prize)
#      ], "Some of the wealthy townsmen offer prizes for those fighters who show great skill in the fights.\
# If you can beat {reg1} opponents before going down, you'll earn {reg11} denars. You'll get {reg12} denars for striking down at least {reg2} opponents,\
# {reg13} denars if you can defeat {reg3} opponents, and {reg14} denars if you can survive long enough to beat {reg4} opponents.\
# If you can manage to be the last {man/fighter} standing, you'll earn the great prize of the fights, {reg15} denars. Sounds good, eh?", "arena_master_melee_pretalk",[]],
#  [anyone|plyr,"arena_training_melee_intro_2", [], "Can I join too?", "arena_training_melee_intro_3",[]],
#  [anyone,"arena_training_melee_intro_3", [], "Ha ha. You would have to be out of your mind not to. Of course. The melee fights are open to all.\
# Actually there is going to be a fight soon. You can go and hop in if you want to.", "arena_master_melee_talk",[]],
#
#
#  [anyone ,"start", [(store_conversation_troop,reg(1)),
#                     (is_between,reg(1),arena_masters_begin,arena_masters_end),
#                     (eq,"$g_talk_troop_met", 0),
#                     ],
#   "Hello. You seem to be new here. Care to share your name?", "arena_master_intro_1",[]],
#  [anyone|plyr,"arena_master_intro_1", [], "I am {playername}.", "arena_master_intro_2",[]],
#  [anyone,"arena_master_intro_2", [(store_encountered_party,reg(2)),(str_store_party_name,1,reg(2))],
#   "Well met {playername}. I am the master of the tournaments here at {s1}. Talk to me if you want to join the fights.", "arena_master_pre_talk",[]],
#
#
#  [anyone|auto_proceed ,"start", [(store_conversation_troop,reg(1)),(is_between,reg(1),arena_masters_begin,arena_masters_end),
#                     (eq, "$last_training_fight_town", "$current_town"),
#                     (store_current_hours,":cur_hours"),
#                     (val_add, ":cur_hours", -4),
#                     (lt, ":cur_hours", "$training_fight_time")],
#   ".", "arena_master_fight_result",[(assign, "$arena_reward_asked", 0)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (eq, "$g_arena_training_kills", 0)
#     ],
#   "Ha-ha, that's quite the bruise you're sporting. But don't worry; everybody gets trounced once in awhile. The important thing is to pick yourself up, dust yourself off and keep fighting. That's what champions do.", "arena_master_pre_talk",[(assign, "$last_training_fight_town", -1)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (lt, "$g_arena_training_kills", arena_tier1_opponents_to_beat),
#     (assign, reg8, "$g_arena_training_kills")
#     ],
#   "Hey, you managed to take down {reg8} opponents. Not bad. But that won't bring you any prize money.\
# Now, if I were you, I would go back there and show everyone what I can do...", "arena_master_pre_talk",[(assign, "$last_training_fight_town", -1)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (lt, "$g_arena_training_kills", arena_tier2_opponents_to_beat),
#     (assign, reg8, "$g_arena_training_kills"),
#     (assign, reg10, arena_tier1_prize),
#     ],
#   "You put up quite a good fight there. Good moves. You definitely show promise.\
# And you earned a prize of {reg10} denars for knocking down {reg8} opponents.", "arena_master_pre_talk",[
#     (call_script, "script_troop_add_gold", "trp_player",arena_tier1_prize),
#     (add_xp_to_troop,5,"trp_player"),
#     (assign, "$last_training_fight_town", -1)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (lt, "$g_arena_training_kills", arena_tier3_opponents_to_beat),
#     (assign, reg8, "$g_arena_training_kills"),
#     (assign, reg10, arena_tier2_prize),
#     (assign, reg12, arena_tier2_opponents_to_beat),
#     ],
#   "That was a good fight you put up there. You managed to take down no less than {reg8} opponents.\
# And of course, you earned a prize money of {reg10} denars.", "arena_master_pre_talk",[
#     (call_script, "script_troop_add_gold", "trp_player",arena_tier2_prize),
#     (add_xp_to_troop,10,"trp_player"),
#     (assign, "$last_training_fight_town", -1)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (lt, "$g_arena_training_kills", arena_tier4_opponents_to_beat),
#     (assign, reg8, "$g_arena_training_kills"),
#     (assign, reg10, arena_tier3_prize)
#     ],
#   "Your performance was amazing! You are without doubt a very skilled fighter.\
# Not everyone can knock down {reg8} people in the fights. Of course you deserve a prize with that performance: {reg10} denars. Nice, eh?", "arena_master_pre_talk",[
#     (call_script, "script_troop_add_gold", "trp_player",arena_tier3_prize),
#     (add_xp_to_troop,10,"trp_player"),
#     (assign, "$last_training_fight_town", -1)]],
#
#  [anyone ,"arena_master_fight_result",
#   [
#     (eq, "$g_arena_training_won", 0),
#     (assign, reg8, "$g_arena_training_kills"),
#     (assign, reg10, arena_tier4_prize),
#     ],
#   "That was damned good fighting, {playername}. You have very good moves, excellent tactics.\
# And you earned a prize of {reg10} denars for knocking down {reg8} opponents.", "arena_master_pre_talk",
#   [
#     (call_script, "script_troop_add_gold", "trp_player",arena_tier4_prize),
#     (add_xp_to_troop,10,"trp_player"),
#     (assign, "$last_training_fight_town", -1),
#     ]],
#
#  [anyone ,"arena_master_fight_result", [(assign, reg10, arena_grand_prize)],
#   "Congratulations champion! Your fight there was something to remember! You managed to be the last fighter standing beating down everyone else. And of course you won the grand prize of the fights: {reg10} denars.", "arena_master_pre_talk",[
#     (call_script, "script_troop_add_gold", "trp_player",arena_grand_prize),
#     (add_xp_to_troop,200,"trp_player"),
#     (assign, "$last_training_fight_town", -1)]],
#
#
#  [anyone ,"start", [(store_conversation_troop,reg(1)),(is_between,reg(1),arena_masters_begin,arena_masters_end)],
#   "Hello {playername}. Good to see you again.", "arena_master_pre_talk",[(assign, "$arena_reward_asked", 0)]],
#  
#
#  [anyone,"arena_master_pre_talk", [], "What would you like to do?", "arena_master_talk",[]],
#
#
##  [anyone|plyr,"arena_master_talk", [], "About the arena fights...", "arena_master_melee",[]],
#  [anyone|plyr,"arena_master_talk", [], "About the melee fights...", "arena_master_melee_pretalk",[]],
#  [anyone|plyr,"arena_master_talk", [(eq, "$arena_tournaments_asked", 0)], "Will there be a tournament in nearby towns soon?", "arena_master_ask_tournaments",[(assign, "$arena_tournaments_asked", 1)]],
#  [anyone|plyr,"arena_master_talk", [], "I need to leave now. Good bye.", "close_window",[]],
#
#  [anyone,"arena_master_ask_tournaments", [], "{reg2?There won't be any tournaments any time soon.:{reg1?Tournaments are:A tournament is} going to be held at {s15}.}", "arena_master_talk",
#   [
#       (assign, ":num_tournaments", 0),
#       (try_for_range_backwards, ":town_no", towns_begin, towns_end),
#         (party_slot_ge, ":town_no", slot_town_has_tournament, 1),
#         (val_add, ":num_tournaments", 1),
#         (try_begin),
#           (eq, ":num_tournaments", 1),
#           (str_store_party_name, s15, ":town_no"),
#         (else_try),
#           (str_store_party_name, s16, ":town_no"),
#           (eq, ":num_tournaments", 2),
#           (str_store_string, s15, "@{s16} and {s15}"),
#         (else_try),
#           (str_store_string, s15, "@{s16}, {s15}"),
#         (try_end),
#       (try_end),
#       (try_begin),
#         (eq, ":num_tournaments", 0),
#         (assign, reg2, 1),
#       (else_try),
#         (assign, reg2, 0),
#         (store_sub, reg1, ":num_tournaments", 1),
#       (try_end),
#   ]],
#
#  [anyone,"arena_master_melee_pretalk", [], "There will be a fight here soon. You can go and jump in if you like.", "arena_master_melee_talk",[]],
#  [anyone|plyr,"arena_master_melee_talk", [], "Good. That's what I am going to do.", "close_window",
#   [
#    (assign, "$last_training_fight_town", "$current_town"),
#    (store_current_hours,"$training_fight_time"),
#    (assign, "$g_mt_mode", abm_training),
#    (party_get_slot, ":scene","$current_town",slot_town_arena),
#    (modify_visitors_at_site,":scene"),
#    (reset_visitors),
#    (store_random_in_range, "$g_player_entry_point", 32, 40),
#    (set_visitor, "$g_player_entry_point", "trp_player"),
#    (set_jump_mission,"mt_arena_melee_fight"),
#    (jump_to_scene, ":scene"),
#    ]],
#  [anyone|plyr,"arena_master_melee_talk", [], "Thanks. But I will give my bruises some time to heal.", "arena_master_melee_reject",[]],
#  [anyone,"arena_master_melee_reject", [], "Good {man/girl}. That's clever of you.", "arena_master_pre_talk",[]],
#
#  [anyone|plyr,"arena_master_melee_talk", [(eq, "$arena_reward_asked", 0)], "Actually, can you tell me about the rewards again?", "arena_training_melee_explain_reward",[(assign, "$arena_reward_asked", 1)]],
#
#  [anyone,"arena_master_pre_talk",
#   [(eq,"$arena_join_or_watch",1),
#    (ge,"$arena_bet_amount",1),
#    (eq,"$arena_bet_team","$arena_winner_team"),
#    (assign,reg(5),"$arena_win_amount")],
# "You've won the bet, eh? Let me see. The sum you have earned amounts to {reg5} denars. Here you go.", "arena_master_pre_talk",
#   [(call_script, "script_troop_add_gold", "trp_player", "$arena_win_amount"),
#    (assign,"$arena_bet_amount",0),
#    (assign,"$arena_win_amount",0),
#    ]],
  
#  [anyone,"arena_master_pre_talk",
#   [(eq,"$arena_join_or_watch",0),
#    (ge,"$arena_bet_amount",1),
#    (eq,"$arena_fight_won",1),
#    (assign,reg(5),"$arena_win_amount"),
#   ],
# "And you had the good sense to bet on yourself too. Hmm let me see. You have won yourself some {reg5} denars. Here you are.", "arena_master_pre_talk",
#   [(call_script, "script_troop_add_gold", "trp_player", "$arena_win_amount"),
#    (assign,"$arena_bet_amount",0),
#    (assign,"$arena_win_amount",0)]],

#  [anyone,"start", [(store_conversation_troop,reg(1)),(is_between,reg(1),arena_masters_begin,arena_masters_end),(eq,"$waiting_for_arena_fight_result",1),(eq,"$arena_join_or_watch",0),(eq,"$arena_fight_won",1)],
# "Congratulations champion. You made some pretty good moves out there. Here is your share of share of the prize money, 2 denars.", "arena_master_pre_talk",
#   [(assign,"$waiting_for_arena_fight_result",0),(add_xp_to_troop,20,"trp_player"),(call_script, "script_troop_add_gold", "trp_player",2)]],
#  [anyone,"start", [(store_conversation_troop,reg(1)),(is_between,reg(1),arena_masters_begin,arena_masters_end),(eq,"$waiting_for_arena_fight_result",1),(eq,"$arena_join_or_watch",0)],
# "That's quite the bruise you're sporting. But don't worry; everybody gets trounced once in awhile. The important thing is to pick yourself up, dust yourself off and keep fighting. That's what champions do.", "arena_master_pre_talk",[[assign,"$waiting_for_arena_fight_result"]]],
#  [anyone,"start", [(store_conversation_troop,reg(1)),(is_between,reg(1),arena_masters_begin,arena_masters_end),(eq,"$waiting_for_arena_fight_result",1)],
# "That was exciting wasn't it? Nothing like a good fight to get the blood flowing.", "arena_master_pre_talk",[(assign,"$waiting_for_arena_fight_result",0)]],

##  [anyone,"arena_master_melee", [], "The next arena fight will start in a while. Hurry up if you want to take part in it.", "arena_master_melee_talk",[
##    (party_get_slot, ":arena_cur_tier","$current_town",slot_town_arena_melee_cur_tier),
##    (try_begin), #reg3 = num teams, reg4 = team size
##      (eq, ":arena_cur_tier", 0),
##      (party_get_slot, "$_num_teams","$current_town",slot_town_arena_melee_1_num_teams),
##      (party_get_slot, "$_team_size","$current_town",slot_town_arena_melee_1_team_size),
##    (else_try),
##      (eq, ":arena_cur_tier", 1),
##      (party_get_slot, "$_num_teams","$current_town",slot_town_arena_melee_2_num_teams),
##      (party_get_slot, "$_team_size","$current_town",slot_town_arena_melee_2_team_size),
##    (else_try),
##      (party_get_slot, "$_num_teams","$current_town",slot_town_arena_melee_3_num_teams),
##      (party_get_slot, "$_team_size","$current_town",slot_town_arena_melee_3_team_size),
##    (try_end),
##   ]],
##  [anyone|plyr,"arena_master_melee_talk", [], "I want to join the next fight", "arena_master_next_melee_join",[(assign,"$arena_join_or_watch",0)]],
##  [anyone|plyr,"arena_master_melee_talk", [], "I would like to watch the next fight", "arena_master_next_melee_watch",
##   [(assign,"$arena_join_or_watch",1)]],
##  [anyone|plyr,"arena_master_melee_talk", [], "No. perhaps later.", "arena_master_we_will_fight_not",[]],
##  [anyone,"arena_master_we_will_fight_not", [], "Alright. Talk to me when you are ready.", "close_window",[]],
##  [anyone,"arena_master_next_melee_join", [
##    (assign,"$arena_bet_amount"),
##    (assign,"$arena_bet_team",0),
##    (party_get_slot, ":player_odds", "$g_encountered_party", slot_town_player_odds),
##    (store_div, ":divider", ":player_odds", 20),
##    (store_mul, ":odds_simple", ":divider", 20),
##    (val_sub, ":odds_simple", ":player_odds"),
##    (try_begin),
##      (lt, ":odds_simple", 0),
##      (val_add, ":divider", 1),
##    (try_end),
##    (val_max, ":divider", 50),
##    (store_div, ":odds_player", ":player_odds", ":divider"),
##    (store_div, ":odds_other", 1000, ":divider"),
##    (try_for_range, ":unused", 0, 5),
##      (assign, ":last_divider", 21),
##      (try_for_range, ":cur_divider", 2, ":last_divider"),
##        (store_div, ":odds_player_test", ":odds_player", ":cur_divider"),
##        (val_mul, ":odds_player_test", ":cur_divider"),
##        (eq, ":odds_player_test", ":odds_player"),
##        (store_div, ":odds_other_test", ":odds_other", ":cur_divider"),
##        (val_mul, ":odds_other_test", ":cur_divider"),
##        (eq, ":odds_other_test", ":odds_other"),
##        (val_div, ":odds_player", ":cur_divider"),
##        (val_div, ":odds_other", ":cur_divider"),
##        (assign, ":last_divider", 0),
##      (try_end),
##    (try_end),
##    (assign, reg5, ":odds_player"),
##    (assign, reg6, ":odds_other"),], "Do you want to place a bet on yourself? The odds against you are {reg5} to {reg6}.", "arena_master_will_you_bet",
##   []],
##
##  [anyone|plyr,"arena_master_will_you_bet", [], "No.", "arena_master_start_fight",[]],
##  [anyone|plyr,"arena_master_will_you_bet", [(store_troop_gold,reg(0)),(ge,reg(0),10)], "I want to bet 10 denars.",
##   "arena_master_bet_placed",[(assign,"$arena_bet_amount",10),(troop_remove_gold, "trp_player",10)]],
##  [anyone|plyr,"arena_master_will_you_bet", [(store_troop_gold,reg(0)),(ge,reg(0),50)], "I want to bet 50 denars.",
##   "arena_master_bet_placed",[(assign,"$arena_bet_amount",50),(troop_remove_gold, "trp_player",50)]],
##  [anyone|plyr,"arena_master_will_you_bet", [(store_troop_gold,reg(0)),(ge,reg(0),100)], "I want to bet 100 denars.",
##   "arena_master_bet_placed",[(assign,"$arena_bet_amount",100),(troop_remove_gold, "trp_player",100)]],
##  [anyone,"arena_master_next_melee_watch", [], "Do you want to place a bet?", "arena_master_will_you_bet",[]],
##  [anyone,"arena_master_bet_placed", [(eq,"$arena_join_or_watch",1)], "Hmm. That's good. If you win, you'll get {reg5} denars. And which team do you want to place your bet on?", "arena_master_select_team",
##   [(store_mul, "$arena_win_amount", "$arena_bet_amount", "$_num_teams"),
##    (val_mul, "$arena_win_amount", 9),
##    (val_div, "$arena_win_amount", 10),
##    (assign, reg5, "$arena_win_amount"),
##    ]],
##  [anyone|plyr,"arena_master_select_team", [], "The red team. I have a feeling they will win this one.",
##   "arena_master_start_fight",[(assign,"$arena_bet_team",0)]],
##  [anyone|plyr,"arena_master_select_team", [], "The blue team. They will sweep the ground with the reds.",
##   "arena_master_start_fight",[(assign,"$arena_bet_team",1)]],
##  [anyone|plyr,"arena_master_select_team", [(ge,"$_num_teams",3)], "The green team. My money is on them this time.",
##   "arena_master_start_fight",[(assign,"$arena_bet_team",2)]],
##  [anyone|plyr,"arena_master_select_team", [(ge,"$_num_teams",4)], "The yellow team. They will be victorious.",
##   "arena_master_start_fight",[(assign,"$arena_bet_team",3)]],
##  [anyone,"arena_master_bet_placed", [], "That's good. Let me record that. If you win, you'll get {reg5} denars.", "arena_master_start_fight",
##   [(store_mul,"$arena_win_amount", "$arena_bet_amount", "$_num_teams"),
##    (party_get_slot, ":player_odds", "$g_encountered_party", slot_town_player_odds),
##    (val_sub, "$arena_win_amount", "$arena_bet_amount"),
##    (val_mul, "$arena_win_amount", ":player_odds"),
##    (val_div, "$arena_win_amount", 1000),
##    (val_add, "$arena_win_amount", "$arena_bet_amount"),
##    (val_mul, "$arena_win_amount", 9),
##    (val_div, "$arena_win_amount", 10),
##    (assign, reg5, "$arena_win_amount"),
##    ]],
##  
##  [anyone,"arena_master_start_fight", [], "Very well. The fight starts in a moment. Good luck.", "close_window",
##   [
##    (store_encountered_party,"$current_town"),
##    (party_get_slot, ":arena_scene","$current_town",slot_town_arena),
##    (modify_visitors_at_site,":arena_scene"),
##    (reset_visitors),
##
##    #Assemble participants
##    (assign, ":slot_no", 0),
##    (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_xerina"),
##    (val_add, ":slot_no", 1),
##    (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_dranton"),
##    (val_add, ":slot_no", 1),
##    (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_kradus"),
##    (val_add, ":slot_no", 1),
##    (try_for_range, reg(4), 0, 10),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_regular_fighter"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (try_for_range, reg(4), 0, 10),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_veteran_fighter"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (try_for_range, reg(4), 0, 10),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_champion_fighter"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (try_for_range, reg(4), 0, 5),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_sword_sister"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (try_for_range, reg(4), 0, 10),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_hired_blade"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (try_for_range, reg(4), 0, 10),
##      (lt, ":slot_no", 48),
##      (troop_set_slot, "trp_temp_array_a", ":slot_no", "trp_mercenary"),
##      (val_add, ":slot_no", 1),
##    (try_end),
##    (assign, "$pin_troop", "trp_temp_array_a"),
##    (call_script, "script_shuffle_troop_slots", 0, 48),
##    
##    (try_for_range, reg(12), 0, 48),
##      (troop_set_slot, "trp_temp_array_b", reg(12),reg(12)), #Initialize temp_array_b such that temp_array_b[i] = i
##    (try_end),
##
##    (store_random_in_range, "$arena_player_team", 0, "$_num_teams"),
##    (try_for_range, ":i_team", 0, "$_num_teams"), # repeat for num_teams; reg(55) = cur_team
##      (assign, ":team_slots_start", ":i_team"),
##      (val_mul, ":team_slots_start", 8),
##      (assign, ":team_slots_end", ":team_slots_start"),
##      (val_add, ":team_slots_end", 8),
##      (assign, "$pin_troop", "trp_temp_array_b"),
##      (call_script, "script_shuffle_troop_slots", ":team_slots_start", ":team_slots_end"),
##      (assign, ":cur_slot", ":team_slots_start"),
##      (try_for_range, reg(6), 0, "$_team_size"), # repeat for team_size; 
##        (troop_get_slot, ":cur_slot_troop", "trp_temp_array_a", ":cur_slot"),
##        (try_begin), #place player
##          (eq,"$arena_join_or_watch",0),
##          (eq, ":i_team", "$arena_player_team"),
##          (eq, reg(6), 0),
##          (assign, ":cur_slot_troop", "trp_player"),
##        (try_end),
##        (troop_get_slot, ":cur_entry_no", "trp_temp_array_b", ":cur_slot"),
##        (set_visitor,":cur_entry_no",":cur_slot_troop"),
##        (val_add, ":cur_slot", 1),
##      (try_end),
##    (try_end),
##
##    (try_begin),
##      (eq, "$arena_join_or_watch", 1),
##      (set_visitor, 33, "trp_player"),#entry point 51
##    (try_end),
##    (assign, "$arena_fight_won", 0),
##    (assign, "$arena_winner_team", -1),
##    (assign, "$waiting_for_arena_fight_result", 1),
##    (assign, "$g_mt_mode", abm_fight),
##    (party_get_slot, reg(6),"$current_town",slot_town_arena_melee_cur_tier),
##    (val_add,reg(6),1),
##    (val_mod,reg(6),3),
##    (party_set_slot, "$current_town",slot_town_arena_melee_cur_tier, reg(6)),
###    (set_jump_mission,"mt_arena_melee_fight"),
##    (party_get_slot, ":arena_mission_template", "$current_town", slot_town_arena_template),
##    (set_jump_mission, ":arena_mission_template"),
##    (party_get_slot, reg(7), "$current_town", slot_town_arena),
##    (jump_to_scene, reg(7)),
##    ]],



######################################################################################
  [trp_galeas,"start", [], "If you have any prisoners, my {boy/girl}, I would be happy to buy them from you.", "galeas_talk",[]],

  [trp_galeas|plyr,"galeas_talk",
   [[store_num_regular_prisoners,reg(0)],[ge,reg(0),1]],
   "Then you'd better bring your purse. I do indeed have some prisoners for you.", "galeas_sell_prisoners",[]],
  [trp_galeas|plyr,"galeas_talk",[], "Not this time. Good bye.", "close_window",[]],
  [trp_galeas,"galeas_sell_prisoners", [],
  "Let me see what you have...", "galeas_sell_prisoners_2",
   [[change_screen_trade_prisoners]]],
  [trp_galeas, "galeas_sell_prisoners_2", [], "If you take any more prisoners, remember to bring them to me. I always pay well.", "close_window",[]],

##  [party_tpl|pt_refugees,"start", [], "We have been driven out of our homes because of this war.", "close_window",[(assign, "$g_leave_encounter",1)]],
##  [party_tpl|pt_farmers,"start", [], "We are just simple farmers.", "close_window",[(assign, "$g_leave_encounter",1)]],


# Random Quest related conversations
#  [trp_nobleman, "start", [],
#   "Who are you? What do you want? Be warned, we are fully armed and more than capable to defend ourselves. Go to your way now or you will regret it.", "nobleman_talk_1",
#   [(play_sound,"snd_encounter_nobleman")]],
#  [trp_nobleman|plyr, "nobleman_talk_1", [],
#   "I demand that you surrender to me.", "nobleman_talk_2",[]],
#  [trp_nobleman|plyr, "nobleman_talk_1", [],
#   "I am sorry sir. You may go.", "close_window",[(assign, "$g_leave_encounter",1)]],
#  [trp_nobleman, "nobleman_talk_2", [],
#   "Surrender to a puny peasant like you? Hah. Not likely.", "close_window",[[encounter_attack]]],
#
#  [trp_nobleman,"enemy_defeated", [], "Parley! I am of noble birth, and I ask for my right to surrender.", "nobleman_defeated_1",[]],
#  [trp_nobleman|plyr,"nobleman_defeated_1", [], "And I will grant you that. If you can be ransomed of course...", "nobleman_defeated_2",[]],
#  [trp_nobleman,"nobleman_defeated_2", [], "Oh, you need not worry about that. My family would pay a large ransom for me.", "nobleman_defeated_3",[]],
#  [trp_nobleman|plyr,"nobleman_defeated_3", [[str_store_troop_name,1,"$nobleman_quest_giver"]], "Hmm. {s1} will be happy about this... Then you are my prisoner.", "close_window",
#   [[assign,"$nobleman_quest_succeeded",1],[assign,"$nobleman_quest_nobleman_active",0]]],

# Prisoner Trains
##  [anyone,"start", [(eq,"$g_encountered_party_type",spt_prisoner_train)],
##   "What do you want?", "prisoner_train_talk",[]],
##
##  [anyone|plyr,"prisoner_train_talk", [],
##   "Set those prisoners free now!", "prisoner_train_talk_ultimatum",[]],
##  [anyone,"prisoner_train_talk_ultimatum", [],
##   "Or what? Are you going to attack us?", "prisoner_train_talk_ultimatum_2",[]],
##  [anyone|plyr,"prisoner_train_talk_ultimatum_2", [],
##   "Yes I will. Consider yourself warned!", "prisoner_train_talk_ultimatum_2a",[]],
##  [anyone,"prisoner_train_talk_ultimatum_2a", [],
##   "We'll see that.", "close_window",[
##    (call_script, "script_make_kingdom_hostile_to_player", "$g_encountered_party_faction", -3),
##    ]],
##
##  [anyone|plyr,"prisoner_train_talk_ultimatum_2", [],
##   "Attack you? Hell no! I just took pity on those poor souls.", "prisoner_train_talk_ultimatum_2b",[]],
##  [anyone,"prisoner_train_talk_ultimatum_2b", [],
##   "Find something else to take pity on.", "close_window",[(assign, "$g_leave_encounter",1)]],
##  [anyone|plyr,"prisoner_train_talk", [],
##   "Better watch those prisoners well. They may try to run away.", "prisoner_train_smalltalk",[]],
##  [anyone,"prisoner_train_smalltalk", [],
##   "Don't worry. They aren't going anywhere.", "close_window",[(assign, "$g_leave_encounter",1)]],



##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_forager), (is_between, "$g_encountered_party_relation", -9, 1)],
##   "Hold it right there. Who are you?", "soldiers_interrogation",[(play_sound,"snd_encounter_vaegirs_neutral")]],
##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_forager), (le, "$g_encountered_party_relation", -10)],
##   "You will not survive this!", "close_window",
##   [(store_relation, reg(5),"$g_encountered_party_faction"), (val_sub,reg(5),1), (set_relation,"$g_encountered_party_faction",0,reg(5)),(encounter_attack,0)]],
##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_forager),(ge, "$g_encountered_party_relation", 1)],
##   "Our lands have been invaded. But we will drive them back.", "close_window",[(assign, "$g_leave_encounter",1),(play_sound,"snd_encounter_vaegirs_ally"),]],
##
##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_scout),(is_between, "$g_encountered_party_relation", -9, 1)],
##   "Hold it right there. Who are you?", "soldiers_interrogation",[]],
##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_scout),(le, "$g_encountered_party_relation", -10)],
##   "You deserve to die a thousand deaths!", "close_window",
##   [(store_relation, reg(5),"$g_encountered_party_faction"), (val_sub,reg(5),2), (set_relation,"$g_encountered_party_faction",0,reg(5)),(encounter_attack,0)]],
##  [anyone,"start", [(eq, "$g_encountered_party_type", spt_scout),(ge, "$g_encountered_party_relation", 1)],
##   "Venture deep into the enemy territory and find myself a caravan to raid. That's the way I will get rich.", "close_window",[(assign, "$g_leave_encounter",1)]],
##
##  [anyone,"start", [(this_or_next|eq, "$g_encountered_party_type", spt_patrol),(eq, "$g_encountered_party_type", spt_war_party),(is_between, "$g_encountered_party_relation", -9, 1)],
##   "Hold it right there. Who are you?", "soldiers_interrogation",[]],
##  [anyone,"start", [(this_or_next|eq, "$g_encountered_party_type", spt_patrol),(eq, "$g_encountered_party_type", spt_war_party),(le, "$g_encountered_party_relation", -10)],
##   "You will not survive this!", "close_window",
##   [(store_relation, reg(5),"$g_encountered_party_type"), (val_sub,reg(5),3), (set_relation,"$g_encountered_party_type",0,reg(5)),(encounter_attack,0)]],
##  [anyone,"start", [(this_or_next|eq, "$g_encountered_party_type", spt_patrol),(eq, "$g_encountered_party_type", spt_war_party),(ge, "$g_encountered_party_relation", 1)],
##   "Sooner or later, friend. Victory will belong to us.", "close_window",[(assign, "$g_leave_encounter",1)]],

#swadian parties
##  [anyone|plyr,"soldiers_interrogation", [], "I am {playername}.", "soldiers_interrogation_2",[]],
##  [anyone,"soldiers_interrogation_2", [], "What are you doing here?", "soldiers_interrogation_3",[]],
##  [anyone|plyr,"soldiers_interrogation_3", [], "I am carrying some merchandise.", "soldiers_interrogation_4",[]],
##  [anyone|plyr,"soldiers_interrogation_3", [], "I am just admiring the sights.", "soldiers_interrogation_4",[]],
##  [anyone,"soldiers_interrogation_4", [], "Hmm. All right. You may go now. But be careful. There is a war going on. The roads are not safe for travellers.", "close_window",[(assign, "$g_leave_encounter",1)]],
  

 
  
# Bandits
##  [party_tpl|pt_mountain_bandits,"start", [(this_or_next|eq, "$g_encountered_party_template", "pt_mountain_bandits"),(eq, "$g_encountered_party_template", "pt_forest_bandits"),
##                                           (eq,"$talk_context",tc_party_encounter),
##                                           (party_get_slot,":protected_until_hours", "$g_encountered_party",slot_party_ignore_player_until),
##                                           (store_current_hours,":cur_hours"),
##                                           (store_sub, ":protection_remaining",":protected_until_hours",":cur_hours"),
##                                           (ge, ":protection_remaining", 0)], "What do you want?\
## You want to pay us some more money?", "bandit_paid_talk",[]],
##  
##  [anyone|plyr,"bandit_paid_talk", [], "Sorry to trouble you. I'll be on my way now.", "bandit_paid_talk_2a",[]],
##  [anyone,"bandit_paid_talk_2a", [], "Yeah. Stop fooling around and go make some money.\
## I want to see that purse full next time I see you.", "close_window",[(assign, "$g_leave_encounter",1)]],
##  [anyone|plyr,"bandit_paid_talk", [], "No. It's your turn to pay me this time.", "bandit_paid_talk_2b",[]],
##  [anyone,"bandit_paid_talk_2b", [], "What nonsense are you talking about? You want trouble? You got it.", "close_window",[
##       (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,0),
##       (party_ignore_player, "$g_encountered_party", 0),
##    ]],


##OiM dialogs begin
## tf_male = 0  
#OiM start genaration

  [anyone|auto_proceed, "start", [
	(eq, "$start_genaration", 0),
	(eq, "$g_talk_troop", "trp_oim_monfor"), 
  ], "{!}NOT SHOWN", "oim_char_generation_1", [(assign, "$start_genaration", 1)]],
  [anyone, "oim_char_generation_1", [], "My name is Jaques de Clermont. I can see you are surely no brigand. Come, unsaddle your steed and rest yourself by the fire. The supper is nigh ready...", "oim_ends_talk_to_monfore",[]],

  [anyone|plyr, "oim_ends_talk_to_monfore", [], "My name is {playername}.^^How did you find yourself in these lands, sir? Where are you headed?", "oim_first_talk_to_monfore_1",[]],
  [anyone, "oim_first_talk_to_monfore_1", [], "I am of the Clermonts of Languedoc. Our line descends from the famed crusader, the Count Simon de Clermont. But unlike my magnificent ancestor, I have neither great titles nor vast lands. I served in Guard of Cardinal Mazarin, and was doing well for myself -- but then the devil made me his fool, and I challenged a certain D'Artagnan, lieutenant of the royal musketeers, to a duel. Fully knowing my skill with saber and pistol alike, the guileful Gascon thought to avoid the risk, and convinced the Queen that I secretly planned an attempt on the life of the young Louis. Thus, in the night on duel's eve, I was forced to flee Paris. And now I am doomed to wander the fields of Europe.", "oim_first_talk_to_monfore_4",[]],  
  
  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_told_replik_pro_zemli", 0)], "Tell me, sir, what is happening in these lands?", "oim_first_talk_to_monfore_3",[]],
   [anyone, "oim_first_talk_to_monfore_3", [], "The air smells of gunpowder and burning cities. Eastern Europe stands on the verge of a great war. For many years, the Zaporozhian Cossacks fought for freedom against the Polish gentry, but were nearly defeated -- and so, Hetman Bogdan Khmelnytsky was forced to turn to the Russians for help. Thus, not long ago in Pereyaslav, the Council of Cossack leaders known as the Starshina swore allegiance to the Russian Tsar, Alexei Mikhailovich. ^Now the Tsar marches with the Cossacks, and together they are preparing an attack on the Polish-Lithuanian Commonwealth. Meanwhile, the King of Sweden and the Crimean Khan look on, awaiting the outcome of the coming conflict. That is all I know. If you meet any soldiers on the road, you might learn further news from them... They should know far more than I.", "oim_first_talk_to_monfore_4",[(assign, "$oim_told_replik_pro_zemli", 1)]],  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_told_replik_pro_zemli", 1)], "Tell me of...", "oim_talk_to_monfor_intro_19",[]],  
   [anyone, "oim_talk_to_monfor_intro_19", [], "Of what?", "oim_talk_to_monfor_intro_20", []],         
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Could you tell me of the Cossack Hetmanate?", "oim_talk_to_monfor_intro_21",[]],    
   [anyone, "oim_talk_to_monfor_intro_21", [], "The Cossacks fight for their freedom and dream of one day forging their own state, one like the Polish Commonwealth, and just as powerful. But in this new nation, the Catholic Pole -- the lyakh, as the Cossacks call him -- he would no longer find himself among the gentry. Instead, all titles would be held by Orthodox Cossack leaders. Some years ago, the Zaporozhian Host, in a series of bloody battles, forced the Polish crown to grant them limited sovereignty, but now the times have changed. Today the Ukrainian Hetman fights under the hand of the Tsar of Moscow.", "oim_talk_to_monfor_intro_19", []],       
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Could you tell me of the Polish Commonwealth?", "oim_talk_to_monfor_intro_22",[]],      
   [anyone, "oim_talk_to_monfor_intro_22", [], "That is the most amazing state I have ever seen. It is a feudal republic, comprised of three major groups of people -- the Poles, the Lithuanians, and Russian-Ukrainians. The nobility is nearly all Polish. All the important decisions, including who is to be king, is determined by their congress, which they call the Sejm. But the Polish gentry is unruly, which leads to constant strife and a divided military. Unless they make up their minds and come forth in unity and strength, soon they will be conquered by their autocrat neighbors.", "oim_talk_to_monfor_intro_19", []],          
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Could you tell me of the Muscovite Tsardom?", "oim_talk_to_monfor_intro_23",[]],      
   [anyone, "oim_talk_to_monfor_intro_23", [], "The Time of Troubles has long since passed in Russia. Now a new dynasty of Tsars, the Romanovs, seek to regain the lands once seized by Poland, and expand their nation with the orthodox lands in the West. Alexei Mikhailovich has resolved to regain all the Russian lands that today are claimed by the Polish Commonwealth. The host of the Tsar is vast, and he plans to drive them forth any day now.", "oim_talk_to_monfor_intro_19", []],          
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Could you tell me of the Kingdom of Sweden?", "oim_talk_to_monfor_intro_24",[]],      
   [anyone, "oim_talk_to_monfor_intro_24", [], "The Kingdom of Sweden so far remains neutral to both the Muscovites and the Poles, but it keeps its cold eye on their northern lands. No one has any doubt that it shall draw its hands around the throat of whichever nation loses the coming war. The Swedes have an impressive army, dreaded by all of Northern Europe.", "oim_talk_to_monfor_intro_19", []],         
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Could you tell me of the Crimean Khanate?", "oim_talk_to_monfor_intro_25",[]],      
   [anyone, "oim_talk_to_monfor_intro_25", [], "Islam Giray, aided Bogdan Hmelnitski, depends on an independent Cossack Hetmanate to shield him against both the Muscovite Tsardom and the Polish Commonwealth. Islam Giray passes for a lavish ruler, and thus far he has sided with the Cossacks. But now that Ukraine has allied with Russia, there are rumors that the Tatars would betray the Cossacks, and ally with the Polish Commonwealth instead.", "oim_talk_to_monfor_intro_19", []], 
   [anyone|plyr, "oim_talk_to_monfor_intro_20", [], "Return...", "oim_first_talk_to_monfore_pretalk",[(assign, "$oim_told_replik_pro_zemli", 2)]],        
  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_first_talk_to_monfore_what_find", 0)], "What can you tell me of this area?", "oim_first_talk_to_monfore_what_find",[]],
   [anyone, "oim_first_talk_to_monfore_what_find", [], "'Tis nothing short of a battlefield between the Swedes, the Poles, the Russians, and the Cossacks. Oh, and the Crimeans too would love to grab their share. If you are asking for my counsel -- visit the cities, where you can buy arms and supplies, and learn the latest news... The local rulers, lords, mayors, and even village elders might give you jobs of various kinds. My sincere advice, though -- do not take on more than you can handle. And yes, don't get me wrong, but visiting the odd pub can be quite useful. There one can find all manner of men who could help you on your way, and you might hire some skilled warriors, or even test your strength against others for pay.", "oim_first_talk_to_monfore_4",[(assign, "$oim_first_talk_to_monfore_what_find", 1)]],  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_first_talk_to_monfore_what_to_do", 0)], "What would you advise I do from here?", "oim_first_talk_to_monfore_what_to_do",[]],
   [anyone, "oim_first_talk_to_monfore_what_to_do", [], "These are troubled times, and a mercenary, especially one that has known command, is worth his weight in gold. Start with small jobs, I would say -- take your time to get accustomed, and understand the local affairs. Wipe out some bandits, do some freelance jobs -- escort a merchant convoy or protect a village... After that you might try enlisting with one of the rulers -- you'll earn a reward, maybe even get yourself an estate, which by turns would also bring you some coin. Once you gather some loyal warriors and earn a name for yourself, you might lay siege to a stronghold, throw your backing behind a claimant to the throne, or even start a rebellion yourself!", "oim_first_talk_to_monfore_4",[(assign, "$oim_first_talk_to_monfore_what_to_do", 1)]],
  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_monfor_ready_to_fight", 0), (eq, 0, 1),], "Could you instruct me in arts of the blade?", "oim_talk_to_monfor_practise_fight",[]],
  [anyone, "oim_talk_to_monfor_practise_fight", [], "We shall begin when you're ready.", "oim_talk_to_monfor_practise_fight_1",[]],  
  [anyone|plyr, "oim_talk_to_monfor_practise_fight_1", [], "I'm ready.", "close_window",[
     (assign, "$oim_monfor_ready_to_fight", 1),
     (jump_to_menu, "mnu_start_phase_2"),
     (music_set_situation, 0),
     (change_screen_mission),
  ]],  
  [anyone|auto_proceed, "start", [(eq, "$oim_monfor_ready_to_fight", 2),(eq, "$g_talk_troop", "trp_oim_monfor"), ], "{!}NOT SHOWN", "oim_talk_to_monfor_fight_result_2", [(assign, "$oim_monfor_ready_to_fight", 4)]],
  [anyone|auto_proceed, "start", [(eq, "$oim_monfor_ready_to_fight", 3),(eq, "$g_talk_troop", "trp_oim_monfor"), ], "{!}NOT SHOWN", "oim_talk_to_monfor_fight_result_3", [(assign, "$oim_monfor_ready_to_fight", 4)]],  
  [anyone, "oim_talk_to_monfor_fight_result_2", [], "You handle the saber well!", "oim_talk_to_monfor_fight_result_2_1", []],    
  [anyone, "oim_talk_to_monfor_fight_result_2_1", [], "Not a bad fight, but I would recommend regular training.", "oim_first_talk_to_monfore_4", []],      
  [anyone, "oim_talk_to_monfor_fight_result_3", [], "Not bad, but you must wield the saber with more confidence.", "oim_first_talk_to_monfore_4", []],    

  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [(eq, "$oim_monfor_ready_to_fire_musquet", 0), (eq, 0, 1),], "I hear that guards are adept at sharpshooting. Could you perhaps give me some tips?", "oim_talk_to_monfor_intro_19_1",[]],
   [anyone|plyr, "oim_talk_to_monfor_intro_19_1", [], "I would love to learn how to shoot with a musket. Could you teach me how to use one?", "oim_talk_to_monfor_intro_11_6", []],    
   [anyone, "oim_talk_to_monfor_intro_11_6", [], "Certainly! Just wait a moment while I set up some targets...", "close_window", [
    #some code 
		#(set_show_messages, 0),
		(assign, "$oim_monfor_ready_to_fire_musquet", 1),	
		#(troop_add_item, "trp_player","itm_samopal",0),
		#(troop_add_item, "trp_player","itm_steel_bolts_10",0),
		#(troop_equip_items, "trp_player"),	
		#(set_show_messages, 1),
    ]],    
 
  [anyone|auto_proceed, "start", [(eq, "$oim_monfor_ready_to_fire_musquet", 2), (eq, "$g_talk_troop", "trp_oim_monfor"), ], "{!}NOT SHOWN", "oim_first_talk_to_monfore_4", [(assign, "$oim_monfor_ready_to_fire_musquet", 3)]],  
  [anyone|plyr, "oim_first_talk_to_monfore_4", [], "Well, it was a pleasure to meet you. But now, I shall be moving on...", "oim_first_talk_to_monfore_4_end",[]], 
  [anyone, "oim_first_talk_to_monfore_4_end", [], "I recommend you set your path to Zamoshye and take in the town. And Smolensk is a fine city, and not far from there.", "close_window",[
    (str_store_troop_name, s9, "$g_talk_troop"),	
    (str_store_party_name_link, s10, "p_village_66"),	
    (setup_quest_text, "qst_talk_to_zamoshie_elder"),
    (str_store_string, s2, "@As {s9} said it wount be a good idea to visit {s10}."),
    (call_script, "script_start_quest", "qst_talk_to_zamoshie_elder", "trp_oim_monfor"),
	#(set_show_messages, 0),
    #(troop_remove_item, "trp_player", "itm_steel_bolts_10",0),
	#(troop_remove_item, "trp_player", "itm_old_musket",0),
    
	#(troop_add_item, "trp_player", "itm_bolts",0),
	#(troop_add_item, "trp_player", "itm_samopal",0),
    #(troop_equip_items, "trp_player"),		
	#(set_show_messages, 1),	

	#Monfor spawn code. 
	(set_spawn_radius, 1),
    (spawn_around_party, "p_main_party", "pt_oim_monfor_party"),
    (assign, ":oim_monfor_party", reg0),
    (party_add_members, ":oim_monfor_party", "$g_talk_troop", 1),
	(party_add_members, ":oim_monfor_party", "trp_nord_champion", 10),
    (party_set_ai_behavior, ":oim_monfor_party", ai_bhvr_patrol_party),
    (party_set_ai_object, ":oim_monfor_party", "p_town_13"),
    (party_set_flags, ":oim_monfor_party", pf_default_behavior, 0),
	(party_set_ai_patrol_radius, ":oim_monfor_party", 5),
	(val_add, "$oim_monfor_ready_to_fire_musquet", 10),
	(set_show_messages, 0),
	#OiM crab mode
	(options_get_campaign_ai, ":ai"),
	(try_begin), 
		(eq, ":ai", 2), 
		#easy
		(troop_add_item, "trp_player","itm_sablya_c",0),
		(troop_add_item, "trp_player","itm_karabin_old_a",0),
		(troop_add_item, "trp_player","itm_sumpter_horse",0),
		(troop_add_gold, "trp_player", 1000), 
	(else_try), 
		(eq, ":ai", 1), 
		#normal
		(troop_add_item, "trp_player","itm_sablya_pure_c",0),
		(troop_add_item, "trp_player","itm_pistol",0),
		(troop_add_item, "trp_player","itm_sumpter_horse",0),
		(troop_add_gold, "trp_player", 500), 
	(else_try), 
		#really normal mode
		(troop_add_item, "trp_player","itm_plotnik_toporik",0),
		(troop_add_item, "trp_player","itm_samopal",0),
		(troop_add_item, "trp_player","itm_sumpter_horse",0),
		(troop_add_gold, "trp_player", 100), 
	(end_try),
	#OiM crab mode end
	(troop_equip_items, "trp_player"),
	(set_show_messages, 0),		
	(jump_to_menu, "mnu_auto_return_to_map"),
  ]],
	
	[anyone, "oim_first_talk_to_monfore_pretalk", [], "{playername}?", "oim_first_talk_to_monfore_4",[]],
  
#code scene #3 Zomsh'e  p_village_66 (!!!!!!)
#oim_intro_zamoshie_elder
#OiM redone quests
  [trp_village_66_elder, "oim_intro_zamoshie_elder", [], "Why, hello there... Mikhay's my name. We are Rusyn, but we live under the Polish gentry. We have heard say that the Russian Tsar wants to regain our lands, and has set out to make war with the Polish king. He leads his host to Smolensk. Word has also come that the Cossack Colonel Zolotarenko stands nearby with his army, calling all free men to the Zaporozhian Host, to fight under his banner.", "oim_intro_zamoshie_elder_1",[]],
  [trp_village_66_elder|plyr, "oim_intro_zamoshie_elder_1", [], "And do you have some work for me? Something that will give me a chance to swing my saber, win myself some glory -- and fill my purse! It's a little too empty at the moment...", "oim_intro_zamoshie_elder_4",[]],
  [trp_village_66_elder, "oim_intro_zamoshie_elder_4", [], "Aye, there is always work for a daring soul such as yourself. Believe it or not, the colonels of the gentry just sit in wait for the Muscovites, huddling in their towns, fearing to stick their nose out of the gates. Meanwhile, bandits roam the roads, giving travelers and merchants no peace... We cannot even travel to the bazaar, for fear of being overtaken! And to make matters worse, the blasted warlord of Smolensk taxes us so heavily that we have nothing for ourselves, and will soon be reduced to starvation...", "oim_intro_zamoshie_elder_5",[]],
	#(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -5),
  [trp_village_66_elder|plyr, "oim_intro_zamoshie_elder_5", [
  	(neg|check_quest_active,"qst_deal_with_zamoshie_bandits"),
	(neg|check_quest_finished,"qst_deal_with_zamoshie_bandits"),
   ], "Find and wipe out the bandits.", "oim_intro_kill_bandits_start",[]],
  
  [trp_village_66_elder|plyr, "oim_intro_zamoshie_elder_5", [
	(neg|check_quest_active,"qst_zamoshie_lower_taxes"),
	(neg|check_quest_finished,"qst_zamoshie_lower_taxes"),
  ], "Persuade the Smolensk warlord to lower the taxes.", "oim_intro_taxes_lower",[]],

  [trp_village_66_elder|plyr, "oim_intro_zamoshie_elder_5", [
	(neg|check_quest_active,"qst_oim_bring_goods_zamoshie"),
	(neg|check_quest_finished,"qst_oim_bring_goods_zamoshie"),
  ], "Bring in some goods.", "oim_bring_goods_in_zamoshie_intro",[]],  

  [trp_village_66_elder|plyr, "oim_intro_zamoshie_elder_5", [], "Leave...", "close_window",[]],  

  
  [trp_village_66_elder, "oim_intro_kill_bandits_start", [], "Bandits have settled in the forest nearby, and set out to plunder us each day. They are only a few of them, but numbers matter not -- our peasants are not trained for battle...", "oim_intro_kill_bandits_dialog",[]],  
  [trp_village_66_elder|plyr, "oim_intro_kill_bandits_dialog", [], "Agree...", "oim_intro_kill_bandits_dialog_start_quest",[]],
  [trp_village_66_elder|plyr, "oim_intro_kill_bandits_dialog_start_quest", [], "Bandits? Sounds like my kind of work! Tell me how I can find them.", "oim_intro_kill_bandits_dialog_start_quest_1",[]],
#start quest  
  [trp_village_66_elder, "oim_intro_kill_bandits_dialog_start_quest_1", 
  [
    (try_begin),
      (call_script, "script_party_count_members_with_full_health", "p_main_party"),
      (assign, ":player_party_size", reg0),
	  (le, ":player_party_size", 2),
	  (str_store_string, s3, "str_you_are_weak_take_these_men_with_you"),
	(else_try),
	  (str_clear, s3),
	(try_end),
  ], "They are lurking in the forest right past the village. Go and defeat the bastards... We'll reward you well. {s3}", "close_window",[
#code starting bandits quest
		(set_spawn_radius, 4),
        (quest_get_slot, ":quest_target_center", "qst_deal_with_zamoshie_bandits", slot_quest_target_center),       
        (spawn_around_party,":quest_target_center", "pt_zamoshie_bandits"),
        (assign, ":quest_target_party", reg0),
        (quest_set_slot, "qst_deal_with_zamoshie_bandits", slot_quest_target_party, ":quest_target_party"),
		(quest_set_slot, "qst_deal_with_zamoshie_bandits", slot_quest_xp_reward, 100),
		(quest_set_slot, "qst_deal_with_zamoshie_bandits", slot_quest_gold_reward, 100),
		(quest_set_slot, "qst_deal_with_zamoshie_bandits", slot_quest_current_state, 0),
		(quest_set_slot, "qst_deal_with_zamoshie_bandits", slot_quest_giver_troop, "$g_talk_troop"),  
        (party_set_ai_behavior, ":quest_target_party", ai_bhvr_hold),
        (party_set_ai_object, ":quest_target_party", "p_main_party"),
		
        (party_set_flags, ":quest_target_party", pf_default_behavior, 0),
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_deal_with_zamoshie_bandits"),
		(str_store_string, s2, "@OiM The elder {s9} asked you to deal with bandits"),
		(call_script, "script_start_quest", "qst_deal_with_zamoshie_bandits", "$g_talk_troop"),

        (try_begin),
          (call_script, "script_party_count_members_with_full_health", "p_main_party"),
          (assign, ":player_party_size", reg0),
	      (le, ":player_party_size", 2),

	      (party_get_slot, ":center_culture", "$current_town", slot_center_culture),
	      (store_faction_of_party, ":faction", "$current_town"), 
	      (try_begin), 
	        (eq, ":faction", "fac_kingdom_1"), 
		    (faction_get_slot, ":volunteer_troop", "fac_kingdom_1", slot_faction_tier_1_troop),
	      (else_try), 
	        (eq, ":faction", "fac_kingdom_2"), 
	        (faction_get_slot, ":volunteer_troop", "fac_kingdom_2", slot_faction_tier_1_troop),
          (else_try), 
	        (eq, ":faction", "fac_kingdom_3"), 
	        (faction_get_slot, ":volunteer_troop", "fac_kingdom_3", slot_faction_tier_1_troop),
	      (else_try), 
	        (eq, ":faction", "fac_kingdom_4"),
	        (faction_get_slot, ":volunteer_troop", "fac_kingdom_4", slot_faction_tier_1_troop),
	      (else_try),
	        (eq, ":faction", "fac_kingdom_5"), 
	        (faction_get_slot, ":volunteer_troop", "fac_kingdom_5", slot_faction_tier_1_troop),
	      (else_try),
	        (faction_get_slot, ":volunteer_troop", ":center_culture", slot_faction_tier_1_troop),
	      (end_try), 
	 	 
          (party_add_members, "p_main_party", ":volunteer_troop", 2),
	    (else_try),
  ]],  
  [trp_village_66_elder|plyr, "oim_intro_kill_bandits_dialog", [], "Refuse...", "oim_intro_kill_bandits_dialog_refuge",[]],  

  [trp_village_66_elder|plyr, "oim_intro_kill_bandits_dialog_refuge", [], "I have urgent business elsewhere, so I'm afraid I cannot help.", "oim_intro_kill_bandits_dialog_refuge_1",[]],  
  [trp_village_66_elder, "oim_intro_kill_bandits_dialog_refuge_1", [], "Very well, then... We shall just have to search for another who might protect us. What else can we do?", "oim_intro_zamoshie_elder_5",[]],    
  
#OiM start quest kill bandits
  [party_tpl|pt_zamoshie_bandits|auto_proceed, "start", [], "{!}NOT SHOWN", "zamoshien_badits_dialog_prebattle_1",[]],
  [anyone, "zamoshien_badits_dialog_prebattle_1", [], "Well met! It has been a long while since we have seen a noble personage. What brings you here, your grace?", "zamoshien_badits_dialog_prebattle_2",[]],   
  [anyone|plyr, "zamoshien_badits_dialog_prebattle_2", [], "You speak with an eloquent tongue... I would presume you fight just as well? I am on the hunt for some local bandits -- perhaps that would be you?", "zamoshien_badits_dialog_prebattle_3",[]],   
  [anyone, "zamoshien_badits_dialog_prebattle_3", [], "We are no bandits, but fair and upright forest brothers. We do for ourselves the best we can, rob from the rich, and give to the poor -- and take but a token share for ourselves, as reward for our daring feats of arms.", "zamoshien_badits_dialog_prebattle_4",[]],   
  [anyone|plyr, "zamoshien_badits_dialog_prebattle_4", [], "That's strange... According to the local villagers, it is you who are taking from the poor even their last pittance. This seems far from noble to me... And they have asked of me to put an end to this disgraceful situation.", "zamoshien_badits_dialog_prebattle_5",[]],   
  [anyone, "zamoshien_badits_dialog_prebattle_5", [], "Strange business this. Some nameless passer-by dares to slander us. Aye, lads, a long time has passed since our daggers bit flesh. Let's test the color of this noble fool's blood. Get him!", "close_window",[[encounter_attack]]],     

#oim_zamoshie_killed_bandits
  
  [trp_village_66_elder|plyr, "oim_zamoshie_killed_bandits", [], "Hello again my good man -- the bandits are done for. They shall pester you no more. Do you remember your promise?", "oim_zamoshie_killed_bandits_1",[]],
  [trp_village_66_elder, "oim_zamoshie_killed_bandits_1", [], "Of course, how could I forget? Here, take these provisions. They will help you on your way. And thank you for your help!", "oim_zamoshie_killed_bandits_2",[
#  insert code quest reward
    (call_script, "script_troop_add_gold", "trp_player", 100),
    (add_xp_as_reward, 200),
	(troop_add_items, "trp_player", "itm_grain", 2),
	(troop_add_items, "trp_player", "itm_flour", 3),
	(troop_add_items, "trp_player", "itm_oil", 1),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
	(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", 2),
    (call_script, "script_end_quest", "qst_deal_with_zamoshie_bandits"),	
  ]],
  [trp_village_66_elder|plyr, "oim_zamoshie_killed_bandits_2", [], "Perhaps I could offer you further aid?", "oim_choose_quests",[]],
# choose quests. Experimental  
  [trp_village_66_elder|auto_proceed, "oim_choose_quests", [
	(assign, ":result", 0), 
	(try_begin), 
		(neg|check_quest_active,"qst_deal_with_zamoshie_bandits"),
		(neg|check_quest_finished,"qst_deal_with_zamoshie_bandits"),
		(val_add, ":result", 1), 
	(end_try), 
	(try_begin), 
		(neg|check_quest_active,"qst_zamoshie_lower_taxes"),
		(neg|check_quest_finished,"qst_zamoshie_lower_taxes"),
		(val_add, ":result", 1), 
	(end_try), 
	(try_begin), 
		(neg|check_quest_active,"qst_oim_bring_goods_zamoshie"),
		(neg|check_quest_finished,"qst_oim_bring_goods_zamoshie"),
		(val_add, ":result", 1), 
	(end_try), 
	(eq, ":result", 0), 
  ], "{!}NOT SHOWN", "oim_help_to_find_icon",[]],
  
  [trp_village_66_elder, "oim_choose_quests", [], "Well...", "oim_choose_quests_answer",[]],
  [trp_village_66_elder|plyr, "oim_choose_quests_answer", [
	(neg|check_quest_active,"qst_deal_with_zamoshie_bandits"),
	(neg|check_quest_finished,"qst_deal_with_zamoshie_bandits"),
  ], "Find and wipe out the bandits.", "oim_intro_kill_bandits_start",[]],
  [trp_village_66_elder|plyr, "oim_choose_quests_answer", [
	(neg|check_quest_active,"qst_zamoshie_lower_taxes"),
	(neg|check_quest_finished,"qst_zamoshie_lower_taxes"),
  ], "Persuade the Smolensk warlord to lower the taxes.", "oim_intro_taxes_lower",[]],
  [trp_village_66_elder|plyr, "oim_choose_quests_answer", [
	(neg|check_quest_active,"qst_oim_bring_goods_zamoshie"),
	(neg|check_quest_finished,"qst_oim_bring_goods_zamoshie"),
  ], "Bring in some goods.", "oim_bring_goods_in_zamoshie_intro",[]],  
  [trp_village_66_elder|plyr, "oim_choose_quests_answer", [], "Return...", "village_elder_pretalk",[]],       
  [trp_village_66_elder, "oim_help_to_find_icon", [], "Thank you, my friend. We have no other needs.", "village_elder_pretalk",[]],     

#oim_intro_taxes_lower

  [trp_village_66_elder, "oim_intro_taxes_lower", [], "There is one more thing... The warlord of Smolensk has set the taxes so high that we cannot bear it! Our very survival is at stake! We thought of sending humble messengers to him, but we are too frightened... And the roads are far too perilous. Come to our aid, good {man/lady}. Talk to the warlord, and beg him to lower our taxes.", "oim_intro_taxes_lower_1",[]],
  [trp_village_66_elder|plyr, "oim_intro_taxes_lower_1", [], "Agree...", "oim_intro_taxes_lower_agree",[]],
    [trp_village_66_elder|plyr, "oim_intro_taxes_lower_agree", [], "I could speak to him on your behalf, surely... But I arrived not long ago in these lands. I know no one, and no one can stand by my word but I alone. To persuade the warlord would be no easy task...", "close_window",[
	#code to start quest

	(quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_target_troop, "trp_knight_1_6"),
    (quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_target_party, "trp_knight_1_6"),
    (quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_xp_reward, 100),
    (quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_gold_reward, 10),
    (quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_current_state, 0),
	(quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_target_amount, 200), 	
	(quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_giver_troop, "trp_village_66_elder"),
    (str_store_troop_name, s9, "$g_talk_troop"),	
    (str_store_troop_name_link, s10, "trp_knight_1_6"),		
	(setup_quest_text, "qst_zamoshie_lower_taxes"),	
	(str_store_string, s2, "@OiM The elder {s9} asked you to {s10} to lower taxes"),
	(call_script, "script_start_quest", "qst_zamoshie_lower_taxes", "$g_talk_troop"),		
  ]],  
  [trp_village_66_elder|plyr, "oim_intro_taxes_lower_1", [], "Refuse...", "oim_choose_quests_disagree",[]],
    [trp_village_66_elder|plyr, "oim_choose_quests_disagree", [], "I am but a passer-by in these lands... It is no business of mine to petition the ruler on behalf of his serfs. You shall have to find another to run this errand for you.", "oim_choose_quests_disagree_1",[]],
    [trp_village_66_elder, "oim_choose_quests_disagree_1", [], "Well, I have my answer then. But know this -- one cannot live by the saber alone... You would be wise to master the art of speech as well. Otherwise you will not be worth the soil you stand upon.", "close_window",[]],

#OiM Fedor Obolenskiy dialog begin	

  [anyone|plyr,"lord_talk",[#(troop_slot_eq, "$g_talk_troop", slot_troop_is_prisoner, 0),
                            (check_quest_active,"qst_zamoshie_lower_taxes"),
							(neg|check_quest_succeeded, "qst_zamoshie_lower_taxes"), 
							(neg|check_quest_finished,"qst_zamoshie_lower_taxes"),
							(eq, "$g_talk_troop", "trp_knight_1_6")
                            ], "The dwellers of Zamoshye ask that their taxes be lowered.", "oim_fedor_obuhovich_lower_taxes_2_a", []],
							

  [anyone|plyr,"oim_fedor_obuhovich_lower_taxes_2_a", [], "I have business to discuss with you, warlord... You tax Zamoshye so heavily that the local villagers would soon all flee or starve. You would be wise to ease their burden.", "oim_fedor_obuhovich_lower_taxes_2_b",[]],
  
							
  [trp_knight_1_6, "oim_fedor_obuhovich_lower_taxes_2_b", [], "Why should you care, {sir/madam}? You well know that we are at war. By tomorrow, enemy marksman may arrive here, and drive the loyal servants of the Polish king straight out of Smolensk. We must swiftly gather all the money as we can... to better reinforce the town walls.", "oim_convince_options",[
	#(assign, "$convince_value", 200),
	(quest_get_slot, "$convince_value", "qst_zamoshie_lower_taxes", slot_quest_target_amount), 
  ]],

  [anyone|plyr,"oim_convince_options", [(assign, reg8, "$convince_value"),], "Pay the taxes of the village ({reg8} thaler).", "oim_convince_bribe",[]],
  [anyone|plyr,"oim_convince_options", [], "Attempt to persuade the warlord...", "oim_convince_persuade_begin", []],
  [anyone|plyr,"oim_convince_options", [], "Leave...", "lord_pretalk",[]],
  [anyone,"oim_convince_bribe", [], "Heh... In more peaceful times I would refuse... But war has a way of eroding one's principles. Here, then, give me the money and go tell the villagers that they are free of their tax debt for the past year.", "oim_convince_bribe_verify",[]],

  [anyone|plyr,"oim_convince_bribe_verify", [(store_troop_gold, ":gold", "trp_player"),
                                         (lt, ":gold", "$convince_value")],
   "I fear I cannot pay such an amount.", "oim_convince_bribe_cant_afford",[]],
  [anyone|plyr,"oim_convince_bribe_verify", [(store_troop_gold, ":gold", "trp_player"),
                                         (ge, ":gold", "$convince_value")],
  "Very well, here is your money.", "oim_convince_bribe_goon",[]],
  [anyone|plyr,"oim_convince_bribe_verify", [], "Perhaps I could still persuade you?", "lord_pretalk",[]],

  [anyone,"oim_convince_bribe_cant_afford", [], "If that is so, there is nothing I can do.", "oim_convince_options",[]],
   [anyone,"oim_convince_bribe_goon", [], "All right, this amount is enough.", "oim_convince_accept",[(troop_remove_gold, "trp_player","$convince_value")]],
  
  [anyone,"oim_convince_persuade_begin", 
  [(troop_get_slot, ":last_persuasion_time", "$g_talk_troop", slot_troop_last_persuasion_time),
   (store_current_hours, ":cur_hours"),
   (store_add, ":valid_time", ":last_persuasion_time", 24),
   (gt, ":cur_hours", ":valid_time"),
   ], 
   "Hmm, very well. I am listening.", "oim_convince_persuade_begin_2",[]],
   
   
  [anyone|plyr,"oim_convince_persuade_begin_2", [], "Attempt to persuade...", "oim_convince_persuade",[
        (try_begin),
          (store_random_in_range, ":rand", 0, 100),
          (lt, ":rand", 30),
          (store_current_hours, ":cur_hours"),
          (troop_set_slot, "$g_talk_troop", slot_troop_last_persuasion_time, ":cur_hours"),
        (try_end),
        (store_skill_level, ":persuasion_level", "skl_persuasion", "trp_player"),
        (store_add, ":persuasion_potential", ":persuasion_level", 5),

        (store_random_in_range, ":random_1", 0, ":persuasion_potential"),
        (store_random_in_range, ":random_2", 0, ":persuasion_potential"),
        (store_add, ":rand", ":random_1", ":random_2"),

        (assign, ":persuasion_difficulty", "$convince_value"),
        (convert_to_fixed_point, ":persuasion_difficulty"),
        (store_sqrt, ":persuasion_difficulty", ":persuasion_difficulty"),
        (convert_from_fixed_point, ":persuasion_difficulty"),
        (val_div, ":persuasion_difficulty", 10),
        (val_add, ":persuasion_difficulty", 4),

        (store_sub, "$persuasion_strength", ":rand", ":persuasion_difficulty"),
        (val_mul, "$persuasion_strength", 20),
        (assign, reg5, "$persuasion_strength"),
        (val_sub, "$convince_value", "$persuasion_strength"),
        #(quest_set_slot, "$g_convince_quest", slot_quest_convince_value, "$convince_value"),
		(quest_set_slot, "qst_zamoshie_lower_taxes", slot_quest_target_amount, "$convince_value"), 	
        (str_store_troop_name, s50, "$g_talk_troop"),
        (troop_get_type, reg51, "$g_talk_troop"),
        (try_begin),
          (lt, "$persuasion_strength", -30),
          (str_store_string, s5, "str_persuasion_summary_very_bad"),
        (else_try),
          (lt, "$persuasion_strength", -10),
          (str_store_string, s5, "str_persuasion_summary_bad"),
        (else_try),
          (lt, "$persuasion_strength", 10),
          (str_store_string, s5, "str_persuasion_summary_average"),
        (else_try),
          (lt, "$persuasion_strength", 30),
          (str_store_string, s5, "str_persuasion_summary_good"),
        (else_try),
          (str_store_string, s5, "str_persuasion_summary_very_good"),
        (try_end),
        (dialog_box, "@{s5} (Persuasion strength: {reg5})", "@Persuasion Attempt"),
  ]],
  [anyone|plyr,"oim_convince_persuade_begin_2", [], "Wait, perhaps there's a way I could change your mind?", "oim_convince_options",[]],

  [anyone,"oim_convince_persuade_begin", [], "Oh for Heaven's sake, that will be quite enough. My head hurts from all your idle talk.", "lord_pretalk",[]],
 
  [anyone,"oim_convince_persuade", [(le, "$convince_value", 0)], "Hmm, all right then, you've convinced me.", "oim_convince_accept",[]],
  [anyone,"oim_convince_persuade", [(gt, "$persuasion_strength", 5)], "You speak with eloquence, but none of this has convinced me, {playername}.", "oim_convince_options",[]],
  [anyone,"oim_convince_persuade", [(gt, "$persuasion_strength", -5)], "Stop. You've spoken your piece, but I cannot change my stand.", "oim_convince_options",[]],
  [anyone,"oim_convince_persuade", [], "No, no, your reasoning bears little weight.", "oim_convince_options",[]],
  [anyone,"oim_convince_accept",[],
   "Well, your reasons are solid. I suppose I shall forgive the villagers' tax debts.", "close_window",
   [(quest_set_slot,  "qst_zamoshie_lower_taxes", slot_quest_current_state, 1),
    (call_script, "script_succeed_quest", "qst_zamoshie_lower_taxes"),
    (assign, "$g_leave_encounter", 1),
    ]],


#OiM - givving bonuses for settleing the quest "Lower taxes zamoshie"

  [trp_village_66_elder|plyr, "oim_zamoshie_lower_taxes_done", [], "I spoke to the warlord. Your tax debts are forgiven. You may rejoice!", "oim_zamoshie_lower_taxes_done_1",[]],
  [trp_village_66_elder, "oim_zamoshie_lower_taxes_done_1", [], "I bow low before you, my good {man/lady}. You have saved us from a hungry death. Here, take this as a reward for all your help.", "oim_zamoshie_lower_taxes_done_2",[
  #insert code for reward   
    (call_script, "script_troop_add_gold", "trp_player", 100),
    (add_xp_as_reward, 200),
    (call_script, "script_change_player_relation_with_center", "$current_town", 6),
    (call_script, "script_end_quest", "qst_zamoshie_lower_taxes"),	
	(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", 1),
  ]],
  [trp_village_66_elder|plyr, "oim_zamoshie_lower_taxes_done_2", [], "If there is anything else I can do, please tell me.", "oim_choose_quests",[]],
	
#village_elder_talk  

# OiM start intor quest "oim_bring_goods_in_zamoshie_intro"
  [trp_village_66_elder, "oim_bring_goods_in_zamoshie_intro", [], "As you well know, master, there is war in these lands... Traders no longer pass through the villages with their goods. We must go buy everything at the town market. But our people fear travelling to the town -- the road is too dangerous. If you bring us some goods, we would pay you well for it.", "oim_bring_goods_in_zamoshie_intro_answer",[]],
  [trp_village_66_elder|plyr, "oim_bring_goods_in_zamoshie_intro_answer", [], "Agree...", "oim_bring_goods_in_zamoshie_intro_answer_ok",[]],
  [trp_village_66_elder|plyr, "oim_bring_goods_in_zamoshie_intro_answer_ok", [], "So be it. I shall deliver you the goods, and perhaps I shall learn a bit about trading myself!", "village_elder_talk",[
#code to start quest deliver goods zamoshie village
    (quest_set_slot, "qst_oim_bring_goods_zamoshie", slot_quest_xp_reward, 100),
    (quest_set_slot, "qst_oim_bring_goods_zamoshie", slot_quest_gold_reward, 100),
    (quest_set_slot, "qst_oim_bring_goods_zamoshie", slot_quest_current_state, 0),
    (quest_set_slot, "qst_oim_bring_goods_zamoshie", slot_quest_giver_troop, "$g_talk_troop"),  
    (str_store_troop_name, s9, "$g_talk_troop"),	
    (str_store_item_name, s10, "itm_salt"),		
	(setup_quest_text, "qst_oim_bring_goods_zamoshie"),	
	(str_store_string, s2, "@OiM The elder {s9} asked you to bring {s10}"),
	(call_script, "script_start_quest", "qst_oim_bring_goods_zamoshie", "$g_talk_troop"),		
  ]],
  [trp_village_66_elder|plyr, "oim_bring_goods_in_zamoshie_intro_answer", [], "Refuse...", "oim_bring_goods_in_zamoshie_intro_answer_net",[]],  
  [trp_village_66_elder|plyr, "oim_bring_goods_in_zamoshie_intro_answer_net", [], "I have dedicated myself to the military arts. I have scarce little time to drive a merchant's cart.", "oim_bring_goods_in_zamoshie_intro_answer_net_1",[]],  
  [trp_village_66_elder, "oim_bring_goods_in_zamoshie_intro_answer_net_1", [], "'Tis a poor refusal you make, {sir/madam}. 'Tis no disgrace for good warrior to learn the art of the merchant. -- And no merchant would last long in these lands, were he not a little skilled at holding a sword.", "oim_choose_quests",[]],     

#OiM test if good where brought
  [anyone,"oim_check_bring_goods", [(store_item_kind_count, ":item_count", "itm_salt"),
									(ge, ":item_count", 3),],
   "Very well. Here is your money.", "village_elder_talk",[
    (troop_remove_item, "trp_player", "itm_salt"),
	(troop_remove_item, "trp_player", "itm_salt"),
	(troop_remove_item, "trp_player", "itm_salt"),
    (call_script, "script_troop_add_gold", "trp_player", 900),
    (add_xp_as_reward, 200),
    (call_script, "script_change_player_relation_with_center", "$current_town", 5),
    (call_script, "script_end_quest", "qst_oim_bring_goods_zamoshie"),	
	(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", 1),
   ]],
   
  [anyone,"oim_check_bring_goods", [(store_item_kind_count, ":item_count", "itm_salt"), 
									(lt, ":item_count", 3),],
	"Alas, this meets but part of our needs. Deliver all the goods, and we shall pay you all of your reward.", "close_window", []],

 #oim_start_quest_trakay_icon	

 # [anyone,"oim_start_quest_trakay_icon_a", [], "Bila u nas tut icona", "oim_start_quest_trakay_icon_1", []],
 # [anyone|plyr,"oim_start_quest_trakay_icon_1", [], "Nuzno podumat", "oim_start_quest_trakay_icon_2", []],
 # [anyone,"oim_start_quest_trakay_icon_2", [], "Da on v vilno zivet", "oim_start_quest_trakay_icon_3", []],
 # [anyone|plyr,"oim_start_quest_trakay_icon_3", [], "Nu poprobuju najti", "close_window", [
	#	#code start trakay_icon_quets
	#	(quest_set_slot, "qst_oim_trakay_icon", slot_quest_xp_reward, 100),
	#	(quest_set_slot, "qst_oim_trakay_icon", slot_quest_gold_reward, 100),
	#	(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 1),
	#	(quest_set_slot, "qst_oim_trakay_icon", slot_quest_giver_troop, "$g_talk_troop"),  
	#	(str_store_troop_name, s9, "$g_talk_troop"),	
	#	(str_store_party_name_link, s10, "p_town_4"),		
	#	(str_store_troop_name_link, s11, "trp_kingdom_1_pretender"),
	#	(setup_quest_text, "qst_oim_trakay_icon"),	
	#	(str_store_string, s2, "@OiM The elder {s9} said that the monk is in the {s10}. Try to talk to {s11}"),
	#	(try_begin),
	#		(neg|check_quest_active, "qst_oim_trakay_icon"),
	#		(call_script, "script_start_quest", "qst_oim_trakay_icon", "$g_talk_troop"),	
	#	(try_end),
 # ]],
#oim_trakai_icon_radzivil_talk  

  [anyone|plyr,"oim_trakai_icon_radzivil_talk", [], "Your worship, can you tell me where I might find the local Catholic priest?", "oim_trakai_icon_radzivil_talk_1", []],
  [anyone,"oim_trakai_icon_radzivil_talk_1", [], "What need have you of him, {sir/madam}?", "oim_trakai_icon_radzivil_talk_2", []],
  [anyone|plyr,"oim_trakai_icon_radzivil_talk_2", [], "I would like to confess my sins and receive holy communion.", "oim_trakai_icon_radzivil_talk_3", []],
  [anyone,"oim_trakai_icon_radzivil_talk_3", [], "Hah, an amusing thought... Our priest would rather hit you with his censer, such a firebrand is he. As for his whereabouts, I must confess I know nothing. -- Either he remained in the city or fled to Riga on one of the carts. Ask some of the townsfolk -- they may have seen him.", "close_window", [
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 2),  
		(str_store_party_name_link, s10, "p_town_4"),		
		(str_store_string, s2, "str_trakay_radz_descr"),  
		(add_quest_note_from_sreg, "qst_oim_trakay_icon", 4, s2, 1),
  ]],

#town_dweller_talk Vilno

  [anyone|plyr,"town_dweller_talk", [
		(eq, "$current_town", "p_town_4"),
		(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 2),
		(check_quest_active, "qst_oim_trakay_icon"), 
  ], "Do you know where the local priest is?", "oim_trakai_icon_town_dweller_talk", []],
  
  
  [anyone,"oim_trakai_icon_town_dweller_talk", [(eq, "$trakai_icon_town_dweller_talk", 0), (troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 0),], "No, mister, I know not...", "close_window", [(assign, "$trakai_icon_town_dweller_talk", 1), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_talk", [(eq, "$trakai_icon_town_dweller_talk", 1), (troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 0),], "The priest? He was here only yesterday... Held mass in the church. But as for now, I do not know where he is.", "close_window", [(assign, "$trakai_icon_town_dweller_talk", 2), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_talk", [(eq, "$trakai_icon_town_dweller_talk", 2), (troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 0),], "I am not of the Catholic faith, mister. I know nothing of the priest.", "close_window", [(assign, "$trakai_icon_town_dweller_talk", 3), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_talk", [(eq, "$trakai_icon_town_dweller_talk", 3), (troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 0),], "The priest? Heh, he fled to Riga with the carts yesterday. Sat on the cart holding some icon on his chest.", "close_window", [
  #code to change quest state
		#(str_store_party_name_link, s10, "p_town_12"),		
		#(str_store_troop_name_link, s11, "trp_knight_4_2"),
		#(setup_quest_text, "qst_oim_trakay_icon"),	
		#(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 3),
		#(str_store_string, s2, "@OiM The  dwellers said that the monk is in the {s10}. Try to talk to {s11}"),  
		#(add_quest_note_from_sreg, "qst_oim_trakay_icon", 4, s2, 1),
		
		(str_store_party_name_link, s10, "p_town_12"),		
		#(setup_quest_text, "qst_oim_trakay_icon"),	
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 4),
		(str_store_string, s2, "@OiM The  De la Gardi Said to ask dwellers in the {s10}. "),
		(add_quest_note_from_sreg, "qst_oim_trakay_icon", 4, s2, 1),
		
		(troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),
  ]],  

  [anyone,"oim_trakai_icon_town_dweller_talk", [(troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 1),], "You just asked me about the priest.", "close_window", []],  

  [anyone|plyr,"town_dweller_talk", [
		(eq, "$current_town", "p_town_12"),
		(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 0),
		(check_quest_active, "qst_oim_getman_tampliers_archives"), 
		(neg|check_quest_succeeded, "qst_oim_getman_tampliers_archives"), 
		(neg|check_quest_finished, "qst_oim_getman_tampliers_archives"), 
  ], "Could you tell me where I might find the archives?", "oim_getman_tampliers_archives_dweller_dlg", []],

  
#OiM trakai Icon De La Gardi talk  
  [anyone|plyr, "lord_talk",[(eq, "$g_talk_troop", "trp_knight_4_2"),
							(quest_get_slot, ":quest_current_state", "qst_oim_trakay_icon", slot_quest_current_state),
							(eq, ":quest_current_state", 3),
							], "I want to talk about the Catholic priest.", "oim_trakai_icon_delagardi_talk", []], 
  [anyone|plyr,"oim_trakai_icon_delagardi_talk", [], "Where can I find the priest of Vilna, sir?", "oim_trakai_icon_delagardi_talk_1", []],
  [anyone,"oim_trakai_icon_delagardi_talk_1", [], "You speak of the priest who arrived with the carts?", "oim_trakai_icon_delagardi_talk_2", []],
  [anyone|plyr,"oim_trakai_icon_delagardi_talk_2", [], "The very same.", "oim_trakai_icon_delagardi_talk_3", []],  
  [anyone,"oim_trakai_icon_delagardi_talk_3", [], "I heard complaints about him yesterday from the local priest at the cathedral. He said that as soon as that priest arrived he started a brawl with the clerics, then took off to a pub. As for me, I am a Protestant and keep out of Catholic affairs. I heard they were going to flog him, but felt pity for the sod and let him go.", "oim_trakai_icon_delagardi_talk_4", []],
  [anyone|plyr,"oim_trakai_icon_delagardi_talk_4", [], "So where would he be now?", "oim_trakai_icon_delagardi_talk_5", []],  
  [anyone,"oim_trakai_icon_delagardi_talk_5", [], "Talk to some of the locals, maybe they can tell you.", "close_window", [
	#code to change quets state
		(str_store_party_name_link, s10, "p_town_12"),		
		#(setup_quest_text, "qst_oim_trakay_icon"),	
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 4),
		(str_store_string, s2, "@OiM The  De la Gardi Said to ask dwellers in the {s10}. "),
		(add_quest_note_from_sreg, "qst_oim_trakay_icon", 4, s2, 1),
		(assign, "$g_leave_encounter",1),
  ]],  

  [anyone|plyr,"town_dweller_talk", [
							(check_quest_active, "qst_oim_trakay_icon"),
							(quest_slot_eq, "qst_oim_trakay_icon", slot_quest_current_state, 4),
  ], "Would you know where I might find the priest of Vilna?", "oim_trakai_icon_town_dweller_riga_talk", []],

  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(eq, "$trakai_icon_town_dweller_riga_talk", 0),], "I go to the kirche. I know nothing of the Catholic priest. Better ask the Catholics, mister.", "close_window", [(assign, "$trakai_icon_town_dweller_riga_talk", 1), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(eq, "$trakai_icon_town_dweller_riga_talk", 1),], "I don't know, mister.", "close_window", [(assign, "$trakai_icon_town_dweller_riga_talk", 2), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(eq, "$trakai_icon_town_dweller_riga_talk", 2),], "The priest? He was being questioned at the governor-general yesterday. But as for where he be now, goodness knows.", "close_window", [(assign, "$trakai_icon_town_dweller_riga_talk", 3), (troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1),]],
  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(eq, "$trakai_icon_town_dweller_riga_talk", 3),], "The priest of Vilna? That one who beat up the clerics? At the pub, I dare say.", "close_window", [
	(assign, "$trakai_icon_town_dweller_riga_talk", 4), 
	(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 5), 
	(troop_set_slot, "$g_talk_agent", slot_troop_met_previously, 1), 
	(str_store_string, s2, "str_monk_in_the_tavern"),
	(add_quest_note_from_sreg, "qst_oim_trakay_icon", 5, s2, 1),
  ]],	
  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(eq, "$trakai_icon_town_dweller_riga_talk", 4),], "And how should I know where the priest might be?", "close_window", []],  

  [anyone,"oim_trakai_icon_town_dweller_riga_talk", [(troop_slot_eq, "$g_talk_agent", slot_troop_met_previously, 1),], "Mister, stop harping that same string -- you asked me already.", "close_window", []],    
 #trp_oim_trakai_ksendz

  

  [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_1", [], "Are you not the priest of Vilna?", "oim_trakai_icon_town_dweller_riga_talk_2", []],		
  [anyone,"oim_trakai_icon_town_dweller_riga_talk_2", [], "And what if I am? Ah, what can I do for you, child? Would you mind treating this humble church minister to a few mugs of Riga beer? Word has it that the secret of this beer was brought here in times of old by Templar heretics...", "oim_trakai_icon_town_dweller_riga_talk_3", []],		
  [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_3", [], "Just wait one short moment with that beer, father. First tell me the whereabouts of that miraculous icon you purloined from Trakai?", "oim_trakai_icon_town_dweller_riga_talk_4", []],		
  [anyone,"oim_trakai_icon_town_dweller_riga_talk_4", [], "The what? What icon? I don't know anything about that. Yea, I took every valuable I owned as I left Vilna, but only to save it from the Muscovite schismatics who were about to raid the city. But I don't know anything about any icon.", "oim_trakai_icon_town_dweller_riga_talk_5", []],		
  [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_5", [], "So, holy father, what is that thing sticking out of that knapsack of yours?", "oim_trakai_icon_town_dweller_riga_talk_6", []],		
  [anyone,"oim_trakai_icon_town_dweller_riga_talk_6", [], "Verily I am my own greatest misfortune, Holy Mother of God! True, it's all true. I have the icon. But I'll not give it away, and if you should try taking it by force, you'll have only yourself to blame for what follows.", "oim_trakai_icon_town_dweller_riga_talk_7", []],		
   [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_7", [(eq, "$oim_trakai_icon_town_dweller_riga_talk_7_dengi", 0)], "Offer money to the priest...", "oim_trakai_icon_town_dweller_riga_talk_deneg", [(assign, "$oim_trakai_icon_town_dweller_riga_talk_7_dengi",1)]],		  
     [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_deneg", [
		(store_troop_gold, ":gold", "trp_player"), 
		(ge, ":gold", 150), 
	 ], "What if I give a certain amount for the needs of your church? Perhaps...", "oim_trakai_icon_town_dweller_riga_talk_deneg_1", []],		  
     [anyone,"oim_trakai_icon_town_dweller_riga_talk_deneg_1", [
	 #code to check if money if enough
	    (troop_get_slot, ":troop_renown", "trp_player", slot_troop_renown),
		(store_character_level, ":level", "trp_player"),		
		(assign, ":result", ":level"),
		(val_mul, ":result", ":troop_renown"),
		(val_mul, ":result", 4),
		(lt, ":result", 250), 
	 ], "Those pennies are not worth even the candle wax, while that miraculous icon -- why, that will draw many a hefty offering. You cannot bribe me so easily, child.", "oim_trakai_icon_town_dweller_riga_talk_deneg_negative", []],			
     [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_deneg_negative", [], "Truly your greed knows no limits, priest! May you burn in hell!", "oim_trakai_icon_town_dweller_riga_talk_2_loop_back", []],		  
     [anyone,"oim_trakai_icon_town_dweller_riga_talk_deneg_1", [
	    (troop_get_slot, ":troop_renown", "trp_player", slot_troop_renown),
		(store_character_level, ":level", "trp_player"),		
		(assign, ":result", ":level"),
		(val_mul, ":result", ":troop_renown"),
		(val_mul, ":result", 4),
		(ge, ":result", 250), 	 
	 ], "Verily you are as pious as you are charitable, child. Your offering has put me to shame. So be it, take the icon and carry it back to the schismatics. May they use it in their prayers -- not forget the good priest Spasokukotsky.", "oim_trakai_icon_town_dweller_riga_talk_deneg_positive", [
		(troop_remove_gold, "trp_player", 150),
	 ]],			
	 [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_deneg_positive", [], "One could hardly forget you, I say. Very well, give me the icon.", "close_window", [
        (quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 10),
		(call_script, "script_succeed_quest", "qst_oim_trakay_icon"),	 
	 ]],		  	
   [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_7", [(eq, "$oim_trakai_icon_town_dweller_riga_talk_7_ug", 0),], "Attempt to persuade the priest...", "oim_trakai_icon_town_dweller_riga_talk_ugovor", [(assign, "$oim_trakai_icon_town_dweller_riga_talk_7_ug",1)]],		  
	 [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_ugovor", [
	 #code to test positive
	    (troop_get_slot, ":troop_renown", "trp_player", slot_troop_renown),
		(store_character_level, ":level", "trp_player"),		
		(assign, ":result", ":level"),
		(val_mul, ":result", ":troop_renown"),
		(val_mul, ":result", 4),
		(ge, ":result", 250), 	 
	 ], "Think carefully, father. Do you really know nothing of my name? Have you never heard it in the streets -- or in the pubs?", "oim_trakai_icon_town_dweller_riga_talk_ugovor_pos", []],		  
     [anyone,"oim_trakai_icon_town_dweller_riga_talk_ugovor_pos", [], "I didn't quite catch your name... Ah, {playername} was it? Mary mother of Jesus, that's a horse of a different color! Heard of you, aye, heard quite a lot of you... Eh, 'tis so hard to part with such an icon. But what can I do -- an argument with you would only cost me dearly. Here, you should have it. Please, take it.", "oim_trakai_icon_town_dweller_riga_talk_ugovor_pos_1", []],			
     [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_ugovor_pos_1", [], "That's much better, father. 'Tis true what they say -- a good name and a good word weigh far more than a good word alone.", "close_window", [
        (quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 10),
		(call_script, "script_succeed_quest", "qst_oim_trakay_icon"),	 
	 ]],	
	 [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_ugovor", [
	 #code to test negative
 	    (troop_get_slot, ":troop_renown", "trp_player", slot_troop_renown),
		(store_character_level, ":level", "trp_player"),		
		(assign, ":result", ":level"),
		(val_mul, ":result", ":troop_renown"),
		(val_mul, ":result", 4),
		(neg|ge, ":result", 250), 	 
	 ], "Give me the icon, as a sign of respect.", "oim_trakai_icon_town_dweller_riga_talk_ugovor_neg", []],		  
     [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_ugovor_neg", [], "In case you heard me badly, my name is {playername}.", "oim_trakai_icon_town_dweller_riga_talk_ugovor_neg_1", []],			
     [anyone,"oim_trakai_icon_town_dweller_riga_talk_ugovor_neg_1", [], "And I am the priest Spasokukotsky. I know the governor-general well, whereas you I am only seeing for the first time today. So now go, for Heaven's sake -- you will not get anything from me!", "oim_trakai_icon_town_dweller_riga_talk_ugovor_neg_2", []],		  
	 [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_ugovor_neg_2", [], "Very well...", "oim_trakai_icon_town_dweller_riga_talk_2_loop_back", []],				
   [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_7", [], "Take it by force!", "oim_trakai_icon_town_dweller_riga_talk_siloy", []],		    
	 [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_siloy", [], "Give me that icon, you damned Cassock! Or you'll get it in the neck!", "oim_trakai_icon_town_dweller_riga_talk_siloy_1", []],		  	
	 [anyone,"oim_trakai_icon_town_dweller_riga_talk_siloy_1", [], "Murder! Robbery! A priest is beaten for his icon! Good Catholics, help!", "close_window", [
		(set_party_battle_mode),
		(try_for_agents, ":cur_agent"),
			(agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
			(try_begin),
				(eq, ":cur_agent_troop", "trp_oim_polish_taver_visitor"),
				(agent_set_team, ":cur_agent", 1),
			(try_end),
			(try_begin),
				(eq, ":cur_agent_troop", "trp_oim_trakai_ksendz"),
				(agent_set_team, ":cur_agent", 1),
			(try_end),
		(try_end),
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 6),		
   ]],				  
		

   [anyone|plyr,"oim_trakai_icon_town_dweller_riga_talk_7", [], "Leave the priest be. [Mission failed.]", "close_window", [
   #code to abondon quest
		(call_script, "script_fail_quest", "qst_oim_trakay_icon"),
   ]],		       

#OiM loop for quest tracay icon
	 [anyone,"oim_trakai_icon_town_dweller_riga_talk_2_loop_back", [], "Well, what now?", "oim_trakai_icon_town_dweller_riga_talk_7", []],				  	 
#OiM loop for quest tracay icon end

#oim_polish_taver_visitor
	[anyone|plyr,"oim_trakai_icon_tavern_talk", [], "You didn't find the priest?", "oim_trakai_icon_tavern_talk_1", []],		  
    	[anyone,"oim_trakai_icon_tavern_talk_1", [], "Keep your eyes open and you'll find him...", "close_window", []],				


    [anyone|plyr,"oim_tracai_icon_failed", [], "I couldn't find the icon. The priest vanished...", "oim_tracai_icon_failed_1", []],		  
	[anyone,"oim_tracai_icon_failed_1", [
		(call_script, "script_cf_select_random_village_with_faction", "fac_kingdom_2"),
		(assign, ":village", reg0),
		(str_store_party_name, s4, ":village"),
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_target_center, ":village"),
	], "Oh dear... Well, you had better get going. Whoever you're looking for has already left for {s4}.", "close_window", [
	#code finish quest
		(call_script, "script_change_player_relation_with_center", "$current_town", -7),
		(fail_quest, "qst_oim_trakay_icon"),
		(call_script, "script_end_quest", "qst_oim_trakay_icon"),	
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 2),
		(quest_get_slot, ":village", "qst_oim_dmitriy_gerasim", slot_quest_target_center),
		(str_store_party_name_link, s4, ":village"),
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_target_center, ":village"),
		(str_store_string, s5, "@OiM_getman No skazal chto Yavangelik v {s4}"),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_gerasim", 4, s5, 1),
	]],		

	
#OiM start dialog with zolotarenko
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start", [], "Greetings, brother Cossack. Where is it you're heading?", "oim_zolotarenko_bring_tataring_start_1", []],		       
	[anyone,"oim_zolotarenko_bring_tataring_start_1", [], "Greetings to you, stranger. I am Colonel Vasil Zolotarenko, and I am leading the Cossacks to aid the Tsar of Moscow, under the orders of the Hetman.", "oim_zolotarenko_bring_tataring_start_2", []],		
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start_2", [], "So it is true that Cossacks and Muscovites are now united against the Polish king?", "oim_zolotarenko_bring_tataring_start_3", []],		       
	[anyone,"oim_zolotarenko_bring_tataring_start_3", [], "Yes, 'tis true... You know the saying: even old men are strong in numbers. Thus our glorious hetman Bogdan Hmelnitski has made a bargain with the Muscovite Tsar -- together we shall beat the Poles! The orders of the Hetman are such that my regiment, together with marksman warlords, will take on the Polotsk. But meanwhile, in addition to the Poles -- may the devil take them! -- a new foe has appeared: the Crimean Khan.", "oim_zolotarenko_bring_tataring_start_4", []],		
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start_4", [], "What has the Khan of Crimea to do with this war? Crimea is a distant land, far away from Smolensk...", "oim_zolotarenko_bring_tataring_start_5", []],		       
	[anyone,"oim_zolotarenko_bring_tataring_start_5", [], "I see you know little of our local affairs... The Khan would not sit idly by as one of his neighbors gains overwhelming strength. Thus he sends spies to Lithuania, to see who would win this war -- and whom he should support.", "oim_zolotarenko_bring_tataring_start_6", []],		
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start_6", [], "And you have seen hide or hair of these Tatar spies?", "oim_zolotarenko_bring_tataring_start_7", []],		       
	[anyone,"oim_zolotarenko_bring_tataring_start_7", [], "Why, of course we have. We even caught one. Told us quite a lot, the infidel.", "oim_zolotarenko_bring_tataring_start_8", []],		
	[anyone,"oim_zolotarenko_bring_tataring_start_8", [], "Now we are looking for a loyal {man/lady}, one who might deliver to the Sich this infidel captive, along with the deed in which all that he told us is written. Perhaps you could aid us in this, friend?", "oim_zolotarenko_bring_tataring_start_9", []],			
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start_9", [], "Agree...", "oim_zolotarenko_bring_tataring_start_agreed", []],		       
		[anyone|plyr,"oim_zolotarenko_bring_tataring_start_agreed", [], "Would that I could, but I dare not take the journey alone, I fear.", "oim_zolotarenko_bring_tataring_start_agreed_1", []],		       	
		[anyone,"oim_zolotarenko_bring_tataring_start_agreed_1", [], "Truly spoken. The task is perilous, and the path is long. But if you should make up your mind to go, I shall give you money for your travel, and a pair of good, reliable Cossacks.", "oim_zolotarenko_bring_tataring_start_agreed_2", []],					
		[anyone|plyr,"oim_zolotarenko_bring_tataring_start_agreed_2", [], "Very well, Colonel. I shall set out at once to the Sich. Where is this infidel of yours?", "oim_zolotarenko_bring_tataring_start_agreed_3", []],		       	
		[anyone,"oim_zolotarenko_bring_tataring_start_agreed_3", [], "We're bringing him out now. Do not fail me, {playername}. The Sich of the Cossacks shall reward you in our traditional way. One more thing -- speak not to the infidel along the way. He speaks with the devil's tongue, and may bewilder and beguile anyone.", "close_window", [
		#code to start quest 
		    (quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_xp_reward, 100),
			(quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_gold_reward, 100),
			(quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_giver_troop, "$g_talk_troop"),  
			(str_store_troop_name, s9, "$g_talk_troop"),	
			(str_store_troop_name, s10, "trp_oim_tatarin_zolotarenko"),		
			(setup_quest_text, "qst_oim_bring_tatarin_to_sich"),	
			(str_store_string, s2, "@OiM The  {s9} asked you to bring {s10} to Sich"),
			(call_script, "script_start_quest", "qst_oim_bring_tatarin_to_sich", "$g_talk_troop"),	
			#(),
			(party_force_add_prisoners, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
			(party_add_members, "p_main_party", "trp_rhodok_sergeant", 2),
			(troop_add_item, "trp_player","itm_kozak_good_shablya",0),
			(call_script, "script_change_player_party_morale", 20),
			(assign, "$g_leave_encounter",1),
		]],					
	[anyone|plyr,"oim_zolotarenko_bring_tataring_start_9", [], "Refuse...", "oim_zolotarenko_bring_tataring_start_negative", []],		       	
		[anyone|plyr,"oim_zolotarenko_bring_tataring_start_negative", [], "Nay, colonel, escorting prisoners is not for me.", "oim_zolotarenko_bring_tataring_start_negative_1", []],		       		
		[anyone,"oim_zolotarenko_bring_tataring_start_negative_1", [], "As you wish. But know this: we Cossacks treat our friends with open arms, but those who are no friends of ours will find no quarter amongst us. Do not make a choice you will regret later.", "close_window", [
		#code for penalti
			#(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -5),
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -15),
		]],					


	[anyone,"oim_tatarin_first_talk", [], "Dear {sir/madam}, listen to me, for the love of Allah!", "oim_tatarin_first_talk_1", [(assign, "$talked_to_tatarin", 1)]],		
	[anyone|plyr,"oim_tatarin_first_talk_1", [], "What is it now?", "oim_tatarin_first_talk_2", []],		       
	[anyone,"oim_tatarin_first_talk_2", [], "Please -- untie my hands and give me water. I promise I shall not run away.", "oim_tatarin_first_talk_3", []],		
	[anyone|plyr,"oim_tatarin_first_talk_3", [], "Untie him and give him a drink...", "oim_tatarin_first_talk_4_1", []],		       
		[anyone|plyr,"oim_tatarin_first_talk_4_1", [], "All right, quit whimpering, I'll untie you. Here is the water flask.", "oim_tatarin_first_talk_4_2", []],		       
		[anyone,"oim_tatarin_first_talk_4_2", [], "Thank you, dear {sir/madam}. I thought I would die of thirst. To show you my thanks, I shall tell you something important.", "oim_tatarin_first_talk_6", []],		
	[anyone|plyr,"oim_tatarin_first_talk_3", [], "Leave the prisoner bound...", "oim_tatarin_first_talk_7", []],		       
		[anyone|plyr,"oim_tatarin_first_talk_7", [], "Be quiet. One more word and I'll chop off your head, Zolotarenko's orders be damned.", "oim_tatarin_first_talk_6_1", []],		       
		[anyone,"oim_tatarin_first_talk_6_1", [], "Don't be angry, {sir/madam}. Allow me to speak a few words to you in private. It's very important.", "oim_tatarin_first_talk_6", []],		
	[anyone|plyr,"oim_tatarin_first_talk_6", [], "Well, what is it? Speak, and be quick about it!", "oim_tatarin_first_talk_10", []],		       
	[anyone,"oim_tatarin_first_talk_10", [], "I notice you have little knowledge of local affairs. In the name of Allah the most merciful, I assure you that we, the servants of the Khan of Crimea, have betrayed no one and do not wish to attack anyone.", "oim_tatarin_first_talk_11", []],		
	[anyone|plyr,"oim_tatarin_first_talk_11", [], "Right, and the next thing you'll say is that the Cossacks betrayed you.", "oim_tatarin_first_talk_12", []],		       
	[anyone,"oim_tatarin_first_talk_12", [], "Verily so, mister! The Cossacks have made a brotherly bond with our sworn enemy, the Tsar of Moscow. After they wipe out the Polish Commonwealth, they shall turn their pistols towards Bakhchisaray, and bring war to our people.", "oim_tatarin_first_talk_13", []],		
	[anyone|plyr,"oim_tatarin_first_talk_13", [], "And how would you know that?", "oim_tatarin_first_talk_14", []],		       
	[anyone,"oim_tatarin_first_talk_14", [], "I posed as a merchant, and brought some carts to Bryansk. There I bribed a courier who was carrying a message from Hmelnitski to the Tsar. That letter explained all the treacherous plans of the Cossacks and the Muscovites.", "oim_tatarin_first_talk_15", []],		
	[anyone|plyr,"oim_tatarin_first_talk_15", [], "And you have this letter, I assume?", "oim_tatarin_first_talk_16", []],		       
	[anyone,"oim_tatarin_first_talk_16", [], "Yes, I made a precise copy of it. Here, read it.", "oim_tatarin_first_talk_17", []],		
	[anyone|plyr,"oim_tatarin_first_talk_17", [], "Hmm. Interesting things it says: ""...and afterwards, Your Highness, Tsar of Moscow, we shall gather our forces and march upon Crimea. You may take Bakhchisaray, Kafa and Azov, while I lay claim to Akkerman and Sugdeya. And once the Tatars have fallen, we shall visit our good friend, the Sultan of Istanbul..."" 'Tis well written, but I do not trust you. Had this deed the Hetman's seal, it would be quite another matter. But this you could easily have forged yourself.", "oim_tatarin_first_talk_18", []],		       
	[anyone,"oim_tatarin_first_talk_18", [], "Believe me, {playername}-bey!!! I swear by Allah this is all true. Free me, my good {man/lady}, and together let us deliver this terrible news to Perekop. The Mirza shall reward you greatly. Believe not the Cossacks, for they will deceive you.", "oim_tatarin_first_talk_19", []],		
	[anyone|plyr,"oim_tatarin_first_talk_19", [], "Do not trust the infidel...", "oim_tatarin_first_talk_19_neg", []],		       
		[anyone|plyr,"oim_tatarin_first_talk_19_neg", [], "Hey Cossacks! Give this godless heathen a taste of the whip. Tie him fast and put a piece of lard in his mouth, to still his dark speeches and dirty tongue.", "close_window", [
			(str_store_string, s2, "@OiM nu vot so shmatom sala budet tishe sebya vesti"),
			(quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 1),
		]],		       		
	[anyone|plyr,"oim_tatarin_first_talk_19", [], "I had best let him go, but steer myself out of harm's way.", "oim_tatarin_first_talk_19_otp", []],		       
		[anyone|plyr,"oim_tatarin_first_talk_19_otp", [], "Very well, Tatar. Your words have the ring of truth, but I do not wish to bring the anger of the Cossack Sich down upon my head. If you have any money hidden away, give it to me -- and then I will help you escape.", "oim_tatarin_first_talk_19_otp1", []],	
		[anyone,"oim_tatarin_first_talk_19_otp1", [], "There is some silver is inside my hat. Take it and leave me there by the tree. Then in a while, send pursuers after me. I will be far away by then.", "oim_tatarin_first_talk_19_otp2", []],				
		[anyone|plyr,"oim_tatarin_first_talk_19_otp2", [], "That is what I will do. Give me the hat.", "close_window", [
			(str_store_string, s2, "@OiM Kozaki zametii 4to vi predeli ih"),
			(call_script, "script_fail_quest", "qst_oim_bring_tatarin_to_sich"),
			(call_script, "script_troop_add_gold", "trp_player", 80),
			(party_remove_prisoners, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
		]],	
	[anyone|plyr,"oim_tatarin_first_talk_19", [], "I will bring the Tatar to Perekop. I badly need money right now, and this reward sounds most promising.", "oim_tatarin_first_talk_19_perekop", []],
		[anyone|plyr,"oim_tatarin_first_talk_19_perekop", [], "Very well, Tatar. You have convinced me. We head for Perekop. But forget not, the Mirza had better draw a hefty reward from his pouch...", "oim_tatarin_first_talk_19_perekop_1", []],	
		[anyone,"oim_tatarin_first_talk_19_perekop_1", [], "Not just the Mirza, but his serenity the Khan himself shall repay you for this noble deed. Give me a saber and a horse, and take me into your company.", "close_window", [
			(call_script, "script_fail_quest", "qst_oim_bring_tatarin_to_sich"),
			(party_add_members, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
			(party_remove_prisoners, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
		    (quest_set_slot, "qst_oim_bring_tatarin_to_perekop", slot_quest_xp_reward, 200),
			(quest_set_slot, "qst_oim_bring_tatarin_to_perekop", slot_quest_gold_reward, 1500),
			(quest_set_slot, "qst_oim_bring_tatarin_to_perekop", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_bring_tatarin_to_perekop", slot_quest_giver_troop, "$g_talk_troop"),  
			(str_store_troop_name, s9, "$g_talk_troop"),	
			(str_store_party_name_link, s10, "p_castle_17"),	
			(setup_quest_text, "qst_oim_bring_tatarin_to_perekop"),	
			(str_store_string, s2, "@OiM The {s9} asked you to bring him to {s10}"),
			(call_script, "script_start_quest", "qst_oim_bring_tatarin_to_perekop", "$g_talk_troop"),	
			(str_store_string, s2, "@OiM Kozaki zametili 4to vi predeli ih"),
	]],		       	
	
	[anyone,"oim_tatarin_loopback", [], "Why do we stop? The road is long. Let us get underway.", "close_window", []],

	[anyone,"oim_kozaks_tell_failur", [], "So this is how you keep your word to the Colonel! We shall ride to the Sich at once, and tell everyone of your betrayal! You shall pay for this!", "close_window", [
	#code
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -7),
		(party_remove_members, "p_main_party", "trp_rhodok_sergeant", 2),
		(assign, "$talked_to_tatarin", 2),
		(str_store_string, s2, "@OiM teper mozhno dalshe v put"),
		(call_script, "script_end_quest", "qst_oim_bring_tatarin_to_sich"),
	]],		

#trp_castle_17_seneschal	
	[anyone|plyr,"oim_bring_tataring_to_sich_sich_dlg", [], "Please, tell me -- to whom should I give the captive Tatar?", "oim_bring_tataring_to_sich_sich_dlg_1", []],	
	[anyone,"oim_bring_tataring_to_sich_sich_dlg_1", [], "Ah, him -- you should go to the Kosh Ataman, Pavlo Gomon. He is in charge of military matters.", "close_window", [
			(setup_quest_text, "qst_oim_bring_tatarin_to_sich"),	
			(str_store_string, s2, "@OiM Ischi teper yego Gomona to..."),
			(add_quest_note_from_sreg, "qst_oim_bring_tatarin_to_sich", 4, s2, 1),
			(quest_set_slot, "qst_oim_bring_tatarin_to_sich", slot_quest_current_state, 2),
	]],		

	[anyone|plyr,"oim_gomon_bring_tataring_start", [], "I have brought the Tatar spy whom Zolotarenko took captive near Smolensk.", "oim_gomon_bring_tataring_start_1", []],		       
	[anyone,"oim_gomon_bring_tataring_start_1", [], "You have arrived just in time. That infidel is of great importance.", "oim_gomon_bring_tataring_start_2", []],		
	[anyone|plyr,"oim_gomon_bring_tataring_start_2", [], "He is in the cart. Your Cossacks can find him there. But tell me, why is he so important?", "oim_gomon_bring_tataring_start_3", []],		       
	[anyone,"oim_gomon_bring_tataring_start_3", [], "Zolotarenko sent him as a sign. That infidel is our proof that the Crimean Khan is preparing to stab us in the back. This cannot be allowed to stand! We shall set forth at once! Here, take this gold for your faithful service. The Cossacks shall always remember this deed.", "close_window", [
		#code finish quest
		(call_script, "script_troop_add_gold", "trp_player", 100),
		(add_xp_as_reward, 200),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 7),
		(call_script, "script_end_quest", "qst_oim_bring_tatarin_to_sich"),	
		(party_remove_prisoners, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
	]],		


	[anyone,"oim_tatarin_end_qst_perekop", [], "Halt, Mirza! Quiet your dogs. Don't you recognize me? Speak not my name -- that is an order. Prepare a bath at once, and bring forth our finest female captives. Lay out a decorous dress -- a robe, wide trousers, a sash of Greek silk, and boots of the finest leather. And as for this valiant warrior, see that he is rewarded generously.", "oim_tatarin_end_qst_perekop_1", []],		
	[anyone|plyr,"oim_tatarin_end_qst_perekop_1", [], "Remember, I expect a hefty reward.", "oim_tatarin_end_qst_perekop_2", []],		       
	[anyone,"oim_tatarin_end_qst_perekop_2", [], "Here it is. We value your faithful service.", "oim_tatarin_end_qst_perekop_3", []],		
	[anyone|plyr,"oim_tatarin_end_qst_perekop_3", [], "So perhaps you have not deceived me. But why conceal your name, for the devil's sake?", "oim_tatarin_end_qst_perekop_4", []],		       
	[anyone,"oim_tatarin_end_qst_perekop_4", [], "Quiet. Speak not the shaitans' name in vain. And the time has not yet come for you to speak out my name either. If you wish to know it, come into the service of our Khan. A war is brewing, and we shall need good men like you. But for now, farewell.", "close_window", [
		(call_script, "script_troop_add_gold", "trp_player", 1500),
		(call_script, "script_end_quest", "qst_oim_bring_tatarin_to_perekop"),	
		(party_remove_members, "p_main_party", "trp_oim_tatarin_zolotarenko", 1),
		(assign, "$g_leave_encounter", 1),
		(assign, "$talked_to_tatarin2", 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],		

	
	#oim_start_quest_sem_samuraev	
	[anyone,"oim_start_quest_sem_samuraev", [], "Greetings, {sir/madam}. I have news of a job well-suited for one such as you. Some days ago, the peasants from the village of Sivash visited this town. They were looking to hire a small mercenary squad to protect them from bandits.", "oim_start_quest_sem_samuraev_1", []],		
	[anyone|plyr,"oim_start_quest_sem_samuraev_1", [], "Well then, perhaps you could extend your protection to them yourself?", "oim_start_quest_sem_samuraev_2", []],		       
	[anyone,"oim_start_quest_sem_samuraev_2", [], "Nay, I am a noble Bek. 'Tis no good for me to fight for such rewards as our pitiful peasantry have to offer. But it would be a fine job for you. And yes, they pay with their meager provisions, not with silver.", "oim_start_quest_sem_samuraev_3", []],		
	[anyone|plyr,"oim_start_quest_sem_samuraev_3", [], "So be it, I shall help the peasants.", "oim_start_quest_sem_samuraev_4", []],
		[anyone,"oim_start_quest_sem_samuraev_4", [], "Then waste no more time here. Find six warriors for your company and head to Sivash. You'll have a week.", "close_window", [
			(quest_set_slot, "qst_oim_sem_samuraev", slot_quest_xp_reward, 200),
			(quest_set_slot, "qst_oim_sem_samuraev", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_sem_samuraev", slot_quest_giver_troop, "trp_village_28_elder"),  
			(quest_set_slot, "qst_oim_sem_samuraev", slot_quest_expiration_days, 7),
			(str_store_troop_name, s9, "$g_talk_troop"),	
			(str_store_party_name_link, s10, "p_village_28"),	
			(setup_quest_text, "qst_oim_sem_samuraev"),	
			(store_character_level, ":level", "trp_player"),				
			(store_add, "$oim_sem_samuraev_soldiers_count", ":level", 4),
			(assign, reg(0), 6),
			(assign, reg(0), "$oim_sem_samuraev_soldiers_count"), 
			(str_store_string, s2, "@OiM The {s9} need to bring at least {reg0} troops to {s10}"),
			(call_script, "script_start_quest", "qst_oim_sem_samuraev", "$g_talk_troop"),	
			(assign, "$g_leave_encounter", 1),
		]],			
	[anyone|plyr,"oim_start_quest_sem_samuraev_3", [], "No, I shall only fight under the royal banners.", "oim_start_quest_sem_samuraev_5", []],		       
		[anyone,"oim_start_quest_sem_samuraev_5", [], "Do as you please. But even jobs such as this are not easy to come by.", "close_window", [(assign, "$g_leave_encounter", 1),]],		


	[anyone,"oim_sem_samuraev_defend_village", [
	#code check if everything is ok
		(party_get_num_companions, ":num_troops", "p_main_party"),	
		(neg|check_quest_failed, "qst_oim_sem_samuraev"),
		(ge, ":num_troops", "$oim_sem_samuraev_soldiers_count"),
	], "Allah be blessed! The bandits shall arrive soon. Help us to fend them off... We will reward you as best we can.", "close_window", [
		(str_store_string, s2, "@OiM Ne uspeli s conay slezt kak oni priperlis'"),
		(jump_to_menu, "mnu_oim_fight_sem_samuraev"),
		(finish_mission),
	]],
	
	[anyone,"oim_sem_samuraev_defend_village", [
		(check_quest_failed, "qst_oim_sem_samuraev"),
	], "You are late, warrior. The bandits have already come and gone... All our stores have been ransacked and looted.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
		(call_script, "script_end_quest", "qst_oim_sem_samuraev"),
	]],	
	
	[anyone,"oim_sem_samuraev_defend_village", [
		(party_get_num_companions, ":num_troops", "p_main_party"),	
		(neg|check_quest_failed, "qst_oim_sem_samuraev"),
		(lt, ":num_troops", "$oim_sem_samuraev_soldiers_count"),
		(assign, reg(0), "$oim_sem_samuraev_soldiers_count"), 
	], "Oh dear, I fear the worst! You have too few men. To deal with these bandits, you shall need no less than {reg0} warriors. Recruit a sufficient force and return.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
	]],			


#oim_pre_fight_dlg_sem_samuraev	
	[anyone,"oim_pre_fight_dlg_sem_samuraev", [], "Zdorovenki buly! We are busy looking after the officers of the Zaporozhian Host. At the Hetman's orders, we prepare food for his soldiers and fodder for their horses. I hope you are not here to hinder us, my good {man/lady}?", "oim_pre_fight_dlg_sem_samuraev_1", []],		
	[anyone|plyr,"oim_pre_fight_dlg_sem_samuraev_1", [], "But this is strange... Are you sure you are not mistaken, Cossack? That village is Tatar...", "oim_pre_fight_dlg_sem_samuraev_2", []],		       
	[anyone,"oim_pre_fight_dlg_sem_samuraev_2", [], "That's none of your bloody business. Do not interfere! Pass by in peace and leave. -- And if you will not go quietly, we shall drive you from here by force.", "oim_pre_fight_dlg_sem_samuraev_3", []],		
	[anyone|plyr,"oim_pre_fight_dlg_sem_samuraev_3", [], "Very well, do your worst!", "close_window", [
		(assign, "$oim_fight_sem_samuraev", 1),
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -3),		
		(str_store_string, s2, "@OiM Jaz budet jarko"),
	]],		       
	[anyone|plyr,"oim_pre_fight_dlg_sem_samuraev_3", [], "All right, Cossack. Tame yourself. If this is the Hetman's order, I will not hinder you.", "close_window", [
        (call_script, "script_change_player_relation_with_center", "$g_encountered_party", -20),
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_3", -3),		
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", 3),		
		(call_script, "script_fail_quest", "qst_oim_sem_samuraev"),
		(call_script, "script_end_quest", "qst_oim_sem_samuraev"),
        (call_script, "script_village_set_state",  "$current_town", svs_looted),

        (party_add_particle_system, "$current_town", "psys_map_village_fire"), #new
        (party_add_particle_system, "$current_town", "psys_map_village_fire_smoke"), #new
        (party_set_icon, "$current_town", "icon_village_burnt_a"), #new
        (party_set_slot, "$current_town", slot_village_smoke_added, 1), #new
		
        (party_set_slot, "$current_town", slot_village_raid_progress, 100), #was 0
        (party_set_slot, "$current_town", slot_village_recover_progress, 0),

		(call_script, "script_change_player_honor", -2),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(assign, "$g_leave_encounter", 1), 
	]],		       

	#oim_start_lendliz_dlg
	[anyone,"oim_start_lendliz_dlg", [], "Have you heard? The Don Cossacks are planning a raid on the Crimean Tatars. They ask that our father, the Tsar, aid them with provisions. Our Tsar is a kind man, and has ordered the mayor of Moscow to send iron and equipment for the Don. Would you deliver this for us?", "oim_start_lendliz_dlg_1", []],		
	[anyone|plyr,"oim_start_lendliz_dlg_1", [], "Why not yourself?", "oim_start_lendliz_dlg_2", []],		       
	[anyone,"oim_start_lendliz_dlg_2", [], "If the Tsar's carts were to travel to the Don, the Tatars would at once know everything. They have spies everywhere. But you -- it is doubtful that you would draw their attention.", "oim_start_lendliz_dlg_3", []],		
	[anyone|plyr,"oim_start_lendliz_dlg_3", [], "Very well, I agree. Where should I head?", "oim_start_lendliz_dlg_positive", []],		       
		[anyone,"oim_start_lendliz_dlg_positive", [], "Make your way to Moscow, and speak with the mayor. Give him this deed, and he will provide you with everything you need. The provisions you are to be delivered to the Ataman, Naum Vasiliev. Now make haste! Time is short.", "close_window", [
		#code to start dlg
		(quest_set_slot, "qst_oim_lendliz", slot_quest_xp_reward, 300),
		(quest_set_slot, "qst_oim_lendliz", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_lendliz", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_lendliz"),	
		(str_store_string, s2, "@OiM {s9} asked you visit moscow to give suppleis to donskie kazaki"),
		(call_script, "script_start_quest", "qst_oim_lendliz", "$g_talk_troop"),	
		(assign, "$g_leave_encounter", 1),
		]],		
	[anyone|plyr,"oim_start_lendliz_dlg_3", [], "I must refuse. I have much other work to do.", "oim_start_lendliz_dlg_neg", []],		       
	[anyone,"oim_start_lendliz_dlg_neg", [], "Very well, I cannot force you.", "close_window", []],		
	
	#oim_lendliz_giving_goods

	[anyone,"oim_lendliz_giving_goods", [], "So, let us see... Signature, seal -- everything in place. All right, take this and sign here. And remember: if the Tatars should learn of these carts, they will cut you to ribbons.", "oim_lendliz_giving_goods_1", []],		
	[anyone|plyr,"oim_lendliz_giving_goods_1", [], "They may find me no easy mark. Show me these goods of yours.", "close_window", [
	#code to add items
		(troop_add_items, "trp_player", "itm_iron", 6),	
		(troop_add_items, "trp_player", "itm_tools", 5),
		(troop_add_items, "trp_player", "itm_linen", 5),
		(str_store_troop_name_link, s6, "trp_knight_2_7"), 
		(quest_set_slot, "qst_oim_lendliz", slot_quest_current_state, 1),
		(str_store_string, s5, "@OiM_Potop nuzhno peredat ih teper {s6}"),	
		(quest_set_slot, "qst_oim_potop_alias", slot_quest_current_state, 1),
		(add_quest_note_from_sreg, "qst_oim_lendliz", 4, s5, 1),
	]],		       
	
	
	
	
	#oim_lendliz_talk_to_naum
	[anyone,"oim_lendliz_talk_to_naum", [], "At last!", "oim_lendliz_talk_to_naum_2", []],		
	[anyone|plyr,"oim_lendliz_talk_to_naum_2", [], "Here, look.", "oim_lendliz_talk_to_naum_3", []],		       
	[anyone,"oim_lendliz_talk_to_naum_3", [], "But these are mere provisions. We asked for arms!", "oim_lendliz_talk_to_naum_4", []],		
	[anyone|plyr,"oim_lendliz_talk_to_naum_4", [], "I brought what I was told to bring. Take it, and let us part ways amicably.", "oim_lendliz_talk_to_naum_5", []],		       
	[anyone,"oim_lendliz_talk_to_naum_5", [], "Nay, this will not do! I care not how, but you must bring us pistols and sabers. A week I give you! No more.", "oim_lendliz_talk_to_naum_5_new", []],		

	[anyone|plyr,"oim_lendliz_talk_to_naum_5_new", [], "And what am I to do?", "oim_lendliz_talk_to_naum_5_new_1", []],		       
	[anyone,"oim_lendliz_talk_to_naum_5_new_1", [], "I have a plan. Men that I trust have reported that a cart laden with arms has recently set out to Bakhchisaray. You must capture it!", "oim_lendliz_talk_to_naum_5_new_2", []],		
	[anyone|plyr,"oim_lendliz_talk_to_naum_5_new_2", [], "And what if I fail?", "oim_lendliz_talk_to_naum_5_new_3", []],		       
	[anyone,"oim_lendliz_talk_to_naum_5_new_3", [], "You shall not fail, and to be sure of this, I shall give you two Cossacks.", "oim_lendliz_talk_to_naum_5_new_4", []],		
	[anyone|plyr,"oim_lendliz_talk_to_naum_5_new_4", [], "Well, I'll see what I can do. I shall try to catch that cart!", "oim_lendliz_talk_to_naum_5_new_5", []],		       
	[anyone,"oim_lendliz_talk_to_naum_5_new_5", [], "Good then. Take the lads and march out.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_lendliz"),
		(troop_remove_items, "trp_player", "itm_iron", 6),	
		(troop_remove_items, "trp_player", "itm_tools", 5),
		(troop_remove_items, "trp_player", "itm_linen", 5),
		#(call_script, "script_end_quest", "qst_oim_lendliz"),
		(quest_set_slot, "qst_oim_lendliz2", slot_quest_xp_reward, 200),
		(quest_set_slot, "qst_oim_lendliz2", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_lendliz2", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_party_name_link, s10, "p_town_16"),	
		(str_store_party_name_link, s11, "p_town_14"),	
		(setup_quest_text, "qst_oim_lendliz2"),	
		(str_store_string, s2, "@OiM {s9} asked you to bring 2 tureckih mushketa da 2 kozackih shabli"),
		(call_script, "script_start_quest", "qst_oim_lendliz2", "$g_talk_troop"),	
		#spawn corovan
		#tp_oim_merchant_caravan
		#adding help troops
		(set_spawn_radius,0),
        (spawn_around_party,"p_town_16", "pt_oim_merchant_caravan"),
        (assign, "$oim_lendliz_caravan", reg0),
		(party_set_faction, "$oim_lendliz_caravan", "fac_commoners"
		#this peace of code needs testing
		),
		(party_set_slot, "$oim_lendliz_caravan", slot_party_type, spt_kingdom_caravan),
		(party_set_slot, "$oim_lendliz_caravan", slot_party_ai_state, spai_undefined),
		(party_set_ai_behavior, "$oim_lendliz_caravan", ai_bhvr_travel_to_party),
		(party_set_ai_object, "$oim_lendliz_caravan", "p_town_14"),
		(party_set_flags, "$oim_lendliz_caravan", pf_default_behavior, 0),
		(troop_set_slot, "trp_caravan_master", slot_troop_leaded_party, "$oim_lendliz_caravan"),
		(party_add_leader, "$oim_lendliz_caravan", "trp_caravan_master"),
		(store_sub, ":item_to_price_slot", slot_town_trade_good_prices_begin, trade_goods_begin),
		(try_for_range, ":cur_goods", trade_goods_begin, trade_goods_end),
			(store_add, ":cur_goods_price_slot", ":cur_goods", ":item_to_price_slot"),
			(party_set_slot, "$oim_lendliz_caravan", ":cur_goods_price_slot", average_price_factor),
		(try_end),
		(troop_set_slot, "trp_caravan_master", slot_troop_wealth, 4000),
		(party_add_members, "$oim_lendliz_caravan", "trp_caravan_guard", 10), 	
		(party_add_members, "$oim_lendliz_caravan", "trp_hired_blade", 6), 	
		(party_add_members, "$oim_lendliz_caravan", "trp_mercenary_crossbowman", 2), 	
		(party_add_members, "$oim_lendliz_caravan", "trp_merc_reytar", 1), 	
		(party_force_add_members, "p_main_party", "trp_don_cossack", 2), 	
	]],		
	
	#oim_don_cossaks_responce	
	[anyone,"oim_don_cossaks_responce", [
		(check_quest_failed, "qst_oim_lendliz2"),
	], "Damn you! What have you done, you worthless fool? You've let the foe slip clear away. I shall go at once to the Ataman, and tell him of your incompetence...", "close_window", [
		(call_script, "script_end_quest", "qst_oim_lendliz2"),
		(party_remove_members, "p_main_party", "trp_don_cossack", 3),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],		
	
	[anyone,"oim_don_cossaks_responce", [], "Ha! Our sabers cut them down quite nicely! And look at all our trophies! Well, I and my man will take the cart, and return to the Ataman. And to you I wish godspeed!", "close_window", [
		(party_remove_members, "p_main_party", "trp_don_cossack", 3),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			
	
	[anyone,"oim_lendliz_talk_to_naum2", [], "On behalf of all the hosts of the Don, thank you for your faithful aid, {playername}. Oh, we shall meet the Tatars with a great battle. Here, you have well earned your reward.", "oim_lendliz_talk_to_naum_2_1", [
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_2", 6),		
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 15),
		(call_script, "script_end_quest", "qst_oim_lendliz2"),
		(call_script, "script_troop_add_gold", "trp_player", 650),
		(add_xp_as_reward, 400),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],		
	
	[anyone|plyr,"oim_lendliz_talk_to_naum_2_1", [], "Thank you as well, Ataman. And now I shall depart.", "oim_lendliz_talk_to_naum_2_2", []],		       
	[anyone,"oim_lendliz_talk_to_naum_2_2", [], "There is one more thing. I have received a report that the captive Tatar escaped. He saw you in the camp, and will no doubt tell his people that it was you who supplied us with our arms. I tell you this, that you will be wary and prepared for the Tatars' revenge.", "oim_lendliz_talk_to_naum_2_3", [
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_3", -5),		
	]],		
	[anyone|plyr,"oim_lendliz_talk_to_naum_2_3", [], "Thank you for the warning. Well, no one can stand in the way of one who walks the path of the righteous. Let us wish each other the best. Farewell!", "close_window", [(assign, "$g_leave_encounter", 1),]],		       

	
	
	#oim_start_quest_monfor_shved
	
	[anyone,"oim_start_quest_monfor_shved", [], "Word has it that the Chevalier de Clermont has arrived in these lands. Have you met him?", "oim_start_quest_monfor_shved_1", []],		
	[anyone|plyr,"oim_start_quest_monfor_shved_1", [], "Clermont I know. What of it?", "oim_start_quest_monfor_shved_2", []],		       
	[anyone,"oim_start_quest_monfor_shved_2", [], "He is to be found at once and brought to our king.", "oim_start_quest_monfor_shved_3", []],		
	[anyone|plyr,"oim_start_quest_monfor_shved_3", [], "And why would Carl Gustaf be interested in this man?", "oim_start_quest_monfor_shved_4", []],		       
	[anyone,"oim_start_quest_monfor_shved_4", [], "Jaques de Clermont may be in disfavor with the French court, but the Prime Minister of France, Cardinal Mazarin, still regards him with favor. Our king would like to enlist the Cardinal's support, and he requires a trusted messenger to discuss the matter with Clermont.", "oim_start_quest_monfor_shved_5", []],		
	[anyone|plyr,"oim_start_quest_monfor_shved_5", [], "But why so urgent? And could you not simply approach Clermont on your own?", "oim_start_quest_monfor_shved_6", []],		       
	[anyone,"oim_start_quest_monfor_shved_6", [], "Bogdan Hmelnitski wishes to arrange his own agreement with Mazarin. Once he discovers that we have enlisted Clermont to our service, he shall stop supporting us in our war with the Polish Commonwealth. Therefore we need a little-known mediator.", "oim_start_quest_monfor_shved_7", []],		
	[anyone|plyr,"oim_start_quest_monfor_shved_7", [], "Agree...", "oim_start_quest_monfor_shved_8", []],		       
		[anyone|plyr,"oim_start_quest_monfor_shved_8", [], "I presume the reward would amount to more than the kind favors of the Swedish royalty?", "oim_start_quest_monfor_shved_9", []],		       
		[anyone,"oim_start_quest_monfor_shved_9", [], "The Swedish crown generously rewards its loyal servants. Here, take this. It should be enough to whet your appetite.", "oim_start_quest_monfor_shved_11", [(call_script, "script_troop_add_gold", "trp_player", 100),]],	
		[anyone|plyr,"oim_start_quest_monfor_shved_11", [], "Where should I look for him?", "oim_start_quest_monfor_shved_12", []],		       
		[anyone,"oim_start_quest_monfor_shved_12", [], "Scour the cities, look in the pubs. Inquire any passer-by. Perhaps one will have some clue.", "close_window", [
		#code to start quest
		(quest_set_slot, "qst_oim_monfor_shved", slot_quest_xp_reward, 200),
		(quest_set_slot, "qst_oim_monfor_shved", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_monfor_shved", slot_quest_giver_troop, "trp_kingdom_4_lord"),  
		(quest_set_slot, "qst_oim_monfor_shved", slot_quest_expiration_days, 14),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_monfor_shved"),	
		(str_store_string, s2, "@OiM {s9} asked you to bring to king Shveden the Monfor"),
		(call_script, "script_start_quest", "qst_oim_monfor_shved", "$g_talk_troop"),	
		(assign, "$g_leave_encounter", 1),
		(try_for_parties, ":party"),
	        (party_is_active, ":party"),
			(party_get_template_id, ":cur_party_template", ":party"),
			(eq, ":cur_party_template", "pt_oim_monfor_party"),
			(call_script, "script_cf_oim_remove_party", ":party"), 
		(try_end), 
	]],		

	[anyone|plyr,"oim_start_quest_monfor_shved_7", [], "Refuse...", "oim_start_quest_monfor_shved_13", []],		       
		[anyone|plyr,"oim_start_quest_monfor_shved_13", [], "I'd be better swinging my saber. Courtly intrigue is not for me...", "oim_start_quest_monfor_shved_14", []],		       
		[anyone,"oim_start_quest_monfor_shved_14", [], "Do as you please. But know this -- the favor of the king is not easily granted, but quite easily taken.", "close_window", [(assign, "$g_leave_encounter", 1),]],		

 
	#oim_monfor_talk_shved_start
	[anyone|plyr,"oim_monfor_talk_shved_start", [], "I have an invitation for you from the king of Sweden. Join my party, and we shall make our way together to Karl Gustaf.", "oim_monfor_talk_shved_start_1", [(quest_set_slot, "qst_oim_monfor_shved", slot_quest_current_state, 1), ]],		       
	[anyone,"oim_monfor_talk_shved_start_1", [], "I am glad to see you in good health. A herald of Bogdan Hmelnitski came to us the other day. He had with him five trained warriors -- a clear sign that he is a man to be reckoned with. When you have at least ten men at your command, then we shall talk. Now make haste, or I will make my way to the Cossacks.", "close_window", [
		(quest_set_slot, "qst_oim_monfor_shved_army", slot_quest_xp_reward, 200),
		(quest_set_slot, "qst_oim_monfor_shved_army", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_monfor_shved_army", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_monfor_shved_army"),	
		(str_store_string, s2, "@OiM {s9} asked you to bring at least 10 soldiers with you to go to the king"),
		(call_script, "script_start_quest", "qst_oim_monfor_shved_army", "$g_talk_troop"),	
		(assign, "$g_leave_encounter", 1),
	]],		
	
	
	#oim_monfor_talk_shved_soldiers
	
	[anyone|plyr,"oim_monfor_talk_shved_soldiers", [], "About my offer...", "oim_monfor_talk_shved_soldiers_1", []],		       
	[anyone,"oim_monfor_talk_shved_soldiers_1", [], "You have gathered your troops?", "oim_monfor_talk_shved_soldiers_2", []],		
	[anyone|plyr,"oim_monfor_talk_shved_soldiers_2", [
		(party_get_num_companions, ":num_troops", "p_main_party"),	
		(ge, ":num_troops", 10),
	], "Yea, here they are, all weathered fighters.", "oim_monfor_talk_shved_soldiers_2_pos", []],		 
	[anyone,"oim_monfor_talk_shved_soldiers_2_pos", [], "Well, that changes matters. Travelling with such a company is an honor. Let us go then to the king. As for the Cossacks, you may deal with them yourself...", "close_window", [
		(quest_set_slot, "qst_oim_monfor_shved", slot_quest_giver_troop, "trp_kingdom_4_lord"),
		(call_script, "script_succeed_quest", "qst_oim_monfor_shved"),
		(call_script, "script_end_quest", "qst_oim_monfor_shved_army"),
		(party_force_add_members, "p_main_party", "trp_oim_monfor", 1),
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -2),
	]],			
	[anyone|plyr,"oim_monfor_talk_shved_soldiers_2", [], "Alas, not all of them.", "oim_monfor_talk_shved_soldiers_3", []],		       
	[anyone,"oim_monfor_talk_shved_soldiers_3", [], "Well then get a move on, the Cossacks come to me nigh every day...", "close_window", []],		
	

	#oim_monfor_talk_shved_king
	#party_count_members_of_type 
	[anyone,"oim_monfor_talk_shved_king", [], "What is it, {sir/madam}?", "oim_monfor_talk_shved_king_1", []],		
	[anyone|plyr,"oim_monfor_talk_shved_king_1", [
	#code test
		#(party_count_members_of_type, ":count", "p_main_party", "trp_oim_monfor"), 
		#(ge, ":count", 1), 
	], "I have arrived with the Chevalier de Clermont, Sire. It is said that you wished to speak with him.", "oim_monfor_talk_shved_king_1_pos", []],		       
		[anyone,"oim_monfor_talk_shved_king_1_pos", [], "Yes, this is true. Call him in, quickly. Your services shall be rewarded.", "close_window", [
			(call_script, "script_end_quest", "qst_oim_monfor_shved"),
			(party_remove_members, "p_main_party", "trp_oim_monfor", 1), 
			(assign, "$g_leave_encounter", 1),
			(call_script, "script_troop_add_gold", "trp_player", 350),
			(set_spawn_radius, 1),
			(spawn_around_party, "p_town_13", "pt_oim_monfor_party"),
			(assign, ":oim_monfor_party", reg0),
			(party_add_members, ":oim_monfor_party", "trp_oim_monfor", 1),
			(party_add_members, ":oim_monfor_party", "trp_nord_champion", 10),
			(party_set_ai_behavior, ":oim_monfor_party", ai_bhvr_patrol_party),
			(party_set_ai_object, ":oim_monfor_party", "p_town_13"),
			(party_set_flags, ":oim_monfor_party", pf_default_behavior, 0),
			(party_set_ai_patrol_radius, ":oim_monfor_party", 5),
		]],		
	[anyone|plyr,"oim_monfor_talk_shved_king_1", [(eq, 0, 1),], "I have come to pay my respects.", "oim_monfor_talk_shved_king_1_neg", []],		       
		[anyone,"oim_monfor_talk_shved_king_1_neg", [], "Very well. Now go, I have much to do.", "close_window", [(assign, "$g_leave_encounter", 1),]],		


	#oim_start_quest_mest_i_zakon_dlg
	[anyone,"oim_start_quest_mest_i_zakon_dlg", [], "I have a simple task for you, my good {man/lady}. Someone must to go to the Cossack village of Maslov Brod, and cause there such violence and mayhem that even the grandsons of their pathetic serfs will tremble with fear in recalling that day.", "oim_start_quest_mest_i_zakon_dlg_1", []],		
	[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_1", [], "And what is this village guilty of, that it would so enrage the Polish crown?", "oim_start_quest_mest_i_zakon_dlg_2", []],		       
	[anyone,"oim_start_quest_mest_i_zakon_dlg_2", [], "Every last homestead has sent their able men to aid those damned Zaporozhian rebels. But that is merely half the reason. The Ukrainian serfs require a lesson in power, that the rest would learn to dread the very idea of supporting Hmelnitski.", "oim_start_quest_mest_i_zakon_dlg_3", []],		
	[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_3", [], "So what, the valiant soldiers of His Royal Majesty cannot fulfill this brutal duty?", "oim_start_quest_mest_i_zakon_dlg_4", []],		       
	[anyone,"oim_start_quest_mest_i_zakon_dlg_4", [], "Sending in the royal hosts would be... lacking in finesse. Nay, far better to enlist a warrior who has no name for himself. In this way, we might teach all those who might stand against the Polish Commonwealth that we have the support of every man who can mount a horse and draw a blade.", "oim_start_quest_mest_i_zakon_dlg_5", []],		
	[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_5", [], "Agree...", "oim_start_quest_mest_i_zakon_dlg_pos", []],
		[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_pos", [], "Well, if such is the will of His Majesty, then so be it.", "oim_start_quest_mest_i_zakon_dlg_pos1", []],		       
		[anyone,"oim_start_quest_mest_i_zakon_dlg_pos1", [], "Perfect! Hurry to Maslov Brod and give those villains a good thrashing. Whatever loot you find is yours to take. And here, take this as well, as payment for deeds well done.", "close_window", [
			(quest_set_slot, "qst_mest_i_zakon", slot_quest_xp_reward, 200),
			(quest_set_slot, "qst_mest_i_zakon", slot_quest_current_state, 0),
			(quest_set_slot, "qst_mest_i_zakon", slot_quest_giver_troop, "$g_talk_troop"),  
			(str_store_troop_name_link, s9, "$g_talk_troop"),	
			(str_store_party_name_link, s10, "p_village_84"),	
			(setup_quest_text, "qst_mest_i_zakon"),	
			(quest_set_slot, "qst_mest_i_zakon", slot_quest_expiration_days, 45),
			(call_script, "script_troop_add_gold", "trp_player", 50),
			(str_store_string, s2, "@OiM {s9} asked you to burn and loot {s10}"),
			(call_script, "script_start_quest", "qst_mest_i_zakon", "$g_talk_troop"),	
			(assign, "$g_leave_encounter", 1),
		]],		
	[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_5", [], "Refuse...", "oim_start_quest_mest_i_zakon_dlg_neg", []],		       
		[anyone|plyr,"oim_start_quest_mest_i_zakon_dlg_neg", [], "This matter is not to my liking. I pray you find someone else.", "oim_start_quest_mest_i_zakon_dlg_neg1", []],		       
		[anyone,"oim_start_quest_mest_i_zakon_dlg_neg1", [], "'Tis your call, but know that the Polish gentry forgives not a lazy hand.", "close_window", [
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -15),
			(assign, "$g_leave_encounter", 1),
		]],		
	#oim_elder_talk_maslovbrod

	[anyone,"oim_elder_talk_maslovbrod", [], "What are you up to, my good {man/lady}?", "oim_elder_talk_maslovbrod_1", []],		
	[anyone|plyr,"oim_elder_talk_maslovbrod_1", [], "Nothing much... Though I do not mind a bit of loot and plunder...", "oim_elder_talk_maslovbrod_2", []],		       
	[anyone,"oim_elder_talk_maslovbrod_2", [], "There can be no doubt 'twas the damned Poles that sent you. By Christ, please just leave us in peace. You had best know that Maslov Brod is no mere village. It is here, on the shores of Rosava, that the great Hetman Bogdan Hmelnitski gathers all the Starshiny, the Cossack leaders, whenever they are preparing a major campaign.", "oim_elder_talk_maslovbrod_3", []],		
	[anyone|plyr,"oim_elder_talk_maslovbrod_3", [], "And why should this concern me?", "oim_elder_talk_maslovbrod_4", []],		       
	[anyone,"oim_elder_talk_maslovbrod_4", [], "Hmelnitski shall never tolerate such plunder. If you do not wish the Hetman as your worst enemy, then you had best be on your way.", "oim_elder_talk_maslovbrod_5", []],		
	[anyone|plyr,"oim_elder_talk_maslovbrod_5", [], "So that's what this is about... No one told me this! And what shall you tell your Hetman if I turn away from your village now?", "oim_elder_talk_maslovbrod_6", []],		       
	[anyone,"oim_elder_talk_maslovbrod_6", [], "If you should leave in peace, we would tell the Hetman of your noble act. Believe us, Hmelnitski can be very gracious.", "oim_elder_talk_maslovbrod_7", []],		
	[anyone|plyr,"oim_elder_talk_maslovbrod_7", [], "Continue plundering...", "oim_elder_talk_maslovbrod_loot", []],		       
		[anyone|plyr,"oim_elder_talk_maslovbrod_loot", [], "Pardon me, but I already took my share.", "close_window", [
			(call_script, "script_change_player_relation_with_center", "$g_encountered_party", -30),
			(jump_to_menu, "mnu_village_start_attack"),
			(finish_mission),
		]],		       
	[anyone|plyr,"oim_elder_talk_maslovbrod_7", [], "Do not plunder...", "oim_elder_talk_maslovbrod_neg", []],		       
		[anyone|plyr,"oim_elder_talk_maslovbrod_neg", [], "You convinced me. I shall not bother you.", "oim_elder_talk_maslovbrod_neg1", []],		       
		[anyone,"oim_elder_talk_maslovbrod_neg1", [], "Our gratitude shall never be forgotten! This very day I shall send a messenger to Hmelnitski, to speak of your generosity.", "close_window", [
			(quest_set_slot, "qst_mest_i_zakon", slot_quest_current_state, 1), 
			(quest_get_slot, ":lord", "qst_mest_i_zakon", slot_quest_giver_troop), 
			(call_script, "script_change_player_relation_with_troop", ":lord", -20),
			(call_script, "script_fail_quest", "qst_mest_i_zakon"),
			(quest_set_slot, "qst_mest_i_zakon2", slot_quest_current_state, 0),
			(quest_set_slot, "qst_mest_i_zakon2", slot_quest_giver_troop, "$g_talk_troop"), 
			(str_store_troop_name, s9, "$g_talk_troop"),	
			(setup_quest_text, "qst_mest_i_zakon2"),	
			(str_store_string, s2, "@OiM {s9} skazal chto pohlopochet pered gretnanom za to chto ti sdelal"),
			(call_script, "script_start_quest", "qst_mest_i_zakon2", "$g_talk_troop"),	
			(jump_to_menu, "mnu_auto_return_to_map"),
			(finish_mission),
		]],		

	#qst_mest_i_zakon3_talk
	[anyone,"qst_mest_i_zakon3_talk", [], "So you are that Polish lickspittle who agreed to burn and plunder Maslov Brod for a handful of silver? You shall regret that dark deed.", "close_window", [
		(assign, "$cant_leave_encounter", 1),
		#(call_script, "script_fail_quest", "qst_mest_i_zakon3"),
		(call_script, "script_end_quest", "qst_mest_i_zakon3"),
		(encounter_attack),
	]],		
	
	[anyone,"qst_mest_i_zakon2_talk", [], "I heard that you were called to plunder Maslov Brod, but spared the good village. It is a place dear to my heart, and I thank you for staying your hand. Let me convey to you the gratitude of the Hetman, and this well-packed purse.", "lord_pretalk", [
	#code to finish quest
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", 6),		
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 5),
		(call_script, "script_end_quest", "qst_mest_i_zakon2"),
		(call_script, "script_troop_add_gold", "trp_player", 250),
		(add_xp_as_reward, 900),
		#(assign, "$g_leave_encounter", 1),
	]],		
	
#	qst_mest_i_zakon_talk_end
	[anyone,"qst_mest_i_zakon_talk_end", [], "Excellent job, {playername}! Now these serfs shall know that the Polish Commonwealth will forgive no insult!", "qst_mest_i_zakon_talk_end_1", []],		
	[anyone|plyr,"qst_mest_i_zakon_talk_end_1", [], "That is well, but I have raised the anger of the Hetman, and I fear his retribution.", "lord_pretalk", [
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_5", -7),		
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", 6),		
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 15),
		(call_script, "script_end_quest", "qst_mest_i_zakon"),
		(call_script, "script_troop_add_gold", "trp_player", 650),
		(add_xp_as_reward, 300),
		(assign, "$g_leave_encounter", 1),
	]],
	
	[anyone,"qst_mest_i_zakon_talk_end_2", [], "The task is failed, and now the king is angered. You shall not be pardoned for this!", "lord_pretalk", [
	#code to finish quest
		(call_script, "script_end_quest", "qst_mest_i_zakon"),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -15),
	]],		

	#
	[anyone,"oim_qst_kidalovo_z_konyem_dlg", [], "Could you perhaps do me a small favor, {sir/madam}? The task is this: we had planned to give our ruler a pure-bred stallion, but alas, war has called and I cannot deliver the beast. Can you convey the animal to him in my stead?", "oim_qst_kidalovo_z_konyem_dlg_1", []],		
	[anyone|plyr,"oim_qst_kidalovo_z_konyem_dlg_1", [], "Agree...", "oim_qst_kidalovo_z_konyem_dlg_pos", []],		       
		[anyone|plyr,"oim_qst_kidalovo_z_konyem_dlg_pos", [], "Very well, I would not shy from taking this job.", "oim_qst_kidalovo_z_konyem_dlg_pos2", []],		       
		[anyone,"oim_qst_kidalovo_z_konyem_dlg_pos2", [], "Here is the stallion, and here is the money for his keeping. Know this -- if you should lose the steed, or fail to deliver it in time, you'll have only yourself to blame for what follows.", "close_window", [
			(faction_get_slot, ":king", "$g_talk_troop_faction", slot_faction_leader), 
			(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_target_troop, ":king"), 
			(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_expiration_days, 14),
			(call_script, "script_troop_add_gold", "trp_player", 150),
			(troop_add_item, "trp_player","itm_hunter"),
			(str_store_troop_name_link, s9, "$g_talk_troop"),	
			(str_store_troop_name_link, s10, ":king"),	
			(setup_quest_text, "qst_oim_kidalovo_z_konyem"),	
			(str_store_string, s2, "@OiM {s9} asked to bring horse to {s10}"),
			(call_script, "script_start_quest", "qst_oim_kidalovo_z_konyem", "$g_talk_troop"),	
			(assign, "$g_leave_encounter", 1),
		]],		
	[anyone|plyr,"oim_qst_kidalovo_z_konyem_dlg_1", [], "Refuse...", "oim_qst_kidalovo_z_konyem_dlg_neg", []],		       
		[anyone|plyr,"oim_qst_kidalovo_z_konyem_dlg_neg", [], "I am honored to hear that you would wish to bestow such an important task upon me... But alas, I have no time to play nurse to a horse.", "oim_qst_kidalovo_z_konyem_dlg_neg_1", []],		       
		[anyone,"oim_qst_kidalovo_z_konyem_dlg_neg_1", [], "The decision is yours. I shall find myself another who can aid me in this.", "close_window", [(assign, "$g_leave_encounter", 1),]],		


	#oim_horse_ambush_dlg
	[anyone,"oim_horse_ambush_dlg", [], "Well hello, wayfarer! Why such a hurry? What is it that troubles you?", "oim_horse_ambush_dlg_1", []],		
	[anyone|plyr,"oim_horse_ambush_dlg_1", [], "And who are you to ask that?", "oim_horse_ambush_dlg_2", []],		       
	[anyone,"oim_horse_ambush_dlg_2", [], "Who am I? Why, I am a freedom fighter, at your service. -- And the keeper of this road, too.", "oim_horse_ambush_dlg_3", []],		
	[anyone|plyr,"oim_horse_ambush_dlg_3", [], "What is that supposed to mean?", "oim_horse_ambush_dlg_4", []],		       
	[anyone,"oim_horse_ambush_dlg_4", [], "No need for rude words, wayfarer. Better show us what you have in the cart, now.", "oim_horse_ambush_dlg_5", []],		
	[anyone|plyr,"oim_horse_ambush_dlg_5", [], "In the cart be arms, and I assure you I can use them...", "oim_horse_ambush_dlg_6", [(assign, "$oim_fight_horse", 1),]],		       
	[anyone,"oim_horse_ambush_dlg_6", [], "Then we shall just have to see about that...", "close_window", [[encounter_attack]]],		

	#oim_horse_ambush_dlg2
	[anyone,"oim_horse_ambush_dlg2", [], "I believe not my eyes! Verily a royal steed you have, my good {man/lady}. To possess such a treasure, a {man/woman} must be able to wield his saber with great skill. Perhaps we shall take it!", "close_window", [
			(troop_remove_items, "trp_player", "itm_hunter", 1),
			(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_current_state, 1),
			(assign, "$g_leave_encounter", 1),
			(finish_mission),
			(jump_to_menu, "mnu_auto_return_to_map"),
	]],		
	
	#oim_horse_delivered_dlg
	[anyone|plyr,"oim_horse_delivered_dlg", [], "{sire/madam}, I brought you a modest gift from the local nobles.", "oim_horse_delivered_dlg_1", []],		       
	[anyone,"oim_horse_delivered_dlg_1", [], "What a beautiful stallion! Truly my subjects must love me, if they bring such gifts. But it is taking a great risk, travelling these roads with such a horse. Here, take this for your troubles.", "close_window", [
		(troop_remove_items, "trp_player", "itm_hunter", 1),
		(call_script, "script_troop_add_gold", "trp_player", 150),
		(add_xp_as_reward, 300),
		(quest_get_slot, ":lord", "qst_oim_kidalovo_z_konyem", slot_quest_giver_troop), 
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 5),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
		(call_script, "script_change_player_relation_with_troop", ":lord", 15),
		(call_script, "script_change_player_honor", 1), 
		(quest_set_slot, "qst_oim_kidalovo_z_konyem", slot_quest_expiration_days, -1),
		(call_script, "script_end_quest", "qst_oim_kidalovo_z_konyem"),
		(assign, "$g_leave_encounter", 1),						
	]],		
	
	#oim_start_quest_invest_dlg
		[anyone,"oim_start_quest_invest_dlg", [], "Aye, I have an errand for you, {sir/madam}. As you may know, the treasury of the Cossack Hetmanate is empty... Yet we have a hidden cache at Dunayevtsy, which we keep for such occasions. You are to take these monies from their elder there, and deliver it to Hetman Hmelnitski.", "oim_start_quest_invest_dlg_1", []],		
	[anyone|plyr,"oim_start_quest_invest_dlg_1", [], "A simple job. Why not send one of your men?", "oim_start_quest_invest_dlg_2", []],		       
	[anyone,"oim_start_quest_invest_dlg_2", [], "Nobody must know of it. Therefore has the Cossack Starshina have decided to bestow the task upon an unknown man. Should the Tatars or, God forbid, the Poles find out about it, they would wage an assault in full strength, and take the money for themselves.", "oim_start_quest_invest_dlg_answ", []],		
		[anyone|plyr,"oim_start_quest_invest_dlg_answ", [], "Agree...", "oim_start_quest_invest_dlg_pos1", []],
		[anyone,"oim_start_quest_invest_dlg_pos1", [], "Set yourself out then, and do not tarry. The Hetman will offer a reward that befits the task.", "oim_start_quest_invest_dlg_pos2", []],		
		[anyone|plyr,"oim_start_quest_invest_dlg_pos2", [], "But how will the elder recognize me?", "oim_start_quest_invest_dlg_pos3", []],		       
		[anyone,"oim_start_quest_invest_dlg_pos3", [], "The password is the motto that Cardinal Richelieu ordered written upon the cannons.", "close_window", [
		#code to start qst 
			(assign, "$g_leave_encounter", 1),
			(quest_set_slot, "qst_oim_invest", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_invest", slot_quest_current_state, 0),
			(str_store_troop_name_link, s9, "$g_talk_troop"),	
			(str_store_party_name_link, s10, "p_village_4"),	
			(setup_quest_text, "qst_oim_invest"),
			(str_store_string, s2, "@As {s9} said to get money from {s10}."),
			(call_script, "script_start_quest", "qst_oim_invest", "$g_talk_troop"),
		]],		
	[anyone|plyr,"oim_start_quest_invest_dlg_answ", [], "Refuse...", "oim_start_quest_invest_dlg_neg", []],		       
		[anyone|plyr,"oim_start_quest_invest_dlg_neg", [], "I fear this task is not for me.", "oim_start_quest_invest_dlg_neg1", []],		       
		[anyone,"oim_start_quest_invest_dlg_neg1", [], "Well then, we shall just have to find someone more brave and resolute.", "close_window", []],		

	#lord_talk
	[anyone|plyr,"lord_talk", [
		(check_quest_active,"qst_oim_invest"),
		(neg|check_quest_finished,"qst_oim_invest"),
		(quest_slot_eq, "qst_oim_invest", slot_quest_current_state, 0), 
	], "Could you tell me, what is the motto that Cardinal Richelieu ordered written on the cannons?", "oim_invest_get_pass_lord", []],		       
	[anyone,"oim_invest_get_pass_lord", [(is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"),], "With fire and sword! Everyone knows that.", "close_window", [(assign, "$g_leave_encounter", 1),(assign,"$oim_oim_answ",1),]],		
	[anyone,"oim_invest_get_pass_lord", [(is_between, "$g_talk_troop", "trp_knight_2_1", "trp_knight_2_20"),], "I have heard of it from the French mercenaries. ""Ultima ratio regnum"" -- the final argument of kings.", "close_window", [(assign, "$g_leave_encounter", 1),(assign,"$oim_sarin_answ",1),]],		
	[anyone,"oim_invest_get_pass_lord", [(is_between, "$g_talk_troop", "trp_knight_3_1", "trp_knight_3_20"),], "On cannons? It is probably ""si vis pacem, para bellum"" -- if you wish for peace, prepare for war.", "close_window", [(assign, "$g_leave_encounter", 1), (assign,"$oim_budmo_answ",1),]],		
	[anyone,"oim_invest_get_pass_lord", [(is_between, "$g_talk_troop", "trp_knight_4_1", "trp_knight_4_20"),], "What could a French Cardinal order? ""Dura lex, sed lex"" -- the law is harsh, but it is the law.", "close_window", [(assign, "$g_leave_encounter", 1), (assign,"$oim_budmo_answ",1),]],		
	[anyone,"oim_invest_get_pass_lord", [(is_between, "$g_talk_troop", "trp_knight_5_1", "trp_knight_5_20"),], "With Fire & Sword!", "close_window", [(assign, "$g_leave_encounter", 1),(assign,"$oim_oim_answ",1),]],		
	[anyone,"oim_invest_get_pass_lord", [], "Why should I care...", "lord_pretalk", [(assign, "$g_leave_encounter", 1),]],			

	
	#oim_get_money_invest_dlg
	[anyone|plyr,"oim_get_money_invest_dlg", [], "Sir, I come to you under orders of the Cossack Starshina. I have been instructed to collect the money and to bring it to Bogdan Khmelnytsky.", "oim_get_money_invest_dlg_1", []],		
	[anyone,"oim_get_money_invest_dlg_1", [], "What are you going on about, my good {man/lady}? I know nothing of this.", "oim_get_money_invest_dlg_2", []],		       
	[anyone|plyr,"oim_get_money_invest_dlg_2", [], "Hmm, let's see, there must be some kind of password...", "oim_get_money_invest_dlg_answ", []],		
		[anyone|plyr,"oim_get_money_invest_dlg_answ", [(eq, "$oim_sarin_answ",1),], "Ultima ratio regnum!", "oim_get_money_invest_dlg_answ_rgth", []],		       
		[anyone|plyr,"oim_get_money_invest_dlg_answ", [], "Si vis pacem, para bellum!", "oim_get_money_invest_dlg_answ_neg", []],		       
		[anyone|plyr,"oim_get_money_invest_dlg_answ", [(eq, "$oim_budmo_answ",1),], "Dura lex, sed lex!", "oim_get_money_invest_dlg_answ_neg", []],		       
		[anyone|plyr,"oim_get_money_invest_dlg_answ", [], "Homo homini lupus est!", "oim_get_money_invest_dlg_answ_neg", []],		       	
		[anyone|plyr,"oim_get_money_invest_dlg_answ", [(eq, "$oim_oim_answ",1),], "With fire and sword!", "oim_get_money_invest_dlg_answ_neg", []],		       		
	
	[anyone,"oim_get_money_invest_dlg_answ_neg", [], "Have you lost your mind, my good {man/lady}? Enough of this nonsense, and give your poor tongue a rest. You'd better be on your way... I know nothing of a password -- and nothing of the Starshina either. If you keep pestering me, I will have to call my sons. -- They'll teach you to bother an old man!", "close_window", []],		
	
	[anyone,"oim_get_money_invest_dlg_answ_rgth", [], "Lord be praised, you're the one we have been waiting for. I had feared the fiends already learned of our hidden cache. Here, friend, take everything, and may your ride be swift. The Cossacks await you.", "oim_get_money_invest_dlg_answ_rgth_1", [
		(call_script, "script_troop_add_gold", "trp_player", 15000),
		(quest_set_slot, "qst_oim_invest", slot_quest_giver_troop, "trp_kingdom_5_lord"), 
		(call_script, "script_succeed_quest", "qst_oim_invest"),
		(call_script, "script_end_quest", "qst_oim_invest"),#new		
		(quest_get_slot, ":invest_quest_giver_troop", slot_quest_giver_troop, "qst_oim_invest_2"),
		(quest_set_slot, "qst_oim_invest_2", slot_quest_giver_troop, ":invest_quest_giver_troop"),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s10, "trp_kingdom_5_lord"),	
		(setup_quest_text, "qst_oim_invest_2"),
		(quest_set_slot, "qst_oim_invest_2", slot_quest_expiration_days, 30),
		(str_store_string, s2, "str_give_the_money_you_took_from_s9_to_s10"),
		(call_script, "script_start_quest", "qst_oim_invest_2", "trp_kingdom_5_lord"),
	]],		
	[anyone|plyr,"oim_get_money_invest_dlg_answ_rgth_1", [], "This one hell of a secret cache! With this, one could buy up your whole village...", "close_window", [
	#code_to_change
		(quest_set_slot, "qst_oim_invest", slot_quest_current_state, 1),
	]],		       	
	
	#qst_oim_invest_finish
	[anyone|plyr,"qst_oim_invest_finish", [], "I brought you something, Hetman.", "qst_oim_invest_finish_1", []],		
	[anyone,"qst_oim_invest_finish_1", [], "For a long time I have been waiting, friend.", "qst_oim_invest_finish_2", []],		       
	[anyone|plyr,"qst_oim_invest_finish_2", [], "Here is everything the elder gave me...", "qst_oim_invest_finish_3", []],		
	[anyone,"qst_oim_invest_finish_3", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 15000), 
	], "Good! We shall buy powder, arms and provisions... And send the Poles running for the hills! The gratitude of all the Zaporozhian Host is yours, and along with it -- a tightly-packed purse as your reward.", "close_window", [
	#code to end quest		
		(troop_remove_gold, "trp_player", 15000),
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		(add_xp_as_reward, 600),
		(quest_get_slot, ":quest_giver_lord", "qst_oim_invest_2", slot_quest_giver_troop), 
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 5),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 15),
		(call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", 15),
		(call_script, "script_change_player_honor", 2), 
		(call_script, "script_end_quest", "qst_oim_invest_2"),
		(assign, "$g_leave_encounter", 1),	
	]],		       
	[anyone,"qst_oim_invest_finish_3", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(lt, ":cur_gold", 15000), 
	], "That cannot be all there was! Where is the rest?", "qst_oim_invest_finish_3_fail", []],		
	[anyone|plyr,"qst_oim_invest_finish_3_fail", [], "Do not be cross, Hetman. The road is long -- and I endured some expenses...", "qst_oim_invest_finish_3_fail_1", []],		
	[anyone,"qst_oim_invest_finish_3_fail_1", [
	    (store_troop_gold, ":cur_gold", "trp_player"),
		(lt, ":cur_gold", 12000),
	], "Hey Cossacks, throw this scoundrel in a cage! That will teach him to go carousing with Cossack gold.", "close_window", [
			(quest_get_slot, ":quest_giver_lord", "qst_oim_invest_2", slot_quest_giver_troop), 
	    	(store_troop_gold, ":cur_gold", "trp_player"),     		
			(try_begin),
			  (lt, ":cur_gold", 3000), 
			  (call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", -12),
			  (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -24),			  
			  (call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", -12),
			  (call_script, "script_change_player_honor", -3), 
			(else_try),
			  (lt, ":cur_gold", 6000), 
			  (call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", -8),
			  (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -16),			  
			  (call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", -8),
			  (call_script, "script_change_player_honor", -2), 
			(else_try),
			  (lt, ":cur_gold", 9000), 
			  (call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", -4),
			  (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -8),			  
			  (call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", -4),
			  (call_script, "script_change_player_honor", -1), 
			(else_try),
			  (call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", -2),
			  (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -4),			  
			  (call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", -2),
			  (call_script, "script_change_player_honor", -1), 
			(try_end),
			(call_script, "script_fail_quest", "qst_oim_invest_2"),
			(call_script, "script_end_quest", "qst_oim_invest_2"),
			(assign, "$g_player_is_captive", 1),
			(assign,"$auto_menu",-1),
			(store_troop_gold, ":cur_gold", "trp_player"),
			(troop_remove_gold, "trp_player", ":cur_gold"),
			(assign, "$capturer_party", "$g_encountered_party"),
			(jump_to_menu, "mnu_captivity_castle_taken_prisoner"),
			(finish_mission),
			(assign, "$g_leave_encounter", 1),	
		]],		       
		[anyone,"qst_oim_invest_finish_3_fail_1", [], "Your time is running out! I will let you go this one time because you haven't spent too much of the money. But we'll be watching you. Bring me 15000 thaler or we will hunt you down.", "close_window", [
		  (quest_get_slot, ":quest_giver_lord", "qst_oim_invest_2", slot_quest_giver_troop), 
	      (call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -2),
	      (call_script, "script_change_player_relation_with_troop", ":quest_giver_lord", -2),			  
		]],
	
	#oim_rekomendaciya_k_trubeckomu
	[anyone,"oim_rekomendaciya_k_trubeckomu", [], "Well, greetings, {playername}. Truth be said, I did not expect to see you still alive.", "oim_rekomendaciya_k_trubeckomu_1", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_1", [], "I am glad to see you as well. Thank you for aiding me when we first met. Now I am a weathered man, but I still wonder what is to come.", "oim_rekomendaciya_k_trubeckomu_2", []],		       
	[anyone,"oim_rekomendaciya_k_trubeckomu_2", [], "A loner always walks a difficult road. Without affluent patrons or personal riches, neither glory or power come easy. Have you not pondered over whether you shall join one of the warring parties?", "oim_rekomendaciya_k_trubeckomu_3", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_3", [], "Yea, I have pondered it. Yet how shall I earn the favor of the high and mighty?", "oim_rekomendaciya_k_trubeckomu_4", []],		       
	[anyone,"oim_rekomendaciya_k_trubeckomu_4", [], "Choose your side and fight in their battles. Then you shall swiftly learn who are your friends and foes. But to gain the patronage of kings, magnates, and commanders, you shall have to earn quite a fair name... a better name than you have now.", "oim_rekomendaciya_k_trubeckomu_5", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_5", [], "How then can I earn a fair name, as you say?", "oim_rekomendaciya_k_trubeckomu_6", []],		       
	[anyone,"oim_rekomendaciya_k_trubeckomu_6", [], "Take up different tasks. Take me for instance -- even now I ride to France on a secret mission bestowed upon me by the Tsar of Moscow himself.", "oim_rekomendaciya_k_trubeckomu_7", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_7", [], "Counsel me, whom should I approach for such jobs?", "oim_rekomendaciya_k_trubeckomu_8", []],		       
	[anyone,"oim_rekomendaciya_k_trubeckomu_8", [], "Well, you may be in luck. I have recently received a patent from Prince Trubetskoi. He is at war in Lithuania, and is gathering gallant men to his cause. If you so desire, I might compose a letter of credence to him, on your behalf.", "oim_rekomendaciya_k_trubeckomu_9", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_9", [], "That is a fine offer. Let me think over it.", "oim_rekomendaciya_k_trubeckomu_10", []],		       
	[anyone,"oim_rekomendaciya_k_trubeckomu_10", [], "Very well -- make haste! The road lies open before you!", "oim_rekomendaciya_k_trubeckomu_11", []],		
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_11", [], "Agree...", "oim_rekomendaciya_k_trubeckomu_pos1", []],		       
		[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_pos1", [], "So be it. Write the letter and tell me where to find the prince.", "oim_rekomendaciya_k_trubeckomu_pos2", []],		       
		[anyone,"oim_rekomendaciya_k_trubeckomu_pos2", [], "The Muscovite forces have invaded Lithuania, and are preparing to lay siege to Vilna. Alexei Trubetskoi is commanding the least capable of their regiments. -- They have not won a single battle against the gentry! Make your way to Vilna, there you shall find him, and if not -- ask the Moscow warlords you will meet on the way. They should be able to give you some direction.", "oim_rekomendaciya_k_trubeckomu_pos3", []],		
		[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_pos3", [], "Thank you and farewell.", "close_window", [
			#code to start qst
			(quest_set_slot, "qst_oim_trubeckoy_rekomendation", slot_quest_giver_troop, "trp_oim_monfor"), 
			(quest_set_slot, "qst_oim_trubeckoy_rekomendation", slot_quest_current_state, 0),
			(str_store_troop_name, s9, "trp_oim_monfor"),	
			(str_store_troop_name_link, s10, "trp_knight_2_10"),	
			(setup_quest_text, "qst_oim_trubeckoy_rekomendation"),
			(str_store_string, s2, "@As {s9} give you a recomendation to {s10}."),
			(call_script, "script_start_quest", "qst_oim_trubeckoy_rekomendation", "trp_oim_monfor"),
			(assign, "$g_leave_encounter", 1),
		]],		       
	[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_11", [], "Refuse...", "oim_rekomendaciya_k_trubeckomu_neg", []],		       
		[anyone|plyr,"oim_rekomendaciya_k_trubeckomu_neg", [], "I think I shall not go to the Muscovite Prince, but approach another man instead.", "oim_rekomendaciya_k_trubeckomu_neg_1", []],	
		[anyone,"oim_rekomendaciya_k_trubeckomu_neg_1", [], "As you wish. You might serve the Zaporozhians, the Swedes or even the Poles if you like. None would be disgraceful, for in this war, every regent has a truth of his own. My only advice is not to delay in your choosing.", "close_window", [(assign, "$g_leave_encounter", 1),]],		       
	

	
	[anyone|plyr,"lord_talk", [
		(check_quest_active,"qst_oim_trubeckoy_rekomendation"),
		(neg|check_quest_finished,"qst_oim_trubeckoy_rekomendation"),
		(eq, "$g_talk_troop", "trp_knight_2_10"),
	], "I come from Clermont.", "oim_trubeckoy_rekomendation_dlg", []],		
	[anyone|plyr,"oim_trubeckoy_rekomendation_dlg", [], "I have a letter of credence from the Chevalier de Clermont, Prince.", "oim_trubeckoy_rekomendation_dlg_1", [
		(call_script, "script_end_quest", "qst_oim_trubeckoy_rekomendation"),
	]],		
	[anyone,"oim_trubeckoy_rekomendation_dlg_1", [], "Let me see... So, Clermont writes that you are a {man/woman} who can be trusted. This is good. These days, we are recovering the lands that were taken from the Rus during the Time of Troubles, together with our Cossack brothers.", "oim_trubeckoy_rekomendation_dlg_2", []],		       
	[anyone,"oim_trubeckoy_rekomendation_dlg_2", [], "Laying siege to towns is no easy task. The longer it lasts, the more provisions their villagers smuggle in for them, and this is something we cannot allow to happen. You are to ravage no less than three villages of the Polish Commonwealth -- such is your first assignment. Forget not that their peasants are also our enemies.", "oim_trubeckoy_rekomendation_dlg_3", []],		       
	[anyone|plyr,"oim_trubeckoy_rekomendation_dlg_3", [], "I shall accept the task.", "oim_trubeckoy_rekomendation_dlg_4", []],		
		[anyone|plyr,"oim_trubeckoy_rekomendation_dlg_4", [], "This is my kind of job, Prince! I hear that the British monarchs gave out patents that permitted their men to attacking enemy settlements during their wars with Spain. Therefore I am no bandit, but a land-bound privateer!", "oim_trubeckoy_rekomendation_dlg_5", []],		
		[anyone,"oim_trubeckoy_rekomendation_dlg_5", [], "A filibuster of the Tsar, I would say. Now head out for the hunt, and good luck!", "close_window", [
			(quest_set_slot, "qst_oim_tzr_korsar", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_tzr_korsar", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_tzr_korsar", slot_quest_expiration_days, 21),
			(str_store_troop_name_link, s9, "$g_talk_troop"),	
			(setup_quest_text, "qst_oim_tzr_korsar"),	
			(str_store_string, s2, "@OiM {s9} asked to loot at least 3 caravans"),
			(assign, "$oim_villages_looted_count", 0), 
			(call_script, "script_start_quest", "qst_oim_tzr_korsar", "$g_talk_troop"),
			(assign, "$g_leave_encounter", 1),			
		]],		       
	[anyone|plyr,"oim_trubeckoy_rekomendation_dlg_3", [], "I fear I must say no. Waging war on the peasantry is not for me.", "oim_trubeckoy_rekomendation_dlg_neg", []],		
		[anyone|plyr,"oim_trubeckoy_rekomendation_dlg_neg", [], "Would you happen to have another job, Prince?", "oim_trubeckoy_rekomendation_dlg_neg_1", []],		
		[anyone,"oim_trubeckoy_rekomendation_dlg_neg_1", [], "He who seeks to earn the trust of the Moscow Tsar shall obey any order without question. Ours is a mighty nation, not a squabbling aristocracy. Now begone before I order to put you in jail.", "close_window", [
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -10),
			(assign, "$g_leave_encounter", 1),
		]],		       
	
	[anyone|plyr,"lord_talk", [
		(check_quest_active,"qst_oim_tzr_korsar"),
		(check_quest_succeeded,"qst_oim_tzr_korsar"),
		(neg|check_quest_finished,"qst_oim_tzr_korsar"),
		(eq, "$g_talk_troop", "trp_knight_2_10"),
	], "I want to talk about the assignment...", "oim_trubeckoy_korsar_dlg_1", []],	
	[anyone|plyr,"oim_trubeckoy_korsar_dlg_1", [], "The task is complete, Prince! The villages have been ravaged, and none shall dare to bring goods into the Polish towns. You may go boldly forth and lay your siege.", "oim_trubeckoy_korsar_dlg_2", []],		       
	[anyone,"oim_trubeckoy_korsar_dlg_2", [], "I am grateful for your services, {playername}! Now I can see that Clermont was right -- one can entrust you with important matters.", "close_window", [
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 6),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
		(call_script, "script_end_quest", "qst_oim_tzr_korsar"),
		(assign, "$g_leave_encounter", 1),
	]],		

	#OiM potop storyline
	#lord_find_zagloba_dlg
		
	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"),
		(store_random_in_range, ":rand", 0, 100),
		(ge, ":rand", 40), 
	], "Gather your men, your assemble allies, and attack the Swedish forces.", "close_window", [(assign, "$g_leave_encounter", 1),]],		       
	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"),
		(store_random_in_range, ":rand", 0, 100),
		(lt, ":rand", 80), 
	], "My advice to you -- befriend a famous warrior, Colonel Zagloba. He will no doubt know what to do.", "close_window", [
		(quest_set_slot, "qst_oim_potop_find_zagloba", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_find_zagloba", slot_quest_current_state, 0),
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_find_zagloba"),
		(str_store_string, s2, "@OIM_add {s9} asked you to find Pan Zagloba"),
		(call_script, "script_start_quest", "qst_oim_potop_find_zagloba", "$g_talk_troop"),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 1),	
		(assign, "$oim_can_recruit_zagloba", 1), 
		(assign, "$g_leave_encounter", 1),]],		       
	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_2_1", "trp_knight_2_20"),	
	], "Go now to the Tsar of Moscow. He alone can overcome the Swedes.", "close_window", [(assign, "$g_leave_encounter", 1),]],		       	
	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_3_1", "trp_knight_3_20"),	
	], "Word has came to me that the Polish king aims to ally with the Tatars. You might assist in this alliance.", "close_window", [(assign, "$g_leave_encounter", 1),]],		       
	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_4_1", "trp_knight_4_20"),	
	], "I fear it is all over for the Polish Commonwealth. My advice is to swear an oath of allegiance to the king of Sweden while you still can.", "close_window", [(assign, "$g_leave_encounter", 1),]],		       	

	[anyone,"lord_find_zagloba_dlg", [
		(is_between, "$g_talk_troop", "trp_knight_5_1", "trp_knight_5_20"),	
	], "Hey, what did you say?!", "lord_find_zagloba_dlg_kozak", []],		       	

	[anyone,"lord_find_zagloba_dlg", [
	], "I am busy.", "lord_pretalk", [(assign, "$g_leave_encounter", 1),]],		       	
	
	[anyone|plyr,"lord_find_zagloba_dlg_kozak", [], "Only joking...", "close_window",[(assign, "$g_leave_encounter",1)]],
		[anyone|plyr,"lord_find_zagloba_dlg_kozak", [], "Well, I wanted to aid the Poles...", "close_window",[
			#(assign, "$g_cant_leave_encounter", 1), 
			(assign, "$cant_leave_encounter", 1),
			(encounter_attack),
		]],
		
	#oim_zagloba_finded
	[anyone|plyr,"oim_zagloba_finded", [], "Could it be the famed Colonel Zagloba, scourge of those who stand against the Polish Commonwealth?", "oim_zagloba_finded_1", []],		       
	[anyone,"oim_zagloba_finded_1", [], "Oh aye, the very same! And indeed I have carved down countless foes. Were there hairs enough on my head to count those I've brought down by my own hand, the barber would make a fortune trimming my forelock. The devil take me if I lie...", "oim_zagloba_finded_2", []],		
	[anyone|plyr,"oim_zagloba_finded_2", [], "Colonel Zagloba, I wish to call you to my side, to join me in my campaign against the Swedes.", "oim_zagloba_finded_3", []],		       
	[anyone,"oim_zagloba_finded_3", [], "The Swedes you say? If my feet were grown into the ground like roots, only then would I not go -- and even so I'd tear them from the earth. I have a mighty craving for Swedish meat! How I dream of tasting it once more, as a wolf thirsts for lamb! Oh, what scoundrels they are! Fleas must've got into their little stockings and bit their legs, so they won't sit still at home like they should. Instead they like to wander onto foreign lands, where they've got no business...", "close_window", [
		#(call_script, "script_succeed_quest", "qst_oim_potop_find_zagloba"),
		(call_script, "script_end_quest", "qst_oim_potop_find_zagloba"),
		(call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
		#setting up potop controlling variables
		(store_current_day, "$oim_potop_last_qst_time"),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 2),
	]],	

	[anyone,"oim_zagloba_help_answer", [(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 2),], "You haven't enough glory and you've not smelled enough gunpowder. The trust of the king wouldn't hurt, either. Ah, and one more thing -- the support of the gentry. If some gentry man gives you an errand, take it. But be aware, shall you fail, no laurels will fall to you.", "close_window", [
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 3),
	]],		

	[anyone,"oim_zagloba_auto_help", [
		(check_quest_active, "qst_oim_potop_main"),
		(neg|check_quest_finished,"qst_oim_potop_main"),
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 2), 
	], "I want to give you a piece of advice.", "oim_zagloba_help_answer", [
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 3), 
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		]],		       	
	
    [anyone,"oim_lord_sp_task", [
		(is_between, "$g_talk_troop", "trp_knight_1_1", "trp_knight_1_20"),
		#(troop_slot_ge, "$g_talk_troop", slot_troop_player_relation, 10), 
		(check_quest_active, "qst_oim_potop_main"),
		(neg|check_quest_finished,"qst_oim_potop_main"),
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 3), 
		#(store_distance_to_party_from_party, ":cur_dist", "$g_talk_troop", "trp_kingdom_1_lord"),
		#(gt, ":cur_dist", 15),
		
		(faction_get_slot, ":king", "$g_talk_troop_faction", slot_faction_leader), 		
		(troop_get_slot, ":king_party", ":king", slot_troop_leaded_party),
		(troop_get_slot, ":lord_party", "$g_talk_troop", slot_troop_leaded_party),
		(try_begin), 
			(ge, ":king_party", 0), 
			(ge, ":lord_party", 0), 
			(store_distance_to_party_from_party, ":cur_dist", ":lord_party", ":king_party"),	
		(else_try), 
			(assign, ":cur_dist", 0), 
		(end_try), 
		(ge, ":cur_dist", 13),
	], "I have an important assignment for you, {sir/madam}. My soldiers have recently intercepted a message from the Tsar of Moscow to the king of Sweden. It laid out all the Muscovite plans. We have learned from it that the Swedes shall attack our towns and strongholds any day now. We must warn our king at once.", "oim_letter_to_king_potop_start", [
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 4),
	]],		

	[anyone|plyr,"oim_letter_to_king_potop_start", [], "I fear not. Give me the message.", "close_window", [
		(quest_set_slot, "qst_oim_potop_deliver_letter", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_deliver_letter", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s11, "trp_kingdom_1_lord"),	
		(setup_quest_text, "qst_oim_potop_deliver_letter"),
		(str_store_string, s2, "@OIM_add {s9} asked you to deliver letter to the King"),
		(call_script, "script_start_quest", "qst_oim_potop_deliver_letter", "$g_talk_troop"),
		(assign, "$g_leave_encounter", 1),
	]],		

	[anyone|plyr,"oim_letter_to_king_potop_start", [], "I'm afraid that this task is beyond me.", "close_window", [
		(store_current_day, "$oim_potop_last_qst_time"),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 5),
		(assign, "$g_leave_encounter", 1),
	]],		
	
	[anyone|plyr,"lord_king_delivered_letter_oim", [], "{Sire/Madam}, I have brought you a message that was intercepted from the Muscovites. It say the Swedes are about to invade Poland.", "lord_king_delivered_letter_oim_1", []],		
	[anyone,"lord_king_delivered_letter_oim_1", [], "Would that you had come earlier with that letter. -- The Swedes already ravage our lands, and men of the gentry along with the magnates are shifting their loyalty, one after another swearing to Karl.", "lord_king_delivered_letter_oim_2", []],		
	[anyone|plyr,"lord_king_delivered_letter_oim_2", [], "How could the Swedes take over your lands so easily?", "lord_king_delivered_letter_oim_3", []],		
	[anyone,"lord_king_delivered_letter_oim_3", [], "After long years of peace, the gentry of the once great Poland have forgotten the ways of war. King Karl promised them great liberties and benefits, and so they easily came under his hand. But the Russian and Lithuanian magnates, on the other hand, wish to separate from the Polish Commonwealth and form kingdoms of their own.", "lord_king_delivered_letter_oim_4", []],		
	[anyone|plyr,"lord_king_delivered_letter_oim_4", [], "So, many have shifted their loyalties, and are now with the Swedes?", "lord_king_delivered_letter_oim_5", []],			
	[anyone,"lord_king_delivered_letter_oim_5", [], "Many have, but the gentry still wavers, and we still have a few loyal regiments.", "oim_lord_sp_task", [
		(call_script, "script_end_quest", "qst_oim_potop_deliver_letter"),
		#small cheat (quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 5), - only if letter wasn't delivered
		#(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 5),
	]],			
	
	[anyone,"oim_lord_sp_task", [
		(check_quest_active,"qst_oim_potop_main"),
		(neg|check_quest_failed,"qst_oim_potop_main"),
		#(quest_slot_ge, "qst_oim_potop_main", slot_quest_current_state, 3),
		(quest_get_slot, ":cur_state" ,"qst_oim_potop_main", slot_quest_current_state),
		(ge, ":cur_state", 3),
		(le, ":cur_state", 5),
		(eq, "$g_talk_troop", "trp_kingdom_1_lord"),
		(neg|check_quest_active, "qst_oim_potop_deliver_swedish_solders"),
		(neg|check_quest_active, "qst_oim_potop_deliver_swedish_troops_reward"),
	], "You wish to serve the Polish Commonwealth? I would ask you then to capture a Swede commander and deliver him to this place. Then we shall... inquire as to the Swedish perspective on the course of the war.", "oim_potop_zahvat_shved_sold", []],		
	[anyone|plyr,"oim_potop_zahvat_shved_sold", [], "Forgive me, Sire, but I am not yet ready to cross swords with Swedish troops.", "oim_potop_zahvat_shved_sold_1", []],		
	[anyone,"oim_potop_zahvat_shved_sold_1", [], "I shall not take no for an answer. Return to me with the prisoner.", "close_window", [
	#starting quest
		(quest_set_slot, "qst_oim_potop_deliver_swedish_solders", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_deliver_swedish_solders", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_deliver_swedish_solders"),
		(str_store_string, s2, "@OIM_add {s9} deliver swedish prisoner to him"),
		(call_script, "script_start_quest", "qst_oim_potop_deliver_swedish_solders", "$g_talk_troop"),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 6),
		(assign, "$g_leave_encounter", 1),
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_4", -30),
	]],		
	
	#oim_zagloba_auto_help
	[anyone,"oim_zagloba_auto_help", [
		(check_quest_active,"qst_oim_potop_main"),
		(neg|check_quest_failed,"qst_oim_potop_main"),
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 5),
	], "If you want to make your way in life, and help the Polish Commonwealth not only by good words, but also by bold deeds, then you must first obtain the king's trust. -- And that is no easy task, believe you me!", "oim_potop_help_king_zagloba", []],		
	[anyone|plyr,"oim_potop_help_king_zagloba", [], "I shall try.", "close_window", []],			

	#lord report captured swedish troops
	#potop_deliver_swedish_troops
	[anyone|plyr,"potop_deliver_swedish_troops", [], "Sire, I have the captive Swede. These northerners are not so invincible as one hears.", "potop_deliver_swedish_troops_1",[]],

	[anyone,"potop_deliver_swedish_troops_1", [
		(call_script, "script_cf_oim_get_swedish_prisoner_count"), 
		(ge, reg0, 1), 
	], "Good. You shall be rewarded. Alas, the Swedes have over-run both our capitals, old Krakov and Warsaw. But our faithful regiments shall fight until the last drop of blood has been spilt.", "potop_deliver_swedish_troops_positive", [
		(call_script, "script_cf_oim_remove_swedish_prisoner"),
		(call_script, "script_end_quest", "qst_oim_potop_deliver_swedish_solders"),
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 3),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
		#
		(quest_set_slot, "qst_oim_potop_deliver_swedish_troops_reward", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_deliver_swedish_troops_reward", slot_quest_current_state, 0),
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_deliver_swedish_troops_reward"),
		(str_store_string, s2, "str_oim_swedish_prisoner"),
		(call_script, "script_start_quest", "qst_oim_potop_deliver_swedish_troops_reward", "$g_talk_troop"),

		#(call_script, "script_troop_add_gold", "trp_player", 1000),
		#(add_xp_as_reward, 600),
	]],		
	
	[anyone,"potop_deliver_swedish_troops_positive", [], "Oh yes, I almost forgot -- you will receive your reward after we interrogate the Swede. For now, you are dismissed.", "close_window", [
		(store_current_day, "$oim_potop_last_qst_time"),
		(assign, "$g_leave_encounter", 1),
	]],		
	
	[anyone,"potop_deliver_swedish_troops_1", [], "So, where is the Swede?", "potop_deliver_swedish_troops_2", []],		
	[anyone|plyr,"potop_deliver_swedish_troops_2", [], "He fled, Sire. Next time he shall not escape!", "lord_pretalk", []],		
	
	[anyone,"potop_deliver_swedish_troops_reward", [
		(store_current_day, ":now_time"),
		(val_sub, ":now_time", "$oim_potop_last_qst_time"), 
		(lt, ":now_time", 2), 
		(quest_slot_eq, "qst_oim_potop_deliver_swedish_troops_reward", 0), 
	], "The Swede is strong in his heresy. Our best interrogators have done their best, but he mumbles only the words ""forstar inte"".", "potop_deliver_swedish_troops_reward_1", []],		
		[anyone|plyr,"potop_deliver_swedish_troops_reward_1", [], "Hmm, that seems like the words ""I do not understand"" in their language. Perhaps you should call in an interpreter...", "lord_pretalk", [(assign, "$g_leave_encounter", 1),]],
	
	[anyone,"potop_deliver_swedish_troops_reward", [
		(store_current_day, ":now_time"),
		(val_sub, ":now_time", "$oim_potop_last_qst_time"), 
		(ge, ":now_time", 2), 
		(quest_slot_eq, "qst_oim_potop_deliver_swedish_troops_reward", 0), 
	], "Good, we have turned the Protestant heretic to Catholicism at last...", "oim_potop_defend_church_start", [
		(assign, "$g_swedish_prisoner_finished", 1), 
		(call_script, "script_end_quest", "qst_oim_potop_deliver_swedish_troops_reward"),
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		(add_xp_as_reward, 600),
	]],		
	
	[anyone,"oim_potop_defend_church_start", [], "I have a new task for you. The captive Swede told us that the king of Sweden has sent a powerful force to Chenstokhova, disguised as bandits. Our Yasnogorskiy monastery is in Chenstokhova, and the Swedes plan to ransack the place, and desecrate a sacred relic. ", "oim_potop_defend_church_start_1", []],		
	[anyone|plyr,"oim_potop_defend_church_start_1", [], "What relic?", "oim_potop_defend_church_start_2", []],			
	[anyone,"oim_potop_defend_church_start_2", [], "The Yasnogorskiy monastery is home to the icon of Chenstokhova Theotokos, the patroness of Poland.", "oim_potop_defend_church_start_3", []],		
	[anyone|plyr,"oim_potop_defend_church_start_3", [], "Why would they ravage Chenstokhova?", "oim_potop_defend_church_start_4", []],	
	[anyone,"oim_potop_defend_church_start_4", [], "The Swedes are Lutherans. They care more for the treasures of the monastery... But such a robbery would completely crush the morale of our Catholics and Orthodox Poles alike.", "oim_potop_defend_church_start_5", []],			
	[anyone|plyr,"oim_potop_defend_church_start_5", [], "I see. What am I to do?", "oim_potop_defend_church_start_6", []],		
	[anyone,"oim_potop_defend_church_start_6", [], "Drive these bandits out of Chenstokhova and save our relic. We shall reward you most generously.", "oim_potop_defend_church_start_7", []],			
	[anyone|plyr,"oim_potop_defend_church_start_7", [], "To save such a relic is a point of honor. I shall set out at once.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_defend_church", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_defend_church", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_party_name_link, s10, "p_village_54"), 
		(setup_quest_text, "qst_oim_potop_defend_church"),
		(str_store_string, s2, "@OIM_add You were asked to protect {s10}"),
		(call_script, "script_start_quest", "qst_oim_potop_defend_church", "$g_talk_troop"),
		(assign, "$g_leave_encounter", 1),
		#code
		(party_set_slot, "p_village_54", slot_village_state, svs_normal),
		(call_script, "script_refresh_village_defenders", "p_village_54"),
	]],			

	
	[anyone|plyr,"oim_potop_defend_church", [], "Hey there! Stop this plundering at once and leave this place while you still can.", "oim_potop_defend_church_1", []],			
	[anyone,"oim_potop_defend_church_1", [], "We ares the forest bandites. Minde yor ways, mess not. Me men will ploonder ze damnet monaster, you cannot stop zem!", "oim_potop_defend_church_2", []],		
	[anyone|plyr,"oim_potop_defend_church_2", [], "You forest bandits carry Swedish rapiers and muskets. I am here at the behest of the Polish king. Lay down your weapons or we shall open fire!", "oim_potop_defend_church_3", []],			
	[anyone,"oim_potop_defend_church_3", [], "Reiter! Attack!", "close_window", [
	#code_to start fight
		(quest_set_slot, "qst_oim_potop_defend_church", slot_quest_current_state, 1),
		(jump_to_menu, "mnu_oim_potop_defend_church"), 
		(finish_mission),
	]],		

	#potop_defend_monastery_done
	[anyone|plyr,"potop_defend_monastery_done", [], "Chenstokhova is saved, Your Majesty. My men have defeated the foe.", "oim_potop_defend_church_1_1", []],			
	[anyone,"oim_potop_defend_church_1_1", [], "What a marvelous feat of arms you have accomplished! Upon learning of the miraculous salvation of the Yasnogorskiy monastery, the gentry have regained their spirit, and have sworn that they will fight for the Polish crown even unto their last drop of blood.", "oim_potop_otbai_warshaw", [
		(call_script, "script_end_quest", "qst_oim_potop_defend_church"),
		(call_script, "script_troop_add_gold", "trp_player", 4500),
		(add_xp_as_reward, 1600),
		(assign, "$g_leave_encounter", 1),
	]],		

	[anyone|plyr,"potop_defend_monastery_done_failed", [], "{Sire/Madam}, the Swedes could not be stopped. The Yasnogorskiy monastery has been ravaged.", "oim_potop_defend_church_1", []],			
	[anyone,"oim_potop_defend_church_1", [], "This blow could not have come at a worse time. Now even a miracle cannot save the Polish Commonwealth. I shall have to abdicate the throne in order to stop the bloodshed. Go now, {playername}.", "close_window", [
		(call_script, "script_end_quest", "qst_oim_potop_defend_church"),
		(call_script, "script_fail_quest", "qst_oim_potop_main"), 	
		(call_script, "script_end_quest", "qst_oim_potop_main"), 	
		(assign, "$g_main_quest_active", 2),		
		(assign, "$g_leave_encounter", 1),
	]],		

	[anyone,"oim_potop_otbai_warshaw", [], "After our victory at Chenstokhova, our generals have grown fierce and battle-hungry. I shall grant you a patent, that you may gather as many of our Hetmans, Colonels and warlords as you can, and drive every last one of those fiends from our great city of Warsaw!", "oim_potop_otbai_warshaw_1", []],		
	[anyone|plyr,"oim_potop_otbai_warshaw_1", [], "I am grateful for your trust, Your Majesty!", "oim_potop_otbai_warshaw_2", []],			
		[anyone|plyr,"oim_potop_otbai_warshaw_2", [], "Warsaw shall be ours!", "close_window", [
		#start quest "Warshava"
		#qst_oim_potop_defend_get_back_warshaw
			(quest_set_slot, "qst_oim_potop_defend_get_back_warshaw", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_potop_defend_get_back_warshaw", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_potop_defend_get_back_warshaw"),
			(str_store_party_name_link, s10, "p_town_6"),
			(str_store_string, s2, "@OIM_add Wam nuzhno otbit warshavu nazad"),
			(call_script, "script_start_quest", "qst_oim_potop_defend_get_back_warshaw", "$g_talk_troop"),
			(call_script, "script_change_player_relation_with_faction", "fac_kingdom_4", -60),
		]],			
	
	
	#oim_potop_follow_me
	[anyone|plyr,"oim_potop_follow_me", [
	    (assign, "$temp", spai_accompanying_army),
		(assign, "$temp_2", "p_main_party"),
	], "Look here upon the King's patent. Gather under my banners, and we shall banish the Swedes from these lands, and regain the former glory of the Polish Commonwealth.", "oim_potop_follow_me_1", [
		(troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
		(call_script, "script_party_set_ai_state", ":party_no", "$temp", "$temp_2"),
		(try_begin),
			(eq, "$temp", spai_accompanying_army),
			(party_set_slot, ":party_no", slot_party_commander_party, "$temp_2"),
		(else_try),
			(party_set_slot, ":party_no", slot_party_commander_party, -1),
		(try_end),
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, "$temp"),
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, "$temp_2"),
		#Checking if the order is accepted by the ai
		(call_script, "script_recalculate_ai_for_troop", "$g_talk_troop"),
		(assign, "$g_leave_encounter", 1),
	]],			
	[anyone,"oim_potop_follow_me_1", [(eq, 1,0),], "Warring against invaders to our lands is sacred work indeed. But ever since the dawn of time, our troops have been led by weathered, illustrious warlords. I care not for your royal papers. I shall fight on my own.", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, -1),
	]],		
	
	[anyone,"oim_potop_follow_me_1", [
		#(troop_slot_ge, "trp_player",slot_troop_renown, 100),
		(troop_get_slot, ":party_no", "$g_talk_troop", slot_troop_leaded_party),
		(party_slot_eq, ":party_no", slot_party_ai_state, "$temp"),
		(party_slot_eq, ":party_no", slot_party_ai_object, "$temp_2"),
		(assign, "$g_leave_encounter", 1),
	], "It is high time it is to show these Swedes who are the true masters of Poland. Lead us, and may we bring death to our enemies!", "lord_pretalk", [
	
	]],		
	
	[anyone,"oim_potop_follow_me_1", [], "I fear I have too many other responsibilities right now.", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_state, spai_undefined),
		(troop_set_slot, "$g_talk_troop", slot_troop_player_order_object, -1),
	]],		
	
	#finish it!
	#oim_potop_end_quest_warshaw
	[anyone,"oim_potop_end_quest_warshaw", [], "You have done the impossible. For that, I bestow upon you with the title of warlord of Warsaw. Kneel before me and repeat these words: ""In accepting these lands, I swear an oath to the crown of the Polish Commonwealth, and swear by Lord Jesus Christ and Virgin Mary..."" ", "oim_potop_vasal_dlg", [
		#(call_script, "script_succeed_quest", "qst_oim_potop_defend_get_back_warshaw"),
		(call_script, "script_end_quest", "qst_oim_potop_defend_get_back_warshaw"),
		(call_script, "script_troop_add_gold", "trp_player", 2000),
		(add_xp_as_reward, 1000),
		#add code to enter service
	]],	
	
	[anyone|plyr,"oim_potop_vasal_dlg", [], "In accepting these lands, I swear an oath to the crown of the Polish Commonwealth, and swear by Lord Jesus Christ and Virgin Mary...", "oim_potop_vasal_dlg_1", []],			
	[anyone,"oim_potop_vasal_dlg_1", [], "To profess the Catholic faith; to duly keep and guard the strongholds, towns, settlements, and roads; and to remain a faithful Christian, and loyal to you, the Polish king, and all your heirs.", "oim_potop_vasal_dlg_2", []],		
	[anyone|plyr,"oim_potop_vasal_dlg_2", [], "To profess the Catholic faith; to duly keep and guard the strongholds, towns, settlements, and roads; and to remain a faithful Christian, and loyal to you, the Polish king, and all your heirs.", "oim_potop_vasal_dlg_3", []],			
	[anyone,"oim_potop_vasal_dlg_3", [], "And by the same token, neither support nor serve, under this solemn oath, and under penalty of losing all lands, any other princes or commanders, or others of any blood, who shall take it to their heart to oppose the Polish Commonwealth.", "oim_potop_vasal_dlg_4", []],		
	[anyone|plyr,"oim_potop_vasal_dlg_4", [], "And by the same token, neither support nor serve, under this solemn oath, and under penalty of losing all lands, any other princes or commanders, or others of any blood, who shall take it to their heart to oppose the Polish Commonwealth.", "oim_potop_vasal_dlg_5", []],			
	[anyone,"oim_potop_vasal_dlg_5", [], "Before witnesses I give this solemn vow, and kiss the cross.", "oim_potop_vasal_dlg_6", []],		
	[anyone|plyr,"oim_potop_vasal_dlg_6", [], "Before witnesses I give this solemn vow, and kiss the cross.", "oim_potop_vasal_dlg_7", []],			
	[anyone,"oim_potop_vasal_dlg_7", [], "Very well now, Colonel {playername}. Now you are a full member of the Polish gentry, with all the rights and duties a title of nobility entails.", "qst_oim_potop_capture_swedish_lord", [
		(assign, "$g_talk_troop_faction", "fac_kingdom_1"), 
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
		(try_begin),
			(gt, "$g_invite_offered_center", 0),
			(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
			(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(try_end),
	    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		(call_script, "script_update_all_notes"),
		(assign, "$g_recalculate_ais", 1),
	]],		
	
	#oim_potop_capture_swedish_lord
	[anyone,"qst_oim_potop_capture_swedish_lord", [], "There is one more job I have for you. You must take captive and deliver to us a Swedish general. Let us show every man on this earth that the Swedes, too, can be made to bleed.", "oim_potop_capture_swedish_lord_1", []],		
	[anyone|plyr,"oim_potop_capture_swedish_lord_1", [], "For the sake of the Polish Commonwealth, I am ready to risk my very life.", "oim_potop_capture_swedish_lord_2", [
		(quest_set_slot, "qst_oim_potop_capture_swedish_lord", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_capture_swedish_lord", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_capture_swedish_lord"),
		(str_store_string, s2, "@OIM_add {s9} asked you to capture any swedish lord"),
		(call_script, "script_start_quest", "qst_oim_potop_capture_swedish_lord", "$g_talk_troop"),
	]],			
	[anyone,"oim_potop_capture_swedish_lord_2", [], "Ah, and remember -- you now have the authority to recruit the subjects of the Polish Commonwealth under your banner.", "lord_pretalk", []],		
	
	
	#oim_potop_capture_lord
	[anyone,"oim_potop_capture_lord", [
		(call_script, "script_cf_oim_get_swedish_lord_prisoner_count"), 
		(ge, reg0, 1), 
	], "Marvelous! Let our chancellor make a royal deed, and send it into every province. Let every man know that we have taken whole regiments of Swedes captive. And the credit is yours!", "lord_pretalk", [
		(call_script, "script_cf_oim_remove_swedish_lord_prisoner"),
		#(call_script, "script_succeed_quest", "qst_oim_potop_capture_swedish_lord"),
		(call_script, "script_end_quest", "qst_oim_potop_capture_swedish_lord"),
		(call_script, "script_change_player_relation_with_faction", "$g_talk_troop_faction", 3),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 10),
		(call_script, "script_troop_add_gold", "trp_player", 2000),
		(add_xp_as_reward, 1000),
		#code to start message talk to King
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 7),		
		(store_current_day, "$oim_potop_last_qst_time"),
		#code
		(str_store_string, s5, "str_oim_potop_wait_till_order"), 
		(add_quest_note_from_sreg, "qst_oim_potop_main", 4, s5, 1),		
	]],		
	
	
	[anyone,"oim_potop_capture_lord", [
	], "And where is the Swede?", "close_window", [(assign, "$g_leave_encounter", 1),]],	
	
	#ADD HERE CODE TO START "quest_wait" and then  push to quest "Shtirlic"
	
	
	#oim_potop_shtirlic_start_dlg
	[anyone,"oim_potop_start_qst_shtirlic_dlg", [], "Well, you are now a member of the Polish gentry -- and one whom I trust in particular. I have a very difficult task for you.", "oim_potop_shtirlic_start_dlg_1", []],		
	[anyone|plyr,"oim_potop_shtirlic_start_dlg_1", [], "I am ready, Your Majesty. What must I do?", "oim_potop_shtirlic_start_dlg_2", []],			
	[anyone,"oim_potop_shtirlic_start_dlg_2", [], "Our land is beset by foes that would tear it to pieces. In these times, any ally is invaluable. We must gain the support of the Crimean Khanate.", "oim_potop_shtirlic_start_dlg_3", []],		
	[anyone|plyr,"oim_potop_shtirlic_start_dlg_3", [], "But the Khan himself is close friends with the Zaporozhian Hetman...", "oim_potop_shtirlic_start_dlg_4", []],			
	[anyone,"oim_potop_shtirlic_start_dlg_4", [], "Indeed, that is the crux of the matter. You must find Mehmed Giray, and aid him in becoming Khan. Offer him all you can, that Islam Giray may be removed from power.", "oim_potop_shtirlic_start_dlg_5", []],		
	[anyone|plyr,"oim_potop_shtirlic_start_dlg_5", [], "But I am of the Polish gentry, my {lord/lady}. If I should throw my weight behind a Tatar claimant, all our foes would know who is behind this.", "oim_potop_shtirlic_start_dlg_6", []],			
	[anyone,"oim_potop_shtirlic_start_dlg_6", [], "That is why your mission is so difficult. You will have to leave our service, and act at your own risk.", "oim_potop_shtirlic_start_dlg_7", []],		
	[anyone|plyr,"oim_potop_shtirlic_start_dlg_7", [], "And what of the reward for such an impossible command?", "oim_potop_shtirlic_start_dlg_8", []],			
	[anyone,"oim_potop_shtirlic_start_dlg_8", [], "I grieve to hear even a patriot such as yourself thinking of greed in this year of hardships. But yes, I promise a worthwhile reward, and royal support in the election of the new Marshal. Alas, even the king is not all-powerful.", "oim_potop_shtirlic_start_dlg_9", []],		
	[anyone|plyr,"oim_potop_shtirlic_start_dlg_9", [], "Very well, I will accomplish this deed.", "close_window", [
		#code to start quest 
		#oim_potop_shtirlic
		(quest_set_slot, "qst_oim_potop_shtirlic", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_shtirlic", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 9),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s10, "trp_kingdom_3_pretender"), 
		(setup_quest_text, "qst_oim_potop_shtirlic"),
		(str_store_string, s2, "@OIM_add {s9} asked you to help {s10} to get back the throne"),
		(call_script, "script_start_quest", "qst_oim_potop_shtirlic", "$g_talk_troop"),
		(assign, "$g_leave_encounter",1),
	]],			
	
	#member_chat
	#oim_zagloba_help_answer
	#oim_zagloba_help_answer
	[anyone|plyr,"oim_zagloba_help_answer", [
		(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 0),
		(check_quest_active, "qst_oim_potop_shtirlic"), 
		(neg|check_quest_failed, "qst_oim_potop_shtirlic"), 
		(neg|check_quest_finished, "qst_oim_potop_shtirlic"), 
	], "Colonel Zagloba, the king's orders are more difficult than ever... He has ordered me to leave service and desert to the Tatars. There I am to throw my weight behind Mehmed Giray, that he may become Khan.", "oim_potop_shtirlic_zagloba_help_dlg", []],
	
	[anyone,"oim_potop_shtirlic_zagloba_help_dlg", [], "Ha ha, our great king is truly a wise man! This task is certainly no easy matter, but fear not: old Zagloba will be with you 'til the heart stops pounding and the blood stills in my veins!", "oim_potop_shtirlic_zagloba_help_dlg_1", []],		
	[anyone|plyr,"oim_potop_shtirlic_zagloba_help_dlg_1", [], "What say you then, how shall we begin?", "oim_potop_shtirlic_zagloba_help_dlg_2", []],			
	[anyone,"oim_potop_shtirlic_zagloba_help_dlg_2", [], "Start from the beginning, as they say. Go to the king, and publicly announce that you are leaving the service.", "member_chat", []],		
	
	[anyone|plyr,"oim_zagloba_help_answer", [
		(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 1),
		(neq, "$players_kingdom", "fac_player_supporters_faction"),
	], "Well, Colonel Zagloba, now I am once again a freelance soldier, with neither kin nor home. Now how shall we go about finding this Mehmed Giray?", "oim_potop_shtirlic_zagloba_find_khan", []],
	
	[anyone,"oim_potop_shtirlic_zagloba_find_khan", [], "Who other the old Zagloba could help you now? As you may know, I suffered for many years in the captivity of the Tatars! Nevertheless, finding the claimant to the Khan's throne will be no easy task. Let us pass through their towns, and inquire at the pubs. Perhaps something will turn up.", "member_chat", []],		
	
#	(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
#    (call_script, "script_player_leave_faction", 1),
	
	[anyone,"oim_potop_leave_rp", [], "Such is your right, but never again let me lay my eyes upon you!", "close_window", [
		(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(call_script, "script_player_leave_faction", 1),
		(quest_set_slot, "qst_oim_potop_shtirlic", slot_quest_current_state, 1),
		(assign, "$g_leave_encounter", 1),
	]],		
	
	#oim_potop_mahmet_girey_talk
	#code for starting revelion
	[anyone,"oim_potop_mahmet_girey_talk", [], "I am the elder brother of Khan Islam Giray. Upon the passing of our father, I inherited the throne, and ruled the Khanate for several years. But my brother was determined to rule, and gained the support of the Sultan of Istanbul himself. He exploited our defeat in the war with the Muscovite Tsardom, and had me barred from power.", "oim_potop_mahmet_girey_talk_1", []],		
	[anyone|plyr,"oim_potop_mahmet_girey_talk_1", [], "I have heard this tale. But what say you -- do you wish to be Khan once more?", "oim_potop_mahmet_girey_talk_2", []],			
	[anyone,"oim_potop_mahmet_girey_talk_2", [], "What a fool question is this! It is as if a crow has found its way into a summer garden. I would do anything for the restoration of justice!", "oim_potop_mahmet_girey_talk_3", []],		
	[anyone|plyr,"oim_potop_mahmet_girey_talk_3", [], "Very well, I shall aid you. But promise me this -- once you become Khan once more, you will forge an alliance with the Polish Commonwealth.", "oim_potop_mahmet_girey_talk_4", []],			
	[anyone,"oim_potop_mahmet_girey_talk_4", [], "I will do as you say. I swear this in Allah's name.", "close_window", [
		(assign, "$players_kingdom", "fac_player_supporters_faction"),
		(troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
		(try_begin),
			(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
			(assign, "$supported_pretender", "$g_talk_troop"),
			(troop_get_slot, "$supported_pretender_old_faction", "$g_talk_troop", slot_troop_original_faction),
			(troop_set_faction, "$g_talk_troop", "fac_player_supporters_faction"),
			(faction_set_slot, "fac_player_supporters_faction", slot_faction_leader, "$g_talk_troop"),
			(assign, "$g_talk_troop_faction", "fac_player_supporters_faction"),
			(quest_set_slot, "qst_rebel_against_kingdom", slot_quest_giver_troop, "$g_talk_troop"),
			(quest_set_slot, "qst_rebel_against_kingdom", slot_quest_target_faction, "$supported_pretender_old_faction"),
			(str_store_faction_name_link, s14, "$supported_pretender_old_faction"),
			(str_store_troop_name_link, s13, "$g_talk_troop"),
			(setup_quest_text,"qst_rebel_against_kingdom"),
			(str_store_string, s2, "@You promised to help {s13} claim the throne of {s14}."),
			(call_script, "script_start_quest", "qst_rebel_against_kingdom", "$g_talk_troop"),
		(try_end),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
			(call_script, "script_update_all_notes"),
			(assign, "$g_recalculate_ais", 1),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
		(try_begin),
			(gt, "$g_invite_offered_center", 0),
			(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
			(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(try_end),
		(call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(try_begin),
			(check_quest_active, "qst_join_faction"),
			(eq, "$g_invite_faction_lord", "$g_talk_troop"),
			(call_script, "script_end_quest", "qst_join_faction"),
		(else_try),
			(check_quest_active, "qst_join_faction"),
			(call_script, "script_abort_quest", "qst_join_faction", 0),
		(try_end),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		(assign, "$g_leave_encounter",1),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 25),
        (faction_set_slot, "$g_talk_troop_faction", slot_faction_state, sfs_active),
        (party_force_add_members, "p_main_party", "$supported_pretender", 1),
        (troop_set_slot, "$supported_pretender", slot_troop_cur_center, 0),
        (troop_set_auto_equip, "$supported_pretender",0),
        (str_store_troop_name_link, s6, "$supported_pretender"),
        (display_message, "@{s6} has joined your party."),
        (assign, "$player_made_legitimacy_claim", 0),
        (assign, "$player_made_benefit_claim", 0),
        (assign, "$player_made_strength_claim", 0),
        (assign, "$player_made_benefit_claim", 0),
        (store_relation, ":reln", "$supported_pretender_old_faction", "fac_player_supporters_faction"),
        (val_min, ":reln", -50),
        (call_script, "script_set_player_relation_with_faction", "$supported_pretender_old_faction", ":reln"),
        (str_store_faction_name, s1, "$supported_pretender_old_faction"),
        (faction_set_name, "fac_player_supporters_faction", "@{s1} Rebels"),
        (faction_set_color, "fac_player_supporters_faction", 0xFF0000),
		(assign, "$g_recalculate_ais", 1),		
        (call_script, "script_update_all_notes"),
		(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 2),
	]],		

	#oim_zagloba_auto_help
	[anyone|auto_proceed,"oim_zagloba_auto_help", [
		(check_quest_active,"qst_oim_potop_shtirlic"),
		(neg|check_quest_finished,"qst_oim_potop_shtirlic"),
		(quest_slot_eq, "qst_oim_potop_shtirlic", slot_quest_current_state, 3),	 
	], "{!}NOT SHOWN", "oim_potop_shtirlic_last_dlg", []],		
	[anyone|plyr,"oim_potop_shtirlic_last_dlg", [], "Well, well -- Mehmed Giray is now Khan, and I am a High Mirza. But in the eyes of the gentry, I am a damnable traitor. What am I to do, Colonel Zagloba?", "oim_potop_shtirlic_last_dlg_1", []],			
	[anyone,"oim_potop_shtirlic_last_dlg_1", [], "Throw off your dark thoughts, noble {sir/madam}! Forget not that your duty is to aid the Polish Commonwealth! You must stand before the Khan and demand that he fulfill his promise, and forge an alliance with Jan Kasimir.", "oim_potop_shtirlic_last_dlg_2", []],		
	[anyone|plyr,"oim_potop_shtirlic_last_dlg_2", [], "So be it.", "close_window", [
		#code to end quest 
		#(call_script, "script_succeed_quest", "qst_oim_potop_shtirlic"),
		(call_script, "script_end_quest", "qst_oim_potop_shtirlic"),
		#(call_script, "script_troop_add_gold", "trp_player", 2000),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 10),
		(add_xp_as_reward, 1000),

	]],			
	[anyone|plyr,"oim_potop_shtirlic_last_dlg_2", [], "I fear I have other goals now.", "oim_potop_shtirlic_last_dlg_3", []],			
		[anyone|plyr,"oim_potop_shtirlic_last_dlg_3", [], "For all my service, I have not heard one approving word from Jan Kasimir. But Mehmed Giray has treated me well indeed. In these troubled times, the silk robe of the Mirza is more honor than a ragged Polish kuntush. I shall stay with the Tatars.", "oim_potop_shtirlic_last_dlg_4", []],			
	[anyone,"oim_potop_shtirlic_last_dlg_4", [], "Then damn you to hell, traitor that you are! The very sight of your face disgusts me! May I be damned myself, if I should waste a single moment more among your men! May ye go forth in the fear of God, and the wrath of our most pious king!", "close_window", [
		#code to fail quest
		(call_script, "script_fail_quest", "qst_oim_potop_shtirlic"),
		(call_script, "script_end_quest", "qst_oim_potop_shtirlic"),
		(call_script, "script_fail_quest", "qst_oim_potop_main"),
		(call_script, "script_end_quest", "qst_oim_potop_main"),
		(assign, "$g_main_quest_active", 2),
	    (call_script, "script_retire_companion", "$g_talk_troop", 100), 
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", -3),
	]],		

	#oim_potop_soyuznichek
	[anyone|plyr,"oim_potop_soyuznichek", [], "So now you have become Khan. It is time to remember your promise.", "oim_potop_soyuznichek_1", []],			
	[anyone,"oim_potop_soyuznichek_1", [], "So much has fallen on my poor head of late... Tell me, what promises have I not fulfilled?", "oim_potop_soyuznichek_2", []],		
	[anyone|plyr,"oim_potop_soyuznichek_2", [], "You swore to forge alliance with Jan Kasimir, most graceful Khan...", "oim_potop_soyuznichek_3", []],			
	[anyone,"oim_potop_soyuznichek_3", [], "Dear, dear, I do not think I could have promised something like this...", "oim_potop_soyuznichek_4", []],		
	[anyone|plyr,"oim_potop_soyuznichek_4", [], "Of course you could. You swore in the name of Allah.", "oim_potop_soyuznichek_5", []],			
	[anyone,"oim_potop_soyuznichek_5", [], "With witnesses?", "oim_potop_soyuznichek_6", []],		
	[anyone|plyr,"oim_potop_soyuznichek_6", [], "With witnesses.", "oim_potop_soyuznichek_7", []],			
	[anyone,"oim_potop_soyuznichek_7", [], "Were these witnesses faithful Muslims?", "oim_potop_soyuznichek_8", []],		
	[anyone|plyr,"oim_potop_soyuznichek_8", [], "Eh... no.", "oim_potop_soyuznichek_9", []],			
	[anyone,"oim_potop_soyuznichek_9", [], "In that case my oath is void, so I must beg your pardon...", "oim_potop_soyuznichek_10", []],		
	[anyone|plyr,"oim_potop_soyuznichek_10", [], "There was one witness that was worth ten faithful Muslims.", "oim_potop_soyuznichek_11", []],			
	[anyone,"oim_potop_soyuznichek_11", [], "Oh? And who might that be?", "oim_potop_soyuznichek_12", []],		
	[anyone|plyr,"oim_potop_soyuznichek_12", [], "The famed Colonel Zagloba. You know full well how sharp is his tongue -- and what respect he commands among the Mirzas and Beys... He could stir your new subjects to rise against you in no time.", "oim_potop_soyuznichek_13", []],			
	[anyone,"oim_potop_soyuznichek_13", [], "Well, why didn't you say so to begin with, my dear friend. I do remember that bargain -- clearly I do. Please, I spoke only in jest. I will fulfill all my promises, with pleasure. However...", "oim_potop_soyuznichek_14", []],		
	[anyone|plyr,"oim_potop_soyuznichek_14", [], "What now?", "oim_potop_soyuznichek_15", []],			
	[anyone,"oim_potop_soyuznichek_15", [], "You yourself spoke just now of how easily my Mirzas and Beys might remove me from the throne. If I suddenly announce that I have broken our alliance with Cossacks, and now fight for Poland -- well, just imagine! I should be deposed before my speech is finished!", "oim_potop_soyuznichek_16", []],		
	[anyone|plyr,"oim_potop_soyuznichek_16", [], "So what do you suggest?", "oim_potop_soyuznichek_17", []],			
	[anyone,"oim_potop_soyuznichek_17", [], "If one of my loyal commanders should set forth to Muscovy, and take two Russian strongholds... Why, then my position would be strong, and I might decide with whom to fight and with whom to forge friendship.", "oim_potop_soyuznichek_18", []],		
	[anyone|plyr,"oim_potop_soyuznichek_18", [], "It shall be done, Khan. But consider this: if you deceive me in this, you will have made a powerful enemy.", "close_window", [
		#code to start quest "soyuznichek"
		(quest_set_slot, "qst_oim_potop_alias", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_alias", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 11),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(assign, "$oim_potop_moscow_cities_count", 0),
		(setup_quest_text, "qst_oim_potop_alias"),
		(str_store_string, s2, "@OIM_add {s9} asked you to capture 2 cities of Moscow"),
		(call_script, "script_start_quest", "qst_oim_potop_alias", "$g_talk_troop"),
		(store_relation, ":player_relation", "fac_kingdom_2", "fac_player_supporters_faction"),
		(try_begin), 
			(gt, ":player_relation", 0),
			(call_script, "script_set_player_relation_with_faction", "fac_kingdom_2", -10),
		(end_try), 	
		(assign, "$g_leave_encounter",1),
	]],			

	#oim_potop_soyuznichek_finish
	[anyone|plyr,"oim_potop_soyuznichek_finish", [], "I took the two towns, Khan. Please now allow me to relay a letter, offering peace and eternal friendship to Jan Kasimir.", "oim_potop_soyuznichek_finish_1", []],			
	[anyone,"oim_potop_soyuznichek_finish_1", [], "Here is the letter. My promise to you is fulfilled. And this is well -- my warriors have been impatient for battle with the Cossacks, and Porta has spoken no objection to our shift in alliance...", "close_window", [
		#code to finish quest
		#(call_script, "script_succeed_quest", "qst_oim_potop_alias"),
		(str_store_string, s5, "@OiM_Potop Pora pogovorit s korolem"),	
		(quest_set_slot, "qst_oim_potop_alias", slot_quest_current_state, 1),
		(add_quest_note_from_sreg, "qst_oim_potop_alias", 4, s5, 1),
		(add_xp_as_reward, 1000),
		(assign, "$g_leave_encounter", 1),
		#add code for politics
		(call_script, "script_diplomacy_start_peace_between_kingdoms", "fac_kingdom_1", "fac_kingdom_3", 1),
		#
		(call_script, "script_diplomacy_start_war_between_kingdoms", "fac_kingdom_3", "fac_kingdom_2", 1),
		(call_script, "script_diplomacy_start_war_between_kingdoms", "fac_kingdom_3", "fac_kingdom_4", 1),
		(call_script, "script_diplomacy_start_war_between_kingdoms", "fac_kingdom_3", "fac_kingdom_5", 1),
		
		
		
	]],		
	#oim_potop_soyuznichek_last_dlg

	[anyone|plyr,"oim_potop_soyuznichek_last_dlg", [], "I have fulfilled your order, Sire. Mehmed Giray sits upon the throne, and is ready to forge an alliance with you.", "oim_potop_soyuznichek_last_dlg_1", []],			
	[anyone,"oim_potop_soyuznichek_last_dlg_1", [], "The Polish Commonwealth shall never forget you -- our brave hero! Here is a lavish reward.", "oim_potop_soyuznichek_last_dlg_2", [(call_script, "script_troop_add_gold", "trp_player", 8000),]],		
	[anyone|plyr,"oim_potop_soyuznichek_last_dlg_2", [], "And that is all?", "oim_potop_soyuznichek_last_dlg_3", []],			
	[anyone,"oim_potop_soyuznichek_last_dlg_3", [], "What else is there?", "oim_potop_soyuznichek_last_dlg_4", []],		
	[anyone|plyr,"oim_potop_soyuznichek_last_dlg_4", [], "I was promised that my gentry title would be restored, and land as well.", "oim_potop_soyuznichek_last_dlg_5", []],			
	[anyone,"oim_potop_soyuznichek_last_dlg_5", [], "My friend, in our land any gentry, even a landless wanderer, has the power to veto any royal decree. Alas, the king is but a first among equals. I have no power to restore to a Tatar sympathizer his title of nobility.", "oim_potop_soyuznichek_last_dlg_6", []],		
	[anyone|plyr,"oim_potop_soyuznichek_last_dlg_6", [], "Then what am I to do?", "oim_potop_soyuznichek_last_dlg_7", []],			
	[anyone,"oim_potop_soyuznichek_last_dlg_7", [], "If you can restore your fair name among our colonels, we shall eagerly award you vast lands as you deserve.", "close_window", [
		(assign, "$oim_auto_talk_troop", "trp_npc1"), 
		(jump_to_menu, "mnu_oim_auto_talk_menu"),
		(finish_mission),
		(music_set_situation, 0),
		(quest_set_slot, "qst_oim_potop_return", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_return", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_return"),
		(str_store_string, s2, "@OIM_add As {s9} said he'll let get back onl if other..."),
		(call_script, "script_start_quest", "qst_oim_potop_return", "$g_talk_troop"),
		(assign, "$g_leave_encounter",1),
	]],		
	
	#oim_potop_return_zagloba_dlg
	[anyone|plyr,"oim_potop_return_zagloba_dlg", [], "So this is how things must be, Colonel Zagloba. Khans and Kings know not how to keep their promises, but simply do as they will. And as you can see, it seems as though things always line up against me...", "oim_potop_return_zagloba_dlg_1", []],			
	[anyone,"oim_potop_return_zagloba_dlg_1", [], "Never you mind, {playername}. You'll never fail with old Zagloba at your side. I know at least three colonels who will trust my word. And my word of you shall be so glowing that they will follow you even to the ends of the earth!", "oim_potop_return_zagloba_dlg_2", []],		
	[anyone|plyr,"oim_potop_return_zagloba_dlg_2", [], "And who would these colonels be?", "oim_potop_return_zagloba_dlg_3", []],			
	[anyone,"oim_potop_return_zagloba_dlg_3", [], "Colonel Skrzetuski, Colonel Wolodyjowski and Colonel Kmicic.", "oim_potop_return_zagloba_dlg_4", []],		
	[anyone|plyr,"oim_potop_return_zagloba_dlg_4", [], "Well then, let us get ourselves to your colonels.", "oim_potop_return_zagloba_dlg_5", []],			
	[anyone,"oim_potop_return_zagloba_dlg_5", [], "But first you must go to the Khan and tell him you shall leave his service...", "close_window", [
		(str_store_troop_name_link, s6, "trp_knight_1_1"),
		(str_store_troop_name_link, s7, "trp_knight_1_2"),
		(str_store_troop_name_link, s8, "trp_knight_1_3"),
		(str_store_string, s5, "str_oim_potop_return_notes"), 
		(add_quest_note_from_sreg, "qst_oim_potop_return", 4, s5, 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(quest_set_slot, "qst_oim_potop_return", slot_quest_current_state, 1),
	]],		
	
	#oim_mehmet_ask_leave_service
	[anyone|auto_proceed,"oim_mehmet_ask_leave_service", [], "{!}NOT SHOWN", "lord_ask_leave_service", [
		(call_script, "script_end_quest", "qst_oim_potop_alias"), 
	]],		

	
	#oim_potop_kmitic_start_dlg
	[anyone|plyr,"oim_potop_kmitic_start_dlg", [
		(neg|check_quest_active, "qst_oim_potop_kmitic"),
	], "What can I do to gain your backing in the court?", "oim_potop_kmitic_start_dlg_1", []],			
	[anyone,"oim_potop_kmitic_start_dlg_1", [], "You would impress me? Very well, my sworn enemy, Prince Khovansky, once placed a price on my head. But as you can see, thank the saints, I am unharmed... Still, I would love to have a word with this prince... Deliver him -- alive and well -- that I may resolve the question of what I shall do with his own head.", "oim_potop_kmitic_start_dlg_2", []],		
	[anyone|plyr,"oim_potop_kmitic_start_dlg_2", [], "And that is all?", "oim_potop_kmitic_start_dlg_3", []],			
	[anyone,"oim_potop_kmitic_start_dlg_3", [], "Yes. Bring me Khovansky. Then I shall once more be a faithful servant of the Polish King, and you shall gain my support.", "oim_potop_kmitic_start_dlg_4", []],		
	[anyone|plyr,"oim_potop_kmitic_start_dlg_4", [], "I will try to do as you ask.", "close_window", [
		(str_store_troop_name_link, s3, "trp_knight_1_1"),	
		(str_store_troop_name_link, s4, "trp_knight_2_16"),	
		(str_store_string, s5, "@OiM_Potop {s3} prosil vzat v plen {s4} "),	
		(quest_set_slot, "qst_oim_potop_kmitic", slot_quest_giver_troop, "$g_talk_troop"), 
		(setup_quest_text, "qst_oim_potop_kmitic"),
		(str_store_string, s2, "@OiM_Potop {s3} prosil vzat v plen {s4} "),	
		(call_script, "script_start_quest", "qst_oim_potop_kmitic", "$g_talk_troop"),
		(quest_set_slot, "qst_oim_potop_kmitic", slot_quest_current_state, 1),
		(finish_mission),		
		(assign, "$g_leave_encounter", 1),
	]],			
	
	[anyone|plyr,"oim_potop_kmitic_start_dlg", [
		(neg|troop_slot_eq, "trp_knight_2_16", slot_troop_prisoner_of_party, "p_main_party"),	
	], "What was the name of that prince, Kho... vansky? ", "lord_pretalk", []],			
	[anyone|plyr,"oim_potop_kmitic_start_dlg", [
		(troop_slot_eq, "trp_knight_2_16", slot_troop_prisoner_of_party, "p_main_party"),	
	], "Here is your prince, Colonel Kmicic. I hope now I can count on your support?", "oim_potop_kmitic_start_dlg_1_1", []],			
		[anyone,"oim_potop_kmitic_start_dlg_1_1", [], "For this deed I am forever in your debt.", "lord_pretalk", [
			(remove_troops_from_prisoners,  "trp_knight_2_16", 1),
			(call_script, "script_end_quest", "qst_oim_potop_kmitic"), 
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 50),
			(assign, "$g_oim_kmitic_finished", 1), 
		]],			
	
	#oim_potop_volodievskiy_start_dlg
	[anyone|plyr,"oim_potop_volodievskiy_start_dlg", [], "I need your help, Colonel Wolodyjowski. Do you wish to serve your homeland with your saber, and support me in the court?", "oim_potop_volodievskiy_start_dlg_1", []],			
	[anyone,"oim_potop_volodievskiy_start_dlg_1", [], "I have heard of you. Indeed I have heard many things, some bad and some good. But 'tis of little concern to me! If only you could aid me in my plight...", "oim_potop_volodievskiy_start_dlg_2", []],		
	[anyone|plyr,"oim_potop_volodievskiy_start_dlg_2", [], "And what that plight would be, Colonel Wolodyjowski?", "oim_potop_volodievskiy_start_dlg_3", []],			
	[anyone,"oim_potop_volodievskiy_start_dlg_3", [], "While I was busying myself chopping off the heads of our enemies, my bride, Anusia Borzobogataya, was kidnapped by the damnable Swedes. And I am too wounded from battle to set out in search of her myself. Find Anusia and bring her back to me, and I shall be your friend to my dying breath.", "oim_potop_volodievskiy_start_dlg_4", []],		
	[anyone|plyr,"oim_potop_volodievskiy_start_dlg_4", [], "I will try to bring back your Anusia at all costs. I leave at once.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_current_state, 1),
		(setup_quest_text, "qst_oim_potop_volodievskiy"),
		(str_store_string, s2, "str_oim_potop_volodievskiy_start"),	
		(call_script, "script_start_quest", "qst_oim_potop_volodievskiy", "$g_talk_troop"),		
	]],			

	[anyone|plyr,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_volodievskiy"),
		(neg|check_quest_finished,"qst_oim_potop_volodievskiy"),
		(quest_slot_eq, "qst_oim_potop_volodievskiy", slot_quest_current_state, 1), 
	], "I am at my wit's end! Where can I find this Anusia?", "oim_zagloba_help_answer_volodievskiy", []],			

	[anyone,"oim_zagloba_help_answer_volodievskiy", [], "Pan Wolodyjowski said she is being held captive by the Swedes. Let us capture a Swedish officer and ask him if he knows anything of this...", "oim_zagloba_help_answer_volodievskiy_1", []],		
	[anyone,"oim_zagloba_help_answer_volodievskiy_1", [], "How do you expect to persuade the damsel to come with us? I advise you to ask Colonel Wolodyjowski to write a letter explaining the matter.", "member_chat", [
		(str_store_string, s5, "@OiM_Potop Shveda slovit tak shveda...."),	
		(add_quest_note_from_sreg, "qst_oim_potop_volodievskiy", 4, s5, 1),
		(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_current_state, 2),
	]],		
	#
	[anyone|plyr,"oim_potop_volodievskiy_letter_dlg", [], "Colonel Wolodyjowski, please write a few words to your beloved, so she will believe us when we find her.", "oim_potop_volodievskiy_letter_dlg_1", []],			
	[anyone,"oim_potop_volodievskiy_letter_dlg_1", [], "Why, of course. Here is a note with my family seal...", "lord_pretalk", [(assign, "$oim_potop_has_letter", 1),]],		

	#oim_potop_volodievsky_shved_dlg
	[anyone|plyr,"oim_potop_volodievsky_shved_dlg", [], "You heard anything of a captive lady of the gentry? Anusia Borzobogataya is her name.", "oim_potop_volodievsky_shved_dlg_1", []],			
	[anyone,"oim_potop_volodievsky_shved_dlg_1", [], "Zat smoll girlie girl?", "oim_potop_volodievsky_shved_dlg_2", []],		
	[anyone|plyr,"oim_potop_volodievsky_shved_dlg_2", [], "Seems like her. But you had better watch what you say in front of Wolodyjowski, or your head might fly off. Understand?", "oim_potop_volodievsky_shved_dlg_3", []],			
	[anyone,"oim_potop_volodievsky_shved_dlg_3", [], "My colonel think, if her name is Borzobogataya, perhap she has lots money. But it was just a stoopid Polish zekond name, and she haz no money at all.", "oim_potop_volodievsky_shved_dlg_4", []],		
	[anyone|plyr,"oim_potop_volodievsky_shved_dlg_4", [], "What did you do with her?", "oim_potop_volodievsky_shved_dlg_5", []],			
	[anyone,"oim_potop_volodievsky_shved_dlg_5", [
		(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_4", -1), 
		(assign, ":target_center", reg0), 
		(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_target_center, ":target_center"),
		(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_current_state, 3),
		(str_store_party_name_link, s5, ":target_center"), 
		(str_store_string, s6, "@OiM_Potop Borzobagataya v {s5}"),	
		(add_quest_note_from_sreg, "qst_oim_potop_volodievskiy", 4, s6, 1),
	], "Yesh, we just sold her to anozer stoopid man, like her. Now she must be at {s5}.", "oim_potop_volodievsky_shved_dlg_6", []],		
	[anyone|plyr,"oim_potop_volodievsky_shved_dlg_6", [], "All right. Well, Colonel Zagloba, let us prepare for a journey!", "close_window", []],			

	#oim_potop_borzobogataya_dlg
	
	[anyone|plyr,"oim_potop_borzobogataya_dlg", [], "Michal Wolodyjowski sent me to rescue you, my dear.", "oim_potop_borzobogataya_dlg_1", []],			
	[anyone,"oim_potop_borzobogataya_dlg_1", [], "You -- no you're lying! I was kidnapped, exhausted by hunger, carried indecorously from place to place. I am abused and exhausted, and I dare not believe a single word spoken by a stranger.", "oim_potop_borzobogataya_dlg_2", []],		
	
	[anyone|plyr,"oim_potop_borzobogataya_dlg_2", [], "You must trust my word of honor.", "oim_potop_borzobogataya_dlg_chest_test", 		 []],			
	[anyone|plyr,"oim_potop_borzobogataya_dlg_2", [], "Here is a letter from Colonel Wolodyjowski.", "oim_potop_borzobogataya_dlg_zagloba_test", []],			
	[anyone|plyr,"oim_potop_borzobogataya_dlg_2", [(eq, "$oim_potop_has_letter", 1)], "Colonel Zagloba is at my side. You know him well, do you not?", "oim_potop_borzobogataya_dlg_positive", []],			
	[anyone|plyr,"oim_potop_borzobogataya_dlg_2", [], "I will be back.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],			

		[anyone|auto_proceed,"oim_potop_borzobogataya_dlg_chest_test", [
			(store_random_in_range, ":random", 0, 100),
			(lt, ":random", 15), 
		], "{!}NOT SHOWN", "oim_potop_borzobogataya_dlg_positive", []],		

		[anyone|auto_proceed,"oim_potop_borzobogataya_dlg_chest_test", [], "{!}NOT SHOWN", "oim_potop_borzobogataya_dlg_negative", []],		
	

		[anyone|auto_proceed,"oim_potop_borzobogataya_dlg_zagloba_test", [
			(store_random_in_range, ":random", 0, 100),
			(lt, ":random", 50), 
		], "{!}NOT SHOWN", "oim_potop_borzobogataya_dlg_positive", []],		

		[anyone|auto_proceed,"oim_potop_borzobogataya_dlg_zagloba_test", [], "{!}NOT SHOWN", "oim_potop_borzobogataya_dlg_negative", []],		

		
	[anyone,"oim_potop_borzobogataya_dlg_positive", [], "Very well, I'll just have to risk it. Let us make haste!", "close_window", [
		#code talk to RP lord
		(assign, "$oim_auto_talk_troop", "trp_oim_polish_lord"),   
		(jump_to_menu, "mnu_oim_auto_talk_menu"),
		(finish_mission),
	]],		
		
	[anyone,"oim_potop_borzobogataya_dlg_negative", [], "No, I do not believe you, and I'm not going anywhere. Prove to me first that you are not simply another kidnapper...", "oim_potop_borzobogataya_dlg_2", []],		

	#oim_potop_polish_lord_talk
	[anyone,"oim_potop_polish_lord_talk", [], "What is this? Who are you to be giving orders here?", "oim_potop_polish_lord_talk_1", []],		
	[anyone|plyr,"oim_potop_polish_lord_talk_1", [], "I am here to bring this girl to the man she is to marry...", "oim_potop_polish_lord_talk_2", []],			
	[anyone,"oim_potop_polish_lord_talk_2", [], "To the blushing groom, eh? Well I've invested a lot of money in the girl -- more than you could make in a year! Make yourself scarce, or I'll call the guards...", "oim_potop_polish_lord_talk_3", []],		
	[anyone|plyr,"oim_potop_polish_lord_talk_3", [], "Push through angrily!", "oim_potop_polish_lord_talk_4", []],			
		[anyone|plyr,"oim_potop_polish_lord_talk_4", [], "Call your guards. But first, give them a chance to pray for the salvation of their souls...", "close_window", [
			(jump_to_menu, "mnu_oim_potop_romeo_fight"),
			(change_screen_mission),
		]],			

	[anyone|plyr,"oim_potop_polish_lord_talk_3", [], "I can sell her back to you.", "oim_potop_polish_lord_talk_money", []],			
		[anyone|plyr,"oim_potop_polish_lord_talk_money", [], "And what would be the cost?", "oim_potop_polish_lord_talk_money_2", []],			

		[anyone,"oim_potop_polish_lord_talk_money_2", [
			#code gold
			(assign, ":low_bound", 130), 
			(assign, ":upper_bound", 190),
			(store_character_level, ":level"),
			(val_mul, ":low_bound", ":level"),
			(val_mul, ":upper_bound", ":level"), 
			(store_random_in_range, "$oim_potop_borzobogata_price", ":low_bound", ":upper_bound"),
			(val_add, "$oim_potop_borzobogata_price", 4000), 
			(assign, reg0, "$oim_potop_borzobogata_price"),
		], "You can take her for {reg0} thaler. And for twice that, I'll throw in my wife, mother-in-law, and sister-in-law to boot. May they all rot in hell...", "oim_potop_polish_lord_talk_money_3", []],			
			[anyone|plyr,"oim_potop_polish_lord_talk_money_3", [
				(store_troop_gold, ":gold", "trp_player"),
				(ge, ":gold", "$oim_potop_borzobogata_price"),
			], "Here is the money.", "close_window", [
				(troop_remove_gold, "trp_player", "$oim_potop_borzobogata_price"), 
				(quest_set_slot, "qst_oim_potop_volodievskiy", slot_quest_current_state, 10), #something like the quest is ended
				(str_store_string, s5, "@OiM_Potop Pani osvobozhdena. Pora idti k volodievskomu"),	
				(add_quest_note_from_sreg, "qst_oim_potop_volodievskiy", 6, s5, 1),
				(party_force_add_members, "p_main_party", "trp_knight_1_2_wife", 1),
				(jump_to_menu, "mnu_auto_return_to_map"),
				(finish_mission),
			]],			
			[anyone|plyr,"oim_potop_polish_lord_talk_money_3", [], "I do not have such an amount.", "oim_potop_polish_lord_talk_money_4", []],			
			[anyone|plyr,"oim_potop_polish_lord_talk_money_4", [], "Call your guards. But first, give them a chance to pray for the salvation of their souls...", "close_window", [
				(jump_to_menu, "mnu_oim_potop_romeo_fight"),
				(change_screen_mission),
			]],			
			
	#oim_potop_volodievskiy_last_dlg		
	[anyone|plyr,"oim_potop_volodievskiy_last_dlg", [], "Colonel Wolodyjowski, your bride awaits you, well-guarded by my men. But before you run to her, please remember our bargain.", "oim_potop_volodievskiy_last_dlg_1", []],			
	[anyone,"oim_potop_volodievskiy_last_dlg_1", [], "My memory still serves me well, despite my wounded head. I am now a loyal servant of the Polish King -- and your grateful supporter.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_potop_volodievskiy"), 
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 50),
		(party_remove_members, "p_main_party", "trp_knight_1_2_wife", 1),
		(assign, "$volodievskiy_supported", 1), 
	]],		
	
	#to be re-done
	#oim_potop_kshetuskiy_start_dlg		
	[anyone|plyr,"oim_potop_kshetuskiy_start_dlg", [], "Tell me, Colonel, how can I gain your support at the court?", "oim_potop_kshetuskiy_start_dlg_1", []],			
	[anyone,"oim_potop_kshetuskiy_start_dlg_1", [
		(call_script, "script_cf_get_random_lord_except_king_with_faction", "fac_kingdom_5"), 
		(assign, ":target_troop", reg0), 
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_target_troop, ":target_troop"),
		(str_store_troop_name_link, s3, ":target_troop"),
	], "Support you say? Well... Some damned serfs snuck into my stables and stole my stallion -- a fine purebred! It seems the fools sold it, and now {s3} has it. Bring back my horse, and we shall see what support I can offer you...", "oim_potop_kshetuskiy_start_dlg_2", []],		
	[anyone|plyr,"oim_potop_kshetuskiy_start_dlg_2", [], "Very well, I will do my best.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_kshetuskiy"),
		(str_store_string, s2, "str_oim_khetuskiy_qst_descr"),
		(call_script, "script_start_quest", "qst_oim_potop_kshetuskiy", "$g_talk_troop"),		
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 1),
		(assign, "$g_leave_encounter",1),
	]],			

	#oim_zagloba_help_answer
	[anyone|plyr,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_kshetuskiy"),
		(neg|check_quest_finished,"qst_oim_potop_kshetuskiy"),
		(quest_slot_eq, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 1), 
	], "And what now, Colonel Zagloba? Where shall we find this stolen steed?", "oim_zagloba_help_answer_kshetuskiy", []],			
	[anyone,"oim_zagloba_help_answer_kshetuskiy", [
		(quest_get_slot, ":target_troop", "qst_oim_potop_kshetuskiy", slot_quest_target_troop), 	
		(assign, ":num_centers", 0),
		(try_for_range, ":village_no", villages_begin, villages_end),
			(party_slot_eq, ":village_no", slot_town_lord, ":target_troop"),                          
			(is_between, ":village_no",  villages_begin, villages_end),
			(try_begin),
                (eq, ":num_centers", 0),
                (assign, ":target_center", ":village_no"),
				(val_add, ":num_centers", 1),			
            (try_end),
		(try_end),
		(try_begin),
			(eq, ":num_centers", 0), 
			(call_script, "script_cf_get_village_of_faction", "fac_kingdom_5"), 
			(assign, ":target_center", reg0), 
		(try_end), 
		#(quest_set_slot, "qst_oim_potop_kshetuskiy" slot_quest_target_troop, ":target_troop"),
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_target_center, ":target_center"),
		(str_store_troop_name, s3, ":target_troop"),
		(str_store_party_name_link, s4, ":target_center"),
	], "{s3}? Oh, I remember. He resides at {s4}.", "oim_zagloba_help_answer_kshetuskiy_1", [
		(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 2),
		(str_store_string, s5, "str_oim_items_list_kshetuskiy"),	
		(add_quest_note_from_sreg, "qst_oim_potop_kshetuskiy", 4, s5, 1),
	]],		

	[anyone|plyr,"oim_zagloba_help_answer_kshetuskiy_1", [], "But the horse will be well-guarded.", "oim_zagloba_help_answer_kshetuskiy_2", []],			
	[anyone,"oim_zagloba_help_answer_kshetuskiy_2", [], "Naturally. But where force fails, cunning may find a way. We should disguise ourselves as Tatars, and try to slip in the village. And then -- well, we can hope for a bit of luck, eh?", "member_talk", []],		
	
	#trp_reestrovuy_kozak
	#oim_potop_kozaks_guard
	
	[anyone|auto_proceed, "oim_potop_kozaks_guard", [
		(call_script, "script_player_check_tatarin_costume"),
		(lt, reg0, 2),
	], "{!}NOT SHOWN", "oim_potop_kozaks_guard_not_tatarin", []],		
		[anyone,"oim_potop_kozaks_guard_not_tatarin", [], "Halt right there! To arms, lads! We have a Tatar over here!", "close_window", [
			(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 4),
			(call_script, "script_cf_set_agent_mode_hostile"), 
		]],		
	[anyone|auto_proceed,"oim_potop_kozaks_guard", [], "{!}NOT SHOWN", "oim_potop_kozaks_guard_tatarin", []],		
		[anyone,"oim_potop_kozaks_guard_tatarin", [], "Hey, Tatar, what is yer need here?", "oim_potop_kozaks_guard_tatarin_1", []],			
		[anyone|plyr,"oim_potop_kozaks_guard_tatarin_1", [], "I rich Tatar trader, Shaltyn-Baltyn. See preety horse, want to look in ze mouth.", "oim_potop_kozaks_guard_tatarin_2", []],			
		[anyone,"oim_potop_kozaks_guard_tatarin_2", [], "Lo, Mykolo, he speaks not our tongue. Keep away from the horse, heathen, or father will cut you to ribbons.", "oim_potop_kozaks_guard_tatarin_3", []],		
		[anyone|plyr,"oim_potop_kozaks_guard_tatarin_3", [], "Kazak is big dzhigit. Fear no man. Shaltyn-Baltyn likes much to see preety horse. Here, take the monies. I go look horse.", "oim_potop_kozaks_guard_tatarin_4", []],			
		[anyone,"oim_potop_kozaks_guard_tatarin_4", [
			(store_skill_level, ":dest", "skl_persuasion"),
			(lt, ":dest", 3), 
		], "I see you have hard time understanding! Clear off, Tatar, before I call the lads!", "close_window", [
			(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 4),
			(call_script, "script_cf_set_agent_mode_hostile"), 
		]],		
		[anyone,"oim_potop_kozaks_guard_tatarin_4", [], "Devil take you, infidel. Very well, fifty coins will earn you a look, but one false move and you'll regret it! We'll stay here, and act like we didn't see you.", "close_window", [
			(quest_set_slot, "qst_oim_potop_kshetuskiy", slot_quest_current_state, 3),	
		]],		
	
	
	
	#oim_potop_kshetuskiy_last_dlg
	[anyone|plyr,"oim_potop_kshetuskiy_last_dlg", [], "Here is your stallion, Colonel. But I fear it will be of little use...", "oim_potop_kshetuskiy_last_dlg_1", []],			
	[anyone,"oim_potop_kshetuskiy_last_dlg_1", [], "Nay, 'tis a great use, friend! Be sure that this horse shall begin a breed of the greatest war horses in all the Polish Commonwealth.", "oim_potop_kshetuskiy_last_dlg_2", []],		
	[anyone|plyr,"oim_potop_kshetuskiy_last_dlg_2", [], "From your lips to God's ear. A good steed is often worth more to a warrior than a good saber.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_potop_kshetuskiy"), 
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 50),
		(troop_remove_item, "trp_player", "itm_oim_qst_horse"), 
		(assign, "$kshetuskiy_supported", 1), 
	]],				

	[anyone,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_kmitic"),
		(neg|check_quest_succeeded, "qst_oim_potop_kmitic"),
		(neg|check_quest_finished, "qst_oim_potop_kmitic"),		
		(assign, "$hero_requested_to_learn_location", "trp_knight_2_16"),
		(call_script, "script_update_troop_location_notes", "$hero_requested_to_learn_location", 1),
		(call_script, "script_get_information_about_troops_position", "$hero_requested_to_learn_location", 0),
	], "{s1}", "do_member_trade", []],	

	
	#oim_potop_letter_back_to_the_rp
	[anyone,"oim_potop_letter_back_to_the_rp", [], "Word of your feats precede you. The most illustrious Colonels of the Polish Commonwealth have contacted me on your behalf, and I cannot turn away from their plea. I hereby offer you a return to service, and grant you a village.", "oim_potop_letter_back_to_the_rp_1", []],			
	[anyone|plyr,"oim_potop_letter_back_to_the_rp_1", [], "Thank you, Your Majesty. But what of the promised city?", "oim_potop_letter_back_to_the_rp_2", []],			
	[anyone,"oim_potop_letter_back_to_the_rp_2", [], "Cities do not grow on trees! Granting one to you means taking it away from another one of my loyal subjects. But one thing I can promise you -- the first city you take shall be yours...", "oim_potop_letter_back_to_the_rp_3", []],			
	[anyone|plyr,"oim_potop_letter_back_to_the_rp_3", [], "Thank you for your open hand, Your Majesty. Very well, then -- I shall move out to seize a city for myself...", "lord_pretalk", [
		#(call_script, "script_end_quest", "qst_oim_potop_kmitic"), 
		#(call_script, "script_end_quest", "qst_oim_potop_volodievskiy"), 
		#(call_script, "script_end_quest", "qst_oim_potop_kshetuskiy"), 
		(call_script, "script_troop_add_gold", "trp_player", 5000),
		(add_xp_as_reward, 6000),
		(call_script, "script_end_quest", "qst_oim_potop_return"), 
		(assign, "$g_talk_troop_faction", "fac_kingdom_1"), 
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
			(call_script, "script_update_all_notes"),
			(assign, "$g_recalculate_ais", 1),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
		(try_begin),
			(gt, "$g_invite_offered_center", 0),
			(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
			(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(try_end),
	    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 12),
		(quest_set_slot, "qst_oim_potop_capture_city", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_capture_city", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_capture_city"),
		(str_store_string, s2, "str_oim_potop_capture_city_descr"),
		(call_script, "script_start_quest", "qst_oim_potop_capture_city", "$g_talk_troop"),
	]],			

	#oim_potop_marshal_elections
	[anyone|plyr,"oim_potop_marshal_elections", [], "Your Majesty, you recall how you promised to support me in gaining the Marshal's baton?", "oim_potop_marshal_elections_1", []],			
	[anyone,"oim_potop_marshal_elections_1", [], "You are too naive, my friend. Such promises cannot be easily trusted...", "oim_potop_marshal_elections_2", []],			
	[anyone|plyr,"oim_potop_marshal_elections_2", [], "What strange words I hear... The legends and romances always celebrate the nobility and honor of Kings...", "oim_potop_marshal_elections_3", []],			
	[anyone,"oim_potop_marshal_elections_3", [], "Alas, life is not a fairy tale...", "oim_potop_marshal_elections_4", []],			
	[anyone|plyr,"oim_potop_marshal_elections_4", [], "So you shall not put me forth for Marshal, Sire?", "oim_potop_marshal_elections_5", []],			
	[anyone,"oim_potop_marshal_elections_5", [], "It seems I must. I have no wish to quarrel with your new friends. They might even rebel if they learned I rejected you.", "oim_potop_marshal_elections_6", []],			
	[anyone|plyr,"oim_potop_marshal_elections_6", [], "So I can put myself forth for the election?", "oim_potop_marshal_elections_7", []],			
	[anyone,"oim_potop_marshal_elections_7", [], "Yes. As soon as you gather enough support from the gentry, let me know. I shall announce your nomination.", "lord_pretalk", [
		#code to start quest
		(call_script, "script_end_quest", "qst_oim_potop_capture_city"),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 14),
		(quest_set_slot, "qst_oim_potop_marshal", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_marshal", slot_quest_current_state, 0),
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(setup_quest_text, "qst_oim_potop_marshal"),
		(str_store_string, s2, "str_oim_marshal_descr"),
		(call_script, "script_start_quest", "qst_oim_potop_marshal", "$g_talk_troop"),
	]],			
	
	[anyone|plyr,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_marshal"),
		(neg|check_quest_finished,"qst_oim_potop_marshal"),
		(quest_slot_eq, "qst_oim_potop_marshal", slot_quest_current_state, 0), 
	], "Would you help me in one more difficult quest, Colonel Zagloba?", "oim_zagloba_help_answer_marshal_1", [
		(quest_set_slot, "qst_oim_potop_marshal", slot_quest_current_state, 1), 
		(str_store_string, s5, "str_oim_potop_support_advice"),	
		(add_quest_note_from_sreg, "qst_oim_potop_marshal", 4, s5, 1),
	]],			
	[anyone,"oim_zagloba_help_answer_marshal_1", [], "What bug do you have inside that head of yours?", "oim_zagloba_help_answer_marshal_2", []],			
	[anyone|plyr,"oim_zagloba_help_answer_marshal_2", [], "Merely to become the Marshal of the Crown. But that position can only be gained through election, as you know...", "oim_zagloba_help_answer_marshal_3", []],			
	[anyone,"oim_zagloba_help_answer_marshal_3", [], "The late Jeremiah Vishnevetsky himself spoke kindly of my gift for politics... Yes, I will aid you.", "oim_zagloba_help_answer_marshal_4", []],			
	[anyone|plyr,"oim_zagloba_help_answer_marshal_4", [], "What is your advice?", "oim_zagloba_help_answer_marshal_5", []],			
	[anyone,"oim_zagloba_help_answer_marshal_5", [], "Let us speak to the gentry. I suppose I can draw them to your side. But you keep your eyes open -- and miss no chance to earn their trust in any way...", "member_talk", []],			

	#oim_potop_lord_talk_support_elections
	[anyone,"oim_potop_lord_talk_support_elections", [
		(store_random_in_range, ":random", 0, 100), 
		(this_or_next|ge, ":random", 70), 
		(troop_slot_ge, "$g_talk_troop", slot_troop_player_relation, 5),
	], "I see Colonel Zagloba himself is one of your men. That certainly changes things. I shall have to consider your offer.", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1), 
		(str_clear, s4), 
		(str_clear, s5), 
		(assign, ":count", 0), 
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0), 
				(str_store_string, s4, "@{s2}"),
			(else_try), 	
			(str_store_string, s4, "@{s4}, {s2}"),
		(end_try), 
			(val_add, ":count", 1),
		(end_try), 
		(assign, ":count", 0), 
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 2), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0), 
				(str_store_string, s5, "@{s2}"),
			(else_try), 	
			(str_store_string, s5, "@{s5}, {s2}"),
		(end_try), 
			(val_add, ":count", 1),
		(end_try), 
		(str_store_string, s6, "str_oim_potop_support_list"),	
		(add_quest_note_from_sreg, "qst_oim_potop_marshal", 4, s6, 1),
	]],				

	[anyone,"oim_potop_lord_talk_support_elections", [
		(store_random_in_range, ":random", 0, 100), 
		(ge, ":random", 85), 
		(neg|troop_slot_ge, "$g_talk_troop", slot_troop_player_relation, 0),
	], "I do not trust you...", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 2), 
		(str_clear, s4), 
		(str_clear, s5), 
		(assign, ":count", 0), 
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0), 
				(str_store_string, s4, "@{s2}"),
			(else_try), 	
			(str_store_string, s4, "@{s4}, {s2}"),
		(end_try), 
			(val_add, ":count", 1),
		(end_try), 
		(assign, ":count", 0), 
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 2), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0), 
				(str_store_string, s5, "@{s2}"),
			(else_try), 	
			(str_store_string, s5, "@{s5}, {s2}"),
		(end_try), 
			(val_add, ":count", 1),
		(end_try), 
		(str_store_string, s6, "str_oim_potop_support_list"),	
		(add_quest_note_from_sreg, "qst_oim_potop_marshal", 4, s6, 1),
	]],				
	
	[anyone,"oim_potop_lord_talk_support_elections", [], "Pardon me, but I have no time to speak with you about the title of Hetman of the Crown.", "close_window", [
		(assign, "$g_leave_encounter", 1),
	]],				
	
	#oim_potop_start_elections
	[anyone|plyr,"oim_potop_start_elections", [], "Sire, I am ready for the vote.", "oim_potop_lord_talk_support_elections_1", []],			
	[anyone,"oim_potop_lord_talk_support_elections_1", [], "You are quite certain you will prevail? Know that there can be no second chance.", "oim_potop_lord_talk_support_elections_2", []],			
	[anyone|plyr,"oim_potop_lord_talk_support_elections_2", [], "You are right... Perhaps I am in too much haste.", "lord_pretalk", []],			
	[anyone|plyr,"oim_potop_lord_talk_support_elections_2", [
		(call_script, "script_oim_count_suppurters", "fac_kingdom_1"), 
		(gt, reg0, 50), 
	], "I am certain of victory. Call the Sejm.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_marshal_started", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_marshal_started", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_marshal_started"),
		(str_store_string, s2, "@OIM_add Nu polkiy seym bil sozvan.Skoro budut resultati..."),
		(call_script, "script_start_quest", "qst_oim_potop_marshal_started", "$g_talk_troop"),
		(assign, "$g_election_date", 83), 
   	    #(assign, "$g_recalculate_ais", 1),
		(call_script, "script_succeed_quest", "qst_oim_potop_marshal"), 
	]],				
	
	#oim_zagloba_marshal_help
	[anyone,"oim_zagloba_auto_help", [
		(check_quest_active, "qst_oim_potop_marshal_started"),
		(neg|check_quest_succeeded, "qst_oim_potop_marshal_started"), 
		(neg|check_quest_finished,"qst_oim_potop_marshal_started"),
		(quest_slot_eq, "qst_oim_potop_marshal_started", slot_quest_current_state, 1),
	], "Congratulations, my son! Oh, never in my wildest dreams did I imagine myself the Marshal's counselor. Soon we shall rain merry hell upon all our foes!", "member_talk", [
		(call_script, "script_troop_add_gold", "trp_player", 3500),
		(add_xp_as_reward, 4000),
		(call_script, "script_succeed_quest", "qst_oim_potop_marshal_started"), 
	]],		       	
	
	#oim_potop_mission_impossible_start
	[anyone,"oim_potop_mission_impossible_start", [], "Well, Marshal, under your mighty hand, our hosts shall swiftly crush all our foes.", "oim_potop_mission_impossible_start_1", []],			
	[anyone|plyr,"oim_potop_mission_impossible_start_1", [], "That is my hope as well, my lord.", "oim_potop_mission_impossible_start_2", []],			
	[anyone,"oim_potop_mission_impossible_start_2", [], "Then gather the troops, and let us march to war!", "oim_potop_mission_impossible_start_3", []],			
	[anyone|plyr,"oim_potop_mission_impossible_start_3", [], "And whom shall I war with?", "oim_potop_mission_impossible_start_4", []],			
	[anyone,"oim_potop_mission_impossible_start_4", [
		(call_script, "script_cf_set_oim_potop_target_centers"),
	], "Take {s3}, {s4}, {s5} and {s6} from the hands of our enemies. Such is my royal will...", "oim_potop_mission_impossible_start_5", []],			
	[anyone|plyr,"oim_potop_mission_impossible_start_5", [], "And has it occurred to you, Your Majesty, that such a decree might be impossible to follow?", "oim_potop_mission_impossible_start_6", []],			
	[anyone,"oim_potop_mission_impossible_start_6", [], "There is no challenge too great for the Polish gentry. The Polish Commonwealth is, after all, still part of the European community. And our overseas allies, from faraway colonies on the other side of the Atlantic, shall undeniably offer us military aid.", "oim_potop_mission_impossible_start_7", []],			
	[anyone|plyr,"oim_potop_mission_impossible_start_7", [], "And what if I should fail?", "oim_potop_mission_impossible_start_8", []],			
	[anyone,"oim_potop_mission_impossible_start_8", [], "Then we shall find another Marshal -- one who can stand up for the ideals of democracy! Come back with victory, or do not come back at all...", "lord_pretalk", [
		#code to init old quests and start new ones
		(call_script, "script_end_quest", "qst_oim_potop_marshal"),
		(call_script, "script_end_quest", "qst_oim_potop_marshal_started"),
		(quest_set_slot, "qst_oim_potop_mission_impossible", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_mission_impossible", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_marshal"),
		(str_store_troop_name_link, s7, "$g_talk_troop"), 
		(str_store_party_name_link, s3, "$oim_potop_target_city_1"), 
		(str_store_party_name_link, s4, "$oim_potop_target_city_2"), 
		(str_store_party_name_link, s5, "$oim_potop_target_city_3"), 
		(str_store_party_name_link, s6, "$oim_potop_target_city_4"), 
		(str_store_string, s2, "@OIM_add Nu vot teper {s7} hochet chto bi vi ustanovili kontrol nad {s3}, {s4}, {s5}, {s6}..."),
		(call_script, "script_start_quest", "qst_oim_potop_mission_impossible", "$g_talk_troop"),
		(call_script, "script_oim_spawn_defend_army", "$oim_potop_target_city_1"), 
		(call_script, "script_oim_spawn_defend_army", "$oim_potop_target_city_2"), 
		(call_script, "script_oim_spawn_defend_army", "$oim_potop_target_city_3"), 
		(call_script, "script_oim_spawn_defend_army", "$oim_potop_target_city_4"), 
	]],			

	#oim_zagloba_marshal_help
	[anyone|plyr,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_mission_impossible"),
		(neg|check_quest_succeeded, "qst_oim_potop_mission_impossible"), 
		(neg|check_quest_finished,"qst_oim_potop_mission_impossible"),
		(quest_slot_eq, "qst_oim_potop_mission_impossible", slot_quest_current_state, 0), 
	], "I have no clue how to execute such an order. I feel as if Jan Kasimir simply wants to get rid of me! Colonel Zagloba, I am in great need of your counsel.", "oim_potop_mission_impossible_zagloba", []],
	[anyone,"oim_potop_mission_impossible_zagloba", [], "We may be able to fulfill this command, but it will be no easy task. You shall need a force second to none. -- Ask our old comrades, Skrzetuski, Kmicic and Wolodyjowski. I think they might assist you.", "member_talk", []],		
		
	#oim_potop_mission_impossible_last
	[anyone|plyr,"oim_potop_mission_impossible_last", [], "Sire, your people rejoice. The Polish Commonwealth has crushed its foes, and regained all the lands which had been stolen from us.", "oim_potop_mission_impossible_last_1", []],			
	[anyone,"oim_potop_mission_impossible_last_1", [], "Truly you have accomplished the impossible, Marshal. I must admit my error. You are well worthy of your title.", "oim_potop_mission_impossible_last_2", [
		#code to end quest
		(call_script, "script_troop_add_gold", "trp_player", 3500),
		(add_xp_as_reward, 8000),
		#(call_script, "script_succeed_quest", "qst_oim_potop_mission_impossible"), 
		(call_script, "script_end_quest", "qst_oim_potop_mission_impossible"),
	]],			
	
	#switch to moscow tzar hunting
	[anyone|auto_proceed,"oim_potop_mission_impossible_last_2", [
        (store_relation, ":cur_relation", "fac_kingdom_1", "fac_kingdom_2"),
        (lt, ":cur_relation", 0),
	], "{!}NOT SHOWN", "oim_potop_moscow_tsar_hunt_start_dlg", []],	
		
	#Not at war
	[anyone|auto_proceed,"oim_potop_mission_impossible_last_2", [], "{!}NOT SHOWN", "lord_pretalk", [
		#start ahtung
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 15),
	]],			
	
	#oim_potop_moscow_tsar_hunt_start_dlg
	[anyone,"oim_potop_moscow_tsar_hunt_start_dlg", [], "The Swedes and the Zaporozhians have been dealt with -- and well done. But the gravest foe of the Polish Commonwealth is the Muscovite Tsardom. Only one great power can prevail, and it shall be either we or they.", "oim_potop_moscow_tsar_hunt_start_dlg_1", []],			
	[anyone|plyr,"oim_potop_moscow_tsar_hunt_start_dlg_1", [], "My lord, your orders are to conquer Muscovy?", "oim_potop_moscow_tsar_hunt_start_dlg_2", []],			
	[anyone,"oim_potop_moscow_tsar_hunt_start_dlg_2", [], "Nay, Marshal. History has taught us that such an effort could only be in vain. Our forefathers once took Moscow, but the entire people rose against us, and we had to retreat. Our scheme must be more cunning.", "oim_potop_moscow_tsar_hunt_start_dlg_3", []],			
	[anyone|plyr,"oim_potop_moscow_tsar_hunt_start_dlg_3", [], "I am intrigued, Sire...", "oim_potop_moscow_tsar_hunt_start_dlg_4", []],			
	[anyone,"oim_potop_moscow_tsar_hunt_start_dlg_4", [], "We must capture the Russian Tsar. When we have secured him in Warsaw, he shall become our political tool, and his barbaric nation shall no longer pose any threat to us.", "oim_potop_moscow_tsar_hunt_start_dlg_5", []],			
	[anyone|plyr,"oim_potop_moscow_tsar_hunt_start_dlg_5", [], "As you wish. I set out at once.", "lord_pretalk", [
		#code to start dlg
		#qst_oim_potop_capture_tszar
		(quest_set_slot, "qst_oim_potop_capture_tszar", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_capture_tszar", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_capture_tszar"),
		#(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_troop_name_link, s3, "trp_kingdom_2_lord"), 
		(str_store_string, s2, "@OIM_add  {s2} hochet chto bi vzali v plen {s3}"),
		(call_script, "script_start_quest", "qst_oim_potop_capture_tszar", "$g_talk_troop"),
	]],			

	[anyone|plyr,"oim_zagloba_help_answer", [
		(check_quest_active, "qst_oim_potop_capture_tszar"),
		(neg|check_quest_succeeded, "qst_oim_potop_capture_tszar"), 
		(neg|check_quest_finished,"qst_oim_potop_capture_tszar"),
		(quest_slot_eq, "qst_oim_potop_capture_tszar", slot_quest_current_state, 0), 
	], "What do you think we should do now?", "oim_potop_mission_impossible_zagloba", []],
	[anyone,"oim_potop_mission_impossible_zagloba", [], "I think we can do it!", "member_talk", [
		(quest_set_slot, "qst_oim_potop_capture_tszar", slot_quest_current_state, 1),
	]],		

	#oim_potop_capture_tzar_dlg_captured
	[anyone,"oim_potop_capture_tzar_dlg_captured", [], "The Muscovite Tsardom shall not offer a ransom for me. -- But if you should set me free, we could forget all the troubles between us, and I would accept you into my service.", "oim_potop_capture_tzar_dlg_captured_1", []],			
	[anyone|plyr,"oim_potop_capture_tzar_dlg_captured_1", [], "A nobleman of the Polish Commonwealth would never collude with the enemy.", "close_window", [
		(call_script, "script_succeed_quest", "qst_oim_potop_capture_tszar"), 
	]],			
	[anyone|plyr,"oim_potop_capture_tzar_dlg_captured_1", [], "Hmm, yes -- why not? I must admit that I have grown tired of serving the Polish King.", "close_window", [
		#code to fail main quest and switching main hero to Moscow Tszardom
		(call_script, "script_fail_quest", "qst_oim_potop_main"),
		(assign, "$g_main_quest_active", 2),
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 100),
		(party_remove_prisoners, "p_main_party", "$g_talk_troop", 1),
		(remove_troops_from_prisoners, "$g_talk_troop", 1),

        (unlock_achievement, ACHIEVEMENT_POLISH_DRAMA),        

		(call_script, "script_end_quest", "qst_oim_potop_main"),
	    (call_script, "script_retire_companion", "trp_npc1", 100), 
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", -3),
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_1", -3),
		(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(call_script, "script_player_leave_faction", 1),
		(assign, "$g_talk_troop_faction", "fac_kingdom_2"), 
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
			(call_script, "script_update_all_notes"),
			(assign, "$g_recalculate_ais", 1),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
		(try_begin),
			(gt, "$g_invite_offered_center", 0),
			(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
			(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(try_end),
	    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		(assign, "$g_leave_encounter",1),		
	]],			

	#oim_potop_capture_tzar_last_dlg
	[anyone|auto_proceed,"oim_potop_capture_tzar_last_dlg", [], "{!}NOT SHOWN", "oim_potop_capture_tzar_dlg_captured_1_1", []],			
	[anyone|plyr,"oim_potop_capture_tzar_dlg_captured_1_1", [
		(party_count_prisoners_of_type, ":rslt", "p_main_party", "trp_kingdom_2_lord"),
		(lt, ":rslt", 1), 
		], "I have mobilized all our forces that we may capture the Tsar!", "lord_pretalk", []],			
	[anyone|plyr,"oim_potop_capture_tzar_dlg_captured_1_1", [], "Your Majesty, I have the Russian Tsar. Where do you order him placed?", "oim_potop_capture_tzar_dlg_captured_2", []],			
	[anyone,"oim_potop_capture_tzar_dlg_captured_2", [], "In the mightiest stronghold, guarded by our finest cuirassier regiment! My gratitude, Marshal. You may now busy yourself with your own affairs. You have well earned a rest.", "oim_potop_capture_tzar_dlg_captured_3", []],			
	[anyone|plyr,"oim_potop_capture_tzar_dlg_captured_3", [], "I expected a more tangible reward -- another village, perhaps.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 15),
		(call_script, "script_troop_add_gold", "trp_player", 3500),
		(add_xp_as_reward, 4000),
		(call_script, "script_end_quest", "qst_oim_potop_capture_tszar"),
		(remove_troops_from_prisoners,  "trp_kingdom_2_lord", 1),
		(call_script, "script_remove_troop_from_prison", "trp_kingdom_2_lord"),
	]],			

	
	[anyone|auto_proceed,"oim_zagloba_auto_help", [
		(check_quest_active, "qst_oim_potop_main"),
		(neg|check_quest_finished,"qst_oim_potop_main"),
		(quest_slot_eq, "qst_oim_potop_main", slot_quest_current_state, 15), 
	], "{!}NOT SHOWN", "oim_zagloba_start_qst_rp_king", [
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 16), 
	]],	
	
	[anyone,"oim_zagloba_start_qst_rp_king", [], "You know, I been through every pub in the land, and spoken with the gentry as well... And my, how displeased our commanders are with their King!", "oim_zagloba_start_qst_rp_king_1", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_1", [], "And why is this, Colonel Zagloba?", "oim_zagloba_start_qst_rp_king_2", []],			
	[anyone,"oim_zagloba_start_qst_rp_king_2", [], "The king has allowed Catholicism to take root in Ukraine, which is sure to lead to more bloody riots. Worse, he is readying to make peace with the Swedes, and makes overtures to the Crimean Khan, who we well know would steal from us far more than he could offer us in return. I fear the Polish Commonwealth needs a new king...", "oim_zagloba_start_qst_rp_king_3", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_3", [], "And what are your thoughts? A quiet coup at the palace? Or will it be civil war?", "oim_zagloba_start_qst_rp_king_4", []],			
	[anyone,"oim_zagloba_start_qst_rp_king_4", [], "Good God, no! Naturally, the King shall abdicate of his own free will.", "oim_zagloba_start_qst_rp_king_5", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_5", [], "Of his own free will, you say? He will require a very solid reason for such an act.", "oim_zagloba_start_qst_rp_king_6", []],			
	[anyone,"oim_zagloba_start_qst_rp_king_6", [], "Should all the gentry put forth that the King is out of favor, then surely he will have little choice in the matter...", "oim_zagloba_start_qst_rp_king_7", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_7", [], "And who do you, Colonel Zagloba, predict shall take up the crown of the Polish Commonwealth?", "oim_zagloba_start_qst_rp_king_8", []],			
	[anyone,"oim_zagloba_start_qst_rp_king_8", [], "Well, when I last had a dinner in a pub in Warsaw, and shared my concerns about the fates of our motherland with the gentry, they cheered -- ""Coronate Zagloba!"".", "oim_zagloba_start_qst_rp_king_9", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_9", [], "So that's what you're going on about, old man?", "oim_zagloba_start_qst_rp_king_10", []],			
	[anyone,"oim_zagloba_start_qst_rp_king_10", [], "Precisely, my son, may the devils roast me. Thank you for offering me refuge, and sharing your bread with an old man. But now, I must wish you farewell. The loyal gentry awaits me. Oh, and if you wish to swear allegiance to your new emperor, you might take the opportunity before I go.", "oim_zagloba_start_qst_rp_king_11", []],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_11", [], "I'm coming with you.", "oim_zagloba_start_qst_rp_king_12", []],			
		[anyone|plyr,"oim_zagloba_start_qst_rp_king_12", [], "Jan Kasimir truly isn't the best leader for Poland. Who knows, perhaps Zagloba is the very King our nation needs?", "close_window", [
			#oim code !vetka za Zaglobu
			(quest_set_slot, "qst_oim_potop_dismiss_king", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_potop_dismiss_king", slot_quest_current_state, 1),
			(setup_quest_text, "qst_oim_potop_dismiss_king"),
			(str_store_string, s2, "@OIM_add  Teper pora sobrat koaliciyu protiv korolya i smestit ego s trona"),
			(call_script, "script_start_quest", "qst_oim_potop_dismiss_king", "$g_talk_troop"),		
			#fix this
			#(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 2), 
			(try_for_range, ":cur_troop", kingdom_heroes_begin, kingdom_heroes_end),
				(troop_set_slot, ":cur_troop", slot_troop_support_hero, 0),
			(end_try), 
		]],			
	[anyone|plyr,"oim_zagloba_start_qst_rp_king_11", [], "I have never been a traitor.", "oim_zagloba_start_qst_rp_king_13", []],			
		[anyone|plyr,"oim_zagloba_start_qst_rp_king_13", [], "Remember then, old man, that there are such things like glory and honor!", "close_window", [
		#oim code !vetka za Korolya
		#qst_oim_potop_king_elections_kings_node
			(quest_set_slot, "qst_oim_potop_king_elections_kings_node", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_potop_king_elections_kings_node", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_potop_king_elections_kings_node"),
			(str_store_troop_name_link, s3, "trp_kingdom_1_lord"), 
			(str_store_troop_name, s4, "trp_npc1"), 
			(str_store_string, s2, "str_oim_zagloba_rising_descr"),
			(call_script, "script_start_quest", "qst_oim_potop_king_elections_kings_node", "$g_talk_troop"),
			(call_script, "script_retire_companion", "trp_npc1", 100), 
		]],			

	#oim_potop_zagloba_uprising
	[anyone,"oim_potop_zagloba_uprising", [], "What? Again?! And with whom was my dear wife unfaithful this time?", "oim_potop_zagloba_uprising_1", []],			
	[anyone|plyr,"oim_potop_zagloba_uprising_1", [], "'Tis no joking matter, my King. The irrepressible Zagloba has gathered all the malcontent gentry, and is preparing to stage an uprising...", "oim_potop_zagloba_uprising_2", []],			
	[anyone,"oim_potop_zagloba_uprising_2", [], "God bless. And I thought... Oh, why you, {playername} -- you see dirty tricks everywhere. Even now you imagine that a drunk and horseless man who has been run out of every pub in the country, shall take down a King. So there are murmurs of discontentment amongst the Sejm, but so what? We, the Vasa, have ruled this great nation well, and shall continue its rule into the coming ages.", "oim_potop_zagloba_uprising_3", []],			
	[anyone|plyr,"oim_potop_zagloba_uprising_3", [], "You must believe me, my King, before it is too late.", "oim_potop_zagloba_uprising_4", []],			
	[anyone,"oim_potop_zagloba_uprising_4", [], "I will believe you, if you provide some momentous facts to back up your momentous theories.", "lord_pretalk", [
		#qst_oim_potop_zagloba_revoult
		(quest_set_slot, "qst_oim_potop_zagloba_revoult", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_zagloba_revoult", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_zagloba_revoult"),
		(str_store_string, s2, "str_oim_zagloba_revolt_proofs"),
		(call_script, "script_start_quest", "qst_oim_potop_zagloba_revoult", "$g_talk_troop"),
		(quest_set_slot, "qst_oim_potop_king_elections_kings_node", slot_quest_current_state, 1),
	]],			

	#oim_potop_zagloba_uprising_lord_dlg
	[anyone,"oim_potop_zagloba_uprising_lord_dlg", [], "Zagloba has issued a royal decree which states that Jan Kasimir is to be dethroned for the betrayal of the gentry -- and Zagloba himself appointed the provisional military regent! He carries this parchment through the towns and villages, and reads it loudly in the public squares. His allies multiply by the dozens. The gentry that yet remain loyal pray to God that someone will stop him.", "oim_potop_zagloba_uprising_lord_dlg_1", []],			
	[anyone|plyr,"oim_potop_zagloba_uprising_lord_dlg_1", [], "I too will light a candle and say a prayer for our dear King. After supper, perhaps...", "lord_pretalk", [
		(try_begin), 
			(neg|quest_slot_eq, "qst_oim_potop_zagloba_revoult", slot_quest_current_state, 2),
			(quest_set_slot, "qst_oim_potop_zagloba_revoult", slot_quest_current_state, 2),
			(set_spawn_radius, 4),
			(spawn_around_party, "p_town_6", "pt_oim_zagloba_party"),
			(assign, ":zagloba_party", reg0),
			(party_set_ai_behavior, ":zagloba_party", ai_bhvr_hold),
			(party_set_ai_object, ":zagloba_party", "p_town_6"),
			(party_set_flags, ":zagloba_party", pf_default_behavior, 0),
			(party_get_position, pos1, "p_town_6"),
			(map_get_random_position_around_position, pos2, pos1, 1),
			(party_set_ai_behavior, ":zagloba_party", ai_bhvr_patrol_location),
			(party_set_ai_patrol_radius, ":zagloba_party", 10),
			(party_set_ai_target_position, ":zagloba_party", pos2),
			(party_set_ai_object, ":zagloba_party", "p_town_6"),
			(party_set_flags, ":zagloba_party", pf_default_behavior, 0),
			(party_set_slot, ":zagloba_party", slot_party_follow_me, 1),
			(party_set_slot, ":zagloba_party", slot_party_ai_substate, 0),		
			(party_add_members, ":zagloba_party", "trp_oim_zagloba_qst", 1),
			(call_script, "script_oim_spawn_strong_army", ":zagloba_party", "fac_kingdom_1"),
			(troop_set_slot, "trp_oim_zagloba_qst", slot_troop_leaded_party, ":zagloba_party"),
			(quest_set_slot, "qst_oim_potop_zagloba_revoult", slot_quest_target_party, ":zagloba_party"),
		(end_try), 	
	]],			

	
	#oim_potop_zagloba_pre_fight_dlg	
	[anyone|plyr,"oim_potop_zagloba_pre_fight_dlg", [], "Listen well, old man! You must stop stirring up the people. Go home and watch over your grandsons. Put down this decree of yours, before you have driven the Polish Commonwealth into civil war!", "oim_potop_zagloba_pre_fight_dlg_1", []],			
	[anyone,"oim_potop_zagloba_pre_fight_dlg_1", [], "How dare you, whelp, speak with such disrespect before the emperor! -- That is to say, the provisional military regent of the Polish Commonwealth. Draw your weapon!", "close_window", [[encounter_attack]]],			
	
	#oim potop end line. 
	
	#oim_potop_universal_delivered
	[anyone,"oim_potop_universal_delivered", [], "What is it? Ah, yes, let me read it... John Vasa... a stranger... abolisher of the gentry and the natural liberties of the Cossacks... a Jesuit fosterling... a coward and an untalented warlord... What, is this about me?", "oim_potop_universal_delivered_1", []],			
	[anyone|plyr,"oim_potop_universal_delivered_1", [], "Yes, precisely. Read the signature.", "oim_potop_universal_delivered_2", []],			
	[anyone,"oim_potop_universal_delivered_2", [], "By God's grace, the regent and emperor of the Polish Commonwealth, Onufry the First, known by the name of Zagloba the Terrible...", "oim_potop_german_mercanaries", [
		(call_script, "script_troop_add_gold", "trp_player", 3500),
		(add_xp_as_reward, 4000),
		#(call_script, "script_succeed_quest", "qst_oim_potop_zagloba_revoult"), 
		(call_script, "script_end_quest", "qst_oim_potop_zagloba_revoult"),
	]],			

	[anyone,"oim_potop_german_mercanaries", [
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
		(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(str_store_party_name, s3, "$g_invite_offered_center"), 
		(try_for_range, ":army_no", 1, 7), 
			(eq, ":army_no", ":army_no"),
			(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_4", "p_town_1"), 
			(assign, ":spawn_point", reg0), 
			(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_1", "p_town_6"),
			(assign, ":target_party", reg0), 
			(set_spawn_radius, 3),
			(spawn_around_party, ":spawn_point", "pt_oim_potop_mercs_army"),
			(assign, ":party_no", reg0),
			(party_get_position, pos1, ":target_party"),
			(map_get_random_position_around_position, pos2, pos1, 1),
			(party_set_ai_behavior, ":party_no", ai_bhvr_patrol_location),
			(party_set_ai_patrol_radius, ":party_no", 10),
			(party_set_ai_target_position, ":party_no", pos2),
			(party_set_ai_object, ":party_no", ":target_party"),
			(party_set_flags, ":party_no", pf_default_behavior, 0),
			(party_set_slot, ":party_no", slot_party_follow_me, 1),
			(party_set_slot, ":party_no", slot_party_ai_substate, 0),		
			(call_script, "script_oim_spawn_strong_army", ":party_no", "fac_kingdom_4"),
		(end_try), 
	], "My God! So you were right... Well... yes you will receive the village of {s3} as a reward for your loyal service. As for the rest, do not let it trouble you. I shall compose a letter to my friend the German emperor, and he shall send a force of trusty mercenaries, who shall crush the uprising in its cradle.", "oim_potop_german_mercanaries_1", []],			
	[anyone|plyr,"oim_potop_german_mercanaries_1", [], "But the Sejm may not approve of such deeds!", "oim_potop_german_mercanaries_2", []],			
	[anyone,"oim_potop_german_mercanaries_2", [], "The Sejm shall be abolished! Sooner or later, the gentry would have doomed the nation to ruin by their unruliness. Therefore as of this day I proclaim the Republic abolished, and the creation of the Great Duchy of Poland, along with the Great Duchies of Russia, Lithuania, and Kiev...", "oim_potop_german_mercanaries_3", []],			
	[anyone|plyr,"oim_potop_german_mercanaries_3", [], "Very well, then a kingdom it shall be...", "lord_pretalk", [
		(quest_set_slot, "qst_oim_potop_king_elections_kings_node", slot_quest_current_state, 2),
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 20),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_potop_king_elections_kings_node", slot_quest_start_time, ":cur_day"),
		#code to start hell
		(assign, "$g_recalculate_ais", 1),
		(call_script, "script_update_all_notes"),
		(str_store_string, s2, "str_hero_supported_the_king"),  
		(add_quest_note_from_sreg, "qst_oim_potop_king_elections_kings_node", 4, s2, 1),
		(call_script, "script_oim_rise_rebellion", "fac_kingdom_1", "trp_knight_1_1"), 
		(call_script, "script_change_troop_faction", "trp_knight_1_2", "fac_oim_rebel_faction"), 
		(call_script, "script_change_troop_faction", "trp_knight_1_3", "fac_oim_rebel_faction"), 	
		(call_script, "script_diplomacy_start_war_between_kingdoms", "fac_oim_rebel_faction", "fac_kingdom_1", 1),		
	]],			
	[anyone|plyr,"oim_potop_german_mercanaries_3", [], "Nay, king.", "oim_potop_german_mercanaries_4", []],			
	[anyone|plyr,"oim_potop_german_mercanaries_4", [], "I would have been your ally against the uprising, but not in your abolition of the Republic. And if you should call in your mercenaries, I shall drive them back wherever they came from.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
		#qst_oim_potop_destroy_mercs
		(quest_set_slot, "qst_oim_potop_destroy_mercs", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_potop_destroy_mercs", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_destroy_mercs"),
		(str_store_string, s2, "@OIM_add  Teper kogda nachalos vtorzhenie - pora ostanovit nayomnikov"),
		(call_script, "script_start_quest", "qst_oim_potop_destroy_mercs", "trp_player"),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_potop_destroy_mercs", slot_quest_start_time, ":cur_day"),
		(assign, "$g_recalculate_ais", 1),
		(call_script, "script_update_all_notes"),		
		
	]],			

	#oim_potop_zagloba_return_dlg
	[anyone,"oim_potop_zagloba_return_dlg", [], "Greetings, {playername}. At last I have found you.", "oim_potop_zagloba_return_dlg_1", []],			
	[anyone|plyr,"oim_potop_zagloba_return_dlg_1", [], "Good day to you too, Colonel Zagloba. What brings you here?", "oim_potop_zagloba_return_dlg_2", []],			
	[anyone,"oim_potop_zagloba_return_dlg_2", [], "Word came to me that you parted ways with Jan Kasimir. And not in a good way...", "oim_potop_zagloba_return_dlg_3", []],			
	[anyone|plyr,"oim_potop_zagloba_return_dlg_3", [], "This is true. The King resolved to disband the Sejm, and abolish the Sejm. I see now that I was wrong in trying to protect him.", "oim_potop_zagloba_return_dlg_4", []],			
	[anyone,"oim_potop_zagloba_return_dlg_4", [], "I warned you! Better you had listened to old Zagloba, eh? For my voice is the people's voice! So, what do you plan to do now?", "oim_potop_zagloba_return_dlg_5", []],			
	[anyone|plyr,"oim_potop_zagloba_return_dlg_5", [], "Well... I already routed the mercenaries that the King sent against the gentry.", "oim_potop_zagloba_return_dlg_6", []],			
	[anyone,"oim_potop_zagloba_return_dlg_6", [], "So you're finally ready to support the true patriots?", "oim_potop_zagloba_return_dlg_7", []],			
	[anyone|plyr,"oim_potop_zagloba_return_dlg_7", [], "Yes, I am ready.", "oim_potop_zagloba_return_dlg_pos", []],			
		[anyone,"oim_potop_zagloba_return_dlg_pos", [], "Good then. Let me say, I always believed in you. And here -- I shall give you your first assignment! Try speaking to the gentry, and inspire them to our cause. Today I am but a lonely rebel in hiding, but they will listen to you.", "close_window", [
			(call_script, "script_end_quest", "qst_oim_potop_king_elections_kings_node"),
			(call_script, "script_end_quest", "qst_oim_potop_destroy_mercs"), 
			(add_xp_as_reward, 4000),

            (unlock_achievement, ACHIEVEMENT_POLISH_DRAMA),            

			#qst_oim_potop_dismiss_king
			(try_for_range, ":cur_troop", kingdom_heroes_begin, kingdom_heroes_end),
				(store_troop_faction, ":cur_faction", ":cur_troop"), 
				(eq, ":cur_faction", "fac_kingdom_1"),
				(troop_set_slot, ":cur_troop", slot_troop_support_hero, 0), 
			(end_try), 	
			(quest_set_slot, "qst_oim_potop_dismiss_king", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_potop_dismiss_king", slot_quest_current_state, 1),
			(setup_quest_text, "qst_oim_potop_dismiss_king"),
			(str_store_string, s2, "@OIM_add  Teper pora sobrat koaliciyu protiv korolya i smestit ego s trona"),
			(call_script, "script_start_quest", "qst_oim_potop_dismiss_king", "$g_talk_troop"),
			(call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
			(jump_to_menu, "mnu_auto_return_to_map"), 
			(finish_mission), 
		]],			
	[anyone|plyr,"oim_potop_zagloba_return_dlg_7", [], "I am still not ready to stand openly against the king.", "oim_potop_zagloba_return_dlg_neg", []],			
		[anyone|plyr,"oim_potop_zagloba_return_dlg_neg", [], "Everyone has their own truth, be it gentry or the monarchs. You'll just have to decide yourself how you must strike the balance. I shall leave now for some other place...", "close_window", [
			(call_script, "script_end_quest", "qst_oim_potop_destroy_mercs"), 
			(call_script, "script_abort_quest", "qst_oim_potop_main", -1), 
			(call_script, "script_end_quest", "qst_oim_potop_main"), 
			(assign, "$g_main_quest_active", 2),
			(jump_to_menu, "mnu_auto_return_to_map"), 
			(finish_mission), 
		]],			

	#lord_dlg_king_dismiss
	#(assign, "$cant_leave_encounter", 1),
	[anyone|plyr,"lord_dlg_king_dismiss", [], "I have heard that you are displeased with the King, sir. Word has it that he should be forced to abdicate.", "lord_dlg_king_dismiss_1", []],			
	[anyone,"lord_dlg_king_dismiss_1", [], "I am displeased with many things. But at present I am not ready to join his opponents.", "lord_dlg_king_dismiss_2", []],			
	[anyone|plyr,"lord_dlg_king_dismiss_2", [
		(troop_get_slot, ":troop_renown", "$g_talk_troop", slot_troop_renown),
		(store_mul, "$oim_potop_prise", ":troop_renown", 35), 
		(store_troop_gold, ":res", "trp_player"), 
		(ge, ":res", "$oim_potop_prise"), 
		(assign, reg0, "$oim_potop_prise"),
	], "I can pay you {reg0} thaler.", "lord_dlg_king_dismiss_positive", [
		(troop_remove_gold, "trp_player", "$oim_potop_prise"),
	]],			

	[anyone|plyr,"lord_dlg_king_dismiss_2", [
		(ge, "$g_talk_troop_relation", 	25), 
	], "Do it for me.", "lord_dlg_king_dismiss_positive", []],			

	[anyone|plyr,"lord_dlg_king_dismiss_2", [
		(store_random_in_range, ":random", 0, 100),
		(lt, ":random", 25),
	], "Are you not a patriot of your homeland?", "lord_dlg_king_dismiss_positive", []],			
	
	[anyone|plyr,"lord_dlg_king_dismiss_2", [(eq, 0, 1),], "Our forces are more powerful than the royal banner-wavers!", "close_window", [
		#no starting codition
		(quest_set_slot, "qst_oim_potop_dismiss_king", slot_quest_target_party, "$g_encountered_party"),
		(assign, "$cant_leave_encounter", 1),
		(encounter_attack),
	]],			
	
	[anyone|plyr,"lord_dlg_king_dismiss_2", [], "We shall speak again.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
	]],			
	
	#lord_dlg_king_dismiss_positive

	[anyone,"lord_dlg_king_dismiss_positive", [], "Consider it a deal. Come next Sejm, I shall renounce the King.", "close_window", [
		(try_begin),
			(quest_slot_eq, "qst_oim_potop_dismiss_king", slot_quest_current_state, 0), 
			(call_script, "script_change_troop_faction", "$g_talk_troop", "fac_oim_rebel_faction"), 
		(else_try), 
			(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1), 
		(end_try),	
		(str_clear, s4), 
		(assign, ":count", 0),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0),
				(str_store_string, s4, "@{s2}"),
			(else_try), 	
				(str_store_string, s4, "@{s4}, {s2}"),
			(end_try),	
			(val_add, ":count", 1),
		(end_try), 
		(try_begin), 
			(ge, ":count", 1),
			(str_store_string, s4, "@{s4}."),
		(end_try), 
		(str_store_string, s6, "str_oim_potop_support_list_king"),	
		(add_quest_note_from_sreg, "qst_oim_potop_dismiss_king", 4, s6, 1),
		(assign, "$g_leave_encounter", 1), 
	]],				

    #oim_potop_king_before_execution_talk
	[anyone|plyr,"oim_potop_king_before_execution_talk", [], "Your Majesty, I warned you that the people are not to be trifled with. The masses do not wish to live as before, and the elite cannot be contained.", "oim_potop_king_before_execution_talk_1", []],			
	[anyone,"oim_potop_king_before_execution_talk_1", [], "I do not understand. What are you talking about?", "oim_potop_king_before_execution_talk_2", []],			
	[anyone|plyr,"oim_potop_king_before_execution_talk_2", [], "Here is a paper which lacks only the King's signature. Your loyal Colonels may escort you...", "oim_potop_king_before_execution_talk_3", []],			
	[anyone,"oim_potop_king_before_execution_talk_3", [], "Treason! 'Tis treason! Cuirassiers, grab this rabble-rouser!", "close_window", [
		(assign, "$g_next_menu", "mnu_oim_potop_fight_with_king_result"), 
		(try_begin), 
			(eq, "$g_oim_interrior_fight", 1),
			(call_script, "script_cf_set_agent_mode_hostile"), 
		(else_try), 
			(assign, "$cant_leave_encounter", 1),
			(assign, "$g_oim_fight_with_king", 1),
			(encounter_attack),
		(end_try), 
	]],			

	#oim_potop_king_execution_zagloba_talk
	[anyone,"oim_potop_king_execution_zagloba_talk", [], "Jan Kasimir has abdicated in a cowardly manner and fled. What are your plans now?", "oim_potop_king_execution_zagloba_talk_1", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_1", [], "What of them? A Sejm is coming, one in which the gentry shall elect the new King of the Polish Commonwealth.", "oim_potop_king_execution_zagloba_talk_2", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_2", [], "Do you never imagine that all this democracy is the chiefest cause of all our constant struggles and defeats?", "oim_potop_king_execution_zagloba_talk_3", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_3", [], "What are you saying, Colonel Zagloba?", "oim_potop_king_execution_zagloba_talk_4", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_4", [], "I am saying that a powerful nation must have a powerful ruler.", "oim_potop_king_execution_zagloba_talk_5", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_5", [], "And you have one in mind?", "oim_potop_king_execution_zagloba_talk_6", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_6", [], "Of course. A famous warrior, an illustrious warlord, well-respected by the gentry.", "oim_potop_king_execution_zagloba_talk_7", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_7", [], "And who would that be?", "oim_potop_king_execution_zagloba_talk_8", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_8", [], "You.", "oim_potop_king_execution_zagloba_talk_9", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_9", [], "Me? You suppose that a kinless warrior could be elected king?", "oim_potop_king_execution_zagloba_talk_10", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_10", [], "Perhaps not... but if you exploit the confusion and seize the crown by force, many shall flock to your banners.", "oim_potop_king_execution_zagloba_talk_11", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_11", [], "And what of the rest?", "oim_potop_king_execution_zagloba_talk_12", []],			
	[anyone,"oim_potop_king_execution_zagloba_talk_12", [], "I think we might be able to persuade them. A saber, a pistol, and a band of well-weathered lads -- all heavy arguments in any quarrel.", "oim_potop_king_execution_zagloba_talk_13", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_13", [], "So be it, I shall claim the crown.", "oim_potop_king_execution_zagloba_talk_14", []],			
	[anyone|plyr,"oim_potop_king_execution_zagloba_talk_14", [], "Go now, Colonel Zagloba. Go forth and proclaim that by God's will and for the good of the Polish Commonwealth the new king shall be {playername} the First!", "close_window", [

        (unlock_achievement, ACHIEVEMENT_POLISH_DRAMA),        

		(faction_get_slot, ":old_leader", "fac_kingdom_1", slot_faction_leader),
		#(troop_set_slot, ":old_leader", slot_troop_change_to_faction, "fac_commoners"),
		(call_script, "script_oim_remove_lord", ":old_leader", "fac_kingdom_1"),
		(faction_set_slot, "fac_kingdom_1", slot_faction_leader, "trp_player"),
		(faction_set_slot, "fac_kingdom_1", slot_faction_marshall, "trp_player"),
		(faction_set_slot, "fac_kingdom_1", slot_faction_ai_state, sfai_default),
		(faction_set_slot, "fac_kingdom_1", slot_faction_ai_object, -1),
		(store_relation, ":relation", "fac_kingdom_1", "fac_player_faction"),
		(try_begin), 
			(lt, ":relation", 20),
			(call_script, "script_set_player_relation_with_faction", "fac_kingdom_1", 20),
		(end_try),		
		(call_script, "script_end_quest", "qst_oim_potop_main"),
		#code to start qst qst_oim_potop_final_qst
		(quest_set_slot, "qst_oim_potop_final_qst", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_potop_final_qst", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_final_qst"),
		(str_store_string, s2, "str_oim_last_qst_text"),
		(call_script, "script_start_quest", "qst_oim_potop_final_qst", "$g_talk_troop"),
		(call_script, "script_end_quest", "qst_oim_potop_execute_king"),
        (assign, "$g_recalculate_ais", 1),
        (call_script, "script_update_all_notes"),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			

	 
  	#oim_potop_qst_oim_potop_final_qst_guard_talk
	[anyone,"oim_potop_qst_oim_potop_final_qst_guard_talk", [], "Your Majesty, a certain Chevalier de Clermont is here to see you.", "oim_potop_qst_oim_potop_final_qst_guard_talk_1", []],			
	[anyone|plyr,"oim_potop_qst_oim_potop_final_qst_guard_talk_1", [], "Call him in, then.", "close_window", [
		(assign, "$oim_auto_talk_troop", "trp_oim_killer_qst"), 
		(jump_to_menu, "mnu_oim_auto_talk_menu"),
		(finish_mission),
		(music_set_situation, 0),
	]],			
  
	#oim_potop_qst_oim_potop_final_qst_killer_talk 
	[anyone|plyr,"oim_potop_qst_oim_potop_final_qst_killer_talk", [], "Who are you? And what do you need?", "oim_potop_qst_oim_potop_final_qst_killer_talk_1", []],			
	[anyone,"oim_potop_qst_oim_potop_final_qst_killer_talk_1", [], "Please, reject not my plea, Sire.", "oim_potop_qst_oim_potop_final_qst_killer_talk_2", []],			
	[anyone|plyr,"oim_potop_qst_oim_potop_final_qst_killer_talk_2", [], "I advise you to speak to my chancellor.", "oim_potop_qst_oim_potop_final_qst_killer_talk_3", []],			
	[anyone,"oim_potop_qst_oim_potop_final_qst_killer_talk_3", [], "There is no need.", "close_window", [
		(str_store_string, s2, "str_oim_potop_hero_killed"),
		(jump_to_menu, "mnu_oim_last_game_menu"),

        (unlock_achievement, ACHIEVEMENT_POLISH_DRAMA),        

		(finish_mission),
		(music_set_situation, 0),
	]],			
	
	#oim_potop_intro_to_the_quest
	[anyone,"oim_potop_intro_to_the_quest", [], "I see you are a friend of our nation. Hear this, then. Troubled times have befallen the Republic of the gentry. The fires of Cossack rebellion has scorched Ukraine. Just as the soldiers of the crown overcame the Cossacks, so has Hetman Hmelnitski sworn allegiance to the Russian Tsar.", "oim_potop_intro_to_the_quest_1", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_1", [], "I heard that the Tsar of Moscow has levied war against the Polish king...", "oim_potop_intro_to_the_quest_2", []],			
	[anyone,"oim_potop_intro_to_the_quest_2", [], "These words are true. A great host has entered Lithuania, and together with the Cossacks it threatens our forces.", "oim_potop_intro_to_the_quest_3", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_3", [], "What of the Tatars?", "oim_potop_intro_to_the_quest_4", []],			
	[anyone,"oim_potop_intro_to_the_quest_4", [], "The Tatars are now our allies, and fight with us against the Cossacks. However, their alliance is frail. Today they may cast their lot with us, but come tomorrow, if Hmelnitski allows them to take taxes from Ukrainian villages, they might once more side with the Cossacks.", "oim_potop_intro_to_the_quest_5", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_5", [], "And what of the King of Sweden?", "oim_potop_intro_to_the_quest_6", []],			
	[anyone,"oim_potop_intro_to_the_quest_6", [], "The new King of Sweden, Carl Gustaf, thinks only of how to bribe Polish magnates and invade the lands of the Great Poland. He gathers his men, and bides his time until we are bled white by our war with Muscovy.", "oim_potop_intro_to_the_quest_7", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_7", [], "Dear, dear... The situation is worse than ever.", "oim_potop_intro_to_the_quest_8", []],			
	[anyone,"oim_potop_intro_to_the_quest_8", [], "Any crisis, as the Latin scholars say, is an opportunity. Wars blaze up one after the other, and nations once unconquerable may one day tremble like leaves in the wind. Old dynasties pass, and make way for new ones.", "oim_potop_intro_to_the_quest_9", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_9", [], "Why do you speak of this?", "oim_potop_intro_to_the_quest_10", []],			
	[anyone,"oim_potop_intro_to_the_quest_10", [], "To show you that if you fight for the Polish Commonwealth, you have much to gain! I call you to our ranks!", "oim_potop_intro_to_the_quest_11", []],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_11", [], "The Polish Commonwealth is a mighty nation. Fighting on your side would be an honor.", "lord_pretalk", [
		#code to start qst_oim_potop_main
		(quest_set_slot, "qst_oim_potop_main", slot_quest_giver_troop, "trp_player"),  
		(quest_set_slot, "qst_oim_potop_main", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_potop_main"),
		(str_store_string, s2, "@OiMP2_str_qst_potop_general_line"),

        (unlock_achievement, ACHIEVEMENT_FIRST_STEPS),

		(call_script, "script_start_quest", "qst_oim_potop_main", "trp_player"),
		(assign, "$g_main_quest_active", 1),
		(call_script, "script_add_notification_menu", "mnu_notification_simple_str", "str_oim_kings_service_notification", -1), 
	]],			
	[anyone|plyr,"oim_potop_intro_to_the_quest_11", [], "Sorry to say this to you, but I feel your cause is lost.", "oim_potop_intro_to_the_quest_12", []],			
		[anyone|plyr,"oim_potop_intro_to_the_quest_12", [], "Bah! Your nation is the author of its own misfortunes. You and your liberal gentry will have to do without the likes of me.", "lord_pretalk", []],			
	

	
	####################################################################################################
	##  Black Getman Story line
	####################################################################################################
		
	
	#oim_getman_initial_dlg
	[anyone,"oim_getman_initial_dlg", [
		(try_begin), 
			(call_script, "script_cf_select_random_village_with_faction", "fac_kingdom_5"), 
			(assign, "$oim_getman_target_village", reg0), 
			(str_store_party_name, s10, "$oim_getman_target_village"), 
		(try_end), 	
	], "You know of {s10}? A messenger just arrived from there, and tells of a bandit attack on the village. Make haste and go to their aid, or they are surely doomed.", "oim_getman_initial_dlg_1", []],			
	
	#oim_getman_initial_dlg_1
	[anyone|plyr,"oim_getman_initial_dlg_1", [], "Yes, very well. I'll help the villagers.", "close_window", [
		(assign, "$g_leave_encounter", 1),
		#start qst
		#qst_oim_getman_defend_villages
		(quest_set_slot, "qst_oim_getman_defend_villages", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_defend_villages", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_defend_villages"),
		(str_store_party_name_link, s3, "$oim_getman_target_village"), 
		(str_store_troop_name, s4, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add_getman  {s4} hochet chto bi vi zaschtili {s3}"),
		(call_script, "script_start_quest", "qst_oim_getman_defend_villages", "$g_talk_troop"),
		(assign, "$g_main_quest_active", 1),
		(troop_set_slot, "trp_kingdom_1_pretender", slot_troop_cur_center, -1),
	]],			
	
	[anyone|plyr,"oim_getman_initial_dlg_1", [], "The petty squabbles of the country folk is none of my concern.", "close_window", [
		(assign, "$g_leave_encounter", 1),
		(call_script, "script_set_player_relation_with_faction", "fac_kingdom_5", 0),
	]],			
	
	#oim_getman_init_dlg_old_man
	#fix it!
	[anyone|plyr,"oim_getman_init_dlg_old_man", [], "What do you want, old man?", "oim_getman_init_dlg_old_man_2", []],			
	[anyone,"oim_getman_init_dlg_old_man_2", [], "Hear me... You protected this village from bandits, which proves that you are no foe of the Cossacks. I am the last keeper of a great secret...", "oim_getman_init_dlg_old_man_3", []],			
	[anyone|plyr,"oim_getman_init_dlg_old_man_3", [], "Easy there, old man. Here, let me dress your wounds and call some men to bring you into your house.", "oim_getman_init_dlg_old_man_4", []],			
	[anyone,"oim_getman_init_dlg_old_man_4", [], "Nay, my wounds are mortal. Listen now to my words, I have not long to live. For ninety five years I have lived well -- I have had more days than most. One last thing remains... to pass my knowledge to an honored comerade... Listen now...", "oim_getman_init_dlg_old_man_5", []],			
	[anyone|plyr,"oim_getman_init_dlg_old_man_5", [], "Very well, what is it?", "oim_getman_init_dlg_old_man_6", []],			
	[anyone,"oim_getman_init_dlg_old_man_6", [], "The tale of the Black Mace -- find it, and you shall save...", "close_window", [
		#code to start Black Getman qst
		(jump_to_menu, "mnu_oim_getman_defend_village_result2"),
		(quest_set_slot, "qst_oim_getman_main", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_main"),
		(str_store_string, s2, "@OIM_add_getman  starika zal no mozhet kto chto ischo znayet pro getmana"),

		(unlock_achievement, ACHIEVEMENT_FIRST_STEPS), 

		(call_script, "script_start_quest", "qst_oim_getman_main", "trp_player"),
		(assign, "$g_leave_encounter", 1),
		(finish_mission),
		(call_script, "script_add_notification_menu", "mnu_notification_simple_str", "str_oim_kings_service_notification", -1), 
	]],			

	#oim_getman_defend_villages_report
	[anyone,"oim_getman_defend_villages_report", [], "Good! You have my sincere thanks... and a small reward for your labors...", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_getman_defend_villages"),
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		(add_xp_as_reward, 1000),
	]],			
	
	#oim_getman_asking_about_getman	
	[anyone,"oim_getman_asking_about_getman", [
		(neq, "$g_talk_troop_faction", "fac_kingdom_5"), 
	], "That's the first time I hear anything of this.", "lord_pretalk", []],			
	
	[anyone,"oim_getman_asking_about_getman", [
		(store_random_in_range, ":random", 0, 100), 
		(ge, ":random", 70), 
	], "Nay, there's nothing by that name here.", "lord_pretalk", []],			
	
	[anyone,"oim_getman_asking_about_getman", [
		(store_random_in_range, ":random", 0, 100), 
		(ge, ":random", 45), 
	], "Hmm... sounds like some kind of tool of witchcraft to me.", "lord_pretalk", []],			

	#[anyone,"oim_getman_asking_about_getman", [
	#	(store_random_in_range, ":random", 0, 100), 
	#	(ge, ":random", 25), 
	#], "Mozhet koldun kakoy?", "lord_pretalk", []],			

	[anyone,"oim_getman_asking_about_getman", [
		(store_random_in_range, ":random", 0, 100), 
		(lt, ":random", 25), 
	], "Ask the Chevalier de Clermont. He is a master of legends and tales. Whatever he hears, he writes down in his special book.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 1),
		(str_store_string, s5, "@OiM_add Nu teper pora pogovorit s Klermonom"),	
		(add_quest_note_from_sreg, "qst_oim_getman_main", 4, s5, 1),
	]],			
	
   [party_tpl|pt_oim_monfor_party|auto_proceed, "start", [
	(quest_slot_eq, "qst_oim_getman_main", slot_quest_current_state, 1),
   ], "{!}NOT SHOWN", "oim_getman_klermon_help_answer",[(assign, "$g_leave_encounter", 1),]],
   #oim_getman_klermon_help_answer
   [anyone|plyr,"oim_getman_klermon_help_answer", [], "Clermont, I am told that you might know of the Black Mace.", "oim_getman_klermon_help_answer_1", []],			
   [anyone,"oim_getman_klermon_help_answer_1", [], "Ah, where have you heard of it, {playername}?", "oim_getman_klermon_help_answer_2", []],
   [anyone|plyr,"oim_getman_klermon_help_answer_2", [], "Well... it is a strange tale. One old man was mortally wounded by bandits, begged me to find the Black Mace. Sadly, he died before telling me anything of value.", "oim_getman_klermon_help_answer_3", []],			
   [anyone,"oim_getman_klermon_help_answer_3", [], "Yea, I once heard mention of the Black Mace. Alas, I know little more than you. Word has it that it is a very ancient legend...", "oim_getman_klermon_help_answer_4", []],
   [anyone|plyr,"oim_getman_klermon_help_answer_4", [], "And who told you of it?", "oim_getman_klermon_help_answer_5", []],			
   [anyone,"oim_getman_klermon_help_answer_5", [], "Once during a long drinking-bout, when word came to us that the Zaporozhians were defeated, a Cossack spoke these strange words: ""The Black Mace! If only it were in our hands, we would drive those damned Poles all the way to Paris, and the Muscovite dogs back to Siberia..."" ", "oim_getman_klermon_help_answer_6", []],
   [anyone|plyr,"oim_getman_klermon_help_answer_6", [], "Does this Cossack have a name?", "oim_getman_klermon_help_answer_7", []],			
   [anyone,"oim_getman_klermon_help_answer_7", [
		#code to select lord of Kozaks and start quest
		#qst_oim_getman_kozaks_service
		(try_begin),
			(call_script, "script_cf_get_random_lord_except_king_with_faction", "fac_kingdom_5"), 
			(assign, ":getman_traget_lord", reg0), 
			(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 2),		
			(quest_set_slot, "qst_oim_getman_kozaks_service", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_getman_kozaks_service", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_getman_kozaks_service", slot_quest_target_troop, ":getman_traget_lord"), 
			(setup_quest_text, "qst_oim_getman_kozaks_service"),
			(str_store_troop_name_link, s5, ":getman_traget_lord"), 
			(str_store_string, s2, "@OIM_add_getman  {s5} znayet o chornom getmane"),
			(call_script, "script_start_quest", "qst_oim_getman_kozaks_service", "trp_player"),
		(end_try), 	
   ], "His name is {s5}.", "oim_getman_klermon_help_answer_8", []],
   [anyone|plyr,"oim_getman_klermon_help_answer_8", [], "This is something at least -- thank you.", "oim_getman_klermon_help_answer_9", []],			
   [anyone|plyr,"oim_getman_klermon_help_answer_9", [], "Well, enjoyable labors never feel too difficult. I shall set out at once.", "oim_getman_klermon_help_answer_10", []],
   [anyone,"oim_getman_klermon_help_answer_10", [], "I must warn you... Legends of old often conceal ancient evils. Be careful -- and God's speed.", "close_window", []],			
   
   
   
   #qst_oim_getman_kozaks_service
   	#oim_getman_kozaks_service_dlg
	[anyone,"oim_getman_kozaks_service_dlg", [
		(lt, "$g_talk_troop_relation", 0), 
	], "I have no knowledge of what you speak.", "lord_pretalk", []],
	
	[anyone,"oim_getman_kozaks_service_dlg", [
		(lt, "$g_talk_troop_relation", 1),
	], "Breathe not a word of it. This is none of your concern.", "lord_pretalk", []],
	
	[anyone,"oim_getman_kozaks_service_dlg", [
		(lt, "$g_talk_troop_relation", 8),
	], "I do not know you well enough to speak of these matters with you.", "lord_pretalk", []],	
	
	[anyone,"oim_getman_kozaks_service_dlg", [
		(ge, "$g_talk_troop_relation", 7),
	], "Well, I see you are a noble {man/woman}, and well worthy of my trust. Yes, I have heard of the Black Mace.", "oim_getman_kozaks_service_dlg_1", []],	
    
	[anyone|plyr,"oim_getman_kozaks_service_dlg_1", [], "And what is that?", "oim_getman_kozaks_service_dlg_2", []],			
 	[anyone,"oim_getman_kozaks_service_dlg_2", [], "The Black Mace is an ancient relic, forged of rare metals. If the legend is true, its wielder shall never know defeat.", "oim_getman_kozaks_service_dlg_3", []],	
	[anyone|plyr,"oim_getman_kozaks_service_dlg_3", [], "And how came you to know of it?", "oim_getman_kozaks_service_dlg_4", []],			
 	[anyone,"oim_getman_kozaks_service_dlg_4", [], "Our bards sing an ancient song of the Black Mace, a song that has passed from generation to generation -- the legend of a relic destined to save Ukraine. But it is only sung in presence of Sich Cossacks. Thus no other man can learn the secret.", "oim_getman_kozaks_service_dlg_5", []],	
	[anyone|plyr,"oim_getman_kozaks_service_dlg_5", [], "The more I know, the more I want to learn the rest. Is there anything else?", "oim_getman_kozaks_service_dlg_6", []],			
 	[anyone,"oim_getman_kozaks_service_dlg_6", [], "I can perhaps offer you one thread to follow. A few years ago, our forces drove the damned lyaki across the lands. At one point, we took a banner bearer from the personal company of the Lithuanian prince Janusz Radziwill, and he tried to buy his life by telling us all the secrets of his master.", "oim_getman_kozaks_service_dlg_7", []],	
	[anyone|plyr,"oim_getman_kozaks_service_dlg_7", [], "And? Did he save his life?", "oim_getman_kozaks_service_dlg_8", []],			
 	[anyone,"oim_getman_kozaks_service_dlg_8", [], "No, we hanged him anyway. But not before he swore that he had heard Radziwill often talk of the Black Mace. Hear me now, friend. If you have set out to discover this secret, you must enter the service of the Zaporozhians. Find Radziwill, and discover what he knows.", "oim_getman_kozaks_service_dlg_9", []],	
	[anyone|plyr,"oim_getman_kozaks_service_dlg_9", [], "Very well, I'll do it.", "lord_pretalk", [
		#qst_oim_getman_za_radzivilla
		(quest_set_slot, "qst_oim_getman_za_radzivilla", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_za_radzivilla", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_getman_za_radzivilla", slot_quest_target_troop, "$g_talk_troop"), 
		(setup_quest_text, "qst_oim_getman_za_radzivilla"),
		(str_store_troop_name_link, s3, "trp_kingdom_1_pretender"),
		(str_store_string, s2, "str_oim_getman_za_radzivilla_descr"),
		(call_script, "script_start_quest", "qst_oim_getman_za_radzivilla", "trp_player"),
		(str_store_string, s5, "str_getman_talk_to_rdz_main"),	
		(add_quest_note_from_sreg, "qst_oim_getman_main", 4, s5, 1),
		(add_xp_as_reward, 1000),
		#(call_script, "script_succeed_quest", "qst_oim_getman_kozaks_service"), 
		(call_script, "script_end_quest", "qst_oim_getman_kozaks_service"),
		
	]],			

    [party_tpl|pt_oim_monfor_party|auto_proceed, "start", [
	    (check_quest_active, "qst_oim_getman_kozaks_service"), 
	    (quest_slot_eq, "qst_oim_getman_kozaks_service", slot_quest_current_state, 1),
    ], "{!}NOT SHOWN", "oim_getman_kozak_service_klermon_advice",[
		(assign, "$g_leave_encounter", 1),
		(quest_set_slot, "qst_oim_getman_kozaks_service", slot_quest_current_state, 2),
	]],	
    #oim_getman_kozak_service_klermon_advice
	
	[anyone|plyr,"oim_getman_kozak_service_klermon_advice", [
		(quest_get_slot, ":troop_no", "qst_oim_getman_kozaks_service", slot_quest_target_troop), 
		(str_store_troop_name, s2, ":troop_no"), 
	], "{s2} told me nothing when I asked him of the Black Mace.", "oim_getman_kozak_service_klermon_advice_1", []],			
 	[anyone,"oim_getman_kozak_service_klermon_advice_1", [], "Nor would he. That Cossack is a plain enough fellow at first glance, but truth be told, Cossacks can keep secrets well, and never trust strangers. You must attempt to earn his friendship, if you wish to get any information out of him.", "close_window", []],	

	##oim_general_radzivil_start_dlg	
	#[anyone,"oim_general_radzivil_start_dlg", [], "Mi Radzivilli - takie zhe potomki....", "oim_general_radzivil_start_dlg_1", []],			
	#[anyone|plyr,"oim_general_radzivil_start_dlg_1", [], "No ved korol", "oim_general_radzivil_start_dlg_2", []],			
	#[anyone,"oim_general_radzivil_start_dlg_2", [], "V etom i est nasha glavnaya beda", "oim_general_radzivil_start_dlg_3", []],			
	#[anyone|plyr,"oim_general_radzivil_start_dlg_3", [], "I chto zhe ti hochesh sdelat?", "oim_general_radzivil_start_dlg_4", []],			
	#[anyone,"oim_general_radzivil_start_dlg_4", [], "Dlya nachla vistupit protiv uzurpatora...", "pretender_start", [
	#	(troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
	#]],			

	[anyone|plyr,"pretender_start", [
		(eq, "$g_talk_troop", "trp_kingdom_1_pretender"),
		(check_quest_active, "qst_oim_getman_main"), 
		(neg|check_quest_active, "qst_oim_getman_radzivill_rebelion"), 
	], "Tell me, Prince, why is the Black Mace so famous.", "oim_getman_talk_about_rebellion", []],			
	
	#oim_getman_talk_about_rebellion
	[anyone,"oim_getman_talk_about_rebellion", [], "How did you come to know of the Black Mace? That secret is shared between but few men of knowledge.", "oim_getman_talk_about_rebellion_1", []],			
	[anyone|plyr,"oim_getman_talk_about_rebellion_1", [], "It cannot be so great secret if bards sing of it in taverns...", "oim_getman_talk_about_rebellion_2", []],			
	[anyone,"oim_getman_talk_about_rebellion_2", [], "So that is how it is... Well then you shall just have to ask the bards why it is so famous.", "oim_getman_talk_about_rebellion_3", []],			
	[anyone|plyr,"oim_getman_talk_about_rebellion_3", [], "Let us leave the jokes aside, Prince. Honestly, I feel a real connection with that mace, and I want to find out what it is.", "oim_getman_talk_about_rebellion_4", []],			
	[anyone,"oim_getman_talk_about_rebellion_4", [], "The secret of Black Mace is kept by the ancient houses of Lithuania, such as us, the Radziwill. These secrets are not meant for the ears of the strangers.", "oim_getman_talk_about_rebellion_5", []],			
	[anyone|plyr,"oim_getman_talk_about_rebellion_5", [], "And what if I become a friend to the Radziwill?", "oim_getman_talk_about_rebellion_6", []],			
	[anyone,"oim_getman_talk_about_rebellion_6", [], "How could that happen?", "oim_getman_talk_about_rebellion_7", []],			
	[anyone|plyr,"oim_getman_talk_about_rebellion_7", [], "Perhaps by aiding you in winning the throne.", "oim_getman_talk_about_rebellion_8", []],			
	[anyone,"oim_getman_talk_about_rebellion_8", [], "Ah, I see. Well then yes, anyone who would help the Radziwill could count on their patronage.", "pretender_start", [
		#code to start qst Radzivil rebelion
		#qst_oim_getman_radzivill_rebelion
		(quest_set_slot, "qst_oim_getman_radzivill_rebelion", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_radzivill_rebelion", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_radzivill_rebelion"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_troop_name_link, s4, "trp_kingdom_1_lord"), 
		(str_store_string, s2, "@OIM_add  chtobi uznat bolshe o chornom getmane nuzhno pomoch {s3} vernut tron"),
		(call_script, "script_start_quest", "qst_oim_getman_radzivill_rebelion", "$g_talk_troop"),
	]],			
	
	#qst_rebel_against_kingdom
	#qst_oim_getman_radzivill_rebelion
	
	#oim_radzivil_dlg_orders
	
	[anyone,"oim_radzivil_dlg_orders", [
		(this_or_next|check_quest_active, "qst_oim_getman_radzivill_rebelion"), 
		(             check_quest_active, "qst_rebel_against_kingdom"), 
		#(neg|check_quest_finished, "qst_oim_getman_radzivill_rebelion"), 
		(quest_slot_eq, "qst_oim_getman_radzivill_rebelion", slot_quest_current_state, 0), 
	], "As the rightful king I should take over a capital, even a temporary one. I would much prefer the thickness of stronghold walls, rather than wandering across the nation with your troops.", "oim_radzivil_capture_first_castle", []],			
	[anyone|plyr,"oim_radzivil_capture_first_castle", [], "What can I do?", "oim_radzivil_capture_first_castle_1", []],			
	[anyone,"oim_radzivil_capture_first_castle_1", [], "Leave me guarded by a trusty garrison in any city you take. I shall make it my capital.", "close_window", [
		#qst capture 
		#qst_oim_getman_radzivill_capture_city
		(try_begin), 
			(neg|check_quest_active, "qst_oim_getman_radzivill_rebelion"), 
			(quest_set_slot, "qst_oim_getman_radzivill_rebelion", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_getman_radzivill_rebelion", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_radzivill_rebelion"),
			(str_store_troop_name_link, s3, "$g_talk_troop"), 
			(str_store_troop_name_link, s4, "trp_kingdom_1_lord"), 
			(str_store_string, s2, "@OIM_add  chtobi uznat bolshe o chornom getmane nuzhno pomoch {s3} vernut tron"),
			(call_script, "script_start_quest", "qst_oim_getman_radzivill_rebelion", "$g_talk_troop"),
		(end_try), 
		(quest_set_slot, "qst_oim_getman_radzivill_capture_city", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_radzivill_capture_city", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_radzivill_capture_city"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add  {s3} prosil vas zahvatit gorod dly nego"),
		(call_script, "script_start_quest", "qst_oim_getman_radzivill_capture_city", "$g_talk_troop"),
		(quest_set_slot, "qst_oim_getman_radzivill_rebelion", slot_quest_current_state, 1), 
	]],			
	
	#oim_getman_radzivil_city_captured
	[anyone,"oim_getman_radzivil_city_captured", [
		(quest_get_slot, ":center_no", "qst_oim_getman_main", slot_quest_target_center),
		(str_store_party_name, s2, ":center_no"),
	], "Excellent! Now you can always find me in {s2}. Here is a modest amount for your war expenses.", "oim_getman_radzivil_kiev_kapture", [
		(call_script, "script_troop_add_gold", "trp_player", 3500),
		(add_xp_as_reward, 2000),
		(quest_set_slot, "qst_oim_getman_radzivill_capture_city", slot_quest_current_state, 3),
		(call_script, "script_end_quest", "qst_oim_getman_radzivill_capture_city"),
		(party_remove_members, "p_main_party", "trp_kingdom_1_pretender", 1),
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 3),
	]],				
	
	#oim_getman_radzivil_kiev_kapture
	[anyone,"oim_getman_radzivil_kiev_kapture", [
		(store_faction_of_party, ":party_faction", "p_town_3"),
		(neq, ":party_faction", "fac_player_supporters_faction"), 
	], "Our war of liberation has proven quite a success. Yet to move further we must drive our foes from Kiev, and the sooner the better. Capture the city and speak to the mayor. He is loyal to me, and will tell us if anyone be preparing for treason.", "oim_getman_radzivil_kiev_kapture_1", []],			
	[anyone|plyr,"oim_getman_radzivil_kiev_kapture_1", [], "Yes, Prince, I shall move out at once.", "close_window", [
		#qst_oim_getman_kiev_capture
		(quest_set_slot, "qst_oim_getman_kiev_capture", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_kiev_capture", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kiev_capture"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_troop_name_link, s4, "$g_talk_troop"), 
		(str_store_string, s2, "str_capture_kiev_qst_str"),
		(call_script, "script_start_quest", "qst_oim_getman_kiev_capture", "$g_talk_troop"),
		(try_begin),
			(store_faction_of_party, ":party_faction", "p_town_3"),
			(neq, ":party_faction", "fac_kingdom_1"), 
			(call_script, "script_give_center_to_faction", "p_town_3", "fac_kingdom_1"),  
			(call_script, "script_give_center_to_lord", "p_town_3", "trp_kingdom_1_lord", 0),
			(call_script, "script_remove_lords_from_center", "p_town_3"), 
			(call_script, "script_oim_spawn_strong_army", "p_town_3", "fac_kingdom_1"),
		(try_end), 	
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			
	
	#oim_getman_kiev_captured_dlg
	[anyone,"oim_getman_kiev_captured_dlg", [], "Marvelous. But we have learned from a captive rebel that there is an uprising brewing in Kiev against the King. We must discover if this is true.", "close_window", [

		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kiev_burgomistr"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add  {s3} prosil vas pogovorit s burgomistrom Kieva"),
		(call_script, "script_start_quest", "qst_oim_getman_kiev_burgomistr", "$g_talk_troop"),
		(call_script, "script_end_quest", "qst_oim_getman_kiev_capture"),
	]],			
	
	#code to start dlg
	[anyone,"oim_radzivil_dlg_orders", [
		(store_faction_of_party, ":party_faction", "p_town_3"),
		(eq, ":party_faction", "fac_player_supporters_faction"), 
		(quest_slot_eq, "qst_oim_getman_main", slot_quest_current_state, 3),
	], "The mayor of Kiev reports that some colonels are preparing a rebellion, and are intending to hand over the city to the enemy. You must go to the mayor and investigate the matter.", "close_window", [
		#qst_oim_getman_kiev_burgomistr
		(call_script, "script_troop_add_gold", "trp_player", 2500),
		(add_xp_as_reward, 1000),
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 4),
		#(call_script, "script_succeed_quest", "qst_oim_getman_radzivill_capture_city"), 
		(call_script, "script_end_quest", "qst_oim_getman_radzivill_capture_city"),
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kiev_burgomistr"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add_Kiev {s3} prosil zahvatit "),
		(call_script, "script_start_quest", "qst_oim_getman_kiev_burgomistr", "$g_talk_troop"),
	]],			
	
	[anyone,"oim_getman_radzivil_kiev_kapture", [], "The mayor of Kiev reports that some colonels are preparing a rebellion, and are intending to hand over the city to the enemy. You must go to the mayor and investigate the matter.", "close_window", [
		#qst_oim_getman_kiev_burgomistr
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kiev_burgomistr"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add  {s3} prosil vas pogovorit s burgomistrom Kieva"),
		(call_script, "script_start_quest", "qst_oim_getman_kiev_burgomistr", "$g_talk_troop"),
	]],			
	
	#oim_getman_kiev_burgomistr
	[anyone,"oim_getman_kiev_burgomistr", [], "What is your bidding, most graceful Prince?", "oim_getman_kiev_burgomistr_1", [
		(call_script, "script_succeed_quest", "qst_oim_getman_kiev_burgomistr"), 
		(quest_set_slot, "qst_oim_getman_main", slot_quest_current_state, 5),
	]],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_1", [], "The bidding of the Prince is to know the names of the traitors.", "oim_getman_kiev_burgomistr_2", []],			
	[anyone,"oim_getman_kiev_burgomistr_2", [], "Indeed there were murmurs among the warlords, but after his many victories, no one would dare betray him. Radziwill has captured Kiev once before. It was then that a strange event came to pass...", "oim_getman_kiev_burgomistr_3", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_3", [], "What happened?", "oim_getman_kiev_burgomistr_4", []],			
	[anyone,"oim_getman_kiev_burgomistr_4", [], "I know not if I should speak of it... A force was sent by Radziwill to ransack and plunder everything from the ancient monastery of Kirillovskiy.", "oim_getman_kiev_burgomistr_5", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_5", [], "What is so strange in this? The Prince is Protestant. He would not hold a Catholic church sacred, nor for that matter an Orthodox monastery.", "oim_getman_kiev_burgomistr_6", []],			
	[anyone,"oim_getman_kiev_burgomistr_6", [], "But this is where it starts getting strange... The soldiers of the prince, under cover of night, brought from the Kirillovskaya church ancient sarcophagi belonging to Kiev princes of old. I have no idea why they would be interested in such strange artifacts.", "oim_getman_kiev_burgomistr_7", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_7", [], "This is interesting indeed. Tell me more.", "oim_getman_kiev_burgomistr_8", []],			
	[anyone,"oim_getman_kiev_burgomistr_8", [], "Ah, what else is there to tell... It was so long ago, and my poor memory is failing lately.", "oim_getman_kiev_burgomistr_9", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_9", [], "Here, take his purse. Perhaps it can aid your memory.", "oim_getman_kiev_burgomistr_10", []],			
	[anyone,"oim_getman_kiev_burgomistr_10", [], "Perhaps a modest donation to city needs, say 5000 thaler, could help me remember...", "oim_getman_kiev_burgomistr_11", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_11", [
                    (store_troop_gold, ":gold", "trp_player"),
                    (ge, ":gold", 5000),
	], "So be it, here is the money.", "oim_getman_kiev_burgomistr_gold_given", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_11", [], "I will return once I have the money...", "close_window", [
		#qst_oim_getman_kiev_burgomistr_gold
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr_gold", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_kiev_burgomistr_gold", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kiev_burgomistr_gold"),
		(str_store_string, s2, "@OIM_add  Net zolota - net informacii. Kazhis etomu skuperdyayu smozhet razvyazat yazik tolko zoloto"),
		(call_script, "script_start_quest", "qst_oim_getman_kiev_burgomistr_gold", "$g_talk_troop"),
	]],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given", [], "That happened after Bogdan Hmelnitski was crushed by Berestechek. The Cossacks fled, and the forces of Janusz Radziwill entered Kiev without resistance. I was a friend of the abbot of the Kirillovskiy monastery, and I concealed myself there, in hopes that the invaders would not find me.", "oim_getman_kiev_burgomistr_gold_given_1", [
		(troop_remove_gold, "trp_player", 5000), 
		(try_begin),
			(check_quest_active, "qst_oim_getman_kiev_burgomistr_gold"), 
			#(call_script, "script_succeed_quest", "qst_oim_getman_kiev_burgomistr_gold"), 
			(call_script, "script_end_quest", "qst_oim_getman_kiev_burgomistr_gold"),
		(try_end),
	]],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_1", [], "Do not lie to me! I know you are in cahoots with Radziwill, and you have been for many years now.", "oim_getman_kiev_burgomistr_gold_given_2", []],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given_2", [], "Well, well. Just before the Lithuanian forces arrived, a messenger arrived with a letter from the Prince. He ordered to go to the monastery and meet his heralds.", "oim_getman_kiev_burgomistr_gold_given_3", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_3", [], "What then?", "oim_getman_kiev_burgomistr_gold_given_4", []],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given_4", [], "Then? Why, I opened the gate, let the troops in, and looked on as they hauled marble sarcophagi out on carts.", "oim_getman_kiev_burgomistr_gold_given_5", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_5", [], "What would Radziwill want with them?", "oim_getman_kiev_burgomistr_gold_given_6", []],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given_6", [], "I haven't the foggiest idea. The Kirillovskaya church was the family crypt of the nobles of the house of Oleg. Perhaps Radziwill believe them to be his own ancestors...", "oim_getman_kiev_burgomistr_gold_given_7", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_7", [], "And where did they take them?", "oim_getman_kiev_burgomistr_gold_given_8", []],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given_8", [], "I know not. The soldiers were silent. Only their standard bearer, upon exiting the gates, took a sip of vodka from his flask, laughed, and said these words: ""We have the Black Mace. Now we are ready for war!"" ", "oim_getman_kiev_burgomistr_gold_given_9", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_9", [], "Did I hear you right -- you said the Black Mace?", "oim_getman_kiev_burgomistr_gold_given_10", []],			
	[anyone,"oim_getman_kiev_burgomistr_gold_given_10", [], "Indeed.", "oim_getman_kiev_burgomistr_gold_given_11", []],			
	[anyone|plyr,"oim_getman_kiev_burgomistr_gold_given_11", [], "Very well, mayor, please continue to serve the city as best you can. But speak not a word of our talk here, or I shall hunt you down like a dog.^^It seems that Prince Janusz is not the simpleton as he pretends. I look forward to our next encounter...", "close_window", [
		(quest_set_slot, "qst_oim_getman_ask_add_info", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_ask_add_info", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_ask_add_info"),
		(str_store_string, s2, "@OIM_add  Nu chto zhe znya eto pora razprosit radzivila dop. informaciyu..."),
		(call_script, "script_start_quest", "qst_oim_getman_ask_add_info", "trp_player"),
	]],			
	
	#oim_radzivil_dlg_kiev_report
	[anyone,"oim_radzivil_dlg_kiev_report", [], "And what did he say?", "oim_radzivil_dlg_kiev_report_1", []],			
	[anyone|plyr,"oim_radzivil_dlg_kiev_report_1", [], "He says that Kiev is quiet. That the rebels are laying low.", "oim_radzivil_dlg_kiev_report_2", []],			
	[anyone,"oim_radzivil_dlg_kiev_report_2", [], "Very well, here is a modest sum to further our cause...", "close_window", [
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		(add_xp_as_reward, 1000),
		(call_script, "script_end_quest", "qst_oim_getman_kiev_burgomistr"),
	]],			
	
	#oim_getman_ask_add_info_dlg
	[anyone,"oim_getman_ask_add_info_dlg", [], "Let's not get ahead of ourselves. I am not yet King, but I may have an important mission for you. When you return, then we shall speak.", "oim_getman_ask_add_info_dlg_1", []],			
	[anyone|plyr,"oim_getman_ask_add_info_dlg_1", [], "And what are your thoughts this time?", "oim_getman_ask_add_info_dlg_2", []],			
	[anyone,"oim_getman_ask_add_info_dlg_2", [], "The Khan of Crimea is something of a problem. Much hangs on whom the Tatars shall ally with. March to Crimea, capture a Mirza and bring him before me. I must know everything first hand.", "oim_getman_ask_add_info_dlg_3", []],			
	[anyone|plyr,"oim_getman_ask_add_info_dlg_3", [], "So be it, Prince. I shall do your bidding.", "close_window", [
		#code capture tatarin
		#qst_oim_getman_capture_tatarin
		(quest_set_slot, "qst_oim_getman_capture_tatarin", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_capture_tatarin", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_capture_tatarin"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "@OIM_add  {s3} hochet chto bi vi vzyali v plen tatarskogo murzu..."),
		(call_script, "script_start_quest", "qst_oim_getman_capture_tatarin", "$g_talk_troop"),
	]],			
	
	[anyone|plyr,"oim_getman_captured_tatarin_dlg", [], "Where from did you get this letter?", "oim_getman_captured_tatarin_dlg_1", [(quest_set_slot, "qst_oim_getman_capture_tatarin", slot_quest_current_state, 2),]],			
	[anyone,"oim_getman_captured_tatarin_dlg_1", [], "Some days ago we met a blind man on the roads. We searched him and found this paper. There is no one among my men who can read this script. The blind man was killed, and we are delivering word to the Khan.", "oim_getman_captured_tatarin_dlg_2", []],			
	[anyone|plyr,"oim_getman_captured_tatarin_dlg_2", [], "You learned nothing from the blind man?", "oim_getman_captured_tatarin_dlg_3", []],			
	[anyone,"oim_getman_captured_tatarin_dlg_3", [], "Only the name of the one that gave him the letter.", "oim_getman_captured_tatarin_dlg_4", []],			
	[anyone|plyr,"oim_getman_captured_tatarin_dlg_4", [], "And who would that be?", "oim_getman_captured_tatarin_dlg_5", []],			
	[anyone,"oim_getman_captured_tatarin_dlg_5", [], "It was only some trader. We caught up with him in half a day, and finished him as well.", "oim_getman_captured_tatarin_dlg_6", []],			
	[anyone|plyr,"oim_getman_captured_tatarin_dlg_6", [], "Well then, this means that now only I know about the archives...", "oim_getman_captured_tatarin_dlg_7", []],			
	[anyone,"oim_getman_captured_tatarin_dlg_7", [], "What are you saying?", "oim_getman_captured_tatarin_dlg_8", []],			
	[anyone|plyr,"oim_getman_captured_tatarin_dlg_8", [], "Nothing. Take the prisoner away, and keep him under close watch.", "close_window", [
		#code to start qst_oim_getman_tampliers_archives
		(quest_set_slot, "qst_oim_getman_tampliers_archives", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_tampliers_archives", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_tampliers_archives"),
		(str_store_party_name_link, s20, "p_town_12"),
		(str_store_string, s2, "@OIM_add  pora iskat arhivi tamplierov..."),
		(call_script, "script_start_quest", "qst_oim_getman_tampliers_archives", "trp_player"),
		(call_script, "script_succeed_quest", "qst_oim_getman_capture_tatarin"), 
		(call_script, "script_end_quest", "qst_oim_getman_ask_add_info"),
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			
	
	#oim_getman_tatarin_captured
	[anyone,"oim_getman_tatarin_captured", [], "Good, I compliment your service. Here is your reward.", "oim_getman_tatarin_captured_1", []],			
	[anyone|plyr,"oim_getman_tatarin_captured_1", [], "Thank you. You promised to tell me the secret of Black Mace, Prince.", "oim_getman_tatarin_captured_2", []],			
	[anyone,"oim_getman_tatarin_captured_2", [], "Only I decide which secrets I tell -- and to whom. I told you once already that only when I have become king shall I tell you everything I know.", "oim_getman_tatarin_captured_3", []],			
	[anyone|plyr,"oim_getman_tatarin_captured_3", [], "So be it, Prince. But do not take it amiss if I go to find things out on my own...", "close_window", [
		(call_script, "script_troop_add_gold", "trp_player", 6000),
		(add_xp_as_reward, 2000),
		(call_script, "script_end_quest", "qst_oim_getman_capture_tatarin"),
   		(quest_get_slot, ":tatarin", "qst_oim_getman_capture_tatarin", slot_quest_target_troop), 
		(party_remove_prisoners, "p_main_party", ":tatarin", 1), 
	]],			
	
	#oim_getman_tampliers_archives_dweller_dlg
	[anyone|auto_proceed, "oim_getman_tampliers_archives_dweller_dlg", [], "I know not, mister. Try speaking to the mayor.", "close_window", []],			
	
	#oim_getman_riga_burgomistr_dlg_init
	[anyone|auto_proceed, "oim_getman_riga_burgomistr_dlg_init", [
		(quest_slot_eq, "qst_oim_getman_tampliers_archives", slot_quest_current_state, 0),
	], "{!}NOT SHOWN", "oim_getman_riga_burgomistr_first_talk", []],			
	
	[anyone|auto_proceed, "oim_getman_riga_burgomistr_dlg_init", [
		(quest_slot_eq, "qst_oim_getman_tampliers_archives", slot_quest_current_state, 2),
	], "{!}NOT SHOWN", "oim_getman_riga_burgomistr_access", []],			

	[anyone|auto_proceed, "oim_getman_riga_burgomistr_dlg_init", [
		(call_script, "script_cf_getman_test_riga_cond"), 
		(eq, reg0, 1),

	], "{!}NOT SHOWN", "oim_getman_riga_burgomistr_access", []],			
	
	[anyone|auto_proceed, "oim_getman_riga_burgomistr_dlg_init", [], "{!}NOT SHOWN", "oim_getman_riga_burgomistr_reject", []],			
		[anyone,"oim_getman_riga_burgomistr_reject", [], "You are not allowed into the archives without permission!", "close_window", []],			

	#oim_getman_riga_burgomistr_first_talk	
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk", [], "Sir, I must enter the archives. I need to examine an ancient Templar scroll.", "oim_getman_riga_burgomistr_first_talk_1", []],			
	[anyone,"oim_getman_riga_burgomistr_first_talk_1", [], "The town hall does indeed have some ancient papers, which bear the seal of the Order of the Temple.", "oim_getman_riga_burgomistr_first_talk_2", []],			
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk_2", [], "Tell me then, how did these Templar papers find their way to your town? The Templars have been gone for three hundred years.", "oim_getman_riga_burgomistr_first_talk_3", []],			
	[anyone,"oim_getman_riga_burgomistr_first_talk_3", [], "Yes, the order was abolished by the French king, but some part of the order's precious items and papers were saved by Teutons. It was they who brought these papers to Riga.", "oim_getman_riga_burgomistr_first_talk_4", []],			
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk_4", [], "Ah... the deeds of days gone by. But for now I am more interested in the future.", "oim_getman_riga_burgomistr_first_talk_5", []],			
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk_5", [], "I need permission to enter the archives.", "oim_getman_riga_burgomistr_first_talk_6", []],			
	[anyone,"oim_getman_riga_burgomistr_first_talk_6", [
		(call_script, "script_cf_getman_test_riga_cond"), 
		(neq, reg0, 1),
	], "Surely, you are welcome to see them. But first you will have to receive permission from our lord.", "oim_getman_riga_burgomistr_first_talk_7", []],			
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk_7", [], "And how shall I go about that?", "oim_getman_riga_burgomistr_first_talk_8", []],			
	[anyone,"oim_getman_riga_burgomistr_first_talk_8", [], "Well, best to find him and ask for yourself. It would be far easier were you yourself the {lord/lady} of Riga...", "oim_getman_riga_burgomistr_first_talk_9", []],			
	[anyone|plyr,"oim_getman_riga_burgomistr_first_talk_9", [], "That's not a bad idea...", "close_window", [
		(quest_set_slot, "qst_oim_getman_tampliers_archives", slot_quest_current_state, 1),
	]],			

	[anyone,"oim_getman_riga_burgomistr_first_talk_6", [
	], "Of course you may see them.", "oim_getman_riga_burgomistr_access", []],			

	[anyone,"oim_getman_riga_burgomistr_access", [], "Nothing stands in the way.", "close_window", [
		(jump_to_menu, "mnu_oim_getman_tamplier_archives"),
		(finish_mission),
		(music_set_situation, 0),
	]],	

	[anyone|plyr,"lord_talk", [
		#(lt, "$g_talk_troop_relation", 35),
		(party_slot_eq, "p_town_12", slot_town_lord, "$g_talk_troop"),
		(check_quest_active, "qst_oim_getman_tampliers_archives"), 
		(neg|check_quest_finished, "qst_oim_getman_tampliers_archives"),
	], "I would like to see the archives. ", "oim_getman_get_pass_to_arch", []],		

	[anyone,"oim_getman_get_pass_to_arch", [(lt, "$g_talk_troop_relation", 25),], "You are new around here. I cannot let strangers into the archives. ", "lord_pretalk", []],		
	[anyone,"oim_getman_get_pass_to_arch", [], "It should not be a problem. The burgomaster knows that we are friends, so he will certainly issue a pass for you. ", "lord_pretalk", []],		
	
	#oim_getman_nesviz_location_redz
	[anyone,"oim_getman_nesviz_location_redz", [], "I know I owe you much... But your stubbornness begins to anger me. Now is not the time to speak of it.", "lord_pretalk", [
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -15),
	]],			
	
	[anyone,"oim_getman_nesviz_location_lord", [
		(lt, "$g_talk_troop_relation", 35),
	], "I see you are a newcomer to our lands. We do not know each other well enough to speak of this..", "lord_pretalk", []],			
	
	[anyone,"oim_getman_nesviz_location_lord", [], "'Tis no secret, {sir/madam}. In the village of Nesvizh lies their family crypt.", "lord_pretalk", [
		#qst_oim_getman_nesviz_grobnica_radzivilov
		#(call_script, "script_succeed_quest", "qst_oim_getman_nesviz_grobnica_radzivilov"),
		(call_script, "script_end_quest", "qst_oim_getman_nesviz_grobnica_radzivilov"),
		(add_xp_as_reward, 1500),
		#qst_oim_getman_nesviz_legend
		(quest_set_slot, "qst_oim_getman_nesviz_legend", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_nesviz_legend", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_nesviz_legend"),
		(str_store_troop_name_link, s3, "trp_kingdom_1_pretender"),
		(str_store_party_name_link, s4, "p_village_53"),
		(str_store_faction_name_link, s5, "fac_kingdom_1"),
		(str_store_string, s2, "str_nesvizh_dungeon_descr"),
		(call_script, "script_start_quest", "qst_oim_getman_nesviz_legend", "trp_player"),
	]],			
	
	#oim_getman_nesviz_elder_village_name
	[anyone,"oim_getman_nesviz_elder_village_name", [], "Very well, I shall tell you a legend of old, to amuse you... Here it is, as it was told to me. In times immemorial, when all the lands in this area were covered by impassable woods, the Lithuanian Prince Radziwill arrived here with his forces. His hunters found many wild animals in the wood, and soon all their boats were filled of game. But there was no room for a colossal bear whom the Prince had shot himself, and so they resolved to return for the bear another time. The servants they sent for the bear somehow lost their way, and found the giant only after a few days had passed. By this time, the carcass was no longer fresh -- in Lithuanian, that would be ""Nesvizh""...", "close_window", []],			
	
	#oim_getman_nesviz_elder_dlg
	[anyone,"oim_getman_nesviz_elder_dlg", [], "I know not how to help you, {sir/madam}... How is it that you have come here? By someone's order or under your own will?", "oim_getman_nesviz_elder_dlg_1", [
		(assign, "$g_can_enter_nesviz_dangeon", 1), 
	]],			
	
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_1", [], "I seek the Black Mace.", "oim_getman_nesviz_elder_dlg_exit", []],			
			[anyone,"oim_getman_nesviz_elder_dlg_exit", [], "We are but a small settlement, {sir/madam}. We know nothing of this...", "close_window", []],			
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_1", [
			#code
			(faction_slot_eq, "fac_kingdom_1", slot_faction_leader, "trp_kingdom_1_pretender"),
			], "I serve Janusz Radziwill.", "oim_getman_nesviz_elder_dlg_2", []],				
	[anyone,"oim_getman_nesviz_elder_dlg_2", [], "Well, if you serve our new king, {sir/madam}, then hear my words. Some years ago, huge carts arrived to our old church. They were heavily loaded, but what was inside, no one knows.", "oim_getman_nesviz_elder_dlg_3", []],			
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_3", [], "What else do you know, old man? Has anyone come asking after these carts?", "oim_getman_nesviz_elder_dlg_4", []],				
	[anyone,"oim_getman_nesviz_elder_dlg_4", [], "Yes, there was one. Some days before you, an old Russian Prince arrived here. And he asked about the crypt and tombs as well. And of the Black Mace he often spoke.", "oim_getman_nesviz_elder_dlg_5", []],			
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_5", [], "What was the name of this Prince? And where would he be now?", "oim_getman_nesviz_elder_dlg_6", []],				
	[anyone,"oim_getman_nesviz_elder_dlg_6", [], "His name I know not -- he did not say. But as for where he is now, that I can tell you. Bandits took his life, not far from here. Naturally, we buried him like good Christians. Here, I will show you the grave.", "oim_getman_nesviz_elder_dlg_7", []],			
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_7", [], "The grave is of no interest to me. But these bandits -- I think I should have a talk with them...", "close_window", [
		#code to spawn nesviz bandits
		(set_spawn_radius, 1),
		#(quest_set_slot, "qst_oim_getman_nesviz_legend", slot_quest_current_state, 0),
		(spawn_around_party, "p_village_53", "pt_getman_deserters"),
		(assign, "$qst_nesviz_deserters", reg0),
		#(party_set_position, "$qst_nesviz_deserters", pos63),
		(party_set_ai_behavior, "$qst_nesviz_deserters", ai_bhvr_hold),
		(party_set_flags, "$qst_nesviz_deserters", pf_default_behavior, 0),
		(call_script, "script_oim_spawn_strong_army", "$qst_nesviz_deserters", "fac_kingdom_1"),
	]],				
		
	[anyone|plyr,"oim_getman_nesviz_elder_dlg_1", [], "I am here on my own. I am interested in ancient crypts.", "oim_getman_nesviz_elder_dlg_", []],			
		[anyone,"oim_getman_nesviz_elder_dlg_", [], "The place is dangerous. The foundations of the vault were laid by the great-grandfather of Janusz, Mikolaj Krzysztof Radziwill, known as The Orphan. He ordered a vast dungeon dug beneath the church, after he returned from a pilgrimage to Egypt. But if you are a brave {man/woman}, you may steel yourself and look inside.", "close_window", []],				

	[party_tpl|pt_getman_deserters|auto_proceed, "start", [], "{!}NOT SHOWN", "oim_getman_deserters_talk",[]],
	[anyone|plyr,"oim_getman_deserters_talk", [], "I heard you met a Russian Prince here lately.", "oim_getman_deserters_talk_1", []],				
	[anyone,"oim_getman_deserters_talk_1", [
		(quest_set_slot, "qst_oim_getman_nesviz_legend", slot_quest_target_troop, "$g_talk_troop"),
	], "Aye, this is true. Why do you ask?", "oim_getman_deserters_talk_2", []],			
	[anyone|plyr,"oim_getman_deserters_talk_2", [], "What was his name?", "oim_getman_deserters_talk_3", []],				
	[anyone,"oim_getman_deserters_talk_3", [], "Oh, smart fellow. If you want to know, then you shall give us some coins.", "oim_getman_deserters_talk_4", []],			
	[anyone|plyr,"oim_getman_deserters_talk_4", [], "How much?", "oim_getman_deserters_talk_5", []],				
	[anyone,"oim_getman_deserters_talk_5", [], "A mere... 5000 thaler.", "oim_getman_deserters_talk_6", []],			
	[anyone|plyr,"oim_getman_deserters_talk_6", [(store_troop_gold,":cur_money"), (ge, ":cur_money", 5000),], "Very well, take it.", "oim_getman_deserters_talk_next", []],				
	[anyone|plyr,"oim_getman_deserters_talk_6", [], "I think we shall skip that part. Tell me all you know, or you are done for!", "close_window", [[encounter_attack]]],				
	[anyone|auto_proceed,"oim_getman_deserters_talk_next", [], "{!}NOT SHOWN", "oim_getman_deserters_talk_9", []],				
	[anyone|plyr,"oim_getman_deserters_talk_9", [], "I am all ears...", "oim_getman_deserters_talk_12", [
		(troop_remove_gold, "trp_player", 5000),
	]],			
	[anyone,"oim_getman_deserters_talk_12", [], "I know precious little. It was just this old man riding through the woods with a few guards. Almost no money on him, no valuables -- but one ring with a seal. We didn't mean to kill him. He just fell off his horse and broke his neck.", "oim_getman_deserters_talk_13", []],				
	[anyone|plyr,"oim_getman_deserters_talk_13", [], "And his name was?", "oim_getman_deserters_talk_14", []],			
	[anyone,"oim_getman_deserters_talk_14", [], "His servant told us that his name was Prince Boryatinsky.", "oim_getman_deserters_talk_15", []],				
	[anyone|plyr,"oim_getman_deserters_talk_15", [], "At least that's something. Thank you. Now give me the ring and you can leave.", "oim_getman_deserters_talk_16", []],			
	[anyone,"oim_getman_deserters_talk_16", [], "Take it. It is not worth a dime. ", "close_window", [
		(call_script, "script_succeed_quest", "qst_oim_getman_nesviz_legend"),
		(call_script, "script_end_quest", "qst_oim_getman_nesviz_legend"),
		(add_xp_as_reward, 2500),
		#qst_oim_getman_tayna_knyaza
		(quest_set_slot, "qst_oim_getman_tayna_knyaza", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_tayna_knyaza", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_tayna_knyaza"),
		(str_store_string, s2, "@OIM_add Kyazya Olgovicha pora iskat..."),
		(call_script, "script_start_quest", "qst_oim_getman_tayna_knyaza", "trp_player"),
		(remove_party, "$g_encountered_party"),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],

    #party_is_in_town
    #g_talk_troop_party

	[anyone,"oim_getman_knyaz_boryat_dlg", [
	    (party_get_attached_to, ":attached_to_party", "$g_talk_troop_party"),
        (assign, ":party_is_in_town", 0),
        (try_begin),
			(is_between, ":attached_to_party", centers_begin, centers_end),
			(assign, ":party_is_in_town", ":attached_to_party"),
        (try_end),
		(gt, ":party_is_in_town", 0),
	], "I am busy...", "close_window", [
		(try_begin),
			(neg|check_quest_active, "qst_oim_getman_borat_dlg"),
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_borat_dlg"),
			(str_store_string, s2, "@OIM_add  nuzhno vitrusit pravdu iz sina kyaza..."),
			(call_script, "script_start_quest", "qst_oim_getman_borat_dlg", "trp_player"),
		(try_end), 
	]],				
	
	#oim_getman_knyaz_boryat_dlg	
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg", [], "Prince, I have brought sad news of your father.", "oim_getman_knyaz_boryat_dlg_1", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_1", [], "Tell me of all you know, {sir/madam}. I had almost given up hope of learning what happened to him.", "oim_getman_knyaz_boryat_dlg_2", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_2", [], "He died at a bandit's hand around Nesvizh. I am sorry, Prince.", "oim_getman_knyaz_boryat_dlg_3", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_3", [], "Oh, I told him not to go. Father, father... How did you learn of this?", "oim_getman_knyaz_boryat_dlg_4", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_4", [], "I was in Nesvizh and saw his grave.", "oim_getman_knyaz_boryat_dlg_5", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_5", [], "Perhaps you too are one of these bandits?", "oim_getman_knyaz_boryat_dlg_6", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_6", [], "Here is your father's ring.", "oim_getman_knyaz_boryat_dlg_7", []],			
		[anyone,"oim_getman_knyaz_boryat_dlg_7", [
			(ge, "$g_talk_troop_relation", 0), 
		], "You bring sad news. But 'tis better to know a black truth than nothing at all. You have my gratitude.", "oim_getman_knyaz_boryat_dlg_generik_end", []],				
		[anyone,"oim_getman_knyaz_boryat_dlg_7", [], "So you have taken our family ring as well?! Prepare to defend yourself!", "close_window", [
			#code to start qst get information from Boryatinskiy
			#qst_oim_getman_borat_dlg
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_borat_dlg"),
			(str_store_string, s2, "@OIM_add  nuzhno vitrusit pravdu iz sina kyaza..."),
			(call_script, "script_start_quest", "qst_oim_getman_borat_dlg", "trp_player"),
			#(call_script, "script_set_player_relation_with_faction", "fac_kingdom_2", -10), 
			(assign, "$cant_leave_encounter", 1),
			(assign, "$encountered_party_friendly", 0),
			(encounter_attack),
		]],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_6", [], "I, much like him, was following the trail of the Black Mace.", "oim_getman_knyaz_boryat_dlg_8", []],			
		[anyone,"oim_getman_knyaz_boryat_dlg_8", [
			(ge, "$g_talk_troop_relation", 0), 
		], "You bring sad news. But 'tis better to know a black truth than nothing at all. You have my gratitude.", "oim_getman_knyaz_boryat_dlg_generik_end", []],				
		[anyone,"oim_getman_knyaz_boryat_dlg_8", [], "So you have even intruded on our family secrets? This will cost you your life!", "close_window", [
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_borat_dlg"),
			(str_store_string, s2, "@OIM_add  nuzhno vitrusit pravdu iz sina kyaza..."),
			(call_script, "script_start_quest", "qst_oim_getman_borat_dlg", "trp_player"),
			#(call_script, "script_set_player_relation_with_faction", "fac_kingdom_2", -10), 
			(assign, "$cant_leave_encounter", 1),
			(assign, "$encountered_party_friendly", 0),
			(encounter_attack),
		]],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_6", [], "If you trust me not, Prince, then I had better go.", "oim_getman_knyaz_boryat_dlg_9", []],	
		[anyone,"oim_getman_knyaz_boryat_dlg_9", [
			(ge, "$g_talk_troop_relation", 0), 
		], "You won't be going anywhere until you tell me all you know. Otherwise, you have only yourself to blame for what befalls you.", "lord_pretalk", []],						
		[anyone,"oim_getman_knyaz_boryat_dlg_9", [], "Very well, go now. Henceforth, let us stand away from each other, as distant mountains...", "close_window", [
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_borat_dlg", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_borat_dlg"),
			(str_store_string, s2, "@OIM_add  nuzhno vitrusit pravdu iz sina kyaza..."),
			(call_script, "script_start_quest", "qst_oim_getman_borat_dlg", "trp_player"),
			#(call_script, "script_set_player_relation_with_faction", "fac_kingdom_2", -10), 
			(assign, "$cant_leave_encounter", 1),
			(assign, "$encountered_party_friendly", 0),
			(encounter_attack),
		]],				
	[anyone|auto_proceed,"oim_getman_knyaz_boryat_dlg_generik_end", [], "{!}NOT SHOWN", "oim_getman_knyaz_boryat_dlg_generik_end_1", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_1", [], "Well, Prince, do you still imagine that I murdered your father?", "oim_getman_knyaz_boryat_dlg_generik_end_2", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_generik_end_2", [], "No, I believe you, may he rest in peace. I see you are among those who know the secret of the Black Mace.", "oim_getman_knyaz_boryat_dlg_generik_end_3", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_3", [], "Indeed. I discovered that the Black Mace is in the hands of Janusz Radziwill. It remains to be seen what he plans to do with it.", "oim_getman_knyaz_boryat_dlg_generik_end_4", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_generik_end_4", [], "I know not much of these legends myself... As a child, I was taught that we, the Boryatinsky, are the descendants of the noble house of Oleg. According to one of our family legends, we are the heirs who are to inherit a certain Black Mace... Father believed that by discovering the truth behind this secret, he would bring glory and wide esteem to our house. He set out to Kiev in his search, and from there to Nesvizh. Alas, I see it was all vain...", "oim_getman_knyaz_boryat_dlg_generik_end_5", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_5", [], "Have you perhaps some notes left by your father?", "oim_getman_knyaz_boryat_dlg_generik_end_6", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_generik_end_6", [], "There was a ""Book of the Crow"" at our estate. My father would read it over and over again. But I sold it... For a hefty sum, I might add.", "oim_getman_knyaz_boryat_dlg_generik_end_7", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_7", [], "Sold it? To whom?", "oim_getman_knyaz_boryat_dlg_generik_end_8", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_generik_end_8", [], "A bookseller, whom else.", "oim_getman_knyaz_boryat_dlg_generik_end_9", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_9", [], "What was his name?", "oim_getman_knyaz_boryat_dlg_generik_end_10", []],			
	[anyone,"oim_getman_knyaz_boryat_dlg_generik_end_10", [], "Devil only knows. I did not ask, and he was quickly gone.", "oim_getman_knyaz_boryat_dlg_generik_end_11", []],				
	[anyone|plyr,"oim_getman_knyaz_boryat_dlg_generik_end_11", [], "Well, that is something at least, thank you.", "oim_getman_knyaz_boryat_dlg_generik_end_12", []],			
	
	[anyone|auto_proceed,"oim_getman_knyaz_boryat_dlg_generik_end_12", [(eq,"$talk_context",tc_hero_defeated),], "I would ask you for one thing only. Please let me go home...", "close_window", [
		#code to end quest and start quest 
		#qst_oim_getman_voron_book
		(quest_set_slot, "qst_oim_getman_voron_book", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_voron_book", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_voron_book"),
		(str_store_string, s2, "@OIM_add_getman  Pora pohozhe iskat voronovu knigu"),
		(call_script, "script_start_quest", "qst_oim_getman_voron_book", "trp_player"),
		#ending qsts
		(call_script, "script_end_quest", "qst_oim_getman_borat_dlg"),
		(call_script, "script_end_quest", "qst_oim_getman_tayna_knyaza"),
		(assign, "$g_leave_encounter", 1),
		(add_xp_as_reward, 2500),
	]],				
	[anyone|auto_proceed,"oim_getman_knyaz_boryat_dlg_generik_end_12", [], "And?", "lord_pretalk", [
		(quest_set_slot, "qst_oim_getman_voron_book", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_voron_book", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_voron_book"),
		(str_store_string, s2, "@OIM_add_getman  Pora pohozhe iskat voronovu knigu"),
		(call_script, "script_start_quest", "qst_oim_getman_voron_book", "trp_player"),
		######
		(call_script, "script_end_quest", "qst_oim_getman_tayna_knyaza"),
		(call_script, "script_end_quest", "qst_oim_getman_borat_dlg"),
		(add_xp_as_reward, 2500),
		(assign, "$g_leave_encounter", 1),
	]],				
	
	#oim_getman_buy_book_trader
	[anyone,"oim_getman_buy_book_trader", [], "And what book would that be?", "oim_getman_buy_book_trader_1", []],				
	[anyone|plyr,"oim_getman_buy_book_trader_1", [], "Book of the Crow.", "oim_getman_buy_book_trader_2", []],			
	[anyone,"oim_getman_buy_book_trader_2", [], "Yes, I have that book. It is quite rare, however... I suppose the price of 7000 thaler is just about right for such a rarity...", "oim_getman_buy_book_trader_3", []],				
	[anyone|plyr,"oim_getman_buy_book_trader_3", [
		(store_troop_gold, ":gold", "trp_player"), 
		(ge, ":gold", 7000), 
	], "Very well, connoisseur of antiquities -- here, take your thirty pieces of silver...", "close_window", [
		#code finish quest and jump to menu 
		(jump_to_menu, "mnu_oim_getman_reading_book"),
		(music_set_situation, 0),
		(change_screen_mission),	
		#(call_script, "script_succeed_quest", "qst_oim_getman_voron_book"),
		(call_script, "script_end_quest", "qst_oim_getman_voron_book"),
		(troop_remove_gold, "trp_player", 7000),
		(add_xp_as_reward, 100),
	]],			
	[anyone|plyr,"oim_getman_buy_book_trader_3", [], "I must consider whether I should buy such a costly item...", "close_window", []],			
	
	[anyone,"oim_getman_buy_book_pufnutiy_search", [
		(store_random_in_range, ":random", 0, 100), 
		(lt, ":random", 20), 
	], "I seem to recall... there is a scribe in the temple of Sophia in Novgorod -- Saint Pafnuty. He would know this ancient writ...", "close_window", [
		(assign, "$g_leave_encounter", 1), 
		(quest_set_slot, "qst_oim_getman_voron_translate", slot_quest_current_state, 1),
		(str_store_party_name_link, s6, "p_castle_6"),
		(str_store_string, s5, "@OiM_getman Knigu mozhet perevesti kakoy-to pafnutiy"),	
		(add_quest_note_from_sreg, "qst_oim_getman_voron_translate", 4, s5, 1),
	]],				
	[anyone,"oim_getman_buy_book_pufnutiy_search", [], "Nay, I know nothing.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
	]],				

	#oim_getman_pafnut_start_dlg
	[anyone|plyr,"oim_getman_pafnut_start_dlg", [], "Oh Saint, word of your knowledge has spread across the whole world. Please, be so kind to help me discern, what is written in this book.", "oim_getman_pafnut_start_dlg_1", []],				
	[anyone,"oim_getman_pafnut_start_dlg_1", [], "You hardly resemble a lover of books, my son. Why would you need this knowledge?", "oim_getman_pafnut_start_dlg_2", []],			
	[anyone|plyr,"oim_getman_pafnut_start_dlg_2", [], "I have been told it contains the descriptions of ancient arms. I am... quite interested in this subject.", "oim_getman_pafnut_start_dlg_3", []],				
	[anyone,"oim_getman_pafnut_start_dlg_3", [], "Very well, show me your book.", "oim_getman_pafnut_start_dlg_4", []],			
	[anyone|plyr,"oim_getman_pafnut_start_dlg_4", [], "Here...", "oim_getman_pafnut_start_dlg_5", []],				
	[anyone,"oim_getman_pafnut_start_dlg_5", [], "This is indeed a very ancient tongue, and I do not understand much. I need a dictionary.", "oim_getman_pafnut_start_dlg_6", []],			
	[anyone|plyr,"oim_getman_pafnut_start_dlg_6", [], "I shall find a bookseller and buy the book you need from him.", "oim_getman_pafnut_start_dlg_7", []],				
	[anyone,"oim_getman_pafnut_start_dlg_7", [], "Such a book, my son, one cannot find at vagrant traders. There is but one such dictionary in the world, and it is in my library.", "oim_getman_pafnut_start_dlg_8", []],			
	[anyone|plyr,"oim_getman_pafnut_start_dlg_8", [], "So what is the trouble then?", "oim_getman_pafnut_start_dlg_9", []],				
	[anyone,"oim_getman_pafnut_start_dlg_9", [
		(call_script, "script_cf_troop_get_random_center_of_faction_except_center", "$g_encountered_party_faction", "$g_encountered_party"),
		(assign, ":rand_town", reg0),
		(try_begin), 
			(eq, ":rand_town", 0), 
			(assign, ":rand_town", "p_town_8"),
		(end_try), 	
		(str_store_party_name, s3, ":rand_town"),
		(quest_set_slot, "qst_oim_getman_voron_translate",slot_quest_target_center, ":rand_town"),
	], "The trouble is that all my possessions are left in {s3}. I was sorting the archives, but I was forced to flee and abandon everything. Such is war... If you agree to escort me on my return, as gratitude for your service I shall translate this book for you.", "oim_getman_pafnut_start_dlg_10", []],			
	[anyone|plyr,"oim_getman_pafnut_start_dlg_10", [], "Very well, I agree. Let us move out.", "close_window", [
		#code 
		(quest_get_slot, ":rand_town", "qst_oim_getman_voron_translate",slot_quest_target_center),
		(quest_set_slot, "qst_oim_getman_voron_translate", slot_quest_current_state, 2),
		(str_store_party_name, s3, ":rand_town"),
		(str_store_string, s5, "@OiM_getman Nuzhno perevesti Pafnutiya v {s3}"),	
		(add_quest_note_from_sreg, "qst_oim_getman_voron_translate", 4, s5, 1),
		(party_add_members, "p_main_party", "trp_oim_getman_pafnutiy", 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],				
	
	#oim_getman_pafnut_delivered_dlg
	[anyone|plyr,"oim_getman_pafnut_delivered_dlg", [], "Well, here we are. How much time will you need?", "oim_getman_pafnut_delivered_dlg_1", []],			
	[anyone,"oim_getman_pafnut_delivered_dlg_1", [], "Return in two weeks, my son, and you shall have the translation.", "close_window", [
		(quest_set_slot, "qst_oim_getman_voron_translate", slot_quest_current_state, 3),
		(str_store_string, s5, "@OiM_getman Kniga na perevode u pufnatiya"),	
		(add_quest_note_from_sreg, "qst_oim_getman_voron_translate", 4, s5, 1),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_getman_voron_translate", slot_quest_start_time, ":cur_day"),
		(call_script, "script_succeed_quest", "qst_oim_getman_voron_translate"),
		(party_remove_members, "p_main_party", "trp_oim_getman_pafnutiy", 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],				

	#oim_getman_pafnut_translated_book
	[anyone|plyr,"oim_getman_pafnut_translated_book", [], "So how is the work progressing?", "oim_getman_pafnut_translated_book_1", []],				
	[anyone,"oim_getman_pafnut_translated_book_1", [
		(quest_get_slot, ":qst_day", "qst_oim_getman_voron_translate", slot_quest_start_time),
		(store_current_day, ":cur_day"),
		(val_sub, ":cur_day", ":qst_day"),
		(lt, ":cur_day", 14),
	], "I am not finished yet. Come back later.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],			
	[anyone,"oim_getman_pafnut_translated_book_1", [], "I have finished the translation. Here, you can take it.", "close_window", [
		(jump_to_menu, "mnu_getman_book_translated"),
		(finish_mission),
	]],			
	
	
	#oim_getman_kozak_legends_init_dlgs
	[anyone,"oim_getman_kozak_legends_init_dlgs", [
		(neq, "$g_talk_troop_faction", "fac_kingdom_5"),
	], "A Cossack legend? Well, go ask the Cossacks then.", "lord_pretalk", []],			
	
	[anyone,"oim_getman_kozak_legends_init_dlgs", [], "To your health as well, my friend. You shall need to speak with the Cossack known as Mamai. He knows all ancient tales, far better than any bard.", "oim_getman_kozak_legends_init_dlgs_1", []],			
	[anyone|plyr,"oim_getman_kozak_legends_init_dlgs_1", [], "And where might I find him?", "oim_getman_kozak_legends_init_dlgs_2", []],				
	[anyone,"oim_getman_kozak_legends_init_dlgs_2", [], "Word is, he is retired, which probably means you can find him in the town pubs.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_getman_kozak_legend", slot_quest_current_state, 1),
		(str_store_string, s2, "@OIM_add_getman  Kozak legend - find mamay"),
		(add_quest_note_from_sreg, "qst_oim_getman_kozak_legend", 4, s2, 1),
		(troop_set_slot, "trp_npc4", slot_troop_met, -1),
		(assign, "$can_recruit_mamay", 1),
	]],			

	
	#oim_getman_kozak_legend_mamay_dlg
	#$g_talk_troop_met
	
	[anyone,"oim_getman_kozak_legend_mamay_dlg", [(neq, "$g_talk_troop_met", 1),], "Have you heard of a Cossack named Mamai? Well know this -- I am his descendant. I may not be strong enough to crush ten Poles under my boot, but I wield a pike quite well. However, I am beset by one sin... I am dying for vodka, so much do I love it. Help me, friend -- I have a debt to the innkeeper... Be kind, and pay my debt, and I shall obey your every wish.", "oim_getman_kozak_legend_mamay_dlg_1", []],			
	[anyone|plyr,"oim_getman_kozak_legend_mamay_dlg_1", [], "And what would be the amount of your debt?", "oim_getman_kozak_legend_mamay_dlg_2", []],				
	[anyone,"oim_getman_kozak_legend_mamay_dlg_2", [], "Ah, but a small amount... 5000 thaler...", "oim_getman_kozak_legend_mamay_dlg_3", []],			
	[anyone|plyr,"oim_getman_kozak_legend_mamay_dlg_3", [], "Good Lord! For that amount one could buy a hundred barrels of beer...", "oim_getman_kozak_legend_mamay_dlg_4", []],				
	[anyone,"oim_getman_kozak_legend_mamay_dlg_4", [], "Well, nay not a hundred -- but a dozen it may be... But you see, I was not alone there making merry, but made a treat for all the guests of the inn. However, we then had a small fight with some visiting Poles...", "oim_getman_kozak_legend_mamay_dlg_5", []],			
	[anyone|plyr,"oim_getman_kozak_legend_mamay_dlg_5", [], "Were I the innkeeper, I would strangle you with my bare hands.", "oim_getman_kozak_legend_mamay_dlg_6", []],				
	[anyone,"oim_getman_kozak_legend_mamay_dlg_6", [], "So, will you pay my debt?", "oim_getman_kozak_legend_mamay_dlg_7", []],			
	[anyone|plyr,"oim_getman_kozak_legend_mamay_dlg_7", [
		(store_troop_gold, ":gold", "trp_player"),
		(ge, ":gold", 5000),
	], "Ah, very well, so be it -- I shall pay...", "close_window", [
		(troop_remove_gold, "trp_player", 5000),
		(call_script, "script_recruit_troop_as_companion", "$g_talk_troop"),
		(call_script, "script_succeed_quest", "qst_oim_getman_kozak_legend"),
	]],				
	[anyone|plyr,"oim_getman_kozak_legend_mamay_dlg_7", [], "Please understand, I am a little short on coins as well...", "close_window", []],				
	[anyone,"oim_getman_kozak_legend_mamay_dlg", [], "So, can you pay my debt?", "oim_getman_kozak_legend_mamay_dlg_7", []],				
	
	#oim_getman_mamay_kozak_legend_story
	[anyone,"oim_getman_mamay_kozak_legend_story", [], "I have heard what the bards sing at Cossack gatherings -- that the Black Mace shall return and raise Ukraine above all its enemies.", "oim_getman_mamay_kozak_legend_story_1", []],			
	[anyone|plyr,"oim_getman_mamay_kozak_legend_story_1", [], "And how might I hear this song?", "oim_getman_mamay_kozak_legend_story_2", []],				
	[anyone,"oim_getman_mamay_kozak_legend_story_2", [], "This is unlikely. The song has never been sung since Hmelnitski became the Hetman.", "oim_getman_mamay_kozak_legend_story_3", []],			
	[anyone|plyr,"oim_getman_mamay_kozak_legend_story_3", [], "Why is that?", "oim_getman_mamay_kozak_legend_story_4", []],				
	[anyone,"oim_getman_mamay_kozak_legend_story_4", [], "Hmelnitski is of the Polish gentry. He is no Cossack. The last true Hetman from the Sich was Barabash. He is the one who knows all about the Black Mace.", "oim_getman_mamay_kozak_legend_story_5", []],			
	[anyone|plyr,"oim_getman_mamay_kozak_legend_story_5", [], "Where can I find him?", "oim_getman_mamay_kozak_legend_story_6", []],				
	[anyone,"oim_getman_mamay_kozak_legend_story_6", [], "The rumor is that Barabash has died, but in fact he is very much alive, safe and sound, and travels from one town to another gathering allies.", "oim_getman_mamay_kozak_legend_story_7", []],			
	[anyone|plyr,"oim_getman_mamay_kozak_legend_story_7", [], "Allies for what?", "oim_getman_mamay_kozak_legend_story_8", []],				
	[anyone,"oim_getman_mamay_kozak_legend_story_8", [], "For what, you ask? He seeks to recover the ceremonial mace of the Hetman for himself.", "close_window", [
		#qst_oim_getman_barabash
		(quest_set_slot, "qst_oim_getman_barabash", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_barabash", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_barabash"),
		(str_store_string, s2, "@OIM_add_getman  Barabash zhiv i on dolzhen znat taynu getmana"),
		(call_script, "script_start_quest", "qst_oim_getman_barabash", "trp_player"),
		(call_script, "script_end_quest", "qst_oim_getman_kozak_legend"),
		(str_store_string, s2, "str_mamay_founded"),  
		(add_quest_note_from_sreg, "qst_oim_getman_main", 5, s2, 1),
		
		
	]],			
	
	#oim_getman_barabash_first_talk
	[anyone,"oim_getman_barabash_first_talk", [], "A Cossack by blood, I am. I was the regimental officer, then a Colonel, then acting hetman of the Zaporozhian Army. Throughout this, I always I strove to live in peace with the Polish gentry... Yet the field secretary, Bogdan Hmelnitski, stirred up the Zaporozhians of the Sich and began a rebellion. The Cossacks under my command aided the crown in quieting the rebels, but before the Battle of Yellow Waters, Hmelnitski managed to draw all the Starshiny to his side.", "oim_getman_barabash_first_talk_1", []],			
	[anyone|plyr,"oim_getman_barabash_first_talk_1", [], "Everyone says that you were slain by the traitors.", "oim_getman_barabash_first_talk_2", []],				
	[anyone,"oim_getman_barabash_first_talk_2", [], "The night before the battle, they entered the Hetman's tent. Luckily, I was warned beforehand, and survived. They thought I was one of the bodies they cut to ribbons, but it was only my servant. What do I have to say of this? Simply this -- Hmelnitski has no care for the future of his people. He is moved by personal ambition -- and revenge. Have no doubt, he spells the doom for Ukraine.", "oim_getman_barabash_story", [
		(assign, "$g_talk_troop_met", 1),
		(troop_slot_eq, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
	]],			

	#oim_getman_barabash_story
	[anyone,"oim_getman_barabash_story", [], "The Black Mace is an ancient relic. Seven hundred years ago, Prince Svyatoslav Igorevich ordered it forged from a piece of celestial iron he seized from the soothsayers.", "oim_getman_barabash_story_1", []],			
	[anyone|plyr,"oim_getman_barabash_story_1", [], "The story of the mace I know well. I journeyed to Kiev and Nesvizh, spoke with Radziwill and Prince Boryatinsky, and read the Book of the Crow.", "oim_getman_barabash_story_2", []],				
	[anyone,"oim_getman_barabash_story_2", [], "So you know everything?", "oim_getman_barabash_story_3", []],			
	[anyone|plyr,"oim_getman_barabash_story_3", [], "Everything but this: What is the true power of the Black Mace?", "oim_getman_barabash_story_4", []],				
	[anyone,"oim_getman_barabash_story_4", [], "Ah, so that is what you seek... As legend has it, the mace is a mighty weapon of its own accord, and it gives its bearer the strength to unite all Cossacks under his rule.", "oim_getman_barabash_story_5", []],			
	[anyone|plyr,"oim_getman_barabash_story_5", [], "Would the Cossacks really follow anyone who wields it?", "oim_getman_barabash_story_6", []],				
	[anyone,"oim_getman_barabash_story_6", [], "Of course not... But were the Black Mace to land in the hands of one who could boldly lead the Cossacks to battle, the morale of his forces would be unbreakable.", "oim_getman_barabash_story_7", []],			
	[anyone|plyr,"oim_getman_barabash_story_7", [], "So that is why Radziwill was obsessed with it. Nevertheless, he cannot use the mace until he stands as chief of the Zaporozhian Army. He concealed the Black Mace in Nesvizh so that it could never fall into the hands of another. Perhaps it is time I visit his family crypt...", "close_window", [
		#oim code "find pernach
		#qst_oim_getman_nesvizh_pernach
		(quest_set_slot, "qst_oim_getman_nesvizh_pernach", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_nesvizh_pernach"),
		(str_store_party_name_link, s3, "p_village_53"),
		(str_store_string, s2, "str_nesvizh_pernach_descr"),
		(call_script, "script_start_quest", "qst_oim_getman_nesvizh_pernach", "trp_player"),
	]],				
	
	#oim_getman_mamay_nesviz_dlg_encounter
	[anyone,"oim_getman_mamay_nesviz_dlg_encounter", [], "There are many rumors about this place. The Radziwill line was never shy of magic, and once The Orphan returned from Egypt, why, I shudder at the stories. It is said that he planned to bring two mummies out of Cairo, but the seamen refused to take them aboard. A bad omen, I dare say. Then The Orphan ordered the mummies dissected into pieces and delivered in parts. I know not, however, if they were ever brought to Nesvizh, or if the ship's crew found their death on the sea floor...", "oim_getman_mamay_nesviz_dlg_encounter_1", []],			
	[anyone|plyr,"oim_getman_mamay_nesviz_dlg_encounter_1", [], "And why should we be concerned?", "oim_getman_mamay_nesviz_dlg_encounter_2", []],				
	[anyone,"oim_getman_mamay_nesviz_dlg_encounter_2", [], "Not concerned... I just feel that there might be an ambush awaiting at the vault, so be careful.", "close_window", [
		(quest_set_slot, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(music_set_situation, 0),
	]],				
	
	#
	[anyone|plyr,"oim_getman_nesviz_post_battle_dlg_prisoner", [], "Speak now -- who sent you?", "oim_getman_nesviz_post_battle_dlg_prisoner_1", []],				
	[anyone,"oim_getman_nesviz_post_battle_dlg_prisoner_1", [], "Janusz Radziwill...", "oim_getman_nesviz_post_battle_dlg_prisoner_2", []],			
	[anyone|plyr,"oim_getman_nesviz_post_battle_dlg_prisoner_2", [], "You guard this place at his behest?", "oim_getman_nesviz_post_battle_dlg_prisoner_3", []],				
	[anyone,"oim_getman_nesviz_post_battle_dlg_prisoner_3", [], "Nay, there is nothing to guard but these empty coffins. The lord took what was kept therein. But our orders remain to slay whosoever should come looking here.", "oim_getman_nesviz_post_battle_dlg_prisoner_4", []],			
	[anyone|plyr,"oim_getman_nesviz_post_battle_dlg_prisoner_4", [], "Very well, so we shall have to search for Radziwill.", "close_window", [
		#code to jump to talk to mamay
		(assign, "$oim_auto_talk_troop", "trp_npc4"), 
		(finish_mission),
		(jump_to_menu, "mnu_oim_auto_talk_menu"),
		(music_set_situation, 0),
	]],				

	#oim_getman_nesviz_mamay_dlg
	[anyone|plyr,"oim_getman_nesviz_mamay_dlg", [], "And how would you propose we find Radziwill?", "oim_getman_nesviz_mamay_dlg_1", []],				
	[anyone,"oim_getman_nesviz_mamay_dlg_1", [], "Look upon the decree that Radziwill's soldiers carry through the towns and villages:", "oim_getman_nesviz_mamay_dlg_2", []],			
	[anyone,"oim_getman_nesviz_mamay_dlg_2", [], "The royal decree of great Prince Janusz Radziwill. As we have come to know, the bandit {playername} raided our ancestral estate, ruined the place, slaying our serfs and plundering our family crypt. To all men of the Polish Commonwealth -- should you meet this bandit and heathen, report him at once. Should a member of the gentry come upon him with his troops, attack him at once and take into captivity. He who captures the dog shall receive a lavish reward, be he of noble blood or not.", "oim_getman_nesviz_mamay_dlg_3", []],			
	[anyone,"oim_getman_nesviz_mamay_dlg_3", [], "Surely with a sizable force one might challenge him and take him captive. Or one might lay siege to whichever fortress he's hiding in. But that would be a long victory, and meanwhile our Cossack colonels, hearing of the Black Mace, are swearing allegiance to Radziwill one after another...", "oim_getman_nesviz_mamay_dlg_4", []],			
	[anyone|plyr,"oim_getman_nesviz_mamay_dlg_4", [], "I fear my men will not be enough.", "oim_getman_nesviz_mamay_dlg_5", []],				
	[anyone,"oim_getman_nesviz_mamay_dlg_5", [], "Here is my advice. Pose as a mercenary, sneak in the stronghold where Radziwill resides, and cut his throat...", "oim_getman_nesviz_mamay_dlg_6", []],			
	[anyone|plyr,"oim_getman_nesviz_mamay_dlg_6", [], "Yes... I shall do as you say.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),	
		(finish_mission),
		#qst_oim_getman_kill_radzivill
		(quest_set_slot, "qst_oim_getman_kill_radzivill", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_kill_radzivill"),
		(str_store_string, s2, "@OIM_add_getman  Nu chto zhe mozhno budet poprobovat ubit radzivilla..."),
		(call_script, "script_start_quest", "qst_oim_getman_kill_radzivill", "trp_player"),
		
		(call_script, "script_player_leave_faction", 1),
		(troop_set_slot, "trp_kingdom_1_pretender", slot_troop_player_relation, -50),
		(call_script, "script_set_player_relation_with_faction", "fac_kingdom_1", -50),
		(call_script, "script_update_troop_notes", "trp_kingdom_1_pretender"),
		(str_store_string, s2, "str_kill_radzivall_and_get_pernach"),  
		(add_quest_note_from_sreg, "qst_oim_getman_main", 6, s2, 1),

	]],				
	
	[anyone|plyr,"oim_getman_nesviz_mamay_dlg_6", [], "No, Mamai. We shall defeat Radziwill honestly, on the battlefield.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(call_script, "script_player_leave_faction", 1),
		(call_script, "script_set_player_relation_with_faction", "fac_kingdom_1", -50),
		(troop_set_slot, "trp_kingdom_1_pretender", slot_troop_player_relation, -50),
		(finish_mission),
	]],				
	
	#oim_getman_radzivill_captured
	[anyone,"oim_getman_radzivill_captured", [], "How dare you, serf? Capture the king of the Polish Commonwealth? My subjects shall cut you to ribbons...", "oim_getman_radzivill_captured_1", []],			
	[anyone|plyr,"oim_getman_radzivill_captured_1", [], "If you are the King, Prince Janusz, then I'm the Turkish Sultan. Nay, you are now my prisoner, and nothing more.", "oim_getman_radzivill_captured_2", []],				
	[anyone,"oim_getman_radzivill_captured_2", [], "And what do you plan to do now?", "oim_getman_radzivill_captured_3", []],			
	[anyone|plyr,"oim_getman_radzivill_captured_3", [], "I shall bring you before the Cossacks, and they shall decide your fate.", "close_window", [
		(troop_add_item, "trp_player", "itm_black_hetman", 0),
		(call_script, "script_succeed_quest", "qst_oim_getman_nesvizh_pernach"),
		(quest_set_slot, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 3),
	]],				

	
	#oim_getman_guard_dlg_before_fight
	[anyone,"oim_getman_guard_dlg_before_fight", [], "Oh, another mercenary! You must have long ears! You respond quickly to His Majesty's call for a new regiment. Where do you hail from?", "oim_getman_guard_dlg_before_fight_1", []],			
	[anyone|plyr,"oim_getman_guard_dlg_before_fight_1", [], "I am an orphan. Since I was fourteen, I have been among freelance mercenaries. Many battles I have fought, for many masters...", "oim_getman_guard_dlg_before_fight_2", []],				
	[anyone,"oim_getman_guard_dlg_before_fight_2", [], "Come inside the fortress. King Janusz the First himself shall speak to you. He is looking for personal guards. Go now, if you choose your words carefully, you may rise quickly.", "close_window", [
		(quest_set_slot, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 1),
	]],				
		
	#oim_getman_radzivil_before_death
	[anyone,"oim_getman_radzivil_before_death", [], "So you are a new volunteer?", "oim_getman_radzivil_before_death_1", []],			
	[anyone|plyr,"oim_getman_radzivil_before_death_1", [], "Yes, Sire!", "oim_getman_radzivil_before_death_2", []],				
	[anyone,"oim_getman_radzivil_before_death_2", [], "Hmm, I somehow feel that I have seen you before. Turn towards the light... Oh my, yes indeed I know you! Guards! Seize the traitor!", "close_window", [
		(call_script, "script_cf_set_agent_mode_hostile"), 
		(quest_set_slot, "qst_oim_getman_kill_radzivill", slot_quest_current_state, 2),
	]],			
	
	#trp_npc2
	#oim_getman_radzivil_npc2_dlg
	[anyone,"oim_getman_radzivil_npc2_dlg", [], "Well, I see you managed to escape the fortress...", "oim_getman_radzivil_npc2_dlg_1", []],			
	[anyone|plyr,"oim_getman_radzivil_npc2_dlg_1", [], "Yes, over the shoulders of the late Radziwill's bodyguards and the town guard.", "oim_getman_radzivil_npc2_dlg_2", []],				
	[anyone,"oim_getman_radzivil_npc2_dlg_2", [], "You mean you have slain Radziwill?", "oim_getman_radzivil_npc2_dlg_3", []],			
	[anyone|plyr,"oim_getman_radzivil_npc2_dlg_3", [], "Indeed.", "oim_getman_radzivil_npc2_dlg_4", []],				
	[anyone,"oim_getman_radzivil_npc2_dlg_4", [], "And what of the Black Mace? Have you recovered it?", "oim_getman_radzivil_npc2_dlg_5", []],			
	[anyone|plyr,"oim_getman_radzivil_npc2_dlg_5", [], "Here it is, on my belt. But enough talk. Let us ride swiftly before they send pursuers. Although, they are probably rather too occupied there to think too much of us just now...", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(call_script, "script_end_quest", "qst_oim_getman_kill_radzivill"),
		(troop_add_item, "trp_player", "itm_black_hetman", 0),
		(add_xp_as_reward, 4000),
		(call_script, "script_oim_remove_lord_and_replace", "trp_kingdom_1_pretender", "trp_kingdom_1_lord"),
		(call_script, "script_remove_lord_from_prison", "trp_kingdom_1_lord"),
		(call_script, "script_succeed_quest", "qst_oim_getman_nesvizh_pernach"),		
		(str_store_string, s2, "str_talk_to_barabash_pernach"),  
		(add_quest_note_from_sreg, "qst_oim_getman_barabash", 4, s2, 1),
	]],				

	#oim_getman_radzivil_died	
	[anyone,"oim_getman_radzivil_died", [], "Allow me to speak, {playername}! We were set to guard the captive Prince. But when morning came and we went to wake him, he was, well...", "oim_getman_radzivil_died_1", []],			
	[anyone|plyr,"oim_getman_radzivil_died_1", [], "Well what?", "oim_getman_radzivil_died_2", []],				
	[anyone,"oim_getman_radzivil_died_2", [], "Well, how would a wise man say it... he was cold. Gave up the ghost. All the evening he was whining that his heart ached -- we could hardly sleep with his complaints. But it seems that it was no lie. So what should we do now?", "oim_getman_radzivil_died_3", []],			
	[anyone|plyr,"oim_getman_radzivil_died_3", [], "Bury him with all honors and let us move on.", "close_window", [
		#code to spawn Radzivil's tomb
		(try_begin), 
			(check_quest_active, "qst_oim_getman_kill_radzivill"),
			(call_script, "script_end_quest", "qst_oim_getman_kill_radzivill"),
		(end_try), 
		(set_spawn_radius, 1),
        (spawn_around_party, "p_main_party", "pt_oim_static_object"),
		(assign, ":party", reg0),
        (str_store_troop_name, s1, "trp_kingdom_1_pretender"),
        (party_set_name, ":party", "@{s1}'s tomb"),
		(call_script, "script_oim_remove_lord_and_replace", "trp_kingdom_1_pretender", "trp_kingdom_1_lord"),
		#(call_script, "script_remove_lord_from_prison", "trp_kingdom_1_lord"),
		(music_set_situation, 0),
		(str_store_string, s2, "str_talk_to_barabash_pernach"),  
		(add_quest_note_from_sreg, "qst_oim_getman_barabash", 4, s2, 1),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],				
			
	#oim_getman_barabash_pernach_taken	
	[anyone,"oim_getman_barabash_pernach_taken", [], "This cannot be! The very mace from the Cossack legend. Truth be told I never thought it existed for real... Well, {playername}, stand under my banner, let us gather all Cossack Starshina, and restore the Cossack nation to its former glory!", "oim_getman_barabash_pernach_taken_1", [
		(call_script, "script_end_quest", "qst_oim_getman_barabash"),
	]],			
	[anyone|plyr,"oim_getman_barabash_pernach_taken_1", [], "You think of a rebellion against Hmelnitski?", "oim_getman_barabash_pernach_taken_2", []],				
	[anyone,"oim_getman_barabash_pernach_taken_2", [], "Nay. Hmelnitski is cunning as a fox, and has gathered all the Starshina to his cause. He is also supported by Muscovites. Before we openly stand against the dog, we must first talk with the Colonels and show them the Black Mace -- draw them to our side. Only after we have the majority of their support shall we stand against Hmelnitski...", "oim_getman_barabash_pernach_taken_3", []],			
	[anyone|plyr,"oim_getman_barabash_pernach_taken_3", [], "Forgive me, Barabash, but I do not believe in this plan...", "close_window", [
		(quest_set_slot, "qst_oim_getman_nesvizh_pernach", slot_quest_current_state, 10),
		#(call_script, "script_end_quest", "qst_oim_getman_nesvizh_pernach"),
		(assign, "$oim_auto_talk_troop", "trp_npc4"), 
		(jump_to_menu, "mnu_oim_auto_talk_menu2"),
		(finish_mission),
		(music_set_situation, 0),
		(str_store_string, s2, "str_pernach_taken_fight_for_getman"),  
		(add_quest_note_from_sreg, "qst_oim_getman_main", 7, s2, 1),

	]],				
	[anyone|plyr,"oim_getman_barabash_pernach_taken_3", [], "So be it, Colonel, I go to speak with the Cossacks.", "close_window", [
		(call_script, "script_end_quest", "qst_oim_getman_nesvizh_pernach"),
		#qst_oim_getman_za_barabasha
		(quest_set_slot, "qst_oim_getman_za_barabasha", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_za_barabasha", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_za_barabasha"),
		(str_store_string, s2, "@OIM_add_getman  Chto bi poluchit pernach nuzhno privlech na 50% "),
		(call_script, "script_start_quest", "qst_oim_getman_za_barabasha", "trp_player"),
		(str_store_string, s2, "str_pernach_taken_fight_for_getman"),  
		(add_quest_note_from_sreg, "qst_oim_getman_main", 7, s2, 1),
	]],				
		
 	 
	#oim_getman_mamay_talk_babrabash_refused
	[anyone,"oim_getman_mamay_talk_babrabash_refused", [], "So what have you resolved upon with Barabash?", "oim_getman_mamay_talk_babrabash_refused_1", []],			
	[anyone|plyr,"oim_getman_mamay_talk_babrabash_refused_1", [], "The Colonel proposed that we incite the Starshina to rebel against Hmelnitski.", "oim_getman_mamay_talk_babrabash_refused_2", []],				
	[anyone,"oim_getman_mamay_talk_babrabash_refused_2", [], "And what was your response?", "oim_getman_mamay_talk_babrabash_refused_3", []],			
	[anyone|plyr,"oim_getman_mamay_talk_babrabash_refused_3", [], "I refused.", "oim_getman_mamay_talk_babrabash_refused_4", []],				
	[anyone,"oim_getman_mamay_talk_babrabash_refused_4", [], "So be it, then. Barabash shall become Hetman, and will restore the lands of the Polish gentry. Meanwhile, Hmelnitski will seek to forge a free Cossack nation. Let us go talk to Bogdan. Perhaps we shall fight at his side -- and who knows, you might even become a Marshal in time.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(assign, "$g_leave_encounter", 1),
		(assign, "$g_talk_troop_faction", "fac_kingdom_5"),
		(call_script, "script_end_quest", "qst_oim_getman_nesvizh_pernach"),
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
			(call_script, "script_update_all_notes"),
			(assign, "$g_recalculate_ais", 1),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
	    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "trp_kingdom_5_lord", "$g_talk_troop_faction"),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		#qst_oim_getman_za_hmelya
		#qst_oim_na_rech_pospolitu
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_za_hmelya"),
		(str_store_string, s2, "@OIM_add_getman  teper kogda ya primknul k hmelyu chto bi poluchit istinuyu silu getmana nuzhno stat mashalom"),
		(call_script, "script_start_quest", "qst_oim_getman_za_hmelya", "trp_player"),		
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_start_time, ":cur_day"),
	]],			
		
		
	[anyone,"oim_getman_za_barabasha_lords_dlg", [], "Yes? What is it you wish to tell me?", "oim_getman_za_barabasha_lords_dlg_1", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_1", [], "First, you should know that Colonel Barabash, the former Hetman, is still alive.", "oim_getman_za_barabasha_lords_dlg_2", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_2", [], "Ah, this is starting to make sense! And now I know who was behind the attempt on his life...", "oim_getman_za_barabasha_lords_dlg_3", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_3", [], "Indeed. It was Hmelnitski that ordered him dead.", "oim_getman_za_barabasha_lords_dlg_4", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_4", [], "You say Hmelnitski was behind all of this? Perhaps it is true, or perhaps not. People shall say what they wish.", "oim_getman_za_barabasha_lords_dlg_5", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_5", [], "My opinion of Hmelnitski is that he is leading Ukraine off a cliff. Instead of supporting the Polish Commonwealth, beside which Ukraine can once more take a worthy place, he poses as the long-lost brother of the Tatars, and then of the Muscovites...", "oim_getman_za_barabasha_lords_dlg_6", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_6", [], "And what do you propose?", "oim_getman_za_barabasha_lords_dlg_7", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_7", [], "I propose we take the Hetman's trappings from Hmelnitski and give them to Barabash.", "oim_getman_za_barabasha_lords_dlg_8", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_8", [], "And you feel that Barabash is worthy of the title?", "oim_getman_za_barabasha_lords_dlg_9", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_9", [], "Aye, for he is the true Hetman -- and we do have this mace...", "oim_getman_za_barabasha_lords_dlg_10", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_10", [], "That is the Black Mace!", "oim_getman_za_barabasha_lords_dlg_11", []],			
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_11", [], "Indeed it is.", "oim_getman_za_barabasha_lords_dlg_12", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_12", [
		(store_random_in_range, ":radom", 0, 100),
		(ge, ":radom", 35), 
	], "Well then, I am ready to follow he who holds the mace. Barabash must be Hetman. I am ready to stand beside him, if the uprising gains the support from the Starshiny.", "oim_getman_za_barabasha_lords_dlg_pos", []],			
		[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_pos", [], "Many have already joined us. I shall let you know when Barabash is ready to commence the uprising.", "oim_getman_za_barabasha_lords_dlg_generik", [
			(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1), 	 
			(str_clear, s4), 
			(str_clear, s5), 
			(assign, ":count", 0),
			(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
				(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
				(str_store_troop_name_link, s2, ":troop_no"), 
				(try_begin), 
					(eq, ":count", 0), 
					(str_store_string, s4, "@{s2}"),
				(else_try), 	
				(str_store_string, s4, "@{s4}, {s2}"),
			(end_try), 
				(val_add, ":count", 1),
			(end_try), 
			(assign, ":count", 0),
			(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
				(troop_slot_eq, ":troop_no", slot_troop_support_hero, -1), 
				(str_store_troop_name_link, s2, ":troop_no"), 
				(try_begin), 
					(eq, ":count", 0), 
					(str_store_string, s5, "@{s2}"),
				(else_try), 	
				(str_store_string, s5, "@{s5}, {s2}"),
			(end_try), 
				(val_add, ":count", 1),
			(end_try), 
			(str_store_string, s6, "str_oim_potop_support_list"),	
			(add_quest_note_from_sreg, "qst_oim_getman_za_barabasha", 4, s6, 1),
		]],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_12", [], "You speak well, but that by itself is not enough... I do not yet know if I should move against Hmelnitski. First I must speak with the Cossacks.", "oim_getman_za_barabasha_lords_dlg_neg", [
			(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, -1), 	
			(str_clear, s4), 
			(str_clear, s5), 
			(assign, ":count", 0),
			(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
				(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
				(str_store_troop_name_link, s2, ":troop_no"), 
				(try_begin), 
					(eq, ":count", 0), 
					(str_store_string, s4, "@{s2}"),
				(else_try), 	
				(str_store_string, s4, "@{s4}, {s2}"),
			(end_try), 
				(val_add, ":count", 1),
			(end_try), 
			(assign, ":count", 0),
			(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
				(troop_slot_eq, ":troop_no", slot_troop_support_hero, -1), 
				(str_store_troop_name_link, s2, ":troop_no"), 
				(try_begin), 
					(eq, ":count", 0), 
					(str_store_string, s5, "@{s2}"),
				(else_try), 	
				(str_store_string, s5, "@{s5}, {s2}"),
			(end_try), 
				(val_add, ":count", 1),
			(end_try), 
			(str_store_string, s6, "str_oim_potop_support_list"),	
			(add_quest_note_from_sreg, "qst_oim_getman_za_barabasha", 4, s6, 1),		
		]],				
	[anyone|plyr,"oim_getman_za_barabasha_lords_dlg_neg", [], "Well, the decision is yours, but I think you shall soon find my words to be true...", "oim_getman_za_barabasha_lords_dlg_generik", []],				
	[anyone,"oim_getman_za_barabasha_lords_dlg_generik", [
		(quest_slot_eq, "qst_oim_getman_za_barabasha", slot_quest_current_state, 0), 
	], "Nevertheless, were I in your place, I would speak to Hmelnitski. Perhaps the situation is not quite as simple as the old Hetman told you...", "lord_pretalk", [
		(quest_set_slot, "qst_oim_getman_za_barabasha", slot_quest_current_state, 1), 
	]],			
	[anyone|auto_proceed,"oim_getman_za_barabasha_lords_dlg_generik", [], "Nevertheless, were I in your place, I would speak to Hmelnitski. Perhaps the situation is not quite as simple as the old Hetman told you...", "lord_pretalk", []],				
	 
		
	#oim_getman_hmel_barabash_story
	[anyone,"oim_getman_hmel_barabash_story", [], "Ivan Barabash has long been lapdog to the damned Poles. When he became the acting Hetman, he levied unbearable taxes on the Cossack people, raising money to curry favor with the Polish king -- then helped to spread the Catholic faith. This traitor shall make all of Ukraine serfs to the Poles.", "oim_getman_hmel_barabash_story_1", []],			
	[anyone|plyr,"oim_getman_hmel_barabash_story_1", [], "And what you propose, Hetman?", "oim_getman_hmel_barabash_story_2", []],				
	[anyone,"oim_getman_hmel_barabash_story_2", [], "I propose not -- I do. The Pereyaslav council decrees that all Cossacks must swear an oath to the Tsar of Moscow. Only under the protection of an Orthodox nation may our people gain their freedom.", "oim_getman_hmel_barabash_story_3", []],			
	[anyone|plyr,"oim_getman_hmel_barabash_story_3", [], "So then, you only want what is best for Ukraine?", "oim_getman_hmel_barabash_story_4", []],				
	[anyone,"oim_getman_hmel_barabash_story_4", [], "Precisely so. And believe me, its future lies not with Catholic Poland. Only a Hetman who has lost his mind would fight for Poland against Russia...", "oim_getman_hmel_barabash_story_5", []],			
	[anyone|plyr,"oim_getman_hmel_barabash_story_5", [], "I see your political course has been carefully considered. I may come over to your side.", "oim_getman_hmel_barabash_story_6", []],				
	[anyone,"oim_getman_hmel_barabash_story_6", [], "Everything is in your hands. I have a faithful man placed very close to Barabash. Just a few days ago, word came from him that the former Hetman sent a messenger disguised as merchant to the new King of the Polish Commonwealth, carrying a secret package. If you should require evidence of his treason, capture that package and investigate its contents.", "oim_getman_hmel_barabash_story_7", []],			
	[anyone|plyr,"oim_getman_hmel_barabash_story_7", [], "Agree...", "oim_getman_hmel_barabash_story_pos", []],				
		[anyone|plyr,"oim_getman_hmel_barabash_story_pos", [], "So be it, Hetman. I shall go forth to find that cart. If you indeed speak the truth, and Barabash is engaged in underhanded affairs with the Poles, then I shall become your trusted ally. But if we find nothing, understand that there is little I can do. But tell me one thing -- what route are these false merchants taking?", "oim_getman_hmel_barabash_story_pos_1", []],				
		[anyone,"oim_getman_hmel_barabash_story_pos_1", [
			#code init "qst_oim_getman_caravan"
			(quest_set_slot, "qst_oim_getman_za_barabasha", slot_quest_current_state, 2), 
			(call_script, "script_cf_select_random_town_with_faction", "fac_kingdom_5"),
			(assign, ":start_town", reg0), 
			(call_script, "script_cf_select_random_town_with_faction", "fac_kingdom_1"),
			(assign, ":end_town", reg0), 
			(quest_set_slot, "qst_oim_getman_caravan", slot_quest_target_center, ":end_town"),
			(set_spawn_radius,0),
			(spawn_around_party,":start_town", "pt_oim_merchant_caravan"),
			(assign, "$oim_barabash_caravan", reg0),
			(party_set_faction, "$oim_barabash_caravan", "fac_kingdom_1"),
			(party_set_slot, "$oim_barabash_caravan", slot_party_type, spt_kingdom_caravan),
			(party_set_slot, "$oim_barabash_caravan", slot_party_ai_state, spai_undefined),
			(party_set_ai_behavior, "$oim_barabash_caravan", ai_bhvr_travel_to_party),
			(party_set_ai_object, "$oim_barabash_caravan", ":end_town"),
			(party_set_flags, "$oim_barabash_caravan", pf_default_behavior, 0),
			(troop_set_slot, "trp_caravan_master", slot_troop_leaded_party, "$oim_barabash_caravan"),
			(party_add_leader, "$oim_barabash_caravan", "trp_caravan_master"),
			(store_sub, ":item_to_price_slot", slot_town_trade_good_prices_begin, trade_goods_begin),
			(try_for_range, ":cur_goods", trade_goods_begin, trade_goods_end),
				(store_add, ":cur_goods_price_slot", ":cur_goods", ":item_to_price_slot"),
				(party_set_slot, "$oim_barabash_caravan", ":cur_goods_price_slot", average_price_factor),
			(try_end),
			#
			(call_script, "script_oim_spawn_strong_army", "$oim_barabash_caravan", "fac_kingdom_1"),
			(troop_set_slot, "trp_caravan_master", slot_troop_wealth, 4000),
			(quest_set_slot, "qst_oim_getman_caravan", slot_quest_giver_troop, "$g_talk_troop"), 
			(quest_set_slot, "qst_oim_getman_caravan", slot_quest_current_state, 0),
			(str_store_party_name_link, s3, ":start_town"), 
			(str_store_party_name_link, s4, ":end_town"),
			(str_store_troop_name_link, s5, "$g_talk_troop"),
			(setup_quest_text, "qst_oim_getman_caravan"),
			(str_store_string, s2, "@OIM_add_getman  {s5} skazal chto nuzniy karavan vishel iz {s3} i idet v {s4}. Mozhet i hmel prav... "),
			(call_script, "script_start_quest", "qst_oim_getman_caravan", "$g_talk_troop"),
		], "According to my spy, by now the carts will have moved out from {s3} and are heading to {s4}. God's speed.", "lord_pretalk", []],			
	[anyone|plyr,"oim_getman_hmel_barabash_story_7", [], "Refuse...", "oim_getman_hmel_barabash_story_neg", []],				
		[anyone|plyr,"oim_getman_hmel_barabash_story_neg", [], "Take your forked tongue back in your mouth, Hetman. I expect you devised all this to set me against the old Colonel.", "oim_getman_hmel_barabash_story_neg_1", []],				
		[anyone,"oim_getman_hmel_barabash_story_neg_1", [], "Believe whatever you please, {playername}. But be aware -- the lives of my foes are often cut short, and their deaths are painful. Soon we shall meet again.", "lord_pretalk", [
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", -60),
			(quest_set_slot, "qst_oim_getman_za_barabasha", slot_quest_current_state, 2), 
		]],			

	
	#oim_getman_caravan_master_talk
	[anyone,"oim_getman_caravan_master_talk", [], "Spare me, oh noble warrior. Take what you wish -- take everything! But leave me my life.", "oim_getman_caravan_master_talk_1", []],			
	[anyone|plyr,"oim_getman_caravan_master_talk_1", [], "Have no doubt that I shall take everything. But first I will speak with you of other things. Where is the package you carry to the Poles from Barabash?", "oim_getman_caravan_master_talk_2", []],				
	[anyone,"oim_getman_caravan_master_talk_2", [], "What package?", "oim_getman_caravan_master_talk_3", []],			
	[anyone|plyr,"oim_getman_caravan_master_talk_3", [], "I see you have lost your memory... We shall try to refresh it. Hey there lads -- whose hands are itching? We'll need one hundred lashes for this one...", "oim_getman_caravan_master_talk_4", []],				
	[anyone,"oim_getman_caravan_master_talk_4", [], "Oh, please no, {sir/madam}! Here is the letter, inside this robe. Take it, for God's sake, but injure me not.", "oim_getman_caravan_master_talk_5", []],			
	[anyone|plyr,"oim_getman_caravan_master_talk_5", [], "All right, the devil take you. Give me the letter and go to your cart.", "oim_getman_caravan_master_talk_6", []],				
	[anyone,"oim_getman_caravan_master_talk_6", [], "Thank you, noble {sir/madam}. Even my children shall remember your kindness this day...", "oim_getman_caravan_master_talk_7", []],			
	[anyone|plyr,"oim_getman_caravan_master_talk_7", [], "So, let us see this letter: ""...and to you, great King, may your years be long, I solemnly swear -- if your forces shall aid me in crushing Hmelnitski, may he be damned, and aid me in becoming Hetman of the crown, all of Ukraine on the right bank, with all its villages, hamlets, towns and strongholds, I shall give over to the gentry of Great Poland forthwith, as a lavish reward for Your Majesty's aid..."" ", "oim_getman_caravan_master_talk_8", []],				
	[anyone|plyr,"oim_getman_caravan_master_talk_8", [], "So this is who you truly are, Barabash. And you speak of yourself as the defender of Cossack liberties. You just wait -- I'll come for you!", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(call_script, "script_fail_quest", "qst_oim_getman_za_barabasha"),
		(call_script, "script_end_quest", "qst_oim_getman_za_barabasha"), 
		(call_script, "script_succeed_quest", "qst_oim_getman_caravan"),
	]],						
	
	#oim_getman_hmel_letter_captured
	[anyone|plyr,"oim_getman_hmel_letter_captured", [], "You were right, Hetman.", "oim_getman_hmel_letter_captured_1", []],				
	[anyone,"oim_getman_hmel_letter_captured_1", [], "Verily he shall make no little trouble if he is not stopped in time. So, are you ready to swear an oath to me?", "oim_getman_hmel_letter_captured_2", []],			
	[anyone|plyr,"oim_getman_hmel_letter_captured_2", [], "Yes, Hetman, I am.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_getman_caravan"),
		(assign, "$g_talk_troop_faction", "fac_kingdom_5"), 
		(call_script, "script_get_poorest_village_of_faction", "$g_talk_troop_faction"),
		(assign, "$g_invite_offered_center", reg0),
		(try_begin),
			(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
			(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
			(val_min, ":relation", -40),
			(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
			(call_script, "script_update_all_notes"),
			(assign, "$g_recalculate_ais", 1),
		(try_end),
		(try_begin),
			(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
			(neq, "$players_kingdom", "fac_player_supporters_faction"),
			(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
			(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
			(call_script, "script_player_leave_faction", 1),
		(try_end),
		(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
		(try_begin),
			(gt, "$g_invite_offered_center", 0),
			(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
			(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$g_talk_troop", "$g_talk_troop_faction"),
		(try_end),
	    (call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$g_talk_troop", "$g_talk_troop_faction"),
		(assign, "$player_has_homage" ,1),
		(assign, "$g_player_banner_granted", 1),
		(assign, "$g_invite_faction", 0),
		(assign, "$g_invite_faction_lord", 0),
		(assign, "$g_invite_offered_center", 0),
		#qst_oim_getman_za_hmelya
		#qst_oim_na_rech_pospolitu
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_za_hmelya"),
		(str_store_string, s2, "@OIM_add_getman  teper kogda ya primknul k hmelyu chto bi poluchit istinuyu silu getmana nuzhno stat mashalom"),
		(call_script, "script_start_quest", "qst_oim_getman_za_hmelya", "trp_player"),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_getman_za_hmelya", slot_quest_start_time, ":cur_day"),
	]],				
	
	#oim_getman_hmel_casus_beli_dlg
	[anyone,"oim_getman_hmel_casus_beli_dlg", [], "Yes indeed. It is time we join all our peoples together, and found a new nation.", "oim_getman_hmel_casus_beli_dlg_1", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_1", [], "And what should it be called? The Polish Commonwealth or the Tsardom of Moscow?", "oim_getman_hmel_casus_beli_dlg_2", []],				
	[anyone,"oim_getman_hmel_casus_beli_dlg_2", [], "Neither. We shall restore the old Grand Principality of Rus.", "oim_getman_hmel_casus_beli_dlg_3", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_3", [], "Which would be ruled by a Grand Prince, not by a Hetman. But would his heirs call themselves Tsars or Kings? Or better yet, emperors.", "oim_getman_hmel_casus_beli_dlg_4", []],				
	[anyone,"oim_getman_hmel_casus_beli_dlg_4", [], "You understand quickly. But first you must conquer the Muscovite Tsardom.", "oim_getman_hmel_casus_beli_dlg_5", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_5", [], "Why delay then? You are Hetman, and I am Marshal. Give the word and we shall march.", "oim_getman_hmel_casus_beli_dlg_6", []],				
	[anyone,"oim_getman_hmel_casus_beli_dlg_6", [], "We have entered into alliance with them. Besides, our Colonels do not want this war. But if you stir their hostilities against us, our subjects shall rise up at once.", "oim_getman_hmel_casus_beli_dlg_7", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_7", [], "And what would you propose?", "oim_getman_hmel_casus_beli_dlg_8", []],				
	[anyone,"oim_getman_hmel_casus_beli_dlg_8", [], "You must leave service. Thereafter you shall capture a city of the Muscovite Tsardom. The Muscovites will assume that it was our work, and declare war upon us. Meanwhile I shall hold my colonels at bay, explaining to them that you acted at my personal behest.", "oim_getman_hmel_casus_beli_dlg_9", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_9", [], "A cunning plan. But after this, all Zaporozhian Colonels shall become my deadly enemies.", "oim_getman_hmel_casus_beli_dlg_10", []],				
	[anyone,"oim_getman_hmel_casus_beli_dlg_10", [], "Your good name will be restored in time. Once the war begins, I shall accept you back into service. For many, that alone would be a firm reason to change their attitude towards you. After this, simply fight well, win your battles, and soon enough, all shall be forgotten.", "oim_getman_hmel_casus_beli_dlg_11", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_11", [], "Agree...", "oim_getman_hmel_casus_beli_dlg_12", []],				
		[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_12", [], "I shall do it for a holy cause, the restoration of the Ancient Rus.", "oim_getman_hmel_casus_beli_dlg_13", []],				
		[anyone,"oim_getman_hmel_casus_beli_dlg_13", [], "So be it, then. In several days I shall announce the election of the new Marshal.", "lord_pretalk", [
			#code
			(quest_set_slot, "qst_oim_getman_hmel_casus_beli", slot_quest_current_state, 1),
			(str_store_string, s5, "str_oim_casus_beli_hmel_qst"),	
			(add_quest_note_from_sreg, "qst_oim_getman_hmel_casus_beli", 4, s5, 1),
			(call_script, "script_player_leave_faction", 1), 
			(call_script, "script_set_player_relation_with_faction", "fac_kingdom_2", 0),
		]],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_11", [], "I cannot commit an act of betrayal, even if it is only a pretense.", "oim_getman_hmel_casus_beli_dlg_14", []],				
		[anyone|plyr,"oim_getman_hmel_casus_beli_dlg_14", [], "I would rather begin the war by ordinary means. Any rebels shall be dealt with.", "lord_pretalk", [
			#(call_script, "script_fail_quest", "qst_oim_getman_hmel_casus_beli"), 
			#qst_oim_getman_hmel_greate_war
			(quest_set_slot, "qst_oim_getman_hmel_casus_beli", slot_quest_current_state, 2),
			(quest_set_slot, "qst_oim_getman_hmel_greate_war", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_hmel_greate_war", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_hmel_greate_war"),
			(str_store_string, s2, "@OIM_add_getman Bilo resheno deystvovat na prolom. Vi otpravili gonca s tekstom o nachale voini v MTzrd"),
			(call_script, "script_start_quest", "qst_oim_getman_hmel_greate_war", "trp_player"),
			(set_spawn_radius, 0),
            (spawn_around_party, "p_main_party", "pt_sacrificed_messenger"),
            (assign, ":new_party", reg0),
			(call_script, "script_get_random_troop_from_party", "p_main_party"), 
			(assign, ":troop", reg0), 
            (party_add_members, ":new_party", ":troop", 1),
			(remove_member_from_party, ":troop", "p_main_party"),
            (party_set_ai_behavior, ":new_party", ai_bhvr_travel_to_party),
			(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_2", "p_town_8"),
			(assign, ":quest_target_center", reg0), 
            (party_set_ai_object, ":new_party", ":quest_target_center"),
			(quest_set_slot, "qst_oim_getman_hmel_greate_war", slot_quest_target_center, ":quest_target_center"),
            (party_set_flags, ":new_party", pf_default_behavior, 0),
			(quest_set_slot, "qst_oim_getman_hmel_greate_war", slot_quest_target_party, ":new_party"),
			(str_store_string, s5, "str_oim_casus_beli_hmel_qst"),	
			(add_quest_note_from_sreg, "qst_oim_getman_hmel_casus_beli", 4, s5, 1),
		]],				
	
	
	#qst_oim_getman_hmel_casus_beli
	#oim_getman_hmel_casus_beli_end_dlg
	[anyone,"oim_getman_hmel_casus_beli_end_dlg", [], "Thus all our lands are united under one mighty hand. It does not do for such a vast nation, the successor of the Ancient Rus, to be named the Cossack Hetmanate. Glory throughout all ages shall be to the Grand Principality of Rus!", "oim_getman_hmel_casus_beli_end_dlg_1", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_end_dlg_1", [], "Then you are now the Grand Prince?", "oim_getman_hmel_casus_beli_end_dlg_2", []],				
	[anyone,"oim_getman_hmel_casus_beli_end_dlg_2", [], "'Tis no simple matter. Defeat is ever an orphan, but victory has many willing fathers. Many of our warlords have suddenly recalled their Rurik heritage, and now claim the throne.", "oim_getman_hmel_casus_beli_end_dlg_3", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_end_dlg_3", [], "And what do you propose?", "oim_getman_hmel_casus_beli_end_dlg_4", []],				
	[anyone,"oim_getman_hmel_casus_beli_end_dlg_4", [], "If we allow elections, the Grand Principality will only become once more a place of feuding warlords, and its sovereign would be but the first among equals. Only a coronation can make me a true King. And for this, the crown of Prince Vytautas would work well enough.", "oim_getman_hmel_casus_beli_end_dlg_5", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_end_dlg_5", [], "What is this crown you speak of?", "oim_getman_hmel_casus_beli_end_dlg_6", []],				
	[anyone,"oim_getman_hmel_casus_beli_end_dlg_6", [], "Vytautas the Great is the Grand Prince of Lithuania, and cousin to the Polish King Jogaila. Hand in hand with Jogaila, he fought at Grunwald with the Teuton Order, and gained so much influence that Holy Roman Emperor Sigismund himself offered him the crown of King. This crown was forged in the year 1340 and sent to Vilna, but it vanished along the route, and Vytautas himself died in Trakai, awaiting an anointing that never came.", "oim_getman_hmel_casus_beli_end_dlg_7", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_end_dlg_7", [], "You are right. A crown that had vanished for hundreds of years would make a great symbol. Yet where would one begin to look for it?", "oim_getman_hmel_casus_beli_end_dlg_8", []],				
	[anyone,"oim_getman_hmel_casus_beli_end_dlg_8", [], "You found the legendary Black Mace, did you not? I'm sure you can find the crown as well. Aid me in strengthening my grip on the throne, and I shall reward you as only a King can.", "oim_getman_hmel_casus_beli_end_dlg_9", []],			
	[anyone|plyr,"oim_getman_hmel_casus_beli_end_dlg_9", [], "It is a bargain then, Grand Prince to be.", "lord_pretalk", [
		(faction_set_name, "fac_kingdom_5", "@Velikoye Knyazestvo Rus"),
		#qst_oim_getman_korona_vitovta
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_korona_vitovta"),
		(str_store_string, s2, "@OIM_add_getman Korona vitovta - to chto reshit problemi"),
		(call_script, "script_start_quest", "qst_oim_getman_korona_vitovta", "$g_talk_troop"),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_start_time, ":cur_day"),
		(try_begin), 
			(eq, "$g_talk_troop", "trp_kingdom_5_lord"), 
			(call_script, "script_end_quest", "qst_oim_getman_hmel_casus_beli"), 
		(else_try), 
			(call_script, "script_end_quest", "qst_oim_getman_barabash_casus_beli"), 
		(end_try), 
		
		#qst_oim_getman_hmel_greate_war
		#qst_oim_getman_barabash_greate_war
		(try_begin), 
			(check_quest_active, "qst_oim_getman_hmel_greate_war"),
			(call_script, "script_end_quest", "qst_oim_getman_hmel_greate_war"),
		(end_try), 

		(try_begin), 
			(check_quest_active, "qst_oim_getman_barabash_greate_war"),
			(call_script, "script_end_quest", "qst_oim_getman_barabash_greate_war"),
		(end_try), 

		
	]],				

	#oim_getman_mamay_korona_start_dlg	
	[anyone,"oim_getman_mamay_korona_start_dlg", [], "What troubles you, {playername}? No love from girls -- or is it a painful ailment? Drink some of this vodka, and your sorrows will be gone...", "oim_getman_mamay_korona_start_dlg_1", []],			
	[anyone|plyr,"oim_getman_mamay_korona_start_dlg_1", [], "Oh, Mamai, vodka cannot save me. The Grand Prince has assigned me a most difficult task -- to find the crown of Vytautas, which has been lost for three ages...", "oim_getman_mamay_korona_start_dlg_2", []],				
	[anyone,"oim_getman_mamay_korona_start_dlg_2", [], "Ten thousand devils take him! How in hell should we find it? Nay, in a case like this, one can hardly do without vodka! Fill the mugs!", "oim_getman_mamay_korona_start_dlg_3", []],			
	[anyone,"oim_getman_mamay_korona_start_dlg_3", [], "To your health!", "oim_getman_mamay_korona_start_dlg_4", []],			
	[anyone,"oim_getman_mamay_korona_start_dlg_4", [], "I remember now... There was a certain bard in the Sich. It was he who told the legend of three Polish knights who stood against an Orthodox prince, who was to receive the crown from the schismatics. Thus they took the crown by force, as it was being carried from Hungary to Vilna. Yet after Vytautas died, all of Lithuania was turned upside-down, and the ones who took the crown were stricken as if a curse had been placed upon them. One died in torment, and another hanged himself, but the third recanted of his deeds, accepted the schema and became a monk. And it seems he took the crown with him.", "oim_getman_mamay_korona_start_dlg_5", []],			
	[anyone|plyr,"oim_getman_mamay_korona_start_dlg_5", [], "And to which monastery did this reformed knight go? Did the bard speak of this?", "oim_getman_mamay_korona_start_dlg_6", []],				
	[anyone,"oim_getman_mamay_korona_start_dlg_6", [], "Nay, he did not. Yet when I was last in the area of Hortitsa, I saw that same bard. Let me go visit him quietly, and find out any other details.", "oim_getman_mamay_korona_start_dlg_7", []],			
	[anyone|plyr,"oim_getman_mamay_korona_start_dlg_7", [], "Certainly. Set out at once!", "oim_getman_mamay_korona_start_dlg_8", []],				
	[anyone,"oim_getman_mamay_korona_start_dlg_8", [], "First, let me have 1500 thaler for my expenses. Who knows what I might encounter along the way.", "oim_getman_mamay_korona_start_dlg_9", []],			
	[anyone|plyr,"oim_getman_mamay_korona_start_dlg_9", [], "Here, take it. -- But there are to be no drunken brawls in the taverns!", "oim_getman_mamay_korona_start_dlg_10", []],				
	[anyone,"oim_getman_mamay_korona_start_dlg_10", [], "Worry not. I shall be swift as the wind.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 1),
		(str_store_string, s5, "str_oim_korona_vitovta_mamay"),	
		(add_quest_note_from_sreg, "qst_oim_getman_korona_vitovta", 4, s5, 1),
		(remove_member_from_party, "trp_npc4", "p_main_party"),
		(spawn_around_party, "p_main_party", "pt_sacrificed_messenger"),
		(assign, ":new_party", reg0),
		(assign, ":troop", "trp_npc4"), 
		(party_add_members, ":new_party", ":troop", 1),
		#(remove_member_from_party, ":troop", "p_main_party"),
		(party_set_ai_behavior, ":new_party", ai_bhvr_travel_to_party),
		(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_5", "p_town_5"),
		(assign, ":quest_target_center", reg0), 
		(party_set_ai_object, ":new_party", ":quest_target_center"),
		(party_set_flags, ":new_party", pf_default_behavior, 0),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_target_party, ":new_party"),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_target_center, ":quest_target_center"),
		(party_set_name, ":new_party", "@Mamay"),
		(troop_remove_gold, "trp_player", 1500),
	]],			


	#oim_getman_mamay_korona_finded_dlg
	[anyone,"oim_getman_mamay_korona_finded_dlg", [], "Here I am! Allow me to report, commander. I caused no brawls along the way, and though I may have taken a sip or two of vodka, it was only for the greater good. The way was long and hard, and just the other day I spent the last thaler...", "oim_getman_mamay_korona_finded_dlg_1", []],			
	[anyone|plyr,"oim_getman_mamay_korona_finded_dlg_1", [], "Be quick, delay not the answer! Did you find out anything?", "oim_getman_mamay_korona_finded_dlg_2", []],				
	[anyone,"oim_getman_mamay_korona_finded_dlg_2", [], "That bard I spoke of died last summer.", "oim_getman_mamay_korona_finded_dlg_3", []],			
	[anyone|plyr,"oim_getman_mamay_korona_finded_dlg_3", [], "Then all is lost...", "oim_getman_mamay_korona_finded_dlg_4", []],				
	[anyone,"oim_getman_mamay_korona_finded_dlg_4", [], "No, no, not all. The bard had a grandson, who knew all his songs and tales. He told me, after a small bribe, that the third knight took his monastic vows in the Trakai monastery. And he mentioned his name, too...", "oim_getman_mamay_korona_finded_dlg_5", []],			
	[anyone|plyr,"oim_getman_mamay_korona_finded_dlg_5", [], "So that grandchild took all the money out of your purse? Verily, that bard's lad shall go far... Very well, then let us waste no time and ride forth to Trakai!", "oim_getman_mamay_korona_finded_dlg_6", []],				
	[anyone,"oim_getman_mamay_korona_finded_dlg_6", [], "The lad's tale cost me but half a thaler, with which I bought him a bowl of soup with dumplings. But there is no reason to ride to Trakai -- I was there already. From there I rode to Vilna, and plied the local cathedral archive keeper with vodka for three straight days. Oh that one is a bottomless pit, the schismatic! With what money was left I ordered the local scribe to make a copy of the ancient manuscript, which tells of all these events. The monks knew not of whom or what it spoke...", "oim_getman_mamay_korona_finded_dlg_7", []],			
	[anyone,"oim_getman_mamay_korona_finded_dlg_7", [
		(call_script, "script_select_random_polish_center"), 
		(assign, ":quest_target_center", reg0),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_target_center, ":quest_target_center"),
		(str_store_party_name, s3, ":quest_target_center"), 
	], "Now let us see of what this ancient manuscript speaks: ""...and the man who repented of his grievous sins was accepted as a brother, and took upon himself our monastic vows, among them a vow of silence. Thereupon he took his schema to a hidden refuge at {s3}, where he spent his last days in constant self-torture. The item he brought with him was hidden in his cell, to wait for its hour to arrive..."" ", "oim_getman_mamay_korona_finded_dlg_8", []],			
	[anyone|plyr,"oim_getman_mamay_korona_finded_dlg_8", [], "My gratitude for your service, Mamai! Very well then, I shall go to the Grand Prince...", "close_window", [
		(call_script, "script_recruit_troop_as_companion", "trp_npc4"),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		(str_store_string, s5, "str_oim_korona_talk_to_getman"),	
		(add_quest_note_from_sreg, "qst_oim_getman_korona_vitovta", 4, s5, 1),
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 3),
	]],				

	#oim_getman_hmel_korna_finded
	[anyone|plyr,"oim_getman_hmel_korna_finded", [], "Good news, my Prince! I now know where the crown has been kept. Gather our forces and let us march to seize it!", "oim_getman_hmel_korna_finded_1", []],				
	[anyone,"oim_getman_hmel_korna_finded_1", [], "This is good news indeed. But we cannot mobilize our forces. My position is too unstable for me to confront the clergy. Besides, we should rather claim that the crown has always been kept in my house, awaiting the right hour.", "oim_getman_hmel_korna_finded_2", []],			
	[anyone|plyr,"oim_getman_hmel_korna_finded_2", [], "And what would you suggest we do?", "oim_getman_hmel_korna_finded_3", []],				
	[anyone,"oim_getman_hmel_korna_finded_3", [
		(quest_get_slot, ":party", "qst_oim_getman_korona_vitovta", slot_quest_target_center),
		(str_store_party_name_link, s3, ":party"), 
		(str_store_party_name, s2, ":party"), 
		(str_store_string, s5, "@Nu chto zhe budem trusit monastir v {s3} skritno"),	
		(add_quest_note_from_sreg, "qst_oim_getman_korona_vitovta", 4, s5, 1),
	], "There is one way -- you must dress yourself a monk, and go to {s2}. Once you sneak inside the monastery, do whatever you must to gain the crown.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_getman_korona_vitovta", slot_quest_current_state, 4),
	]],			

	
	#oim_getman_hmel_election_end_dlg
	[anyone,"oim_getman_hmel_election_end_dlg", [], "You have fulfilled your promises honorably. Now it is my turn.", "oim_getman_hmel_election_end_dlg_1", []],			
	[anyone,"oim_getman_hmel_election_end_dlg_1", [], "Wait for the coming elections, and I shall find a way to influence their outcome. Alas, you have powerful adversaries.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_getman_korona_vitovta"), 
		#qst_oim_getman_last_qst
		(quest_set_slot, "qst_oim_getman_last_qst", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_oim_getman_last_qst", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_getman_last_qst"),
		(str_store_string, s2, "@OIM_add_getman od morya do more qst text"),
		(call_script, "script_start_quest", "qst_oim_getman_last_qst", "$g_talk_troop"),
	]],			
	
	#oim_getman_volhv_last_dlg
	[anyone,"oim_getman_volhv_last_dlg", [], "Greetings, {playername}.", "oim_getman_volhv_last_dlg_1", []],			
	[anyone|plyr,"oim_getman_volhv_last_dlg_1", [], "Who are you? What do you need?", "oim_getman_volhv_last_dlg_2", []],				
	[anyone,"oim_getman_volhv_last_dlg_2", [], "I am a servant of Perun, the God of Thunder. Many in the Rus still worship the ancient gods. Pagans they call us...", "oim_getman_volhv_last_dlg_3", []],			
	[anyone|plyr,"oim_getman_volhv_last_dlg_3", [], "And what do you need?", "oim_getman_volhv_last_dlg_4", []],				
	[anyone,"oim_getman_volhv_last_dlg_4", [], "You have a thing that belongs to us.", "oim_getman_volhv_last_dlg_5", []],			
	[anyone|plyr,"oim_getman_volhv_last_dlg_5", [], "And what would that be?", "oim_getman_volhv_last_dlg_6", []],				
	[anyone,"oim_getman_volhv_last_dlg_6", [], "The Black Mace, stolen from us by Radziwill. Return it to me. This mace must remain in the hidden sanctuary.", "oim_getman_volhv_last_dlg_7", []],			
	[anyone|plyr,"oim_getman_volhv_last_dlg_7", [], "I fear I cannot give it back, pagan. It is simply too powerful", "oim_getman_volhv_last_dlg_8", []],				
	[anyone,"oim_getman_volhv_last_dlg_8", [], "There you are wrong, {playername}. It is but a mere mace. Perhaps upon hearing of its magical effects, you became convinced in your own strength, and found yourself an invincible warrior.", "oim_getman_volhv_last_dlg_9", []],			
	[anyone|plyr,"oim_getman_volhv_last_dlg_9", [], "Very well, soothsayer. Here, take the Black Mace. My hope is that the Rus shall never have need of it.", "oim_getman_volhv_last_dlg_10", []],				
	[anyone,"oim_getman_volhv_last_dlg_10", [], "Farewell, {playername}.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission), 
		(troop_remove_item, "trp_player", "itm_black_hetman", 1), 		
		(call_script, "script_end_quest", "qst_oim_getman_last_qst"), 		
		(call_script, "script_end_quest", "qst_oim_getman_main"), 
		
		(unlock_achievement, ACHIEVEMENT_BLACK_MACE), 
		
		(try_begin),
			(check_quest_active, "qst_oim_getman_za_hmelya"), 
			(call_script, "script_end_quest", "qst_oim_getman_za_hmelya"), 
		(end_try), 		
		(try_begin),
			(check_quest_active, "qst_oim_getman_za_barabasha"), 
			(call_script, "script_end_quest", "qst_oim_getman_za_barabasha"), 
		(end_try), 				
	]],			
	
	
	#kingdom_1",  "Rzeczpospolita Korony
	#kingdom_2",  "Moscow Tzardom",    0
	#kingdom_3",  "Crimea Khaganate", 0,
	#kingdom_4",  "Swedish Kingdom",    
	#kingdom_5",  "Hetmanat",  0, 0.9, [


	#za barabasha copy-paste code
	#oim_getman_barabash_casus_beli_dlg
	[anyone,"oim_getman_barabash_casus_beli_dlg", [], "Yes there is. It is time to join all our peoples together, and found a new nation.", "oim_getman_barabash_casus_beli_dlg_1", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_1", [], "And what should it be called? The Polish Commonwealth or the Tsardom of Moscow?", "oim_getman_barabash_casus_beli_dlg_2", []],				
	[anyone,"oim_getman_barabash_casus_beli_dlg_2", [], "Neither. We shall restore the old Grand Princedom of Rus.", "oim_getman_barabash_casus_beli_dlg_3", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_3", [], "Which would be ruled by a Grand Prince, not by a Hetman. But would his heirs call themselves Tsars or Kings? Or better yet, emperors.", "oim_getman_barabash_casus_beli_dlg_4", []],				
	[anyone,"oim_getman_barabash_casus_beli_dlg_4", [], "You understand quickly. But first you must conquer the Muscovite Tsardom.", "oim_getman_barabash_casus_beli_dlg_5", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_5", [], "Why delay then? You are Hetman, and I am Marshal. Give the word and we shall march.", "oim_getman_barabash_casus_beli_dlg_6", []],				
	[anyone,"oim_getman_barabash_casus_beli_dlg_6", [], "We have entered into alliance with them. Besides, our Colonels do not want this war. But if you stir their hostilities against us, our subjects shall rise up at once.", "oim_getman_barabash_casus_beli_dlg_7", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_7", [], "And what would you propose?", "oim_getman_barabash_casus_beli_dlg_8", []],				
	[anyone,"oim_getman_barabash_casus_beli_dlg_8", [], "You must leave service. Thereafter you shall capture a city of the Muscovite Tsardom. The Muscovites will assume that it was our work, and declare war upon us. Meanwhile I shall hold my colonels at bay, explaining to them that you acted at my personal behest.", "oim_getman_barabash_casus_beli_dlg_9", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_9", [], "A cunning plan. But after this, all Zaporozhian Colonels shall become my deadly enemies.", "oim_getman_barabash_casus_beli_dlg_10", []],				
	[anyone,"oim_getman_barabash_casus_beli_dlg_10", [], "Your good name will be restored in time. Once the war begins, I shall accept you back into service. For many, that alone would be a firm reason to change their attitude towards you. After this, simply fight well, win your battles, and soon enough, all shall be forgotten.", "oim_getman_barabash_casus_beli_dlg_11", []],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_11", [], "Agree...", "oim_getman_barabash_casus_beli_dlg_12", []],				
		[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_12", [], "I shall do it for a holy cause, the restoration of the Ancient Rus.", "oim_getman_barabash_casus_beli_dlg_13", []],				
		[anyone,"oim_getman_barabash_casus_beli_dlg_13", [], "So be it, then. In several days I shall announce the election of the new Marshal.", "lord_pretalk", [
			#code
			#qst_oim_getman_barabash_casus_beli
			(quest_set_slot, "qst_oim_getman_barabash_casus_beli", slot_quest_current_state, 1),
			(str_store_string, s5, "str_oim_casus_beli_barabash_qst"),	
			(add_quest_note_from_sreg, "qst_oim_getman_barabash_casus_beli", 4, s5, 1),
			(call_script, "script_player_leave_faction", 1), 
			(call_script, "script_set_player_relation_with_faction", "fac_kingdom_1", 0),
		]],			
	[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_11", [], "I cannot commit an act of betrayal, even if it is only a pretense.", "oim_getman_barabash_casus_beli_dlg_14", []],				
		[anyone|plyr,"oim_getman_barabash_casus_beli_dlg_14", [], "I would rather begin the war by ordinary means. Any rebels shall be dealt with.", "lord_pretalk", [
			#(call_script, "script_fail_quest", "qst_oim_getman_barabash_casus_beli"), 
			#qst_oim_getman_barabash_greate_war
			(quest_set_slot, "qst_oim_getman_barabash_casus_beli", slot_quest_current_state, 2),
			(quest_set_slot, "qst_oim_getman_barabash_greate_war", slot_quest_giver_troop, "trp_player"), 
			(quest_set_slot, "qst_oim_getman_barabash_greate_war", slot_quest_current_state, 0),
			(setup_quest_text, "qst_oim_getman_barabash_greate_war"),
			(str_store_string, s2, "@OIM_add_getman Bilo resheno deystvovat na prolom. Vi otpravili gonca s tekstom o nachale voini v MTzrd"),
			(call_script, "script_start_quest", "qst_oim_getman_barabash_greate_war", "trp_player"),
			(set_spawn_radius, 0),
            (spawn_around_party, "p_main_party", "pt_sacrificed_messenger"),
            (assign, ":new_party", reg0),
			(call_script, "script_get_random_troop_from_party", "p_main_party"), 
			(assign, ":troop", reg0), 
            (party_add_members, ":new_party", ":troop", 1),
			(remove_member_from_party, ":troop", "p_main_party"),
            (party_set_ai_behavior, ":new_party", ai_bhvr_travel_to_party),
			(call_script, "script_cf_select_random_walled_center_with_faction", "fac_kingdom_1"),
			(assign, ":quest_target_center", reg0), 
            (party_set_ai_object, ":new_party", ":quest_target_center"),
			(quest_set_slot, "qst_oim_getman_barabash_greate_war", slot_quest_target_center, ":quest_target_center"),
            (party_set_flags, ":new_party", pf_default_behavior, 0),
			(quest_set_slot, "qst_oim_getman_barabash_greate_war", slot_quest_target_party, ":new_party"),
			(str_store_string, s5, "str_oim_casus_beli_barabash_qst"),	
			(add_quest_note_from_sreg, "qst_oim_getman_barabash_casus_beli", 4, s5, 1),
		]],			
	 
	 
	
	
	
	##################################################################################	
	##																				##	
	##	OiM Dmitriy code															##
	##																				##	
	##################################################################################			

	
	#oim_dmitriy_initial_dlg
	[anyone,"oim_dmitriy_initial_dlg", [], "Have you truly made up your mind to become king? Alas, all the thrones are occupied. But many a poor nobleman has raised himself up to become King. History is written by such men.", "oim_dmitriy_initial_dlg_1", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_1", [], "Tell me, what do you mean?", "oim_dmitriy_initial_dlg_2", []],				
	[anyone,"oim_dmitriy_initial_dlg_2", [], "Do you not know? Only sixty years have passed since the son of Tsar Ivan the Terrible, Prince Dmitry, was murdered in Uglich. Soon rumors were circulating in Moscow that the child-killers had been sent by the new Tsar, Boris Godunov.", "oim_dmitriy_initial_dlg_3", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_3", [], "Could it be true?", "oim_dmitriy_initial_dlg_4", []],				
	[anyone,"oim_dmitriy_initial_dlg_4", [], "Who knows what the truth is. All witnesses of these dreadful deeds were wiped out, along with their villages. One thing alone is true -- as soon as talk of murder began, the rule of Boris was all but finished.", "oim_dmitriy_initial_dlg_5", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_5", [], "Yea, I've heard stories like this...", "oim_dmitriy_initial_dlg_6", []],				
	[anyone,"oim_dmitriy_initial_dlg_6", [], "Stories? My late grandfather told me of these dreadful years. In the middle of August, frost struck the lands of Moscow. All their bread was lost, and a great famine arose which lasted three full years. It was then that a man from Poland proclaimed himself Prince Dmitry.", "oim_dmitriy_initial_dlg_7", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_7", [], "So the son of Ivan the Terrible was not murdered?", "oim_dmitriy_initial_dlg_8", []],				
	[anyone,"oim_dmitriy_initial_dlg_8", [], "Godunov tried to prove him dead, but the monk, Grigory Otrepyev, told another tale. He claimed he was Dmitry himself, and that it was the son of a priest that was murdered instead, while he himself was saved and hidden in the monastery by those loyal to the crown.", "oim_dmitriy_initial_dlg_9", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_9", [], "And the people believed him?", "oim_dmitriy_initial_dlg_10", []],				
	[anyone,"oim_dmitriy_initial_dlg_10", [], "Alas, they did. Worse yet, all the Polish magnates aided him, for they dreamed of seeing their pawn seated upon the throne of Moscow. Many church leaders and noble Boyars of Rus took the side of False Dmitry. And the Don Cossacks even sent him a messenger to swear allegiance.", "oim_dmitriy_initial_dlg_11", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_11", [], "And what followed?", "oim_dmitriy_initial_dlg_12", []],				
	[anyone,"oim_dmitriy_initial_dlg_12", [], "Everyone knows that. Otrepyev, with a small force, marched on to Moscow. Godunov sent his forces to pacify the uprising, but they betrayed Godunov and joined the impostor. And once the Boyars Basmanov and Shuisky, of noble houses, swore before the folk that Otrepyev truly was Prince Dmitry, Tsar Boris fell into illness and soon died. Meanwhile, Grigory Otrepyev, or whoever he really was, entered Moscow and was anointed as the sovereign Dmitry I.", "oim_dmitriy_initial_dlg_13", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_13", [], "So that is how the Time of Troubles began...", "oim_dmitriy_initial_dlg_14", []],				
	[anyone,"oim_dmitriy_initial_dlg_14", [], "Indeed. Soon the Boyars, doubtful that Dmitry was indeed the son of Tsar Ivan, murdered him and rioted against the Poles in Moscow. Vasily Shuisky became Tsar, and soon another False Dmitry arrived, named by the people the Thief of Tushino -- and after that, impostors sprung up in the Rus like mushrooms after the rain...", "oim_dmitriy_initial_dlg_15", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_15", [], "So the first False Dmitry was an impostor after all?", "oim_dmitriy_initial_dlg_16", []],				
	[anyone,"oim_dmitriy_initial_dlg_16", [], "Much water has flowed under the bridge since the day... Of those who know the real truth, no one remains. Although I do know one man who was in Otrepyev's company...", "oim_dmitriy_initial_dlg_17", []],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_17", [], "Who is he?", "oim_dmitriy_initial_dlg_18", []],			
	[anyone,"oim_dmitriy_initial_dlg_18", [], "Oh, a clever one. That knowledge is quite valuable...", "oim_dmitriy_initial_dlg_19", []],				
	[anyone|plyr,"oim_dmitriy_initial_dlg_19", [], "And what do you want for it?", "oim_dmitriy_initial_dlg_20", []],			
	[anyone,"oim_dmitriy_initial_dlg_20", [], "I have been ordered to lead a force through the lands of the Polish Commonwealth, and bring war to the Poles. I could use your aid in this. Ravage three Polish villages, and I shall tell you all I know. And at the same time, I shall see what sort of friend you are to the Muscovite Tsardom.", "oim_dmitriy_initial_dlg_21", []],				
	[anyone|plyr,"oim_dmitriy_initial_dlg_21", [], "I do not do battle with peasants.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_dmitriy_main", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_dmitriy_main", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_dmitriy_main"),
		(str_store_string, s2, "@OIM_add_getman  Nu chto zhe kto ne bil "),
		(call_script, "script_start_quest", "qst_oim_dmitriy_main", "trp_player"),
		#
		(str_store_troop_name_link, s4, "$g_talk_troop"), 
		(str_store_string, s5, "@OiM_dmitriy Teper kogda {s4} oskorblen moim otkazom pomoch emu - shansov uznat pravdu o lzhedmitriye u menya bolshe net"),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_main", 4, s5, 1),
		(call_script, "script_fail_quest", "qst_oim_dmitriy_main"),
	]],			
	[anyone|plyr,"oim_dmitriy_initial_dlg_21", [], "I agree. It is a worthy deed.", "lord_pretalk", [
		#qst_oim_dmitriy_main
		(quest_set_slot, "qst_oim_dmitriy_main", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_dmitriy_main", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_dmitriy_main"),
		(str_store_string, s2, "@OIM_add_getman  Nu chto zhe kto ne bil "),

		(unlock_achievement, ACHIEVEMENT_FIRST_STEPS), 

		(call_script, "script_start_quest", "qst_oim_dmitriy_main", "trp_player"),
		########################################
		#qst_dmitriy_loot_villages
		(quest_set_slot, "qst_dmitriy_loot_villages", slot_quest_giver_troop, "$g_talk_troop"), 
		(quest_set_slot, "qst_dmitriy_loot_villages", slot_quest_current_state, 0),
		(setup_quest_text, "qst_dmitriy_loot_villages"),
		(str_store_troop_name_link, s3, "$g_talk_troop"), 
		(str_store_string, s2, "str_dmitriy_villages_descr"),
		(call_script, "script_start_quest", "qst_dmitriy_loot_villages", "$g_talk_troop"),
		#(assign, "$oim_dmitriy_looted_count", 1),
		(assign, "$g_main_quest_active", 1),
		(call_script, "script_add_notification_menu", "mnu_notification_simple_str", "str_oim_kings_service_notification", -1), 		
	]],				

	#oim_dmitriy_loot_villages_end_dlg
	[anyone|plyr,"oim_dmitriy_loot_villages_end_dlg", [], "There. I have had my share of fun. Three villages lay in ruin. Send report of victory to the Tsar, and tell me what you promised.", "oim_dmitriy_loot_villages_end_dlg_1", []],				
	[anyone,"oim_dmitriy_loot_villages_end_dlg_1", [], "Quite good! May these Poles be damned. We need more heroes like Ivan Susanin! As for that man you asked of, he lives in Trakai. He is a former Cossack Starshina, and goes by the name of Gerasim Evangelic.", "lord_pretalk", [
		(call_script, "script_end_quest","qst_dmitriy_loot_villages"), 
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 0),
		(setup_quest_text, "qst_oim_dmitriy_gerasim"),
		(str_store_party_name_link, s3, "p_village_82"),
		(str_store_string, s2, "@OIM_add_getman  Nuzhno nayti gerasima Evangelika"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_gerasim", "trp_player"),
	]],			
 
	[anyone,"oim_start_quest_trakay_icon", [], "Our settlement is large. Many people call this their home. Perhaps the one you seek is among them, but perhaps not.", "oim_start_quest_trakay_icon_1", []],				
	[anyone|plyr,"oim_start_quest_trakay_icon_1", [], "There now, good sir, do not waste words on me. If you know where he can be found, but are hesitant to help a stranger without something in return, then speak plainly.", "oim_start_quest_trakay_icon_2", []],			
	[anyone,"oim_start_quest_trakay_icon_2", [], "Ah, plainly. Trakai has little use for your money, but we could use your help.", "oim_start_quest_trakay_icon_3", []],				
	[anyone|plyr,"oim_start_quest_trakay_icon_3", [], "And what help would that be?", "oim_start_quest_trakay_icon_4", []],			
	[anyone,"oim_start_quest_trakay_icon_4", [], "A great difficulty has befallen us, {sir/madam}... We had a miraculous icon in our village chapel. We know not what it meant, but it was Orthodox, and it was ours. It was left here by the Grand Prince Yaroslav the Wise himself, when he laid the foundation for the town of Yuriev. The Lithuanian name Trakai came to us later. Very recently, however, a Catholic priest arrived from Vilna with his soldiers, and plundered the chapel, taking everything we had ""for the needs of his church"".", "oim_start_quest_trakay_icon_5", []],				
	[anyone|plyr,"oim_start_quest_trakay_icon_5", [], "And what do you want of me?", "oim_start_quest_trakay_icon_6", []],			
	[anyone,"oim_start_quest_trakay_icon_6", [], "Find the priest and return the relic that is ours. -- And I shall reward you. I'll find out where Gerasim might be.", "oim_start_quest_trakay_icon_7", []],				
	[anyone|plyr,"oim_start_quest_trakay_icon_7", [], "I must think on this, old man. I am new to these lands... Where would I seek this priest?", "oim_start_quest_trakay_icon_8", []],			
	[anyone,"oim_start_quest_trakay_icon_8", [], "He lives in Vilna, {sir/madam}. Everyone knows him there.", "oim_start_quest_trakay_icon_9", []],				
	[anyone|plyr,"oim_start_quest_trakay_icon_9", [], "All right, I will try to help.", "close_window", [
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_xp_reward, 100),
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_gold_reward, 100),
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 1),
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(str_store_party_name_link, s10, "p_town_4"),		
		(str_store_troop_name_link, s11, "trp_kingdom_1_pretender"),
		(setup_quest_text, "qst_oim_trakay_icon"),	
		(str_store_string, s2, "@OiM The elder {s9} said that the monk is in the {s10}. Try to talk to {s11}"),
		(call_script, "script_start_quest", "qst_oim_trakay_icon", "$g_talk_troop"),	
		
		(quest_set_slot, "qst_oim_trakay_icon", slot_quest_current_state, 2),  
		(str_store_party_name_link, s10, "p_town_4"),		
		(str_store_string, s2, "str_trakay_radz_descr"),  
		(add_quest_note_from_sreg, "qst_oim_trakay_icon", 4, s2, 1),

	]],			
		
    [anyone,"oim_tracai_icon_done", [], "Well, my good {man/lady}, have you found the priest? Recovered our icon?", "oim_tracai_icon_done_1", []],	
    [anyone|plyr,"oim_tracai_icon_done_1", [], "Yes, I found him. Followed him all the way to Riga, and spent quite some time persuading him. Here is your icon.", "oim_tracai_icon_done_2", []],		       
	[anyone,"oim_tracai_icon_done_2", [], "All our village shall pray for you, my good {man/lady}! That icon is worshipped by men from all the nearby villages... We shall tell them all who returned it to us. As for old Gerasim, he once resided here, but he is here no longer here. He left for {s4}.", "close_window", [
	#code finish quest
		(call_script, "script_troop_add_gold", "trp_player", 250),
		(add_xp_as_reward, 200),
		(call_script, "script_change_player_relation_with_center", "$current_town", 10),
		(call_script, "script_end_quest", "qst_oim_trakay_icon"),	
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 2),
		#(quest_slot_eq, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 2),
		(call_script, "script_cf_select_random_village_with_faction", "fac_kingdom_2"),
		(assign, ":village", reg0),
		(str_store_party_name_link, s4, ":village"),
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_target_center, ":village"),
		(str_store_string, s5, "@OiM_getman Yavangelik v {s4}"),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_gerasim", 4, s5, 1),
	]],		
	
	#oim_dmitriy_gerasim_start_dlg
	[anyone|plyr,"oim_dmitriy_gerasim_start_dlg", [], "Old man, are you perhaps Gerasim Evangelic?", "oim_dmitriy_gerasim_start_dlg_1", []],			
	[anyone,"oim_dmitriy_gerasim_start_dlg_1", [], "Perhaps so. And what business of yours would that be?", "oim_dmitriy_gerasim_start_dlg_2", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_start_dlg_2", [], "I heard you were a confidant of False Dmitry.", "oim_dmitriy_gerasim_start_dlg_3", []],			
	[anyone,"oim_dmitriy_gerasim_start_dlg_3", [], "Perhaps so, perhaps not. And why would you be curious?", "oim_dmitriy_gerasim_start_dlg_4", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_start_dlg_4", [], "I want to know if he truly was the saved prince Dmitry or not.", "oim_dmitriy_gerasim_start_dlg_5", []],			
	[anyone,"oim_dmitriy_gerasim_start_dlg_5", [], "Five decades have passed since those days. All who lived in those troubled times have long passed into the grave. The bones of Dmitry have long moldered, and the Tsars of the house of Romanov today call him a traitor and an imposter...", "oim_dmitriy_gerasim_start_dlg_6", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_start_dlg_6", [], "You named him Dmitry, not Grigory, old man. Would that mean he truly were...", "close_window", [
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 3),
	]],			
	
	#oim_dmitriy_gerasim_elder
	[anyone|plyr,"oim_dmitriy_gerasim_elder", [], "Sir, I spoke to the old Cossack Gerasim just now. Can you tell me where he is now?", "oim_dmitriy_gerasim_elder_1", []],			
	[anyone,"oim_dmitriy_gerasim_elder_1", [], "Gerasim was severely wounded. He lay in one of the houses.", "close_window", [
		(assign, "$oim_auto_talk_troop", "trp_oim_dmitriy_yevangelik"), 
		(jump_to_menu, "mnu_oim_auto_talk_menu"),
		(quest_set_slot, "qst_oim_dmitriy_gerasim", slot_quest_current_state, 5),
		(finish_mission),
	]],				

	[anyone|plyr,"oim_dmitriy_gerasim_last", [], "I am back, old man. We overcame the bandits.", "oim_dmitriy_gerasim_last_1", []],			
	[anyone,"oim_dmitriy_gerasim_last_1", [], "I see you are a good warrior. You really wish to know of Prince Dmitry?", "oim_dmitriy_gerasim_last_2", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_2", [], "Yes, old man, that is my wish.", "oim_dmitriy_gerasim_last_3", []],			
	[anyone,"oim_dmitriy_gerasim_last_3", [], "My wound is deep. I doubt I have much time left. Very well, I will tell what I can. In the days of my youth, I was a Starshina of the Sich. My troops hid on the Dnieper floodplain, and made raids on the Lithuanians, Poles, and Muscovites. Once a lad arrived at our camp... He was about twenty-five years old. Called himself Grigory, said he was a runaway monk. He told us that the name he had before he took his vows was Yuriy, and he was the son of the Galician Boyar Bogdan Yakov Zamyatni-Otrepyev -- a company commander who was knifed in Moscow by a drunken Lithuanian. Grigory asked to serve among my men, and wished to learn how to wield a sword and ride a horse. Every Cossack of mine back then was worth his weight in gold, so I took him in, taught him the arts of war, and started taking him on raids.", "oim_dmitriy_gerasim_last_4", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_4", [], "This was the future Tsar Dmitry?", "oim_dmitriy_gerasim_last_5", []],			
	[anyone,"oim_dmitriy_gerasim_last_5", [], "Indeed it was. Later I came to learn that prior to donning the cloth, he resided in Moscow, and served at the house of prince Boris Cherkassky. Grigory learned how to read and write, and displayed quite some wit. He was unlike any ill born Boyar. Now the tales have it that he was an ugly, bow-legged man with misshapen hands, but in truth he was a true Prince on sight. And those who happened to have known Tsar Ivan Vasilievich admitted that the young man closely resembled the Terrible Tsar, even more that his elder son, whom he killed...", "oim_dmitriy_gerasim_last_6", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_6", [], "So what happened?", "oim_dmitriy_gerasim_last_7", []],			
	[anyone,"oim_dmitriy_gerasim_last_7", [], "Soon enough, Dmitry left us and became sword-bearer for Prince Adam Vishnevetsky. It was there that he made known his true name. That is when word spread through all of Rus that the rightful heir to the throne yet lived.", "oim_dmitriy_gerasim_last_8", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_8", [], "I heard you were among his closest companions.", "oim_dmitriy_gerasim_last_9", []],			
	[anyone,"oim_dmitriy_gerasim_last_9", [], "That is true. Dmitry Ivanovich sent for me after he met the Polish King Sigismund and was proclaimed the rightful claimant to the Tsardom of Moscow. He offered me the honor of leading his personal guard, and I accepted.", "oim_dmitriy_gerasim_last_10", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_10", [], "You believed that he was not an impostor, but the real Prince?", "oim_dmitriy_gerasim_last_11", []],			
	[anyone,"oim_dmitriy_gerasim_last_11", [], "Yea, I believed it. He showed me a golden cross covered with gems, given to him by his godfather, Prince Ivan Mstislavsky. Besides, the real Yuriy Zamyatni-Otrepyev died soon after birth. I went to Galich myself to check. -- And he had a birthmark known to the Tsar's servants.", "oim_dmitriy_gerasim_last_12", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_12", [], "So Dmitry was the true Tsar.", "oim_dmitriy_gerasim_last_13", []],			
	[anyone,"oim_dmitriy_gerasim_last_13", [], "So it would seem. Yet his reign was short. He had promised the Poles some of the lands of Russia in exchange for their support, but when he refused them this, they along with the Jesuits rejected him and consigned him to a certain death at the hands of the rebel Boyars. His death was dreadful.", "oim_dmitriy_gerasim_last_14", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_14", [], "And how did you survive?", "oim_dmitriy_gerasim_last_15", []],			
	[anyone,"oim_dmitriy_gerasim_last_15", [], "Dmitry came to learn of the plot. He sent me to Warsaw with a secret letter to the king. Just after I left the city, I learned of his death. I disguised myself as a simple Cossack, and returned to the palace, only to find his torn and broken body. Beside it I found the very cross I spoke of before.", "oim_dmitriy_gerasim_last_16", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_16", [], "So you have been a wanderer ever since?", "oim_dmitriy_gerasim_last_17", []],			
	[anyone,"oim_dmitriy_gerasim_last_17", [], "Yes, I have wandered. But now it seems that my path comes to an end. But now, listen well to my words... Do you see that chest box? Inside it there is a good pistol, some silver I have kept for a rainy day, and the cross of Tsar Dmitry. Take it and do with it as you please.", "oim_dmitriy_gerasim_last_18", []],				
	[anyone|plyr,"oim_dmitriy_gerasim_last_18", [], "Thank you, old man.", "oim_dmitriy_gerasim_last_19", []],			
	[anyone,"oim_dmitriy_gerasim_last_19", [], "Spare me your thanks. Avenge Dmitry's death if you truly wish to express your gratitude. Many Boyars of the noble houses are displeased with the Romanovs. Find the Marshal-warlord of Moscow and gain his confidence. Now go... The village folk will bury me as a Christian.", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_gerasim"),
		(call_script, "script_end_quest", "qst_oim_dmitriy_gerasim"),
		(troop_add_item, "trp_player", "itm_good_pistol", 0),
		(quest_set_slot, "qst_oim_dmitriy_main", slot_quest_current_state, 1),
		#qst_oim_dmitriy_talk_to_voevoda
		(quest_set_slot, "qst_oim_dmitriy_talk_to_voevoda", slot_quest_giver_troop, "trp_player"), 
		(quest_set_slot, "qst_oim_dmitriy_talk_to_voevoda", slot_quest_current_state, 0),
		(str_store_troop_name_link, s3, "trp_knight_2_1"),
		(setup_quest_text, "qst_oim_dmitriy_talk_to_voevoda"),
		(str_store_string, s2, "@OIM_add_getman  Nuzhno pogovorit s voevodoy..."),
		(call_script, "script_start_quest", "qst_oim_dmitriy_talk_to_voevoda", "trp_player"),
	]],				
	
	#[anyone,"oim_lord_sp_task"
	[anyone,"oim_dmitriy_elena_init_dlg", [], "{Sir/Madam}, what wind brings you to our lands? We heard that the Swedes attacked Poland. The council is in turmoil, and all the roads are closed. Our merchants no longer carry their goods, and instead sit in town making no profit.", "oim_dmitriy_elena_init_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_1", [], "A deep bow to you from Gerasim, who goes by the name of Evangelic.", "oim_dmitriy_elena_init_dlg_2", []],			
	[anyone,"oim_dmitriy_elena_init_dlg_2", [], "Hmm... Eh... Who is this Gerasim? It's the first I've heard of him...", "oim_dmitriy_elena_init_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_3", [], "That who is known to you from the Time of Troubles. He instructed me to pay homage to you as he died.", "oim_dmitriy_elena_init_dlg_4", []],			
	[anyone,"oim_dmitriy_elena_init_dlg_4", [], "As he died, you say? Thank Go... I mean to say, most unfortunate... But again, I do not know of whom you speak...", "oim_dmitriy_elena_init_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_5", [], "Of the Cossack who commanded Prince Dmitry's personal guard...", "oim_dmitriy_elena_init_dlg_6", []],			
	[anyone,"oim_dmitriy_elena_init_dlg_6", [], "Silence, you wretch! I know no Dmitry. Aye, my father supported the impostor, the False Dmitry, but he had a small mind, and for this our family has already suffered greatly. Do not stir up the past. Be gone from this place.", "oim_dmitriy_elena_init_dlg_7", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_7", [], "I see your point, warlord. Times are difficult these days... And he who would dare to recall the past might not just lose an eye, but could well lose his very head. In any case, I have said nothing to you, and you have heard nothing from me.", "oim_dmitriy_elena_init_dlg_8", []],			
	[anyone,"oim_dmitriy_elena_init_dlg_8", [], "I see you have a sharp mind and a quick tongue. I need men like you. In fact, I have a certain delicate affair that I shall entrust with you.", "oim_dmitriy_elena_init_dlg_9", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_9", [], "What would that be? I seek to gain glory and fill my purse.", "oim_dmitriy_elena_init_dlg_10", []],			
	[anyone,"oim_dmitriy_elena_init_dlg_10", [], "The niece of the Swedish king, Eleanor, is our guest here at Novgorod. Here is your order -- to escort the princess to Allenstein Castle, where Carl Gustaf now resides. If you do this, you will earn the Tsar's favor, and the gratitude of the king of Sweden. And I shall offer you reward as well. The prison chief shall provide you all that is necessary.", "oim_dmitriy_elena_init_dlg_11", []],				
	[anyone|plyr,"oim_dmitriy_elena_init_dlg_11", [], "Well, certainly such a task is to my liking. I would like to visit Carl.", "lord_pretalk", [
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_talk_to_voevoda"),
		(call_script, "script_end_quest", "qst_oim_dmitriy_talk_to_voevoda"),
		(add_xp_as_reward, 600),
		#qst_oim_dmitriy_eleonora
		(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(str_store_party_name_link, s10, "p_castle_6"),		
		(str_store_troop_name_link, s11, "trp_kingdom_4_lord"),
		(setup_quest_text, "qst_oim_dmitriy_eleonora"),	
		(str_store_string, s2, "@OiM The {s9} prosil vas otvezti Eleonoru v {s10} k {s11}"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_eleonora", "$g_talk_troop"),	
		(str_store_party_name_link, s3, "p_castle_6"), 
		(str_store_string, s2, "str_additional_info_oim_dmitriy_eleonora"),  
		(add_quest_note_from_dialog, "qst_oim_dmitriy_eleonora", 4, s2, 1),

	]],			
	
	#oim_dmitriy_eleonora_mayor_talk
	[anyone,"oim_dmitriy_eleonora_mayor_talk", [], "Perfect, then. We shall load the cart, and then you may go forth with our celebrated guest...", "close_window", [
		(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 1),
		(call_script, "script_troop_add_gold", "trp_player", 200), 
		(party_force_add_members, "p_main_party", "trp_eleonora", 1),
		(party_force_add_members, "p_main_party", "trp_vaegir_archer", 4),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_start_time, ":cur_day"),
	]],					
	
	#oim_dmitriy_eleonora_dlg
	[anyone,"oim_dmitriy_eleonora_dlg", [], "Hear me, {playername}. I must tell you something!", "oim_dmitriy_eleonora_dlg_1", [
		(quest_set_slot, "qst_oim_dmitriy_eleonora", slot_quest_current_state, 2),
		(jump_to_menu, "mnu_auto_return_to_map"),
		(finish_mission),
	]],				
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_1", [], "I have no time for talk.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_1", [], "I am all ears.", "oim_dmitriy_eleonora_dlg_2", []],			
	[anyone,"oim_dmitriy_eleonora_dlg_2", [], "In Novgorod I dared not open my mouth. The warlord of the town wants to please everyone -- the Novgorod council, the Moscow Tsar -- and even the King of Sweden. He did not tell you who I really am, did he?", "oim_dmitriy_eleonora_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_3", [], "That is of no concern to me.", "oim_dmitriy_eleonora_dlg_3_neg", []],			
		[anyone|plyr,"oim_dmitriy_eleonora_dlg_3_neg", [], "Were you the beloved wife of the Turkish Sultan, I would still bring you to castle Allenstein.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_3", [], "I suppose not. So who are you?", "oim_dmitriy_eleonora_dlg_4", []],			
	[anyone,"oim_dmitriy_eleonora_dlg_4", [], "I am not Carl's niece, but the former wife of his nephew, Olaf. My name is Alevtina, and I am the only daughter of the Boyar Nikita Odoyevskiy. I have been forced into an arranged marriage at the insistence of King Carl.", "oim_dmitriy_eleonora_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_5", [], "But I was told you were kept hostage in Novgorod.", "oim_dmitriy_eleonora_dlg_6", []],			
	[anyone,"oim_dmitriy_eleonora_dlg_6", [], "You were deceived. My husband Olaf died three months ago of gluttony. After the funeral, I fled to Novgorod, but the warlord feared Carl's wrath, and resolved to return me to him. He spoke to you with a forked tongue, believe me!", "oim_dmitriy_eleonora_dlg_7", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_7", [], "This means nothing to me. Let us carry on.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_7", [], "So you do not want to go to Castle Allenstein?", "oim_dmitriy_eleonora_dlg_8", []],			
	[anyone,"oim_dmitriy_eleonora_dlg_8", [], "Please, bring me to my father, {sir/madam}. He shall reward you with an open hand.", "oim_dmitriy_eleonora_dlg_9", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_9", [], "Pardon me, but I am executing my orders no matter what you say.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_eleonora_dlg_9", [], "So be it, come what may. We'll go to your father.", "close_window", [
		#code to fail quest and start new
		(call_script, "script_fail_quest", "qst_oim_dmitriy_eleonora"), 
		(call_script, "script_end_quest", "qst_oim_dmitriy_eleonora"), 
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_4", -60), 
		#qst_oim_dmitriy_eleonora_home
		(quest_set_slot, "qst_oim_dmitriy_eleonora_home", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_eleonora_home", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s11, "trp_knight_2_17"),
		(setup_quest_text, "qst_oim_dmitriy_eleonora_home"),	
		(str_store_string, s2, "@OiM The {s9} prosilf vas otvezti ee k {s11}"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_eleonora_home", "$g_talk_troop"),	
	]],				

	#oim_dmitriy_eleonora_delivered_shwed
	[anyone|plyr,"oim_dmitriy_eleonora_delivered_shwed", [], "Sire! Your niece, Eleanor, has been delivered safe and sound. And I am happy to have served you.", "oim_dmitriy_eleonora_delivered_shwed_1", []],			
	[anyone,"oim_dmitriy_eleonora_delivered_shwed_1", [], "You cannot know the full extent of my joy -- especially now that Alexei, Tsar of Moscow, can no longer twist my arms. Thank you for your excellent service!", "oim_dmitriy_eleonora_delivered_shwed_2", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_delivered_shwed_2", [], "Perhaps you have another task for me, Sire?", "oim_dmitriy_eleonora_delivered_shwed_3", []],			
	[anyone,"oim_dmitriy_eleonora_delivered_shwed_3", [], "Head to the Tsar of Moscow and relay my gratitude and that of my kinswoman.", "lord_pretalk", [
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_eleonora"), 
		(call_script, "script_end_quest", "qst_oim_dmitriy_eleonora"), 
		(call_script, "script_change_player_relation_with_faction", "fac_kingdom_4", 10), 
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 20), 
		(add_xp_as_reward, 600),
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		#qst_oim_dmitriy_deliver_letter_shwed
		(quest_set_slot, "qst_oim_dmitriy_deliver_letter_shwed", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_deliver_letter_shwed", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s11, "trp_kingdom_2_lord"),
		(setup_quest_text, "qst_oim_dmitriy_deliver_letter_shwed"),	
		(str_store_string, s2, "@OiM The {s9} prosilf vas dostavit pismo k {s11}"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_deliver_letter_shwed", "$g_talk_troop"),	
		(remove_member_from_party, "trp_eleonora", "p_main_party"),
	]],				

	#oim_dmitriy_eleonora_delivered_odoevskiy
	[anyone|plyr,"oim_dmitriy_eleonora_delivered_odoevskiy", [], "A long road I traveled to get to you, warlord. I have brought your daughter from Novgorod.", "oim_dmitriy_eleonora_delivered_odoevskiy_1", []],			
	[anyone,"oim_dmitriy_eleonora_delivered_odoevskiy_1", [], "Thank you for this fine deed, {sir/madam}! I shall not let you go before I give you a worthy reward.", "oim_dmitriy_eleonora_delivered_odoevskiy_2", []],				
	[anyone|plyr,"oim_dmitriy_eleonora_delivered_odoevskiy_2", [], "Perhaps I could be of further service, warlord?", "oim_dmitriy_eleonora_delivered_odoevskiy_3", []],			
	[anyone,"oim_dmitriy_eleonora_delivered_odoevskiy_3", [], "Indeed you can, {sir/madam}. Head to Moscow and relay my message to Tsar Alexei Mikhailovich.", "lord_pretalk", [
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_eleonora_home"), 
		(call_script, "script_end_quest", "qst_oim_dmitriy_eleonora_home"), 
		#(call_script, "script_change_player_relation_with_faction", "fac_kingdom_4", 10), 
		(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 20), 
		(add_xp_as_reward, 600),
		(call_script, "script_troop_add_gold", "trp_player", 1000),
		#qst_oim_dmitriy_deliver_letter_msk
		(quest_set_slot, "qst_oim_dmitriy_deliver_letter_msk", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_deliver_letter_msk", slot_quest_giver_troop, "$g_talk_troop"),  
		(str_store_troop_name_link, s9, "$g_talk_troop"),	
		(str_store_troop_name_link, s11, "trp_kingdom_2_lord"),
		(setup_quest_text, "qst_oim_dmitriy_deliver_letter_msk"),	
		(str_store_string, s2, "@OiM The {s9} prosil vas dostavit pismo k {s11}"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_deliver_letter_msk", "$g_talk_troop"),	
		(remove_member_from_party, "trp_eleonora", "p_main_party"),
	]],			


	#oim_dmitriy_leter_delevered_shwed
	[anyone|plyr,"oim_dmitriy_leter_delevered_msk", [], "Your Majesty, Boyar Nikita Odoyevsky offers a low bow for the salvation of his daughter.", "oim_dmitriy_leter_delevered_general", [
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_deliver_letter_msk"), 
		(call_script, "script_end_quest", "qst_oim_dmitriy_deliver_letter_msk"), 

	]],				
	
	[anyone|plyr,"oim_dmitriy_leter_delevered_shwed", [], "Your Majesty, the Swedish king Carl Gustaf sends you his gratitude for the return of his niece.", "oim_dmitriy_leter_delevered_general", [
		#(call_script, "script_succeed_quest", "qst_oim_dmitriy_deliver_letter_shwed"), 
		(call_script, "script_end_quest", "qst_oim_dmitriy_deliver_letter_shwed"), 
	]],				
	#oim_dmitriy_leter_delevered_general
	[anyone,"oim_dmitriy_leter_delevered_general", [], "Very well, thank you for your service. Who are you and where do you come from?", "oim_dmitriy_leter_delevered_general_1", []],				
	[anyone|plyr,"oim_dmitriy_leter_delevered_general_1", [], "My name is {playername}. I would like to enter your service, Your Majesty.", "oim_dmitriy_leter_delevered_general_2", []],			
	[anyone,"oim_dmitriy_leter_delevered_general_2", [], "Well, the Muscovite Tsardom is in need of good warriors. Come closer. Bow down before me.", "oim_dmitriy_leter_delevered_general_3", []],				
	[anyone|plyr,"oim_dmitriy_leter_delevered_general_3", [], "Yes, Your Majesty!", "oim_dmitriy_leter_delevered_general_4", []],			
	[anyone,"oim_dmitriy_leter_delevered_general_4", [], "What is this cross around your neck? It looks familiar. There is one just like it inside the Armory. These two crosses were forged for the sons of Ivan the Terrible at his behest! Where could a mere warrior get it?", "oim_dmitriy_leter_delevered_general_5", []],				
	[anyone|plyr,"oim_dmitriy_leter_delevered_general_5", [], "Hear me, Your Majesty...", "oim_dmitriy_leter_delevered_general_6", []],			
	[anyone,"oim_dmitriy_leter_delevered_general_6", [], "Nay, I shall not hear a word! This cross can only fall into the hands of the impostor, or his wicked offspring. Our torturers shall discover the truth behind this!", "oim_dmitriy_leter_delevered_general_7", []],				
	[anyone,"oim_dmitriy_leter_delevered_general_7", [], "Guards! Take him!", "close_window", [
		#qst_oim_dmitriy_tsar_prison
		(quest_set_slot, "qst_oim_dmitriy_tsar_prison", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_tsar_prison", slot_quest_giver_troop, "trp_player"),  
		(str_store_troop_name_link, s11, "trp_kingdom_2_lord"),
		(setup_quest_text, "qst_oim_dmitriy_tsar_prison"),	
		(str_store_string, s2, "@OiM The {s11} dobriy tsar... otpravil v turmu na doprosi... Viberus - poluchit on svoye..."),
		(call_script, "script_start_quest", "qst_oim_dmitriy_tsar_prison", "trp_player"),	
		#fix this
		(assign, "$g_leave_encounter", 1), 
		(call_script, "script_player_leave_faction", 1),
		(jump_to_menu, "mnu_oim_dmitriy_captured"),
		(finish_mission),
		(party_relocate_near_party, "p_main_party", "p_town_8", 1),
	]],			
	
	#oim_dmitriy_razin_init_dlg
	[anyone,"oim_dmitriy_razin_init_dlg", [], "Tsar Alexei Mikhailovich placed a high bounty on the head of the new impostor. Word has it that he is the grandson of the impostor Grishka Otrepyev.", "oim_dmitriy_razin_init_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_razin_init_dlg_1", [], "Dmitry was the true son of Ivan the Terrible. As for that lad -- God knows who he truly is.", "oim_dmitriy_razin_init_dlg_2", []],			
	[anyone,"oim_dmitriy_razin_init_dlg_2", [], "Perhaps you have heard? Ataman Stepan Razin claims a right to the throne as well.", "lord_pretalk", [
		(call_script, "script_end_quest", "qst_oim_dmitriy_tsar_prison"),
		#qst_oim_dmitriy_razin
		(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_giver_troop, "trp_player"),  
		(str_store_troop_name_link, s11, "trp_kingdom_2_pretender"),
		(setup_quest_text, "qst_oim_dmitriy_razin"),	
		(str_store_string, s2, "@OiM The Nu chto zhe teper bez podderzhki moguschestvennogo pokrovitelya delat mne nechego... Pora idti k {s11}"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_razin", "trp_player"),	
	]],				
	
	#oim_dmitriy_king_talk
	#(assign, "$talk_context", tc_court_talk),
	[anyone,"oim_dmitriy_king_talk", [(eq, "$talk_context", tc_court_talk),], "You dare to come into my halls in person! Guards, to arms!", "close_window", [
		(str_store_string, s2, "str_oim_generik_death_qst"),
		(jump_to_menu, "mnu_oim_last_game_menu"),
		(finish_mission),
	]],				
	[anyone,"oim_dmitriy_king_talk", [], "You are still quite the fool! Well then, your death shall be as swift as that of Grishka Otrepyev...", "close_window", [
		(assign, "$cant_leave_encounter", 1),  
		(encounter_attack), 
	]],				
	
	#oim_dmitriy_talk_razin_first
	[anyone,"oim_dmitriy_talk_razin_first", [], "I have good cause to seek you. All the villages are full of rumors about the rightful heir of the house of Rurik -- the great-grandchild of Ivan, and the grandson of his son, Dmitry.", "oim_dmitriy_talk_razin_first_1", []],				
	[anyone|plyr,"oim_dmitriy_talk_razin_first_1", [], "Well, what can I say...", "oim_dmitriy_talk_razin_first_2", []],			
	[anyone,"oim_dmitriy_talk_razin_first_2", [], "Whatever you may say, you cannot fool the people. For they are wise, and shall always know a true Tsar from an impostor.", "oim_dmitriy_talk_razin_first_3", []],				
	[anyone|plyr,"oim_dmitriy_talk_razin_first_3", [], "Is it truly important to you who I am?", "oim_dmitriy_talk_razin_first_4", []],			
	[anyone,"oim_dmitriy_talk_razin_first_4", [], "It is best that he be a good man, one whom the Boyar and the folk shall be eager to follow. So tell me, are you ready to join the uprising, Prince Dmitry?", "oim_dmitriy_talk_razin_first_5", []],				
	[anyone|plyr,"oim_dmitriy_talk_razin_first_5", [], "Agree...", "oim_dmitriy_talk_razin_first_5_pos", []],			
		[anyone|plyr,"oim_dmitriy_talk_razin_first_5_pos", [], "Very well, I'll risk it. Perhaps I may become Tsar after all! Spread the word, Ataman -- we march at dawn!", "oim_dmitriy_talk_razin_first_5_pos_1", []],			
		[anyone,"oim_dmitriy_talk_razin_first_5_pos_1", [], "Very well...", "close_window", [
			(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_current_state, 2),
			(assign, "$supported_pretender", "trp_kingdom_2_pretender"),
			(troop_set_slot, "$supported_pretender", slot_troop_cur_center, 0),
			(troop_set_auto_equip, "$supported_pretender",0),
			(str_store_troop_name_link, s6, "$supported_pretender"),
			(display_message, "@{s6} has joined your party."),
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 25),
			(party_force_add_members, "p_main_party", "$supported_pretender", 1),
		]],				
	[anyone|plyr,"oim_dmitriy_talk_razin_first_5", [], "Refuse...", "oim_dmitriy_talk_razin_first_5_neg", []],			
		[anyone|plyr,"oim_dmitriy_talk_razin_first_5_neg", [], "Your uprising shall leads straight to the gallows. They'll quarter us, friend, before we reach Tula. Let us wait until the time is right.", "close_window", [
			(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_current_state, 1),
		]],			
	
	
	#lord_join_rebellion_suggest
	[anyone,"oim_dmitriy_razin_sp_task", [
		(quest_slot_eq, "qst_oim_dmitriy_razin", slot_quest_current_state, 2),
		#(neg|check_quest_active, "qst_biyars_specnaz"), 
	], "Yes, we must make preparations. If we fail to draw the Boyars to our side, the cause is lost.", "oim_dmitriy_razin_boyars_task", []],				
	[anyone|plyr,"oim_dmitriy_razin_boyars_task", [], "Do you have any ideas?", "oim_dmitriy_razin_boyars_task_1", []],			
	[anyone,"oim_dmitriy_razin_boyars_task_1", [], "I knew a runaway serf who served in the house of the warlord Nikita Odoyevsky. He told me that often, noble Boyars would gather there and talk of sedition, calling the Romanovs a house of ill born upstarts.", "oim_dmitriy_razin_boyars_task_2", []],				
	[anyone|plyr,"oim_dmitriy_razin_boyars_task_2", [], "You propose we negotiate with Odoyevsky?", "oim_dmitriy_razin_boyars_task_3", []],			
	[anyone,"oim_dmitriy_razin_boyars_task_3", [], "Yes. Ride there and try to persuade him to join our cause.", "oim_dmitriy_razin_boyars_task_4", []],				
	[anyone|plyr,"oim_dmitriy_razin_boyars_task_4", [], "Good. I shall ride out at once.", "supported_pretender_pretalk", [
		(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_current_state, 3),
		(quest_set_slot, "qst_biyars_specnaz", slot_quest_current_state, 0),
		(quest_set_slot, "qst_biyars_specnaz", slot_quest_giver_troop, "$g_talk_troop"),  
		(setup_quest_text, "qst_biyars_specnaz"),	
		(str_store_troop_name_link, s11, "trp_knight_2_17"),
		(str_store_string, s2, "str_oim_dmitriy_specnaz_descr"),
		#(call_script, "script_end_quest", "qst_biyars_specnaz"),# "$g_talk_troop"),	
		(call_script, "script_start_quest", "qst_biyars_specnaz", "$g_talk_troop"),	
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			
	
	#oim_biyars_specnaz_init_dlg
	[anyone,"oim_biyars_specnaz_init_dlg", [], "Rebellious talk that is. Lighter conversation has found people in torture chambers. Were it not for the cross of Rurik on your chest, I would have sent you to the dungeon myself...", "oim_biyars_specnaz_init_dlg_1", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_1", [], "So you know who I am?", "oim_biyars_specnaz_init_dlg_2", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_2", [], "I know of all that transpires in the Tsardom of Moscow. If a mouse should sleep in the Tsar's bedchamber, I would have a report about it. I heard that the Tsar Alexei himself took you for a descendant of the house of Rurik, and placed you at the top of his list of wanted men.", "oim_biyars_specnaz_init_dlg_3", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_3", [], "I know many things as well. For one, I know that you, one of Tsar Alexei's most trusted allies, arrange secret Boyar gatherings, where you weave treasonous plots.", "oim_biyars_specnaz_init_dlg_4", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_4", [], "We, the Boyars of the noble Russian houses, installed the Romanovs as Tsars -- and we can just as easily remove them. Tsar Alexei has strengthened his grip, and thinks he shall live by his own mind. He offered his royal support to the heretic, Patriarch Nikon, which led to a schism in the Orthodox Church. What else he devises no one can say. This is why we Boyars gather secretly, our only concern the utmost good of the Motherland...", "oim_biyars_specnaz_init_dlg_5", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_5", [], "A rare occasion it is indeed, when the Boyars and the common people are one in their aspirations. I and Ataman Razin call you to stand against the Romanovs, and see a true Tsar sitting in the Kremlin.", "oim_biyars_specnaz_init_dlg_6", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_6", [], "With Razin's support, we certainly could drive the Romanovs from power. Their house is of bad blood, and if a direct descendant of Rurik should step forth, we would indeed support him. Yet for now I cannot act against the Tsar.", "oim_biyars_specnaz_init_dlg_7", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_7", [], "Why is this, Boyar?", "oim_biyars_specnaz_init_dlg_8", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_8", [], "I simply have no time for this now, {sir/madam}. My daughter, my darling Alevtina, was captured by the Tatars. While I was of town with my troops, they came here on a raid, and took her from the tower. If Alevtina should die in Tatar bondage, my soul would know no rest. Seeing her free is my first and only task.", "oim_biyars_specnaz_init_dlg_9", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_9", [], "I feel for your loss, but how does this misery bar you from taking a stand against Alexei?", "oim_biyars_specnaz_init_dlg_10", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_10", [], "The Tsar of Moscow promised to send an embassy to Crimea and plead for Alevtina's return. And if he should do this for me, I would serve him hand and foot.", "oim_biyars_specnaz_init_dlg_11", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_11", [], "And what if I release Alevtina from bondage?", "oim_biyars_specnaz_init_dlg_12", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_12", [], "Hear my words. If you bring Alevtina back home, I shall side with your righteous cause, and bring many other Boyars with me.", "oim_biyars_specnaz_init_dlg_13", []],				
	[anyone|plyr,"oim_biyars_specnaz_init_dlg_13", [], "And where shall I look for her? Perhaps you can offer some advice?", "oim_biyars_specnaz_init_dlg_14", []],			
	[anyone,"oim_biyars_specnaz_init_dlg_14", [], "The main slave marketplace is in Kafa. Ride there and try to find out about her.", "close_window", [
		(assign, "$g_leave_encounter", 1), 
		#qst_oim_alevtina_hanum
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_giver_troop, "$g_talk_troop"),  
		(setup_quest_text, "qst_oim_alevtina_hanum"),	
		(str_store_string, s2, "@OiM Alevtina v Kafe v plenu..."),
		(call_script, "script_start_quest", "qst_oim_alevtina_hanum", "$g_talk_troop"),	
	]],				
	
	#oim_dmitriy_nikita_auto_responce
	[anyone,"oim_dmitriy_nikita_auto_responce", [], "I see Alevtina is not with you, so waste not my time...", "close_window", [
		(assign, "$g_leave_encounter", 1), 
	]],					
	
	
	#oim_dmitriy_ransom_brok_dlg
	[anyone,"oim_dmitriy_ransom_brok_dlg", [], "I hear little, ya. The esir were brought from Rus, there was that girlie, much beauty, but much naughty.", "oim_dmitriy_ransom_brok_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_ransom_brok_dlg_1", [], "And where is this ""much naughty girle"" now?", "oim_dmitriy_ransom_brok_dlg_2", []],			
	[anyone,"oim_dmitriy_ransom_brok_dlg_2", [], "I hear very bad, ya. Not know Russian, no words...", "oim_dmitriy_ransom_brok_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_ransom_brok_dlg_3", [], "I feel your pain. All right, how many coins to cure your deaf ears?", "oim_dmitriy_ransom_brok_dlg_4", []],			
	[anyone,"oim_dmitriy_ransom_brok_dlg_4", [], "Not a very much, ya. Just 3000 thaler.", "oim_dmitriy_ransom_brok_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_ransom_brok_dlg_5", [
		(store_troop_gold, ":gold", "trp_player"), 
		(ge, ":gold", 3000), 
	], "All right, take the money and speak...", "oim_dmitriy_ransom_brok_dlg_6", [
		(troop_remove_gold, "trp_player", 3000),
	]],			
	[anyone,"oim_dmitriy_ransom_brok_dlg_6", [
		(call_script, "script_cf_get_random_lord_except_king_with_faction", "fac_kingdom_3"), 
		(assign, ":lord", reg0), 
		(try_begin),
			(this_or_next|lt, ":lord", kingdom_heroes_begin), 
			(gt, ":lord", kingdom_heroes_end), 
			(assign, ":lord", "trp_knight_3_5"), 
		(try_end), 
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_target_troop, ":lord"),
		(call_script, "script_cf_select_random_town_with_faction", "fac_kingdom_3"), 
		(assign, ":town", reg0), 
		(try_begin),
			(this_or_next|lt, ":town", towns_begin), 
			(gt, ":town", towns_end), 
			(assign, ":town", "p_town_17"), 
		(try_end), 
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_target_center, ":town"),
		(str_store_troop_name_link, s2, ":lord"), 
		(str_store_party_name_link, s3, ":town"), 
	], "Hear me, {sir/madam} - the Boyar girl Alevtina was a slave, in Kafa. She be sold, I thinks, sold to {s2}. She go with him to {s3}.", "ransom_broker_pretalk", [
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_current_state, 1),
		(str_store_string, s4, "str_hanum_notes_from_slave_trader"),  
		(add_quest_note_from_sreg, "qst_oim_alevtina_hanum", 4, s4, 1),
	]],				
	
	[anyone|plyr,"oim_dmitriy_ransom_brok_dlg_5", [], "I shall return later...", "ransom_broker_pretalk", []],			

	
	#oim_dmitriy_aletina_hanum_murza_dlg
	[anyone,"oim_dmitriy_aletina_hanum_murza_dlg", [], "In Allah's Holy Name! That girl cost me too much. For that money one could build another palace! And now she is no longer my concubine, but my wife. A beloved wife. There can be no talk of giving her back.", "oim_dmitriy_aletina_hanum_murza_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_1", [], "And what if I pay you?", "oim_dmitriy_aletina_hanum_murza_dlg_2", []],			
		[anyone,"oim_dmitriy_aletina_hanum_murza_dlg_2", [], "Well, if you pay a hundred thousand, I may think it over.", "oim_dmitriy_aletina_hanum_murza_dlg_3", []],				
		[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [], "I have no such amount.", "lord_pretalk", []],			
		[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [
			(store_troop_gold, ":gold", "trp_player"), 
			(ge, ":gold", 100000), 
		], "Here it is, take it.", "lord_pretalk", [
			(troop_remove_gold, "trp_player", 100000), 
			(call_script, "script_succeed_quest", "qst_oim_alevtina_hanum"), 
			(party_force_add_members, "p_main_party", "trp_alevtina", 1),
		]],			
		[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [], "Well, perhaps we shall find another way.", "lord_pretalk", []],			
	[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [(eq, 0, 1),], "Prepare to defend yourself!", "close_window", [
		(call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", -100),
		(assign, "$cant_leave_encounter", 1),
		(encounter_attack),
	]],			
	[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [], "Well, if you don't want to do it the easy way, we shall do it the hard way.", "oim_dmitriy_aletina_hanum_murza_dlg_castle", []],			
		[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_castle", [], "I'll take the lady, and your town as well!", "close_window", [
			(call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", -100),
			(jump_to_menu, "mnu_auto_return_to_map"), 
			(assign, "$g_leave_encounter", 1), 
		]],			
	[anyone|plyr,"oim_dmitriy_aletina_hanum_murza_dlg_3", [], "Well, no is no.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_alevtina_hanum", slot_quest_current_state, 2),
		(str_store_string, s5, "@OiM pohozhe alevtinu nuzhnu budet zabirat iz garema siloy..."),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_gerasim", 4, s5, 1),
	]],			
	
	
	#oim_dmitriy_alevtina_guard_dlg
	[anyone,"oim_dmitriy_alevtina_guard_dlg", [], "Stop! Who is it?", "oim_dmitriy_alevtina_guard_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_alevtina_guard_dlg_1", [], "The new doctor. I have come to see the wives of the Mirza at his behest.", "oim_dmitriy_alevtina_guard_dlg_2", []],			
	[anyone,"oim_dmitriy_alevtina_guard_dlg_2", [], "I have not seen you before, eh?", "oim_dmitriy_alevtina_guard_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_alevtina_guard_dlg_3", [], "I just arrived the other day.", "oim_dmitriy_alevtina_guard_dlg_4", []],			
	[anyone,"oim_dmitriy_alevtina_guard_dlg_4", [
		(store_skill_level, ":persuasion", "skl_persuasion", "trp_player"),
		(ge, ":persuasion", 3),
	], "All right, go in.", "close_window", [
		(assign, "$g_battle_result", 1), 
		(jump_to_menu, "mnu_oim_dmitriy_alevtina_hanum"),
		(finish_mission),
	]],				
	[anyone,"oim_dmitriy_alevtina_guard_dlg_4", [], "Doctor or not -- I care not. There is but one rule for everyone -- only eunuchs are allowed into the harem. Prove that you are a eunuch, and then you can go in.", "oim_dmitriy_alevtina_guard_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_alevtina_guard_dlg_5", [], "I'll make a eunuch out of you!", "oim_dmitriy_alevtina_guard_dlg_6", []],			
	[anyone,"oim_dmitriy_alevtina_guard_dlg_6", [], "Alarm! Assault!", "close_window", [
		(call_script, "script_cf_set_agent_mode_hostile"), 
		(mission_disable_talk),
		(jump_to_menu, "mnu_oim_dmitriy_alevtina_hanum"),
		#(finish_mission),
	]],				
	
	#oim_dmitriy_alevtina_garem_dlg
	[anyone|plyr,"oim_dmitriy_alevtina_garem_dlg", [], "So we meet again, Boyarina.", "oim_dmitriy_alevtina_garem_dlg_1", []],			
	[anyone,"oim_dmitriy_alevtina_garem_dlg_1", [], "I am no Boyarina. I am the beloved wife of the Mirza, Alevtina-hanum.", "oim_dmitriy_alevtina_garem_dlg_2", []],				
	[anyone|plyr,"oim_dmitriy_alevtina_garem_dlg_2", [], "All right, stop pretending. Gather belongings, you're coming with me. Your father awaits you.", "oim_dmitriy_alevtina_garem_dlg_3", []],			
	[anyone,"oim_dmitriy_alevtina_garem_dlg_3", [], "Go home? Sit in a room with a spindle, look out the window and freeze in the winters, when snowdrifts grow as tall as men? No way. Here I have my halls, my servants, luxurious dresses and jewelry. The Mirza loves me...", "oim_dmitriy_alevtina_garem_dlg_4", []],				
	[anyone|plyr,"oim_dmitriy_alevtina_garem_dlg_4", [], "Argue any more and you'll be going home wrapped in this carpet. Pack your things now!", "close_window", [
		(call_script, "script_succeed_quest", "qst_oim_alevtina_hanum"),
		(party_force_add_members, "p_main_party", "trp_alevtina", 1),
		(jump_to_menu, "mnu_auto_return_to_map"),		
		(finish_mission),
	 ]],			
	 
	#oim_alevtina_delivered_dlg	
	[anyone|plyr,"oim_alevtina_delivered_dlg", [], "Rejoice, Boyar, for your daughter has returned safely to her rooms. But make no haste to visit her -- she is tired after a long road. And we have a bargain to keep.", "oim_alevtina_delivered_dlg_1", []],			
	[anyone,"oim_alevtina_delivered_dlg_1", [], "Oh how joyous! Housekeeper, bring the vodka, we shall celebrate with a feast! The Lord had mercy on me, and brought my one and only daughter home once more.", "oim_alevtina_delivered_dlg_2", []],				
	[anyone|plyr,"oim_alevtina_delivered_dlg_2", [], "Hmm... A feast is always good. But the matter of our agreement brooks no delay. Will you fulfill your promise?", "oim_alevtina_delivered_dlg_3", []],			
	[anyone,"oim_alevtina_delivered_dlg_3", [], "How can I not? Now that Alevtina is back home, and I owe the Tsar nothing. We shall give merry hell to those Romanov tricksters. I am at your command, as is my army -- and here, take this deed as well. It shall help you draw other Boyars to your cause.", "lord_pretalk", [
		(remove_member_from_party, "trp_alevtina", "p_main_party"), 
		(assign, "$supported_pretender", "trp_kingdom_2_pretender"),
		(call_script, "script_end_quest", "qst_oim_alevtina_hanum"),
		(call_script, "script_end_quest", "qst_biyars_specnaz"),
		(assign, "$oim_dmitriy_can_recruit", 1), 
        (troop_set_slot, "$supported_pretender", slot_troop_discussed_rebellion, 1),
        (call_script, "script_change_troop_faction", "$supported_pretender", "fac_player_supporters_faction"),
		#moved code
			(troop_set_slot, "$supported_pretender", slot_troop_discussed_rebellion, 1),
			(assign, "$players_kingdom", "fac_player_supporters_faction"),
			(try_begin),
				#(is_between, "$g_talk_troop", pretenders_begin, pretenders_end),
				#(assign, "$supported_pretender", "$g_talk_troop"),
				(troop_get_slot, "$supported_pretender_old_faction", "$supported_pretender", slot_troop_original_faction),
				(troop_set_faction, "$supported_pretender", "fac_player_supporters_faction"),
				
				(faction_set_slot, "fac_player_supporters_faction", slot_faction_leader, "$supported_pretender"),
				(assign, "$g_talk_troop_faction", "fac_player_supporters_faction"),
				(quest_set_slot, "qst_rebel_against_kingdom", slot_quest_giver_troop, "$supported_pretender"),
				(quest_set_slot, "qst_rebel_against_kingdom", slot_quest_target_faction, "$supported_pretender_old_faction"),
				(str_store_faction_name_link, s14, "$supported_pretender_old_faction"),
				(str_store_troop_name_link, s13, "$supported_pretender"),
				(setup_quest_text,"qst_rebel_against_kingdom"),
				(str_store_string, s2, "@You promised to help {s13} claim the throne of {s14}."),
				(call_script, "script_start_quest", "qst_rebel_against_kingdom", "$supported_pretender"),
			(try_end),
			(try_begin),
				(is_between, "$players_oath_renounced_against_kingdom", kingdoms_begin, kingdoms_end),
				(neq, "$players_oath_renounced_against_kingdom", "$g_talk_troop_faction"),
				(store_relation, ":relation", "fac_player_supporters_faction", "$players_oath_renounced_against_kingdom"),
				(val_min, ":relation", -40),
				(call_script, "script_set_player_relation_with_faction", "$players_oath_renounced_against_kingdom", ":relation"),
				(call_script, "script_update_all_notes"),
				(assign, "$g_recalculate_ais", 1),
			(try_end),
			(try_begin),
				(is_between, "$players_kingdom", kingdoms_begin, kingdoms_end),
				(neq, "$players_kingdom", "fac_player_supporters_faction"),
				(faction_get_slot, ":old_leader", "$players_kingdom", slot_faction_leader),
				(call_script, "script_add_log_entry", logent_renounced_allegiance,   "trp_player",  -1, ":old_leader", "$players_kingdom"),
				(call_script, "script_player_leave_faction", 1),
			(try_end),
			(call_script, "script_player_join_faction", "$g_talk_troop_faction"),
			(try_begin),
				(gt, "$g_invite_offered_center", 0),
				(call_script, "script_give_center_to_lord", "$g_invite_offered_center", "trp_player", 0),
				(call_script, "script_add_log_entry", logent_fief_granted_village, "trp_player",  "$g_invite_offered_center", "$supported_pretender", "$g_talk_troop_faction"),
			(try_end),
			(call_script, "script_add_log_entry", logent_pledged_allegiance,   "trp_player",  -1, "$supported_pretender", "$g_talk_troop_faction"),
			(try_begin),
				(check_quest_active, "qst_join_faction"),
				(eq, "$g_invite_faction_lord", "$supported_pretender"),
				(call_script, "script_end_quest", "qst_join_faction"),
			(else_try),
				(check_quest_active, "qst_join_faction"),
				(call_script, "script_abort_quest", "qst_join_faction", 0),
			(try_end),
			(assign, "$player_has_homage" ,1),
			(assign, "$g_player_banner_granted", 1),
			(assign, "$g_invite_faction", 0),
			(assign, "$g_invite_faction_lord", 0),
			(assign, "$g_invite_offered_center", 0),
			(assign, "$g_leave_encounter",1),
			(faction_set_slot, "$g_talk_troop_faction", slot_faction_state, sfs_active),
			(assign, "$player_made_legitimacy_claim", 0),
			(assign, "$player_made_benefit_claim", 0),
			(assign, "$player_made_strength_claim", 0),
			(assign, "$player_made_benefit_claim", 0),
			(store_relation, ":reln", "$supported_pretender_old_faction", "fac_player_supporters_faction"),
			(val_min, ":reln", -50),
			(call_script, "script_set_player_relation_with_faction", "$supported_pretender_old_faction", ":reln"),
			(str_store_faction_name, s1, "$supported_pretender_old_faction"),
			(faction_set_name, "fac_player_supporters_faction", "@{s1} Rebels"),
			(faction_set_color, "fac_player_supporters_faction", 0xFF0000),
            #(call_script, "script_create_kingdom_hero_party", "$g_talk_troop", "p_main_party"),
            #(party_set_slot, "$pout_party", slot_party_commander_party, "p_main_party"),
            #(call_script, "script_party_decide_next_ai_state_under_command", "$pout_party"),
            #(store_current_hours, ":follow_until_time"),
            #(store_add, ":follow_period", 60, "$g_talk_troop_relation"),
            #(val_div, ":follow_period", 2),
            #(val_add, ":follow_until_time", ":follow_period"),
            #(party_set_slot, "$pout_party", slot_party_follow_player_until_time, ":follow_until_time"),
            #(party_set_slot, "$pout_party", slot_party_following_player, 1),
			#(quest_set_slot, "qst_oim_dmitriy_razin", slot_quest_current_state, 2),
			(str_store_string, s5, "@OiM_getman Pohozhe bunt razina budet seryoznim..."),	
			(add_quest_note_from_sreg, "qst_oim_dmitriy_razin", 4, s5, 1),
			(call_script, "script_give_center_to_lord", "p_town_11", "trp_kingdom_2_pretender", 0),
			(call_script, "script_give_center_to_faction", "p_town_11", "fac_player_supporters_faction"),  
			(call_script, "script_remove_lords_from_center", "p_town_11"), 
			(call_script, "script_change_troop_faction", "trp_knight_2_7", "fac_player_supporters_faction"),
			(call_script, "script_change_troop_faction", "$g_talk_troop", "fac_player_supporters_faction"),
			#(troop_set_slot, "$supported_pretender", slot_troop_occupation, slto_kingdom_hero),
            (assign, "$g_recalculate_ais", 1),
            (call_script, "script_update_all_notes"),		
	]],				
	
	#lord_join_rebellion_suggest 
	#oim_dmitriy_rebelion_suggest_letter
	[anyone,"oim_dmitriy_rebelion_suggest_letter", [], "The noble here claims you're the grandson of Dmitry himself...", "lord_pretalk", [
        (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
        (call_script, "script_change_troop_faction", "$g_talk_troop", "fac_player_supporters_faction"),
        (troop_get_slot, ":lords_party", "$g_talk_troop", slot_troop_leaded_party),
        (party_set_faction, ":lords_party", "fac_player_supporters_faction"),
        (assign, "$g_leave_encounter", 1),
	]],				 	 
	 
	#oim_dmitriy_sarin_na_kichku_dlg
	#supported_pretender_pretalk
	[anyone,"oim_dmitriy_sarin_na_kichku_dlg", [], "Congratulations, {playername}. The rebellion spreads, with more Boyars joining it each day. But there is one question on everyone's tongue. When we bring down Alexei the Quiet, who shall be the next Tsar?", "oim_dmitriy_sarin_na_kichku_dlg_1", []],				
	[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_1", [], "It is too early to think on such things. Razin shall be provisional commander, and then we shall gather the national council.", "oim_dmitriy_sarin_na_kichku_dlg_2", []],			
	[anyone,"oim_dmitriy_sarin_na_kichku_dlg_2", [], "Razin? Our ancestors shall turn in their graves if that fugitive bandit spends but one day in the Faceted Halls. Know this -- if you should accept the Ataman as regent, the Boyars shall no longer follow you.", "oim_dmitriy_sarin_na_kichku_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_3", [], "And what do you propose?", "oim_dmitriy_sarin_na_kichku_dlg_4", []],			
	[anyone,"oim_dmitriy_sarin_na_kichku_dlg_4", [], "As if you do not see it yourself! Why would we put a Cossack Ataman at the helm of our nation, or gather puppets for needless jabber, when we have the rightful heir to the throne amongst us.", "oim_dmitriy_sarin_na_kichku_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_5", [], "You speak of me?", "oim_dmitriy_sarin_na_kichku_dlg_6", []],			
	[anyone,"oim_dmitriy_sarin_na_kichku_dlg_6", [], "Who else? The great-grandson of Ivan the Terrible, grandson of the slain Dmitry! One could not imagine better candidate for the throne.", "oim_dmitriy_sarin_na_kichku_dlg_7", []],				
	[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_7", [], "Indeed. Am I not the Prince, after all?", "oim_dmitriy_sarin_na_kichku_dlg_pos", []],			
		[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_pos", [], "Go forth, Boyar, and proclaim to all that Prince Dmitry has agreed to lead the great army that shall banish the Romanov dogs and restore rightful rule.", "close_window", [
			(assign, "$player_honor", -10),
			(display_message, "@You lose honour."),
			#qst_oim_black_lord
			(quest_set_slot, "qst_oim_black_lord", slot_quest_current_state, 0),
			(quest_set_slot, "qst_oim_black_lord", slot_quest_giver_troop, "$g_talk_troop"),  
			(setup_quest_text, "qst_oim_black_lord"),	
			(str_store_string, s2, "str_oim_black_lord"),
			(call_script, "script_start_quest", "qst_oim_black_lord", "$g_talk_troop"),	
			(assign, "$g_leave_encounter", 1),
		]],			
	[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_7", [], "Nay. Russia has had enough imposters.", "oim_dmitriy_sarin_na_kichku_dlg_neg", []],			
		[anyone|plyr,"oim_dmitriy_sarin_na_kichku_dlg_neg", [], "You yourself know I am Prince Dmitry no more than you are a Prince of the British Crown. Let Razin lead the rebellion, and let the people decide everything once victory is at hand.", "close_window", [
			(call_script, "script_change_player_honor", 10),
			(assign, "$g_leave_encounter", 1),
		]],			
	
	
	#oim_dmitriy_rebelion_suggest_samozvanec
	[anyone,"oim_dmitriy_rebelion_suggest_samozvanec", [], "Greetings, Your Majesty Dmitry Ivanovich. I swear to fight for you even unto my last drop of blood.", "close_window", [
        (troop_set_slot, "$g_talk_troop", slot_troop_discussed_rebellion, 1),
        (call_script, "script_change_troop_faction", "$g_talk_troop", "$players_kingdom"),
        (troop_get_slot, ":lords_party", "$g_talk_troop", slot_troop_leaded_party),
        (party_set_faction, ":lords_party", "$players_kingdom"),
        (assign, "$g_leave_encounter", 1),
	]],				 	 	
	
	#oim_dmitriy_razin_ending_dlg
	#for black_lord ending
	[anyone,"oim_dmitriy_razin_ending_dlg", [], "Allow me to speak, and take not my life, Your Majesty Tsar!", "oim_dmitriy_razin_ending_dlg_1", [
		(quest_set_slot, "qst_oim_black_lord", slot_quest_current_state, 1),
		(store_current_day, ":cur_day"),
		(quest_set_slot, "qst_oim_black_lord", slot_quest_start_time, ":cur_day"),
		#
		(call_script, "script_end_quest", "qst_oim_dmitriy_razin"),
	]],				
	[anyone|plyr,"oim_dmitriy_razin_ending_dlg_1", [], "Ataman, you have my attention. Speak your mind.", "oim_dmitriy_razin_ending_dlg_2", []],			
	[anyone,"oim_dmitriy_razin_ending_dlg_2", [], "I beg you, Your Majesty. Alexei has been routed, and rightful power is restored and once more shared between all. The noble Boyars have recovered their estates and titles. But what of me? Shall I return to the Don to be a mere Ataman?", "oim_dmitriy_razin_ending_dlg_3", []],				
	[anyone|plyr,"oim_dmitriy_razin_ending_dlg_3", [], "And what is it that you desire, Stepan?", "oim_dmitriy_razin_ending_dlg_4", []],			
	[anyone,"oim_dmitriy_razin_ending_dlg_4", [], "Nothing that I have not earned. Give me the rank of warlord, and command over the Boyar Council.", "oim_dmitriy_razin_ending_dlg_5", []],				
	[anyone|plyr,"oim_dmitriy_razin_ending_dlg_5", [], "It is a very ambitious request...", "oim_dmitriy_razin_ending_dlg_6", []],			
	[anyone,"oim_dmitriy_razin_ending_dlg_6", [], "Forget not that I know who you truly are. Thus my plea is modest. Should I instead cry out ""impostor"", and see your corpse be dragged from the Kremlin in parts, like the first Dmitry?", "oim_dmitriy_razin_ending_dlg_7", []],				
	[anyone|plyr,"oim_dmitriy_razin_ending_dlg_7", [], "I fear not your threats, Stepan. But you are worthy of the post. So be it.", "lord_pretalk", [
		(quest_set_slot, "qst_oim_black_lord", slot_quest_current_state, 2),		
		(assign, "$g_battle_result", 1),
		(finish_mission),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end), 
			(troop_set_slot, ":troop_no", slot_troop_support_hero, 0),
		(end_try), 
		#razin rebbelion code
		(assign, "$g_razin_rebellion", 1), 
		(store_current_day, "$g_razin_time_offset"),
		(troop_set_slot, "trp_kingdom_2_pretender", slot_troop_occupation, slto_kingdom_hero),
		(val_add, "$g_razin_time_offset", 7), 
	]],			
	[anyone|plyr,"oim_dmitriy_razin_ending_dlg_7", [], "Guards! Seize this traitor! To the dungeon with him!", "oim_dmitriy_razin_ending_dlg_neg", []],			
	[anyone,"oim_dmitriy_razin_ending_dlg_neg", [], "So this is how you reward your allies? Hey Cossacks, hear me. The Tsar is a fake!", "close_window", [
		(call_script, "script_cf_set_agent_mode_hostile"), 
		(quest_set_slot, "qst_oim_black_lord", slot_quest_current_state, 2),		
	]],				
	
	
	#oim_dmitriy_razin_rebel_end
	#generik ending
	[anyone,"oim_dmitriy_razin_rebel_end", [], "We have won. We have thrown off the yoke of the invaders. Now it falls to us to decide who shall be the new Tsar.", "oim_dmitriy_razin_rebel_end_1", []],				
	[anyone|plyr,"oim_dmitriy_razin_rebel_end_1", [], "And how should we elect him?", "oim_dmitriy_razin_rebel_end_2", []],			
	[anyone,"oim_dmitriy_razin_rebel_end_2", [], "That is for the Boyar Council to decide. Soon the lower Boyar congregation shall gather to discuss those who are worthy.", "oim_dmitriy_razin_rebel_end_3", []],				
	[anyone|plyr,"oim_dmitriy_razin_rebel_end_3", [], "And what if I wish to be Tsar?", "oim_dmitriy_razin_rebel_end_4", []],			
	[anyone,"oim_dmitriy_razin_rebel_end_4", [], "Well, you have every right. Speak with the Boyars, and try drawing them to your side.", "close_window", [
		(call_script, "script_end_quest", "qst_rebel_against_kingdom"),
		(call_script, "script_end_quest", "qst_oim_dmitriy_razin"),
		#qst_oim_dmitriy_elections
		(quest_set_slot, "qst_oim_dmitriy_elections", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_dmitriy_elections", slot_quest_giver_troop, "$g_talk_troop"),  
		(quest_set_slot, "qst_oim_dmitriy_elections", slot_quest_expiration_days, 21),  
		(setup_quest_text, "qst_oim_dmitriy_elections"),	
		(str_store_string, s2, "@OiM Teper kogda ya pretendent na prestol nuzhno"),
		(call_script, "script_start_quest", "qst_oim_dmitriy_elections", "$g_talk_troop"),	
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end), 
			(troop_set_slot, ":troop_no", slot_troop_support_hero, 0),
		(end_try), 
	]],				
	
	#oim_dmitriy_tsar_elections
	[anyone,"oim_dmitriy_tsar_elections", [], "Yes, {playername}.", "oim_dmitriy_tsar_elections_1", []],				
	[anyone|plyr,"oim_dmitriy_tsar_elections_1", [], "I am the great-grandson of Ivan the Terrible of the house of Rurik. The throne is mine by right.", "oim_dmitriy_tsar_elections_resp", [
		(assign, "$temp", 1), 
	]],			
	[anyone|plyr,"oim_dmitriy_tsar_elections_1", [], "Support me on the council and I shall bestow upon you a new estate.", "oim_dmitriy_tsar_elections_resp", [
		(assign, "$temp", 2), 	
	]],			
	[anyone|plyr,"oim_dmitriy_tsar_elections_1", [], "You know I am a man of honor. I shall be a just Tsar.", "oim_dmitriy_tsar_elections_resp", [
		(assign, "$temp", 3), 	
	]],			
	[anyone,"oim_dmitriy_tsar_elections_resp", [
		(assign, ":test_result", 0), 
		(troop_get_slot, ":player_renown", "trp_player", slot_troop_renown),
		(val_mul, ":player_renown", 80), 
		(val_div, ":player_renown", 100),
		(try_begin), 
			(eq, "$temp", 1), 
			(is_between, "$g_talk_troop", "trp_knight_2_1", "trp_knight_2_4"),
			(assign, ":test_result", 1), 
		(else_try), 
			(eq, "$temp", 2), 
			(is_between, "$g_talk_troop", "trp_knight_2_4", "trp_knight_2_12"),
			(troop_get_slot, ":renown", "$g_talk_troop", slot_troop_renown),
			(ge, ":player_renown", ":renown"),
			(assign, ":test_result", 1), 
		(else_try), 
			(ge, "$player_honor", 12), 
			(assign, ":test_result", 1), 
		(end_try),
		(call_script, "script_troop_get_player_relation", "$g_talk_troop"),
		(assign, ":lord_relation", reg0), 
		(this_or_next|eq, ":test_result", 1), 
		(this_or_next|eq, debug_mode, 1), 
		(this_or_next|ge, ":lord_relation", 20), 
		(             ge, "$player_honor", 12), 
	], "I believe you and shall vote for you on the council.", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1),		
		(str_clear, s4), 
		(str_clear, s5), 
		(assign, ":count", 0),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0),
				(str_store_string, s4, "@{s2}"),
			(else_try), 	
				(str_store_string, s4, "@{s4}, {s2}"),
			(end_try),	
			(val_add, ":count", 1),
		(end_try), 
		(try_begin), 
			(ge, ":count", 1),
			(str_store_string, s4, "@{s4}."),
		(end_try), 
		(assign, ":count", 0),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 2), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0),
				(str_store_string, s5, "@{s2}"),
			(else_try), 	
				(str_store_string, s5, "@{s5}, {s2}"),
			(end_try),	
			(val_add, ":count", 1),			
		(end_try), 
		(try_begin), 
			(ge, ":count", 1),
			(str_store_string, s5, "@{s5}."),
		(end_try), 
		(str_store_string, s6, "str_oim_potop_support_list"),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_elections", 4, s6, 1),		
	]],				
	[anyone,"oim_dmitriy_tsar_elections_resp", [], "Your arguments are somehow lacking...", "lord_pretalk", [
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 2),		
		(str_clear, s4), 
		(str_clear, s5), 
		(assign, ":count", 0),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 1), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0),
				(str_store_string, s4, "@{s2}"),
			(else_try), 	
				(str_store_string, s4, "@{s4}, {s2}"),
			(end_try),	
			(val_add, ":count", 1),
		(end_try), 
		(try_begin), 
			(ge, ":count", 1),
			(str_store_string, s4, "@{s4}."),
		(end_try), 
		(assign, ":count", 0),
		(try_for_range, ":troop_no", kingdom_heroes_begin, kingdom_heroes_end),
			(troop_slot_eq, ":troop_no", slot_troop_support_hero, 2), 
			(str_store_troop_name_link, s2, ":troop_no"), 
			(try_begin), 
				(eq, ":count", 0),
				(str_store_string, s5, "@{s2}"),
			(else_try), 	
				(str_store_string, s5, "@{s5}, {s2}"),
			(end_try),	
			(val_add, ":count", 1),			
		(end_try), 
		(try_begin), 
			(ge, ":count", 1),
			(str_store_string, s5, "@{s5}."),
		(end_try), 
		(str_store_string, s6, "str_oim_potop_support_list"),	
		(add_quest_note_from_sreg, "qst_oim_dmitriy_elections", 4, s6, 1),		
	]],				
	
	#oim_dmitriy_razin_captured
	[anyone|plyr,"oim_dmitriy_razin_captured", [], "Well, Stepan, have you calmed down at last? Or you do you still wish to so weaken Mother Russia that her foes may tear her to pieces?", "oim_dmitriy_razin_captured_1", []],			
	[anyone,"oim_dmitriy_razin_captured_1", [], "There shall not be another tyrant in the Rus. So long as my hand is strong enough to grasp the blade, I shall fight for Rus to be a free Cossack nation.", "oim_dmitriy_razin_captured_2", []],				
	[anyone|plyr,"oim_dmitriy_razin_captured_2", [], "The nation needs no bandit freeman, but a steadfast, trusted rule. He who goes against this is a true foe of Russia.", "oim_dmitriy_razin_captured_3", []],			
	[anyone|auto_proceed,"oim_dmitriy_razin_captured_3", [], "{!}NOT SHOWN", "oim_dmitriy_razin_captured_4", []],				
	[anyone|plyr,"oim_dmitriy_razin_captured_4", [(eq, 1, 0),], "Let Razin free.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_razin_captured_4", [(eq, 1, 0),], "Keep Razin in jail.", "close_window", []],			
	[anyone|plyr,"oim_dmitriy_razin_captured_4", [], "Execute him for treason.", "close_window", [
		#code
		(assign, "$g_razin_rebellion", 0), 
		(try_for_range, ":lord_no", kingdom_heroes_begin, kingdom_heroes_end),
			(store_troop_faction, ":faction", ":lord_no"), 
			(eq, ":faction", "fac_oim_rebel_faction"), 
			(call_script, "script_change_troop_faction", ":lord_no", "fac_kingdom_2"),
		(end_try), 
		(call_script, "script_remove_troop_from_prison", "$g_talk_troop"),
		(call_script, "script_oim_remove_lord", "trp_kingdom_2_pretender", "fac_kingdom_2"),		
		(faction_set_slot, "fac_oim_rebel_faction", slot_faction_state, sfs_inactive),
		(assign, "$g_recalculate_ais", 1),
		(call_script, "script_update_all_notes"),
		#(str_store_string, s2, "str_oim_razin_executed"),
		#(jump_to_menu, "mnu_simle_text_message"), 
		(call_script, "script_add_notification_menu", "mnu_notification_simple_str", "str_oim_razin_executed", -1),
	]],			
	
	#oim_dmitriy_voevoda_talk
	[anyone,"oim_dmitriy_voevoda_talk", [
		(str_clear, s2), 
		(assign, ":count", 0), 
		(try_for_range, ":cur_kingdom", kingdoms_begin, kingdoms_end),
			(faction_slot_eq, ":cur_kingdom", slot_faction_state, sfs_active),
			(neq, ":cur_kingdom", "fac_player_supporters_faction"),
			(str_store_faction_name, s3, ":cur_kingdom"),
			(val_add, ":count", 1), 
			(try_begin), 
				(eq,  ":count", 1), 
				(str_store_string, s2, "@{s3}"),
			(else_try), 
				(str_store_string, s2, "@{s2}, {s3}"),
			(end_try), 
		(end_try), 	
	], "Your Majesty! Of the foes among our neighbors, only {s2} remains unconquered.", "oim_dmitriy_voevoda_talk_1", []],				
	[anyone|plyr,"oim_dmitriy_voevoda_talk_1", [], "Whom would you say we should assault first?", "oim_dmitriy_voevoda_talk_2", []],			
	[anyone,"oim_dmitriy_voevoda_talk_2", [
		(call_script, "script_cf_get_random_active_faction_except_player_faction_and_faction", "fac_kingdom_2"),
		(str_store_party_name, s2, reg0),
	], "My counsel is to send regiments against {s3}. We shall swiftly deal with them.", "lord_pretalk", []],				
	 
	#oim_dmitriy_vlastilin_dlg 
	[anyone|plyr,"oim_dmitriy_vlastilin_dlg", [], "Come over to my side while it is not too late, or I shall ravage your lands.", "oim_dmitriy_vlastilin_dlg_1", []],			
	[anyone,"oim_dmitriy_vlastilin_dlg_1", [], "That is a low act!", "oim_dmitriy_vlastilin_dlg_2", []],				
	[anyone|plyr,"oim_dmitriy_vlastilin_dlg_2", [], "Yet it is very effective.", "oim_dmitriy_vlastilin_dlg_3", []],			
	[anyone,"oim_dmitriy_vlastilin_dlg_3", [
		(troop_get_slot, ":player_renown", "trp_player", slot_troop_renown),
		(val_mul, ":player_renown", 80), 
		(val_div, ":player_renown", 100),
		(troop_get_slot, ":renown", "$g_talk_troop", slot_troop_renown),
        (call_script, "script_party_calculate_strength", "$g_encountered_party", 0),
        (assign, ":attacker_strength", reg0),
        (call_script, "script_party_calculate_strength", "p_main_party", 0),
        (assign, ":hero_strength", reg0),
		(val_mul, ":hero_strength", 70), 
		(val_div, ":hero_strength", 100), 
		(lt, ":player_renown", ":renown"),
		(lt, ":hero_strength", ":attacker_strength"), 
	], "Dreadful rumors circle around you... but I shall never serve an impostor!", "close_window", [
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1),
	]],				
	[anyone,"oim_dmitriy_vlastilin_dlg_3", [], "Very well, I swear allegiance to you, Sire.", "close_window", [
        (call_script, "script_change_troop_faction", "$g_talk_troop", "fac_kingdom_2"),
        (troop_get_slot, ":lords_party", "$g_talk_troop", slot_troop_leaded_party),
        (party_set_faction, ":lords_party", "fac_kingdom_2"),
		(troop_set_slot, "$g_talk_troop", slot_troop_support_hero, 1),
		(assign, "$g_leave_encounter", 1),
	]],				
	
	
	#kingdom_1",  "Rzeczpospolita Korony
	#kingdom_2",  "Moscow Tzardom",    0
	#kingdom_3",  "Crimea Khaganate", 0,
	#kingdom_4",  "Swedish Kingdom",    
	#kingdom_5",  "Hetmanat",  0, 0.9, [
	

	#oim tavern visitor
	
	#oim geberik counters for taverns
	##
	#oim_alcohol_cnt
	#oim_gashish_cnt 

	#OiM tavern fights system code begin
	#oim_tavern_visitor_dlg
	[anyone,"oim_tavern_visitor_dlg", [(call_script, "script_oim_get_alcohol_status"),], "Greetings, {sir/madam}! {s2}", "oim_tavern_visitor_dlg_1", []],				
	[anyone|plyr, "oim_tavern_visitor_dlg_1", [], "My fists are itching for a fight... Would you perhaps like to measure your strength?", "oim_tavern_visitor_simple_fight_check", []],			
	[anyone|plyr, "oim_tavern_visitor_dlg_1", [], "What a face you have, friend. Excellent for scaring slow-witted lads.", "oim_tavern_duel", []],			
	[anyone|plyr, "oim_tavern_visitor_dlg_1", [(eq, 0, 1),], "Word is, many able sharpshooters reside here... Perhaps we might have a marksmanship contest?", "oim_tavern_ranged", []],			
	[anyone|plyr, "oim_tavern_visitor_dlg_1", [(neq, "$g_talk_troop_faction", "fac_kingdom_3")], "Let us raise our glasses for...", "oim_drink", []],			
	[anyone|plyr, "oim_tavern_visitor_dlg_1", [], "My troops await me...", "close_window", []],			

	[anyone|auto_proceed,"oim_tavern_visitor_simple_fight_check", [
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_simple_fights_count),
		(ge, ":count", 6), 
	], "{!}NOT SHOWN", "oim_tavern_simple_fight_refuse_too_much", []],			

	[anyone|auto_proceed,"oim_tavern_visitor_simple_fight_check", [
		(store_character_level, ":level", "trp_player"), 
		(ge, ":level", 12), 
	], "{!}NOT SHOWN", "oim_tavern_simple_fight_refuse_generik", []],			

	[anyone|auto_proceed,"oim_tavern_visitor_simple_fight_check", [], "{!}NOT SHOWN", "oim_tavern_visitor_simple_fight", []],			
	
	[anyone,"oim_tavern_visitor_simple_fight", [], "What good it is to me to crush your ribs for nothing? But were it for a few silver coins...", "oim_tavern_simple_fight_bet", []],			

	[anyone|plyr, "oim_tavern_simple_fight_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 5), 
 	], "5 thaler", "oim_tavern_simple_fight_goon", [(assign, "$g_oim_bet", 5)]],

	[anyone|plyr, "oim_tavern_simple_fight_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 10), 
	], "10 thaler", "oim_tavern_simple_fight_goon", [(assign, "$g_oim_bet", 10)]],

	[anyone|plyr, "oim_tavern_simple_fight_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 15), 
	], "15 thaler", "oim_tavern_simple_fight_goon", [(assign, "$g_oim_bet", 15)]],

	[anyone|plyr, "oim_tavern_simple_fight_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 25), 
	], "25 thaler", "oim_tavern_simple_fight_goon", [(assign, "$g_oim_bet", 25)]],

	[anyone|plyr, "oim_tavern_simple_fight_bet", [], "Not just now, I'm afraid... You see, I injured my hand in the last fight...", "oim_tavern_visitor_dlg", []],

	[anyone, "oim_tavern_simple_fight_goon", [], "You sure know how to talk! You better watch yourself, or I'll bleed you dry!", "close_window", [
		#tavern simple fight init code
		#(store_current_day, ":now_day"),
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_simple_fights_count),
		(val_add, ":count", 1),
		(troop_set_slot, "$g_talk_troop", slot_troop_simple_fights_count, ":count"),	
		(jump_to_menu, "mnu_oim_tavern_simple_fight"),		
		(finish_mission),
	]],			

	#oim_tavern_duel
	[anyone|auto_proceed,"oim_tavern_duel", [
		(store_character_level, ":level", "trp_player"), 
		(ge, ":level", 12), 
	], "{!}NOT SHOWN", "oim_tavern_simple_fight_refuse_generik", []],			

	[anyone|auto_proceed,"oim_tavern_duel", [], "{!}NOT SHOWN", "oim_tavern_duel_goon", []],			

	[anyone,"oim_tavern_duel_goon", [(call_script, "script_get_tavern_visitor_store_to_s2")], "{s2}", "close_window", [
		#oim code
		(store_current_day, ":now_day"),
		(troop_set_slot, "$g_talk_troop", slot_troop_last_duel_time, ":now_day"),
		(jump_to_menu, "mnu_oim_duel_fight"), 
		(finish_mission),
	]],			

	#oim_tavern_ranged
	[anyone|auto_proceed,"oim_tavern_ranged", [
		#slot_troop_ranged_fights_count
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_ranged_fights_count),
		(ge, ":count", 6), 
	], "{!}NOT SHOWN", "oim_tavern_simple_fight_refuse_too_much", []],			

	[anyone|auto_proceed,"oim_tavern_ranged", [
		(store_character_level, ":level", "trp_player"), 
		(ge, ":level", 12), 
	], "{!}NOT SHOWN", "oim_tavern_simple_fight_refuse_generik", []],			

	[anyone|auto_proceed, "oim_tavern_ranged", [], "{!}NOT SHOWN", "oim_tavern_ranged_goon", []],			

	[anyone, "oim_tavern_ranged_goon", [], "We could have a contest... But what is there to win? Let us compete for a cash prize!", "oim_tavern_ranged_bet", []],			
	
	[anyone|plyr, "oim_tavern_ranged_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 5), 
 	], "5 thaler.", "oim_tavern_ranged_bet_goon2", [(assign, "$g_oim_bet", 5)]],

	[anyone|plyr, "oim_tavern_ranged_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 10), 
	], "10 thaler.", "oim_tavern_ranged_bet_goon2", [(assign, "$g_oim_bet", 10)]],

	[anyone|plyr, "oim_tavern_ranged_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 15), 
	], "15 thaler.", "oim_tavern_ranged_bet_goon2", [(assign, "$g_oim_bet", 15)]],

	[anyone|plyr, "oim_tavern_ranged_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 25), 
	], "25 thaler.", "oim_tavern_ranged_bet_goon2", [(assign, "$g_oim_bet", 25)]],

	[anyone|plyr, "oim_tavern_ranged_bet", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 50), 
	], "50 thaler.", "oim_tavern_ranged_bet_goon2", [(assign, "$g_oim_bet", 25)]],
	
	[anyone|plyr, "oim_tavern_ranged_bet", [], "Not just now, I'm afraid... You see, I injured my hand in the last fight...", "oim_tavern_visitor_dlg", []],
	
	[anyone,"oim_tavern_ranged_bet_goon2", [], "Great, it's a deal. A long time has passed since I last shot for leisure...", "close_window", [
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_ranged_fights_count),
		(val_add, ":count", 1), 
		(troop_get_slot, "$g_talk_troop", slot_troop_ranged_fights_count, ":count"),
		(jump_to_menu, "mnu_oim_tavern_ranged_fight"),
		(finish_mission),
	]],				
	
	#oim_drink
	[anyone|auto_proceed, "oim_drink", [
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_alcohol_count),
		(eq, ":count", 0), 
	], "{!}NOT SHOWN", "oim_drink_refuse", []],			

	[anyone, "oim_drink", [], "Well, for whom, then?", "oim_drink_goon", []],			

	[anyone|plyr, "oim_drink_goon", [], "For Jan Kasimir!", "oim_drink_goon2", [(assign, "$g_oim_toste", "fac_kingdom_1"),]],
	[anyone|plyr, "oim_drink_goon", [], "For Carl!", "oim_drink_goon2", [(assign, "$g_oim_toste", "fac_kingdom_4"),]],
	[anyone|plyr, "oim_drink_goon", [], "For old Hmel!", "oim_drink_goon2", [(assign, "$g_oim_toste", "fac_kingdom_5"),]],
	[anyone|plyr, "oim_drink_goon", [], "For the Khan's health!", "oim_drink_goon2", [(assign, "$g_oim_toste", "fac_kingdom_3"),]],
	[anyone|plyr, "oim_drink_goon", [], "For the Tsar!", "oim_drink_goon2", [(assign, "$g_oim_toste", "fac_kingdom_2"),]],
	[anyone|plyr, "oim_drink_goon", [], "Return...", "oim_tavern_visitor_dlg", []],

	[anyone|auto_proceed, "oim_drink_goon2", [
		(eq, "$g_oim_toste", "$g_talk_troop_faction"), 
	], "{!}NOT SHOWN", "oim_drink_goon3", []],			

	[anyone|auto_proceed, "oim_drink_goon2", [], "{!}NOT SHOWN", "oim_drink_duel", []],			
	
	
	[anyone,"oim_drink_duel", [], "Hey, you dirty spy!", "close_window", [
		#oim code start duel
		(troop_set_slot, "$g_talk_troop", slot_troop_alcohol_count, 0),
		(store_current_day, ":now_day"),
		(troop_set_slot, "$g_talk_troop", slot_troop_last_duel_time, ":now_day"),
		(jump_to_menu, "mnu_oim_duel_fight"), 
		(finish_mission),
	]],				

	[anyone,"oim_drink_goon3", [], "All right then! Drain it to the dregs!", "close_window", [
		#oim code to add alcohol count
		(troop_get_slot, ":count", "$g_talk_troop", slot_troop_alcohol_count),
		(val_add, ":count", 1), 
		(troop_set_slot, "$g_talk_troop", slot_troop_alcohol_count, ":count"), 
		(val_add, "$g_oim_hero_alcohol_count", 1),
		(val_add, "$g_oim_hero_global_alc_count", 1), 
		(store_random_in_range, ":random", 0, 100), 
		(try_begin),
			(ge, "$g_oim_hero_alcohol_count", 7), 
			(le, ":random", 10), 
			(jump_to_menu, "mnu_oim_drunken_prison"),
			(finish_mission),
		(else_try), 
			(ge, "$g_oim_hero_alcohol_count", 7),
			(ge, "$g_oim_hero_global_alc_count", 50),
			(le, ":random", 60), 
			(jump_to_menu, "mnu_oim_drunken_wound"), 
			(finish_mission),
		(end_try), 	
		(try_begin), 
			(ge, "$g_oim_hero_global_alc_count", 75),
			(le, ":random", 75),			
			(jump_to_menu, "mnu_oim_alcoholic"), 
			(finish_mission),
		(try_end), 
	]],				
		
	[anyone,"oim_drink_refuse", [], "I don't know you well enough to be drinking with you...", "close_window", []],				
	[anyone,"oim_tavern_simple_fight_refuse_too_much", [], "I have to rest a little. I'm getting tired.", "close_window", []],				
	[anyone,"oim_tavern_simple_fight_refuse_generik", [], "I have no time for you. Pass by and go.", "close_window", []],				


	[anyone,"oim_tavern_rich_visitor", [], "Of course, mister. For 25 thaler we shall prepare a fine meal for you.", "oim_tavern_rich_visitor_goon", []],				
	[anyone|plyr,"oim_tavern_rich_visitor_goon", [
		(store_troop_gold, ":cur_gold", "trp_player"),
		(ge, ":cur_gold", 25), 
	], "Good. Here is the money.", "close_window", [
		(troop_remove_gold, "trp_player", 25), 
		(finish_mission),
		
		(jump_to_menu, "mnu_oim_rich_visitor_meal"),
		]],				
	[anyone|plyr,"oim_tavern_rich_visitor_goon", [], "Some other time.", "close_window", []],			

	[anyone|plyr,"oim_dmitriy_eleonora_auto_dlg", [], "Why have you stopped? Go on to the father!", "close_window", []],			

###
##  OiM GE Code
###	
	
	#oim_guild_master_talk
	[anyone,"oim_guild_master_talk", [], "Yes, {playername}.", "oim_guild_master_ask", 
	[
		#(jump_to_menu, "mnu_auto_return_to_map"),
	]],	
	
	[anyone|plyr,"oim_guild_master_ask", [], "What can I gain from a caravan?", "oim_send_caravan_generik_descr", []],			

    [anyone,"oim_send_caravan_generik_descr", [], "Well, you can buy a load of goods here on a discount, and send the caravan to another city, where you'd sell the goods -- for a profit or a loss, depends on how good a trader you are.", "oim_guild_master_talk", []],	
	
	[anyone|plyr,"oim_guild_master_ask", 
	[
		(this_or_next|quest_slot_eq, "qst_oim_deliver_caravan", slot_quest_target_center, -1),  
		(neg|check_quest_active, "qst_oim_deliver_caravan"),
	], "Yes, I'd like to send a caravan.", "oim_send_caravan_generik", []],		

	[anyone|plyr,"oim_guild_master_ask", 
	[
		(quest_slot_eq, "qst_oim_trade_pantent", slot_quest_current_state, 1),
	], "I would like to get a trade permit.", "oim_buy_trayd_patend", []],	
	
	[anyone,"oim_buy_trayd_patend", [], "I should think that for you, {playername}, a trade permit can be issued on the spot for a mere 2500 thaler.", "oim_buy_trayd_patend_1", []],	

    [anyone|plyr,"oim_buy_trayd_patend_1", 
    [
        (store_troop_gold, ":gold", "trp_player"), 
        (ge, ":gold", 2500),
    ], "I am willing to pay this amount. ", "oim_buy_trayd_patend_2", []],	

    [anyone,"oim_buy_trayd_patend_2", [], "Excellent. Here is the document and the seal... ", "oim_guild_master_talk", 
    [
        (quest_set_slot, "qst_oim_trade_pantent", slot_quest_current_state, 2),
        (str_store_string, s2, "str_oim_trade_pantent_granted"),  
        (add_quest_note_from_sreg, "qst_oim_trade_pantent", 4, s2, 1),
        (troop_remove_gold, "trp_player", 2500),
		
		#(check_quest_active, "qst_oim_trade_pantent"), 
		#(quest_slot_eq, "qst_oim_trade_pantent", slot_quest_current_state, 2),
		(call_script, "script_end_quest", "qst_oim_trade_pantent"),
    ]],	

    [anyone|plyr,"oim_buy_trayd_patend_1", [], "That is too expensive for me.", "oim_guild_master_talk", []],			
		
	[anyone|plyr,"oim_guild_master_ask", [], "Let's talk about something else.", "mayor_pretalk", []],			







	[anyone,"oim_send_caravan_generik", [
	  (assign, ":there_are_items_avaliable", 0),
      (assign, ":there_are_items_avaliable_and_enought_money", 0),

      (store_troop_gold, ":gold", "trp_player"), 

	  (try_for_range, ":goods", trade_goods_begin, trade_goods_end),
	    (party_get_slot, ":cur_merchant", "$g_encountered_party", slot_town_merchant),
        (assign, ":num_items", 0),       
        (try_for_range, ":i_slot", num_equipment_kinds, max_inventory_items + num_equipment_kinds),
          (troop_get_inventory_slot, ":slot_item", ":cur_merchant", ":i_slot"),
          (try_begin),
            (eq, ":slot_item", ":goods"),
            (val_add, ":num_items", 1),
          (try_end),
        (try_end),

		(ge, ":num_items", 5),

		(assign, ":there_are_items_avaliable", 1),		
  	    (call_script, "script_oim_get_item_base_price", ":goods"), 
	  
	    (assign, ":base_price", reg0),
	    (ge, ":base_price", 10), #no need to make trade with less valueable items. its impossible to make profit because of trade expenses.	  

  	    (call_script, "script_game_get_item_buy_price_factor", ":goods"),#, "$g_encountered_party"), 
	    (assign, ":price_factor", reg0),	  
	    (store_mul, ":price", ":base_price", ":price_factor"), 
	    (val_div, ":price", 100),
	    (assign, reg0, ":price"),	  	  
	    (val_mul, ":price", 5), 
	  
	    (store_div, ":price_for_escort", ":base_price", 2), #escort price = 0.5x base price
        (val_add, ":price", ":price_for_escort"), #price for escourt
  	    
        (ge, ":gold", ":price"),

		(assign, ":there_are_items_avaliable_and_enought_money", 1),
	  (try_end),

	  (str_store_party_name, s1, "$town_suggested_to_go_to"),

	  (assign, "$g_trade_next_menu", 0),
	  (try_begin),	    
	    (eq, ":there_are_items_avaliable", 0),		
		(assign, "$g_trade_next_menu", 1),
      (else_try),
	    (eq, ":there_are_items_avaliable_and_enought_money", 0),
		(assign, "$g_trade_next_menu", 2),
      (try_end),	    

	  (eq, ":there_are_items_avaliable_and_enought_money", 1),

	  (store_distance_to_party_from_party, ":dist", "$town_suggested_to_go_to", "$g_encountered_party"),
	  (store_div, ":travel_time", ":dist", 4),
	  (assign, reg1, ":travel_time"),
	], "Which goods do you want to trade?   ", "oim_send_caravan_which_goods", []],			
	
	[anyone,"oim_send_caravan_generik", [	
	(eq, "$g_trade_next_menu", 1),	
	], "I am afraid, we don't have enough items in stock to furnish the caravan.", "oim_send_caravan_give_up", []],			
	
	[anyone,"oim_send_caravan_generik", [	
	(eq, "$g_trade_next_menu", 2),	
	], "You do not have enough money to afford the caravan.", "oim_send_caravan_give_up", []],			

	[anyone|plyr,"oim_send_caravan_give_up", [(str_store_string, s2, "str_return_later"),], "{s2}", "mayor_pretalk", []],	







    






    [anyone|plyr|repeat_for_1000,"oim_send_caravan_which_goods", [
      (store_repeat_object, ":goods"),
      (is_between,":goods", trade_goods_begin, trade_goods_end),
      (call_script, "script_oim_is_trade_good_availible", "$g_encountered_party", ":goods"),
	  (gt, reg0, 0),

	  (party_get_slot, ":cur_merchant", "$g_encountered_party", slot_town_merchant),
      (assign, ":num_items", 0),       
      (try_for_range, ":i_slot", num_equipment_kinds, max_inventory_items + num_equipment_kinds),
        (troop_get_inventory_slot, ":slot_item", ":cur_merchant", ":i_slot"),
        (try_begin),
          (eq, ":slot_item", ":goods"),
          (val_add, ":num_items", 1),
        (try_end),
      (try_end),

	  (ge, ":num_items", 5),

      (str_store_item_name, s5 ,":goods"),
  	  (call_script, "script_oim_get_item_base_price", ":goods"), 
	  
	  (assign, ":base_price", reg0),
	  (ge, ":base_price", 10), #no need to make trade with less valueable items. its impossible to make profit because of trade expenses.	  

  	  (call_script, "script_game_get_item_buy_price_factor", ":goods"),
	  (assign, ":price_factor", reg0),	  
	  (store_mul, ":price", ":base_price", ":price_factor"), 
	  (val_div, ":price", 100),

	  (assign, reg0, ":price"),	  
	  
	  (val_mul, ":price", 5), 

	  (val_add, ":price", 100), #minimum caravan cost is 100 (50 for caravan master + 50 for one guard)
	  
  	  (store_troop_gold, ":gold", "trp_player"), 
	  (ge, ":gold", ":price"),
    ],
    "{s5}, price: {reg0} thaler.", "oim_send_caravan_which_town",[
      (store_repeat_object, ":goods"),
	  (assign, "$town_suggested_goods", ":goods"),
    ]],
	   
	[anyone|plyr,"oim_send_caravan_which_goods", [(str_store_string, s2, "str_reason_high_price"),], "{s2}", "mayor_pretalk", []],			









	[anyone,"oim_send_caravan_which_town", [], "And where would you like to send the caravan?", "oim_send_caravan_town_selected", []],			
	
    [anyone|plyr|repeat_for_parties,"oim_send_caravan_town_selected", 
    [
        (store_repeat_object, ":center_no"),
        (party_slot_eq,":center_no",slot_party_type, spt_town),        
        (neq, ":center_no", "$g_encountered_party"),
        (str_store_party_name, s1, ":center_no"),		
		(str_store_item_name, s2, "$town_suggested_goods"),
		
		(set_fixed_point_multiplier, 100),  

		(store_distance_to_party_from_party, ":dist", ":center_no", "$g_encountered_party"),

		(call_script, "script_get_max_skill_of_player_party", "skl_trade"),
		(assign, ":trade_skill", reg0),
		
		(store_mul, ":trade_skill_mul_10", ":trade_skill", 10),
		(store_add, ":trade_skill_mul_10_plus_20", ":trade_skill_mul_10", 20),

		(str_store_party_name, s1, ":center_no"),		

		(try_begin),
		  (le, ":dist", ":trade_skill_mul_10_plus_20"),
		  
		  (call_script, "script_oim_get_item_base_price", "$town_suggested_goods"), 
		  
		  (assign, ":base_price", reg0),
		  (assign, ":temp_g_encountered_party", "$g_encountered_party"),
		  (assign, "$g_encountered_party", ":center_no"),
		  (call_script, "script_game_get_item_sell_price_factor", "$town_suggested_goods"),
		  (assign, "$g_encountered_party", ":temp_g_encountered_party"),
		  (assign, ":price_factor", reg0),
		  (store_mul, ":price", ":base_price", ":price_factor"), 
		  (val_div, ":price", 100),
		  (assign, reg1, ":price"),

		  (str_store_string, s1, "str_price_there_known"),		
		(else_try),
          (str_store_string, s1, "str_price_there_unknown"),		
		(try_end),

    ], "{s1}", "oim_send_caravan_finish",[(store_repeat_object, "$town_suggested_to_go_to")]],
      
    [anyone|plyr,"oim_send_caravan_town_selected", [], "Some other time.", "mayor_pretalk", []],			   

	[anyone,"oim_send_caravan_finish", 
    [
	  (store_distance_to_party_from_party, ":dist", "$town_suggested_to_go_to", "$g_encountered_party"),
	  (store_div, ":travel_time", ":dist", 10),
	  (assign, reg1, ":travel_time"),

	  (str_store_item_name, s2, "$town_suggested_goods"),
	  (str_store_party_name, s1, "$town_suggested_to_go_to"),

	  (party_get_slot, ":cur_merchant", "$g_encountered_party", slot_town_merchant),
       (assign, "$g_num_town_suggested_goods", 0),       
       (try_for_range, ":i_slot", num_equipment_kinds, max_inventory_items + num_equipment_kinds),
         (troop_get_inventory_slot, ":slot_item", ":cur_merchant", ":i_slot"),
         (try_begin),
           (eq, ":slot_item", "$town_suggested_goods"),
           (val_add, "$g_num_town_suggested_goods", 1),
         (try_end),
       (try_end),
	], "Very well, that shouldn't be a problem. The caravan shall head to {s1}. I guess the journey will take {reg1} hours. And how many {s2} would you like to send?", "oim_send_caravan_town_select_go_on4", []],			
	











		
	[anyone|plyr,"oim_send_caravan_town_select_go_on4", [
        (ge, "$g_num_town_suggested_goods", 20),

		(call_script, "script_oim_get_item_base_price", "$town_suggested_goods"), 
		(assign, ":price", reg0),

		(str_store_item_name, s2, "$town_suggested_goods"),
		(call_script, "script_oim_game_get_item_buy_price_factor", "$town_suggested_goods", "$g_encountered_party"), 
		(assign, ":price_factor", reg0),
		(val_mul, ":price", ":price_factor"), 
		(val_div, ":price", 100),
		(val_mul, ":price", 20), #count

		(store_troop_gold, ":gold", "trp_player"), 
		(store_sub, ":gold_minus_minimum_caravan_expense", ":gold", 100), #minimum caravan expense is 100 (50 for caravan master + 50 for one guard)
		(ge, ":gold_minus_minimum_caravan_expense", ":price"),
		(assign, reg0, ":price"),
		(assign, "$g_total_caravan_cost_huge", ":price"),
	], "A great caravan ({reg0} thaler, 20 goods).", "oim_send_caravan_town_select_go_on4b", [(assign, "$oim_count_to_deliver", 20),(assign, "$g_total_caravan_cost", "$g_total_caravan_cost_huge"),]],			
	[anyone|plyr,"oim_send_caravan_town_select_go_on4", [
        (ge, "$g_num_town_suggested_goods", 15),

		(call_script, "script_oim_get_item_base_price", "$town_suggested_goods"), 
		(assign, ":price", reg0),

		(str_store_item_name, s2, "$town_suggested_goods"),
		(call_script, "script_oim_game_get_item_buy_price_factor", "$town_suggested_goods", "$g_encountered_party"), 
		(assign, ":price_factor", reg0),
		(val_mul, ":price", ":price_factor"), 
		(val_div, ":price", 100),
		(val_mul, ":price", 15), #count

		(store_troop_gold, ":gold", "trp_player"), 
		(store_sub, ":gold_minus_minimum_caravan_expense", ":gold", 100), #minimum caravan expense is 100 (50 for caravan master + 50 for one guard)
		(ge, ":gold_minus_minimum_caravan_expense", ":price"),
		(assign, reg0, ":price"),
		(assign, "$g_total_caravan_cost_large", ":price"),
	], "A big caravan ({reg0} thaler, 15 goods).", "oim_send_caravan_town_select_go_on4b", [(assign, "$oim_count_to_deliver", 15),(assign, "$g_total_caravan_cost", "$g_total_caravan_cost_large"),]],			
	[anyone|plyr,"oim_send_caravan_town_select_go_on4", [
	    (ge, "$g_num_town_suggested_goods", 10),

		(call_script, "script_oim_get_item_base_price", "$town_suggested_goods"), 
		(assign, ":price", reg0),

		(call_script, "script_oim_game_get_item_buy_price_factor", "$town_suggested_goods", "$g_encountered_party"), 
		(assign, ":price_factor", reg0),
		(val_mul, ":price", ":price_factor"), 
		(val_div, ":price", 100),
		(val_mul, ":price", 10), #count
		
		(store_troop_gold, ":gold", "trp_player"), 
		(store_sub, ":gold_minus_minimum_caravan_expense", ":gold", 100), #minimum caravan expense is 100 (50 for caravan master + 50 for one guard)
		(ge, ":gold_minus_minimum_caravan_expense", ":price"),
		(assign, reg0, ":price"),
		(assign, "$g_total_caravan_cost_medium", ":price"),
	], "A medium caravan ({reg0} thaler, 10 goods).", "oim_send_caravan_town_select_go_on4b", [(assign, "$oim_count_to_deliver", 10),(assign, "$g_total_caravan_cost", "$g_total_caravan_cost_medium"),]],			
	[anyone|plyr,"oim_send_caravan_town_select_go_on4", [
	    (ge, "$g_num_town_suggested_goods", 5),

		(call_script, "script_oim_get_item_base_price", "$town_suggested_goods"), 
		(assign, ":price", reg0),

		(call_script, "script_oim_game_get_item_buy_price_factor", "$town_suggested_goods", "$g_encountered_party"), 
		(assign, ":price_factor", reg0),
		(val_mul, ":price", ":price_factor"), 
		(val_div, ":price", 100),
		(val_mul, ":price", 5), #count

		(store_troop_gold, ":gold", "trp_player"), 
		(store_sub, ":gold_minus_minimum_caravan_expense", ":gold", 100), #minimum caravan expense is 100 (50 for caravan master + 50 for one guard)
		(ge, ":gold_minus_minimum_caravan_expense", ":price"),
		(assign, reg0, ":price"),
		(assign, "$g_total_caravan_cost_small", ":price"),
	], "A small caravan ({reg0} thaler, 5 goods).", "oim_send_caravan_town_select_go_on4b", [(assign, "$oim_count_to_deliver", 5),(assign, "$g_total_caravan_cost", "$g_total_caravan_cost_small"),]],			
	
	[anyone|plyr,"oim_send_caravan_town_select_go_on4", [
		(str_store_string, s2, "str_reason_high_price"), 
	], "{s2} ", "mayor_pretalk", []], #was close_window

	[anyone,"oim_send_caravan_town_select_go_on4b", [
    ], "All right. There will be one caravan master leading the caravan. How many caravan guards do you want as escort?", "oim_send_caravan_town_select_go_on4c", []],			

	[anyone|plyr,"oim_send_caravan_town_select_go_on4c", 
	[
	  (assign, reg5, 2), 
	  (assign, reg0, 100),
    ], "{reg5}, price: {reg0} thaler.", "oim_send_caravan_town_select_go_on5", [(assign, "$g_number_of_escorts", 2),]],			

	[anyone|plyr,"oim_send_caravan_town_select_go_on4c", 
	[
	  (store_troop_gold, ":gold", "trp_player"), 
	  (store_sub, ":gold_minus_200", ":gold", 200), 
	  (ge, ":gold_minus_200", "$g_total_caravan_cost"), 
	  (assign, reg5, 4), 
	  (assign, reg0, 200),
    ], "{reg5}, price: {reg0} thaler.", "oim_send_caravan_town_select_go_on5", [(assign, "$g_number_of_escorts", 4),]],			

	[anyone|plyr,"oim_send_caravan_town_select_go_on4c", 
	[
	  (store_troop_gold, ":gold", "trp_player"), 
	  (store_sub, ":gold_minus_400", ":gold", 400), 
	  (ge, ":gold_minus_400", "$g_total_caravan_cost"), 
	  (assign, reg5, 8), 
	  (assign, reg0, 400),
    ], "{reg5}, price: {reg0} thaler.", "oim_send_caravan_town_select_go_on5", [(assign, "$g_number_of_escorts", 8),]],			

	[anyone|plyr,"oim_send_caravan_town_select_go_on4c", 
	[
	  (store_troop_gold, ":gold", "trp_player"), 
	  (store_sub, ":gold_minus_600", ":gold", 600), 
	  (ge, ":gold_minus_600", "$g_total_caravan_cost"), 
	  (assign, reg5, 12), 
	  (assign, reg0, 600),
    ], "{reg5}, price: {reg0} thaler.", "oim_send_caravan_town_select_go_on5", [(assign, "$g_number_of_escorts", 12),]],			
	
	[anyone|plyr,"oim_send_caravan_town_select_go_on4c", 
	[
	  (store_troop_gold, ":gold", "trp_player"), 
	  (store_sub, ":gold_minus_1000", ":gold", 1000), 
	  (ge, ":gold_minus_1000", "$g_total_caravan_cost"), 
	  (assign, reg5, 20), 
	  (assign, reg0, 1000),
    ], "{reg5}, price: {reg0} thaler.", "oim_send_caravan_town_select_go_on5", [(assign, "$g_number_of_escorts", 20),]],			

	[anyone,"oim_send_caravan_town_select_go_on5", 
	[		
		(str_store_item_name, s1, "$town_suggested_goods"), 
        (str_store_party_name, s2, "$town_suggested_to_go_to"), 		

		(try_begin),
		  (eq, "$oim_count_to_deliver", 20),
		  (assign, "$g_total_caravan_cost", "$g_total_caravan_cost_huge"),		  
		(else_try),
		  (eq, "$oim_count_to_deliver", 15),
		  (assign, "$g_total_caravan_cost", "$g_total_caravan_cost_large"),
		(else_try),
		  (eq, "$oim_count_to_deliver", 10),
		  (assign, "$g_total_caravan_cost", "$g_total_caravan_cost_medium"),
		(else_try),		  
		  (assign, "$g_total_caravan_cost", "$g_total_caravan_cost_small"),
		(try_end),

		(assign, "$g_total_caravan_cost_pure", "$g_total_caravan_cost"),

		(store_mul, ":number_of_escorts_mul_50", "$g_number_of_escorts", 50),		
		(val_add, "$g_total_caravan_cost", ":number_of_escorts_mul_50"),		
	], "All right, that should be just fine. {s2} -- that will cost you {reg1} thaler.", "close_window", [
		#spawning caravan
		(set_spawn_radius,1),
        (spawn_around_party,"p_main_party", "pt_oim_merchant_caravan2"),
        (assign, ":oim_caravan", reg0),
		
		(party_set_slot, ":oim_caravan", slot_party_type, spt_kingdom_caravan),
		(party_set_slot, ":oim_caravan", slot_party_ai_state, spai_undefined),

		(party_set_ai_behavior, ":oim_caravan", ai_bhvr_travel_to_party),		
		(party_set_ai_object, ":oim_caravan", "$town_suggested_to_go_to"),

		(party_set_flags, ":oim_caravan", pf_default_behavior, 0),
		(party_add_leader, ":oim_caravan", "trp_caravan_master"),
		(party_add_members, ":oim_caravan", "trp_caravan_guard", "$g_number_of_escorts"), #was fix 10 for every kind of caravan
		
		(try_begin),
		  (gt, "$players_kingdom", 0),
		  (party_set_faction, ":oim_caravan", "$players_kingdom"),
        (else_try),
		  (party_set_faction, ":oim_caravan", "fac_player_faction"),
        (try_end),

		(troop_clear_inventory, "trp_oim_caravan_master"),
		(troop_add_items, "trp_oim_caravan_master", "$town_suggested_goods", "$oim_count_to_deliver"),
		
		#starting quest
		#qst_oim_deliver_caravan
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_current_state, 0),
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_giver_troop, "trp_player"),  
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_target_center, "$town_suggested_to_go_to"),  
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_target_item, "$town_suggested_goods"),  
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_target_amount, "$oim_count_to_deliver"),  
		(quest_set_slot, "qst_oim_deliver_caravan", slot_quest_target_party, ":oim_caravan"),  
		(setup_quest_text, "qst_oim_deliver_caravan"),	
		(str_store_party_name_link, s1, "$g_encountered_party"), 
		(str_store_party_name_link, s5, "$town_suggested_to_go_to"), 
		(str_store_item_name, s3, "$town_suggested_goods"), 
		(assign, reg0, "$oim_count_to_deliver"),
		(str_store_string, s2, "str_caravan_develireg_descr"),
		(call_script, "script_start_quest", "qst_oim_deliver_caravan", "trp_player"),	
		
		#removing gold
		(troop_remove_gold, "trp_player", "$g_total_caravan_cost"),

		(assign, ":num_taken_goods", 0),
	    (party_get_slot, ":cur_merchant", "$g_encountered_party", slot_town_merchant),       
        (try_for_range, ":i_slot", num_equipment_kinds, max_inventory_items + num_equipment_kinds),
          (troop_get_inventory_slot, ":slot_item", ":cur_merchant", ":i_slot"),
          (try_begin),
            (eq, ":slot_item", "$town_suggested_goods"),
		    (lt, ":num_taken_goods", "$oim_count_to_deliver"),
            (troop_set_inventory_slot, ":cur_merchant", ":i_slot", -1),
			(val_add, ":num_taken_goods", 1),
          (try_end),
        (try_end),

		#Setting up new price factors
		(call_script, "script_oim_change_price_factors", "$g_encountered_party", "$town_suggested_goods", "$oim_count_to_deliver", 0),

		(assign, reg1, "$g_total_caravan_cost"),		
		(str_store_party_name, s2, "$town_suggested_to_go_to"), 
	]],			

	#oim_caravan_master_dlg
	[anyone,"oim_caravan_master_dlg", [], "Yes, let's move out as soon as possible!", "close_window", [
		(jump_to_menu, "mnu_auto_return_to_map"),
	]],			
	
	#oim new prisoners dialogs
	
  [anyone|plyr,"prisoner_chat", [
	#saving vars
	(store_conversation_troop, "$g_talk_troop"),
    (store_troop_faction, "$g_talk_troop_faction", "$g_talk_troop"),
  ], "Don't even try to run from me!", "prisoner_chat_oim",[]],
  [anyone,"prisoner_chat_oim", [], "And what do you want?", "prisoner_chat_oim_2",[]],
  [anyone|plyr,"prisoner_chat_oim_2", [
	(is_between, "$g_talk_troop", kingdom_heroes_begin, kingdom_heroes_end),
	(neq, "$g_talk_troop", "trp_kingdom_2_lord"), 	
	(neg|quest_slot_eq, "qst_oim_getman_capture_tatarin", slot_quest_target_troop, "$g_talk_troop"), 
	(neq,  "trp_knight_2_16", 1),
	#(neq, "$g_talk_troop", "trp_knight_2_14"),
  ], "I think you should be set free...", "prisoner_chat_oim_3",[]],
  [anyone|plyr,"prisoner_chat_oim_2", [], "Never mind.", "close_window",[]],
  [anyone,"prisoner_chat_oim_3", [], "And what is it you want?", "prisoner_chat_oim_5",[]],
  [anyone|plyr,"prisoner_chat_oim_5", [], "Release for ransom...", "prisoner_chat_oim_5_money",[]],
	[anyone,"prisoner_chat_oim_5_money", [
			#code calculate prise
			(call_script, "script_calculate_ransom_amount_for_troop", "$g_talk_troop"),
			(assign, reg12, reg0),
			(val_mul, reg12, 3), 
			(val_div, reg12, 5), 
			(assign, reg0, reg12),
			(assign, "$temp", reg12),
		], "I can pay {reg0} thaler for my freedom.", "prisoner_chat_oim_5_money_goon",[]],
		[anyone|plyr,"prisoner_chat_oim_5_money_goon", [], "Well then, you are free.", "close_window",[
			#code
			(call_script, "script_troop_add_gold", "trp_player", "$temp"), 
	        (party_remove_prisoners, "p_main_party", "$g_talk_troop", 1),
			(call_script, "script_remove_troop_from_prison", "$g_talk_troop"),
		]],
		[anyone|plyr,"prisoner_chat_oim_5_money_goon", [], "Your offer is not good enough for me.", "close_window",[]],
  [anyone|plyr,"prisoner_chat_oim_5", [], "Free the prisoner unconditionally...", "prisoner_chat_oim_5_honor1",[]],
	[anyone,"prisoner_chat_oim_5_honor1", [], "Well, if you would let me go for free, then you are truly a friend to our people.", "prisoner_chat_oim_5_honor",[]],
	[anyone|plyr,"prisoner_chat_oim_5_honor", [], "Well then, you are free.", "prisoner_chat_oim_5_honor_goon",[]],
		[anyone,"prisoner_chat_oim_5_honor_goon", [], "You are a {man/woman} of honor. You have my gratitude.", "close_window",[
			(party_remove_prisoners, "p_main_party", "$g_talk_troop", 1),
			(call_script, "script_remove_troop_from_prison", "$g_talk_troop"),
			(call_script, "script_change_player_honor", 1),
			(call_script, "script_change_player_relation_with_troop", "$g_talk_troop", 20),
			(call_script, "script_change_player_relation_with_faction_ex", "$g_talk_troop_faction", 10),
		]],
	[anyone|plyr,"prisoner_chat_oim_5_honor", [], "Never mind.", "close_window",[]],
  [anyone|plyr,"prisoner_chat_oim_5", [], "I'll be watching you.", "close_window",[]],
  
	
	
	
	
#OiM end	


	#	(troop_get_slot, ":count", "$g_talk_troop", slot_troop_simple_fights_count),
	#	(val_add, ":count", 1),
	#	(troop_set_slot, "$g_talk_troop", slot_troop_simple_fights_count, ":count"),	
	#	(jump_to_menu, "mnu_oim_tavern_simple_fight"),


#THIS SHOULD BE ONLY IN THE END OF OIM LINES!	
  [party_tpl|pt_oim_monfor_party|auto_proceed, "start", [], "{!}NOT SHOWN", "oim_monfor_auto_response",[]],
	[anyone, "oim_monfor_auto_response", [], "Forgive me, my friend, but I have urgent business. Let us talk another time.", "close_window",[(assign, "$g_leave_encounter", 1),]],   
#zagloba end lines	
    [anyone,"oim_zagloba_help_answer", [], "Death to foes of the Polish Commonwealth!", "close_window", []],		
#just in case  
  	[anyone,"oim_zagloba_auto_help", [], "I want to give you a piece of advice.", "oim_zagloba_stab", []],		       	
    [anyone,"oim_zagloba_stab", [], "Death to the foes of the Polish Commonwealth!", "member_talk", []],		
#lord sp task stub
    [anyone,"oim_lord_sp_task", [], "I don't have any work for you.", "lord_pretalk", [(assign, "$g_leave_encounter", 1),]],		
	
##black Getman Lines:
	[anyone,"oim_radzivil_dlg_orders", [], "So far I have no job for you.", "close_window", []],			

	[anyone,"oim_dmitriy_razin_sp_task", [], "No.", "supported_pretender_pretalk", []],				
	
	[anyone,"oim_zagloba_auto_reject", [], "Excuse me, I am busy.", "close_window", []],				
	
	[anyone,"oim_getman_mamay_auto_reject", [], "Excuse me, I am busy.", "close_window", []],				
	
	
#THIS SHOULD BE ONLY IN THE END OF OIM LINES!   
	
# Ryan BEGIN
  [party_tpl|pt_mountain_bandits|auto_proceed,"start", [(eq,"$talk_context",tc_party_encounter),], #(encountered_party_is_attacker)
   "Warning: This line should never display.", "bandit_introduce",[(play_sound, "snd_encounter_bandits"),]],
  [party_tpl|pt_forest_bandits|auto_proceed,"start", [(eq,"$talk_context",tc_party_encounter),], #(encountered_party_is_attacker)
   "Warning: This line should never display.", "bandit_introduce",[(play_sound, "snd_encounter_bandits"),]],
  [party_tpl|pt_steppe_bandits|auto_proceed,"start", [(eq,"$talk_context",tc_party_encounter),], #(encountered_party_is_attacker)
   "Warning: This line should never display.", "bandit_introduce",[(play_sound, "snd_encounter_steppe_bandits"),]],
  [party_tpl|pt_sea_raiders|auto_proceed,"start", [(eq,"$talk_context",tc_party_encounter),], #(encountered_party_is_attacker)
   "Warning: This line should never display.", "bandit_introduce",[(play_sound, "snd_encounter_sea_raiders"),]],
  [anyone,"bandit_introduce", [
      (store_random_in_range, ":rand", 11, 15),
        (str_store_string, s11, "@I can smell a fat purse a mile away. Methinks yours could do with some lightening, eh?"),
        (str_store_string, s12, "@Why, it be another traveller, chance met upon the road! I should warn you, country here's a mite dangerous for a good {fellow/woman} like you. But for a small donation my boys and I'll make sure you get rightways to your destination, eh?"),
        (str_store_string, s13, "@Well well, look at this! You'd best start coughing up some silver, friend, or me and my boys'll have to break you."),
		(str_store_string, s14, "@There's a toll for passin' through this land, payable to us, so if you don't mind we'll just be collectin' our due from your purse..."),
        (str_store_string_reg, s5, ":rand"),
    ], "{s5}", "bandit_talk",[]], #(play_sound,"snd_encounter_bandits"),
  [anyone|plyr,"bandit_talk", [], "I'll give you nothing but cold steel, you scum!", "close_window",[[encounter_attack]]],
  [anyone|plyr,"bandit_talk", [], "There's no need to fight. I can pay you to let me pass.", "bandit_barter",[]],
  [anyone,"bandit_barter",
   [#(store_relation, ":bandit_relation", "fac_player_faction", "$g_encountered_party_faction"),
    #(ge, ":bandit_relation", -50),
    #(store_mul, "$bandit_tribute", ":bandit_relation", ":bandit_relation"),
    #(val_div, "$bandit_tribute", 70),
    #(val_add, "$bandit_tribute", 100),
    #(val_mul, "$bandit_tribute", 10),

	(store_character_level, ":player_character_level", "trp_player"),
	(store_mul, ":tribute_amount", ":player_character_level", 30),
	(val_add, ":tribute_amount", 50),
		
	#(bandits and looters wants only 3% of player's total richness + player character level * 30 + member size * 10 + 50)
    (store_troop_gold, ":total_value", "trp_player"),
    (troop_get_inventory_capacity, ":inv_size", "trp_player"),
    (try_for_range, ":i_slot", 0, ":inv_size"),
         (troop_get_inventory_slot, ":item_id", "trp_player", ":i_slot"),
         (ge, ":item_id", 0),
         (try_begin),
           (is_between, ":item_id", trade_goods_begin, trade_goods_end),
           (store_item_value, ":item_value", ":item_id"),
           (val_add, ":total_value", ":item_value"),
         (try_end),
    (try_end),    
	(store_div, ":total_value_div_33", ":total_value", 333), 
	(val_mul, ":total_value_div_33", 10), 
	(val_add, ":tribute_amount", ":total_value_div_33"),

    (call_script, "script_party_count_members_with_full_health", "p_main_party"),
    (assign, ":player_party_size", reg0),
	(store_sub, ":player_party_size_minus_player", ":player_party_size", 1),
	(val_min, ":player_party_size_minus_player", 10),	
	(store_mul, ":player_party_size_minus_player_mul_10", ":player_party_size_minus_player", 10),
	(val_add, ":tribute_amount", ":player_party_size_minus_player_mul_10"),
	(assign, "$bandit_tribute", ":tribute_amount"),
	
    (assign, reg5, "$bandit_tribute"),
    ], "Silver without blood -- that's our favorite kind. Pay us {reg5} thaler and we'll let you be on your way.", "bandit_barter_2",[]],
  [anyone|plyr,"bandit_barter_2", [[store_troop_gold,reg(2)],[ge,reg(2),"$bandit_tribute"],[assign,reg(5),"$bandit_tribute"]],
   "Very well, take it.", "bandit_barter_3a",[[troop_remove_gold, "trp_player","$bandit_tribute"]]],
  [anyone|plyr,"bandit_barter_2", [],
   "I don't have that much money with me.", "bandit_barter_3b",[]],
  [anyone,"bandit_barter_3b", [],
   "That's too bad. I guess we'll just have to sell you into slavery. Take {him/her}, lads!", "close_window",[[encounter_attack]]],

  [anyone,"bandit_barter", [],
   "Hey, I've heard of you! You slaughter us freebooters like dogs, and now you expect us to let you go for a few stinking coins? Forget it. You gave us no quarter, and you'll get none from us.", "close_window",[]],



  [anyone,"bandit_barter_3a", [], "Heh, that wasn't so hard, now was it? All right, we'll let you go now. Be off.", "close_window",[
    (store_current_hours,":protected_until"),
    (val_add, ":protected_until", 72),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until,":protected_until"),
    (party_ignore_player, "$g_encountered_party", 72),
	(party_set_ignore_with_player_party, "p_main_party", 72),

	(set_fixed_point_multiplier, 100),  
	(try_for_parties, ":party_no"),
	  (store_faction_of_party, ":party_faction", ":party_no"),

      (this_or_next|eq, ":party_faction", "$players_kingdom"),
      (eq, ":party_faction", "fac_player_faction"),

	  (party_slot_eq, ":party_no", slot_party_type, spt_kingdom_caravan),

	  (store_distance_to_party_from_party, ":dist", "p_main_party", ":party_no"),

	  (le, ":dist", 25),
		  
	  (party_set_ignore_with_player_party, ":party_no", 72),
	(try_end),

    (assign, "$g_leave_encounter",1)
    ]],
  

  [anyone,"start", [(this_or_next|eq, "$g_encountered_party_template", "pt_mountain_bandits"),(eq, "$g_encountered_party_template", "pt_forest_bandits")],
   "Eh? What is it?", "bandit_meet",[]],

  [anyone|plyr,"bandit_meet", [], "Your luck has run out, wretch. Prepare to die!", "bandit_attack",
   [(store_relation, ":bandit_relation", "fac_player_faction", "$g_encountered_party_faction"),
    (val_sub, ":bandit_relation", 3),
    (val_max, ":bandit_relation", -100),
    (set_relation, "fac_player_faction", "$g_encountered_party_faction", ":bandit_relation"),
    (party_ignore_player, "$g_encountered_party", 0),
    (party_set_slot,"$g_encountered_party",slot_party_ignore_player_until, 0),
	(party_set_ignore_with_player_party, "p_main_party", 0),
    ]],
  
  [anyone,"bandit_attack", [
      (store_random_in_range, ":rand", 11, 15),
        (str_store_string, s11, "@Another fool come to throw {him/her}self on my weapon, eh? Fine, let's fight!"),
        (str_store_string, s12, "@We're not afraid of you, {sirrah/wench}. Time to bust some heads!"),
        (str_store_string, s13, "@That was a mistake. Now I'm going to have to make your death long and painful."),
        (str_store_string, s14, "@Brave words. Let's see you back them up with deeds, cur!"),
        (str_store_string_reg, s5, ":rand"),
      ], "{s5}", "close_window",[]],

  [anyone|plyr,"bandit_meet", [], "Never mind, I have no business with you.", "close_window",[(assign, "$g_leave_encounter", 1)]],
# Ryan END
  
#Quest dialogs
  
  [party_tpl|pt_troublesome_bandits,"start", [(quest_slot_eq, "qst_troublesome_bandits", slot_quest_target_party, "$g_encountered_party")],
   "This is a most unlucky day for you. We are the worst people you can meet in these parts...", "troublesome_bandits_intro_1",[]],
  [anyone|plyr,"troublesome_bandits_intro_1", [],
   "Heh. For me, you are nothing more than the usual riffraff. They're offering good money for your heads in {s1}.",
   "troublesome_bandits_intro_2", [(quest_get_slot, ":quest_giver_center", "qst_troublesome_bandits", slot_quest_giver_center),
                                   (str_store_party_name, s1, ":quest_giver_center")
                                   ]],
  [anyone,"troublesome_bandits_intro_2", [],
   "A bounty hunter! ... We hate bounty hunters! Kill {him/her}! Kill {him/her} now!", "close_window",[(encounter_attack)]],
 
 

  [party_tpl|pt_rescued_prisoners,"start", [(eq,"$talk_context",tc_party_encounter)], "Do you want us to follow you?", "disbanded_troop_ask",[]],
  [anyone|plyr,"disbanded_troop_ask", [], "Yes. Let us ride together.", "disbanded_troop_join",[]],
  [anyone|plyr,"disbanded_troop_ask", [], "No. Not just now.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone,"disbanded_troop_join", [[neg|party_can_join]], "You do not have room in your party for us.", "close_window",[(assign, "$g_leave_encounter",1)]],
  [anyone,"disbanded_troop_join", [], "We are at your command.", "close_window",[[party_join],(assign, "$g_leave_encounter",1)]],
   
  [party_tpl|pt_enemy,"start", [(eq,"$talk_context",tc_party_encounter)], "You will not capture me again. Not this time.", "enemy_talk_1",[]],
  [party_tpl|pt_enemy|plyr,"enemy_talk_1", [], "You don't have a chance against me. Give up.", "enemy_talk_2",[]],
  [party_tpl|pt_enemy,"enemy_talk_2", [], "I will give up when you are dead!", "close_window",[[encounter_attack]]],


######################################
# ROUTED WARRIORS
######################################

  [party_tpl|pt_routed_warriors, "start", [(eq,"$talk_context",tc_party_encounter)],
   "I beg you, please leave us alone.", "party_encounter_routed_agents_are_caught",
   []],

  [party_tpl|pt_routed_warriors|plyr, "party_encounter_routed_agents_are_caught", [],
   "Do you think you can run away from me? You will be my prisoner or die!", "party_encounter_routed_agents_are_caught2",
   []],

  [party_tpl|pt_routed_warriors|plyr,"party_encounter_routed_agents_are_caught", [],
   "Ok. We'll leave you in peace this time, but do not show your face to us again.", "close_window", [(assign, "$g_leave_encounter",1)]],

  [party_tpl|pt_routed_warriors, "party_encounter_routed_agents_are_caught2",
   [
     #(store_party_size_wo_prisoners, ":routed_party_size", "$g_encountered_party"),
     #(store_party_size_wo_prisoners, ":main_party_size", "p_main_party"),

    # calculate power of routed party
    (assign, ":routed_party_power", 0),
    (party_get_num_companion_stacks, ":num_stacks", "$g_encountered_party"),
    (try_for_range, ":i_stack", 0, ":num_stacks"),
      (party_stack_get_troop_id, ":stack_troop", "$g_encountered_party", ":i_stack"),
      (store_character_level, ":troop_level", ":stack_troop"),
      (try_begin),
        (troop_is_mounted, ":stack_troop"),
        (val_add, ":troop_level", 5),
      (try_end),      
      (party_stack_get_size, ":stack_size", "$g_encountered_party", ":i_stack"),
      (val_mul, ":troop_level", ":stack_size"),
      (val_add, ":routed_party_power", ":troop_level"),
    (try_end),

    # calculate power of our party
    (assign, ":main_party_power", 0),
    (party_get_num_companion_stacks, ":num_stacks", "p_main_party"),
    (try_for_range, ":i_stack", 0, ":num_stacks"),
      (party_stack_get_troop_id, ":stack_troop", "p_main_party", ":i_stack"),
      (store_character_level, ":troop_level", ":stack_troop"),
      (try_begin),
        (troop_is_mounted, ":stack_troop"),
        (val_add, ":troop_level", 5),
      (try_end),      
      (party_stack_get_size, ":stack_size", "p_main_party", ":i_stack"),
      (val_mul, ":troop_level", ":stack_size"),
      (val_add, ":main_party_power", ":troop_level"),
    (try_end),  
        
    (store_div, ":main_party_power_divided_by_5", ":main_party_power", 5),
    (ge, ":routed_party_power", ":main_party_power_divided_by_5"),
    ],
   "Have you no mercy? Very well -- we will fight you to the last man!", "close_window",
   []],

  [party_tpl|pt_routed_warriors, "party_encounter_routed_agents_are_caught2",
    [
      #(store_party_size_wo_prisoners, ":routed_party_size", "$g_encountered_party"),
      #(store_party_size_wo_prisoners, ":main_party_size", "p_main_party"),

      # calculate power of routed party
      (assign, ":routed_party_population", 0),
      (assign, ":routed_party_power", 0),
      (party_get_num_companion_stacks, ":num_stacks", "$g_encountered_party"),
      (try_for_range, ":i_stack", 0, ":num_stacks"),
        (party_stack_get_troop_id, ":stack_troop", "$g_encountered_party", ":i_stack"),
        (store_character_level, ":troop_level", ":stack_troop"),
        (try_begin),
          (troop_is_mounted, ":stack_troop"),
          (val_add, ":troop_level", 5),
        (try_end),      
        (party_stack_get_size, ":stack_size", "$g_encountered_party", ":i_stack"),
        (val_mul, ":troop_level", ":stack_size"),
        (val_add, ":routed_party_power", ":troop_level"),
        (val_add, ":routed_party_population", ":stack_size"),
      (try_end),

      # calculate power of our party
      (assign, ":main_party_power", 0),
      (party_get_num_companion_stacks, ":num_stacks", "p_main_party"),
      (try_for_range, ":i_stack", 0, ":num_stacks"),
        (party_stack_get_troop_id, ":stack_troop", "p_main_party", ":i_stack"),
        (store_character_level, ":troop_level", ":stack_troop"),
        (try_begin),
          (troop_is_mounted, ":stack_troop"),
          (val_add, ":troop_level", 5),
        (try_end),      
        (party_stack_get_size, ":stack_size", "p_main_party", ":i_stack"),
        (val_mul, ":troop_level", ":stack_size"),
        (val_add, ":main_party_power", ":troop_level"),
      (try_end),  
    
      (store_div, ":main_party_power_divided_by_5", ":main_party_power", 5),
      (lt, ":routed_party_power", ":main_party_power_divided_by_5"),

      (store_party_size_wo_prisoners, ":routed_party_size", "$g_encountered_party"),
      (assign, reg3, ":routed_party_size"),
      
      (try_begin),    
        (gt, ":routed_party_population", 1),
        (str_store_string, s1, "str_we_resign"),
      (else_try),
        (str_store_string, s1, "str_i_resign"),
      (try_end),
    ],
    "{s1}", "close_window",
    [(assign,"$g_enemy_surrenders", 1),
     (call_script, "script_party_wound_all_members", "$g_encountered_party"),
     (call_script, "script_party_copy", "p_total_enemy_casualties", "$g_encountered_party"),
     #(change_screen_exchange_with_party, "$g_encountered_party"),
     ]],

  #[party_tpl|pt_routed_warriors,"close_window_anythink_else", [],
  # "Anythink else.", "close_window", [(assign, "$g_leave_encounter",1)]],

  [anyone|plyr,"prisoner_chat", [
	(neg|troop_slot_eq, "$g_talk_troop", slot_troop_occupation, slto_kingdom_hero),
  ], "Do not try running away or trying something stupid. I will be watching you.", "prisoner_chat_2",[]],
  [anyone,"prisoner_chat_2", [], "No, I swear I won't.", "close_window",[]],


  [anyone,"start", [(party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
                    (this_or_next|is_between,"$g_talk_troop",weapon_merchants_begin,weapon_merchants_end),
                    (this_or_next|is_between,"$g_talk_troop",armor_merchants_begin, armor_merchants_end),
                    (             is_between,"$g_talk_troop",horse_merchants_begin, horse_merchants_end),
                    ],
   "Greetings, {your lordship/my lady}. How may I serve you today?", "town_merchant_talk",[]],

  [anyone,"start", [(this_or_next|is_between,"$g_talk_troop",weapon_merchants_begin,weapon_merchants_end),
                    (this_or_next|is_between,"$g_talk_troop",armor_merchants_begin, armor_merchants_end),
                    (             is_between,"$g_talk_troop",horse_merchants_begin, horse_merchants_end)], "Good day. What can I do for you?", "town_merchant_talk",[]],

  [anyone|plyr,"town_merchant_talk", [(is_between,"$g_talk_troop",weapon_merchants_begin,weapon_merchants_end)],
   "I want to buy a new weapon. Show me your wares.", "trade_requested_weapons",[]],
  [anyone|plyr,"town_merchant_talk", [(is_between,"$g_talk_troop",armor_merchants_begin,armor_merchants_end)],
   "I am looking for some equipment. Show me what you have.", "trade_requested_armor",[]],
  [anyone|plyr,"town_merchant_talk", [(is_between,"$g_talk_troop",horse_merchants_begin,horse_merchants_end)],
   "I am thinking of buying a horse.", "trade_requested_horse",[]],

  [anyone,"trade_requested_weapons", [], "Ah, yes {sir/madam}. These arms are the best you'll find anywhere.", "merchant_trade",[[change_screen_trade]]],
  [anyone,"trade_requested_armor", [], "Of course, {sir/madam}. You'll never find better quality armor than this.", "merchant_trade",[[change_screen_trade]]],
  [anyone,"trade_requested_horse", [], "You have a fine eye for horses, {sir/madam}. You won't find better beasts anywhere else.", "merchant_trade",[[change_screen_trade]]],


  [anyone,"merchant_trade", [], "Anything else?", "town_merchant_talk",[]],
  [anyone|plyr,"town_merchant_talk", [], "Tell me. What are people talking about these days?", "merchant_gossip",[]],
  [anyone,"merchant_gossip", [], "Well, there's nothing new lately. Prices, weather, the war, the same old things.", "town_merchant_talk",[]],
  [anyone|plyr,"town_merchant_talk", [], "Goodbye.", "close_window",[]],




##  [anyone,"start", [(eq, "$talk_context", 0),
##                    (is_between,"$g_talk_troop",walkers_begin, walkers_end),
##                    (eq, "$sneaked_into_town",1),
##                     ], "Stay away beggar!", "close_window",[]],
  
  [anyone,"start", [(eq, "$talk_context", 0),
                    (is_between,"$g_talk_troop",walkers_begin, walkers_end),
                    (party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
                     ], "My {lord/lady}?", "town_dweller_talk",[(assign, "$welfare_inquired",0),(assign, "$rumors_inquired",0),(assign, "$info_inquired",0)]],

  [anyone,"start", [(eq, "$talk_context", 0),
                    (is_between,"$g_talk_troop",walkers_begin, walkers_end),
                     ], "Good day, {sir/madam}.", "town_dweller_talk",[(assign, "$welfare_inquired", 0),(assign, "$rumors_inquired",0),(assign, "$info_inquired",0)]],

  [anyone|plyr,"town_dweller_talk", [(check_quest_active, "qst_hunt_down_fugitive"),
                                     (neg|check_quest_concluded, "qst_hunt_down_fugitive"),
                                      (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_target_center, "$current_town"),
                                      (quest_get_slot, ":quest_target_dna", "qst_hunt_down_fugitive", slot_quest_target_dna),
                                      (call_script, "script_get_name_from_dna_to_s50", ":quest_target_dna"),
                                      (str_store_string, s4, s50),
                                      ],
   "I am looking for a man by the name of {s4}. I was told he may be hiding here.", "town_dweller_ask_fugitive",[]],
  [anyone ,"town_dweller_ask_fugitive", [],
   "Strangers come and go to our village, {sir/madam}. If he is hiding here, you will surely find him if you look around.", "close_window",[]],

# Ryan BEGIN
  [anyone|plyr,"town_dweller_talk",
   [
     (eq, 1, 0),
     (check_quest_active, "qst_meet_spy_in_enemy_town"),
     (neg|check_quest_succeeded, "qst_meet_spy_in_enemy_town"),
     (quest_slot_eq, "qst_meet_spy_in_enemy_town", slot_quest_target_center, "$current_town"),
     (str_store_item_name,s5,"$spy_item_worn"),
     ],
   "Pardon me, but is that a {s5} you're wearing?", "town_dweller_quest_meet_spy_in_enemy_town_ask_item",
   [
     ]],
  [anyone, "town_dweller_quest_meet_spy_in_enemy_town_ask_item", [
     (str_store_item_name,s5,"$spy_item_worn"),

     (try_begin),
     (troop_has_item_equipped,"$g_talk_troop","$spy_item_worn"),
     (str_store_string,s6,"@A {s5}? Well... Yes, I suppose it is. What a strange thing to ask."),
     (else_try),
     (str_store_string,s6,"@Eh? No, it most certainly is not a {s5}. I'd start questioning my eyesight if I were you."),
     (try_end),
  ],
   "{s6}", "town_dweller_talk",[]],

  [anyone|plyr|repeat_for_100,"town_dweller_talk",
   [
     (store_repeat_object,":object"),
     (lt,":object",4), # repeat only 4 times

     (check_quest_active, "qst_meet_spy_in_enemy_town"),
     (neg|check_quest_succeeded, "qst_meet_spy_in_enemy_town"),
     (quest_slot_eq, "qst_meet_spy_in_enemy_town", slot_quest_target_center, "$current_town"),

     (store_add,":string",":object","str_secret_sign_1"),
     (str_store_string, s4, ":string"),
     ],
   "{s4}", "town_dweller_quest_meet_spy_in_enemy_town",
   [
     (store_repeat_object,":object"),
     (assign, "$temp", ":object"),
     ]],

  [anyone ,"town_dweller_quest_meet_spy_in_enemy_town",
   [
     (call_script, "script_agent_get_town_walker_details", "$g_talk_agent"),
     (assign, ":walker_type", reg0),
     (eq, ":walker_type", walkert_spy),
     (quest_get_slot, ":secret_sign", "qst_meet_spy_in_enemy_town", slot_quest_target_amount),
     (val_sub, ":secret_sign", secret_signs_begin),
     (eq, ":secret_sign", "$temp"),
     (store_add, ":countersign", ":secret_sign", countersigns_begin),
     (str_store_string, s4, ":countersign"),
     ],
   "{s4}", "town_dweller_quest_meet_spy_in_enemy_town_know",[]],

  [anyone, "town_dweller_quest_meet_spy_in_enemy_town", [],
   "Eh? What kind of gibberish is that?", "town_dweller_quest_meet_spy_in_enemy_town_dont_know",[]],

  [anyone|plyr, "town_dweller_quest_meet_spy_in_enemy_town_dont_know", [],
   "Never mind.", "close_window",[]],

  [anyone|plyr, "town_dweller_quest_meet_spy_in_enemy_town_know", [
     (quest_get_slot, ":quest_giver", "qst_meet_spy_in_enemy_town", slot_quest_giver_troop),
     (str_store_troop_name, s4, ":quest_giver"),
  ],
   "{s4} sent me to collect your reports. Do you have them with you?", "town_dweller_quest_meet_spy_in_enemy_town_chat",[]],

  [anyone, "town_dweller_quest_meet_spy_in_enemy_town_chat", [
     (quest_get_slot, ":quest_giver", "qst_meet_spy_in_enemy_town", slot_quest_giver_troop),
     (str_store_troop_name, s4, ":quest_giver"),
  ],
   "You have arrived at last. Here they are. Be sure they reach {s4} intact and without delay.", "town_dweller_quest_meet_spy_in_enemy_town_chat_2",[
     (call_script, "script_succeed_quest", "qst_meet_spy_in_enemy_town"),
     (call_script, "script_center_remove_walker_type_from_walkers", "$current_town", walkert_spy),
   ]],

  [anyone|plyr, "town_dweller_quest_meet_spy_in_enemy_town_chat_2", [],
   "Farewell.", "close_window",
   [
     ]],
# Ryan END  

  [anyone|plyr,"town_dweller_talk", [(party_slot_eq, "$current_town", slot_party_type, spt_village),
                                     (eq, "$info_inquired", 0)], "What can you tell me of this village?", "town_dweller_ask_info",[(assign, "$info_inquired", 1)]],
  [anyone|plyr,"town_dweller_talk", [(party_slot_eq, "$current_town", slot_party_type, spt_town),
                                     (eq, "$info_inquired", 0)], "What can you tell me about this town?", "town_dweller_ask_info",[(assign, "$info_inquired", 1)]],

  [anyone,"town_dweller_ask_info", [(str_store_party_name, s5, "$current_town"),
                                    (assign, reg4, 0),
                                    (try_begin),
                                      (party_slot_eq, "$current_town", slot_party_type, spt_town),
                                      (assign, reg4, 1),
                                    (try_end),
                                    (str_store_string, s6, "@This is the {reg4?town:village} of {s5}, {sir/madam}."),
                                    (str_clear, s10),
                                    (try_begin),
                                      (party_slot_eq, "$current_town", slot_town_lord, "trp_player"),
                                      (str_store_string, s10, "@{s6} Our {reg4?town:village} and the surrounding lands belong to you of course, my {lord/lady}."),
                                    (else_try),
                                      (party_get_slot, ":town_lord", "$current_town", slot_town_lord),
                                      (ge, ":town_lord", 0),
                                      (str_store_troop_name, s7, ":town_lord"),
                                      (store_troop_faction, ":town_lord_faction", ":town_lord"),
                                      (str_store_faction_name, s8, ":town_lord_faction"),
                                      (str_store_string, s10, "@{s6} Our {reg4?town:village} and the surrounding lands belong to {s7} of {s8}."),
                                    (try_end),
                                    (str_clear, s5),
                                    (assign, reg20, 0),
                                    (try_for_range, ":cur_good", trade_goods_begin, trade_goods_end),
                                      (store_sub, ":cur_good_slot", ":cur_good", trade_goods_begin),
                                      (val_add, ":cur_good_slot", slot_town_trade_good_productions_begin),
                                      (party_get_slot, ":production", "$g_encountered_party", ":cur_good_slot"),
                                      (ge, ":production", 20),
                                      (str_store_item_name, s3, ":cur_good"),
                                      (try_begin),
                                        (eq, reg20, 0),
                                        (str_store_string, s5, s3),
                                      (else_try),
                                        (eq, reg20, 1),
                                        (str_store_string, s5, "@{s3} and {s5}"),
                                      (else_try),
                                        (str_store_string, s5, "@{s3}, {s5}"),
                                      (try_end),
                                      (val_add, reg20, 1),
                                    (try_end),
                                    (str_store_string, s11, "@{reg20?We mostly produce {s5} here:We don't produce much here these days}.\
 If you would like to learn more, you can speak with our {reg4?guildmaster:village elder}. He is nearby, right over there."),
                                    ],
   "{s10} {s11}", "close_window",[]],

  [anyone|plyr,"town_dweller_talk", [(party_slot_eq, "$current_town", slot_party_type, spt_village),
                                     (eq, "$welfare_inquired", 0)], "How is life here?", "town_dweller_ask_situation",[(assign, "$welfare_inquired", 1)]],
  [anyone|plyr,"town_dweller_talk", [(party_slot_eq, "$current_town", slot_party_type, spt_town),
                                     (eq, "$welfare_inquired", 0)], "How is life here?", "town_dweller_ask_situation",[(assign, "$welfare_inquired", 1)]],


  [anyone,"town_dweller_ask_situation", [(call_script, "script_agent_get_town_walker_details", "$g_talk_agent"),
                                         (assign, ":walker_type", reg0),
                                         (eq, ":walker_type", walkert_needs_money),
                                         (party_slot_eq, "$current_town", slot_party_type, spt_village)],
   "Disaster has struck my family, {sir/madam}. A pestilence has taken our crops, and my poor children lay at home, hungry and sick. And my neighbors are too poor themselves to help me.", "town_dweller_poor",[]],

  [anyone,"town_dweller_ask_situation", [(call_script, "script_agent_get_town_walker_details", "$g_talk_agent"),
                                         (assign, ":walker_type", reg0),
                                         (eq, ":walker_type", walkert_needs_money)],
   "My life is miserable, {sir/madam}. I have not been able to find a job for months, and my poor children go to bed hungry each night. My neighbors are too poor themselves to help me.", "town_dweller_poor",[]],

  [anyone|plyr,"town_dweller_poor", [(store_troop_gold, ":gold", "trp_player"),
                                     (ge, ":gold", 300),
                                     ],
   "Then take these 300 thaler. I hope this will help you and your family.", "town_dweller_poor_paid",
   [(troop_remove_gold, "trp_player", 300),
    ]],

  [anyone|plyr,"town_dweller_poor", [],
   "Then you must work harder, and bear your burden without complaining.", "town_dweller_poor_not_paid",[]],

  [anyone,"town_dweller_poor_not_paid", [], "Yes {sir/madam}. I will do as you say.", "close_window",[]],

  [anyone,"town_dweller_poor_paid", [], "{My lord/My good lady}. You are so good and generous. I will tell everyone how you helped us.", "close_window",
   [(call_script, "script_change_player_relation_with_center", "$g_encountered_party", 1),
    (call_script, "script_agent_get_town_walker_details", "$g_talk_agent"),
    (assign, ":walker_no", reg2),
    (call_script, "script_center_set_walker_to_type", "$g_encountered_party", ":walker_no", walkert_needs_money_helped),
    ]],

  [anyone,"town_dweller_ask_situation", [(call_script, "script_agent_get_town_walker_details", "$g_talk_agent"),
                                         (assign, ":walker_type", reg0),
                                         (eq, ":walker_type", walkert_needs_money_helped)
                                         ],
   "Thank you for your kindness {sir/madam}. You have done a great thing here. I will pray for you every day.", "close_window",[]],

  [anyone,"town_dweller_ask_situation", [(neg|party_slot_ge, "$current_town", slot_town_prosperity, 30)],
   "Times are hard, {sir/madam}. We work hard all day, yet we go to sleep hungry most nights.", "town_dweller_talk",[]],
  
  [anyone,"town_dweller_ask_situation", [(neg|party_slot_ge, "$current_town", slot_town_prosperity, 70)],
   "Times are hard, {sir/madam}. But we count our blessings.", "town_dweller_talk",[]],
  [anyone,"town_dweller_ask_situation", [],
   "We are not doing too badly {sir/madam}. We count our blessings.", "town_dweller_talk",[]],

  [anyone|plyr,"town_dweller_talk", [(eq, "$rumors_inquired", 0)], "What is the latest rumor around here?", "town_dweller_ask_rumor",[(assign, "$rumors_inquired", 1)]],
  [anyone,"town_dweller_ask_rumor", [(neg|party_slot_ge, "$current_town", slot_center_player_relation, -5)], "I don't know anything that would be of interest to you.", "town_dweller_talk",[]],
  
  [anyone,"town_dweller_ask_rumor", [(store_mul, ":rumor_id", "$current_town", 197),
                                     (val_add,  ":rumor_id", "$g_talk_agent"),
                                     (call_script, "script_get_rumor_to_s61", ":rumor_id"),
                                     (gt, reg0, 0)], "{s61}", "town_dweller_talk",[]],

  [anyone,"town_dweller_ask_rumor", [], "I haven't heard anything interesting lately.", "town_dweller_talk",[]],

  [anyone|plyr,"town_dweller_talk", [], "Leave...", "close_window",[]],

  [anyone,"start", [(eq, "$talk_context", 0),
                    (is_between,"$g_talk_troop",regular_troops_begin, regular_troops_end),
                    (party_slot_eq,"$current_town",slot_town_lord, "trp_player"),
                     ], "Yes {sir/madam}?", "player_castle_guard_talk",[]],
  [anyone|plyr,"player_castle_guard_talk", [], "How goes the watch, soldier?", "player_castle_guard_talk_2",[]],
  [anyone,"player_castle_guard_talk_2", [], "All is quiet {sir/madam}. Nothing to report.", "player_castle_guard_talk_3",[]],
  [anyone|plyr,"player_castle_guard_talk_3", [], "Good. Keep your eyes open.", "close_window",[]],


  [anyone,"start", [(eq, "$talk_context", 0),
                    (is_between,"$g_talk_troop",regular_troops_begin, regular_troops_end),
                    (is_between,"$g_encountered_party_faction",kingdoms_begin, kingdoms_end),
                    (eq, "$players_kingdom", "$g_encountered_party_faction"),
                    (troop_slot_ge, "trp_player", slot_troop_renown, 100),
                    (str_store_party_name, s10, "$current_town"),
                     ], "Good day, {sir/my lady}. Your presence is a honor for {s10}.", "close_window",[]],

  [anyone,"start", [(eq, "$talk_context", 0),
                    (is_between,"$g_talk_troop",regular_troops_begin, regular_troops_end),
                    (is_between,"$g_encountered_party_faction",kingdoms_begin, kingdoms_end),
                     ], "Step right while you're here, and you'll have no trouble.", "close_window",[]],

  [anyone,"start", [(eq, "$talk_context", tc_court_talk),
                    (is_between,"$g_talk_troop",regular_troops_begin, regular_troops_end),
                    (is_between,"$g_encountered_party_faction",kingdoms_begin, kingdoms_end),
                    (party_slot_eq,"$current_town",slot_town_lord, "trp_player"),
                     ], "Your orders, {my lord/my lady}?", "hall_guard_talk",[]],

  [anyone,"start", [
					(call_script, "script_cf_oim_check_condition_for_talk"), 
					(eq,reg0, 1),
                     ], "No talking on the sentry post, {sir/madam}.", "close_window",[]],
                     
  [anyone|plyr,"hall_guard_talk", [], "Stay on duty and let me know if anyone comes to see me.", "hall_guard_duty",[]],
  [anyone,"hall_guard_duty", [], "Yes, {my lord/my lady}. As you wish.", "close_window",[]],
  
  [anyone|plyr,"hall_guard_talk", [], "I want you to arrest this {man/woman} immediately!", "hall_guard_arrest",[]],
  [anyone,"hall_guard_arrest", [], "Who do you want arrested {sir/madam}?", "hall_guard_arrest_2",[]],
  [anyone|plyr,"hall_guard_arrest_2", [], "Ah, never mind my high spirits lads.", "close_window",[]],
  [anyone|plyr,"hall_guard_arrest_2", [], "Forget it. I will find another way to deal with this.", "close_window",[]],

  [anyone,"enemy_defeated", [], "Argh! I hate this.", "close_window",[]],

  [anyone,"party_relieved", [], "Thank you for helping us against those bastards.", "close_window",[]],

  [anyone,"start", [(eq,"$talk_context", tc_party_encounter),(store_encountered_party, reg(5)),(party_get_template_id,reg(7),reg(5)),(eq,reg(7),"pt_sea_raiders")],
   "I will drink from your skull!", "battle_reason_stated",[(play_sound,"snd_encounter_sea_raiders")]],
  
######################################
# GENERIC MEMBER CHAT
######################################

  [anyone,"member_chat", [], "Your orders {sir/madam}?", "regular_member_talk",[]],
  [anyone|plyr,"regular_member_talk", [], "Tell me about yourself", "view_regular_char_requested",[]],
  [anyone,"view_regular_char_requested", [], "Aye {sir/madam}. I have no secrets from you.", "do_regular_member_view_char",[[change_screen_view_character]]],
  [anyone,"do_regular_member_view_char", [], "Anything else?", "regular_member_talk",[]],
  [anyone|plyr,"regular_member_talk", [], "Nothing. Keep moving.", "close_window",[]],




######################################
# GENERIC PARTY ENCOUNTER
######################################

  [anyone,"start", [(eq,"$talk_context",tc_party_encounter),
                    (gt,"$encountered_party_hostile",0),
                    (encountered_party_is_attacker),
                    ],
   "You have no chance against us. Surrender now or we will kill you all...", "party_encounter_hostile_attacker",
   [(try_begin),
      (eq,"$g_encountered_party_template","pt_steppe_bandits"),
      (play_sound, "snd_encounter_steppe_bandits"),
    (try_end)]],
  [anyone|plyr,"party_encounter_hostile_attacker", [
                    ],
   "Don't attack! We surrender.", "close_window", [(assign,"$g_player_surrenders",1)]],
#  [anyone|plyr,"party_encounter_hostile_attacker", [
#                    ],
#   "I will pay you 1000 denars if you just let us go.", "close_window", []],
  [anyone|plyr,"party_encounter_hostile_attacker", [
                    ],
   "We will fight to the end!", "close_window", []],
  
  [anyone,"start", [(eq,"$talk_context",tc_party_encounter),
                    (neg|encountered_party_is_attacker),
                    ],
   "What do you want?", "party_encounter_hostile_defender",
   []],

  [anyone|plyr,"party_encounter_hostile_defender", [],
   "Surrender or die!", "party_encounter_hostile_ultimatum_surrender", [

       ]],

#post 0907 changes begin
  [anyone,"party_encounter_hostile_ultimatum_surrender", [],
   "{s43}", "close_window", [
       (call_script, "script_lord_comment_to_s43", "$g_talk_troop", "str_lord_challenged_default"),
	   #oim code
	   (try_begin), 
	    #"$g_talk_troop_party"  
		
		(store_faction_of_party, ":g_talk_troop_party_faction", "$g_encountered_party"),
		(store_relation, ":g_talk_troop_party_faction_relation", ":g_talk_troop_party_faction", "fac_player_faction"),
		
		(party_get_template_id, ":template", "$g_talk_troop_party"),
		(this_or_next|eq, ":template", "pt_forager_party"), 
		(this_or_next|eq, ":template", "pt_scout_party"), 
		(             eq, ":template", "pt_patrol_party"), 
		(try_begin), 
			(ge, ":g_talk_troop_party_faction_relation", 0),
                        (assign, "$encountered_party_friendly", 0),
                        (assign,"$g_encountered_party_relation",-5),
			(call_script, "script_set_player_relation_with_faction", ":g_talk_troop_party_faction", -5),
		(else_try), 
			(call_script, "script_change_player_relation_with_faction", ":g_talk_troop_party_faction", -3),
		(end_try),	
	   (end_try), 
       ]],
#post 0907 changes end

  [anyone|plyr,"party_encounter_hostile_defender", [],
   "Nothing. I was just passing by...", "close_window", [(assign, "$g_leave_encounter",1)]],
#Captain merchant talk


[anyone|auto_proceed, "start", 
	[
	(is_between,"$g_talk_troop", merch_capitan_begin, merch_begin) 
	], 
	"{!}NOT SHOWN", "merch_captain_start",[]], 

 [anyone,"merch_captain_start", [
	(str_clear, s2), 
	(try_begin), 
		(lt, "$g_naem_count_total", 0),
		(str_store_string, s2, "str_no_soldiers_for_recruit"),
	(end_try), 
 ], "Good day, {sir/madam}. What can I do for you? {s2}", "merch_captain_vibor", []], 
 [anyone|plyr,"merch_captain_vibor", [
	(gt, "$g_naem_count_total", 0),
 ], "I want to hire some soldiers.", "merch_captain_naem",[]],
 [anyone|plyr,"merch_captain_vibor", [], "I would like to change my men's equipment.", "merch_captain_eqvip_type_selection",[]],
 [anyone|plyr,"merch_captain_vibor", [], "I was just passing by...", "close_window",[]],
 
 [anyone,"merch_captain_naem", [], "Who would you like to hire?", "merch_captain_naem_menu", []], 
 [anyone|plyr,"merch_captain_naem_menu", [(call_script, "script_get_troop_descr", 0),
	], "{s19}", "merch_captain_vibor1",
	[
	  (assign, "$g_naem_tip", 0), 
	  (store_mul, ":index", "$g_cur_nation", 3), 
	  (store_add, ":infantry_index", ":index", 0), 
	  (troop_get_slot, "$g_naem_count", "trp_week_limit_array", ":infantry_index"),
	]],

 [anyone|plyr,"merch_captain_naem_menu", [(call_script, "script_get_troop_descr", 1), 
	], "{s19}", "merch_captain_vibor1",
	[
	  (assign, "$g_naem_tip", 1), 
	  (store_mul, ":index", "$g_cur_nation", 3), 
	  (store_add, ":musketman_index", ":index", 1), 
	  (troop_get_slot, "$g_naem_count", "trp_week_limit_array", ":musketman_index"),
	]],

 [anyone|plyr,"merch_captain_naem_menu", [(call_script, "script_get_troop_descr", 2), 
	], "{s19}", "merch_captain_vibor1",
	[
	  (assign, "$g_naem_tip", 2), 
	  (store_mul, ":index", "$g_cur_nation", 3), 
	  (store_add, ":cavalry_index", ":index", 2), 
	  (troop_get_slot, "$g_naem_count", "trp_week_limit_array", ":cavalry_index"),
	]],

   [anyone|plyr,"merch_captain_naem_menu", [], "I don't need anything.", "start",[]],
	 
   [anyone,"merch_captain_vibor1", [       
		(try_begin),
			(party_get_free_companions_capacity, "$g_free_capacity", "p_main_party"),
			(call_script, "script_get_mercenary_price"),
		(try_end),
		(try_begin),
			(le,"$g_naem_count", 0),
			(try_begin),
			  (eq, "$g_naem_tip", 0),
			  (str_store_string, s20, "str_you_have_taken_all_infantry"),
			(else_try),
			  (eq, "$g_naem_tip", 1),
			  (str_store_string, s20, "str_you_have_taken_all_musketeer"),
			(else_try),
			  (eq, "$g_naem_tip", 2),
			  (str_store_string, s20, "str_you_have_taken_all_cavalry"),
			(try_end),
		(else_try),
			(eq, "$g_free_capacity", 0),
			(str_store_string, s20, "@ U Vas maximalnovozmozhnoe kolichestvo naemnikov "),
		(else_try),
			(gt,"$g_naem_price", "$g_trp_player_gold"),
			(str_store_string, s20, "@ U Vas ne hvataet deneg "),
		(else_try),
			(str_store_string, s20, "@  Skolko naemnikov nuzhno?"),
		(try_end),
	], "{s20}", "merch_captain_count", []],  
	
	[anyone|plyr,"merch_captain_count", [ 
		(try_begin),
			(call_script, "script_get_merch_string", 1),
		(try_end),
		(eq, reg0, 1),
		(ge, "$g_naem_count", 1),
	], "1 {s20}", "start", [(call_script, "script_add_merch_members", 1),]], 
	
	[anyone|plyr,"merch_captain_count", [   
		(try_begin),
			(call_script, "script_get_merch_string", 3),
		(try_end),
		(eq, reg0, 1),
		(ge, "$g_naem_count", 3),
	],  "3 {s20}", "start",[(call_script, "script_add_merch_members", 3),]], 									
	
	[anyone|plyr,"merch_captain_count", [   
		(try_begin),
			(call_script, "script_get_merch_string", 5),
		(try_end),
		(eq, reg0, 1),
		(ge, "$g_naem_count", 5),
	], "5 {s20}", "start",[(call_script, "script_add_merch_members", 5)]], 									
	
	#[anyone|plyr,"merch_captain_count", [   
	#	(try_begin),
	#		(call_script, "script_get_merch_string", 10),
	#	(try_end),
	#	(eq, reg0, 1),
	#	(ge, "$g_naem_count", 10),
	#], "10 {s20}", "start",[(call_script, "script_add_merch_members", 10)]], 
	
	#General Changes
	#Changed by mexxico/ozan : I closed this selection (buying 20 men in once) because inflation is added now. 
	#For example if there are less cavalry in camp then cavalry become more expensive than normal. 
	#Now we need to avoid players buying dozens of men in once time to make this inflation effect effective.
	#Otherwise they can buy 20 men from low price alltogether. 
	#Now these scenarios will occur : Player will buy 10 then price will rise and they cannot be able to take second 10 men now.
	#After adding inflation and seperate counters for each type (infantry, musketmen and cavalry) of men in each mercenary camp, now game will be more challenging and strategical.
	#Also I increased cost of basic horses now cavalries become more expensive. There is no horse to 10 thalers in any place of game.
	#[anyone|plyr,"merch_captain_count", [   
	#	(try_begin),
	#		(call_script, "script_get_merch_string", 20),
	#	(try_end),
	#	(eq, reg0, 1),
	#	(ge, "$g_naem_count", 20),
	#], "20 {s20}", "start",[(call_script, "script_add_merch_members", 20)]],  

	[anyone|plyr,"merch_captain_count", [], "I need nothing.", "merch_captain_start",[]],
	
	
	[anyone,"merch_captain_eqvip_type_selection", [	], "Which troop class do you wish to equip?", "merch_captain_type_selection_menu", []], 
	
	[anyone|plyr,"merch_captain_type_selection_menu", [
	  (call_script, "script_get_troop_descr", 0),
	  (gt, reg0, 0),

      (store_mul, ":troop_displace", "$g_cur_nation", 3),
	  (val_add, ":troop_displace", 0),		
	  (troop_get_slot, ":cur_troop", "trp_merch_array", ":troop_displace"),		
	  (assign, ":count", 0),
	  (try_for_range, ":cur_troop_upgrade", 0, 4),
	    (store_add, ":troop", ":cur_troop", ":cur_troop_upgrade"),
		(party_count_members_of_type, ":cur_count", "p_main_party", ":troop"),
		(val_add, ":count", ":cur_count"),
	  (try_end),
	  (assign, reg7, ":count"),

	  (try_begin),
	    (gt, reg0, 1),
		(str_store_string, s20, "str_men"),
	  (else_try),
	    (str_store_string, s20, "str_man"),
	  (try_end),
	], "{s19} ({reg7} {s20})", "merch_captain_eqvip",
	[
	  (assign, "$g_naem_tip", 0),
	]], 
	
	[anyone|plyr,"merch_captain_type_selection_menu", 
	[
	  (call_script, "script_get_troop_descr", 1),
	  (gt, reg0, 0),

      (store_mul, ":troop_displace", "$g_cur_nation", 3),
	  (val_add, ":troop_displace", 1),		
	  (troop_get_slot, ":cur_troop", "trp_merch_array", ":troop_displace"),		
	  (assign, ":count", 0),
	  (try_for_range, ":cur_troop_upgrade", 0, 4),
	    (store_add, ":troop", ":cur_troop", ":cur_troop_upgrade"),
		(party_count_members_of_type, ":cur_count", "p_main_party", ":troop"),
		(val_add, ":count", ":cur_count"),
	  (try_end),
	  (assign, reg7, ":count"),

	  (try_begin),
	    (gt, reg0, 1),
		(str_store_string, s20, "str_men"),
	  (else_try),
	    (str_store_string, s20, "str_man"),
	  (try_end),
	], "{s19} ({reg7} {s20})", "merch_captain_eqvip",
	[
	  (assign, "$g_naem_tip", 1),
	]],  
	
	[anyone|plyr,"merch_captain_type_selection_menu", 
	[
	  (call_script, "script_get_troop_descr", 2),
	  (gt, reg0, 0),

      (store_mul, ":troop_displace", "$g_cur_nation", 3),
	  (val_add, ":troop_displace", 2),		
	  (troop_get_slot, ":cur_troop", "trp_merch_array", ":troop_displace"),		
	  (assign, ":count", 0),
	  (try_for_range, ":cur_troop_upgrade", 0, 4),
	    (store_add, ":troop", ":cur_troop", ":cur_troop_upgrade"),
		(party_count_members_of_type, ":cur_count", "p_main_party", ":troop"),
		(val_add, ":count", ":cur_count"),
	  (try_end),
	  (assign, reg7, ":count"),

	  (try_begin),
	    (gt, reg0, 1),
		(str_store_string, s20, "str_men"),
	  (else_try),
	    (str_store_string, s20, "str_man"),
	  (try_end),
	], "{s19} ({reg7} {s20})", "merch_captain_eqvip",
	[
	  (assign, "$g_naem_tip", 2),
	]], 
	
	[anyone|plyr,"merch_captain_type_selection_menu", [
		(assign, ":count", 0), 
		(call_script, "script_get_troop_descr", 0),(assign, ":count", reg0),
		(call_script, "script_get_troop_descr", 1),(assign, ":count", reg0),
		(call_script, "script_get_troop_descr", 2),(assign, ":count", reg0),
		(try_begin), 
			(gt, ":count", 0), 
			(str_store_string, s19, "str_return_later"), 
		(else_try), 
			(str_store_string, s19, "str_recruit_first"), 
		(end_try), 
	], "{s19}", "merch_captain_start",[]],
	[anyone,"merch_captain_eqvip", [
	(try_begin),
		(call_script, "script_get_mercenary_price"),
		(assign, "$g_count_naem", 0),
		(try_for_range, ":cur_troop_upgrade", 0, 4),
			(store_add, ":troop", "$g_cur_troop", ":cur_troop_upgrade"),
			(party_count_members_of_type, ":cur_count", "p_main_party", ":troop"),
			(val_add, "$g_count_naem", ":cur_count"),
		(try_end),
		(try_begin),
			(eq, "$g_count_naem", 0),
			(str_store_string, s20, "@ U vas netu etogo tipa naemnikov"),
		(else_try),
			(str_store_string, s20, "@ Viberite razdel"),
		(try_end),
	(try_end), 
	], "{s20}", "merch_captain_eqvip_menu", []], 
	
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0),], "Something to wear on their heads...", "merch_eqvip",[(assign, "$g_arms_type", 0),]], #0
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0),], "Better armor...", "merch_eqvip",[(assign, "$g_arms_type", 1),]],  #1
	[anyone|plyr,"merch_captain_eqvip_menu", [
		(gt, "$g_count_naem", 0),
		(neq, "$g_naem_tip", 0),
	], "Change the horses...", "merch_eqvip",[(assign, "$g_arms_type", 2),]],    #2
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0), (eq, 1, 0),], "Melee weapons...", "merch_eqvip",[(assign, "$g_arms_type", 9),]], #9
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0),], "Better boots...", "merch_eqvip",[(assign, "$g_arms_type", 3),]],  #3
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0),], "Gloves...", "merch_eqvip",[(assign, "$g_arms_type", 8),]], #8
	[anyone|plyr,"merch_captain_eqvip_menu", [(gt, "$g_count_naem", 0),], "Melee weapons...", "merch_eqvip",[(assign, "$g_arms_type", 5),]], #5
	[anyone|plyr,"merch_captain_eqvip_menu", [
		(gt, "$g_count_naem", 0),
		(neq, "$g_naem_tip", 0),
	], "Long-range weapons...", "merch_eqvip",[(assign, "$g_arms_type", 4),]], #4 #7
	[anyone|plyr,"merch_captain_eqvip_menu", [
		(gt, "$g_count_naem", 0),
		(neq, "$g_talk_troop", "trp_mercanary_captain_kozaks"), 
		(neq, "$g_talk_troop", "trp_mercanary_captain_shved"),
	], "Shields...", "merch_eqvip",[(assign, "$g_arms_type", 6),]], #6
	[anyone|plyr,"merch_captain_eqvip_menu", [], "Thank you. That will be all...", "merch_captain_start",[]],
		
	[anyone,"merch_eqvip", [], "Here you are, {sir/madam}. This is everything I have.", "merch_eqvip_menu", []], 
	[anyone|plyr,"merch_eqvip_menu", [
		(try_begin),
			(call_script, "script_naem_get_items", "$g_arms_type", 0),
		(try_end),                
		(eq, reg0, 1),
	], "{s21}", "merch_captain_start",[(call_script, "script_update_items", "$g_arms_type", 0), (unlock_achievement, ACHIEVEMENT_DRESS_UP), ]],
	[anyone|plyr,"merch_eqvip_menu", [
		(try_begin),
			(call_script, "script_naem_get_items", "$g_arms_type", 1),
		(try_end),
		(eq, reg0, 1),
	], "{s21}", "merch_captain_start",[(call_script, "script_update_items", "$g_arms_type", 1), (unlock_achievement, ACHIEVEMENT_DRESS_UP), ]],
	[anyone|plyr,"merch_eqvip_menu", [
		(try_begin),
			(call_script, "script_naem_get_items", "$g_arms_type", 2),
		(try_end),
		(eq, reg0, 1),
	], "{s21}", "merch_captain_start",[(call_script, "script_update_items", "$g_arms_type", 2), (unlock_achievement, ACHIEVEMENT_DRESS_UP), ]],
	[anyone|plyr,"merch_eqvip_menu", [
		(try_begin),
			(call_script, "script_naem_get_items", "$g_arms_type", 3),
		(try_end),
		(eq, reg0, 1),
	], "{s21}", "merch_captain_start",[(call_script, "script_update_items", "$g_arms_type", 3), (unlock_achievement, ACHIEVEMENT_DRESS_UP), ]],
	[anyone|plyr,"merch_eqvip_menu", [
		(try_begin),
			(call_script, "script_naem_get_items", "$g_arms_type", 4),
		(try_end),
		(eq, reg0, 1),
	], "{s21}", "merch_captain_start",[(call_script, "script_update_items", "$g_arms_type", 4),]],		
	[anyone|plyr,"merch_eqvip_menu", [(str_store_string, s21, "str_forget_it"),], "{s21}", "merch_captain_start",[]],


  [anyone,"start", [], "Surrender or die. Make your choice", "battle_reason_stated",[]],
  [anyone|plyr,"battle_reason_stated", [], "I am not afraid of you. I will fight.", "close_window",[[encounter_attack]]],

  [anyone,"start", [], "How can I help you?", "free",[]],
  [anyone|plyr,"free", [[neg|in_meta_mission]], "Tell me about yourself.", "view_char_requested",[]],
  [anyone,"view_char_requested", [], "Very well, listen to this...", "view_char",[[change_screen_view_character]]],
  [anyone,"view_char", [], "Anything else?", "free",[]],

  [anyone|plyr,"end", [], "Done.", "close_window",[]],
  
  [anyone|plyr,"start", [], "Drop your weapons and surrender, if you value your life.", "threaten_1",[]],
  [anyone,"threaten_1", [], "We will fight you first.", "end",[[encounter_attack]]],

#  [anyone|plyr,"free", [[partner_is_mercmaster]], "I need to hire some mercenaries.", "mercenaries_requested",[]],
#  [anyone,"mercenaries_requested", [], "I have the toughest fighters in all Calradia.", "buy_mercenaries",[[change_screen_buy_mercenaries]]],
#  [anyone,"buy_mercenaries", [], "Anything else?", "free",[]],

#  [anyone|plyr,"free", [[partner_is_recruitable]], "I need a capable sergeant like yourself. How much do you ask to work for me?", "employ_mercenary_requested",[]],
#  [anyone,"employ_mercenary_requested", [[store_mercenary_price,0],[store_mercenary_wage,1]], "I want {reg0} denars now and {reg1} denars as monthly payment.", "employ_mercenary_2",[]],
#  [anyone|plyr,"employ_mercenary_2", [], "I see I need to think of this.", "employ_mercenary_giveup",[]],
#  [anyone|plyr,"employ_mercenary_2", [[neg|hero_can_join]], "I don't have any more room in my party right now. I will talk to you again later.", "employ_mercenary_giveup",[]],
#  [anyone|plyr,"employ_mercenary_2", [[player_gold_ge,reg(0)],[hero_can_join]], "That's fine. Here's the {reg0} denars. From now on you work for me.", "employ_mercenary_commit",[[troop_remove_gold, "trp_player",reg(0)],[recruit_mercenary]]],
#  [anyone,"employ_mercenary_giveup", [], "Suits me.", "free",[]],
#  [anyone,"employ_mercenary_commit", [], "You got yourself the best fighter in the land.", "end",[]],

  
  [anyone|plyr,"free", [[in_meta_mission]], "Good-bye.", "close_window",[]],
  [anyone|plyr,"free", [[neg|in_meta_mission]], "Leave...", "close_window",[]],
#  [anyone,"free", [], "NO MATCHING SENTENCE!", "close_window",[]],
]